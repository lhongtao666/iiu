$(function(){var a=new WapBanner();a.init();});function WapBanner(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}WapBanner._CONS_={EDIT_URL:ctx+"/gl/wap/wapBanner/edit.htm",DETAIL_URL:ctx+"/gl/wap/wapBanner/detail.htm",DELETE_URL:ctx+"/gl/wap/wapBanner/delete.htm",SAVE_ADD_URL:ctx+"/gl/wap/wapBanner/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/wap/wapBanner/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/wap/wapBanner/listData.htm",SAVE_WAP_CONFIG:ctx+"/gl/wap/wapBanner/saveConfig.htm",SAVE_WAP_BANNER_STATUS:ctx+"/gl/wap/wapBanner/saveWapBannerStatus.htm",SAVE_WAP_BANNER_HEIGHT:ctx+"/gl/wap/wapBanner/saveWapBannerHeight.htm",EDIT_FORM_ID:"wapBannerForm",GRID:"#wapBannerGrid",PAGER:"#wapBannerPager"};
WapBanner.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._loadData();this._bindEventHander();}},_reInitForm:function(){var a=Array.prototype.slice.call(document.querySelectorAll(".js-switch"));
a.forEach(function(b){var c=new Switchery(b,{size:"small"});});$(".ui-sortable").sortable({items:"li:not(.ui-state-disabled)"});$(".ui-sortable").sortable({cancel:".ui-state-disabled"});
$(".ui-sortable").sortable({connectWith:".ui-sortable",placeholder:"hight-light",}).disableSelection();},_add:function(){this._clearForm();$("#editModalContainer").modal("show");
var a='<input type="checkbox"  name="status" value="y" class="status-js-switch">';$("#statusDiv").empty().append(a);var b=new Switchery(document.querySelector(".status-js-switch"),{size:"small"});
},_clearForm:function(){$("#wapBannerForm").find("#imageConatiner").empty();$("#wapBannerForm").find("[name=bannerUrl]").val("");$("#wapBannerForm").find("[name=id]").val("");
$("#wapBannerForm").find("[name=targetUrl]").val("");$("#wapBannerForm").find("[name=height]").val("");$("#wapBannerForm").find("[name=targetProdId]").val("");
$("#wapBannerForm").find("[name=status]").attr("checked",false);$("#wapBannerForm").find("[name=targetProdName]").val("");$("#wapBannerForm").find(".targetProdPathImg").attr("src",ctx+"/img/jt/nophoto.png");
},_detail:function(a){this._clearForm();FormUtils.loadData(WapBanner._CONS_.DETAIL_URL+"?id="+a,function(c){$("#editModalContainer").modal("show");var g="";
if(!c.bannerUrl){var d="/img/jt/nophoto.png?dm=_mm";g=[{url:d,name:"",id:""}];}else{g=[{url:c.bannerUrl,name:"",id:""}];}var b=ImageUtils.createImageDivStr(g,null,null,1);
$("#wapBannerForm").find("#imageConatiner").empty().append(b);$("#wapBannerForm").find("[name=bannerUrl]").val(c.bannerUrl);$("#wapBannerForm").find("[name=id]").val(c.id);
$("#wapBannerForm").find("[name=sort]").val(c.sort);$("#wapBannerForm").find("[name=targetUrl]").val(c.targetUrl);$("#wapBannerForm").find("[name=height]").val(c.height);
$("#wapBannerForm").find("[name=targetProdId]").val(c.targetProdId);if("active"==c.status){var e='<input type="checkbox" checked name="status" value="active" class="status-js-switch">';
$("#wapBannerForm").find("#statusDiv").empty().append(e);}else{var e='<input type="checkbox"  name="status" value="active" class="status-js-switch">';$("#wapBannerForm").find("#statusDiv").empty().append(e);
}$("#wapBannerForm").find("[name=targetProdName]").val(c.targetProdName);$("#wapBannerForm").find(".targetProdPathImg").attr("src",c.targetProdPath);var f=new Switchery(document.querySelector(".status-js-switch"),{size:"small"});
});},_loadData:function(b){var a=this;FormUtils.loadData(WapBanner._CONS_.LIST_DATA_URL,function(e){var g=e.rows;var d=$.templates("#bannerLiTmpl");$.views.helpers({getBannerUrl:function(h){if(h){if(h.startsWith("http")){return h;
}else{return ctx+h;}}else{return ctx+"/img/jt/nophoto.png";}},});var f=d.render(g);var c='<li style="width: 230px;height: 197px;" class=" ui-state-disabled"><div class="liDiv addNewBanner"><div class="col-sm-4"></div><div style=""><img src="'+ctx+'/img/jt/add.png" style="display:inline;width:100%;"></div></div></li>';
$("#bannerLiContainer").empty().append(f).append(c);a._reInitForm();});},_save:function(){var b=this;var f=$("[name=id]").val();var a=null;var d={};if(f!=null&&f!=""){a=WapBanner._CONS_.SAVE_EDIT_URL;
d.sort=$("[name=sort]").val();d.id=f;}else{var e=$(".sticker-item:last").attr("sort")||1;d.sort=parseInt(e)+2;a=WapBanner._CONS_.SAVE_ADD_URL;}if($("#wapBannerForm").valid()){d.bannerUrl=$("#wapBannerForm").find("[name=bannerUrl]").val();
d.height=$("#wapBannerForm").find("[name=height]").val();d.targetUrl=$("#wapBannerForm").find("[name=targetUrl]").val();d.targetProdId=$("#wapBannerForm").find("[name=targetProdId]").val();
var c=document.querySelector(".status-js-switch").checked;if(c){d.status="active";}else{d.status="inactive";}FormUtils.submit(a,d,function(g){if(g.success){if(g.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(g.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}$("#editModalContainer").modal("hide");b._clearForm(true);
b._loadData();}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(WapBanner._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._loadData();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$("body").on("click",".addNewBanner",function(){a._add();
});$("body").on("blur",".configInput",function(){var e=$(this).attr("idVal");var d=$(this).val();var b=WapBanner._CONS_.SAVE_WAP_CONFIG;var c={configId:e,configValue:d,};
FormUtils.submit(b,c,function(f){if(f.success){DialogUtils.success("提示","保存成功");}else{DialogUtils.error("失败",f.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");
});});$("body").on("change",".wapBannerStatus",function(){var f=$(this).attr("idVal");var c=$(this).get(0).checked;var d=null;if(c){d="active";}else{d="inactive";
}var b=WapBanner._CONS_.SAVE_WAP_BANNER_STATUS;var e={id:f,status:d,};FormUtils.submit(b,e,function(g){if(g.success){DialogUtils.success("提示","保存成功");}else{DialogUtils.error("失败",g.msg);
}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("keypress","input",function(b){if(b.keyCode==13){return false;}});$("body").on("dblclick",".wapBannerInput",function(b){$(this).click();
$(this).focus();});$("body").on("blur",".wapBannerHeight",function(){var e=$(this);var g=$(this).attr("idVal");var d=$(this).val();if(!d){return;}var c=$(this).attr("originVal");
if(c==d){return;}var b=WapBanner._CONS_.SAVE_WAP_BANNER_HEIGHT;var f={id:g,height:d,};FormUtils.submit(b,f,function(h){if(h.success){e.attr("originVal",d);
DialogUtils.success("提示","保存成功");}else{DialogUtils.error("失败",h.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("#selectSkuBtn").on("click",function(){var b="product";
SelectProdService.selectProd({isMultiple:0,type:b,canSale:"y",hasStock:"y",limitProdCate:"n",fn:function(d){var c=d[0];$("#wapBannerForm").find("[name=targetProdId]").val(c.prodId);
$("#wapBannerForm").find("[name=targetProdName]").val(c.name);if(c.realPath){$(".targetProdPathImg").attr("src",ctx+c.realPath);}else{var e=ctx+"/img/jt/nophoto.png";
$(".targetProdPathImg").attr("src",e);}$("[name=targetUrl]").val("product_yhz.html?prodId="+c.prodId);}});});$("#selectDefaultImageBtn").click(function(){ImageUtils.selectImage(0,function(b){var c=ImageUtils.createImageDivStr(b,null,null,1);
$("#imageConatiner").empty().append(c);$("[name=bannerUrl]").val(b[0].url.replace("?dm=_mm",""));});});$("body").on("click",".deleteBanner",function(){var b=$(this).attr("idVal");
if(b){a._delete(b);}else{DialogUtils.error(msgCode.ERROR,"请选择条目进行操作");}});$("body").on("click",".editBanner",function(){var b=$(this).attr("idVal");if(b){a._detail(b);
}else{DialogUtils.error(msgCode.ERROR,"请选择条目进行操作");}});$("body").on("click","#saveWapBannerBtn",function(){a._save();});$("body").on("sortupdate",".ui-sortable",function(f,g){var e=g.item;
var c=e.prev();var b=e.next();var d=null;var i=null;if(c.size()){i=parseInt(c.attr("sort"));}var h=null;if(b.size()){h=parseInt(b.attr("sort"));}if(i!==null){d=(i+2);
if(h!==null&&d>h){d=d-1;}}else{if(h!==null){d=(h-2);if(i!==null&&d>i){d=d+1;}}else{d=e.attr("sort")||1;}}e.attr("sort",d);a._updateSort(e.attr("idVal"),e.attr("sort"));
});},_updateSort:function(b,a){FormUtils.submit(ctx+"/gl/wap/wapBanner/updateWapBannerSort.htm","id="+b+"&sort="+a,function(c){if(c.success){}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},};