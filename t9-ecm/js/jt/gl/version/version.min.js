$(function(){var a=new Version();a.init();});function Version(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.editTd=false;}Version._CONS_={EDIT_URL:ctx+"/gl/version/version/edit.htm",DETAIL_URL:ctx+"/gl/version/version/detail.htm",DELETE_URL:ctx+"/gl/version/version/delete.htm",SAVE_ADD_URL:ctx+"/gl/version/version/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/version/version/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/version/version/listData.htm",EDIT_FORM_ID:"versionForm",GRID:"#versionGrid",PAGER:"#versionPager"};
Version.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
CateUtils.getOptions({typeKey:"system",pKey:"versionTags",container:"tagsSearch"});}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("version.button.detail")){$(".versionDetail").hide();
}if(!ResUtils.canShow("version.button.add")){$(".versionAdd").hide();}if(!ResUtils.canShow("version.button.edit")){$(".versionEdit").hide();}if(!ResUtils.canShow("version.button.delete")){$(".versionDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(Version._CONS_.EDIT_FORM_ID);
FormUtils.clear("#versionItemForm");FormUtils.enableForm(Version._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_add:function(){this._showFormWrapper();var a=[];this._initItemTable(a);CateUtils.getOptions({typeKey:"system",pKey:"versionTags",fn:function(b){var f=new StringBuffer();
for(var d=0;d<b.length;d++){var e=b[d].value;var c=b[d].name;f.append("<option value='"+e+"'>"+c+"</option>");}$("#versionTagsSelect").empty().append(f.toString());
$("#versionTagsSelect").chosen();$("#versionTagsSelect").val("").trigger("chosen:updated");}});},_edit:function(a){this._showFormWrapper();this.edit=true;
this._loadData(a,null);CateUtils.getOptions({typeKey:"system",pKey:"versionTags",fn:function(b){var f=new StringBuffer();for(var d=0;d<b.length;d++){var e=b[d].value;
var c=b[d].name;f.append("<option value='"+e+"'>"+c+"</option>");}$("#versionTagsSelect").empty().append(f.toString());$("#versionTagsSelect").chosen();
}});CateUtils.getOptions({typeKey:"system",pKey:"csCompanyCode",fn:function(b){var f=new StringBuffer();f.append("<option value=''>请选择</option>");for(var d=0;
d<b.length;d++){var e=b[d].value;var c=b[d].name;f.append("<option value='"+e+"'>"+c+"</option>");}$("#versionItemSearchForm").find("select[name=belongs]").empty().append(f.toString());
}});},_detail:function(a){this._showFormWrapper();this._loadData(a,null);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(Version._CONS_.EDIT_FORM_ID);
},_loadData:function(c,b){var a=this;if(b){c=c+b;}FormUtils.loadData(Version._CONS_.EDIT_URL+"?id="+c,function(g){$("#versionForm").find("input[name=id]").val(g.id);
$("#versionForm").find("input[name=version]").val(g.version);if(g.tags){var d=g.tags.split(",");$("#versionForm").find("select[name=tags]").val(d).trigger("chosen:updated");
}$("#versionForm").find("textarea[name=desc]").val(g.desc);$("#versionForm").find("input[name=createTime]").val(g.createTime);$("#versionForm").find("input[name=updateTime]").val(g.updateTime);
$("#versionItemForm").find("input[name=versionId]").val(c);var f=[];var h=g.versionItemPos;if(h){for(var e=0;e<h.length;e++){var d=["<input type='checkbox' class='checkSingle' atrItemId='"+h[e].id+"'' />",h[e].module,h[e].tag,h[e].desc,h[e].doc,h[e].belongCompanyCodeName+"<input type='hidden' class='belongs' value='"+h[e].belongs+"' />",(h[e].level=="1"?"标准版":(h[e].level=="2"?"专业版":"旗舰版"))+"<input type='hidden' class='level' value='"+h[e].level+"' />",h[e].sort,"<i class='fa fa-remove deleteVersionItem' title='删除' style='color: red; cursor: pointer;'></i>"];
f.push(d);}}a._initItemTable(f);});},_initItemTable:function(b){$("#versionItemDiv").empty().append("<button type='button' id='addItemBtn' class='btn btn-sm btn-outline btn-primary'>添加条目</button>").append("<table id='versionItemTable' class='table table-striped table-bordered display'></table>");
var a=[{title:"<input type='checkbox' class='checkall' />"},{title:"模块"},{title:"标签"},{title:"描述"},{title:"文档"},{title:"归属企业"},{title:"归属版本"},{title:"排序"},{title:"操作"},];
versionItemTable=$("#versionItemTable").DataTable({data:b,columns:a,lengthMenu:[[-1]],searching:false,paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false});
},_save:function(){var c=this;var d=$("#id").val();var a=null;if(d!=null&&d!=""){a=Version._CONS_.SAVE_EDIT_URL;}else{a=Version._CONS_.SAVE_ADD_URL;}var b=c._getItemJson();
$("[name=itemArrJson]").val(b);if($("#versionForm").valid()){ButtonUtils.disableBtn("saveBtn");FormUtils.submitByFormId(a,Version._CONS_.EDIT_FORM_ID,function(e){ButtonUtils.enableBtn("saveBtn");
if(e.success){if(e.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(e.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(Version._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$("#"+Version._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+Version._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+Version._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#versionItemSearchForm").on("click",".versionItemSearch",function(){var e=$("#id").val();var d=$("#versionItemSearchForm").find("select[name=belongs]").val();
var c=$("#versionItemSearchForm").find("select[name=level]").val();var b="&belongs="+d+"&level="+c;a._loadData(e,b);});$("#versionSearchForm").on("click",".versionSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#versionSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".versionSearch").trigger("click");return false;}});$("body").on("click",".versionAdd",function(){a._add();
});$("body").on("click",".versionEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(Version._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}a._edit(b);});$("body").on("click",".versionDel",function(){var b=$(this).attr("idVal");if(!b){b=$(Version._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".versionDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(Version._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(document).on("click","#addItemBtn",function(){FormUtils.clear("#versionItemForm");
CateUtils.getOptions({typeKey:"system",pKey:"versionModule",container:"moduleSelect"});layer.close(a.layerIndex);a.layerIndex=layer.open({type:1,title:"添加条目",shade:false,btn:["保存","关闭"],area:["50%","50%"],offset:"10%",content:$(".versionItemAdd"),scrollbar:true,success:function(){CateUtils.getOptions({typeKey:"system",pKey:"itemTags",fn:function(b){var f=new StringBuffer();
for(var d=0;d<b.length;d++){var e=b[d].value;var c=b[d].name;f.append("<option value='"+e+"'>"+c+"</option>");}$("#itemTagsSelect").empty().append(f.toString());
$("#itemTagsSelect").chosen();$("#itemTagsSelect").val("").trigger("chosen:updated");}});CateUtils.getOptions({typeKey:"system",pKey:"csCompanyCode",fn:function(b){var f=new StringBuffer();
for(var d=0;d<b.length;d++){var e=b[d].value;var c=b[d].name;f.append("<option value='"+e+"'>"+c+"</option>");}$("#belongCompanyCodeSelect").empty().append(f.toString());
$("#belongCompanyCodeSelect").chosen();$("#belongCompanyCodeSelect").val("").trigger("chosen:updated");}});},yes:function(c,b){a._saveItem();}});});$(document).on("click",".genNewSql",function(){FormUtils.loadData(ctx+"/gl/version/version/genSql.htm",function(b){if(b&&b.success){layer.close(a.layerIndex);
a.layerIndex=layer.open({type:1,title:"最新版本的sql",shade:false,btn:[],area:["1200px","800px"],offset:"10%",content:$(".versionSqlDiv"),scrollbar:true,success:function(d,c){$("#lastVersionSql").html(b.msg);
}});}});});$(document).on("click",".genSql",function(){var b=$("#id").val();var c=[];$(".checkSingle:checkbox:checked").each(function(){c.push($(this).attr("atrItemId"));
});FormUtils.loadData(ctx+"/gl/version/version/genSql.htm?versionId="+b+"&itemIds="+c.toString(),function(d){if(d&&d.success){layer.close(a.layerIndex);
a.layerIndex=layer.open({type:1,title:"最新版本的sql",shade:false,btn:[],area:["1200px","800px"],offset:"10%",content:$(".versionSqlDiv"),scrollbar:true,success:function(f,e){$("#lastVersionSql").html(d.msg);
}});}});});$(document).on("click",".deleteVersionItem",function(){$(this).parents("tr").remove();});$(document).on("dblclick","td",function(){if(!a.editTd){a.editTd=true;
var c=$(this).text();var b="<input type='text' class='editTd' class='form-control' value='"+c+"'> ";$(this).html(b);$(".editTd").focus();}});$(document).on("blur",".editTd",function(){a.editTd=false;
var b=$(this).val();$td=$(this).parent("td");$td.text(b);});$(document).on("click","#versionItemTable tbody tr",function(){if($(this).find(".checkSingle").is(":checked")){$(this).find(".checkSingle").prop("checked",false);
}else{$(this).find(".checkSingle").prop("checked",true);}});$(document).on("click",".checkall",function(){if($(this).is(":checked")){$(".checkSingle").prop("checked",true);
}else{$(".checkSingle").prop("checked",false);}});},_saveItem:function(){var k=this;var h=[];var b=$("#versionItemForm").find("[name=module]").val();var l=$("#versionItemForm").find("[name=itemTags]").val();
var e=new StringBuffer();var j=new StringBuffer();$("#versionItemForm").find("[name=belongs] option:selected").each(function(){e.append($(this).text()).append(",");
});var a=$("#versionItemForm").find("[name=level]").val();var f=a==1?"标准版":(a==2?"专业版":"旗舰版");j.append(f);j.append("<input type='hidden' class='level' value='"+a+"'/>");
var g=$("#versionItemForm").find("[name=belongs]").val();if(!g){DialogUtils.error(msgCode.FAIL_MSG,"归属企业必选");return;}e.append("<input type='hidden' class='belongs' value='"+g+"'/>");
var i=$("#versionItemForm").find("[name=doc]").val();var d=$("#versionItemForm").find("[name=desc]").val();var c=$("#versionItemForm").find("[name=sort]").val();
if(d.length>30){DialogUtils.error(msgCode.FAIL_MSG,"描述长度不能超过30个字");return;}h.push("<input type='checkbox' class='checkSingle'  />");h.push(b);h.push(l);
h.push(d);h.push(i);h.push(e.toString());h.push(j.toString());h.push(c);h.push("<i class='fa fa-remove deleteVersionItem' title='删除' style='color: red; cursor: pointer;'></i>");
layer.close(k.layerIndex);versionItemTable.row.add(h).draw(false);},_getItemJson:function(){var b=[];var e=$("#versionItemTable").find("tr");if(e){for(var a=1;
a<e.length;a++){var c=$(e[a]).find("td");var d={};d.module=$(c[1]).text();d.tag=$(c[2]).text();d.desc=$(c[3]).text();d.doc=$(c[4]).text();d.belongCompanyCodeName=$(c[5]).text();
d.belongs=$(c[5]).find(".belongs").val();d.level=$(c[6]).find(".level").val();d.sort=$(c[7]).text();if(d.tag){b.push(d);}}}return JSON.stringify(b);},_bindFormValidation:function(){var a={rules:{},messages:{}};
FormUtils.bindFormValidation(Version._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(Version._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
if(ResUtils.canShow("version.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"versionDel",iconClasses:"fa fa-remove"});}if(ResUtils.canShow("version.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"versionEdit",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("version.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"versionDetail",iconClasses:"fa fa-list"});}return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}$(Version._CONS_.GRID).JTJqgrid({url:Version._CONS_.LIST_DATA_URL,pager:Version._CONS_.PAGER,postData:a,colNames:["版本号","版本标签","版本概述","创建时间","更新时间","操作"],colModel:[{name:"version",index:"version_",width:120},{name:"tags",index:"tags_",width:120},{name:"desc",index:"desc_",width:120},{name:"createTime",index:"create_time_",width:120},{name:"updateTime",index:"update_time_",width:120},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
},};