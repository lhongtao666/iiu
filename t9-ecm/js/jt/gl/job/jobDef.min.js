$(function(){var a=new JobDef();a.init();});function JobDef(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.hadCHangeCol=false;
this.loggridcreateflag=false;}JobDef._CONS_={GRID:"#jobDefGrid",PAGER:"#jobDefPager",LIST_DATA_URL:ctx+"/gl/job/jobDef/listData.htm",EDIT_URL:ctx+"/gl/job/jobDef/edit.htm",DETAIL_URL:ctx+"/gl/job/jobDef/detail.htm",SAVE_URL:ctx+"/gl/job/jobDef/save.htm",DELETE_URL:ctx+"/gl/job/jobDef/delete.htm",RUN_STOP_URL:ctx+"/gl/job/jobDef/runOrStopJob.htm",HI_LIST_DATA_URL:ctx+"/gl/job/jobDef/jobRunHilistData.htm",JOB_PLAN_TAB_NAME:"计划列表",RUN_HI_TAB_NAME:"任务日志",HI_GRID:"#jobRunHiGrid",HI_PAGER:"#jobRunHiPager",HI_GRID_ID:"jobRunHiGrid",HI_PAGER_ID:"jobRunHiPager",HI_GRID_DIV:"#jobRunHiDiv",};
JobDef.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._hideNotGrantBtn();a._bindEventHander();a._bindFormValidation();a._initJqgrid(b);
}},_hideNotGrantBtn:function(){},_bindFormValidation:function(){var a={rules:{"name":{required:true,maxByteLength:64},"bean":{required:true,maxByteLength:64},}};
FormUtils.bindFormValidation("jobDefForm",a);},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_detail:function(a){this._showFormWrapper();
this._loadData(a,true);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm("jobDefForm");this._disableTable();},_disableTable:function(){ButtonUtils.disableBtn("addRow");
$("data-table tbody input[name]").attr("disabled","disabled");},_enableTable:function(){ButtonUtils.enableBtn("addRow");$("data-table tbody input[name]").removeAttr("disabled");
},_clear:function(c){var a=this;function b(){$("#jobDefForm").validate().resetForm();$(".list_wrapper").show();$(".form_wrapper").hide();FormUtils.clear("jobDefForm");
$("#resTip").text("").hide();$(".beanDiv").show();$(".methodDiv").hide();$("input[name=bean]").removeAttr("readonly");$("input[name=method]").removeAttr("readonly");
$(".form_wrapper .saveBtn").show();a._enableTable();FormUtils.enableForm("jobDefForm");$("select[name='jobType']").attr("disabled",false);a.isFormDataChange=false;
if(c){a._reloadJqgrid();}$(".data-table tbody").empty();}if(a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);
};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());},_createTr:function(d){var b=this;var c=(d&&d.name)?d.name:"";var e=new StringBuffer();var a=(d&&d.dataType)?d.dataType:"";
e.append("<tr>");e.append("<td>");e.append('<input required value="'+c+'" name="name-'+b._generateCode()+'"  validateType="default" type="text" class="form-control paramName" >');
e.append("</td>");e.append("<td>");e.append(b._createSelect(a));e.append("</td>");e.append("<td>");e.append("<button class='btn btn-danger btn-outline deleteEmployeePercentageBtn' type='button'>删除</button>");
e.append("</td>");e.append("</tr>");return e.toString();},_createSelect:function(a){var b=new StringBuffer();b.append('<select class="form-control dataTypeValue" name="dataType">');
if(a=="string"){b.append('<option value="string" selected="selected" >字符串</option>');}else{b.append('<option value="string">字符串</option>');}if(a=="boolean"){b.append('<option value="boolean" selected="selected" >布尔</option>');
}else{b.append('<option value="boolean">布尔</option>');}if(a=="integer"){b.append('<option value="integer" selected="selected" >整数</option>');}else{b.append('<option value="integer">整数</option>');
}if(a=="decimal"){b.append('<option value="decimal" selected="selected" >浮点数</option>');}else{b.append('<option value="decimal">浮点数</option>');}if(a=="date"){b.append('<option value="date" selected="selected" >短日期(yyyy-MM-dd)</option>');
}else{b.append('<option value="date" >短日期(yyyy-MM-dd)</option>');}if(a=="datetime"){b.append('<option value="datetime" selected="selected" >长日期(yyyy-MM-dd hh:mm:ss)</option>');
}else{b.append('<option value="datetime">长日期(yyyy-MM-dd HH:mm:ss)</option>');}b.append("</select>");return b.toString();},_bindEventHander:function(){var a=this;
$("body").on("click",".fixJobPlan",function(){layer.open({type:2,title:'<font style="color:red;">【'+"执行补偿任务"+"】</font>",maxmin:false,shadeClose:true,btn:["确定","取消"],area:["80%","80%"],scrollbar:false,content:ctx+"/gl/job/jobDef/fixJobPlan.htm",yes:function(c,b){}});
});$("body").on("click",".deleteEmployeePercentageBtn",function(){$(this).parents("tr").remove();});$("body").on("click",".showDefaultLog",function(){var c=$(this).attr("idVal");
if(!c){c=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要操作的记录");return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.error,"不能操作多条记录");
return;}}}var b=ctx+"/gl/job/jobDef/loadDefaultPlan.htm?id="+c;FormUtils.submit(b,null,function(f){if(f&&!$.isEmptyObject(f)){var d=f.jobId;var e=f.name;
e=e.length>5?(e.substring(0,3)+"..."):e;JTTabUtils.addOrRefreshTab(ctx+"/gl/job/jobRunHi/list.htm?Q__S__EQ__key_="+d+"-"+f.id,e+JobDef._CONS_.RUN_HI_TAB_NAME);
}else{DialogUtils.error(msgCode.error,"加载默认计划失败,请检查是否有默认计划");}});});$("body").on("click",".runDefaultPlan",function(){var c=$(this).attr("idVal");if(!c){c=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要操作的记录");return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.error,"不能操作多条记录");return;
}}}var b=ctx+"/gl/job/jobDef/runDefaultPlan.htm?id="+c;FormUtils.submit(b,null,function(d){if(d.success){DialogUtils.success(msgCode.success,d.msg);}else{DialogUtils.error(msgCode.error,d.msg);
}});});$("body").on("click",".jobDefPlan",function(){var d=$(this).attr("idVal");if(!d){d=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(d==null||d.length==0){DialogUtils.error(msgCode.error,"请选择要操作的记录");
return;}else{if(d&&d.length>1){DialogUtils.error(msgCode.error,"不能操作多条记录");return;}}}var c=$(JobDef._CONS_.GRID).jqGrid("getRowData",d);var b=c.name;b=b.length>5?(b.substring(0,3)+"..."):b;
JTTabUtils.addOrRefreshTab(ctx+"/gl/job/jobPlan/list.htm?Q__S__EQ__job_id_="+d,b+JobDef._CONS_.JOB_PLAN_TAB_NAME);});$("body").on("click",".addRow",function(){$(".data-table tbody").append("");
var c={money:"",rate:""};var b=a._createTr(c);$(".data-table tbody").append(b);return false;});$(document).on("click",".prevBtn",function(){a.hadCHangeCol=false;
a._clear(false);});$(document).on("click",".saveBtn",function(){var b=$("input[name='jobType']").val();if(b=="general"){var f=$("input[name='method']").val();
if(f==""||f==null){DialogUtils.error("错误","类和方法不能为空");return false;}}if(!$("#jobDefForm").valid()){return false;}var d=$(".data-table tbody tr");var c=[];
d.each(function(g){var h={};h.name=$(this).find(".paramName").val();h.dataType=$(this).find(".dataTypeValue").val();h.key=$(this).find(".paramName").val();
c.push(h);});$("[name=jobParamJSON]").val(JSON.stringify(c));var e=$("#jobDefForm").serialize();FormUtils.submit(JobDef._CONS_.SAVE_URL,e,function(g){ButtonUtils.enableBtn("saveBtn");
if(g.success){DialogUtils.success("提示",g.msg);a.isFormDataChange=false;a.hadCHangeCol=false;a.isEdit=false;a._clear(true);}else{DialogUtils.error("失败",g.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("click",".jobDefAdd",function(){a._add();});$("body").on("click",".jobDefEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要更新的记录");
return;}if(b.length>1){DialogUtils.error("错误","不能同时编辑多条记录");return;}}a._edit(b);});$("body").on("click",".jobDefDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要删除的记录");return;}}var e=new StringBuffer();
for(var c=0;c<b.length;){var d=$(JobDef._CONS_.GRID).jqGrid("getRowData",b[c]);e.append(d["name"]);if(++c<b.length){e.append(",");}}a._del(b,""+e);});$("body").on("click",".jobDefDetail",function(){a.isEdit=false;
var b=$(this).attr("idVal");if(!b){b=$(JobDef._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要查看明细的记录");
return;}if(b.length>1){DialogUtils.error("错误","不能同时查看多条记录");return;}}a._detail(b);});$(".list_wrapper").on("click",".jobDefSearch",function(){var b=$(this).closest("form").serialize();
a._reloadJqgrid(b);});$("#jobDefSearchForm").on("keypress",function(b){if(b.which==13){$(".jobDefSearch").trigger("click");}});$(".form_wrapper").on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".form_wrapper").on("change",".form_wrapper select",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".form_wrapper").on("change",".form_wrapper textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("body").on("change","select[name='jobType']",function(){var b=$(this).val();if(b=="common"){$(".beanDiv").show();$(".methodDiv").hide();$("input[name='bean']").val("");
}else{$(".beanDiv").hide();$(".methodDiv").show();$("input[name='bean']").val("executeJob");}});},_initJqgrid:function(b){var a=this;$(JobDef._CONS_.GRID).JTJqgrid({url:JobDef._CONS_.LIST_DATA_URL,pager:JobDef._CONS_.PAGER,colNames:["id","名称","描述","BEAN","参数个数","有默认计划","运行中/计划数","方法名","创建者","创建时间","操作"],colModel:[{name:"id",index:"id_",hidedlg:true,hidden:true,width:120},{name:"name",width:140,index:"name_"},{name:"desc",width:120,hidden:true,index:"desc_",},{name:"bean",width:160,index:"bean_"},{name:"jobParam",width:100},{name:"hasDefaultJob",width:120,formatter:function(c){if("y"==c){return"<label class='label label-primary'>是</label>";
}return"<label class='label label-default'>否</label>";}},{name:"runningPlan",width:120,formatter:function(c,d,e){return e.runningPlan+" / "+e.planCount;
}},{name:"method",width:120,index:"method_",hidden:true},{name:"createByName",width:120,sortable:false,classes:"autoHideCol"},{name:"createTime",width:100,index:"create_time_",formatter:function(c){return DateUtils.miniTime(c);
}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",title:"操作",formatoptions:a._getManagerBtns()}]});},_getManagerBtns:function(){var a=[];
a.push({lable:"编辑",btnClasses:"btn btn-primary jobDefEdit",iconClasses:"fa fa-detail"});a.push({lable:"明细",btnClasses:"btn btn-primary jobDefDetail",iconClasses:"fa fa-detail"});
a.push({lable:"计划列表",btnClasses:"btn btn-primary jobDefPlan",iconClasses:"fa fa-edit"});a.push({lable:"执行默认计划",btnClasses:"btn btn-primary runDefaultPlan",iconClasses:"fa fa-edit"});
a.push({lable:"查看默认日志",btnClasses:"btn btn-primary showDefaultLog",iconClasses:"fa fa-edit"});a.push({lable:"删除",btnClasses:"btn btn-danger jobDefDel",iconClasses:"fa fa-remove"});
return a;},_reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(JobDef._CONS_.GRID,a);},_add:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
$(".log_wrapper").hide();FormUtils.enableForm("jobDefForm");},_edit:function(a){$(".list_wrapper").hide();$(".form_wrapper").show();$(".log_wrapper").hide();
this._loadData(a);},_loadData:function(d,b){var a=this;var c=b?JobDef._CONS_.DETAIL_URL:JobDef._CONS_.EDIT_URL;FormUtils.loadData(c+"?id="+d,function(f){$("input[name=id]").val(f.id);
$("input[name=name]").val(f.name);$("[name=desc]").val(f.desc);$("input[name=bean]").val(f.bean).attr("readonly","readonly");$("input[name=method]").val(f.method).attr("readonly","readonly");
$("input[name=type]").val(f.type);$("input[name=createBy]").val(f.createBy);$("input[name=createTime]").val(f.createTime);$("input[name=updateBy]").val(f.updateBy);
$("input[name=updateTime]").val(f.updateTime);if(f.bean=="executeJob"){$(".beanDiv").hide();$(".methodDiv").show();$("select[name='jobType']").val("general").attr("disabled",true);
}else{$(".beanDiv").show();$(".methodDiv").hide();$("select[name='jobType']").val("common").attr("disabled",true);}var j=new StringBuffer();for(var e=0;
f.jobParamList&&e<f.jobParamList.length;e++){var h=f.jobParamList[e];var g=a._createTr(h);j.append(g);}$(".data-table tbody").append(j.toString());if(b){$(".data-table tbody").find(":input").attr("disabled",true);
}});},_del:function(a){DialogUtils.confirm(function(){FormUtils.del(JobDef._CONS_.DELETE_URL,a,function(b){$(".jobDefSearch").trigger("click");DialogUtils.success("提示",b.msg);
},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});},};