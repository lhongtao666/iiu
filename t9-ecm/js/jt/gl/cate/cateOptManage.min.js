$(function(){var a=new CateOptManage();a.init();});function CateOptManage(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}CateOptManage._CONS_={EDIT_URL:ctx+"/gl/cate/cateOpt/edit.htm",DETAIL_URL:ctx+"/gl/cate/cateOpt/detail.htm",DELETE_URL:ctx+"/gl/cate/cateOpt/delete.htm",SAVE_ADD_URL:ctx+"/gl/cate/cateOpt/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/cate/cateOpt/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/cate/cateOpt/listData.htm",LIST_CATE_URL:ctx+"/gl/cate/cateOpt/listOptCatesBySys.htm",EDIT_FORM_ID:"cateOptManageForm"};
CateOptManage.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this.tempName="";this._bindFormValidation();this._bindEventHander();this._loadOptCatesTree();
var a=$(window).height()-$("#addOptCateBtn").parents(".row").outerHeight()-10-5;$("#cateOptContainer").css({height:a+"px"});this._initColorChooseDiv();
this._locateToGlHelp();}},_initColorChooseDiv:function(){var c=[];c.push("black");c.push("green");c.push("blue");c.push("orange");c.push("#dfdf00");c.push("red");
c.push("#35B7A5");c.push("#5C9BD1");c.push("#cccccc");c.push("#abcabc");c.push("#ffddaa");c.push("#654321");c.push("#963852");c.push("pink");var d="";for(var b=0;
b<c.length;b++){var a=c[b];d=d+'<span  class="colorOptSpan col-sm-1" style="color:white;padding-top:10px;margin-left:10px;margin-top:10px;float:left;background: '+a+';border-radius: 4px;height: 40px;text-align:center;" colorVal="'+a+'"></span>';
}$("#colorOptDiv").empty().append(d);$(document).on("click",".colorOptSpan",function(){$(".colorOptSpan").html("");var e=$(this).html('<i class="glyphicon glyphicon-ok"></i>').attr("colorVal");
$(".colorChooseOpt").val(e);});},_locateToGlHelp:function(){var a="glHelp.systemconfig.cateOpt";glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("cateOpt.button.addCate")){$("#addOptCateBtn").hide();
}},_loadOptCatesTree:function(){var a=this;var b=CateOptManage._CONS_.LIST_CATE_URL+"?Q__S__EQ__type_key_=system&Q__S__IN__key_=taskOpt,jobDefOpt,moduleColumnOpt,desktopGroupOpt,tpl,roleGroupOpt,1495615491373_0.9953286693037262";
FormUtils.loadData(b,function(c){if(c&&c.length){var g=new StringBuffer();var f="";for(var d=0;d<c.length;d++){var e="";g.append("<li class='list-group-item' idVal='").append(c[d].id).append("' keyVal='"+c[d].key+"'><a href='javascript:void(0);'>").append(c[d].name).append("</a></li>");
}$("#optCateContainer").empty().append(g.toString());$("#optCateContainer").find("li:eq(0)").trigger("click");}});},_renderSwitch:function(a){var b=a.find(".js-switch");
b.each(function(d,c){var e=new Switchery(c,{size:"small"});});},_loadOptions:function(c){var a=this;$("#optContainer").empty();var b=ctx+"/gl/cate/cateOpt/listData.htm?cateId="+c;
FormUtils.loadData(b,function(d){if(d&&d.length){for(var f=0;f<d.length;f++){a._buildOptionCateTable(d[f]);}}var e=Array.prototype.slice.call(document.querySelectorAll(".js-switch"));
e.forEach(function(g){var h=new Switchery(g,{size:"small"});});});},_buildPanelHeadStr:function(a){var b=new StringBuffer();b.append("<div class='panel-heading ' style='padding:10px'>");
b.append("<span class='panel-title'><strong>"+a.catePo.name+"("+a.catePo.key+")</strong></span>");if(ResUtils.canShow("cateOpt.button.deleteCate")&&a.catePo.key!="roleGroup"){b.append("<button cateIdVal='"+a.catePo.id+"' class='btn btn-xs btn-danger pull-right deleteOptCateBtn' type='button'><i class='fa fa-remove'></i></button>");
}b.append("</div>");return b.toString();},_buildTableRowItemAddOptStr:function(c,d){var b=this;var e=new StringBuffer();e.append("<div class='col-sm-4 cateOptItem cateOptItem-AddItem' cateIdVal='"+(d?d:"")+"'  optSort='1' >");
e.append('<div class="colorTd col-sm-6">');var a={id:"",cateId:"",sort:"1",createTime:"",name:"",color:"",};e.append(b._buildTableRowItemContent(a,c,""));
e.append("</div>");e.append("<div class='addNewOptTd td col-sm-6'>");e.append("<button class='jt-btn addCateOptBtn' type='button'><i class='fa fa-plus'></i>&nbsp;新增选项</button>");
e.append("</div>");e.append("</div>");return e.toString();},_buildTableRowStr:function(b,f){var c=this;var a=f*3;var h=(f+1)*3;var e=b.catePo.supportColor;
var g=new StringBuffer();g.append("<div  class='row tr' style='margin-bottom: 1rem;' trLineVal='1' cateIdVal='"+b.catePo.id+"'>");for(var d=a;d<h&&d<(b.cateOptPos.length+1);
d++){if(d<b.cateOptPos.length){g.append(c._buildTableRowItem(b,d,e));}else{if(b.catePo.key!="roleGroup"){g.append(c._buildTableRowItemAddOptStr(e,b.catePo.id));
}}}g.append("</div>");return g.toString();},_buildTableRowItemContent:function(d,e,c){var b=this;var f=new StringBuffer();if("y"==e){f.append('<div class="colorTd">');
f.append('<div class="col-sm-10" style="padding-left: 0px;">');f.append("<input name='optName' class='form-control' "+c+" value='"+d.name+"'>");f.append("</div>");
var a=d.color||"#fff";f.append('<div class="col-sm-2" style="padding:   4px; padding-left: 0px; "><span class="form-control colorSpan" style="height:20px;background: '+a+'; " colorVal="'+a+'"></span></div>');
f.append("</div>");}else{f.append("<input name='optName' class='form-control' "+c+" value='"+d.name+"'>");}return f.toString();},_buildTableRowItem:function(a,e,f){var d=this;
var c=a.cateOptPos[e];var g=new StringBuffer();var b="";g.append("<div class='col-sm-4 cateOptItem'  idVal='"+c.id+"' cateIdVal='"+c.cateId+"' optSort='"+c.sort+"' createTimeVal='"+c.createTime+"'>");
g.append("<div class='col-sm-6'>");if(a.catePo.key=="roleGroup"){b="readonly";}g.append(d._buildTableRowItemContent(c,f,b));g.append("</div>");g.append("<div  class='col-sm-3'>");
if(a.catePo.key!="roleGroup"){g.append("<input type='checkbox' "+(c.status=="actived"?"checked":"")+" class='js-switch'>");}g.append("</div");g.append("<div  class='col-sm-3'>");
if(a.catePo.key!="roleGroup"){g.append("&nbsp;&nbsp;<button idVal='"+c.id+"' class='jt-btn-error deleteOptBtn' type='button'type='button'>删除</button>");
}g.append("</div>");g.append("</div>");return g.toString();},_buildPanelBodyStr:function(d){var h=this;var a=d.catePo.supportColor;var f=new StringBuffer();
f.append("<div supportColor='"+d.catePo.supportColor+"' idVal='"+d.catePo.id+"' typeKey='"+d.catePo.typeKey+"' pKey='"+d.catePo.key+"' >");if(d.cateOptPos&&d.cateOptPos.length){var g=d.cateOptPos.length%3;
var e=d.cateOptPos.length/3;var b=g?e+1:e;var j=g?b:(e+1);for(var c=0;c<j;c++){f.append(h._buildTableRowStr(d,c));}}else{f.append(h._buildTableRowStr(d,0));
}return f.toString();},_buildOptionCateTable:function(a){var b=this;var d=new StringBuffer();d.append("<div class='panel panel-default cateItem' idVal='"+a.catePo.id+"' >");
d.append(b._buildPanelHeadStr(a));d.append("<div class='panel-body cateItemPanelBody'>");d.append(b._buildPanelBodyStr(a));d.append("</div>");var c=$(d.toString());
$("#optContainer").prepend(c);return c;},_bindEventHander:function(){var a=this;$("body").on("click",".colorSpan",function(){FormUtils.clear("chooseColorForm");
var c=$(this).parents(".cateOptItem").attr("idVal");var b=$(this).attr("colorVal")||"black";$("[name=optColorIdVal]").val(c);$(".colorOptSpan").filter("[colorVal='"+b+"']").trigger("click");
$("#chooseColor").modal("show");a.clickSpanEle=$(this);});$("body").on("click","#chooseColorValBtn",function(){var b=$('[name="colorVal"]').val();var c=$("[name=optColorIdVal]").val();
a.clickSpanEle.css("background",b);a.clickSpanEle.attr("colorVal",b);if(c){var d=a.clickSpanEle.parents(".cateOptItem");d.find(".js-switch").trigger("change");
}a.clickSpanEle=null;$("#chooseColor").modal("hide");});$("#cateOptContainer").on("click",".addCateOptBtn",function(){var d=$(this).parents(".cateOptItem");
var j=d.attr("cateIdVal");var b=d.find("[name=optName]").val();var g="actived";var h=1;var i=d.parents(".cateItemPanelBody").find(".cateOptItem:not(.cateOptItem-AddItem)");
if(i&&i.size()){h=parseInt(i.last().attr("optSort"))+1;}else{h=parseInt(d.parents(".cateItemPanelBody").find(".cateOptItem-AddItem").attr("optSort"))+1;
}var f=d.find(".colorSpan").attr("colorVal");var c=ctx+"/gl/cate/cateOpt/saveAdd.htm";var e={cateId:j,name:encodeURI(b),status:g,color:f?f:"#fff",sort:h};
if(!b){DialogUtils.error(msgCode.ERROR,"请输入选项值");return;}FormUtils.submit(c,e,function(k){if(k.success){window.sessionStorage.setItem("system-CsBizTypes","");
a._reloadCateItem(j,d);}else{if(k.msg=="repeat"){DialogUtils.error(msgCode.ERROR,"重复添加");}else{DialogUtils.error(msgCode.ERROR,"添加失败");}}});});$(".folder-list").on("click","li",function(){$("#optContainer").empty();
$(".folder-list li").removeClass("active");$(this).addClass("active");var b=$(this).attr("idVal");a._loadOptions(b);});$("#addOptCateBtn").on("click",function(){$(".supportColorDiv").empty().append('<input type="checkbox" value="y" name="supportColor" placeholder="" class="form-control supportColorCheckbox" validateType="default">');
var b=document.querySelector(".supportColorCheckbox");var c=new Switchery(b,{size:"small"});$("#addCateModalContainer").modal("show");});$("#saveOptCateBtn").on("click",function(){if($("#cateForm").valid()){var b=$("#cateForm").find("input[name='cateName']").val();
var c=$("#cateForm").find("input[name='cateKey']").val();var d={typeKey:"system",pKey:$("#optCateContainer").find("li.active").attr("keyVal"),key:c,name:b,supportColor:$("[name=supportColor]").is(":checked")?"y":"n",success:function(e){a._loadOptions(e.msg);
$("#addCateModalContainer").modal("hide");DialogUtils.success(msgCode.SUCCESS,"添加成功");}};CateUtils.addOption(d);}});$("#cateOptContainer").on("click",".deleteOptCateBtn",function(){var d=$(this).attr("cateIdVal");
var c=ctx+"/gl/cate/cateOpt/deleteByCateId.htm";var b=$(this).parents(".panel");DialogUtils.confirm(function(){FormUtils.submit(c,{cateId:d},function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,"删除成功");
b.remove();}});});});$("#addCateModalContainer").on("hidden.bs.modal",function(){FormUtils.clear("cateForm");});$("#cateOptContainer").on("click",".deleteOptBtn",function(){var b=$(this).parents(".cateOptItem");
var c=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/cate/cateOpt/delete.htm?ids="+c,"",function(d){if(d.success){window.sessionStorage.setItem("system-CsBizTypes","");
b.remove();DialogUtils.success(msgCode.SUCCESS,"删除成功");}});});});$("#cateOptContainer").on("change",'[name="optName"]',function(){if(!$(this).val()){DialogUtils.error("失败","请输入选项值");
return;}var b=$(this).parents(".cateOptItem");if(!b.attr("idVal")){return;}b.find(".js-switch").trigger("change");window.sessionStorage.setItem("system-CsBizTypes","");
});$("body").on("change",".js-switch",function(){var d=$(this).parents(".cateOptItem");var c=d.attr("idVal");var j=d.attr("cateIdVal");var b=d.find("[name=optName]").val();
var h=d.attr("optSort");var i=d.attr("createTimeVal");var g=d.find(".js-switch").is(":checked")?"actived":"inactived";var f=d.find(".colorSpan").attr("colorVal");
var e={id:c,cateId:j,name:encodeURI(b),status:g,color:f?f:"#fff",sort:h,createTime:i};FormUtils.submit(ctx+"/gl/cate/cateOpt/saveEdit.htm",e,function(k){if(k.success){window.sessionStorage.setItem("system-CsBizTypes","");
DialogUtils.success("提示","更新成功");a._reloadCateItem(j,d);}else{DialogUtils.error("失败",k.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});},_reloadCateItem:function(c,b){var a=this;
FormUtils.loadData(ctx+"/gl/cate/cateOpt/listData4CateId.htm?cateId="+c,function(e){var d=b.parents(".cateItem");if(!d||!d.size()){d=$(".cateItem [idVal='"+c+"']");
}var g=a._buildOptionCateTable(e);var f=$(g);f.replaceAll(d);a._renderSwitch(f);},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},_bindFormValidation:function(){var a={rules:{optName:{required:true},cateKey:{required:true}},messages:{}};
FormUtils.bindFormValidation("cateForm",a);var b={rules:{colorVal:{required:true},},messages:{}};FormUtils.bindFormValidation("chooseColorForm",a);}};