$(function(){var a=new Res();a.init();});function Res(){if(this instanceof Res){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.resTree=null;
this.currentEditResTrHtml=null;this.currentRes=null;this.newResParentTreeNode=null;}else{return new Res();}}Res._CONS_={DELETE_URL:ctx+"/gl/auth/res/delete.htm?sys="+sys,DETAIL_URL:ctx+"/gl/auth/res/detail.htm?sys="+sys,SAVE_ADD_URL:ctx+"/gl/auth/res/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/auth/res/saveEdit.htm?sys="+sys,LIST_DATA_URL:ctx+"/gl/auth/res/listData.htm?sys="+sys,MOVE_URL:ctx+"/gl/auth/res/move.htm?sys="+sys,LIST_RES_TREE:ctx+"/gl/auth/res/listResTree.htm?sys="+sys,REFRESH_URL:ctx+"/gl/auth/res/refresh.htm?sys="+sys,SORT_URL:ctx+"/gl/auth/res/sort.htm?sys="+sys,};
Res.prototype={init:function(a){if(!this.hadInit){this._bindEventHanlder();this._bindFormValidation();this._loadResTree();this._initRealSysSelect();this._initSys("system","resourceSys","sysList");
}},_initRealSysSelect:function(){if("all"==sys){}},_initDragsort:function(){$("#subResTable").dragsort("destroy");$("#subResTable").dragsort({dragSelector:"tr",dragBetween:false,dragEnd:function(){var a=[];
$("#subResTable").find("tr").each(function(b){a.push({id:$(this).attr("idVal"),sort:b+1});});FormUtils.submit(Res._CONS_.SORT_URL,{sortParams:JSON.stringify(a)},function(b){if(b.success){$("#subResTable").find("tr").each(function(c){$(this).find("td").eq(0).text(c+1);
});}else{DialogUtils.error(msgCode.ERROR,"网络连接失败，请稍候重试");}});}});},_addResHandler:function(a){FormUtils.clear("resForm");$("#iconUrlContainer").attr("src","");
this._setFormStatus(true);$("input[name='parentId']").val(this.newResParentTreeNode.id);$("input[name='type']").val(a);$("input[name='name']").focus();
$("#subResTable").empty();$("#editResBtn").hide();$("#saveResBtn").show();$("#cancelResBtn").show();$("#subResContainer").hide();$("#resForm").find(".sysList").attr("disabled",false);
$("#resForm .editGroup").show();if(a=="url"){$("#titleContainer").text("添加子菜单");}else{$("#titleContainer").text("添加子文件夹");}},_bindFormValidation:function(){var a={rules:{nameForSub:{required:true},codeForSub:{required:true},contentForSub:{required:true},typeForSub:{required:true},isActivedForSub:{required:true},sysForSub:{required:true}}};
var b={rules:{name:{required:true},code:{required:true},sys:{required:true}}};FormUtils.bindFormValidation("resForm",b);FormUtils.bindFormValidation("subResForm",a);
},_bindEventHanlder:function(){var a=this;$("#refreshBtn").on("click",function(){FormUtils.loadData(Res._CONS_.REFRESH_URL,function(){DialogUtils.success(msgCode.SUCCESS,"已生效...");
});});$("#addResModalContainer").on("hidden.bs.modal",function(){FormUtils.clear("subResForm");$('select[name="isHiddenForSub"]').trigger("change");});
$("#deleteIconBtn").on("click",function(){$("#iconUrlContainer").removeAttr("src");$("input[name='imgUrl']").val("");});$("#selectIconBtn").on("click",function(){var b=$(this);
SelectZtreeIconUtils.selectZtreeIcon(function(c){$("input[name='imgUrl']").val(c);$("#iconUrlContainer").attr("src",ctx+ztreeIconStyle+"/"+c+".png");});
});$(document).on("mouseleave","#rMenu",function(){$("#rMenu").hide();});$("#rMenu").on("click","#resAddBtn",function(){a._addResHandler("url");ButtonUtils.enableBtn("selectIconBtn");
$('#resForm input[name="content"]').removeAttr("disabled");});$("#rMenu").on("click","#menuAddBtn",function(){a._addResHandler("menu");ButtonUtils.enableBtn("selectIconBtn");
$('#resForm input[name="content"]').removeAttr("disabled");});$("#rMenu").on("click","#resDelBtn",function(b){DialogUtils.confirm(function(){FormUtils.del(Res._CONS_.DELETE_URL,a.newResParentTreeNode.id,function(c){if(c.success){a.resTree.removeNode(a.newResParentTreeNode);
$("#subResContainer").hide();ButtonUtils.disableBtn("selectIconBtn");a._setFormStatus(false);$("#cancelResBtn").hide();$("#editResBtn").hide();$("#saveResBtn").hide();
DialogUtils.success("成功",c.msg);}else{DialogUtils.success("失败",c.msg);}});});});$("#resForm").on("click","#editResBtn",function(){$("#resForm .editGroup").show();
a._setFormStatus(true);$(this).hide();ButtonUtils.enableBtn("selectIconBtn");$("#saveResBtn").show();$("#cancelResBtn").show();});$("#resForm").on("click","#cancelResBtn",function(){FormUtils.clear("resForm");
a._loadResData(a.currentRes.id,true);$("#subResContainer").show();ButtonUtils.disableBtn("selectIconBtn");a._setFormStatus(false);$(this).hide();$("#editResBtn").show();
$("#saveResBtn").hide();});$("#resForm").on("click","#saveResBtn",function(){if($("#resForm").valid()){if("all"==sys){var c=$("#realSysEditSelect").val().join(",");
$("[name=realSysStr]").val(c);}var e=$("#resForm").serialize();ButtonUtils.disableBtn("saveResBtn");var b=$("input[name='id']").val()?Res._CONS_.SAVE_EDIT_URL:Res._CONS_.SAVE_ADD_URL;
if(!$("#resForm input[name='id']").val()&&!$('#resForm input[name="content"]').val()){DialogUtils.error("保存失败","url不能为空");return;}var d=this;FormUtils.submit(b,e,function(i){ButtonUtils.enableBtn("saveResBtn");
if(i.success){var f=JSON.parse(i.msg);if(i.msgCode==actionCode.CREATE){var h=$.fn.zTree.getZTreeObj("tree");h.addNodes(a.newResParentTreeNode,f);var g=h.getNodesByFilter(function(j){if(j.id==f.id){return true;
}else{return false;}},true);a.currentRes=h;h.selectNode(g);a._loadResData(f.id,true);}else{if(i.msgCode==actionCode.UPDATE){a.currentRes.name=f.name;a.currentRes.iconSkin=f.imgUrl;
$.fn.zTree.getZTreeObj("tree").updateNode(a.currentRes);DialogUtils.success(msgCode.SUCCESS,"更新成功");}}$('input[name="content]').attr("disabled","disabled");
$(d).hide();$("#editResBtn").show();$("#cancelResBtn").hide();a._setFormStatus(false);ButtonUtils.disableBtn("selectIconBtn");a.currentRes=f;$("#titleContainer").text("资源信息");
$("#subResContainer").show();}else{DialogUtils.error("失败",i.msg);}},function(){ButtonUtils.enableBtn("saveResBtn");DialogUtils.error("失败","网络连接失败，请稍候重试");
});}});$("#subResTable").on("click",".subResCancel",function(){$(this).parent().parent().empty().append(a.currentEditResTrHtml);});$("#subResTable").on("click",".subResDel",function(){var c=$(this).parent().parent();
var d=this;var b=c.attr("idVal");DialogUtils.confirm(function(){FormUtils.del(Res._CONS_.DELETE_URL,b,function(f){if(f.success){DialogUtils.success("成功",f.msg);
a._loadResData(a.currentRes.id,true);var e=a.resTree.getNodesByFilter(function(g){if(g.id==b){return true;}},true,a.resTree.getSelectedNodes()[0]);if(e){a.resTree.removeNode(e);
}}else{DialogUtils.error("失败",f.msg);}});});});$("#subResContainer").on("click",".subResEdit",function(){$("#myModalLabel").text("编辑子资源");if($("input[name='type']").val()=="menu"){$('select[name="typeForSub"]').empty().append("<option value='menu'>文件夹</option><option value='url'>url</option>");
}else{$('select[name="typeForSub"]').empty().append("<option value='button'>按钮</option>");}var b=$(this).parents("tr");$('input[name="nameForSub"]').val(b.find("td").eq(1).text());
$('input[name="codeForSub"]').val(b.find("td").eq(2).text());if($("input[name='type']").val()=="menu"){$('select[name="typeForSub"]').empty().append("<option value='menu'>文件夹</option><option value='url'>url</option>");
}else{$('select[name="typeForSub"]').empty().append("<option value='button'>按钮</option>");}$('select[name="typeForSub"]').val(b.attr("type"));$('input[name="contentForSub"]').attr("disabled","disabled");
$('select[name="isActivedForSub"]').val(b.attr("isActived"));$('input[name="idForSub"]').val(b.attr("idVal"));$('input[name="createTimeForSub"]').val(b.attr("createTime"));
$('input[name="sortForSub"]').val(b.attr("sort"));$('input[name="depthForSub"]').val(b.attr("depth"));$('input[name="pathForSub"]').val(b.attr("path"));
$('select[name="sysForSub"]').val(b.attr("realSys"));$('select[name="sysForSub"]').attr("disabled","disabled");if(b.attr("realSys")){$("#realSysSelectForSub").val(b.attr("realSys").split(","));
}$("#addResModalContainer").modal("show");});$("#addResModalContainer").on("shown.bs.modal",function(){if("all"==sys){$("#realSysSelectForSub").chosen("destroy");
$("#realSysSelectForSub").chosen();}});$("body").on("click",".subResAdd",function(){$("#myModalLabel").text("添加子资源");if($("input[name='type']").val()=="menu"){$('select[name="typeForSub"]').empty().append("<option value='menu'>文件夹</option><option value='url'>url</option>");
}else{$('select[name="typeForSub"]').empty().append("<option value='button'>按钮</option>");}$('select[name="sysForSub"]').removeAttr("disabled");$('input[name="contentForSub"]').removeAttr("disabled");
$("#addResModalContainer").modal("show");});$("#saveSubResBtn").on("click",function(){if("all"==sys){$("[name=realSysStrForSub]").val($("#realSysSelectForSub").val().join(","));
}if($("#subResForm").valid()){if(!$('input[name="idForSub"]').val()&&!$('input[name="contentForSub"]').val()){DialogUtils.error("保存失败","url不能为空");return;
}var c={id:$('input[name="idForSub"]').val(),name:$('input[name="nameForSub"]').val(),parentId:$("input[name='id']").val(),code:$('input[name="codeForSub"]').val(),type:$('select[name="typeForSub"]').val(),content:$('input[name="contentForSub"]').val(),isActived:$('select[name="isActivedForSub"]').val(),createTime:$('input[name="createTimeForSub"]').val(),sort:$('input[name="sortForSub"]').val(),depth:$('input[name="depthForSub"]').val(),path:$('input[name="pathForSub"]').val(),realSysStr:$("[name=realSysStrForSub]").val(),realSys:$("#realSysSelectForSub").val(),sys:$('select[name="sysForSub"]').val()};
var b=c.id?Res._CONS_.SAVE_EDIT_URL:Res._CONS_.SAVE_ADD_URL;FormUtils.submit(b,c,function(d){if(d.success){$("#addResModalContainer").modal("hide");DialogUtils.success("成功","保存成功");
a._loadResData(a.currentRes.id,true);}else{DialogUtils.error("失败",d.msg);}},function(){DialogUtils.error("失败","网络错误，请稍候重试");});}});},_setFormStatus:function(a){if(a){$("#resForm").find("input,select,textarea").removeAttr("disabled");
$("#resForm").find(".sysList").attr("disabled","disabled");$("#resForm").find("input[name=content]").attr("disabled","disabled");}else{$("#resForm").find("input,select,textarea").each(function(){if($(this).attr("type")!="hidden"){$(this).attr("disabled","disabled");
}});}if("all"==sys){$("#realSysEditSelect").chosen("destroy");$("#realSysEditSelect").chosen();}},_loadResTree:function(c){if(this.resTree!=null){this.resTree.reAsyncChildNodes(null,"refresh");
this.resTree.expandAll(true);return;}var a=this;var b={edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{autoExpandTrigger:true,isCopy:false,isMove:true,prev:true,next:true,inner:true,borderMax:10,borderMin:-5,minMoveSize:5,autoOpenTime:500}},view:{dblClickExpand:false,showLine:true,selectedMulti:false},async:{enable:true,url:Res._CONS_.LIST_RES_TREE,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"]},check:{enable:false,chkStyle:"radio",radioType:"all"},data:{keep:{parent:true}},callback:{beforeDrag:function(e,d){if(!d[0].parentId){return false;
}else{return true;}},beforeDrop:function(g,f,h,e){var d=f[0];if(e=="inner"&&h.type=="url"&&f[0].type=="url"){return false;}if(e==="prev"||e==="next"){if((d.parentId.isEmpty()&&h.parentId.isEmpty())||(d.parentId==h.parentId)){a._moveHandler(d.id,h.id,null,e);
}else{if(d.parentId!=null&&h.parentId!=null&&d.parentId!=h.parentId){a._moveHandler(d.id,h.id,h.parentId,e);}else{if(d.parentId!=null&&h.parentId==null){a._moveHandler(d.id,h.id,h.id,h.id,e);
}}}return true;}else{if(e==="inner"){if(d==null||h==null){return false;}else{a._moveHandler(d.id,null,h.id,null);return true;}}}return false;},onRightClick:function(f,i,h){f.stopPropagation();
a.newResParentTreeNode=h;var g=false;var j=false;var e=false;if(h.type=="menu"){var d=h.children;if(d==null||d.length==0){e=true;}j=true;g=true;}else{e=true;
}a._showRightMenu({x:f.pageX,y:f.pageY},g,j,e);},onClick:function(d,f,e){a.currentRes=e;a._editRes(a.currentRes.id);a._setFormStatus(false);$("#editResBtn").show();
$("#saveResBtn").hide();$("#cancelResBtn").hide();},onAsyncSuccess:function(d,f,e,h){if(!e){var g=$.fn.zTree.getZTreeObj("tree");g.expandNode(g.getNodes()[0],true,false,true);
g.selectNode(g.getNodes()[0]);a.currentRes=g.getNodes()[0];a._editRes(a.currentRes.id);}}}};$.fn.zTree.init($("#tree"),b);this.resTree=$.fn.zTree.getZTreeObj("tree");
},_editRes:function(a){$("#editResBtn").show();$("#subResContainer").show();this._loadResData(a,true);},_initSys:function(d,c,a){var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey="+d+"&pKey="+c;
FormUtils.loadData(b,function(e){if(e&&e.length>0){var g=new StringBuffer();for(var f=0;f<e.length;f++){if(f==0){g.append("<option value='"+e[f].value+"' selected='selected'>"+e[f].name+"</option>");
}else{g.append("<option value='"+e[f].value+"'>"+e[f].name+"</option>");}}return $("."+a).empty().append(g.toString());}});},_moveHandler:function(d,c,a,b){var e={};
if(d&&c&&a==null){e.type="changeSort";}else{if(d&&c&&a!=null){e.type="changeSortAndParentId";}else{if(d&&a!=null){e.type="changeParentId";}}}e.srcId=d;
e.destId=c;e.destParentId=a;e.moveType=b;FormUtils.submit(Res._CONS_.MOVE_URL,e,function(f){if(f.success){DialogUtils.success("成功","移动成功");}},function(){DialogUtils.error("错误","网络错误，请稍候重试");
});},_showRightMenu:function(b,c,d,a){$("#rMenu").css({top:(b.y-15)+"px",left:(b.x-10)+"px",display:"block"});if(c){$("#resAddBtn").show();}else{$("#resAddBtn").hide();
}if(d){$("#menuAddBtn").show();}else{$("#menuAddBtn").hide();}if(a){$("#resDelBtn").show();}else{$("#resDelBtn").hide();}},_loadResData:function(c,b){var a=this;
FormUtils.loadData(Res._CONS_.DETAIL_URL+"?id="+c,function(e){$("#resForm .editGroup").hide();$("input[name='name']").val(e.name);$("input[name='content']").val(e.content);
$("input[name='imgUrl']").val(e.imgUrl);$("#iconUrlContainer").attr("src",ctx+ztreeIconStyle+"/"+e.imgUrl+".png");$("select[name='sys']").find("option[value="+e.sys+"]").attr("selected",true);
$("input[name='code']").val(e.code);$("input[name='id']").val(e.id);$("input[name='type']").val(e.type);$("input[name='sort']").val(e.sort);$("input[name='parentId']").val(e.parentId);
$("input[name='createTime']").val(e.createTime);$("input[name='path']").val(e.path);$("input[name='depth']").val(e.depth);$("input[name='type']").val(e.type);
$("select[name='isActived']").val(e.isActived);$("select[name='isShow']").val(e.isShow);if("all"==sys){var d="ecm";if(e.sys){d=e.sys.split(",");}$("#realSysEditSelect").val(d);
}if(b){$("#subResTable").empty().append(a._createSubResTrs(e.subs));a._initDragsort();}$("#titleContainer").text("资源信息");a._setFormStatus(false);});},_createSubResTrs:function(c){var d=new StringBuffer(),a;
if(c&&c.length>0){for(var b=0;b<c.length;b++){d.append(this._createSubResTr(c[b],b+1));}}return d.toString();},_createSubResTr:function(b,a){var c=new StringBuffer();
if(b){c.append("<tr ").append("parentId='").append(b.parentId).append("'").append(" createTime='").append(b.createTime).append("'").append(" type='").append(b.type).append("'").append(" depth='").append(b.depth).append("'").append(" path='").append(b.path).append("'").append(" isActived='").append(b.isActived).append("'").append(" sort='").append(b.sort).append("'").append(" idVal='").append(b.id).append("'").append(" realSys='").append(b.sys).append("'").append(">").append("<td width='5%'>").append(a).append("</td>").append("<td width='10%'>").append(b.name).append("</td>").append("<td width='10%'>").append(b.code).append("</td>");
if(b.type=="menu"){c.append("<td width='10%'>").append("菜单").append("</td>");}else{if(b.type=="button"){c.append("<td width='10%'>").append("按钮").append("</td>");
}else{if(b.type=="url"){c.append("<td width='10%'>").append("url").append("</td>");}else{c.append("<td width='10%'>").append("按钮").append("</td>");}}}c.append("<td width='20%'>").append(b.content).append("</td>");
if(b.isActived=="y"){c.append("<td width='10%'>").append("是").append("</td>");}else{c.append("<td width='10%'>").append("否").append("</td>");}if("all"==sys){c.append("<td>").append(b.sys).append("</td>");
}c.append("<td>").append("<button type='button' class='btn btn-sm btn-outline btn-primary subResEdit'>编辑</button>&nbsp;&nbsp;").append("<button type='button' class='btn btn-sm btn-outline btn-danger subResDel'>删除</button>").append("<button type='button' style='display:none;' class='btn btn-sm btn-outline btn-primary subResSave'>保存</button>&nbsp;&nbsp;").append("<button type='button' style='display:none;' class='btn btn-sm btn-outline btn-primary subResCancel'>取消</button>").append("</td>").append("</tr>");
}return c.toString();}};