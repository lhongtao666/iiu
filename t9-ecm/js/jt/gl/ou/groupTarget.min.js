$(function(){var a=new GroupTarget();a.init();});function GroupTarget(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.isInitOrg=false;
this.useCount=false;this.listData={page:1,rows:20,total:0};this.targetType=(targetIsAudit=="y"?"audit":"complete");this.grantBtn={_delete:false,_edit:false,_detail:false};
}GroupTarget._CONS_={LIST_DATA_URL:ctx+"/gl/ou/groupTarget/listData.htm",FIND_ADD_URL:ctx+"/gl/ou/groupTarget/findAddList.htm",DETAIL_URL:ctx+"/gl/ou/groupTarget/detail.htm",EDIT_URL:ctx+"/gl/ou/groupTarget/edit.htm",SAVE_URL:ctx+"/gl/ou/groupTarget/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/ou/groupTarget/saveEdit.htm",DELETE_URL:ctx+"/gl/ou/groupTarget/delete.htm",};
GroupTarget.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;if(targetIsAudit=="y"){$("[name='type'][value='audit']").attr("checked","checked");
}this._bindEventHander();this._hideNotGrantBtn();this._dealStyle();this.initDate("#search-period-year",true);this.initMonthDate("#search-period-month");
this.initDate("#groupTargetForm [name='period-year']");this.initMonthDate("#groupTargetForm [name='period-month']");this.loadListData();this.statusSwitchery=new Switchery(document.querySelector(".status-status .js-switch"),{color:"#1AB394"});
this._locateToGlHelp();}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.operations.groupTarget");},initDate:function(b,a){var c=new Date();var e=c.getFullYear();
var f=new StringBuffer();if(a){f.append("<option value=''>全部</option>");}for(var d=e+1;d>=2015;d--){f.append("<option "+((d==e)?"selected":"")+" value='").append(d).append("' >").append(d).append("年</option>");
}$(b).append(f.toString());},initMonthDate:function(a){var b=new Date();var c=b.getMonth()+1;c=(c<10?"0"+c:c);$(a).val(c);},_dealStyle:function(){var a=$(window).height()-100-50;
$("#groupTargetContainer").height(a);},loadListData:function(){var b=this;var e=$("#search-period-year").val()+"-"+$("#search-period-month").val();var d="";
if(e.length>5){d="&Q__S__EQ__target.period_="+e;}else{if(e.length>1){d="&Q__S__LK__target.period_="+e;}}var a=$("input[name=belongOgn]").val();var c=GroupTarget._CONS_.LIST_DATA_URL+"?page="+this.listData.page+"&rows="+this.listData.rows+"&targetType="+this.targetType+d+"&belongOgn="+a;
FormUtils.loadData(c,function(j){b.listData.total=j.total;var l=new StringBuffer();for(var g=0;g<j.rows.length;g++){var f=j.rows[g];var h=b.targetType=="complete"?f.completeTotal:f.auditTotal;
var k=(f.total==0?0:(h*100/f.total).toFixed(0));if(k>100){k=100;}l.append("<div class='group-target-div'>").append("<div class='group-target-1'>").append("<div class='group-target-name'>"+f.groupName+"</div>").append("<div>目标时间："+f.period+"</div>").append("<div>").append("<span>参与人数："+f.employeeCount+"  </span>").append("<span class='target-span'>已达标: "+f.employeeCompleteCount+"</span>").append("<span class='target-span'>未达标: "+(f.employeeCount-f.employeeCompleteCount)+"</span>").append("</div></div>").append("<div class='group-target-2'>").append("<div>目标：<span class='target-num'>￥"+f.total+"</span>,完成金额：<span class='target-num'>￥"+h+"</span></div>").append("<div class='div-line'>");
if(k>10){l.append("<div class='div-line1'  style='width:calc("+k+"% - 20px);'></div>").append("<div class='div-line1-after'></div>").append("<div class='div-line2'  style='width:"+(100-k)+"%;'></div>");
}else{l.append("<div class='div-line1'  style='width:"+k+"%'></div>").append("<div class='div-line1-after'></div>").append("<div class='div-line2'  style='width:calc("+(100-k)+"% - 20px);'></div>");
}l.append("</div>").append("<div>完成度：<span class='target-num'>"+k+"%</span></div>").append("</div>").append("<div class='group-target-3' data-id='"+f.id+"'>");
if(b.grantBtn._delete){l.append("<a href='#' class='hover-red deleteBtn'><i class='glyphicon glyphicon-trash'></i>删除</a>");}if(b.grantBtn._edit){l.append("<a href='#' class='editBtn'><i class='glyphicon glyphicon-edit'></i>编辑</a>");
}if(b.grantBtn._detail){l.append("<a href='#' class='detailBtn'><i class='glyphicon glyphicon-folder-open'></i>详情</a>");}l.append("</div></div>");}if(j.records<=0){l.append("<div class='norecords' ><img src='/t9-ecm/img/jt/coffee3.png' ><br>没有数据</div>");
}$("#groupTargetContainer").empty().append(l.toString());$("#groupTargetPageContainer").find(".first-row").empty().append(b._min(((b.listData.page-1)*b.listData.rows+1),j.records));
$("#groupTargetPageContainer").find(".last-row").empty().append(b._min(b.listData.page*b.listData.rows,j.records));$("#groupTargetPageContainer").find(".total-row").empty().append(j.records);
if(b.listData.total>b.listData.page){$("#groupTargetPageContainer").find(".next-page").removeClass("no");}else{$("#groupTargetPageContainer").find(".next-page").addClass("no");
}if(b.listData.page>1){$("#groupTargetPageContainer").find(".pre-page").removeClass("no");}else{$("#groupTargetPageContainer").find(".pre-page").addClass("no");
}});},_hideNotGrantBtn:function(){if(ResUtils.canShow("groupTarget.button.detail")){this.grantBtn._detail=true;}if(!ResUtils.canShow("groupTarget.button.add")){$(".groupTargetAdd").hide();
}if(ResUtils.canShow("groupTarget.button.edit")){this.grantBtn._edit=true;}if(ResUtils.canShow("groupTarget.button.delete")){this.grantBtn._delete=true;
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();FormUtils.enableForm("groupTargetForm");FormUtils.clear("groupTargetForm");
$("#employee-target-container").empty();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();$(".saveBtn").show();$("#average-btn").show();
$("#count-btn").show();this.useCount=false;},_add:function(){this._showFormWrapper();this.isEdit=false;},_edit:function(a){this._showFormWrapper();this._loadData(a);
this.isEdit=true;$("[name='orgName']").attr("disabled","disabled");$("[name='period-year']").attr("disabled","disabled");$("[name='period-month']").attr("disabled","disabled");
},_detail:function(a){JTTabUtils.addOrRefreshTab(ctx+"/gl/ou/groupTarget/toDetail.htm?id="+a,"目标详情");},_isPeriodGreatNow:function(c){var a=c.split("-");
var b=new Date();year=b.getFullYear();month=b.getMonth()+1;if(parseInt(a[0])<year||(parseInt(a[0])==year&&parseInt(a[1])<month)){return false;}return true;
},_save:function(){var b=this;var c=this.SAVE_EDIT_URL?GroupTarget._CONS_.SAVE_EDIT_URL:GroupTarget._CONS_.SAVE_URL;var e=$("#groupTargetForm select[name='period-year']").val()+"-"+$("#groupTargetForm select[name='period-month']").val();
if(!b._isPeriodGreatNow(e)){DialogUtils.error(msgCode.ERROR,"目标时间必须不小于当前时间");return;}var a=this._getGroupTargetJson(e);if(!a){DialogUtils.error(msgCode.ERROR,"请给员工分配目标");
return;}if(a.length<=0){DialogUtils.error(msgCode.ERROR,"请选择正确的部门");return;}var d={groupTargetVos:JSON.stringify(a)};ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(c,d,function(f){ButtonUtils.enableBtn("saveBtn");if(f.success){b._showListWrapper();b.loadListData();}},function(){ButtonUtils.enableBtn("saveBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.submit(GroupTarget._CONS_.DELETE_URL,{id:b},function(c){a.loadListData();
DialogUtils.success("提示",c.msg);},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});},_getGroupTargetJson:function(f){var e=this;var d=$("#employee-target-container .group-target-table");
var c=[];var b=0;var a=0;$.each(d,function(){var j={};j.period=f;j.groupId=$(this).attr("data-groupId");var g=$(this).find(".employee-target-td");var i=[];
var h=0;$.each(g,function(){var k={};k.employeeId=$(this).attr("data-employeeId");k.total=$(this).find("input[name='total']").val();k.total=(k.total==""?0:parseInt(k.total));
if(e.useCount){k.countTarget=$(this).find("input[name='countTarget']").val();k.countTarget=(k.countTarget==""?0:parseInt(k.countTarget));a=a+k.countTarget;
}i.push(k);h=h+k.total;});j.employeeTargetVos=i;j.total=h;c.push(j);b=b+h;});if(b<=0&&a<=0){return false;}return c;},_getEmployeeTargetJson:function(){var b=this;
var a=$("#employee-target-container .employee-target-td");var c=[];$.each(a,function(){var d={};d.employeeId=$(this).attr("data-employeeId");d.total=$(this).find("input[name='total']").val();
if(b.useCount){d.countTarget=$(this).find("input[name='countTarget']").val();}c.push(d);});console.log(c);return c;},_loadData:function(d,b){var a=this;
var c=b?GroupTarget._CONS_.DETAIL_URL:GroupTarget._CONS_.EDIT_URL;FormUtils.loadData(c+"?id="+d,function(e){var f=e[0];$("#groupTargetForm [name='orgId']").val(f.orgId);
$("#groupTargetForm [name='orgName']").val(f.groupName);var g=f.period.split("-");$("#groupTargetForm [name='period-year']").val(g[0]);$("#groupTargetForm [name='period-month']").val(g[1]);
a._fillTargetData(e,b);$("#employee-target-container [name='total']").trigger("change");});},_findAddList:function(a){$("#employee-target-container").empty();
var d=$("#groupTargetForm select[name='period-year']").val();var e=$("#groupTargetForm select[name='period-month']").val();var f=d+"-"+e;var b=this;var c=GroupTarget._CONS_.FIND_ADD_URL;
FormUtils.loadData(c+"?groupId="+a+"&period="+f,function(g){if(g.success){b._fillTargetData(JSON.parse(g.msg));}else{DialogUtils.error(msgCode.ERROR,g.msg);
}});},_fillTargetData:function(a,b){var h=new StringBuffer();for(var e=0;e<a.length;e++){var g=a[e];h.append("<div class='col-sm-12 group-name'>"+g.groupName+"</div>").append("<table class='table table-stripped group-target-table' border='0' bordercolor='gray' cellspacing='0' cellpadding='5' data-groupId='"+g.groupId+"'>");
var f=g.employeeTargetVos;for(var d=0;d<f.length;d++){if(d%6==0){h.append("<tr>");}var c=f[d];h.append("<td class='employee-target-td' align='center' data-employeeId='"+c.employeeId+"'>").append("<img onerror='onImageError()' class='jt-employee-img' src='"+ctx+c.profile+"'>").append("<div class='employee-name' >"+c.aid+" : "+c.name+"</div>").append("<div class='total-div'><input autocomplete='off' type='number' placeholder='销售金额' class='total' value='"+c.total+"' name='total'/></div>").append("<div class='countTarget-div'><input autocomplete='off' type='number' value='"+c.countTarget+"' placeholder='销售数量' class='countTarget' name='countTarget'/></div>").append("</td>");
if(d%6==5||d==(f.length-1)){h.append("</tr>");}if(c.countTarget>0){this.useCount=true;}}h.append("</table>");}$("#employee-target-container").empty().append(h.toString());
if(!this.useCount){$(".countTarget-div").addClass("hide");$(".status-status").empty().append('<input type="checkbox"  name="use-count" class="js-switch" />启用销售数量目标');
}else{$(".status-status").empty().append('<input type="checkbox"  name="use-count" checked class="js-switch" />启用销售数量目标');}this.statusSwitchery=new Switchery(document.querySelector(".status-status .js-switch"),{color:"#1AB394",disabled:b?b:false});
$("input[name='use-count']").trigger("change");if(b){FormUtils.disableForm("groupTargetForm");$("#employee-target-container input").attr("disabled","disabled");
}},_bindEventHander:function(){var a=this;$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$("body").on("click",".prevBtn",function(){a._showListWrapper();});$("body").on("click",".groupTargetAdd",function(){a._add();
});$("#select-group").off("click").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name=orgId]").val(),container:"select-group",nolimit:true,positionType:"dept_manager",fn:function(c){$("input[name=orgId]").val(c);
$("#select-group").change();}};GroupUtils.selectGroupTreeBox(b);});$("body").on("change","#select-group",function(){var c=$("#target-period").val();var b=$("input[name=orgId]").val();
if(b){a._findAddList(b);}});$("body").on("change","#groupTargetForm select[name='period-year']",function(){var b=$("input[name=orgId]").val();if(b){a._findAddList(b);
}});$("body").on("change","#groupTargetForm select[name='period-month']",function(){var b=$("input[name=orgId]").val();if(b){a._findAddList(b);}});$("body").on("change","input[name='use-count']",function(){if($(this)[0].checked){$(".countTarget-div").removeClass("hide");
$(".group-count").show();a.useCount=true;}else{$(".countTarget-div").addClass("hide");$(".group-count").hide();a.useCount=false;}});$("#average-btn").on("click",function(){var c=parseInt($("#groupTargetForm input[name='total']").val());
if(c>0){var d=$("#employee-target-container input[name='total']");if(d.length>0){var b=(c/d.length).toFixed(0);$("#employee-target-container input[name='total']").val(b);
}}});$("#count-btn").on("click",function(){var b=parseInt($("#groupTargetForm input[name='countTarget']").val());$("#employee-target-container input[name='countTarget']").val(b);
});$(document).on("change","#employee-target-container input[name='total']",function(){var c=$("#employee-target-container input[name='total']");var b=0;
if(c.length>0){$.each(c,function(){b=b+parseInt($(this).val()==""?0:$(this).val());});}$("#groupTargetForm input[name='total']").val(b);});$("body").on("click",".saveBtn",function(){a._save();
});$(document).on("click",".deleteBtn",function(){var b=$(this).parent(".group-target-3").attr("data-id");a._delete(b);});$(document).on("click",".detailBtn",function(){var b=$(this).parent(".group-target-3").attr("data-id");
a._detail(b);});$(document).on("click",".editBtn",function(){var b=$(this).parent(".group-target-3").attr("data-id");a._edit(b);});$(document).on("click","#groupTargetPageContainer .next-page",function(){if($(this).hasClass("no")){return;
}$(this).addClass("no");a.listData.page=a.listData.page+1;a.loadListData();});$(document).on("click","#groupTargetPageContainer .pre-page",function(){if($(this).hasClass("no")){return;
}$(this).addClass("no");a.listData.page=a.listData.page-1;a.loadListData();});$(window).on("resize",function(){a._dealStyle();});$("body").on("click",".groupTargetSearch",function(){a.loadListData();
});$("body").on("change","[name='type']",function(){a.targetType=$(this).val();});$("body").on("click",".preMonthBtn",function(){var c=$("#search-period-month").val();
if(c==""){c=new Date.getMonth()+1;}c=parseInt(c);c=c-1;if(c<=0){c=12;var b=$("#search-period-year").val();if(b!=""){b=parseInt(b)-1;$("#search-period-year").val(b);
}}if(c<10){c="0"+c;}$("#search-period-month").val(c);});$("body").on("click",".nextMonthBtn",function(){var c=$("#search-period-month").val();if(c==""){c=new Date.getMonth()+1;
}c=parseInt(c);c=c+1;if(c>12){c=1;var b=$("#search-period-year").val();if(b!=""){b=parseInt(b)+1;$("#search-period-year").val(b);}}if(c<10){c="0"+c;}$("#search-period-month").val(c);
});},_min:function(d,c){return d>c?c:d;},};