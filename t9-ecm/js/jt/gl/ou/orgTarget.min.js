$(function(){var a=new OrgTarget();a.init();});function OrgTarget(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.hadInitGrid=false;
this.currentOrgId=null;this.employeeComplete=new EmployeeComplete();}OrgTarget._CONS_={EDIT_URL:ctx+"/gl/ou/groupTarget/edit.htm",LISTORG_DATA_URL:ctx+"/gl/ou/group/findVisiableGroupTree.htm",LIST_ORG_DATA_URL:ctx+"/gl/ou/groupTarget/listData.htm",DETAIL_URL:ctx+"/gl/ou/groupTarget/detail.htm",APPORTION_DATA_URL:ctx+"/gl/ou/groupTarget/getApportionData.htm",SAVE_APPORTION_URL:ctx+"/gl/ou/groupTarget/saveApportion.htm",ORG_GRID:"#groupTargetGrid",ORG_PAGER:"#groupTargetPager"};
OrgTarget.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this.initOrganizationTree();
this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.group_employee.groupTarget";glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("orgTarget.button.org.detail")){$(".orgTargetDetail").hide();
}if(!ResUtils.canShow("orgTarget.button.apportionEmployee")){$(".orgTargetToEmployee").hide();}if(!ResUtils.canShow("groupTarget.button.apportionGroup")){$(".groupTargetToGroup").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$("#orgTargetTabGrid .form_wrapper .saveBtn").show();
$("#orgTargetTabGrid .hideWhenAdd").hide();$("#orgTargetTabGrid .hidden-when-add").show();if(c){$(".groupTargetSearch").trigger("click");}a.onSelectRow();
}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$("#orgTargetTabGrid .list_wrapper").show();
$("#orgTargetTabGrid .form_wrapper").hide();$("#orgTargetTabGrid .apportion_wrapper").hide();$("#orgTargetTabGrid .groupApportion_wrapper").hide();},_showFormWrapper:function(){$("#orgTargetTabGrid .list_wrapper").hide();
$("#orgTargetTabGrid .form_wrapper").show();},_detail:function(f){var b=this;this._showFormWrapper();this._loadData(f);$("#orgTargetTabGrid .form_wrapper .saveBtn").hide();
$(".hideWhenAdd").show();$(".saveAndToGroup").hide();var c=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getRowData",f);var e=c["period"];var a=c["orgId"];var d="&Q__S__EQ__target.period_="+e;
d+="&treeNodeId="+a;b._initEmpTarget(d);},_apportion:function(b,a){$("#orgTargetTabGrid .list_wrapper").hide();$("#orgTargetTabGrid .apportion_wrapper").show();
this._loadGroupData(b,a);},_groupApportion:function(b,a){$("#orgTargetTabGrid .list_wrapper").hide();$("#orgTargetTabGrid .groupApportion_wrapper").show();
this._loadGroupData(b,a);},_loadData:function(b){var a=this;FormUtils.loadData(OrgTarget._CONS_.DETAIL_URL+"?id="+b,function(c){$("#orgDetailTitle").empty().append(c.orgName+c.period+"部门销售目标："+c.total+"，完成度："+(c.completeTotal/c.total*100).toFixed(0)+"%");
});},_loadGroupData:function(c,b){var a=this;if(b=="group"){FormUtils.loadData(OrgTarget._CONS_.EDIT_URL+"?id="+c,function(e){var f=e.orgName;var d=f+e.period+"月销售目标";
$(".groupApportion_wrapper").find("#groupTargetAppForm input[name='notApportion']").val(e.notAssigned);$(".groupApportion_wrapper").find("#orgPanelTitle").text(d);
a._loadApportionGroupData(e);});}else{FormUtils.loadData(OrgTarget._CONS_.DETAIL_URL+"?id="+c,function(e){var f=e.orgName;var d=f+e.period+"月销售目标：";$("#orgPanelTitle").text(d);
$("#orgPanelTitle").append("<span class='appTotal'></span>");$("#orgPanelTitle").append("，未分配金额：<span class='notApportion'>"+e.notAssigned+"</span>");$("#orgPanelTitle").append(" <button type='button' class='btn btn-sm   btn-primary averageBtn'>平均分配</button>");
a._loadApportionData(e,b);});}},_loadApportionGroupData:function(a){FormUtils.loadData(OrgTarget._CONS_.APPORTION_DATA_URL+"?orgId="+a.orgId+"&id="+a.id,function(h){if(h.success){var g=JSON.parse(h.msg);
var e=g.groupTargetVos;var d=[];var c=false;$(".groupApportion_wrapper").find("#groupTargetAppForm input[name='appTotal']").val(g.canAssagin);var j=new StringBuffer();
var f="";j.append("<input type='hidden' name='apportionType' value='group'>");j.append("<input type='hidden' name='targetId' value='"+a.id+"'>");$(".groupApportion_wrapper").find("#contentTitle").text("分配给部门");
f="部门";for(var b=0;b<e.length;b++){d.push(e[b]);}for(var b=0;b<d.length;b++){if(b%3==0){j.append("<div class='form-group'>");}if(d[b].type=="mgr"){j.append("<div class='col-sm-4'>").append("<label class='col-sm-5 control-label'>"+d[b].name+"(负责人)"+"</label>").append("<div class='col-sm-6'>").append("<input type='text' validateType='default' need-count='"+d[b].needCount+"' id='"+d[b].id+"' value='"+d[b].count+"' class='form-control mgrInput' disabled='disabled'  name='appTarget'></div>").append("<label class='col-sm-1 control-label' style='text-align: left;'>元</label></div>");
}else{j.append("<div class='col-sm-4'>").append("<label class='col-sm-5 control-label'>"+d[b].name+"("+f+")"+"</label>").append("<div class='col-sm-6'>").append("<input type='text' validateType='default' need-count='"+d[b].needCount+"' id='"+d[b].id+"' value='"+d[b].count+"' class='form-control appTarget'  name='appTarget'></div>").append("<label class='col-sm-1 control-label' style='text-align: left;'>元</label></div>");
}if(b%3==2){j.append("</div>");}}$(".groupApportion_wrapper").find("#detailAppform").empty().append(j.toString());if(c){$(".groupApportion_wrapper").find("#containManager").click();
}}});},_loadApportionData:function(b,a){FormUtils.loadData(OrgTarget._CONS_.APPORTION_DATA_URL+"?orgId="+b.orgId+"&type="+a+"&id="+b.id,function(j){if(j.success){var h=JSON.parse(j.msg);
var f=h.groupTargetVos;var e=[];var d=false;$("#orgPanelTitle .appTotal").text(h.canAssagin);var k=new StringBuffer();var g="";k.append("<input type='hidden' name='apportionType' value='"+a+"'>");
k.append("<input type='hidden' name='targetId' value='"+b.id+"'>");if(a=="group"){g="部门";}else{g="员工";k.append("<div class='form-group'>").append("<div class='col-sm-3'><input type='checkbox'  id='containManager' name='containManager'>部门负责人是否参与销售</div>");
for(var c=0;c<f.length;c++){if(f[c].type=="mgr"){e.push(f[c]);if(parseInt(f[c].count)>0){d=true;}f.splice(c,1);c--;}}k.append("</div><hr style='margin-top:0px;margin-bottom:10px;' />");
}for(var c=0;c<f.length;c++){e.push(f[c]);}for(var c=0;c<e.length;c++){if(c%4==0){k.append("<div class='form-group' style='text-align:center'>");}if(e[c].type=="mgr"){k.append("<div class='col-sm-3'>");
k.append("<img class='jt-employee-img' style='height:70px;width:70px;border-radius: 50%;' src='"+ctx+e[c].profile+"'>");k.append("<p style='margin:0px;font-size:13px;'>"+e[c].aid+":"+e[c].name+"</p>");
k.append("<label class='col-sm-3 control-label'>目标：</label>");k.append("<div class='col-sm-8'>");k.append("<input type='text' validateType='default' need-count='"+e[c].needCount+"' id='"+e[c].id+"' value='"+e[c].count+"' class='form-control mgrInput' disabled='disabled'  name='appTarget'>");
k.append("</div>");k.append("</div>");}else{k.append("<div class='col-sm-3'>");k.append("<img class='jt-employee-img' style='height:70px;width:70px;border-radius: 50%;' src='"+ctx+e[c].profile+"'>");
k.append("<p style='margin:0px;font-size:13px;'>"+e[c].aid+":"+e[c].name+"</p>");k.append("<label class='col-sm-3 control-label'>目标：</label>");k.append("<div class='col-sm-8'>");
k.append("<input type='text' validateType='default' need-count='"+e[c].needCount+"' id='"+e[c].id+"' value='"+e[c].count+"' class='form-control appTarget'  name='appTarget'>");
k.append("</div>");k.append("</div>");}if(c%4==3){k.append("</div>");}}$("#detailAppform").empty().append(k.toString());if(d){$("#containManager").click();
}}});},initOrganizationTree:function(){var a=this;var b={async:{enable:true,url:OrgTarget._CONS_.LISTORG_DATA_URL,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"]},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{onClick:function(c,e,d){$(".list_wrapper").show();
$(".form_wrapper").hide();a.currentClickTreeNode=d;a._selectOrg(d);},onAsyncSuccess:function(d,j,l,f){var g=$.fn.zTree.getZTreeObj("organizationTree");
if(l){var m=l.children;for(var h=0;h<m.length;h++){if(m[h].isParent==true){m[h].icon=ctx+"/js/zTree_v3/css/zTreeStyle/img/jt-diy/jt-16.png";}else{m[h].icon=ctx+"/js/zTree_v3/css/zTreeStyle/img/jt-diy/jt-30.png";
}g.updateNode(m[h]);}}else{var c=g.getNodes();for(var h=0;h<c.length;h++){c[h].icon=ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy/jt-orgRoot.png";
g.updateNode(c[h]);}}if(l==null){var g=$.fn.zTree.getZTreeObj("organizationTree");var k=g.getNodes();if(k&&k.length){var e=k[0];g.expandNode(e,true,false,true);
g.selectNode(e);a.currentClickTreeNode=e;a._selectOrg(e);}}}},view:{selectedMulti:false}};$.fn.zTree.init($("#organizationTree"),b);},_selectOrg:function(b){var a=this;
a.currentOrgId=b.id;a.employeeComplete.init({treeNodeId:a.currentOrgId});if(!a.hadInitGrid){a.hadInitGrid=true;a._initOrgTargertJqgrid({treeNodeId:a.currentOrgId});
a.onSelectRow();}else{$(".groupTargetSearch").trigger("click");}},onSelectRow:function(c,a){var b=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getGridParam","selarrrow");
if(b.length==1){var d=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getRowData",b);if(d.hasEmployee=="y"){$(".orgTargetToEmployee").attr("disabled",false);}if(d["period"].substring(0,4)!=(new Date()).getFullYear()||d["period"].substring(5,7)!=(new Date()).getMonth()+1){$(".orgTargetToEmployee").attr("disabled",true);
}if(d.hasGroup=="y"){$(".groupTargetToGroup").attr("disabled",false);}if(d["period"].substring(0,4)!=(new Date()).getFullYear()||d["period"].substring(5,7)!=(new Date()).getMonth()+1){$(".groupTargetToGroup").attr("disabled",true);
}$(".orgTargetDetail").attr("disabled",false);}else{$(".orgTargetToEmployee").attr("disabled",true);$(".groupTargetToGroup").attr("disabled",true);$(".orgTargetDetail").attr("disabled",true);
}},_saveApportion:function(g){var j=this;var b="0";var a="0";var i="";if(g=="emp"){b=$(".apportion_wrapper").find("#orgPanelTitle .appTotal").text();a=$(".apportion_wrapper").find("#orgPanelTitle .notApportion").text();
g=$(".apportion_wrapper").find("input[name='apportionType']").val();i=$(".apportion_wrapper").find("input[name='targetId']").val();}if(g=="group"){b=$(".groupApportion_wrapper").find("input[name=appTotal]").val();
a=$(".groupApportion_wrapper").find("input[name=notApportion]").val();g=$(".groupApportion_wrapper").find("input[name='apportionType']").val();i=$(".groupApportion_wrapper").find("input[name='targetId']").val();
}var e=$("input[name=appTarget]");var d=[];if(b==a){DialogUtils.error(msgCode.INFO,"尚未进行分配，不可保存");return false;}if(a<0){DialogUtils.error(msgCode.INFO,"未分配金额小于0，请重新分配");
return false;}var f=false;e.each(function(){var k={};k.id=$(this).attr("id");var l=$(this).attr("need-count");k.value=$(this).val();if(parseInt(k.value)<parseInt(l)){$(this).focus();
DialogUtils.error(msgCode.INFO,"目标已分配下去,至少需要"+parseInt(l));f=true;return false;}if(k.value!=null&&k.value!=""){d.push(k);}});if(f){return false;}var c={items:d,type:g,targetId:i,notAssigned:a};
var h=OrgTarget._CONS_.SAVE_APPORTION_URL;FormUtils.submit(h,{jsonStr:JSON.stringify(c)},function(k){if(k.success){DialogUtils.success(msgCode.INFO,"分摊成功");
j.clear(true);}else{DialogUtils.error(msgCode.INFO,"分摊失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHander:function(){var a=this;
$("body").on("click",".orgTargetDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("#orgTargetTabGrid").on("click",".prevBtn",function(){a.clear(false);});$("body").on("click",".orgTargetToEmployee",function(){var b=$(this).attr("idVal");
if(!b){b=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要分摊的目标记录");return;
}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,"不能选择多条记录");return;}}}a._apportion(b,"employee");});$("body").on("click",".groupTargetToGroup",function(){var b=$(this).attr("idVal");
if(!b){b=$(OrgTarget._CONS_.ORG_GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要分摊的目标记录");return;
}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,"不能选择多条记录");return;}}}a._groupApportion(b,"group");});$(document).on("click","#containManager",function(){var b=$(this)[0].checked;
if(b){$(".mgrInput").addClass("appTarget");$(".mgrInput").attr("disabled",false);}else{$(".mgrInput").removeClass("appTarget");$(".mgrInput").val("0");
$(".mgrInput").attr("disabled",true);}$($(".appTarget")[0]).keyup();});$(".list_wrapper").on("click",".groupTargetSearch",function(){var b=$(this).closest("form").serialize()+"&treeNodeId="+a.currentOrgId;
a.reloadJqgrid(b);});$("#orgTargetSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".groupTargetSearch").trigger("click");return false;}});
$("body").on("click",".saveApportionBtn",function(){a._saveApportion("emp");});$("body").on("click",".saveGroupApportionBtn",function(){a._saveApportion("group");
});$(document).on("keyup",".appTarget",function(){$(this).val($(this).val().replace(/\D/,""));var c=$(this).parents(".apportionDiv").find(".appTarget");
var f=$(this).parents(".apportionDiv").find(".appTotal").text();if(!f){f=$(this).parents(".apportionDiv").find(".appTotal").val();}var e=0;var b=c.length;
c.each(function(){if($(this).val()!=null&&$(this).val()!=""){e+=parseInt($(this).val());}});var d=f-e;$(".apportion_wrapper").find("#orgPanelTitle .notApportion").text(d);
$(".groupApportion_wrapper").find("input[name=notApportion]").val(d);});$("body").on("click",".averageBtn",function(){var e=$(".appTotal").text();var b=$(this).parent().parent().next().find(".appTarget");
if(b.length<=0){return;}var d=parseInt(e/b.length);for(var c=0;c<b.length;c++){$(b[c]).val(d);}$(this).prev().text(e-d*b.length);});$("body").on("click",".averageGroupBtn",function(){var e=$(".groupApportion_wrapper").find(".appTotal").val();
var b=$(".groupApportion_wrapper").find(".appTarget");if(b.length<=0){return;}var d=parseInt(e/b.length);for(var c=0;c<b.length;c++){$(b[c]).val(d);}$("input[name='notApportion'").val(e-d*b.length);
});},_bindFormValidation:function(){var a={rules:{appTarget:{required:true,digits:true}},messages:{}};FormUtils.bindFormValidation("detailAppform",a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(OrgTarget._CONS_.ORG_GRID,a);
},_initOrgTargertJqgrid:function(b){if(b==null||typeof b==undefined){b={};}var a=this;$(OrgTarget._CONS_.ORG_GRID).JTJqgrid({url:OrgTarget._CONS_.LIST_ORG_DATA_URL,pager:OrgTarget._CONS_.ORG_PAGER,postData:b,colNames:["目标名称","归属类型(隐藏)","部门id","部门","目标金额","完成金额","目标完成率","目标差额","日均需达","目标时间","状态(隐藏)","状态","是否达成","是否能删除(隐藏)","创建时间","更新时间","是否有子部门(隐藏)","是否有员工(隐藏)",],colModel:[{name:"name",index:"name_",width:120},{name:"belongType",index:"belong_type_",hidden:true,width:120,formatter:function(c){if(c=="company"){return"公司目标";
}else{return"指定部门目标";}}},{name:"orgId",index:"org_id_",width:120,hidden:true},{name:"orgName",index:"org_id_",width:120},{name:"total",index:"total_",width:120},{name:"completeTotal",width:120},{name:"completeRate",width:120},{name:"differentValue",width:120},{name:"targetForDay",width:120},{name:"period",index:"period_",width:120},{name:"statusHide",index:"status_",hidden:true,width:100,formatter:function(c,d,e){return e.status;
}},{name:"status",index:"status_",width:100,formatter:function(c){if(c=="publish"){return"<span class='text-warning'>发布</span>";}else{if(c=="assign"){return"<span class='text-info'>已分配</span>";
}else{return"<span>草稿</span>";}}}},{name:"isComplete",index:"is_complete_",width:100,formatter:function(c){if(c=="y"){return"<span class='text-info'>是</span>";
}else{return"<span>否</span>";}}},{name:"canDelete",hidden:true},{name:"createTime",index:"create_time_",width:120,classes:"autoHideCol",formatter:function(c){return DateUtils.miniTime(c);
}},{name:"updateTime",index:"update_time_",width:120,classes:"autoHideCol",formatter:function(c){return DateUtils.miniTime(c);}},{name:"hasGroup",hidden:true},{name:"hasEmployee",hidden:true}],onSelectRow:function(d,c){a.onSelectRow(d,c);
}});},_initEmpTarget:function(a){FormUtils.loadData(ctx+"/gl/ou/employeeComplete/listData.htm?"+a,function(c){var e=new StringBuffer();for(var b=0;b<c.length;
b++){var d=(c[b].count/c[b].target*100).toFixed(0);if(b%4==0){e.append("<div class='form-group' style='text-align:center'>");}e.append("<div class='col-sm-3'>");
e.append("<img class='jt-employee-img' style='height:70px;width:70px;border-radius: 50%;' src='"+ctx+c[b].employeeProfile+"'>");e.append("<p style='margin:0px;font-size:14px;'>"+c[b].employeeAid+":"+c[b].employeeName+"</p>");
e.append("<p style='margin:0px;font-size:14px;'>完成度：");if(d>100){e.append("<span style='color:#1caf9a;'>"+d+"%</span></p>");}else{e.append("<span style='color:red'>"+d+"%</span></p>");
}e.append("<p style='margin:0px;font-size:14px;'>金额："+c[b].count+"/"+c[b].target+"</p>");e.append("</div>");if(b%4==3){e.append("</div>");}}$("#orgDetailForm").empty().append(e.toString());
});},};