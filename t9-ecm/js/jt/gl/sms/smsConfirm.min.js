$(function(){var a=new SmsConfirm();a.init();});function SmsConfirm(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}SmsConfirm._CONS_={EDIT_URL:ctx+"/gl/sms/smsConfirm/edit.htm",DELETE_URL:ctx+"/gl/sms/smsRecord/delete.htm",LIST_DATA_URL:ctx+"/gl/sms/smsConfirm/listData.htm",LIST_STATIC_URL:ctx+"/gl/sms/smsConfirm/listStatic.htm",RESEND_RECORD_URL:ctx+"/gl/sms/smsConfirm/resend.htm",CONFIRM_URL:ctx+"/gl/sms/smsConfirm/batchConfirm.htm",UNPASS_CONFIRM_URL:ctx+"/gl/sms/smsConfirm/batchUnpassConfirm.htm",EDIT_FORM_ID:"smsConfirmForm",RECEIVE_GRID:"#smsReceiveGrid",RECEIVE_PAGER:"#smsReceivePager",SEND_GRID:"#smsSendGrid",SEND_PAGER:"#smsSendPager",FAIL_SEND_GRID:"#smsFailSendGrid",FAIL_SEND_PAGER:"#smsFailSendPager"};
SmsConfirm.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this._initjQGrid();
this._initSelect();}},_initSelect:function(){this._initGroupSelect();this._initEmployeeSelect();},_initGroupSelect:function(){var a=this;$(".groupName").on("click",function(){var c=$(this);
var b={isMultiple:0,selectedGroupId:c.parents(".tab-pane").find("input[name='belongOgn']").val(),container:c.parents(".tab-pane").attr("id")+" .groupName",nolimit:true,positionType:"dept_manager",fn:function(e,f,d){c.parents(".tab-pane").find(".groupName").val(d);
c.parents(".tab-pane").find("input[name='belongOgn']").val(e);a._initEmployeeSelect(e,c.parents(".tab-pane").attr("id"));}};GroupUtils.selectGroupTreeBox(b);
});},_initEmployeeSelect:function(a,b){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+(a?a:"")+"&type=dept_manager",function(d){if(b){$("#"+b).find("[name=Q__S__EQ__create_by_]").empty();
}else{$("[name=Q__S__EQ__create_by_]").empty();}var e=new StringBuffer();e.append("<option value=''>请选择</option>");if(d&&d.length){for(var c=0;c<d.length;
c++){e.append("<option value='"+d[c].id+"'>"+d[c].aid+":"+d[c].name+"</option>");}if(b){$("#"+b).find("[name=Q__S__EQ__create_by_]").append(e.toString()).select2();
}else{$("[name=Q__S__EQ__create_by_]").append(e.toString()).select2();}}},null,true);},_initjQGrid:function(){$("body").find("#tabWaiting .smsRecordDelete").remove();
$("body").find("#tabUnpass .smsConfirmConfirm").remove();$("body").find("#tabUnpass .smsConfirmUnpass").remove();this._initGrid("Q__S__EQ__result_=WAITING-CONFIRM","#tabWaiting-smsConfirmGrid","#tabWaiting-smsConfirmPager");
this._initGrid("Q__S__EQ__result_=UNPASS-CONFIRM","#tabUnpass-smsConfirmGrid","#tabUnpass-smsConfirmPager");},_hideNotGrantBtn:function(){if(!ResUtils.canShow("smsConfirm.button.delete")){$(".smsRecordDelete").hide();
}if(!ResUtils.canShow("smsConfirm.button.confirm")){$(".smsConfirmConfirm").hide();}if(!ResUtils.canShow("smsConfirm.button.unpass")){$(".smsConfirmConfirm").hide();
$(".smsConfirmUnpass").hide();}},_confirm:function(b){var a=this;FormUtils.del(SmsConfirm._CONS_.CONFIRM_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
a._reloadAlljQgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_unPassConfirm:function(b){var a=this;FormUtils.del(SmsConfirm._CONS_.UNPASS_CONFIRM_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
a._reloadAlljQgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(SmsConfirm._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._reloadAlljQgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$("body").on("click","#tabWaiting .smsRecordSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b,"#tabWaiting-smsConfirmGrid");});$("body").on("click","#tabUnpass .smsRecordSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b,"#tabUnpass-smsConfirmGrid");});$(document).on("click",".smsConfirmConfirm",function(){var b=$(this).attr("idVal");if(!b){b=$("#tabWaiting-smsConfirmGrid").jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择记录");return;}}a._confirm(b);});$(document).on("click",".smsConfirmUnpass",function(){var b=$(this).attr("idVal");
if(!b){b=$("#tabWaiting-smsConfirmGrid").jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择记录");return;}}a._unPassConfirm(b);
});$("body").on("click","#tabWaiting .smsRecordDelete,#tabUnpass .smsRecordDelete",function(){var b=$(this).attr("idVal");if(!b){var d=null;var e=$(this);
var c=e.parents(".tab-pane").attr("id");if("tabUnpass"==c){d="#tabUnpass-smsConfirmGrid";}b=$(d).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".csTab",function(){var c=$(this).text();var b=$(this).attr("value");if(c.length>5){c="*"+c.substring(c.length-4,c.length);
}JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detail.htm?csId="+b,"客户["+c+"]");});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(SmsConfirm._CONS_.EDIT_FORM_ID,a);
},_getManagerBtns:function(b){var a=[];if("#tabWaiting-smsConfirmGrid"==b){if(ResUtils.canShow("smsConfirm.button.confirm")){a.push({lable:"通过",btnClasses:"btn btn-primary smsConfirmConfirm",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("smsConfirm.button.unpass")){a.push({lable:"不通过",btnClasses:"btn btn-warning smsConfirmUnpass",iconClasses:"fa fa-edit"});}}else{if("#tabUnpass-smsConfirmGrid"==b){if(ResUtils.canShow("smsConfirm.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger smsRecordDelete",iconClasses:"fa fa-remove"});
}}}return a;},_reloadAlljQgrid:function(){var a=this;var a=this;a.reloadJqgrid($("#tabWaiting .smsSearchForm").serialize(),"#tabWaiting-smsConfirmGrid");
a.reloadJqgrid($("#tabUnpass .smsSearchForm").serialize(),"#tabUnpass-smsConfirmGrid");},reloadJqgrid:function(b,a){a=a?a:"tabWaiting-smsConfirmGrid";JTJqgridUtils.reloadJqgrid(a,b);
},_initGrid:function(f,e,d){var c=this;if(f==null||f==undefined){f="";}var b=new Date().currentDate()+" 00:00:00";$(".startCreateTime").val(b);var a={Q__D__BW__create_time_:b,};
$(e).JTJqgrid({url:SmsConfirm._CONS_.LIST_DATA_URL+"?"+f,pager:d,postData:a,width:this.width,rownumbers:true,colNames:["客户ID（隐藏）","客户编号","号码","归属工号","方向","结果","创建时间","到达时间","内容","操作"],colModel:[{name:"csId",index:"cs_id_",width:100,hidden:true},{name:"csCode",index:"cs_code_",width:60,sortable:false,formatter:function(g,h,i){if(ResUtils.canShow("sms.button.csInfo")){return"<a href='#' class='csTab' title='"+g+"' value='"+i.csId+"''>"+g+(g?(":"+i.csName):"")+"</a>";
}else{return g+(g?(":"+i.csName):"");}}},{name:"mobile",width:60,sortable:false},{name:"employeeAid",index:"employee_aid_",width:60},{name:"type",index:"type_",width:30,formatter:function(g){if("receive"==g){return"接收";
}else{return"发送";}}},{name:"result",index:"result_",width:30,formatter:function(g){if(g=="SUCCESS"){return"<span class='text-success'>成功</span>";}else{if(g=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";
}else{if(g=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";}else{if(g.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>";
}else{if(g.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>";}}}}}}},{name:"createTime",index:"create_time_",width:70,formatter:function(g){return DateUtils.miniTime(g);
}},{name:"successTime",index:"success_time_",width:70,hidden:true,formatter:function(i,g,h){if(i){return i;}else{return h.createTime;}}},{name:"content",index:"content_",width:400,formatter:function(i,g,h){var j=new StringBuffer();
j.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");j.append(i);j.append("</div>");return j.toString();}},{name:"__manage",width:80,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns(e)}]});
},};