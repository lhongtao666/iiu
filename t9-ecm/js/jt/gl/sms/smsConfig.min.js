$(function(){var a=new SmsConfig();a.init();});function SmsConfig(){this.hadInit=false;}SmsConfig._CONS_={EDIT_URL:ctx+"/gl/sms/smsConfig/edit.htm",DETAIL_URL:ctx+"/gl/sms/smsConfig/detail.htm",DELETE_URL:ctx+"/gl/sms/smsConfig/delete.htm",SAVE_ADD_URL:ctx+"/gl/sms/smsConfig/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/sms/smsConfig/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/sms/smsConfig/listData.htm",SEARCH_BALANCE_URL:ctx+"/gl/sms/smsConfig/checkSimBalance.htm",PLUS_SEND_COUNT:ctx+"/gl/sms/smsConfig/plusSendCount.htm"};
SmsConfig.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._initData();this._bindEventHander();this._bindFormValidation();this._initGroupSelect();
this._locateToGlHelp();}},_initData:function(){var a=this;FormUtils.loadData(ctx+"/gl/sms/smsConfig/listAllPlatForm.htm",function(g){a.arr={};a.arr["manual"]="短信猫";
if(g&&g.length){for(var d=0;d<g.length;d++){var h=g[d];a.arr[h.key]=h.name;}}var j=new StringBuffer();for(var c in a.arr){var f=a.arr[c];var e="manual"==c?"selected":"";
var b="<option value='"+c+"' "+e+">"+f+"</option>";j.append(b);}$("#smsConfigFormServiceType").empty().append(j.toString());a._loadSmsConfig();});},_locateToGlHelp:function(){var a="glHelp.systemconfig.smsConfig";
glHelpUtil.init(a);},_bindFormValidation:function(){var a={rules:{name:{required:true},ip:{required:true},dayLimit:{required:true}}};FormUtils.bindFormValidation("smsConfigForm",a);
},_initGroupSelect:function(){var a=this;$("body").on("click",".groupNames",function(){var c=$(this);var b={isMultiple:1,isSmsConfigHtml:true,selectedGroupId:c.parents("td").find("[name='groupIds']").val(),container:c.parents("td").attr("class")+" .groupNames",nolimit:true,fn:function(e,f,d){c.parents("td").find(".groupNames").val(d);
c.parents("td").find("[name='groupIds']").val(e);}};GroupUtils.selectGroupTreeBox(b);});},_bindEventHander:function(){var a=this;$(document).on("click","#addGroupNames",function(){var b={isMultiple:1,selectedGroupId:$("#addGroupIds").val(),container:"addGroupNames",positionType:"all",fn:function(c){$("[name=addGroupIds]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$("body").on("click",".smsConfigTestBtn",function(){a.$tr=$(this).parents("tr");$("#sendMsgModalContainer").modal("show");
var b=a.$tr.find("[name=name]").val();$('textarea[name="sendContent"]').val(b);});$("#sendBtn").on("click",function(){var c=a.$tr;var e=c.attr("ip");var b="http://"+e+"/t9-sms/jt/gl/sms/sendMsgBySyn.htm";
var d={receivers:$('input[name="sendTel"]').val(),message:$('textarea[name="sendContent"]').val()};FormUtils.submit(b,d,function(f){if(f.success){if(f&&(f.success)){$('textarea[name="sendContent"]').val("发送短信操作成功,请稍后检查有没有收到短信...");
DialogUtils.success(msgCode.SUCCESS,"发送查询短信成功,请稍候查看结果");}else{var g=f.msg||"发送失败";$('textarea[name="sendContent"]').val(g);DialogUtils.error(msgCode.ERROR,g);
}}else{DialogUtils.error(msgCode.FAIL,f.msg);}},function(){$('textarea[name="sendContent"]').val("发送请求出错,请检查短信猫配置是否正确");DialogUtils.error(msgCode.ERROR,"发送请求出错,请检查短信猫配置是否正确");
},false);});$("body").on("click",".smsConfigDeleteBtn",function(){a._delete($(this).parents("tr").attr("idVal"));});$("body").on("click",".addRow",function(){$("#orgModalLabel").text("添加短信猫");
$("#smsConfigModalContainer").modal("show");});$("body").on("click","#saveBtn",function(){a._save();});$("body").on("click","#smsConfigSaveBtn",function(){a._editSave(this);
});$("body").on("click",".smsConfigBalanceBtn",function(){a._searchBalance(this);});$("body").on("change","input[name=name]",function(){$(this).removeClass("validate_input_error");
});$("body").on("change","input[name=ip]",function(){$(this).removeClass("validate_input_error");});$("body").on("change","input[name=dayLimit]",function(){$(this).removeClass("validate_input_error");
});$("body").on("change","input[name=name],input[name=ip],input[name=port],input[name=simNumber],input[name=dayLimit],select[name=serviceType],select[name=valid],.sendTypeManual,.sendTypeSys",function(){$(this).parents("tr").attr("style","background-color:#CCE5F9;");
});},_editSave:function(j){var m=this;var l=$(j).closest("tr");if(l.find("input[name=name]").first().val()==""){l.find("input[name=name]").first().addClass("validate_input_error");
DialogUtils.error("提示","请输入名称");return;}if(l.find("input[name=ip]").first().val()==""){l.find("input[name=ip]").first().addClass("validate_input_error");
DialogUtils.error("提示","请输入服务器或授权");return;}var k=l.find("input[name=dayLimit]").first().val();if(k<0){l.find("input[name=dayLimit]").first().addClass("validate_input_error");
DialogUtils.error("提示","请输入大于或等于0的数字");return;}var b=/^\d*\.\d+$/;var e=l.find("input[name=warmMoney]").first().val();if(e){if(b.test(e)){l.find("input[name=warmMoney]").first().addClass("validate_input_error");
DialogUtils.error("提示","请输入浮点数字");return;}if(e>999){l.find("input[name=warmMoney]").first().addClass("validate_input_error");DialogUtils.error("提示","请输入小于三位数浮点数");
return;}if(e<0.01){l.find("input[name=warmMoney]").first().addClass("validate_input_error");DialogUtils.error("提示","请输入小于三位数浮点数");return;}}var a=/^[1][3,4,5,7,8][0-9]{9}$/;
var c=l.find("input[name=warnTo]").first().val();if(c){var h=new Array();h=c.split(",");if(h.length>5){l.find("input[name=warnTo]").first().addClass("validate_input_error");
DialogUtils.error("提示","最多可填五个手机号码");return;}for(var g=0;g<h.length;g++){if(h[g]){if(!a.test(h[g])){l.find("input[name=warnTo]").first().addClass("validate_input_error");
DialogUtils.error("提示",h[g]+"手机号有误");return;}}}}var d="";if(l.find("select[name=valid]").val()=="y"){d="sys,manual";}var f={"id":l.attr("idVal"),"name":l.find("input[name=name]").first().val(),"ip":l.find("input[name=ip]").first().val(),"simNumber":l.find("input[name=simNumber]").first().val(),"valid":l.find("select[name=valid]").first().val(),"serviceType":l.find("select[name=serviceType]").first().val(),"sendType":d,"groupIds":l.find("[name=groupIds]").val(),"dayLimit":l.find("input[name=dayLimit]").first().val(),"createTime":l.attr("createtimeval"),"warmMoney":l.find("input[name=warmMoney]").first().val(),"warnTo":l.find("input[name=warnTo]").first().val(),};
ButtonUtils.disableBtn("smsConfigSaveBtn");FormUtils.submit(SmsConfig._CONS_.SAVE_EDIT_URL,f,function(i){ButtonUtils.enableBtn("smsConfigSaveBtn");if(i.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(i.msgCode==actionCode.UPDATE){l.removeAttr("style");DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}},function(){ButtonUtils.enableBtn("smsConfigSaveBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_save:function(){var k=this;var j=$("#smsConfigForm").find("[name=id]").val()?SmsConfig._CONS_.SAVE_EDIT_URL:SmsConfig._CONS_.SAVE_ADD_URL;
var c=/^\d*\.\d+$/;var f=$("#smsConfigForm").find("input[name=warmMoney]").val();if(c.test(f)){$("#smsConfigForm").find("input[name=warmMoney]").addClass("validate_input_error");
DialogUtils.error("提示","请输入浮点数字");return;}if(f>999){$("#smsConfigForm").find("input[name=warmMoney]").addClass("validate_input_error");DialogUtils.error("提示","请输入小于三位数浮点数");
return;}if(f<0.01){$("#smsConfigForm").find("input[name=warmMoney]").addClass("validate_input_error");DialogUtils.error("提示","请输入小于三位数浮点数");return;}var a=/^[1][3,4,5,7,8][0-9]{9}$/;
var d=$("#smsConfigForm").find("input[name=warnTo]").val();var h=new Array();h=d.split(",");if(h.length>5){thisTr.find("input[name=warnTo]").first().addClass("validate_input_error");
DialogUtils.error("提示","最多可填五个手机号码");return;}for(var g=0;g<h.length;g++){if(h[g]){if(!a.test(h[g])){$("#smsConfigForm").find("input[name=warnTo]").addClass("validate_input_error");
DialogUtils.error("提示",h[g]+"手机号有误");return;}}}if($("#smsConfigForm").valid()){if($("#smsConfigForm").find("select[name=serviceType]").val()=="sys"){$("#smsConfigForm").find("select[name=sendType]").val("sys");
}else{$("#smsConfigForm").find("select[name=sendType]").val("manual");}if($("#smsConfigForm").find("select[name=valid]").val()=="n"){$("#smsConfigForm").find("select[name=sendType]").val("");
}var e="";if($("#smsConfigForm").find("select[name=valid]").val()=="y"){e="sys,manual";}var b=$("#smsConfigForm").find("#addGroupIds").val();FormUtils.submit(j,$("#smsConfigForm").serialize()+"&sendType="+e+"&groupIds="+b,function(i){if(i.success){FormUtils.clear("smsConfigForm");
$("#smsConfigModalContainer").modal("hide");if(i.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(i.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}k._loadSmsConfig();}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(SmsConfig._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._loadSmsConfig();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_searchBalance:function(c){var b=$(c).closest("tr").attr("status");if(b=="false"){DialogUtils.error(msgCode.ERROR,"短信猫不可用，无法查询余额！");
return;}var d=$(c).closest("tr").attr("idVal");var a=$(c).closest("tr").find(".balanceTotal");$(c).closest("tr").find(".smsConfigBalanceBtn").attr("disabled",true);
FormUtils.submit(SmsConfig._CONS_.SEARCH_BALANCE_URL+"?id="+d,null,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);$(c).closest("tr").find(".smsConfigBalanceBtn").attr("disabled",false);
}else{DialogUtils.error(msgCode.ERROR,e.msg);}},null,false);},_loadSmsConfig:function(){var a=this;FormUtils.loadData(SmsConfig._CONS_.LIST_DATA_URL+"?sidx=name_&sord=desc",function(d){var d=d;
var f=new StringBuffer();for(var c=0;c<d.length;c++){var e=d[c];var b=a._createRow(e,c+1);f.append(b);}$("#dataTableBody").empty().append(f.toString());
});},_createRow:function(c,d){var i=this;var e=new StringBuffer();e.append("<tr groupIds='"+c.groupIds+"' idVal='"+c.id+"' ip='"+c.ip+"' createTimeVal='"+c.createTime+"' status='"+c.status+"'>");
e.append("<td>");e.append(d+"");if(c.serviceType=="manual"&&c.status=="true"){e.append("<img src='"+ctx+"/img/jt/sms/statusTrue.png'  style='width: 25px;margin-left: 10px;'>");
}else{if(c.serviceType=="manual"){e.append("<img src='"+ctx+"/img/jt/sms/statusFalse.png'  style='width: 25px;margin-left: 10px;'>");}}e.append("</td>");
e.append("<td>");e.append("<input type='text' name='name' class='form-control' validateType='default' value="+c.name+">");e.append("</td>");e.append("<td>");
e.append("<input type='text' name='ip' class='form-control' validateType='default' value="+c.ip+" >");e.append("</td>");e.append("<td>");e.append("<input type='text' name='simNumber' class='form-control' validateType='default' value="+c.simNumber+">");
e.append("</td>");e.append("<td>");e.append("<select class='form-control' name='serviceType'>");for(var h in i.arr){var g=i.arr[h];var a=c.serviceType==h?"selected":"";
var f="<option value='"+h+"' "+a+">"+g+"</option>";e.append(f);}e.append("</select>");e.append("</td>");e.append("<td style='display:none;'>");e.append("<div class='checkbox checkbox-success checkbox-inline'>");
if(c.sendType.indexOf("sys")>-1){e.append("<input type='checkbox' class='sendTypeSys' value='sys' checked>");}else{e.append("<input type='checkbox' class='sendTypeSys' value='sys'>");
}e.append("<label>系统</label>");e.append("</div>");e.append("<div class='checkbox checkbox-success checkbox-inline sendTypeManualDiv'>");if(c.sendType.indexOf("manual")>-1){e.append("<input type='checkbox' class='sendTypeManual' value='manual' checked>");
}else{e.append("<input type='checkbox' class='sendTypeManual' value='manual'>");}e.append("<label>人工</label>");e.append("</div>");e.append("<td>");e.append("<div class='col-sm-4' style='padding-left:2px;padding-right:2px;'>");
var b=c.dayLimit;if(c.dayLimit==null||c.dayLimit==""){b=0;}b=parseInt(b);e.append("<input type='number' class='form-control' validateType='default' value="+b+" name='dayLimit'>");
e.append("</div>");e.append("<span>（当日发送"+c.currentTimes+"）</span>");e.append("</td>");e.append('<td class="'+c.id+'">');e.append("<input type='text' class='groupNames form-control' validateType='default' value="+c.groupNames+">");
e.append('<input type="hidden" value="'+c.groupIds+'" name="groupIds" >');e.append("</td>");e.append("<td>");e.append("<select class='form-control' name='valid'>");
if(c.valid=="y"){e.append("<option value='y' selected>").append("是</option>");e.append("<option value='n'>").append("否</option>");}else{e.append("<option value='y'>").append("是</option>");
e.append("<option value='n' selected>").append("否</option>");}e.append("</select>");e.append("</td>");e.append("<td>");e.append("<input type='number' maxlength='4'  class='form-control' validateType='default'  value='"+c.warmMoney+"' name='warmMoney'>");
e.append("</td>");e.append("<td>");e.append("<input type='text' placeholder='以，逗号隔开' class='form-control'  validateType='default' value='"+c.warnTo+"' name='warnTo'>");
e.append("</td>");e.append("<td>");e.append("<button class='btn btn-sm btn-outline btn-primary' id='smsConfigSaveBtn' type='button'>保存</button>&nbsp");
e.append("<button class='btn btn-sm btn-outline btn-danger smsConfigDeleteBtn' type='button'>删除</button>&nbsp");e.append("<button class='btn btn-sm btn-outline btn-primary smsConfigTestBtn' type='button'>测试</button>&nbsp");
if(c.serviceType=="manual"||c.serviceType=="qyxs"||c.serviceType=="hxkj"){e.append("<button class='btn btn-sm btn-outline btn-primary smsConfigBalanceBtn' type='button'>余额</button>");
}e.append("<span class='balanceTotal'></span>");e.append("</td>");e.append("<td>");e.append("<label class='lastBalance'>"+c.lastBalance+"</label>");e.append("</td>");
e.append("</tr>");return e.toString();},};