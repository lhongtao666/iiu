function SmsRecord(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}SmsRecord._CONS_={EDIT_URL:ctx+"/gl/sms/smsRecord/edit.htm",DELETE_URL:ctx+"/gl/sms/smsRecord/delete.htm",LIST_DATA_URL:ctx+"/gl/sms/smsRecord/listData.htm",LIST_STATIC_URL:ctx+"/gl/sms/smsRecord/listStatic.htm",RESEND_RECORD_URL:ctx+"/gl/sms/smsRecord/resend.htm",EDIT_FORM_ID:"smsRecordForm",RECEIVE_GRID:"#smsReceiveGrid",RECEIVE_PAGER:"#smsReceivePager",SEND_GRID:"#smsSendGrid",SEND_PAGER:"#smsSendPager",FAIL_SEND_GRID:"#smsFailSendGrid",FAIL_SEND_PAGER:"#smsFailSendPager"};
SmsRecord.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._hideNotGrantBtn();this._bindFormValidation();this._bindEventHander();this._initjQGrid();
this._initSelect();this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.dataAudit.smsRecord";glHelpUtil.init(a);},_initSelect:function(){this._initGroupSelect();
this._initEmployeeSelect();},_initGroupSelect:function(){var a=this;$(".groupName").on("click",function(){var c=$(this);var b={isMultiple:0,selectedGroupId:c.parents(".tab-pane").find("input[name='belongOgn']").val(),container:c.parents(".tab-pane").attr("id")+" .groupName",nolimit:true,positionType:"dept_manager",fn:function(e,f,d){c.parents(".tab-pane").find(".groupName").val(d);
c.parents(".tab-pane").find("input[name='belongOgn']").val(e);a._initEmployeeSelect(e,c.parents(".tab-pane").attr("id"));}};GroupUtils.selectGroupTreeBox(b);
});},_initEmployeeSelect:function(a,b){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+(a?a:"")+"&type=dept_manager",function(d){if(b){$("#"+b).find("[name=Q__S__EQ__create_by_]").empty();
}else{$("[name=Q__S__EQ__create_by_]").empty();}var e=new StringBuffer();e.append("<option value=''>请选择</option>");if(d&&d.length){for(var c=0;c<d.length;
c++){e.append("<option value='"+d[c].id+"'>"+d[c].aid+":"+d[c].name+"</option>");}if(b){$("#"+b).find("[name=Q__S__EQ__create_by_]").append(e.toString()).select2();
}else{$("[name=Q__S__EQ__create_by_]").append(e.toString()).select2();}}},null,true);},_initjQGrid:function(){var a=new Date().currentDate()+" 00:00:00";
$(".startCreateTime").val(a);if(ResUtils.canShow("smsRecord.button.listStatic")){}else{$("[href='#tabStatic']").parents(".tabli").remove();$("#tabStatic").remove();
}this._initGrid(null,"#allSmsRecordGrid","#allSmsRecordPager");this._initGrid("Q__S__EQ__type_=send","#sendSmsRecordGrid","#sendSmsRecordPager");this._initGrid("Q__S__EQ__type_=send&Q__S__LK__result_=ERROR","#sendFailSmsRecordGrid","#sendFailSmsRecordPager");
this._initGrid("Q__S__EQ__type_=receive","#receiveSmsRecordGrid","#receiveSmsRecordPager");$("body").find("#tabSend .smsSearchForm").find(".smsType").remove();
$("body").find("#tabSendFail .smsSearchForm").find(".smsType").remove();$("body").find("#tabSendFail .smsSearchForm").find(".smsResult").remove();$("body").find("#tabReceive .smsSearchForm").find(".smsType").remove();
$("body").find("#tabReceive .smsSearchForm").find(".smsResult").remove();$("body").find("#tabSendFail .btnGroup").find(".smsRecordRetry").show();},_reloadAlljQgrid:function(){var b=this;
var d=$("#tabStatic .smsSearchForm").serialize();b.reloadJqgrid(d,"#staticSmsRecordGrid");var c=$("#tabAll .smsSearchForm").serialize();b.reloadJqgrid(c,"#allSmsRecordGrid");
var e=$("#tabSend .smsSearchForm").serialize();e+="&tabType=send";b.reloadJqgrid(e,"#sendSmsRecordGrid");var a=$("#tabSendFail .smsSearchForm").serialize();
b.reloadJqgrid(e,"#sendFailSmsRecordGrid");b.reloadJqgrid($("#tabReceive .smsSearchForm").serialize(),"#receiveSmsRecordGrid");},_hideNotGrantBtn:function(){if(!ResUtils.canShow("smsRecord.button.delete")){$(".smsRecordDelete").hide();
}if(!ResUtils.canShow("smsRecord.button.retry")){$(".smsRecordRetry").hide();}if(!ResUtils.canShow("smsConfirm.button.smsConfirm")){$(".smsConfirmTab").hide();
}else{$("a[href=#tabAll]").parent().removeClass("active");$("#tabAll").removeClass("active");$("a[href=#tabWaiting]").parent().addClass("active");$("#tabWaiting").addClass("active");
}},_retry:function(b){var a=this;FormUtils.loadData(SmsRecord._CONS_.RESEND_RECORD_URL+"?ids="+b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);
a._reloadAlljQgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(SmsRecord._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._reloadAlljQgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".smsRecordCount",function(){a._initStaticGrid();
});$("body").on("click","#tabAll .smsRecordSearch",function(){var b=$(this).closest("form").serialize();b+="&tabType=allSms";a.reloadJqgrid(b,"#allSmsRecordGrid");
});$("body").on("click","#tabStatic .smsRecordSearch",function(){var b=$(this).closest("form").serialize();b+="&tabType=static";a.reloadJqgrid(b,"#staticSmsRecordGrid");
});$("body").on("click","#tabSend .smsRecordSearch",function(){var b=$(this).closest("form").serialize();b+="&tabType=send";a.reloadJqgrid(b,"#sendSmsRecordGrid");
});$("body").on("click","#tabSendFail .smsRecordSearch",function(){var b=$(this).closest("form").serialize();b+="&tabType=sendFail";a.reloadJqgrid(b,"#sendFailSmsRecordGrid");
});$("body").on("click","#tabReceive .smsRecordSearch",function(){var b=$(this).closest("form").serialize();b+="&tabType=receive";a.reloadJqgrid(b,"#receiveSmsRecordGrid");
});$("body").on("click",".smsRecordRetry",function(){var b=$(this).attr("idVal");if(!b){b=$("#sendFailSmsRecordGrid").jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要重发的记录");return;}}a._retry(b);});$("body").on("click","#tabAll .smsRecordDelete,#tabReceive .smsRecordDelete,#tabSend .smsRecordDelete,#tabSendFail .smsRecordDelete",function(){var b=$(this).attr("idVal");
if(!b){var d=null;var e=$(this);var c=e.parents(".tab-pane").attr("id");if("tabAll"==c){d="#allSmsRecordGrid";}else{if("tabSend"==c){d="#sendSmsRecordGrid";
}else{if("tabSendFail"==c){d="#sendFailSmsRecordGrid";}else{if("tabReceive"==c){d="#receiveSmsRecordGrid";}}}}b=$(d).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".csTab",function(){var c=$(this).text();
var b=$(this).attr("value");if(c.length>5){c="*"+c.substring(c.length-4,c.length);}JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detail.htm?csId="+b,"客户["+c+"]");
});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(SmsRecord._CONS_.EDIT_FORM_ID,a);},_getManagerBtns:function(b){var a=[];
if(ResUtils.canShow("smsRecord.button.retry")){a.push({switchCol:{colName:"result",colVals:["ERROR-1","ERROR-2","ERROR-3","ERROR-4","ERROR-5","ERROR-6","ERROR-7","ERROR-SENDING"],colLables:[["重发"],["重发"],["重发"],["重发"],["重发"],["重发"],["重发"],["重发"],],btnClasses:[["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],["btn btn-primary smsRecordRetry"],]}});
}if(ResUtils.canShow("smsRecord.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger smsRecordDelete",iconClasses:"fa fa-remove"});
}return a;},reloadJqgrid:function(b,a){a=a?a:"allSmsRecordGrid";JTJqgridUtils.reloadJqgrid(a,b);},_initStaticGrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};
}b.Q__D__BW__create_time_=new Date().currentDate()+" 00:00:00";$("#staticSmsRecordGrid").JTJqgrid({url:SmsRecord._CONS_.LIST_STATIC_URL,pager:"#staticSmsRecordPager",postData:b,footerrow:true,multiselect:false,colNames:["部门","总计","已发送","发送成功","发送失败","已接收",],colModel:[{name:"groupName",index:"group_name_",width:100,sortable:false},{name:"count",index:"count",width:100,sortable:false},{name:"sendCount",index:"sendCount",width:100},{name:"sendSuccessCount",index:"sendSuccessCount",width:100,sortable:false},{name:"sendFailCount",index:"sendFailCount",width:100,sortable:false},{name:"receiveCount",index:"receiveCount",width:100,sortable:false},],beforeProcessing:function(d){if(d.rows&&d.rows.length){var c={groupName:"总计：",count:d.footData.count,sendCount:d.footData.sendCount,sendFailCount:d.footData.sendFailCount,sendSuccessCount:d.footData.sendSuccessCount,receiveCount:d.footData.receiveCount,};
a.footerData=c;}},gridComplete:function(){$("#staticSmsRecordGrid").closest(".ui-jqgrid").find(".jt-grid-resizing").trigger("click");if(a.footerData){var c=$("#staticSmsRecordGrid").jqGrid("getGridParam","records");
a.footerData.groupName="总计：<span style='color:red;'>"+c+"</span>个";$("#staticSmsRecordGrid").footerData("set",a.footerData);}},});},_initGrid:function(f,e,d){var c=this;
var a=SmsRecord._CONS_.LIST_DATA_URL;if(!(f==null||f==undefined)){a=a+"?"+f;}var b={Q__D__BW__create_time_:new Date().currentDate()+" 00:00:00"};$(e).JTJqgrid({url:a,pager:d,postData:b,width:this.width,rownumbers:true,colNames:["客户ID（隐藏）","客户编号","号码","归属工号","方向","平台","发送结果","平台状态","创建时间","到达时间","内容","操作"],colModel:[{name:"csId",index:"cs_id_",width:60,hidden:true},{name:"csCode",index:"cs_code_",width:60,sortable:false,formatter:function(g,h,i){if(ResUtils.canShow("sms.button.csInfo")){return"<a href='#' class='csTab' title='"+g+"' value='"+i.csId+"''>"+g+(g?(":"+i.csName):"")+"</a>";
}else{return g+(g?(":"+i.csName):"");}}},{name:"mobile",width:60,sortable:false},{name:"employeeAid",index:"employee_aid_",width:60},{name:"type",index:"type_",width:30,formatter:function(g){if("receive"==g){return"接收";
}else{return"发送";}}},{name:"platform",index:"platform_",hidden:"y"==isMultiPlatForm?false:true,width:50,formatter:function(h){var g="短信猫";if(h){if(h.startsWith("gst")){g="高斯通";
}else{if(h.startsWith("lsm")){g="螺丝帽";}else{if(h.startsWith("ali")){g="阿里";}else{if(h.startsWith("qyxs")){g="企业信使";}else{if(h.startsWith("hxkj")){g="华信科技";
}}}}}}return g;}},{name:"result",index:"result_",width:40,formatter:function(g){if(g=="SUCCESS"){return"<span class='text-success'>成功</span>";}else{if(g=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";
}else{if(g=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";}else{if(g.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>";
}else{if(g.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>";}}}}}}},{name:"platformStatus",index:"platform_status_",width:40,formatter:function(g){if(g=="SUCCESS"){return"<span class='text-success'>成功</span>";
}else{if(g=="ERROR"){return"<span class='text-danger'>失败</span>";}else{return"<span>--</span>";}}}},{name:"createTime",index:"create_time_",width:70,formatter:function(g){return DateUtils.miniTime(g);
}},{name:"successTime",index:"success_time_",width:70,hidden:true,formatter:function(i,g,h){if(i){return i;}else{return h.createTime;}}},{name:"content",index:"content_",width:400,formatter:function(i,g,h){var j=new StringBuffer();
j.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");j.append(i);j.append("</div>");return j.toString();}},{name:"__manage",width:80,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns(e)}]});
},};