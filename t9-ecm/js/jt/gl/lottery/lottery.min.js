$(function(){var a=new Lottery();a.init();});function Lottery(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.lotteryResult=new LotteryResult();
var j;var g=0;var e;var c=300;var b;var k=0;var f=0;var d=0;var i=false;var a=0;var h;}Lottery._CONS_={EDIT_URL:ctx+"/gl/lottery/lottery/edit.htm",DETAIL_URL:ctx+"/gl/lottery/lottery/detail.htm",DELETE_URL:ctx+"/gl/lottery/lottery/delete.htm",SAVE_ADD_URL:ctx+"/gl/lottery/lottery/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/lottery/lottery/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/lottery/lottery/listData.htm",UPDATE_STATUS:ctx+"/gl/lottery/lottery/updateStatus.htm",EDIT_FORM_ID:"lotteryForm",GRID:"#lotteryGrid",PAGER:"#lotteryPager"};
Lottery.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this.lotteryResult._initJqgrid();}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("lottery.button.detail")){$(".lotteryDetail").hide();}if(!ResUtils.canShow("lottery.button.add")){$(".lotteryAdd").hide();
}if(!ResUtils.canShow("lottery.button.edit")){$(".lotteryEdit").hide();}if(!ResUtils.canShow("lottery.button.delete")){$(".lotteryDel").hide();}},clear:function(c){var a=this;
function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveDraft .savePublish").show();FormUtils.clear(Lottery._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(Lottery._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();$(".lottery_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".lottery_wrapper").hide();$(".form_wrapper").show();},_add:function(){$(".lotteryTbody").empty();this.lotteryPlus();this._showFormWrapper();$(".lotteryAverage").show();
},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a,false);$(".lotteryAverage").show();},_detail:function(a){this._showFormWrapper();
this._loadData(a,true);$(".lotteryAverage").hide();$(".form_wrapper .saveDraft .savePublish").hide();FormUtils.disableForm(Lottery._CONS_.EDIT_FORM_ID);
},_loadData:function(c,b){var a=this;FormUtils.loadData(Lottery._CONS_.EDIT_URL+"?id="+c,function(d){$("input[name=id]").val(d.id);$("input[name=name]").val(d.name);
$("select[name=type]").val(d.type);$("input[name=circle]").val(d.circle);$("input[name=status]").val(d.status);$("input[name=createTime]").val(d.createTime);
$("input[name=updateTime]").val(d.updateTime);a._initLotteryItem(d.lotteryItemPos,b);});},_initLotteryItem:function(c,b){var a=this;var e=new StringBuffer();
for(var d=0;d<c.length;d++){e.append("<tr>");e.append("<td>");e.append("<input type='text' value='"+c[d].name+"' style='width:60%;' name='name' ");if(b){e.append("disabled='disabled' ");
}e.append("class='form-control'>");e.append("</td>");e.append("<td>");e.append("<input type='number'  value='"+c[d].rate+"' name='rate' style='width:60%;' ");
if(b){e.append("disabled='disabled' ");}e.append("class='form-control'>");e.append("</td>");e.append("<td>");if(!b){e.append("<button type='button' class='btn btn-sm btn-danger lotterySubtract'>减</button>");
}e.append("</td>");e.append("</tr>");}$(".lotteryTbody").empty().append(e.toString());if(!b){a.lotteryPlus(false);}},_save:function(b){var d=this;var h=$("#id").val();
var a=null;if(h!=null&&h!=""){a=Lottery._CONS_.SAVE_EDIT_URL;}else{a=Lottery._CONS_.SAVE_ADD_URL+"?status="+b;}if($("input[name=type]").val()=="disk"){if($(".lotteryTbody").find(".tr").length>16){DialogUtils.error(msgCode.INFO,"轮盘最多只能添加16个奖项");
return;}}else{if($("input[name=type]").val()=="lamp"){if($(".lotteryTbody").find(".tr").length>100000){DialogUtils.error(msgCode.INFO,"跑马灯最多只能添加10000个奖项");
return;}}}var e=$(".lotteryTbody").find("input[name=rate]");var g=0;for(var f=0;f<e.length;f++){g+=parseInt($(e[f]).val());}if(g!=100){DialogUtils.error(msgCode.INFO,"总几率不等于100");
return;}if($("#lotteryForm").valid()){var c=$("#"+Lottery._CONS_.EDIT_FORM_ID).serialize()+"&lotteryItemJSON="+d.getLotteryItems();ButtonUtils.disableBtn("saveDraft");
ButtonUtils.disableBtn("savePublish");FormUtils.submit(a,c,function(i){ButtonUtils.enableBtn("saveDraft");ButtonUtils.enableBtn("savePublish");if(i.success){if(i.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(i.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}d.isEdit=false;d.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);
}},function(){ButtonUtils.enableBtn("saveDraft");ButtonUtils.enableBtn("savePublish");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(Lottery._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveDraft",function(){a._save("draft");});$(document).on("click",".savePublish",function(){a._save("publish");});$("#"+Lottery._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+Lottery._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+Lottery._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".lotterySearch").on("click",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$("#lotterySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".lotterySearch").trigger("click");
}});$("body").on("click",".lotteryAdd",function(){a._add();});$("body").on("click",".lotteryEdit",function(){a.isEdit=true;var c=$(this).attr("idVal");
if(!c){c=$(Lottery._CONS_.GRID).jqGrid("getGridParam","selarrrow");var d=$(Lottery._CONS_.GRID).jqGrid("getRowData",c);var b=d["status"];if(b=="publish"){DialogUtils.error(msgCode.error,"发布状态的抽奖项目不能修改");
return;}if(c==null||c.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}a._edit(c);});$("body").on("click",".lotteryDel",function(){var b=$(this).attr("idVal");if(!b){b=$(Lottery._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".lotteryDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(Lottery._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$("body").on("click",".lotteryPublish",function(){var b=$(this).attr("idVal");
a._updateStatus(b,"publish");});$("body").on("click",".lotteryInvalid",function(){var b=$(this).attr("idVal");a._updateStatus(b,"invalid");});$("body").on("click",".toLottery",function(){var b=$(this).attr("idVal");
$("input[name=lotteryId]").val(b);$(".list_wrapper").hide();$(".form_wrapper").hide();$(".lottery_wrapper").show();FormUtils.loadData(Lottery._CONS_.EDIT_URL+"?id="+b,function(e){a.cycle=e.circle;
a.buildMarqueeTable(e.lotteryItemPos);window.localStorage.setItem("lotteryItems",e.lotteryItemPos);});a.lotteryResult.reloadJqgrid("Q__S__LK__lottery_id_="+b);
$(".isTryDiv").empty().append("<input name='isTry' value='n' type='checkbox' class='js-switch' />");var c=document.querySelector(".js-switch");var d=new Switchery(c,{className:"switchery switchery-small"});
});$("body").on("click",".lottery",function(){if($(".input[name='isTry']").val()=="n"){if(!$("input[name=person]").val()){DialogUtils.error(msgCode.error,"请填写抽奖人");
return;}}a.startLottery(window.localStorage.getItem("lotteryItems"));a.lotteryResult.reloadJqgrid("Q__S__LK__lottery_id_="+$("input[name=lotteryId]").val());
});$("body").on("change","input[name='isTry']",function(){if($(this).val()=="y"){$(this).val("n");}else{$(this).val("y");}});$("body").on("click",".lotterySubtract",function(){$(this).parents("tr").remove();
});$("body").on("click",".lotteryPlus",function(){a.lotteryPlus(true);});$("body").on("click",".lotteryAverage",function(){var b=$(".lotteryTbody").find("input[name=rate]");
if(b.length<=0){return;}var d=parseInt(10000/b.length);for(var c=0;c<b.length;c++){$(b[c]).val(d/100);}});},lotteryPlus:function(a){var b=new StringBuffer();
b.append("<tr>");b.append("<td>");b.append("<input type='text' style='width:60%;' name='name' class='form-control'>");b.append("</td>");b.append("<td>");
b.append("<input type='number' name='rate' style='width:60%;' class='form-control'>");b.append("</td>");b.append("<td>");b.append("<button type='button' class='btn btn-sm btn-primary lotteryPlus'>加</button> ");
if(a){b.append("<button type='button' class='btn btn-sm btn-danger lotterySubtract'>减</button>");}b.append("</td>");b.append("</tr>");$(".lotteryTbody").append(b.toString());
},_updateStatus:function(c,a){var b=this;FormUtils.submit(Lottery._CONS_.UPDATE_STATUS,{id:c,status:a},function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
b.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},getLotteryItems:function(){var a=[];$(".lotteryTbody").find("tr").each(function(){var b=$("#id").val();
var c=$(this).find("input[name=name]").eq(0).val();var d=$(this).find("input[name=rate]").eq(0).val();var e={lotteryId:b,name:c,rate:d};a.push(e);});return JSON.stringify(a);
},_bindFormValidation:function(){var a={rules:{name:{required:true},type:{required:true},circle:{required:true}},messages:{}};FormUtils.bindFormValidation(Lottery._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(Lottery._CONS_.GRID,a);},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(Lottery._CONS_.GRID).JTJqgrid({url:Lottery._CONS_.LIST_DATA_URL,pager:Lottery._CONS_.PAGER,postData:a,colNames:["名称","抽奖形式","跑圈数","状态(隐藏)","状态","创建时间","操作"],colModel:[{name:"name",index:"name_",width:120},{name:"type",index:"type_",width:120,formatter:function(b){switch(b){case"disk":return"轮盘";
break;case"lamp":return"跑马灯";break;}}},{name:"circle",index:"circle_",width:120},{name:"status",hidedlg:true,hidden:true},{name:"statusShow",index:"status_",width:120,formatter:function(b,c,d){switch(d.status){case"draft":return"草稿";
break;case"publish":return"发布";break;case"invalid":return"失效";break;}}},{name:"createTime",index:"create_time_",width:120},{name:"id",index:"id_",width:120,formatter:function(b,c,d){if("draft"==d.status){return"<button class='btn btn-sm btn-primary lotteryPublish' idVal='"+d.id+"'>发布</button>";
}else{if("publish"==d.status){return"<button class='btn btn-sm btn-primary toLottery' idVal='"+d.id+"'>抽奖</button>"+" <button class='btn btn-sm btn-primary lotteryInvalid' idVal='"+d.id+"'>失效</button>";
}else{return"";}}}}]});},buildMarqueeTable:function(a){var c=new StringBuffer();c.append("<tbody tbody style='text-align:center;'>");for(var b=0;b<a.length;
b++){if(b%6==0){c.append("<tr>");}c.append("<td style='background-color:#273a4a;height:40px;border-right:1px solid white;'>"+a[b].name+"</td>");if(b%6==5){c.append("</tr>");
}}c.append("</tbody>");$("#lotteryResultTable").empty().append(c.toString());},startLottery:function(b){var a=this;a.index=0;a.speed=500;a.speedUp=0;a.runArr=a.getSide($("#lotteryResultTable").find("tr").length,$("#lotteryResultTable").find("tr").eq(0).find("td").length);
$(".lottery").attr("disabled",true);a.stopNum=Math.floor(Math.random()*10000);a.downIndex=Math.floor(Math.random()*10000);var d=0;for(var c=0;c<b.length;
c++){if(d<a.stopNum<d+b[c].rate){a.stopNum=b[c];a.downIndex=b[c];}d+=b[c].rate;}a.endCycle=1;clearInterval(a.timer);a.cycle=0;a.flag=false;a.timer=setInterval(function(){a.run(a);
},a.speed);},run:function(a){$("#lotteryResultTable").find("tr").eq(a.runArr[a.index][0]).find("td").eq(a.runArr[a.index][1]).attr("class","playcurr col-sm-2");
if(a.index>0){a.prevIndex=a.index-1;}else{a.prevIndex=a.runArr.length-1;}$("#lotteryResultTable").find("tr").eq(a.runArr[a.prevIndex][0]).find("td").eq(a.runArr[a.prevIndex][1]).attr("class","playnormal col-sm-2");
a.index++;a.speedUp++;if(a.flag==false){if(a.speedUp==5){clearInterval(a.timer);a.speed=100;a.timer=setInterval(function(){a.run(a);},a.speed);}}if(a.cycle==a.endCycle+1&&a.index==a.downIndex){clearInterval(a.timer);
a.speed=300;a.flag=true;a.timer=setInterval(function(){a.run(a);},a.speed);}if(a.index>=a.runArr.length){a.index=0;a.cycle++;}if(a.flag==true&&a.index==a.stopNum){a.speedUp=0;
clearInterval(a.timer);$(".lottery").attr("disabled",false);DialogUtils.success(msgCode.INFO,$("#lotteryResultTable").find("td").eq(a.stopNum-1).html());
}},getSide:function(a,e){var c=[];for(var d=0;d<a;d++){for(var b=0;b<e;b++){c.push([d,b]);}}return c;},};