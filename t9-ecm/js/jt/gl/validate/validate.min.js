$(function(){var a=new Validate();a.init();});function Validate(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.isCreateBaseGrid=true;
this.validateRel=new ValidateRel();}Validate._CONS_={GRID:"#validateGrid",PAGER:"#validatePager",LIST_DATA_URL:ctx+"/gl/validate/validate/listData.htm",EDIT_URL:ctx+"/gl/validate/validate/edit.htm",DETAIL_URL:ctx+"/gl/validate/validate/detail.htm",SAVE_ADD_URL:ctx+"/gl/validate/validate/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/validate/validate/saveEdit.htm",DELETE_URL:ctx+"/gl/validate/validate/delete.htm",BASE_GRID:"#baseValidateGrid",};
Validate.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._hideNotGrantBtn();a._bindEventHander();a._bindFormValidation();a._initJqgrid(b);
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("validate.button.detail")){$(".validateDetail").hide();}if(!ResUtils.canShow("validate.button.add")){$(".validateAdd").hide();
}if(!ResUtils.canShow("validate.button.edit")){$(".validateEdit").hide();}if(!ResUtils.canShow("validate.button.delete")){$(".validateDel").hide();}},_bindFormValidation:function(){FormUtils.bindFormValidation("validateForm");
},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a._clear(false);});$(document).on("click",".saveBtn",function(){var b=$("input[name='id']").val()?Validate._CONS_.SAVE_EDIT_URL:Validate._CONS_.SAVE_ADD_URL;
if(!a.validateRel.validateRelGridData2Json()){return false;}if($("#validateForm").valid()){ButtonUtils.disableBtn("saveBtn");var c=$("#validateForm").serialize();
FormUtils.submit(b,c,function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){DialogUtils.success("提示",d.msg);a.isFormDataChange=false;a.isEdit=false;
a._clear(true);}else{DialogUtils.error("失败",d.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error("错误","后台异常，请稍后重试");});}return false;
});$("body").on("click",".validateAdd",function(){a.isEdit=true;a._add();});$("body").on("click",".validateEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(Validate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要更新的记录");return;}if(b.length>1){DialogUtils.error("错误","不能同时编辑多条记录");
return;}}a._edit(b);});$("body").on("click",".validateDel",function(){var b=$(this).attr("idVal");if(!b){b=$(Validate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要删除的记录");return;}}var e=new StringBuffer();for(var c=0;c<b.length;){var d=$(Validate._CONS_.GRID).jqGrid("getRowData",b[c]);
e.append(d["name"]);if(++c<b.length){e.append(",");}}a._del(b,""+e);});$("body").on("click",".validateDetail",function(){a.isEdit=false;var b=$(this).attr("idVal");
if(!b){b=$(Validate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要查看明细的记录");return;}if(b.length>1){DialogUtils.error("错误","不能同时查看多条记录");
return;}}a._detail(b);});$(".list_wrapper").on("click",".validateSearch",function(){var b=$(this).closest("form").serialize();a._reloadJqgrid(b);});$("#validateSearchForm").on("keypress",function(b){if(b.which==13){$(".validateSearch").trigger("click");
}});$(".form_wrapper").on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".form_wrapper").on("change",".form_wrapper select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".form_wrapper").on("change",".form_wrapper textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".form_wrapper").on("click",".privateValidateEdit",function(){$(".list_wrapper").hide();
$(".form_wrapper").hide();$("input[name=private_vid]").val($("#id").val());$(".privateValidateEdit_wrapper").show();$(".baseValidateList_wrapper").hide();
});$(".form_wrapper").on("click",".baseValidate",function(){$(".list_wrapper").hide();$(".form_wrapper").hide();$(".privateValidateEdit_wrapper").hide();
$(".baseValidateList_wrapper").show();if(a.isCreateBaseGrid){a._initBaseGrid();a.isCreateBaseGrid=false;}});$(".form_wrapper").on("change",".showAndHideGrid",function(){var b=document.getElementById("type").options;
for(var c=0;c<b.length;c++){if(b[c].selected==true){if(b[c].value=="mix"){document.getElementById("relButton").style.display="block";document.getElementById("relGrid").style.display="block";
}else{document.getElementById("relButton").style.display="none";document.getElementById("relGrid").style.display="none";}}}});$(".privateValidateEdit_wrapper").on("click",".addPrivateValidToForm",function(){if(!a.validateRel.checkRelKey($("input[name=private_key]").val())){return false;
}var b={type:$("input[name=private_type]").val(),key:$("input[name=private_key]").val(),configType:$("#private_configType").val(),config:$("input[name=private_config]").val(),serverMethod:$("input[name=private_serverMethod]").val(),msg:$("input[name=private_msg]").val(),sort:$("input[name=private_sort]").val(),vid:$("input[name=private_vid]").val()};
a.validateRel.addValidateRelRow(b);a._backToForm();});$(".privateValidateEdit_wrapper").on("click",".backToForm",function(){a._backToForm(true);});$(".baseValidateList_wrapper").on("click",".backToForm",function(){a._backToForm(false);
});},_initJqgrid:function(b){var a=this;$(Validate._CONS_.GRID).JTJqgrid({url:Validate._CONS_.LIST_DATA_URL,pager:Validate._CONS_.PAGER,colNames:["规则类型","规则业务键","配置内容类型","配置内容","服务器端验证方法","定制提示信息","排序号","创建时间","更新时间","操作"],colModel:[{name:"type",index:"type_",sortable:false,width:120,editoptions:{value:"base:基础验证规则;mix:复合验证规则,private:私有验证规则"},formatter:function(c,d,e){if(e.type=="base"){return"基础验证规则";
}else{if(e.type=="mix"){return"复合验证规则";}else{if(e.type=="private"){return"私有验证规则";}else{if(e.type==undefined){return"";}}}}return e.type;}},{name:"key",width:120,index:"key_"},{name:"configType",sortable:false,index:"config_type_",width:120,editoptions:{value:"base:基本;regex:正则,js:JS方法"},formatter:function(c,d,e){if(e.configType=="base"){return"基本";
}else{if(e.configType=="regex"){return"正则";}else{if(e.configType=="js"){return"JS方法";}else{if(e.configType==undefined){return"";}}}}return e.configType;
}},{name:"config",index:"config_",width:120},{name:"serverMethod",index:"server_method_",width:120},{name:"msg",width:120,index:"msg_",sortable:false},{name:"sort",width:120,index:"sort_"},{name:"createTime",width:180,index:"create_time_"},{name:"updateTime",width:120,index:"update_time_",hidden:true},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",title:"操作",formatoptions:a._getManagerBtns()}]});
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("validate.button.delete")){a.push({lable:"删除",btnClasses:"btn btn-primary validateDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("validate.button.edit")){a.push({lable:"编辑",btnClasses:"btn btn-primary validateEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("validate.button.detail")){a.push({lable:"明细",btnClasses:"btn btn-primary validateDetail",iconClasses:"fa fa-detail"});
}return a;},_add:function(){$(".list_wrapper").hide();$(".form_wrapper").show();$(".privateValidateEdit_wrapper").hide();$(".baseValidateList_wrapper").hide();
this.validateRel.initJqgrid(null);document.getElementById("relButton").style.display="none";document.getElementById("relGrid").style.display="none";},_edit:function(a){$(".list_wrapper").hide();
$(".form_wrapper").show();$(".privateValidateEdit_wrapper").hide();$(".baseValidateList_wrapper").hide();this._loadData(a);},_loadData:function(b){var a=this;
FormUtils.loadData(Validate._CONS_.EDIT_URL+"?id="+b,function(e){$("input[name=id]").val(e.id);var f=document.getElementById("type").options;for(var d=0;
d<f.length;d++){if(f[d].value==e.type){f[d].selected=true;break;}}$("input[name=key]").val(e.key);var c=document.getElementById("configType").options;for(var d=0;
d<c.length;d++){if(c[d].value==e.configType){c[d].selected=true;break;}}$("input[name=config]").val(e.config);$("input[name=serverMethod]").val(e.serverMethod);
$("input[name=msg]").val(e.msg);$("input[name=sort]").val(e.sort);$("input[name=createTime]").val(e.createTime);$("input[name=updateTime]").val(e.updateTime);
a.validateRel.initJqgrid(e.validateRelPos);if(e.type=="mix"){document.getElementById("relButton").style.display="block";document.getElementById("relGrid").style.display="block";
}else{document.getElementById("relButton").style.display="none";document.getElementById("relGrid").style.display="none";}});},_del:function(a){DialogUtils.confirm(function(){DialogUtils.deleteByIds(Validate._CONS_.DELETE_URL,a,function(b){$(Validate._CONS_.GRID).jqGrid("setGridParam",{postData:{}}).trigger("reloadGrid");
DialogUtils.success("提示",b.msg);});});},_reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(Validate._CONS_.GRID,a);},_clear:function(c){var a=this;function b(){$("#validateForm").validate().resetForm();
$(".list_wrapper").show();$(".form_wrapper").hide();FormUtils.clear("validateForm");$("#resTip").text("").hide();a.isFormDataChange=false;if(c){a._reloadJqgrid();
}}if(a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_initBaseGrid:function(){var a=this;$.jgrid.defaults.styleUI="Bootstrap";$(Validate._CONS_.BASE_GRID).jqGrid({datatype:"json",url:ctx+"/gl/validate/validate/listData.htm?Q__S__EQ__type_=base",height:350,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",viewrecords:true,multiselect:false,scroll:true,caption:"基础验证规则列表(双击选择)",rowList:[10,20,30],colNames:["规则类型","规则业务键","配置内容类型","配置内容","服务器端验证方法","定制提示信息","排序号","创建时间","更新时间"],colModel:[{name:"type",width:120,editoptions:{value:"base:基础验证规则;mix:复合验证规则,private:私有验证规则"},formatter:function(b,c,d){if(d.type=="base"){return"基础验证规则";
}else{if(d.type=="mix"){return"复合验证规则";}else{if(d.type=="private"){return"私有验证规则";}else{if(d.type==undefined){return"";}}}}return d.type;}},{name:"key",width:120},{name:"configType",width:120,editoptions:{value:"base:基本;regex:正则,js:JS方法"},formatter:function(b,c,d){if(d.configType=="base"){return"基本";
}else{if(d.configType=="regex"){return"正则";}else{if(d.configType=="js"){return"JS方法";}else{if(d.configType==undefined){return"";}}}}return d.configType;
}},{name:"config",width:120},{name:"serverMethod",width:120},{name:"msg",width:120},{name:"sort",width:120},{name:"createTime",width:120},{name:"updateTime",width:120}],hidegrid:false,ondblClickRow:function(d,h,b,g){var f=$(Validate._CONS_.BASE_GRID).jqGrid("getRowData",d);
var c=a.validateRel.checkRelRidAndRetId(d);if(c==null){return false;}a._addBaseValidToForm(d,f,c);}});$(window).bind("resize",function(){var b=$(".list_wrapper").width();
$(Validate._CONS_.BASE_GRID).setGridWidth(b);});},_backToForm:function(a){$(".list_wrapper").hide();$(".form_wrapper").show();$(".privateValidateEdit_wrapper").hide();
$(".baseValidateList_wrapper").hide();if(a){this._clearPrivateEditDiv();}},_clearPrivateEditDiv:function(){$(".privateEditDiv input").val("");var a=document.getElementById("private_configType").options;
for(var b=0;b<a.length;b++){a[b].selected=false;}a[0].selected=true;},_addBaseValidToForm:function(d,c,a){var b={type:c["type"],key:c["key"],configType:c["configType"],config:c["config"],serverMethod:c["serverMethod"],msg:c["msg"],sort:a,vid:$("#id").val(),rid:d};
this.validateRel.addValidateRelRow(b);this._backToForm();}};function ValidateRel(){this.hadInit=false;this.isEdit=false;this.validateRelRowid=0;}ValidateRel._CONS_={GRID:"#validateRelGrid",GRID_ID:"validateRelGrid",GRID_DIV:"validateRelDiv",PAGER_ID:"validateRelPager",PAGER:"#validateRelPager",JSON_ID:"validateRelJSON"};
ValidateRel.prototype={initJqgrid:function(d){var b=this;var a=JSON.stringify(d);var c='<table id="'+ValidateRel._CONS_.GRID_ID+'"  ></table><div id="'+ValidateRel._CONS_.PAGER_ID+'"></div><input type="hidden"  id="'+ValidateRel._CONS_.JSON_ID+'" name="'+ValidateRel._CONS_.JSON_ID+'">';
$("#"+ValidateRel._CONS_.GRID_DIV).empty().html($(c));$.jgrid.defaults.styleUI="Bootstrap";$(ValidateRel._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:a,height:350,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",multiselect:true,sortable:false,caption:"验证规则关联列表",rowList:[10,20,30],colNames:["当前规则 ID","关联规则 ID","创建时间","更新时间","规则类型","规则业务键","配置内容类型","配置内容","服务器端验证方法","定制提示信息","排序号","操作"],colModel:[{name:"vid",editable:false,hidedlg:true,hidden:true,width:120},{name:"rid",editable:false,width:160,sortable:false},{name:"createTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"type",width:160,sortable:false,editoptions:{value:"base:基础验证规则;mix:复合验证规则,private:私有验证规则"},formatter:function(e,f,g){if(g.type=="base"){return"基础验证规则";
}else{if(g.type=="mix"){return"复合验证规则";}else{if(g.type=="private"){return"私有验证规则";}else{if(g.type==undefined){return"";}}}}return g.type;}},{name:"key",width:160,sortable:false},{name:"configType",width:160,sortable:false,editoptions:{value:"base:基本;regex:正则,js:JS方法"},formatter:function(e,f,g){if(g.configType=="base"){return"基本";
}else{if(g.configType=="regex"){return"正则";}else{if(g.configType=="js"){return"JS方法";}else{if(g.configType==undefined){return"";}}}}return g.configType;
}},{name:"config",width:200,sortable:false},{name:"serverMethod",width:200,sortable:false},{name:"msg",width:200,sortable:false},{name:"sort",editable:true,width:100},{name:"button",width:200}],pager:ValidateRel._CONS_.PAGER,hidegrid:false,gridComplete:function(){JTSubGridUtils.addRowButtons(ValidateRel._CONS_.GRID_ID,true,b._addSelectButton);
}});$(ValidateRel._CONS_.GRID).jqGrid("navGrid",ValidateRel._CONS_.PAGER,{add:false,del:true,deltitle:"删除",delfunc:b._delValidateRel,refresh:false,search:false,edit:false});
},checkRelKey:function(b){var c=$(ValidateRel._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<c.length;a++){if(b==$(ValidateRel._CONS_.GRID).jqGrid("getRowData",c[a])["key"]){alert("已关联该业务键的规则，请修改业务键进行关联");
return false;}}return true;},checkRelRidAndRetId:function(e){var c=0;var d=$(ValidateRel._CONS_.GRID).jqGrid("getDataIDs");for(var b=0;b<d.length;b++){var f=$(ValidateRel._CONS_.GRID).jqGrid("getRowData",d[b]);
if(e==f["rid"]){alert("已关联该规则，请选择其他规则进行关联");return null;}var a=Number(f["sort"]);c=a>=c?(a+1):c;}return c;},_addSelectButton:function(f,d,b,a){var c="<input  type='button'  value='确认修改' class='"+b+"_rowcom_"+a+' btn btn-primary\'   onclick=\'JTSubGridUtils.gridRowEvent("save","'+b+'","'+a+"\");' style='margin: 0px 3px 0px 0px;display:none;'   >";
var e="<input  type='button'  value='取消修改' class='"+b+"_rowcanl_"+a+' btn btn-primary\'   onclick=\'JTSubGridUtils.gridRowEvent("cancel","'+b+'","'+a+"\");' style='margin: 0px 3px 0px 0px;display:none;' >";
var g=new StringBuffer();g.append('<input  onClick=\'JTSubGridUtils.gridRowEvent("edit","').append(b).append('","').append(a).append("\")'  style='margin: 0px 3px 0px 0px;'  class=' btn btn-primary ").append(b).append("_rowedit_").append(a).append("' type='button'  value='修改序号'>").append(f).append(c).append(e);
return""+g;},_selectValidate:function(a){var b=$("#id").val();},_delValidateRel:function(a){DialogUtils.confirm(function(){JTSubGridUtils.delRows(validateRelGridId,a);
});},validateRelGridData2Json:function(){var d=$(ValidateRel._CONS_.GRID);var a=new StringBuffer();a.append("[");var e=d.jqGrid("getDataIDs");for(var b=0;
b<e.length;b++){var f=d.jqGrid("getRowData",e[b]);if(f["isGridRowEdit"]=="Y"){alert("有参数尚未保存，请选择保存或者取消变更!");getElementById(e[b]).focus();return false;}var c="base";
if(f["type"]=="私有验证规则"){c="private";}var h="base";if(f["configType"]=="基本"){h="base";}else{if(f["configType"]=="正则"){h="regex";}else{if(f["configType"]=="JS方法"){h="js";
}}}a.append("{");a.append("'vid':'").append(f["vid"]).append("',");a.append("'rid':'").append(f["rid"]).append("',");a.append("'sort':'").append(f["sort"]).append("',");
a.append("'createTime':'").append(f["createTime"]).append("',");a.append("'updateTime':'").append(f["updateTime"]).append("',");a.append("'type':'").append(c).append("',");
a.append("'key':'").append(f["key"]).append("',");a.append("'configType':'").append(h).append("',");a.append("'config':'").append(f["config"]).append("',");
a.append("'serverMethod':'").append(f["serverMethod"]).append("',");a.append("'msg':'").append(f["msg"]).append("'");if(!e[b].startsWith("tmp@")){a.append(",'id':'").append(e[b]).append("'");
}a.append("},");}var g=""+a;if(e.length>0){g=g.substring(0,g.length-1);}g=g+"]";$("#"+ValidateRel._CONS_.JSON_ID).val(g);return true;},addValidateRelRow:function(a){$(ValidateRel._CONS_.GRID).jqGrid("addRowData","tmp@"+this.validateRelRowid,a,"last");
this.validateRelRowid++;},};