$(function(){var a=new ValidateTbl();a.init();});function ValidateTbl(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.changGridFlag=false;
this.changUnGridFlag=false;this.hadCHangeCol=false;}ValidateTbl._CONS_={GRID:"#validateTblGrid",PAGER:"#validateTblPager",LIST_DATA_URL:ctx+"/gl/validate/validateTbl/listData.htm",EDIT_URL:ctx+"/gl/validate/validateTbl/edit.htm",DETAIL_URL:ctx+"/gl/validate/validateTbl/detail.htm",SAVE_ADD_URL:ctx+"/gl/validate/validateTbl/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/validate/validateTbl/saveEdit.htm",DELETE_URL:ctx+"/gl/validate/validateTbl/delete.htm",GET_COL_URL:ctx+"/gl/validate/validateTbl/getColByTbl.htm",UN_REL_GRID_ID:"unRelValidateGrid",UN_REL_GRID:"#unRelValidateGrid",LIST_USE_URL:ctx+"/gl/validate/validate/listUseData.htm",REL_GRID_ID:"relValidateGrid",REL_GRID:"#relValidateGrid",VALIDATES_COL__URL:ctx+"/gl/validate/validateTbl/getValidatesByTblAndCol.htm",};
ValidateTbl.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._hideNotGrantBtn();a._bindEventHander();a._bindFormValidation();a._initJqgrid(b);
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("validateTbl.button.detail")){$(".validateTblDetail").hide();}if(!ResUtils.canShow("validateTbl.button.add")){$(".validateTblAdd").hide();
}if(!ResUtils.canShow("validateTbl.button.edit")){$(".validateTblEdit").hide();}if(!ResUtils.canShow("validateTbl.button.delete")){$(".validateTblDel").hide();
}},_bindFormValidation:function(){FormUtils.bindFormValidation("validateTblForm");},_clear:function(c){var a=this;function b(){$("#validateTblForm").validate().resetForm();
$(".list_wrapper").show();$(".form_wrapper").hide();FormUtils.clear("validateTblForm");$("#resTip").text("").hide();a.isFormDataChange=false;if(c){a._reloadJqgrid();
}}if(a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_bindEventHander:function(){var self=this;$(document).on("click",".prevBtn",function(){self.hadCHangeCol=false;
self._clear(false);});$(document).on("click",".saveBtn",function(){var reqUrl=$("input[name='id']").val()?ValidateTbl._CONS_.SAVE_EDIT_URL:ValidateTbl._CONS_.SAVE_ADD_URL;
if($("#validateTblForm").valid()){self._getKeysByGrid(ValidateTbl._CONS_.REL_GRID_ID);ButtonUtils.disableBtn("saveBtn");var params=$("#validateTblForm").serialize();
FormUtils.submit(reqUrl,params,function(msg){ButtonUtils.enableBtn("saveBtn");if(msg.success){DialogUtils.success("提示",msg.msg);self.isFormDataChange=false;
self.hadCHangeCol=false;self.isEdit=false;self._clear(true);}else{DialogUtils.error("失败",msg.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error("错误","后台异常，请稍后重试");
});}return false;});$(document).on("click",".saveOne",function(){var reqUrl=$("input[name='id']").val()?ValidateTbl._CONS_.SAVE_EDIT_URL:ValidateTbl._CONS_.SAVE_ADD_URL;
if($("#validateTblForm").valid()){self._getKeysByGrid(ValidateTbl._CONS_.REL_GRID_ID);ButtonUtils.disableBtn("saveOne");ButtonUtils.disableBtn("saveBtn");
$.ajax({type:"POST",url:reqUrl,data:$("#validateTblForm").serialize(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(msg){ButtonUtils.enableBtn("saveBtn");
ButtonUtils.enableBtn("saveOne");if(msg.success){DialogUtils.success("提示",msg.msg);self.isFormDataChange=false;self.hadCHangeCol=false;self.isEdit=false;
}else{DialogUtils.erro(msg.msg);}},error:function(msg){alert(msg);}});}return false;});$("body").on("click",".validateTblAdd",function(){self.isEdit=true;
self._add();});$("body").on("click",".validateTblEdit",function(){self.isEdit=true;var selectedId=$(this).attr("idVal");if(!selectedId){selectedId=$(ValidateTbl._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId==null||selectedId.length==0){DialogUtils.error("错误","请选择要更新的记录");return;}if(selectedId.length>1){DialogUtils.error("错误","不能同时编辑多条记录");return;
}}self._edit(selectedId);});$("body").on("click",".validateTblDel",function(){var selectedId=$(this).attr("idVal");if(!selectedId){selectedId=$(ValidateTbl._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId==null||selectedId.length==0){DialogUtils.error("错误","请选择要删除的记录");return;}}var names=new StringBuffer();for(var i=0;i<selectedId.length;){var rowData=$(ValidateTbl._CONS_.GRID).jqGrid("getRowData",selectedId[i]);
names.append(rowData["name"]);if(++i<selectedId.length){names.append(",");}}self._del(selectedId,""+names);});$("body").on("click",".validateTblDetail",function(){self.isEdit=false;
var selectedId=$(this).attr("idVal");if(!selectedId){selectedId=$(ValidateTbl._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(selectedId==null||selectedId.length==0){DialogUtils.error("错误","请选择要查看明细的记录");
return;}if(selectedId.length>1){DialogUtils.error("错误","不能同时查看多条记录");return;}}self._detail(selectedId);});$(".list_wrapper").on("click",".validateTblSearch",function(){var params=$(this).closest("form").serialize();
self._reloadJqgrid(params);});$("#validateTblSearchForm").on("keypress",function(e){if(e.which==13){$(".validateTblSearch").trigger("click");}});$(".form_wrapper").on("change","input",function(){if(self.isEdit){self.isFormDataChange=true;
}});$(".form_wrapper").on("change",".form_wrapper select",function(){if(self.isEdit){self.isFormDataChange=true;}});$(".form_wrapper").on("change",".form_wrapper textarea",function(){if(self.isEdit){self.isFormDataChange=true;
}});$(".form_wrapper").on("click",".gridSort",function(){$(ValidateTbl._CONS_.REL_GRID).jqGrid("sortGrid","sort",false);});$(".form_wrapper").on("click",".toRigGrid",function(){var selectRowIds=self._getSelectRowId(ValidateTbl._CONS_.UN_REL_GRID_ID)+"";
if(selectRowIds!=""){var rowIds=selectRowIds.split(",");var mysort=0;var gridRowIds=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getDataIDs");for(var i=0;i<gridRowIds.length;
i++){var relRowData=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getRowData",gridRowIds[i]);var tmpSort=Number(relRowData["sort"]);mysort=tmpSort>=mysort?(tmpSort+1):mysort;
}for(var i=0;i<rowIds.length;i++){var rowData=$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("getRowData",rowIds[i]);var parameters={type:rowData["type"],key:rowData["key"],sort:mysort};
$(ValidateTbl._CONS_.REL_GRID).jqGrid("addRowData",rowIds[i],parameters,1);$(ValidateTbl._CONS_.UN_REL_GRID).delRowData(rowIds[i]);mysort++;}self.hadCHangeCol=true;
}});$(".form_wrapper").on("click",".toLeftGrid",function(){var selectRowIds=self._getSelectRowId(ValidateTbl._CONS_.REL_GRID)+"";if(selectRowIds!=""){var rowIds=selectRowIds.split(",");
for(var i=0;i<rowIds.length;i++){var rowData=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getRowData",rowIds[i]);var parameters={type:rowData["type"],key:rowData["key"]};
$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("addRowData",rowIds[i],parameters,"last");$(ValidateTbl._CONS_.REL_GRID).delRowData(rowIds[i]);}self.hadCHangeCol=true;
}});$(".form_wrapper").on("change",".saveColInfo",function(){if(self.hadCHangeCol){var options={title:"您确定要更改列吗？",text:"你已修改本列的校验规则，选择其他列，修改将会不被保存",cancelButtonText:"取消",confirmButtonText:"确认",yesFunc:function(){self._initUnRelValidateGrid();
self._getColRelVali();},noFunc:function(){return false;}};DialogUtils.confirmWithOptions(options);}else{self.changUnGridFlag=true;self._initUnRelValidateGrid();
}});$(".form_wrapper").on("click",".tableCol",function(){var tblName=$("input[name=tbl]").val().trim();if(tblName==""){alert("请输入表名");return;}var selectElement=document.getElementById("col");
selectElement.options.length=0;$.ajax({type:"GET",url:ValidateTbl._CONS_.GET_COL_URL+"?tbl="+tblName,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(msg){if(msg.success){if(msg.msg!=null&&msg.msg!=""){var selectElement=document.getElementById("col");
var options=eval(msg.msg);for(var i=0;i<options.length;i++){if(options[i]!="id_"&&options[i]!="create_by_"&&options[i]!="create_time_"&&options[i]!="update_by_"&&options[i]!="update_time_"){selectElement.options.add(new Option(tblName+"#"+options[i],tblName+"#"+options[i]));
}}if(options.length<1){DialogUtils.error("不存在该表");}else{self._getColRelVali();}}}else{showErro(msg.msg);}},error:function(msg){alert(msg);}});});},_initJqgrid:function(b){var a=this;
$(ValidateTbl._CONS_.GRID).JTJqgrid({url:ValidateTbl._CONS_.LIST_DATA_URL,pager:ValidateTbl._CONS_.PAGER,colNames:["表名","列名","验证业务键","创建时间","更新时间","操作"],colModel:[{name:"tbl",width:120,index:"tbl_"},{name:"col",width:120,index:"col_"},{name:"keys",width:120,index:"keys_"},{name:"createTime",width:180,index:"create_time_"},{name:"updateTime",width:120,index:"update_time_",hidden:true},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",title:"操作",formatoptions:a._getManagerBtns()}]});
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("validateTbl.button.delete")){a.push({lable:"删除",btnClasses:"btn btn-primary validateTblDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("validateTbl.button.edit")){a.push({lable:"编辑",btnClasses:"btn btn-primary validateTblEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("validateTbl.button.detail")){a.push({lable:"明细",btnClasses:"btn btn-primary validateTblDetail",iconClasses:"fa fa-detail"});
}return a;},_reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ValidateTbl._CONS_.GRID);},_add:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
var a=document.getElementById("col");a.options.length=0;document.getElementById("tbl").readOnly=false;ButtonUtils.enableBtn("tblButton");this._initUnRelValidateGrid();
this._initRelValidateGrid();},_edit:function(a){$(".list_wrapper").hide();$(".form_wrapper").show();this._loadData(a);},_loadData:function(b){var a=this;
FormUtils.loadData(ValidateTbl._CONS_.EDIT_URL+"?id="+b,function(d){$("input[name=id]").val(d.id);$("input[name=tbl]").val(d.tbl);document.getElementById("tbl").readOnly=true;
ButtonUtils.disableBtn("tblButton");var c=document.getElementById("col");c.options.length=0;c.options.add(new Option(d.tbl+"#"+d.col,d.tbl+"#"+d.col));
$("input[name=col]").val(d.tbl+"#"+d.col);$("input[name=createTime]").val(d.createTime);$("input[name=updateTime]").val(d.updateTime);a.changUnGridFlag=true;
a._initUnRelValidateGrid();});},_del:function(a){DialogUtils.confirm(function(){DialogUtils.deleteByIds(ValidateTbl._CONS_.DELETE_URL,a,function(b){$(ValidateTbl._CONS_.GRID).jqGrid("setGridParam",{postData:{}}).trigger("reloadGrid");
DialogUtils.success("提示",b.msg);});});},_initUnRelValidateGrid:function(){var a=this;var b='<table id="'+ValidateTbl._CONS_.UN_REL_GRID_ID+'"  ></table>';
$("#unRelValidateGridDiv").empty().html($(b));$.jgrid.defaults.styleUI="Bootstrap";$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid({datatype:"json",url:ValidateTbl._CONS_.LIST_USE_URL+"?types=base,mix",height:200,autowidth:true,shrinkToFit:true,rowNum:1000,mtype:"POST",multiselect:true,sortable:false,caption:"验证规则",rowList:[10,20,30],colNames:["规则类型","规则业务键"],colModel:[{name:"type",width:80,sortable:false,editoptions:{value:"base:基础验证规则;mix:复合验证规则,private:私有验证规则"},formatter:function(c,d,e){if(e.type=="base"){return"基础验证规则";
}else{if(e.type=="mix"){return"复合验证规则";}else{if(e.type=="private"){return"私有验证规则";}else{if(e.type==undefined){return"";}}}}return e.type;}},{name:"key",width:80,sortable:false}],hidegrid:false,gridComplete:function(){if(a.changUnGridFlag){a.changGridFlag=true;
a.changUnGridFlag=false;a._initRelValidateGrid();}},ondblClickRow:function(d,m,n,k){var f=$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("getRowData",d);var g=0;
var l=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getDataIDs");for(var j=0;j<l.length;j++){var c=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getRowData",l[j]);var h=Number(c["sort"]);
g=h>=g?(h+1):g;}var o={type:f["type"],key:f["key"],sort:g};$(ValidateTbl._CONS_.REL_GRID).jqGrid("addRowData",d,o,"last");$(ValidateTbl._CONS_.UN_REL_GRID).delRowData(d);
a.hadCHangeCol=true;}});},_initRelValidateGrid:function(){var a=this;var b='<table id="'+ValidateTbl._CONS_.REL_GRID_ID+'"  ></table>';$("#relValidateGridDiv").empty().html($(b));
$.jgrid.defaults.styleUI="Bootstrap";$(ValidateTbl._CONS_.REL_GRID).jqGrid({datatype:"local",height:200,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",multiselect:true,sortable:true,sortname:"sort",sortorder:"asc",caption:"已选择验证规则",rowList:[10,20,30],colNames:["规则类型","规则业务键","序号","操作"],colModel:[{name:"type",width:80,sortable:false,editoptions:{value:"base:基础验证规则;mix:复合验证规则,private:私有验证规则"},formatter:function(c,d,e){if(e.type=="base"){return"基础验证规则";
}else{if(e.type=="mix"){return"复合验证规则";}else{if(e.type=="private"){return"私有验证规则";}else{if(e.type==undefined){return"";}}}}return e.type;}},{name:"key",width:80,sortable:false},{name:"sort",width:30,editable:true,editrules:{number:true},sortable:false},{name:"button",width:80,sortable:false}],hidegrid:false,gridComplete:function(){var e=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getDataIDs");
for(var d=0;d<e.length;d++){var f=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getRowData",e[d]);if(f["button"]==""){var c="<input  type='button'  value='确认修改' class='"+ValidateTbl._CONS_.REL_GRID_ID+"_rowcom_"+e[d]+' btn btn-primary gridSort\'   onclick=\'JTSubGridUtils.gridRowEvent("save","'+ValidateTbl._CONS_.REL_GRID_ID+'","'+e[d]+"\");' style='margin: 0px 3px 0px 0px;display:none;'   >";
var h="<input  type='button'  value='取消修改' class='"+ValidateTbl._CONS_.REL_GRID_ID+"_rowcanl_"+e[d]+' btn btn-primary\'   onclick=\'JTSubGridUtils.gridRowEvent("cancel","'+ValidateTbl._CONS_.REL_GRID_ID+'","'+e[d]+"\");' style='margin: 0px 3px 0px 0px;display:none;' >";
var j=new StringBuffer();j.append('<input  onClick=\'JTSubGridUtils.gridRowEvent("edit","').append(ValidateTbl._CONS_.REL_GRID_ID).append('","').append(e[d]).append("\")'  style='margin: 0px 3px 0px 0px;'  class=' btn btn-primary ").append(ValidateTbl._CONS_.REL_GRID_ID).append("_rowedit_").append(e[d]).append("' type='button'  value='修改序号'>").append(c).append(h);
var g=""+j;$(ValidateTbl._CONS_.REL_GRID).jqGrid("setRowData",e[d],{button:g});}}if(a.changGridFlag){a.changGridFlag=false;a._getColRelVali();}},ondblClickRow:function(f,i,c,h){var g=$(ValidateTbl._CONS_.REL_GRID).jqGrid("getRowData",f);
var d={type:g["type"],key:g["key"]};$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("addRowData",f,d,"last");$(ValidateTbl._CONS_.REL_GRID).delRowData(f);a.hadCHangeCol=true;
}});},_getSelectRowId:function(a){return $(a).jqGrid("getGridParam","selarrrow");},_getKeysByGrid:function(a){var d="#"+a;var h=[];var f=$(d).jqGrid("getDataIDs");
for(var c=0;c<f.length;c++){var g=$(d).jqGrid("getRowData",f[c]);h.push({"key":g["key"],"sort":g["sort"]});}h.sort(this._compare("sort"));var b=new StringBuffer();
for(var c=0;c<h.length;c++){b.append(h[c].key).append(",");}var e=""+b;if(e.length!=""){$("input[name=keys]").val(e.substring(0,e.length-1));}else{$("input[name=keys]").val("");
}},_compare:function(a){return function(e,d){var c=e[a];var b=d[a];if(b>c){return -1;}else{if(b<c){return 1;}else{return 0;}}};},_getColRelVali:function(){var b=$("#col").val();
var c=b.substring(0,b.indexOf("#"));var a=b.substring(b.indexOf("#")+1);$.ajax({type:"GET",url:ValidateTbl._CONS_.VALIDATES_COL__URL+"?tbl="+c+"&col="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(k){if(k.keys==undefined){$("#id").val("");
$("input[name=createTime]").val("");$("input[name=updateTime]").val("");return false;}$("#id").val(k.id);$("input[name=createTime]").val(k.createTime);
$("input[name=updateTime]").val(k.updateTime);var h=$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("getDataIDs");var g=k.keys.split(",");for(var d=0;d<g.length;
d++){for(var e=0;e<h.length;e++){var l=$(ValidateTbl._CONS_.UN_REL_GRID).jqGrid("getRowData",h[e]);if(l["key"]==g[d]){var f={type:l["type"],key:l["key"],sort:d};
$(ValidateTbl._CONS_.REL_GRID).jqGrid("addRowData",h[e],f,"last");$(ValidateTbl._CONS_.UN_REL_GRID).delRowData(h[e]);break;}}}},error:function(d){DialogUtils.error("没有权限","没有权限");
}});}};