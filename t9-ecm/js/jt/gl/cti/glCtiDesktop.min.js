$(function(){function b(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.intervalId=null;this.timeOutId=null;}b._CONS_={LIST_DATA_URL:ctx+"/gl/cti/glCti/listCtiData.htm",GET_EXT_MESSAGE_URL:ctx+"/gl/cti/glCti/getExtMessage.htm"};
b.prototype={init:function(d){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadData();var c=this;this.intervalId=setInterval(function(){c._updateData();
},parseInt($("select[name=intervalValue]").val())*60*1000);}},_loadData:function(){var c=this;FormUtils.loadData(b._CONS_.LIST_DATA_URL,function(e){for(var d=0;
d<e.length;d++){$("#CTIcontainer").append(c._createPanel(e[d]));}c._updateData();});},_updateData:function(){var c=this;var e=new Date();var g=(e.getHours()>=10?e.getHours():("0"+e.getHours()))+":"+(e.getMinutes()>=10?e.getMinutes():("0"+e.getMinutes()))+":"+(e.getSeconds()>=10?e.getSeconds():("0"+e.getSeconds()));
$("#lastRefreshTime").empty().append(g);var f=e.getTime();$("#nowTime").val(f);var d=$("#CTIcontainer").find("table");if(d.length){d.each(function(){var h=$(this).find("tbody");
var i=h.find("tr").attr("acdVal");if(i){window.top.UMO.agentlist(i,function(l,j){if(j.errno==0){var k=j.agentlist;$.each(k,function(){var n=this.agentStatus;
var o=this.agentDN;if(n==2){var m=h.find("tr[acdVal='"+i+"']").find('div.extDiv[adnVal="'+o+'"]');m.removeClass("notInDiv").addClass("freeDiv");}else{if(n==4){m.removeClass("notInDiv").addClass("callDiv");
}}});}});}});}},_createPanel:function(c){var f=new StringBuffer();f.append('<table class="table table-bordered" id="'+c.name+'" data-ip="'+c.ip+'" data-port="'+c.port+'">');
f.append('<thead><th colspan="2">CTI:'+c.ip+":"+c.port+"</th>");f.append("<tbody>");for(var e=0;e<c.acds.length;e++){f.append('<tr acdVal="'+c.acds[e].number+'">').append('<td width="10%">').append("队列:"+c.acds[e].number).append("</td>").append('<td width="90%">');
for(var d=0;d<c.acds[e].adns.length;d++){f.append('<div class="extDiv notInDiv" adnVal="'+c.acds[e].adns[d]+'">'+c.acds[e].adns[d]+"</div>");}f.append("</td></tr>");
}f.append("</tbody>");f.append("</table>");return f.toString();},_bindEventHander:function(){var c=this;$(document).on("click",".RefreshBtn",function(){if(c.timeOutId!=null){clearTimeout(c.timeOutId);
c.timeOutId=null;}c._updateData();clearInterval(c.intervalId);c.intervalId=setInterval(function(){c._updateData();},parseInt($("select[name=intervalValue]").val())*60*1000);
});$(document).on("change","select[name=intervalValue]",function(){clearInterval(c.intervalId);if(c.timeOutId!=null){clearTimeout(c.timeOutId);c.timeOutId=null;
}var d=new Date();if((d.getTime()-parseInt($("input[id=nowTime]").val()))>parseInt($("select[name=intervalValue]").val())*60*1000){c._updateData();d=new Date();
$("input[id=nowTime]").val(d.getTime());c.intervalId=setInterval(function(){c._updateData();},parseInt($("select[name=intervalValue]").val())*60*1000);
}else{c.timeOutId=setTimeout(function(){c._updateData();c.intervalId=setInterval(function(){c._updateData();},parseInt($("select[name=intervalValue]").val())*60*1000);
c.timeOutId=null;},parseInt($("select[name=intervalValue]").val())*60*1000-(new Date()).getTime()+parseInt($("input[id=nowTime]").val()));}});},};var a=new b();
a.init();});