function TRKSheetRecord4Record(){this.hadInit=false;}TRKSheetRecord4Record._CONS_={LIST_DATA_URL:ctx+"/gl/cti/tRKSheetRecord/listDataForRecordByReqType.htm?reqType=normal_default",EXPORT_DATA_URL:ctx+"/gl/cti/tRKSheetRecord/exportRecord.htm",GRID:"#insideLineSheetRecordGrid",PAGER:"#insideLineSheetRecordPager"};
TRKSheetRecord4Record.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;new Switchery(document.querySelector("#tabBelong .js-switch"),{size:"small"});
this._bindEventHander();this._initToolbarSelect();this._initEmployeeSelect("");this._initBelongEmployeeSelect("");this._initJqgrid(a);this._hideNotGrantBtn();
this._locateToGlHelp();}},_initToolbarSelect:function(){if("y"==markCtiRecord&&$("#tabBelong #markSearchSelect").length){CateUtils.getOptions({typeKey:"system",pKey:"trksheetrecordMarkType",container:"markSearchSelect"});
$(document).on("change","#markSearchSelect",function(){var a=$(this).val();if(!a){$tr.find("#markDesSearchSelect").empty();}else{CateUtils.getOptions({typeKey:"system",pKey:a,container:"markDesSearchSelect"});
}});}if(versionType=="finance"){}if("y"==isShowBizTypeAndInterest){CateUtils.getOptions([{typeKey:"system",pKey:"CsBizTypes",container:"bizTypeSearch"},{typeKey:"system",pKey:"CsInterestType",container:"interestSearch"}]);
}ChannelUtils.getOptions({container:"srcsSearchSelect",caption:"全部",emptyOptions:"null"});this._prodSearch();},_prodSearch:function(a){$("#searchProd").bsSuggest("destroy");
var b=this;var e=$("#productNameSearchSelect").width()+"px";var c="entity";var f="n";var d="n";$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+f+"&storeId="+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(g){b.searchProds=g.value;
return g;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(h,g){b.searchProds=g.value;
}).on("onSetSelectValue",function(j,g){for(var h=0;h<b.searchProds.length;h++){if(b.searchProds[h].skuId==g.id){b.currentProd=b.searchProds[h];break;}}$("#searchProd").val(b.currentProd.prodName);
}).on("onUnsetSelectValue",function(g){b.currentProd={};});},_locateToGlHelp:function(){var a="glHelp.dataAudit.insideLineSheetRecord";glHelpUtil.init(a);
},_hideNotGrantBtn:function(){if(!ResUtils.canShow("trkSheetRecord.button.assign")){$("button.assignBtn").hide();}if(!ResUtils.canShow("trkSheetRecord.button.exportRecord")){$("button.exportRecord").hide();
}if(!ResUtils.canShow("trkSheetRecord.button.viewWebCall")){$("button.viewWebCallSearch").hide();}},_initEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#agentId").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].aid+"'>"+c[b].aid+":"+c[b].name+"</option>");
}}$("#agentId").append(d.toString()).select2();},null,true);},_initBelongEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#belongEmployeeIds").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");d.append("<option value='"+currentUserId+"'>"+currentUserAid+":"+currentUserName+"</option>");
if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}}$("#belongEmployeeIds").append(d.toString()).select2();
},null,true);},_bindEventHander:function(){var a=this;callRecordOperate.init();$("#tabBelong #orgName").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$("#orgId").val(),container:"orgName",fn:function(d){a._initEmployeeSelect(d);
$("#orgId").val(d);}});});$("#tabBelong #belongOrgName").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$("#belongOrgId").val(),container:"belongOrgName",fn:function(d){a._initBelongEmployeeSelect(d);
$("#belongOrgId").val(d);}});});var b=ctx+"/crm/cs/csEntity/detail.htm";var c=ctx+"/crm/cs/csEntity/getCsByCode.htm";$(document).on("click","#tabBelong .csEntityDetailBtn",function(){var d=$(this).attr("csCode");
var e=$(this).attr("csNameVal");FormUtils.submit(c,{csCode:d},function(f){if(!$.isEmptyObject(f)){var g=f.id;JTTabUtils.addOrRefreshTab(b+"?csId="+g+"&type=callRecord","客户["+e+"]明细");
}else{DialogUtils.error("错误","没有找到客户,请通过客户查询找该客户");}});});$(".list_wrapper").on("click","#tabBelong .insideLineSheetRecordSearch",function(){if(!$('input[name="startTime"]').val()){var e=new Date();
var g=e.currentDate();$('input[name="startTime"]').val(g);}var h=$("#agentId").val();var d="";if(h){for(var f=0;f<h.length;f++){if(h[f]){d+=h[f]+",";}}}if(d){d=d.substring(0,(d.length)-1);
}var j=$(this).closest("form").serialize();j+="&agentId="+d;a.reloadJqgrid(j);});$("#tabBelong #insideLineSheetRecordSearchForm").on("keypress",function(d){if(d.keyCode=="13"){$(".insideLineSheetRecordSearch").trigger("click");
}});$("body").on("click","#tabBelong .exportRecord",function(){if(!$('input[name="startTime"]').val()){var e=new Date();var f=e.currentDate();$('input[name="startTime"]').val(f);
}var d=$(TRKSheetRecord4Record._CONS_.GRID).jqGrid("getGridParam","selarrrow");var g=$(this).closest("form").serialize()+"&ids="+d;FormUtils.submit(TRKSheetRecord4Record._CONS_.EXPORT_DATA_URL,g,function(h){if(h.success){DialogUtils.success("成功",h.msg);
}else{DialogUtils.error("失败",h.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("click","#tabBelong .halfAsynExportRecord",function(){if(!$('input[name="startTime"]').val()){var e=new Date();
var f=e.currentDate();$('input[name="startTime"]').val(f);}var d=$(TRKSheetRecord4Record._CONS_.GRID).jqGrid("getGridParam","selarrrow");var g=$(this).closest("form").serialize()+"&ids="+d;
FormUtils.submit(TRKSheetRecord4Record._CONS_.EXPORT_DATA_URL,g,function(h){if(h.success){DialogUtils.success("成功",h.msg);}else{DialogUtils.error("失败",h.msg);
}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("click","#tabBelong .assignBtn",function(){var f=$(TRKSheetRecord4Record._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(f&&f.length){var e=[];for(var h=0;h<f.length;h++){var k=f[h];var j=$(TRKSheetRecord4Record._CONS_.GRID).jqGrid("getRowData",k);if(j.csId.trim().indexOf("未注册")!=-1){if(j.encryptNumber&&e.indexOf(j.encryptNumber)<0){e.push(j.encryptNumber);
}}}if(e.length){var d=new CsAssign(e,"csPhone");d.init();}else{DialogUtils.error("错误","没有可供分配的号码");}}else{var g="start="+$("input[name='startTime']").val();
if($("input[name='endTime']").val()){g+="&end="+$("input[name='endTime']").val();}else{g+="&end="+new Date().current();}var d=new CsAssign([],"clear",g);
d.init();}});$("body").on("click","#tabBelong .csEntityInBtn",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum="+$(this).attr("encryptNumberVal")+"&encryptInNumber="+$(this).attr("encryptInNumberVal")+"&inNum="+$(this).attr("inNumVal"),"新客户");
});$("#insideLineSheetRecordGrid tr img").hover(function(){$(this).closest("tr").addClass("active");});$("body").on("change","#insideLineSheetRecordSearchForm input[name='wipeRepeat']",function(){if($("#insideLineSheetRecordSearchForm input[name='wipeRepeat']").prop("checked")){$("select[name='daysRepeatCall']").attr("disabled","disabled");
}else{$("select[name='daysRepeatCall']").removeAttr("disabled");}});},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);
};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(TRKSheetRecord4Record._CONS_.GRID,a);},_initJqgrid:function(e){var k=this;
if(e==null||typeof e==undefined){e={};}var g=new Date();var c=g.currentDate()+" 00:00:00";$('#tabBelong input[name="startTime"]').val(c);var d="n";$("#tabBelong input[name=wipeRepeat]").val([d]);
var a=true;if(ResUtils.canShow("trkSheetRecord.isShowCsPhone")){a=false;}var b=["客户ID","客户号码","隐藏号码","客户归属"];var f=false;if("y"==isShowBizTypeAndInterest){f=true;
b.push("客户意向");b.push("客户分类");}var l=["地区","方向","类型","分机","员工工号","部门","性质","来源(外显)","主叫","被叫","开始时间","通话时长","呼叫时长","标识","评价","录音"];l=b.concat(l);var j=[{name:"csCode",align:"center",index:"cs_code_",sortable:true,width:f?100:120,formatter:function(n,q,m){if(n){var o=n+":"+m.csName;
if($(window).width()<1024){o=n+"<br>"+m.csName;}var p="<a csCode='"+n+"' href='javascript: void(0);' csIdVal='"+m.csId+"' csNameVal='"+m.csName+"' class='csEntityDetailBtn'>"+o+"</a>";
if(!ResUtils.canShow("csEntity.button.editCallRecord")){p="<a csCode='"+n+"' href='javascript: void(0);' csIdVal='"+m.csId+"' csNameVal='"+m.csName+"'>"+o+"</a>";
}return p;}else{return"";}}},{name:"csPhone",align:"center",sortable:false,width:f?100:140,hidden:a,formatter:function(q,n,p){if(!p.csId){var o=null;var m=p.source;
if(p.direction==0){o=p.encryptAno;}else{o=p.encryptBno;}if(reqType&&reqType=="recordIdParams"){return"<span title='创建客户' class='' href='javascript: void(0);' encryptInNumberVal='"+o+"'  encryptNumberVal='"+p.encryptNumber+"'>"+q+"</span>";
}else{return"<a inNumVal='"+m+"' title='创建客户' class='csEntityInBtn' href='javascript: void(0);' encryptInNumberVal='"+o+"'  encryptNumberVal='"+p.encryptNumber+"'>"+q+"</a>";
}}else{return q;}}},{name:"encryptNumber",align:"center",sortable:false,width:140,hidden:true},{name:"belongEmployeeAid",align:"center",index:"belongEmployeeAid",width:f?100:120,sortable:false,formatter:function(m){if($(window).width()<1024&&m.indexOf(":")!=-1){return m.split(":")[0]+"<br>"+m.split(":")[1];
}else{return m;}}}];if("y"==isShowBizTypeAndInterest){j.push({name:"interests",align:"center",index:"interests",sortable:false,width:80});j.push({name:"bizType",align:"center",index:"bizType",sortable:false,width:80});
}var h=[{name:"addr",align:"center",index:"addr",sortable:false,width:120},{name:"direction",align:"center",index:"Direction",width:60,formatter:function(m){if(m==0){return'<div style="height:25px;width:25px;background:url(/t9-ecm/img/jt/callout.png) no-repeat center;">';
}else{if(m==1){return'<div style="height:25px;width:25px;background:url(/t9-ecm/img/jt/callin.png) no-repeat center;">';}}}},{name:"recfile",align:"center",index:"IsRouteAgent",width:50,formatter:function(n,m,o){if(n){return"<span class='text text-primary'>已接</span>";
}else{return"<span class='text text-danger'>未接</span>";}}},{name:"adn",align:"center",sortable:false,width:60},{name:"employeeAid",align:"center",sortable:false,width:120,formatter:function(n,m,o){if($(window).width()<1024){return n+"<br>"+o.employeeName;
}else{return n+":"+o.employeeName;}}},{name:"groupName",align:"center",sortable:false,width:120},{name:"csId",sortable:false,width:60,formatter:function(m){if(m&&m.trim()){return"<span class='text text-primary'>已注册</span>";
}else{return"<span class='text text-danger'>未注册</span>";}}},{name:"source",align:"center",sortable:true,width:100,formatter:function(o,n,m){if(o){return m.source;
}else{return"无";}}},{name:"ano",hidden:true,align:"center",sortable:false,width:120,formatter:function(o,n,m){if(m.direction==0){return m.source;}else{if(m.direction==1){return m.csPhone;
}}}},{name:"bno",hidden:true,align:"center",sortable:false,width:100,formatter:function(o,n,m){if(m.direction==0){return m.csPhone;}else{if(m.direction==1){return m.source;
}}}},{name:"begtime",align:"center",index:"BegTime",width:100,formatter:function(m){return DateUtils.mini2Time(m);}},{name:"duration",align:"center",sortable:true,width:60,formatter:function(o,n,m){if(m.recfile){return DateUtils.toChineseTime(o);
}else{return"";}}},{name:"ringduration",align:"center",sortable:false,width:80,formatter:function(o,n,m){if(!m.recfile){return DateUtils.toChineseTime(m.duration);
}else{return"";}}},{name:"mark",align:"center",sortable:false,width:120,hidden:markCtiRecord!="y",formatter:function(o,m,n){if(o){return'<div style="width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis">'+o+":"+n.markDes+"</div>";
}else{return"";}},},{name:"uud",align:"center",sortable:false,width:f?30:50,hidden:showPJ!="show",formatter:function(o,n,m){if(!o){return"无";}if(o.indexOf("PJ:1")!=-1){return"满意";
}else{if(o.indexOf("PJ:2")!=-1){return"一般";}else{if(o.indexOf("PJ:3")!=-1){return"不满意";}}}return"无";}},{name:"recfile",align:"center",width:180,formatter:function(p,o,m){if(p){var n=k._generateCode();
var q=new StringBuffer();if(ResUtils.canShow("trkSheetRecord.button.listen")){q.append("<button title='调取录音' uniqueCode='"+n+"'   id-value ='"+m.id+"'  recfileVal='"+p+"' class='listenBtn jt-btn-safe'><i class='fa fa-caret-square-o-left' ></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordTranslate")){q.append("<button title='录音翻译' uniqueCode='"+n+"' id-value ='"+m.id+"' recfileVal='"+p+"' class='operateRecordTrans2WordBtn jt-btn-safe'><i class='fa fa-language'></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.download")){q.append("<button title='下载录音' uniqueCode='"+n+"'   id-value ='"+m.id+"'  recfileVal='"+p+"' class='downloadBtn jt-btn-safe'><i class='fa fa-download'></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.delete")){q.append("<button title='删除录音' uniqueCode='"+n+"'  id-value ='"+m.id+"'  recfileVal='"+p+"' class='deleteBtn  jt-btn-error'><i class='fa fa-remove'></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordMark")){q.append("<button title='通话标识' uniqueCode='"+n+"' id-value ='"+m.id+"' recfileVal='"+p+"' class='operateRecordMarkBtn jt-btn-safe'><i class='fa fa-bookmark'></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordRecomm")){q.append("<button title='录音推荐' uniqueCode='"+n+"' id-value ='"+m.id+"' recfileVal='"+p+"' class='operateRecordShareBtn jt-btn-safe'><i class='fa fa-thumbs-o-up'></i></button>");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordHi")){q.append("<button title='操作记录' uniqueCode='"+n+"' id-value ='"+m.id+"' recfileVal='"+p+"' class='operateRecordHiBtn jt-btn-safe'><i class='fa fa-list'></i></button>");
}return q.toString();}else{return"";}}}];h=j.concat(h);var i=null;i=TRKSheetRecord4Record._CONS_.LIST_DATA_URL;if(versionType=="finance"){i+="&sidx=cs_code_&sord=asc";
}$(TRKSheetRecord4Record._CONS_.GRID).JTJqgrid({url:i,pager:TRKSheetRecord4Record._CONS_.PAGER,postData:{startTime:c,wipeRepeat:d},colNames:l,colModel:h,rownumbers:true});
}};