$(function(){var a=new CtiBatcallTask();a.init();});function CtiBatcallTask(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.fileSingleSizeLimit=0;
}CtiBatcallTask._CONS_={EDIT_URL:ctx+"/gl/cti/ctiBatcallTask/edit.htm",DETAIL_URL:ctx+"/gl/cti/ctiBatcallTask/detail.htm",DELETE_URL:ctx+"/gl/cti/ctiBatcallTask/delete.htm",UPDATE_STATUS_URL:ctx+"/gl/cti/ctiBatcallTask/updateStatus.htm",SAVE_ADD_URL:ctx+"/gl/cti/ctiBatcallTask/saveAdd.htm",SAVE_ADD_NOFILE_URL:ctx+"/gl/cti/ctiBatcallTask/saveAddNoFile.htm",SAVE_EDIT_URL:ctx+"/gl/cti/ctiBatcallTask/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/cti/ctiBatcallTask/listData.htm",NEW_LIST_DATA_URL:ctx+"/gl/cti/ctiBatcallTask/newListData.htm",IMPORT_EXCEL_URL:ctx+"/gl/cti/ctiBatcallTask/importExcel.htm",EDIT_FORM_ID:"ctiBatcallTaskForm",GRID:"#ctiBatcallTaskGrid",PAGER:"#ctiBatcallTaskPager"};
CtiBatcallTask.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._initTaskList(a);this._locateToGlHelp();}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.runtime.batchCall");},_findMaxFileSize:function(){var a=this;
ConfigUtils.findByKey("system.fileUploadMaxSize",function(b){a.fileSingleSizeLimit=b.msg*1024*1024;a._bindExceluploader();});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("ctiBatcallTask.button.detail")){$(".ctiBatcallTaskDetail").hide();
}if(!ResUtils.canShow("ctiBatcallTask.button.edit")){$(".ctiBatcallTaskEdit").hide();}if(!ResUtils.canShow("ctiBatcallTask.button.delete")){$(".ctiBatcallTaskDel").hide();
}if(!ResUtils.canShow("ctiBatcallTask.button.ctiBatcallItemList")){$(".ctiBatcallItemList").hide();}if(!ResUtils.canShow("ctiBatcallTask.button.ctiBatcallItemExport")){$(".ctiBatcallItemExport").hide();
}if(!ResUtils.canShow("ctiBatcallTask.button.ctiBatcallDispnumList")){$(".ctiBatcallDispnumList").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(CtiBatcallTask._CONS_.EDIT_FORM_ID);FormUtils.enableForm(CtiBatcallTask._CONS_.EDIT_FORM_ID);
$("#myCsEntityDiv").empty();$("#mySubCsEntityDiv").empty();if(c){a._initTaskList();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_add:function(){this._showFormWrapper();$(".ctiItemDiv").hide();$(".editInfo").hide();$(".addInfo").show();},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(CtiBatcallTask._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;$(".editInfo").show();$(".addInfo").hide();FormUtils.loadData(CtiBatcallTask._CONS_.EDIT_URL+"?id="+b,function(d){$("#createName").text(d.createName);
$("#createTime").text(d.createTime);var c=d.status==0?'<a  class="label label-danger" style="border-radius: .25em;">已停止</a>':'<a  class="label label-success" style="border-radius: .25em;">正在执行</a>';
$("#taskStatus").html(c);$("#callTotal").text(d.callTotal+"/"+d.itemTotal);});$("#itemIframe").attr("src",ctx+"/gl/cti/ctiBatcallItem/ctiBatcallItemList.htm?taskId="+b);
},_save:function(){var d=this;var h=$("#id").val();var b=null;if(h!=null&&h!=""){b=CtiBatcallTask._CONS_.SAVE_EDIT_URL;}else{b=CtiBatcallTask._CONS_.SAVE_ADD_URL;
}var g=true;if(!$("#ctiBatcallFile").val()){b=CtiBatcallTask._CONS_.SAVE_ADD_NOFILE_URL;g=false;$("#ctiBatcallTaskForm").attr("enctype","application/x-www-form-urlencoded;charset=utf-8");
}var c=new Array();$("#myCsEntityDiv").find("input[name=csEntityCheckBox]:checked").each(function(){c.push($(this).val());});var a=new Array();$("#mySubCsEntityDiv").find("input[name=csEntityCheckBox]:checked").each(function(){a.push($(this).val());
});var e=c.join(",");var f=a.join(",");$("#ctiBatcallTaskForm").find("input[name=selfCsIds]").val(e);$("#ctiBatcallTaskForm").find("input[name=subCsIds]").val(f);
if($("#ctiBatcallTaskForm").valid()){$("#ctiBatcallTaskForm").ajaxSubmit({type:"post",url:b,dataType:"json",contentType:g?"multipart/form-data":"application/x-www-form-urlencoded;charset=utf-8",beforeSend:function(){createLoadingFunc();
},success:function(i){ButtonUtils.enableBtn("saveBtn");if(i.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);d.isEdit=false;d.clear(true);
}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}removeLoadingFunc();}});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(CtiBatcallTask._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._initTaskList();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_updateStatus:function(c,a){var b=this;FormUtils.submit(CtiBatcallTask._CONS_.UPDATE_STATUS_URL,{"id":c,"status":a},function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
b._initTaskList();}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$("#"+CtiBatcallTask._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+CtiBatcallTask._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+CtiBatcallTask._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".ctiBatcallTaskSearch").on("click",function(){var b=$(this).closest("form").serialize();a._initTaskList(b);});$("#ctiBatcallTaskSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".ctiBatcallTaskSearch").trigger("click");
}});$("body").on("click",".ctiBatcallTaskAdd",function(){a._add();});$("body").on("click",".ctiBatcallTaskEdit",function(){a.isEdit=true;$(".saveBtn").hide();
var b=$(this).attr("idVal");if(!b){b=$(CtiBatcallTask._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".ctiBatcallTaskDel",function(){var c=$(this).attr("idVal");
var b=$(this).attr("status");if(b=="1"){DialogUtils.error(msgCode.error,"正在执行,不能删除");return;}if(!c){c=$(CtiBatcallTask._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(c);});$("body").on("click",".ctiBatcallTaskDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(CtiBatcallTask._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(document).on("click",".updateStatus",function(){var c=$(this).attr("idVal");
var b=$(this).attr("dataValue");if(c){if(b=="0"){a._updateStatus(c,"1");}else{if(b=="1"){a._updateStatus(c,"0");}}}});$("body").on("click",".ctiBatcallItemList",function(){var c=$(this).attr("idVal");
if(!c){c=$(CtiBatcallTask._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要操作的记录");return;
}else{if(c&&c.length>1){DialogUtils.error(msgCode.error,"不能操作多条记录");return;}}}var b=$(CtiBatcallTask._CONS_.GRID).jqGrid("getRowData",c);JTTabUtils.addOrRefreshTab(ctx+"/gl/cti/ctiBatcallItem/ctiBatcallItemList.htm?taskId="+c,"外呼条目列表");
});$("body").on("click",".ctiBatcallDispnumList",function(){JTTabUtils.addOrRefreshTab(ctx+"/gl/cti/ctiBatcallDispnum/ctiBatcallDispnumList.htm","外呼显示号列表");
});$("body").on("click",".ctiBatcallItemExport",function(){var b={"importUrl":CtiBatcallTask._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入客户excel数据"};excelUtil.importExcel(b);
});$("body").on("click",".selectSelfCsEntity",function(){var c={type:"self",baseUrl:ctx+"/crm/cs/csEntity/list.htm?isSelectCsEntity=true",callBack:function(f,d){a._appendCsEntityDiv(f,d,"#myCsEntityDiv");
var e=$("#myCsEntityDiv").find("input[name=csEntityCheckBox]:checked").length;$(".myCsTotal").html(e);}};var b=new SelectCsEntityService();b.init(c);});
$("body").on("click",".selectMySubCsEntity",function(){var c={type:"mysub",baseUrl:ctx+"/crm/cs/csEntity/subList.htm?isSelectCsEntity=true",callBack:function(f,d){a._appendCsEntityDiv(f,d,"#mySubCsEntityDiv");
var e=$("#mySubCsEntityDiv").find("input[name=csEntityCheckBox]:checked").length;$(".mySubCsTotal").html(e);}};var b=new SelectCsEntityService();b.init(c);
});$("body").on("change","#mySubCsEntityDiv input[name=csEntityCheckBox]",function(){var b=$("#mySubCsEntityDiv").find("input[name=csEntityCheckBox]:checked").length;
$(".mySubCsTotal").html(b);});$("body").on("change","#myCsEntityDiv input[name=csEntityCheckBox]",function(){var b=$("#myCsEntityDiv").find("input[name=csEntityCheckBox]:checked").length;
$(".myCsTotal").html(b);});},_appendCsEntityDiv:function(d,c,f){if(d&&d.length>0){var b="";var g=new Array();$(f).find("input[name=csEntityCheckBox]").each(function(){g.push($(this).val());
});var e=g.join(",");for(var a=0;a<d.length;a++){if((d[a].phone==""||d[a].phone==null)&&(d[a].subPhone==""||d[a].subPhone==null)){continue;}if(e.length>0&&!(g.indexOf(d[a].id)<0)){continue;
}b+='<div class="col-sm-2">'+'<div class="checkbox checkbox-success checkbox-inline">'+'<input type="checkbox" class="columnCheckBox" name="csEntityCheckBox" value="'+d[a].id+'" checked>';
if("all"==c){b+='<label for="'+d[a].id+'">'+d[a].code+":"+d[a].name+"</label>";}else{b+='<label for="'+d[a].id+'">'+d[a].code+"</label>";}b+="</div>"+"</div>";
}$(f).append(b);}},_bindFormValidation:function(){var a={rules:{subdata:"required",},messages:{subdata:"请输入操作数据",}};FormUtils.bindFormValidation(CtiBatcallTask._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(CtiBatcallTask._CONS_.GRID,a);},_getManagerBtns:function(b){var a="";if(ResUtils.canShow("ctiBatcallTask.button.edit")){a+='<span style="margin-left:10px;"><button type="button" class="btn btn-sm btn-outline btn-primary ctiBatcallTaskEdit" idVal="'+b+'" >编辑</button></span>';
}if(ResUtils.canShow("ctiBatcallTask.button.detail")){}if(ResUtils.canShow("ctiBatcallTask.button.delete")){a+='<span style="margin-left:10px;"><button type="button" class="btn btn-sm btn-outline btn-danger ctiBatcallTaskDel"  idVal="'+b+'"  status="1">删除</button></span>';
}return a;},_initTaskList:function(a){FormUtils.submit(CtiBatcallTask._CONS_.NEW_LIST_DATA_URL,a,function(e){var d="";if(e&&e.rows&&e.rows.length>0){for(var c=0;
c<e.rows.length;c++){var b=e.rows[c];if(b.status==1){d+='<div class="cardBox col-sm-2">'+'<div class="headerBox" style="background-color: #4caf50;">'+'<span  style="cursor: pointer; color:white">'+b.createTime+"</span>"+'<span style="float:right;margin-left:5px;"><i class="icon-remove ctiBatcallTaskDel" idVal="'+b.id+'" status="1"></i></span>'+'<span style="float:right;margin-left:5px;"><i class="fa fa-edit ctiBatcallTaskEdit"  idVal="'+b.id+'"></i></span>'+"</div>"+'<div class="bodyBox ">'+'<div class="col-sm-6" ><span style="float:right;">创建人：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.createName+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">未拨条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.uncallTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">已拨条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.callTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">总条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.itemTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">任务状态(按钮)：</span></div><div class="col-sm-6" ><span style="float:left;"><a  class="label label-success updateStatus" idVal="'+b.id+'" dataValue="1" style="border-radius: .25em;">正在执行</a></span></div>'+"</div>"+"</div>";
}else{d+='<div class="cardBox col-sm-2">'+'<div class="headerBox" style="background-color: #5BC0DE;">'+'<span title="查看详情" style="cursor: pointer; color:white">'+b.createTime+"</span>"+'<span style="float:right;margin-left:5px;" ><i class="icon-remove ctiBatcallTaskDel"  idVal="'+b.id+'"  status="0"></i></span>'+'<span style="float:right;margin-left:5px;"  ><i class="fa fa-edit ctiBatcallTaskEdit" idVal="'+b.id+'"></i></span>'+"</div>"+'<div class="bodyBox ">'+'<div class="col-sm-6" ><span style="float:right;">创建人：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.createName+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">未拨条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.uncallTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">已拨条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.callTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">总条数：</span></div><div class="col-sm-6" ><span style="float:left;">'+b.itemTotal+"</span></div>"+'<div class="col-sm-6" ><span style="float:right;">任务状态(按钮)：</span></div><div class="col-sm-6" ><span style="float:left;"><a  class="label label-danger updateStatus" idVal="'+b.id+'" dataValue="0" style="border-radius: .25em;">已停止</a></span></div>'+"</div>"+"</div>";
}}}$("#ctiBatcallTaskList").empty().append(d);});},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}$(CtiBatcallTask._CONS_.GRID).JTJqgrid({url:CtiBatcallTask._CONS_.LIST_DATA_URL,pager:CtiBatcallTask._CONS_.PAGER,postData:b,colNames:["创建时间","总条数","已拨条数","未拨条数","创建人","状态","状态","操作"],colModel:[{name:"createTime",index:"create_time_",width:120},{name:"itemTotal",index:"item_total_",width:120},{name:"callTotal",index:"",width:120},{name:"uncallTotal",index:"",width:120},{name:"createName",index:"create_name_",width:120},{name:"status",index:"status_",hidden:true},{name:"",index:"",width:120,formatter:function(c,d,e){if(e.status=="0"){return"<span class='text text-primary'>已停止</span>";
}else{if(e.status=="1"){return"<span class='text text-warning'>正在执行</span>";}else{return"";}}},},{name:"oper",index:"oper",width:100,sortable:false,formatter:function(d,e,f){var c=a._getManagerBtns(f.id);
return c;}}]});},};