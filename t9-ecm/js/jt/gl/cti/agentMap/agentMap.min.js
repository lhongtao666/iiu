$(function(){var a=new AgentMap();a.init();});function AgentMap(){this.hadInit=false;this.line_chart=null;this.myChart=null;this.initLineChart=false;this.initMyChart=false;
}AgentMap._CONS_={CS_CALL_LIMIT_URL:ctx+"/gl/cti/agentMap/csCallLimitList.htm",LIST_DATA_URL:ctx+"/gl/cti/agentMap/listData.htm",UPDATE_EMP_TO_CS_LOCKING_URL:ctx+"/gl/cti/agentMap/updateEmpToCsLocking.htm",UPDATE_EMP_TO_CS_INTERVAL_URL:ctx+"/gl/cti/agentMap/updateEmpToCsInterval.htm",CANCEL_WARNING_URL:ctx+"/gl/cti/agentMap/cancelWarning.htm",INIT_AGENTMAP_CHART_URL:ctx+"/gl/cti/agentMap/initAgentMapChart.htm",INIT_AGENTMAP_STATUS_CHART_URL:ctx+"/gl/cti/agentMap/initAgentMapStatusChart.htm",UPDATE_ADN_STATUS_URL:ctx+"/crm/ou/employee/updateAdnStatusById.htm",};
AgentMap.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this._initData();this._bindEventHander();var a=this;this._locateToGlHelp();this.intervalId=setInterval(function(){a._loadAgentMap();
a._initAgentStatusChart();},2000);}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.runtime.agentMap");},_initData:function(){var a=this;a._loadAgentMap();
a._initAgentStatusChart();a._initAgentMapChart();},_bindEventHander:function(){var a=this;$(document).on("click",".agentRowTr",function(){var b=$(this).attr("empId");
if(b){FormUtils.loadData(AgentMap._CONS_.CS_CALL_LIMIT_URL+"?empId="+b,function(c){a._loadEmpToCsData(c);});}});$(document).on("click",".cancelWarning",function(b){var c=$(this).attr("empId");
if(c){FormUtils.submit(AgentMap._CONS_.CANCEL_WARNING_URL+"?empId="+c,null,function(d){if(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");}}else{DialogUtils.error(msgCode.ERROR,"操作失败");
}});}b.stopPropagation();});$(document).on("click",".cancelLocking",function(){var c=$(this).attr("empId");var b=$(this).attr("csId");if(c&&b){FormUtils.submit(AgentMap._CONS_.UPDATE_EMP_TO_CS_LOCKING_URL+"?empId="+c+"&csId="+b+"&isLocking=n",null,function(d){if(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");
FormUtils.loadData(AgentMap._CONS_.CS_CALL_LIMIT_URL+"?empId="+c,function(e){a._loadEmpToCsData(e);});}}else{DialogUtils.error(msgCode.ERROR,"操作失败");}},null);
}});$(document).on("click",".locking",function(){var c=$(this).attr("empId");var b=$(this).attr("csId");if(c&&b){FormUtils.submit(AgentMap._CONS_.UPDATE_EMP_TO_CS_LOCKING_URL+"?empId="+c+"&csId="+b+"&isLocking=y",null,function(d){if(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");
FormUtils.loadData(AgentMap._CONS_.CS_CALL_LIMIT_URL+"?empId="+c,function(e){a._loadEmpToCsData(e);});}}else{DialogUtils.error(msgCode.ERROR,"操作失败");}},null);
}});$(document).on("blur",".intervalInput",function(){var c=$(this).attr("empId");var b=$(this).attr("csId");var d=$(this).val();if(c&&b){FormUtils.submit(AgentMap._CONS_.UPDATE_EMP_TO_CS_INTERVAL_URL+"?empId="+c+"&csId="+b+"&interval="+d,null,function(e){if(e){if(e.success){DialogUtils.success(msgCode.INFO,"操作成功");
}else{DialogUtils.error(msgCode.ERROR,e.msg);FormUtils.loadData(AgentMap._CONS_.CS_CALL_LIMIT_URL+"?empId="+c,function(f){a._loadEmpToCsData(f);});}}else{DialogUtils.error(msgCode.ERROR,"操作失败");
FormUtils.loadData(AgentMap._CONS_.CS_CALL_LIMIT_URL+"?empId="+c,function(f){a._loadEmpToCsData(f);});}},null);}});$(document).on("click",".fenjiMonitor",function(){var c=$(this).attr("idValue");
var b=true;if(c==null||c.length==0){DialogUtils.error("错误","数据错误，员工工号为空");return;}window.top.jtCtiService._monitor(c,b);});$(document).on("click",".forcebusy",function(){var b=$(this).attr("idValue");
if(b==null||b.length==0){DialogUtils.error("错误","数据错误，员工工号为空");return;}window.top.jtCtiService.forcebusy(b);FormUtils.submit(AgentMap._CONS_.UPDATE_ADN_STATUS_URL+"?status=3&aid="+b,null,function(c){});
});$(document).on("click",".forceidle",function(){var b=$(this).attr("idValue");if(b==null||b.length==0){DialogUtils.error("错误","数据错误，员工工号为空");return;}window.top.jtCtiService.forceidle(b);
FormUtils.submit(AgentMap._CONS_.UPDATE_ADN_STATUS_URL+"?status=0&aid="+b,null,function(c){});});$(document).on("click",".fenjiInterrupt",function(){var c=$(this).attr("idValue");
var b=true;if(c==null||c.length==0){DialogUtils.error("错误","数据错误，员工工号为空");return;}window.top.jtCtiService._interrupt(c,b);});$(document).on("click",".viewPhone",function(){var d=this;
var c=$(this).attr("attr-num");var b={number:c,callback:function(e){$(d).parent().find(".csPhoneSpan").val(e);}};DecryptHelper.decrypt(b);});$(document).on("click",".acditemlist",function(){var b=currentUserAcd;
if(b.indexOf(":")>0){b=currentUserAcd.split(":")[1];}window.top.jtCtiService.acditemlist(b,function(d,c){var e=c.acditemlist;if(c.errno==0){a.layerIndex=layer.open({type:1,title:["队列排队列表","background-color:#2ac1ac;color:white;font-size:1em;"],shade:false,btn:["关闭"],area:["25%","60%"],content:$(".acditemDiv"),scrollbar:false,skin:"my-skin",success:function(f,g){if(e.length>0){var j="<div style='    font-size: 18px; font-weight: bold;'>排队总数："+e.length+"</div><br>";
for(var h=0;h<e.length;h++){j+="<div>手机号码："+e[h].teleno+", 呼入时间："+e[h].dtime+"</div>";}$(".showAcdItemList").empty().append(j);}else{$(".showAcdItemList").empty().append("没有排队数据");
}},yes:function(g,f){layer.close(a.layerIndex);},on:function(g,f){layer.close(a.layerIndex);},cancel:function(){layer.close(a.layerIndex);}});}});});},_loadAgentMap:function(){var a=this;
FormUtils.loadData(AgentMap._CONS_.LIST_DATA_URL,function(d){var f=new StringBuffer();for(var c=0;c<d.length;c++){var e=d[c];var b=a._createRow(e,c+1);
f.append(b);}$("#dataTableBody").empty().append(f.toString());});},_loadEmpToCsData:function(d){var a=this;var f=new StringBuffer();for(var c=0;c<d.length;
c++){var e=d[c];var b=a._createEmpToCsRow(e,c+1);f.append(b);}$("#empToCsBody").empty().append(f.toString());},_createRow:function(c,b){var a=this;var d=new StringBuffer();
if("true"==c.warning){d.append("<tr class='agentRowTr' style='background-color:lemonchiffon' empId='"+c.empId+"'>");}else{if(b%2==0){d.append("<tr class='agentRowTr' style='background-color:aliceblue' empId='"+c.empId+"'>");
}else{d.append("<tr class='agentRowTr' empId='"+c.empId+"'>");}}d.append("<td></td>");d.append("<td>");d.append(c.aid);d.append("</td>");d.append("<td>");
d.append(c.empName);d.append("</td>");d.append("<td>");d.append(c.adn);d.append("</td>");d.append("<td>");if(c.status=="0"){d.append("<span style='color:#1caf9a;'>");
d.append("空闲");}else{if(c.status=="1"){d.append("<span style='color:#23c6c8a8;'>");d.append("通话");}else{if(c.status=="3"){d.append("<span style='color:#ed5565;'>");
d.append("示忙");}else{if(c.status=="5"){d.append("<span style='color:#a5a131b3;'>");d.append("话后处理");}else{if(c.status=="2"){d.append("<span style='color:#ccc;'>");
d.append("请挂机");}else{if(c.status=="4"){d.append("<span style='color:#a5a131b3;'>");d.append("振铃");}else{d.append("<span>");}}}}}}d.append("</span>");d.append("</td>");
d.append("<td>");if(c.begTime){d.append(c.begTime.split(" ")[1]);}d.append("</td>");d.append("<td>");if(c.ringingBegTime){d.append(c.ringingBegTime.split(" ")[1]);
}d.append("</td>");d.append("<td>");if(c.connectTime){d.append(c.connectTime.split(" ")[1]);}d.append("</td>");d.append("<td>");if(c.duration){d.append(DateUtils.toDurationDefaultTime(c.duration));
}else{d.append("");}d.append("</td>");d.append("<td>");if(c.direction=="0"){d.append("呼出");}else{if(c.direction=="1"){d.append("呼入");}}d.append("</td>");
d.append("<td>");d.append("<span class='csPhoneSpan'>"+c.csPhone+"</span>");d.append("</td>");d.append("<td>");if(ResUtils.canShow("agentMap.button.fenjiMonitor")&&c.status=="1"){d.append("<button class='jt-btn-safe fenjiMonitor' type='button' idValue="+c.aid+">监听</button>&nbsp");
}if(ResUtils.canShow("agentMap.button.fenjiInterrupt")&&c.status=="1"){d.append("<button class='jt-btn-error fenjiInterrupt' type='button' idValue="+c.aid+">强插</button>&nbsp");
}if(ResUtils.canShow("agentMap.button.forcebusy")&&c.status=="0"){d.append("<button class='jt-btn-error forcebusy'  type='button' idValue="+c.aid+">强制示忙</button>&nbsp");
}if(ResUtils.canShow("agentMap.button.forceidle")&&("3"==c.status||"5"==c.status)){d.append("<button class='jt-btn-safe forceidle'  type='button' idValue="+c.aid+">强制示闲</button>&nbsp");
}if("true"==c.warning){d.append("<button class='jt-btn-error cancelWarning' empId='"+c.empId+"' type='button'>取消预警</button>&nbsp");}d.append("</td>");d.append("</tr>");
return d.toString();},_createEmpToCsRow:function(c,b){var a=this;var d=new StringBuffer();if(b%2==0){d.append("<tr style='background-color:aliceblue'>");
}else{d.append("<tr>");}d.append("<td></td>");d.append("<td>");d.append(c.csCode+":"+c.csName);d.append("</td>");d.append("<td>");d.append("<input type='number' class='intervalInput' empId='"+c.empId+"' csId='"+c.csId+"'  min='0' value='"+parseInt(c.interval)+"'>");
d.append("</td>");d.append("<td>");if(c.isLocking=="y"){d.append("<span style='color:#ed5565;'>");d.append("禁");d.append("</span>");}d.append("</td>");
d.append("<td>");if(c.isLocking=="y"){if(ResUtils.canShow("agentMap.button.cancelLocking")){d.append("<button class='jt-btn-safe cancelLocking' empId='"+c.empId+"' csId='"+c.csId+"' type='button'>取消锁定</button>&nbsp");
}}else{if(ResUtils.canShow("agentMap.button.locking")){d.append("<button class='jt-btn-error locking' empId='"+c.empId+"' csId='"+c.csId+"' type='button'>锁定</button>&nbsp");
}}d.append("</td>");d.append("</tr>");return d.toString();},_initAgentMapChart:function(){var a=this;if(!a.initMyChart){a.initMyChart=true;a.myChart=echarts.init(document.getElementById("agentMapChart"));
}FormUtils.loadData(AgentMap._CONS_.INIT_AGENTMAP_CHART_URL,function(d){if(!d){return;}var e=d.incomeList;var b=d.dialoutList;var c={title:{text:"坐席通话量",},tooltip:{trigger:"axis",},legend:{x:"center",y:"bottom",data:["呼出量","呼入量"],},dataZoom:[{type:"slider",show:true,start:94,end:100,handleSize:8},{type:"inside",start:94,end:100},{type:"slider",show:true,yAxisIndex:0,filterMode:"empty",width:12,height:"70%",handleSize:8,showDataShadow:false,left:"93%"}],xAxis:[{type:"category",data:d.minuteTime,}],yAxis:[{type:"value",}],series:[{name:"呼入量",type:"line",itemStyle:{normal:{color:"#23c6c8a8",lineStyle:{color:"#23c6c8a8",}}},data:e,},{name:"呼出量",type:"line",smooth:false,itemStyle:{normal:{color:"orange",lineStyle:{color:"orange",type:"dotted"}}},data:b,}]};
if(c&&typeof c==="object"){a.myChart.setOption(c,true);}});},_initAgentStatusChart:function(){var a=this;if(!a.initLineChart){a.initLineChart=true;a.line_chart=echarts.init(document.getElementById("agentStatusChart"));
}FormUtils.loadData(AgentMap._CONS_.INIT_AGENTMAP_STATUS_CHART_URL,function(c){if(!c){return;}var b=[parseFloat((c.idle?c.idle:0)/c.count).toFixed(2)*100,parseFloat((c.calling?c.calling:0)/c.count).toFixed(2)*100,parseFloat((c.busy?c.busy:0)/c.count).toFixed(2)*100,parseFloat((c.callEnd?c.callEnd:0)/c.count).toFixed(2)*100,parseFloat((c.hand?c.hand:0)/c.count).toFixed(2)*100];
option={title:{text:"坐席状态统计",},tooltip:{trigger:"axis"},legend:{data:["空闲","通话","示忙","话后处理","请挂机"],},xAxis:[{type:"category",data:["空闲","通话","示忙","话后处理","请挂机"],}],yAxis:[{type:"value",axisLabel:{formatter:"{value} %"}}],series:[{name:"百分比",type:"bar",data:b,itemStyle:{normal:{color:function(e){var d=["#1caf9a","#23c6c8a8","#ed5565","#a5a131b3","#ccc"];
return d[e.dataIndex];}}}},]};a.line_chart.setOption(option);a.line_chart.resize();});},};