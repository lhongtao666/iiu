$(function(){var a=new InsideLineSheetRecord();a.init();});function InsideLineSheetRecord(){this.hadInit=false;}InsideLineSheetRecord._CONS_={LIST_DATA_URL:reqType?ctx+"/gl/cti/tRKSheetRecord/listDataForRecordByReqType.htm?reqType="+reqType+"&type="+type+"&positionType=record,dept_manager":ctx+"/gl/cti/tRKSheetRecord/listDataForRecord.htm?reqType="+reqType+"&type="+type+"&positionType=record,dept_manager",EXPORT_DATA_URL:ctx+"/gl/cti/tRKSheetRecord/exportRecord.htm?type="+type+"&positionType=record,dept_manager",HALF_ASYN_EXPORT_DATA_URL:ctx+"/gl/cti/tRKSheetRecord/halfAsynExportRecord.htm?type="+type+"&positionType=record,dept_manager",GRID:"#insideLineSheetRecordGrid",PAGER:"#insideLineSheetRecordPager"};
InsideLineSheetRecord.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;new Switchery(document.querySelector(".js-switch"),{size:"small"});
this._initToolbarSelect();this._initToolbar();this._initJqgrid(a);this._bindEventHander();this._hideNotGrantBtn();this._initEmployeeSelect("");this._initBelongEmployeeSelect("");
this._locateToGlHelp();}},_initToolbarSelect:function(){if("y"==markCtiRecord&&$("#markSearchSelect").length){CateUtils.getOptions({typeKey:"system",pKey:"trksheetrecordMarkType",container:"markSearchSelect"});
$(document).on("change","#markSearchSelect",function(){var a=$(this).val();if(!a){$tr.find("#markDesSearchSelect").empty();}else{CateUtils.getOptions({typeKey:"system",pKey:a,container:"markDesSearchSelect"});
}});}if(versionType=="finance"){CateUtils.getOptions({typeKey:"system",pKey:"CsBizTypes",container:"bizTypeSearch"});}ChannelUtils.getOptions({container:"srcsSearchSelect",caption:"全部",emptyOptions:"null"});
this._prodSearch();},_prodSearch:function(a){$("#searchProd").bsSuggest("destroy");var b=this;var e=$("#productNameSearchSelect").width()+"px";var c="entity";
var f="n";var d="n";$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+f+"&storeId="+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(g){b.searchProds=g.value;
return g;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(h,g){b.searchProds=g.value;
}).on("onSetSelectValue",function(j,g){for(var h=0;h<b.searchProds.length;h++){if(b.searchProds[h].skuId==g.id){b.currentProd=b.searchProds[h];break;}}$("#searchProd").val(b.currentProd.prodName);
}).on("onUnsetSelectValue",function(g){b.currentProd={};});},_initToolbar:function(){var a='<div class="form-group button-group"><div class="col-sm-6"> <div class="col-sm-2"></div>   <div class="col-sm-10">        <button type="button" class="btn btn-sm   btn-primary insideLineSheetRecordSearch">搜索</button>    </div></div>      </div>';
if("limitCallinBno"==reqType){$("#insideLineSheetRecordSearchForm .form-group:not(.basic-group)").remove();$(".not-basic-group-div").remove();$("#insideLineSheetRecordSearchForm").append(a);
}else{if("adn_error"==reqType){$("#insideLineSheetRecordSearchForm .form-group:not(.basic-group)").remove();$(".not-basic-group-div").remove();$("#insideLineSheetRecordSearchForm").append(a);
}else{if("recordIdParams"==reqType||"adnStaticReq"==reqType||"ctiReport"==reqType){$(".trkSheetRecordToolbarRecord").remove();}}}},_locateToGlHelp:function(){var a="glHelp.dataAudit.insideLineSheetRecord";
glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("trkSheetRecord.button.assign")){$("button.assignBtn").hide();}if(!ResUtils.canShow("trkSheetRecord.button.exportRecord")){$("button.exportRecord").hide();
}if(!ResUtils.canShow("trkSheetRecord.button.viewWebCall")){$("button.viewWebCallSearch").hide();}},_initEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#agentId").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].aid+"'>"+c[b].aid+":"+c[b].name+"</option>");
}}$("#agentId").append(d.toString()).select2();},null,true);},_initBelongEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#belongEmployeeIds").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");d.append("<option value='"+currentUserId+"'>"+currentUserAid+":"+currentUserName+"</option>");
if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}}$("#belongEmployeeIds").append(d.toString()).select2();
},null,true);},_bindEventHander:function(){var a=this;callRecordOperate.init();$("#orgName").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$("#orgId").val(),container:"orgName",fn:function(d){a._initEmployeeSelect(d);
$("#orgId").val(d);}});});$("#belongOrgName").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$("#belongOrgId").val(),container:"belongOrgName",fn:function(d){a._initBelongEmployeeSelect(d);
$("#belongOrgId").val(d);}});});var b=ctx+"/crm/cs/csEntity/detail.htm";var c=ctx+"/crm/cs/csEntity/getCsByCode.htm";$(document).on("click",".csEntityDetailBtn",function(){var d=$(this).attr("csCode");
var e=$(this).attr("csNameVal");FormUtils.submit(c,{csCode:d},function(f){if(!$.isEmptyObject(f)){var g=f.id;JTTabUtils.addOrRefreshTab(b+"?csId="+g+"&type=callRecord","客户["+e+"]明细");
}else{DialogUtils.error("错误","没有找到客户,请通过客户查询找该客户");}});});$(".list_wrapper").on("click",".insideLineSheetRecordSearch",function(){if(!$('input[name="startTime"]').val()){var e=new Date();
var g=e.currentDate();$('input[name="startTime"]').val(g);}var h=$("#agentId").val();var d="";if(h){for(var f=0;f<h.length;f++){if(h[f]){d+=h[f]+",";}}}if(d){d=d.substring(0,(d.length)-1);
}var j=$(this).closest("form").serialize();j+="&agentId="+d;a.reloadJqgrid(j);});$("#insideLineSheetRecordSearchForm").on("keypress",function(d){if(d.keyCode=="13"){$(".insideLineSheetRecordSearch").trigger("click");
}});$("button.viewWebCallSearch").on("click",function(){if(!$('input[name="startTime"]').val()){var e=new Date();var g=e.currentDate();$('input[name="startTime"]').val(g);
}var h=$("#agentId").val();var d="";if(h){for(var f=0;f<h.length;f++){if(h[f]){d+=h[f]+",";}}}if(d){d=d.substring(0,(d.length)-1);}var j=$(this).closest("form").serialize();
j+="&agentId="+d;j+="&uud=webCall";a.reloadJqgrid(j);});$("body").on("click",".exportRecord",function(){if(!$('input[name="startTime"]').val()){var e=new Date();
var f=e.currentDate();$('input[name="startTime"]').val(f);}var d=$(InsideLineSheetRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");var g=$(this).closest("form").serialize()+"&ids="+d;
FormUtils.submit(InsideLineSheetRecord._CONS_.EXPORT_DATA_URL,g,function(h){if(h.success){DialogUtils.success("成功",h.msg);}else{DialogUtils.error("失败",h.msg);
}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("click",".halfAsynExportRecord",function(){if(!$('input[name="startTime"]').val()){var e=new Date();
var f=e.currentDate();$('input[name="startTime"]').val(f);}var d=$(InsideLineSheetRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");var g=$(this).closest("form").serialize()+"&ids="+d;
FormUtils.submit(InsideLineSheetRecord._CONS_.EXPORT_DATA_URL,g,function(h){if(h.success){DialogUtils.success("成功",h.msg);}else{DialogUtils.error("失败",h.msg);
}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("body").on("click",".assignBtn",function(){var f=$(InsideLineSheetRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(f&&f.length){var e=[];for(var h=0;h<f.length;h++){var k=f[h];var j=$(InsideLineSheetRecord._CONS_.GRID).jqGrid("getRowData",k);if(j.csId.trim().indexOf("未注册")!=-1){if(j.encryptNumber&&e.indexOf(j.encryptNumber)<0){e.push(j.encryptNumber);
}}}if(e.length){var d=new CsAssign(e,"csPhone");d.init();}else{DialogUtils.error("错误","没有可供分配的号码");}}else{var g="start="+$("input[name='startTime']").val();
if($("input[name='endTime']").val()){g+="&end="+$("input[name='endTime']").val();}else{g+="&end="+new Date().current();}var d=new CsAssign([],"clear",g);
d.init();}});$("body").on("click",".csEntityInBtn",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum="+$(this).attr("encryptNumberVal")+"&encryptInNumber="+$(this).attr("encryptInNumberVal")+"&inNum="+$(this).attr("inNumVal"),"新客户");
});},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(InsideLineSheetRecord._CONS_.GRID,a);},_initJqgrid:function(g){var c=this;if(g==null||typeof g==undefined){g={};
}var b=new Date();var e=b.currentDate()+" 00:00:00";$('input[name="startTime"]').val(e);var h="n";$("input[name=wipeRepeat]").val([h]);var f=["客户ID","客户号码","隐藏号码","客户归属","地区","方向","类型","分机","员工工号","部门","性质","来源(外显)","主叫","被叫","开始时间","通话时长","呼叫时长","标识","评价","录音"];
var d=[{name:"csCode",align:"center",index:"cs_code_",sortable:true,width:120,formatter:function(j,l,i){if(j){var k=j+":"+i.csName;if($(window).width()<1024){k=j+"<br>"+i.csName;
}return"<a csCode='"+j+"' href='javascript: void(0);' csIdVal='"+i.csId+"' csNameVal='"+i.csName+"' class='csEntityDetailBtn'>"+k+"</a>";}else{return"";
}}},{name:"csPhone",align:"center",sortable:false,width:140,formatter:function(m,j,l){if(!l.csId){var k=null;var i=l.source;if(l.direction==0){k=l.encryptAno;
}else{k=l.encryptBno;}if(reqType&&reqType=="recordIdParams"){return"<span title='创建客户' class='' href='javascript: void(0);' encryptInNumberVal='"+k+"'  encryptNumberVal='"+l.encryptNumber+"'>"+m+"</span>";
}else{return"<a inNumVal='"+i+"' title='创建客户' class='csEntityInBtn' href='javascript: void(0);' encryptInNumberVal='"+k+"'  encryptNumberVal='"+l.encryptNumber+"'>"+m+"</a>";
}}else{return m;}}},{name:"encryptNumber",align:"center",sortable:false,width:140,hidden:true},{name:"belongEmployeeAid",align:"center",index:"belongEmployeeAid",width:120,sortable:false,formatter:function(i){if($(window).width()<1024&&i.indexOf(":")!=-1){return i.split(":")[0]+"<br>"+i.split(":")[1];
}else{return i;}}},{name:"addr",align:"center",index:"addr",sortable:false,width:120},{name:"direction",align:"center",index:"Direction",width:60,formatter:function(i){if(i==0){return'<img style="display: inline; height:35px;" src="/t9-ecm/img/jt/callout.png?dm=_mm">';
}else{if(i==1){return'<img style="display: inline; height:35px;" src="/t9-ecm/img/jt/callin.png?dm=_mm">';}}}},{name:"recfile",align:"center",index:"IsRouteAgent",width:60,formatter:function(j,i,k){if(j){return"<span class='text text-primary'>已接</span>";
}else{return"<span class='text text-danger'>未接</span>";}}},{name:"adn",align:"center",sortable:false,width:80},{name:"employeeAid",align:"center",sortable:false,width:140,formatter:function(j,i,k){if($(window).width()<1024){return j+"<br>"+k.employeeName;
}else{return j+":"+k.employeeName;}}},{name:"groupName",align:"center",sortable:false,width:120},{name:"csId",sortable:false,width:60,formatter:function(i){if(i&&i.trim()){return"<span class='text text-primary'>已注册</span>";
}else{return"<span class='text text-danger'>未注册</span>";}}},{name:"source",align:"center",sortable:true,width:120,formatter:function(k,j,i){if(k){return i.source;
}else{return"无";}}},{name:"ano",hidden:true,align:"center",sortable:false,width:120,formatter:function(k,j,i){if(i.direction==0){return i.source;}else{if(i.direction==1){return i.csPhone;
}}}},{name:"bno",hidden:true,align:"center",sortable:false,width:120,formatter:function(k,j,i){if(i.direction==0){return i.csPhone;}else{if(i.direction==1){return i.source;
}}}},{name:"begtime",align:"center",index:"BegTime",width:100,formatter:function(i){return DateUtils.mini2Time(i);}},{name:"duration",align:"center",sortable:true,width:80,formatter:function(k,j,i){if(i.recfile){return DateUtils.toChineseTime(k);
}else{return"";}}},{name:"ringduration",align:"center",sortable:false,width:80,formatter:function(k,j,i){if(!i.recfile){return DateUtils.toChineseTime(i.duration);
}else{return"";}}},{name:"mark",align:"center",sortable:false,width:120,hidden:markCtiRecord!="y",formatter:function(k,i,j){if(k){return'<div style="width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis">'+k+":"+j.markDes+"</div>";
}else{return"";}},},{name:"uud",align:"center",sortable:false,width:80,hidden:showPJ!="show",formatter:function(k,j,i){if(!k){return"无";}if(k.indexOf("PJ:1")!=-1){return"满意";
}else{if(k.indexOf("PJ:2")!=-1){return"一般";}else{if(k.indexOf("PJ:3")!=-1){return"不满意";}}}return"无";}},{name:"recfile",align:"center",width:180,formatter:function(l,k,i){if(l){var j=c._generateCode();
var m=new StringBuffer();if(ResUtils.canShow("trkSheetRecord.button.listen")){m.append("<button title='调取录音' uniqueCode='"+j+"'   id-value ='"+i.id+"'  recfileVal='"+l+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left' ></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordTranslate")){m.append("<button title='录音翻译' uniqueCode='"+j+"' id-value ='"+i.id+"' recfileVal='"+l+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.download")){m.append("<button title='下载录音' uniqueCode='"+j+"'   id-value ='"+i.id+"'  recfileVal='"+l+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.delete")){m.append("<button title='删除录音' uniqueCode='"+j+"'  id-value ='"+i.id+"'  recfileVal='"+l+"' class='deleteBtn btn btn-xs btn-danger'><i class='fa fa-remove'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordMark")){m.append("<button title='通话标识' uniqueCode='"+j+"' id-value ='"+i.id+"' recfileVal='"+l+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordRecomm")){m.append("<button title='录音推荐' uniqueCode='"+j+"' id-value ='"+i.id+"' recfileVal='"+l+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordHi")){m.append("<button title='操作记录' uniqueCode='"+j+"' id-value ='"+i.id+"' recfileVal='"+l+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}return m.toString();}else{return"";}}}];var a=null;if(reqType&&reqType=="recordIdParams"){a=InsideLineSheetRecord._CONS_.LIST_DATA_URL+"&recordIds="+recordIds;
}else{if(reqType&&(reqType=="adnStaticReq"||reqType=="ctiReport")){a=InsideLineSheetRecord._CONS_.LIST_DATA_URL+"&"+adnStaticReqParamStr;}else{a=InsideLineSheetRecord._CONS_.LIST_DATA_URL;
}}if(versionType=="finance"){a+="&sidx=cs_code_&sord=asc";}$(InsideLineSheetRecord._CONS_.GRID).JTJqgrid({url:a,pager:InsideLineSheetRecord._CONS_.PAGER,postData:{startTime:e,wipeRepeat:h},colNames:f,colModel:d});
}};