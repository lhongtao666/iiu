$(function(){var a=new SystemImage();a.init();});function SystemImage(){this.userId=userId;this.albumId="";}SystemImage._CONS_={TYPE_KEY:"system",CATE_P_KEY:"default-album",LOAD_ALBUM_DATA_URL:ctx+"/gl/image/image/listAlbum.htm",LOAD_IMAGE_DATA_URL:ctx+"/gl/image/image/listImage.htm",DELETE_URL:ctx+"/gl/image/image/delete.htm",DELETE_ALBUM_URL:ctx+"/gl/image/image/deleteAlbum.htm",SAVE_ADD_URL:ctx+"/gl/image/image/saveAdd.htm",PW_STR:"42385A79697676502F512F33454F58333337794472513D3D",UPLOAD_PARAMS:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":"image/*","fileSingleSizeLimit":1*1024*1024*6,"fileNumLimit":300,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
SystemImage.prototype={init:function(){this._loadAlbumTree();this._bindEventHandler();$("#imageContainer").show();$("#uploadImageContainer").hide();$("#albumFormContainer").hide();
this._locateToGlHelp();},_locateToGlHelp:function(){if(this.userId){var a="glHelp.tools.systemFile";}else{var a="glHelp.systemconfig.systemFile";}glHelpUtil.init(a);
},_loadAlbumTree:function(){var a=this;var c="";if(this.userId){c="user";$("[href=#systemImageTab]").text("我的图片");$("[href=#systemFileTab]").text("我的附件");
}else{c="system";}var b={treeId:"albumTree",cateTypeKey:"system",rootKey:"default-album",userId:this.userId,disabledRoot:true,type:c,contextMenu:{upload:{isShow:true,title:"上传图片",clazz:"uploadImageBtn"},add:{isShow:true,title:"添加相册",clickFn:function(d){},clazz:"addAlbumBtn"},update:{isShow:true,title:"更新相册",clickFn:function(){},clazz:"updateAlbumBtn"},del:{isShow:true,title:"删除相册",clickFn:function(d){DialogUtils.confirm(function(){FormUtils.del(SystemImage._CONS_.DELETE_ALBUM_URL,d.id,function(f){if(f.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$.fn.zTree.getZTreeObj("albumTree").removeNode(d);var e=$.fn.zTree.getZTreeObj("albumTree");e.reAsyncChildNodes(null,"refresh");}else{DialogUtils.error(msgCode.FAIL,f.msg);
}});});},clazz:"deleteAlbumBtn"},},saveFn:function(d){a._selectAlbum(d.id);},onClick:function(d){a._selectAlbum(d.id);}};ZtreeUtils.init(b);},_selectAlbum:function(a){this.albumId=a;
$("button.uploadImageBtn").show();$("button.cancelUploadImageBtn").hide();$("button.cancelDeleteBatchBtn").trigger("click");this._loadImage();},_loadAlbum:function(){var a=this;
FormUtils.loadData(SystemImage._CONS_.LOAD_ALBUM_DATA_URL+"?userId="+this.userId,function(b){a._createAlbumDiv(b);});},_loadImage:function(){var a=this;
var c=false;var b=false;if(!ResUtils.canShow("sys.delete.img")){c=true;}FormUtils.loadData(SystemImage._CONS_.LOAD_IMAGE_DATA_URL+"?cateId="+this.albumId,function(d){var e=new StringBuffer();
if(d!=null&&d.length>0){$("#imageContainer").show();$("#uploadImageContainer").hide();$("#imageContainer").empty().append(ImageUtils.createImageDivStr(d,null,true,c,b));
}else{$("#imageContainer").show();$("#uploadImageContainer").hide();$("#imageContainer").empty();}});},_bindEventHandler:function(){var a=this;$(".systemFileLi").on("click",function(){var b=new SystemFile();
b.init();});$(".systemImageLi").on("click",function(){a._loadAlbumTree();});$(".batchManageBtn").on("click",function(){a._status="selecting";$("button.batchManageBtn").hide();
$("button.deleteBatchBtn").show();$("button.cancelDeleteBatchBtn").show();$("img.deleteImage").hide();ImageUtils.offEventHander();});$("#imageContainer").on("click",".file",function(){if(a._status=="selecting"){var b=$(this).find("img.deleteImage");
if(b.is(":visible")){b.hide();}else{b.attr("src",ctx+"/img/jt/success.png");b.show();}}});$("button.deleteBatchBtn").on("click",function(){var c=[];$("img.deleteImage").each(function(){if($(this).is(":visible")&&$(this).attr("src").endWith("success.png")){var d=$(this).attr("idVal");
c.push(d);}});if(c&&c.length){var b={title:"确定要删除"+c.length+"个图片吗",yesFunc:function(){FormUtils.submit(SystemImage._CONS_.DELETE_URL,{ids:c},function(d){DialogUtils.success(msgCode.SUCCESS,"删除成功");
a._loadImage();$("button.cancelDeleteBatchBtn").trigger("click");});}};DialogUtils.confirmWithOptions(b);}});$("button.cancelDeleteBatchBtn").on("click",function(){if(!ResUtils.canShow("sys.delete.img")){$("button.batchManageBtn").hide();
}else{$("button.batchManageBtn").show();}$("button.deleteBatchBtn").hide();$("button.cancelDeleteBatchBtn").hide();$("img.deleteImage").each(function(){$(this).attr("src",ctx+"/img/jt/delete.png");
}).show();a._status="";ImageUtils.bindEventHandler(function(b){FormUtils.submit(SystemImage._CONS_.DELETE_URL,{ids:b},function(c){DialogUtils.success(msgCode.SUCCESS,"删除成功");
});});});ImageUtils.bindEventHandler(function(b){FormUtils.submit(SystemImage._CONS_.DELETE_URL,{ids:b},function(c){DialogUtils.success(msgCode.SUCCESS,"删除成功");
});});$("button.uploadImageBtn").on("click",function(){if(a.albumId){$("#imageContainer").hide();$("#uploadImageContainer").show();a._bindWebuploader();
$("button.uploadImageBtn").hide();$("button.cancelUploadImageBtn").show();$("button.batchManageBtn").hide();$("button.deleteBatchBtn").hide();$("button.cancelDeleteBatchBtn").hide();
}else{DialogUtils.error(msgCode.SUCCESS,"请添加相册后再上传图片");}});$("button.cancelUploadImageBtn").on("click",function(){$("#imageContainer").show();$("#uploadImageContainer").hide();
$("button.uploadImageBtn").show();$("button.cancelUploadImageBtn").hide();$("button.cancelDeleteBatchBtn").trigger("click");});$("#imageContainer").on("mouseenter",".file-box",function(){if(a._status!="selecting"){$(this).addClass("animated "+"pulse");
}});$("#imageContainer").on("mouseleave",".file-box",function(){if(a._status!="selecting"){var b=$(this);window.setTimeout(function(){b.removeClass("animated "+"pulse");
},2000);}});$(document).on("click",".systemImageLi",function(){if(!ResUtils.canShow("sys.delete.img")){$("button.batchManageBtn").hide();}else{$("button.batchManageBtn").show();
}a._loadImage();});},_bindWebuploader:function(){var c=this;var b=[];var d=0;function e(i,h){if(h.flag){var j={height:h.height,width:h.width,path:h.localPath,name:h.fileName,byteCount:h.byteCount,isWater:h.water,isZoom:h.zoom,saveType:"relative",cateId:c.albumId,sort:d++};
b.push(j);}}function a(h,i){alert("上传"+h.name+"失败，原因是"+i);}function f(){$("button.cancelUploadImageBtn").trigger("click");var i=false;var h=false;if(!ResUtils.canShow("sys.delete.img")){i=true;
}FormUtils.submit(SystemImage._CONS_.SAVE_ADD_URL,$.param({imageJson:JSON.stringify(b)}),function(j){("#imageContainer").empty().append(ImageUtils.createImageDivStr(j,null,true,i,h));
},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}var g=new JTWebUploader({config:SystemImage._CONS_.UPLOAD_PARAMS,container:"imageUploader",success:e,error:a,caption:"支持上传：gif,jpg,jpeg,bmp,png格式文件，单个文件最大为6MB",finish:f});
g.init();},_createImageStr:function(a){if(a&&a.length>0){var f=new StringBuffer();for(var c=0;c<a.length;c++){fileurl=ImageUtils.getUrl(a[c],"mm");var b=a[c].name;
var e=a[c].createTime;var d=a[c].id;f.append("<div class='file-box'>").append("<div class='file' urlVal='"+fileurl+"' nameVal='"+b+"'>").append("<img idVal='").append(d).append("' class='deleteImage' src='").append(ctx).append("/img/jt/delete.png' style='display: block; cursor: pointer; position: absolute; right: 0px; width: 40px; height: 40px;' alt='删除按钮'/>").append("<a nameVal='").append(b).append("' href='javascript:void(0);'>").append("<span class='corner'></span>").append("<div class='icon'>").append("<img style='width:180px; height:100px;' src='"+fileurl+"'>").append("</div>").append("<div class='file-name' style='padding-top: 10px; padding-bottom:10px; padding-left:3px; padding-right: 3px;'>").append("<span style='display: inline-block; overflow: hidden; height:20px; '>").append(b).append("</span>").append("<br>").append("<small>添加时间：").append(e).append("</small>").append("</div>").append("</a>").append("</div>").append("</div>");
}return f.toString();}}};