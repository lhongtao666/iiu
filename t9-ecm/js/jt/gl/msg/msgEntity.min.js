$(function(){var a=new MsgEntity();a.init();});function MsgEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}MsgEntity._CONS_={EDIT_URL:ctx+"/gl/msg/msgEntity/edit.htm",DETAIL_URL:ctx+"/gl/msg/msgEntity/detail.htm",DELETE_URL:ctx+"/gl/msg/msgEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/msg/msgEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/msg/msgEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/msg/msgEntity/listData.htm",EDIT_FORM_ID:"msgEntityForm",GRID:"#msgEntityGrid",PAGER:"#msgEntityPager"};
MsgEntity.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.operations.msgEntity";glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("msgEntity.button.detail")){$(".msgEntityDetail").hide();
}if(!ResUtils.canShow("msgEntity.button.add")){$(".msgEntityAdd").hide();}if(!ResUtils.canShow("msgEntity.button.edit")){$(".msgEntityEdit").hide();}if(!ResUtils.canShow("msgEntity.button.delete")){$(".msgEntityDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(MsgEntity._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(MsgEntity._CONS_.EDIT_FORM_ID);SummernoteUtils.setCode("","summernote");SummernoteUtils.destroy("summernote");if(c){a.reloadJqgrid();
}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){$(".saveBtn").show();$(".saveDraftBtn").show();SummernoteUtils.init({},"summernote");
$("#hiddenRecTypeDiv").css("display","none");$("#hiddenRecTypeBtn").css("display","block");$("#hiddenRecTypeInput").css("display","block");this._reInitChooser();
this._showFormWrapper();},_reInitChooser:function(){$("#selectReceiveType").empty();$("#selectReceiveType").chosen("destroy");$("#selectReceiveType").chosen();
$("#selectReceiveType_chosen").css("width","600px");},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a,true);},_detail:function(a){this._showFormWrapper();
this._loadData(a);$(".saveBtn").hide();$(".saveDraftBtn").hide();$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(MsgEntity._CONS_.EDIT_FORM_ID);
},_loadData:function(c,b){var a=this;FormUtils.loadData(MsgEntity._CONS_.EDIT_URL+"?id="+c,function(d){$("input[name=id]").val(d.id);$("input[name=title]").val(d.title);
$("input[name=content]").val(d.content);$("input[name=type]").val(d.type);$("input[name=sender]").val(d.sender);$("input[name=recType]").val(d.recType);
$("input[name=recId]").val(d.recId);$("input[name=recIds]").val(d.recIds);$("input[name=status]").val(d.status);$("input[name=createTime]").val(d.createTime);
$("input[name='startTime']").val(d.startTime);$("input[name='endTime']").val(d.endTime);$("select[name='level']").val(d.level);$("select[name='recType']").val(d.recType);
if(d.recType!="admin"){$("#hiddenRecTypeDiv").css("display","block");$("#hiddenRecTypeBtn").css("display","none");a._loadSelectData(d.recType,d.recNames);
}else{$("#hiddenRecTypeDiv").css("display","none");a._loadSelectData(d.recType,d.recNames);}SummernoteUtils.init({},"summernote");SummernoteUtils.setCode(d.content,"summernote");
if(d.status=="send"){FormUtils.disableForm(MsgEntity._CONS_.EDIT_FORM_ID);$(".saveBtn").hide();$(".saveDraftBtn").hide();}else{if(b&&d.status=="draft"){$(".saveDraftBtn").show();
}}});},_loadSelectData:function(d,c){var a=this;var e=$("#selectReceiveType");if(d=="groups"||d=="users"){var f=c.split(",");var g=new StringBuffer();for(var b=0;
b<f.length-1;b++){g.append("<option selected>"+f[b]+"</option>");}e.empty().append(g.toString()).chosen("destroy").chosen();$("#selectReceiveType_chosen").css("width","600px");
}},_save:function(d){var h=this;var a=$("#id").val();var g=null;if(a!=null&&a!=""){g=MsgEntity._CONS_.SAVE_EDIT_URL;}else{g=MsgEntity._CONS_.SAVE_ADD_URL;
}var b=SummernoteUtils.getCode("summernote");var f=decodeURIComponent(b);if(b&&f.length>8000&&!$("#msgEntityForm").valid()){$(".note-editor").addClass("validate_input_error");
DialogUtils.error(msgCode.ERROR,"内容超过最大字符数");return;}if($("#msgEntityForm").valid()){if(d=="send"){ButtonUtils.disableBtn("saveBtn");}else{ButtonUtils.disableBtn("saveDraftBtn");
}var e=$("select[name=receiveTypeInput]").val();var i="";if(e){i=e.join(",");}var c=$("#"+MsgEntity._CONS_.EDIT_FORM_ID).serialize();c+="&status="+d;c+="&content="+SummernoteUtils.getCode("summernote");
c+="&type=notice";c+="&recConfig="+i;FormUtils.submit(g,c,function(j){if(d=="send"){ButtonUtils.enableBtn("saveBtn");}else{ButtonUtils.enableBtn("saveDraftBtn");
}if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}h.isEdit=false;h.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},function(){if(d=="send"){ButtonUtils.enableBtn("saveBtn");}else{ButtonUtils.enableBtn("saveDraftBtn");
}DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(MsgEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("focus",".note-editor",function(){$(".note-editor").removeClass("validate_input_error");});$(document).on("blur",".note-editor",function(){var c=SummernoteUtils.getCode("summernote");
var b=decodeURIComponent(c);if(c&&b.length>8000){$(".note-editor").addClass("validate_input_error");}});$(document).on("click",".saveBtn",function(){a._save("send");
});$(document).on("click",".saveDraftBtn",function(){a._save("draft");});$("#"+MsgEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+MsgEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+MsgEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".msgEntitySearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$("#msgEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".msgEntitySearch").trigger("click");
}});$("body").on("click",".msgEntityAdd",function(){a._add();});$("body").on("change","#recevieType",function(){var b=$(this).val();if("users"==b||"groups"==b){$("#hiddenRecTypeDiv").css("display","block");
a._reInitChooser();}else{if("admin"==b||""==b){$("#hiddenRecTypeDiv").css("display","none");}}});$("body").on("click",".selectRecType",function(){var e=$("#recevieType").val();
var b=$("#selectReceiveType");if("users"==e){var c=0;if(ResUtils.canShow("employeeSelector.button.msg")){c:1;}var f={isShowAllGroup:c,grantType:"/msg/",isMultiple:1,callBack:function(j){if(j!=null||j.length<1){var h=""+b.val();
b.children("option").each(function(){if(h.indexOf($(this).val()+",")==-1&&h.indexOf(","+$(this).val()+",")==-1&&h.indexOf(","+$(this).val())==-1&&$(this).val()!=h){(this).remove();
}});var k=new StringBuffer();for(var g=0;g<j.length;g++){if(h.indexOf(j[g].id+",")==-1&&h.indexOf(","+j[g].id+",")==-1&&h.indexOf(","+j[g].id)==-1&&j[g].id!=h){k.append("<option value='"+j[g].id+"' selected>"+j[g].name+"</option>");
}}b.append(k.toString());b.trigger("chosen:updated");b.next().removeClass("validate_input_error");}}};var d=new EmployeesSelect();d.init(f);}else{if("groups"==e){var f={isMultiple:1,nolimit:true,selectedGroupId:$("#selectReceiveType").val(),fn:function(j){if(j.length>0){var h=""+b.val();
b.children("option").each(function(){if(h.indexOf($(this).val()+",")==-1&&h.indexOf(","+$(this).val()+",")==-1&&h.indexOf(","+$(this).val())==-1&&$(this).val()!=h){(this).remove();
}});var k=new StringBuffer();for(var g=0;g<j.length;g++){if(h.indexOf(j[g].id+",")==-1&&h.indexOf(","+j[g].id+",")==-1&&h.indexOf(","+j[g].id)==-1&&j[g].id!=h){k.append("<option value='"+j[g].id+"' selected>"+j[g].name+"</option>");
}}b.append(k.toString());b.trigger("chosen:updated");b.next().removeClass("validate_input_error");}}};GroupUtils.selectGroup(f);}}});$("body").on("click",".msgEntityEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(MsgEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}var d=$(MsgEntity._CONS_.GRID).jqGrid("getRowData",b);
var c=d["status"];if(c.indexOf("已发送")>=0){DialogUtils.error(msgCode.error,"该公告已发送，不可编辑!");return;}a._edit(b);});$("body").on("click",".msgEntityDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(MsgEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".msgEntityDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(MsgEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});},_bindFormValidation:function(){var a={rules:{title:{required:true,maxlength:["64"],},startTime:{required:true,date:true},endTime:{required:true,date:true},level:{required:true},recType:{required:true}},messages:{}};
FormUtils.bindFormValidation(MsgEntity._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){if(a&&jQuery.type(a)=="string"){a+="&Q__S__EQ__type_=notice";}else{a={};
a.Q__S__EQ__type_="notice";}JTJqgridUtils.reloadJqgrid(MsgEntity._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];a.push({switchCol:{colName:"status",colVals:["send","draft"],colLables:[["删除","明细"],["删除","编辑"]],btnClasses:[["btn btn-danger msgEntityDel","btn btn-primary msgEntityDetail"],["btn btn-danger msgEntityDel","btn btn-primary msgEntityEdit"]],iconClasses:[["fa fa-remove","fa fa-list"],["fa fa-remove","fa fa-edit"]]}});
return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(MsgEntity._CONS_.GRID).JTJqgrid({url:MsgEntity._CONS_.LIST_DATA_URL,pager:MsgEntity._CONS_.PAGER,postData:{Q__S__EQ__type_:"notice"},colNames:["标题","发送者","接收类型","开始时间","结束时间","等级","状态","创建时间","操作"],colModel:[{name:"title",index:"title_",width:200,formatter:function(d,b,c){var e=new StringBuffer();
e.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");e.append("<a idVal='"+c.id+"' class='msgEntityDetail' href='javascript:void(0);'>"+d+"</a>");
e.append("</div>");return e.toString();}},{name:"senderName",index:"sender_",width:100},{name:"recType",index:"rec_type_",width:120,formatter:function(b){if(b=="admin"){return"全体用户";
}else{if(b=="user"){return"指定用户";}else{if(b=="users"){return"指定用户";}else{if(b=="groups"){return"指定部门";}}}}}},{name:"startTime",index:"start_time_",width:100,formatter:function(b){return DateUtils.miniTime(b);
}},{name:"endTime",index:"end_time_",width:100,formatter:function(b){return DateUtils.miniTime(b);}},{name:"level",index:"level_",width:80,formatter:function(b){if(b==0){return"提示";
}else{if(b==1){return"普通";}else{if(b==2){return"重要";}else{if(b==3){return"非常重要";}else{if(b==4){return"非常重要";}else{if(b==5){return"非常重要";}else{return"";
}}}}}}}},{name:"status",index:"status_",width:80,formatter:function(b){if(b=="send"){return"已发送";}else{if(b=="draft"){return"草稿";}}}},{name:"createTime",index:"create_time_",width:100,classes:"autoHideCol",formatter:function(b){return DateUtils.miniTime(b);
}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});}};