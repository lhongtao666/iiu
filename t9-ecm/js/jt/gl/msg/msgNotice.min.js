$(function(){var a=new MsgNotice();a.init();});function MsgNotice(){this.hadInit=false;this.currentMsgItem;this.totalMsgItem;this.rowItem=10;this.msgData;
}MsgNotice._CONS_={GET_TODAY_MSG_URL:ctx+"/gl/msg/msgEntity/listToDayMsgData.htm",};MsgNotice.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;
a._bindEventHanlder();a._getData("");}},_bindEventHanlder:function(){var a=this;$(document).on("click",".allBtn",function(){a._getData("");$(".allBtn").attr("disabled",true);
$(".noticeBtn").attr("disabled",false);$(".missBtn").attr("disabled",false);$(".csCountBtn").attr("disabled",false);$(".otherBtn").attr("disabled",false);
});$(document).on("click",".noticeBtn",function(){a._getData("notice");$(".allBtn").attr("disabled",false);$(".noticeBtn").attr("disabled",true);$(".missBtn").attr("disabled",false);
$(".csCountBtn").attr("disabled",false);$(".otherBtn").attr("disabled",false);});$(document).on("click",".missBtn",function(){a._getData("miss");$(".allBtn").attr("disabled",false);
$(".noticeBtn").attr("disabled",false);$(".missBtn").attr("disabled",true);$(".csCountBtn").attr("disabled",false);$(".otherBtn").attr("disabled",false);
});$(document).on("click",".csCountBtn",function(){a._getData("assign");$(".allBtn").attr("disabled",false);$(".noticeBtn").attr("disabled",false);$(".missBtn").attr("disabled",false);
$(".csCountBtn").attr("disabled",true);$(".otherBtn").attr("disabled",false);});$(document).on("click",".otherBtn",function(){a._getData("others");$(".allBtn").attr("disabled",false);
$(".noticeBtn").attr("disabled",false);$(".missBtn").attr("disabled",false);$(".csCountBtn").attr("disabled",false);$(".otherBtn").attr("disabled",true);
});$(document).on("click",".deleteMsg",function(){var b=$(this).parents(".timeline-item");var c=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/msg/msgEntity/deleteMsgRead.htm",{msgId:c,recId:currentUserId},function(d){if(d.success){a._getData("");
DialogUtils.success(msgCode.SUCCESS,"删除成功");}});});});$("body").on("click",".content",function(){var b=$(this).attr("urlVal");var d=$(this).attr("titleVal");
var c=$(this).attr("idVal");if(b){if(d==="待办任务"){JTTabUtils.addOrRefreshTab(ctx+"/gl/task/taskEntity/list.htm","待办任务","待办任务");}else{if(d==="我的客户"){JTTabUtils.addOrRefreshTab(ctx+b+"?type=self&turnNew=y",d);
}else{JTTabUtils.addOrRefreshTab(ctx+b,d);}}a._markRead(c);a._getData("");}});$(document).on("click",".next-msg",function(){a.currentMsgItem=a.currentMsgItem+1;
a._buildString(a.msgData);});$(document).on("click",".prev-msg",function(){a.currentMsgItem=a.currentMsgItem-1;a._buildString(a.msgData);});$(document).on("click",".deleteMsgs",function(){DialogUtils.confirmWithOptions({title:"是否删除选中的消息",text:"",confirmButtonText:"确认",yesFunc:function(){a._deleteMsg();
}});});$(document).on("click",".deleteMsgAll",function(){DialogUtils.confirmWithOptions({title:"是否删除所有消息",text:"",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(ctx+"/gl/msg/msgEntity/deleteAllReaded.htm",{recId:currentUserId,type:""},function(b){if(b.success){a._getData("");
DialogUtils.success(msgCode.SUCCESS,"删除成功");}});}});});$(document).on("click","#deleteAll",function(){var d=$(this)[0].checked;var c=$("#msgDiv").find("input[name=deletePart]");
for(var b=0;b<c.length;b++){c[b].checked=d;}});$(document).on("click",".markRead",function(){var b=$(this).attr("idVal");a._markRead(b);document.location.reload();
});},_markRead:function(a){FormUtils.submit(ctx+"/gl/msg/msgEntity/markRead.htm",{id:a,isRead:"y"},function(b){if(b.success){}});},_deleteMsg:function(){var a=this;
var b=[];$(".ibox-content").find("input[name=deletePart]").each(function(){if($(this).is(":checked")){b.push($(this).val());}});FormUtils.submit(ctx+"/gl/msg/msgEntity/deleteMsgRead.htm",{msgId:b,recId:currentUserId},function(c){if(c.success){a._getData("");
DialogUtils.success(msgCode.SUCCESS,"删除成功");}});},_judeNextBtn:function(b,c){var a=this;if((b*a.rowItem)<c){$(".next-msg").removeAttr("disabled");}else{$(".next-msg").attr("disabled","disabled");
}},_judePrevBtn:function(b){var a=this;if(b>1){$(".prev-msg").attr("disabled",false);}else{$(".prev-msg").attr("disabled",true);}},_getData:function(b){var a=this;
FormUtils.loadData(ctx+"/gl/msg/msgEntity/findReadyResult.htm?recId="+currentUserId+"&type="+b,function(c){$("#msgDiv").empty();var d=c.records;a.totalMsgItem=d;
if(d>=1){a.currentMsgItem=1;a.msgData=c.rows;a._buildString(a.msgData);}else{a.currentMsgItem=0;a._judeNextBtn(a.currentMsgItem,a.totalMsgItem);a._judePrevBtn(a.currentMsgItem);
}});},_buildString:function(f){var a=this;$("#msgDiv").empty();var h=new StringBuffer();var c=0;if(a.currentMsgItem*a.rowItem>=a.totalMsgItem){c=a.totalMsgItem;
}else{c=a.currentMsgItem*a.rowItem;}for(var d=(a.currentMsgItem-1)*a.rowItem;d<c;d++){var b=f[d].url;var g=f[d].title;var e="";if(g.indexOf("未接来电")!=-1){e=g.replace("未接来电","");
if(e){e=PhoneEncryptUtils.encryptPhone(e);}else{e="";}}if(e){g=e+"未接来电";}if(!b){b="";}if(e){if(!f[d].content||f[d].content.indexOf("未接来电")>-1){f[d].content="时间未知";
}f[d].content=e+"&nbsp;&nbsp;约<strong>["+f[d].content+"]</strong>&nbsp;&nbsp;未接来电";}h.append("<div class='timeline-item'>");h.append("<div class='row'>");
h.append("<div class='col-sm-12'>");h.append("<div class='col-xs-1' style='padding:0px;padding-top: 10px;'>");h.append("<input type='checkbox' name='deletePart' value='"+f[d].id+"' class='msg-check-box'>");
h.append("</div>");h.append("<div class='col-xs-3 date' style='padding-left:0px;padding-right:2px;text-align:center;'>");if("notice"==f[d].type){h.append("<i>系统公告</i>");
}else{if("miss"==f[d].type){h.append("<i>未接来电</i>");}else{if("assign"==f[d].type){h.append("<i>新进客户</i>");}else{if("others"==f[d].type){h.append("<i>其他消息</i>");
}}}}if(DateUtils.getDateDiff(DateUtils.format(new Date(),"yyyy-MM-dd")+" 00:00:00",f[d].createTime.substring(0,10)+" 00:00:00","day")<0){h.append(f[d].createTime.substring(5,16));
}else{h.append(f[d].createTime.substring(11,16));}h.append("</div>");h.append("<div class='col-xs-7 content' style='min-height: 45px;");h.append("' urlVal='"+b+"'  titleVal='"+g+"'  idVal='"+f[d].id+"' >");
var g="提示";if(f[d].level==1){g="普通";}else{if(f[d].level==2){g="重要";}else{if(f[d].level==3){g="非常重要";}}}if("others"==f[d].type&&f[d].content.indexOf("【客户跟进】")>-1){h.append("<div class='col-xs-1' title='"+g+"'><img class='img-circle msg-level-"+f[d].level+"' style='height:18px;width:18px;' src="+ctx+"/img/jt/notice/level"+f[d].level+".png></div><div class='col-xs-11' style='padding:0px;'>"+a._dealCsContent(f[d].content)+"</div>");
}else{if("others"==f[d].type&&f[d].content.indexOf("【订单跟进】")>-1){h.append("<div class='col-xs-1' title='"+g+"'><img class='img-circle msg-level-"+f[d].level+"' style='height:18px;width:18px;' src="+ctx+"/img/jt/notice/level"+f[d].level+".png></div><div class='col-xs-11' style='padding:0px;'>"+a._dealSoFollowContent(f[d].content)+"</div>");
}else{if("others"==f[d].type&&f[d].content.indexOf("【订单】")>-1){h.append("<div class='col-xs-1' title='"+g+"'><img class='img-circle msg-level-"+f[d].level+"' style='height:18px;width:18px;' src="+ctx+"/img/jt/notice/level"+f[d].level+".png></div><div class='col-xs-11' style='padding:0px;'>"+a._dealSoContent(f[d].content)+"</div>");
}else{if("assign"==f[d].type){h.append("<div class='col-xs-1' title='"+g+"'><img class='img-circle msg-level-"+f[d].level+"' style='height:18px;width:18px;' src="+ctx+"/img/jt/notice/level"+f[d].level+".png></div><div class='col-xs-11' style='padding:0px;'>"+a._dealAssignContent(f[d].content)+"</div>");
}else{h.append("<div class='col-xs-1' title='"+g+"'><img class='img-circle msg-level-"+f[d].level+"' style='height:18px;width:18px;' src='"+ctx+"/img/jt/notice/level"+f[d].level+".png'></div><div class='col-xs-11' style='padding:0px;'>"+f[d].content+"</div>");
}}}}h.append("</div>");h.append("<div class='col-xs-2' style='padding-top: 10px;text-align: right;float: right;'>");h.append("<button class='jt-form-select markRead' idVal='"+f[d].id+"' type='button'>标识为已读</button>");
h.append("<button class='jt-form-select deleteMsg' idVal='"+f[d].id+"' type='button'><i class='fa fa-remove'></i></button>");h.append("</div>");h.append("</div>");
h.append("</div>");h.append("</div>");if(d==a.rowItem-1){break;}}$("#msgDiv").append(h.toString());a._judeNextBtn(a.currentMsgItem,a.totalMsgItem);a._judePrevBtn(a.currentMsgItem);
},_dealAssignContent:function(b){var a="";a=b.replace(/\d{1,5}/g,function(c){var d=new StringBuffer();d.append("<strong>");d.append(c);d.append("</strong>");
return d.toString();});return a;},_dealCsContent:function(b){var a="";a=b.replace(/\d{3,12}:/g,function(d){var c=d.substring(0,d.length-1);var e=new StringBuffer();
e.append("<strong>");e.append(c);e.append("</strong>");e.append(":");return e.toString();});return a;},_dealSoContent:function(b){var a="";a=b.replace(/\d{3,12}】/g,function(d){var c=d.substring(0,d.length-1);
var e=new StringBuffer();e.append("<strong>");e.append(c);e.append("</strong>");e.append("】");return e.toString();});return a;},_dealSoFollowContent:function(b){var a="";
a=b.replace(/\d{3,12}：/g,function(d){var c=d.substring(0,d.length-1);var e=new StringBuffer();e.append("<strong>");e.append(c);e.append("</strong>");e.append("：");
return e.toString();});return a;},};