$(function(){var a=new T9KmEntity();a.init();});function T9KmEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.hadInitList=false;
this.kmFile=new KmFile();this.keyword="";this.rootId=null;this.rows=10;this.page=1;this.textFormat=125;this.hasInitJqgrid=false;}T9KmEntity._CONS_={EDIT_URL:ctx+"/gl/qa/qaEntity/edit.htm",DETAILCONTENT_URL:ctx+"/gl/qa/qaEntity/detailContent.htm",DETAIL_URL:ctx+"/gl/qa/qaEntity/detail.htm",DELETE_URL:ctx+"/gl/qa/qaEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/qa/qaEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/qa/qaEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/qa/T9QaEntity/listData.htm",KEYSEARCH_URL:ctx+"/gl/qa/T9QaEntity/keySearch.htm",CHANGE_CATE_URL:ctx+"/gl/qa/T9QaEntity/changeCate.htm",DELETECATE_URL:ctx+"/gl/qa/T9QaEntity/deleteCate.htm",EDIT_FORM_ID:"T9kmEntityForm"};
T9KmEntity.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this.kmFile.init();
this._hideNotGrantBtn();}},reloadKmList:function(c,a){$(".km-content-layer").show();$(".km-learn").hide();var b=this;var d={rows:b.rows,page:1,sord:b.sord};
if(a||b.queryParam){if(c){b.queryParam=c;$.extend(true,d,c,{"Q__S__EQ__cate_id_":this.cateId});}else{$.extend(true,d,b.queryParam,{"Q__S__EQ__cate_id_":this.cateId});
}}else{d.Q__S__EQ__cate_id_=this.cateId;}$("#kmList").empty();this.kmList(d);},kmListStr:function(e){var b=this,a="",f=new StringBuffer();if(e&&e.length){for(var c=0;
c<e.length;c++){var d="否";if(e[c].isGood=="y"){d="<font style='color:red;'>是</font>";}f.append("<li  data-cate-id='"+e[c].cateId+"' data-id='"+e[c].id+"' data-create-by='"+e[c].createBy+"' data-create-time='"+e[c].createTime+"'>").append("<div class='title'><a class='kmId'>"+e[c].name+"</a>").append("<div class='content'>"+b.kmAnswerHtml(e[c].content)+"</div>").append("<div class='meta'>").append("<a class='cate-type'>"+e[c].cateName+"</a>").append("<a class='createBy'>创建者："+e[c].createBy+"</a>").append("<a class='createTime' style='margin-left:10px;color:#c0c0c0;'>创建时间："+e[c].createTime+"</a>").append("<a class='isGood'  style='margin-left:10px;color:#f8ac59;'>是否加精："+d+"</a>").append("</div></div>").append("<div class='single-libtn-layer'>");
if(ResUtils.canShow("T9kmEntity.button.edit")){f.append("<span class='km-edit-btn '><i class='fa fa-pencil'></i>&nbsp;<strong>编辑</strong></span>&emsp;");
}if(ResUtils.canShow("T9kmEntity.button.delete")){f.append("<span class='km-delete-btn'><i class='fa fa-trash-o'></i>&nbsp;<strong>删除</strong></span>");
}f.append("</div>").append("</li>");}}else{f.append("<li class='no-data-li'>").append("<h2>该分类下没有找到符合的数据...</h2>").append("</li>");}if($(".load-more").length==0&&b&&b.total>b.page){f.append("<li class='load-more'>点击加载更多<br/><font color='#d0d0d0'>当前第&nbsp;").append(b.page).append("&nbsp;页&emsp;共&nbsp;").append(b.total).append("&nbsp;页</font></li>");
}return f.toString();},kmAnswerHtml:function(d){var a=this;var e=new StringBuffer();if(d){if($("#text-chg").length==0){$("body").append("<p id='text-chg' style='display:none;'></p>");
}$("#text-chg").empty().append(d);var c="";var b=$("#text-chg").children("p");if(b.length!=0){b.each(function(f,g){c+=$.trim($(this).text());if(b.length!=f+1){c+="\r\n";
}});}else{c=d;}e.append("<p style='width:auto;overflow:hidden;width:100%;' data-alltext='"+c+"'>").append((a.textFormatter(c)).replace(/\n|\r\n/g,"<br/>")).append("</p>");
}else{e.append("<p class='km-noanswer-layer'></p>");}return e.toString();},loadMoreList:function(){var a=this;var b={rows:a.rows,page:a.page+1,sord:a.sord};
if(a.queryParam){$.extend(true,b,a.queryParam,{"Q__S__EQ__cate_id_":a.rootId});}else{b.Q__S__EQ__cate_id_=this.cateId;}FormUtils.submit(T9KmEntity._CONS_.LIST_DATA_URL,b,function(c){a.total=c.total;
a.page=c.page;$("#kmList").find(".load-more").before(a.kmListStr(c.rows));if(a.total==a.page){$(".load-more").remove();}else{$(".load-more").find("font").html("当前第&nbsp;"+a.page+"&nbsp;页 共&nbsp;"+a.total+"&nbsp;页");
}});},textFormatter:function(d){var b=this;var a=d.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");if(a.length>b.textFormat){var c=(a.substring(0,b.textFormat)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"...<span class='km-li-expand'>[展开全文]</span>";
}else{c=d;}return c;},extendText:function(c){var a=this;if(c.find(".km-li-expand").length>0){var b=c.find(".km-li-expand").parent().attr("data-alltext");
c.find(".km-li-expand").parent().empty().append(b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"&emsp;<span class='km-li-pickup'>[收起 <i class='fa fa-long-arrow-up'></i> ]</span>");
}},pickupText:function(c){var a=this;if(c.find(".km-li-pickup").length>0){var b=c.find(".km-li-pickup").parent().attr("data-alltext");c.find(".km-li-pickup").parent().empty().append(a.textFormatter(b));
}},_hideNotGrantBtn:function(){},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveT9KmEntityBtn").show();
a.kmFile.clearFiles();tinymce.editors=[];tinymce.EditorManager.execCommand("mceRemoveEditor",true,"tinyMceContent");FormUtils.clear(T9KmEntity._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(T9KmEntity._CONS_.EDIT_FORM_ID);if(c){}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){if($(T9KmEntity._CONS_.GRID).length>0){$(".list_wrapper").show();
}else{$(".km_wrapper").show();}$(".form_wrapper").hide();},_showFormWrapper:function(){$(".kmInfo").hide();$(".form_wrapper").show();},_add:function(){FormUtils.clear(T9KmEntity._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(T9KmEntity._CONS_.EDIT_FORM_ID);if($(this).is(".disabledBtn")){return false;}$(".qa-form-layer").hide();$(".qa-list-layer").hide();
$(".qa-btn-layer").hide();$("#detailForm").hide();$(".T9kmEntityFormWrapper").show();},_edit:function(b){var a=this;FormUtils.clear(T9KmEntity._CONS_.EDIT_FORM_ID);
a.edit=true;a._loadData(b);if($(this).is(".disabledBtn")){return false;}$(".qa-form-layer").hide();$(".qa-list-layer").hide();$(".qa-btn-layer").hide();
$("#detailForm").hide();$(".kmFileAdd").removeAttr("disabled");$(".saveT9KmEntityBtn").show();$(".T9kmEntityFormWrapper").show();},_detail:function(a){this._loadDetail(a);
$(".qa-form-layer").hide();$(".qa-list-layer").hide();$(".qa-btn-layer").hide();$(".T9kmEntityFormWrapper").show();$("#T9kmEntityForm").hide();$("#detailForm").show();
$(".T9kmEntityFormWrapper .saveT9KmEntityBtn").hide();$(".kmFileAdd").attr("disabled","disabled");FormUtils.disableForm(T9KmEntity._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(T9KmEntity._CONS_.EDIT_URL+"?id="+b,function(c){$("#T9kmEntityForm").find("input[name=question]").val(c.question);
$("#T9kmEntityForm").find("input[name=id]").val(c.id);$("#T9kmEntityForm").find("input[name=groupIds]").val(c.groupIds);$("#T9kmEntityForm").find("input[name=groupNames]").val(c.groupNames);
$("#T9kmEntityForm").find("input[name=qaCateFirstId]").val(c.qaCateFirstId);$("#T9kmEntityForm").find("input[name=cateId]").val(c.cateId);$("#T9kmEntityForm").find("#cateName").val(c.cateName);
$("#T9kmEntityForm").find("input[name=createBy]").val(c.createBy);$("#T9kmEntityForm").find("input[name=createTime]").val(c.createTime);$("#T9kmEntityForm").find("input[name=type]").val(c.type);
a.kmFile.clearFiles();a.kmFile.createFiles(c.qaEntityFilePos);tinyMCE.activeEditor.setContent(c.content);});},_loadDetail:function(b){var a=this;FormUtils.loadData(T9KmEntity._CONS_.DETAILCONTENT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);
$(".titleDetail").text(c.question);$(".timeDetail").text(c.createTime);$(".authorDetail").text(c.createBy);var d=new StringBuffer();d.append(c.content);
$(".contentDetail").empty().append(d.toString());if(c.qaEntityFilePos==""){$(".filesDetail").hide();}else{$(".filesDetail").show();a.kmFile.clearFiles();
a.kmFile.createFilesInDetail(c.qaEntityFilePos);$(".deleteFile").hide();}if(c.isFavorite=="y"){$(".favoriteCancel").show();$(".favorite").hide();}else{$(".favorite").show();
$(".favoriteCancel").hide();}});},_save:function(){var c=this;var a=$("#id").val()?T9KmEntity._CONS_.SAVE_EDIT_URL:T9KmEntity._CONS_.SAVE_ADD_URL;$("#T9kmEntityForm").find("input[name=type]").val("content");
$("#content").val(tinyMCE.activeEditor.getContent());if($("#T9kmEntityForm").valid()){var b=$("#"+T9KmEntity._CONS_.EDIT_FORM_ID).serialize()+"&kmFileJSON="+c.kmFile.getFiles()+"&belong=t9";
if(!$("#content").val()){DialogUtils.error(msgCode.INFO,"请填写知识内容");}else{ButtonUtils.disableBtn("saveT9KmEntityBtn");FormUtils.submit(a,b,function(d){ButtonUtils.enableBtn("saveT9KmEntityBtn");
if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}tinymce.EditorManager.execCommand("mceRemoveEditor",true,"tinyMceContent");c.isEdit=false;c.clear(true);c._detail(d.msg);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){ButtonUtils.enableBtn("saveT9KmEntityBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(T9KmEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a._deleteLi(b);}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_deleteLi:function(b){var a=this;var c=b.split(",");$.each(c,function(d,f){$("#kmList").find("li[data-id="+this+"]").remove();
});},_toParams:function(){var d={};var a=$("#keyWordSearchIpt").val();var b=$("#isGood  option:selected").val();var c=$("#isMyFavirate option:selected").val();
var e=$("#isLearn option:selected").val();d.Q__S__LK__content_=a;d.Q__S__EQ__is_good_=b;d.type=c;d.isLearn=e;return d;},_bindEventHander:function(){var a=this;
$(document).on("click",".load-more",function(b){event.stopPropagation();if(a.total&&a.total>a.page){a.loadMoreList();}});$(document).on("click",".km-li-expand",function(b){a.extendText($(this).closest("li"));
});$(document).on("click",".km-li-pickup",function(b){a.pickupText($(this).closest("li"));});$("#cateName").on("click",function(){var b={isMultiple:0,typeKey:"system",pKey:"T9QaEntity",treeId:"qa-tree-id",url:T9QaEntity._CONS_.QA_CATE_TREE_URL,container:"cateName",fn:function(f,d,g){if(f){$("#T9kmEntityForm").find('input[name="cateId"]').val(f);
var e=a.getById(f);$("#T9kmEntityForm").find('input[name="qaCateFirstId"]').val(a.getCateFirstId(e));}else{}},dataFilter:function c(f,d,e){return e;if(e){}}};
CateUtils.selectCateTreeBox(b);});$(document).on("click",".prevBtn",function(){$(".form_wrapper").hide();$(".qa-form-layer").show();$(".qa-list-layer").show();
$(".qa-btn-layer").show();window.location.reload();});$(".saveT9KmEntityBtn").off("click").on("click",function(){a._save();});$(document).on("click",".kmId",function(){var b=$(this).parents("li").attr("data-id");
a._detail(b);});$("#"+T9KmEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+T9KmEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+T9KmEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(document).on("click",".T9kmEntitySearch",function(){var b=a._toParams();
a.reloadKmList(b,true);});$("#T9kmEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".T9kmEntitySearch").trigger("click");}});$("body").on("click",".T9kmEntityAdd",function(){a._add();
});$("body").on("click",".km-edit-btn",function(){a.isEdit=true;var b=$(this).parents("li").attr("data-id");if(!b){b=$(T9KmEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}a._edit(b);});$("body").on("click",".km-delete-btn",function(){var b=$(this).parents("li").attr("data-id");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}a._delete(b);});$(document).on("click",".note-list li",function(b){if($(b.target).is(".load-more,.no-data-li,.km-li-expand,.km-li-pickup,.single-libtn-layer,.single-libtn-layer *,.km-noanswer-layer,.km-noanswer-textarea")){}else{if($(this).is(".km-list-select")){$(this).removeClass("km-list-select");
if($(".checkAllBtn").is("[disabled]")){$(".checkAllBtn").removeAttr("disabled");}}else{$(this).addClass("km-list-select");}}});$("body").on("click",".T9kmEntityDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(T9KmEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要查看明细的记录");
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(".T9kmEntityChangeCate").on("click",function(){a.isEdit=true;
var c=[],b=$(".km-list-select");if(b.length==0){DialogUtils.error(msgCode.error,"请选择要移动分类的知识");return false;}$.each(b,function(d,f){c.push($(this).attr("data-id"));
});a._changeCate(c);});$(document).on("click","#returnList",function(){$(".km-content-layer").show();$(".km-learn").hide();});},_changeCate:function(c){var a=this;
if(jQuery.isArray(c)){c=c.join(",");}var b={isMultiple:0,typeKey:"knowledge_type",pKey:"knowledge",selectedCateIds:c,fn:function(d){if(d.length>0){FormUtils.submit(T9KmEntity._CONS_.CHANGE_CATE_URL,{cateId:d[0].id,ids:c},function(e){if(e.success){a.reloadKmList();
DialogUtils.success(msgCode.INFO,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
}}};CateUtils.selectCate(b);},_highLight:function(b,c,d){var a=this;FormUtils.submit(T9KmEntity._CONS_.HIGHLIGHT_URL,{ids:b},function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
$(".T9kmEntityCancel").show();$(".T9kmEntityHighLight").hide();}else{DialogUtils.error(msgCode.ERROR,e.msg);}});},_cancel:function(b){var a=this;FormUtils.submit(T9KmEntity._CONS_.CANCEL_URL,{ids:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
$(".T9kmEntityCancel").hide();$(".T9kmEntityHighLight").show();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_bindFormValidation:function(){var a={rules:{name:{required:true,maxlength:128},cateName:{required:true},keyword:{maxlength:255},contentTmp:{required:true,maxlength:1028},},messages:{cateName:{required:"请选择分类"}}};
FormUtils.bindFormValidation(T9KmEntity._CONS_.EDIT_FORM_ID,a);},reloadDiv:function(a){$(".reviewContainer").empty();this.kmReview.showReviews(a);},getById:function(d){var a=this;
var b=$.fn.zTree.getZTreeObj("T9qaEntityCateTree");var c=b.getNodeByParam("id",d);return c;},getCateFirstId:function(a){var c=null;function b(e){if(e.getParentNode()!=null){var d=e.getParentNode();
c=e.id;return b(d);}else{return c;}}c=b(a);if(!c){c=a.id;}return c;},};