$(function(){var a=new QaImage();a.init();});function QaImage(){if(this instanceof QaImage){this.albumId="";this.container="qaImgDiv";this.iframeIndex=parent.layer.getFrameIndex(window.name);
}else{return new QaImage();}}QaImage._CONS_={LOAD_ALBUM_URL:ctx+"/gl/image/image/listAlbum.htm",LOAD_IMAGE_URL:ctx+"/gl/image/image/listImage.htm",SAVE_ADD_URL:ctx+"/gl/image/image/saveAdd.htm",DELETE_ALBUM_URL:ctx+"/gl/image/image/deleteAlbum.htm",UPLOAD_PARAMS:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":"image/*","fileSingleSizeLimit":1*1024*1024*6,"fileNumLimit":300,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
QaImage.prototype={init:function(){this._bindEventHandler();},_loadAlbumTree:function(){var a=this;var b={treeId:"albumTree",cateTypeKey:"system",rootKey:"default-album",userId:this.userId,type:"userAndSystem",disabledRoot:true,contextMenu:{add:{isShow:true,title:"添加相册",clickFn:function(c){},clazz:"addAlbumBtn"},update:{isShow:true,title:"更新相册",clickFn:function(){},clazz:"updateAlbumBtn"},del:{isShow:true,title:"删除相册",clickFn:function(c){DialogUtils.confirm(function(){FormUtils.del(SelectImage._CONS_.DELETE_ALBUM_URL,c.id,function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$.fn.zTree.getZTreeObj("albumTree").removeNode(c);}else{DialogUtils.error(msgCode.FAIL,msgCode.FAIL_MSG);}});});},clazz:"deleteAlbumBtn"},},saveFn:function(c){a.albumId=c.id;
if(c.name.indexOf("【系统】")!=-1){$("#uploadBtn").hide();}else{$("#uploadBtn").show();}a._loadImageData();},onClick:function(c){a.albumId=c.id;if(c.name.indexOf("【系统】")!=-1){$("#uploader").hide();
$("#photoContainer").show();$("#uploadBtn").hide();$("#cancelUploadBtn").hide();}else{if($("#cancelUploadBtn").is(":visible")){$("#cancelUploadBtn").trigger("click");
}else{$("#uploadBtn").show();}}a._loadImageData();}};ZtreeUtils.init(b);},_loadImageData:function(){var a=this;FormUtils.loadData(QaImage._CONS_.LOAD_IMAGE_URL+"?cateId="+this.albumId,function(b){if(b!=null&&b.length>0){$("#"+a.container).empty().append(a._createImageStr(b));
}else{$("#"+a.container).empty();}});},_createImageStr:function(a){if(a&&a.length){var f=new StringBuffer();for(var c=0;c<a.length;c++){var e=a[c];var b=ImageUtils.getUrl(e,"mm");
var d=e.zoom;f.append("<div value='"+e.id+"' imageUrl='"+e.path+"?dm=_mm' imageName='"+e.name+"' imageIsZoom='"+d+"' class='photo-item-edit'>").append("<div>").append("<img alt='image' class='selectImage' style='width: 100px; height: 100px;' src='"+b+"?dm=_mm' />").append("</div>").append("<div class='item-ft'>").append("<div>").append("<span class='imageName' title='"+e.name+"'>"+e.name+"</span>").append("</div>").append("</div>").append("<div style='clear: both'>").append("</div>").append("</div>");
}return f.toString();}else{return"";}},_bindEventHandler:function(){var a=this;$("#photoContainer").on("mouseenter",".photo-item-edit",function(){if(!$(this).hasClass("photo-item-shadow-red")){$(this).addClass("photo-item-edit-default");
}});$("#photoContainer").on("mouseleave",".photo-item-edit",function(){$(this).removeClass("photo-item-edit-default");});$("#uploadBtn").on("click",function(){$("#uploader").show();
a._bindWebuploader();$("#photoContainer").hide();$(this).hide();$("#cancelUploadBtn").show();});$("#cancelUploadBtn").on("click",function(){$("#uploadBtn").show();
$("#photoContainer").show();$(this).hide();$("#uploader").hide();});if(this.isMultiple==1){$("#photoContainer").on("click",".selectImage",function(b){b.stopPropagation();
if(!$(this).parent().parent().hasClass("photo-item-shadow-red")){$(this).parent().parent().removeClass("photo-item-edit-default");$(this).parent().parent().addClass("photo-item-shadow-red");
}else{$(this).parent().parent().removeClass("photo-item-shadow-red");}});$("#photoContainer").on("click",".photo-item-edit",function(){if(!$(this).hasClass("photo-item-shadow-red")){$(this).removeClass("photo-item-edit-default");
$(this).addClass("photo-item-shadow-red");}else{$(this).removeClass("photo-item-shadow-red");}});}else{if(this.isMultiple==0){$("#photoContainer").on("click",".selectImage",function(b){b.stopPropagation();
$(".photo-item-edit").removeClass("photo-item-shadow-red");if(!$(this).parent().parent().hasClass("photo-item-shadow-red")){$(this).parent().parent().removeClass("photo-item-edit-default");
$(this).parent().parent().addClass("photo-item-shadow-red");}else{$(this).parent().parent().removeClass("photo-item-shadow-red");}});$("#photoContainer").on("click",".photo-item-edit",function(){$(".photo-item-edit").removeClass("photo-item-shadow-red");
if(!$(this).hasClass("photo-item-shadow-red")){$(this).removeClass("photo-item-edit-default");$(this).addClass("photo-item-shadow-red");}else{$(this).removeClass("photo-item-shadow-red");
}});}}},_bindWebuploader:function(){var c=this;var b=[];var d=0;function e(i,h){if(h.flag){var j={height:h.height,width:h.width,path:h.localPath,name:h.fileName,byteCount:h.byteCount,isWater:h.water,isZoom:h.zoom,saveType:"relative",cateId:c.albumId,sort:d++};
b.push(j);}}function a(h,i){alert("上传"+h.name+"失败，原因是"+i);}function f(){$("#cancelUploadBtn").trigger("click");FormUtils.submit(SelectImage._CONS_.SAVE_ADD_URL,$.param({imageJson:JSON.stringify(b)}),function(h){$("#photoContainer").show().append(c._createImageStr(h));
},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}var g=new JTWebUploader({config:SelectImage._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：gif,jpg,jpeg,bmp,png格式文件，单个文件最大为6MB",success:e,error:a,finish:f});
g.init();}};