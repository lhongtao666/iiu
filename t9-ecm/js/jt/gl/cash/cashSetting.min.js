$(function(){var a=new CashSetting();a.init();});function CashSetting(){this.hadInit=false;}CashSetting._CONS_={SAVE_ADD_URL:ctx+"/gl/cash/cashSetting/saveAdd.htm",LIST_DATA_URL:ctx+"/gl/cash/cashSetting/listData.htm",DELETE_URL:ctx+"/gl/cash/cashSetting/delete.htm",SAVE_TABLE_URL:ctx+"/gl/cash/cashSetting/saveTable.htm",SETTING_HI_LIST_URL:ctx+"/gl/cash/cashHi/listData.htm",EXPORT_ISSUE_URL:ctx+"/gl/cash/cashHi/exportIssue.htm",SAVE_ISSUE_URL:ctx+"/gl/cash/cashHi/batchAdd.htm",};
CashSetting.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initTable(a);this._hideNotGrantBtn();this._locateToGlHelp();
}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.operations.cashSetting");},_hideNotGrantBtn:function(){if(!ResUtils.canShow("cashSetting.button.add")){$(".cashSettingAdd").hide();
}if(!ResUtils.canShow("cashSetting.button.delete")){$(".deleteBtn").hide();}if(!ResUtils.canShow("cashSetting.button.issue")){$(".toIssueBtn").hide();}},_bindEventHander:function(){var a=this;
$(document).on("click",".cashSettingSearch",function(){a._initTable($(this).closest("form").serialize());});$("body").on("click",".deleteBtn",function(){var c=$(this).parents("tr");
var d=c.attr("idVal");var b=c.attr("statusVal");if("init"==b){DialogUtils.confirm(function(){FormUtils.submit(CashSetting._CONS_.DELETE_URL,"ids="+d,function(e){if(e.success){c.remove();
DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}});});}else{DialogUtils.error(msgCode.ERROR,"已发行的现金券不能删除");}});
$("body").on("click",".cashSettingAdd",function(){a._saveAdd();});$("body").on("click",".toIssueBtn",function(){var c=$(this).parents("tr");var b={id:c.attr("idVal"),name:c.find("input[name=name]").val(),money:c.find("input[name=money]").val(),pubSum:c.attr("pubSumVal"),useSum:c.attr("useSumVal"),status:c.attr("statusVal")};
a._toIssue(b);});$("body").on("click",".issueBtn",function(){a._saveAddIssue();});$(document).on("click",".searchBtn",function(){a._initCashHi($("#issueForm").find("input[name=id]").val());
});$(document).on("click",".copyCodeBtn",function(){$(this).parent().find("#cashCodeText").select();document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功",$("div.issueEdit"));
});$(document).on("blur","input[name=name]",function(){var b=$(this).val();var c=$(this).attr("org-value");var d=$(this).parent().parent().attr("idVal");
if(b==""){$(this).val(c);return;}if(b!=c&&d){a._saveName(d,b,this);}});$(document).on("keyup","input[name=name]",function(c){if(c.keyCode=="13"){$(this).blur();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(document).on("change","input[name=money]",function(){var d=$(this).val();
var c=$(this).attr("org-value");var e=$(this).parent().parent().attr("idVal");var b=$(this).parent().parent().attr("statusVal");if(d==""){$(this).val(c);
return;}if("publish"==b){DialogUtils.error(msgCode.ERROR,"已发行的现金券不能修改");}else{if(d!=c&&e){a._saveMoney(e,d,this);}}});$(document).on("keyup","input[name=money]",function(c){if(c.keyCode=="13"){$(this).change();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".issueExportExcel").off("click").on("click",function(){var c=$("input[name=id]").val();
var b="Q__S__EQ__hi.setting_id_="+c;if($(".isExportPart").is(":checked")){b+="&Q__S__EQ__hi.status_=unused&isExportPart=y&Q__S__EQ__hi.so_no_="+$("#issueForm").find(".soNoSearch").val();
}else{b+="&"+$("#issueForm").serialize();}window.location.href=CashSetting._CONS_.EXPORT_ISSUE_URL+"?"+b;});$(document).on("click",".isExportPart",function(){if($(this).is(":checked")){$(this).val("y");
}else{$(this).val("n");}});},_saveName:function(d,a,b){var c={id:d,key:"name",value:a};this._saveEditGrid(c,b);},_saveMoney:function(d,a,b){var c={id:d,key:"money",value:a};
this._saveEditGrid(c,b);},_saveEditGrid:function(c,b){var a=CashSetting._CONS_.SAVE_TABLE_URL;FormUtils.submit(a,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
$(b).attr("org-value",c.value);$(b).val(c.value);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);$(b).val($(b).attr("org-value"));}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_saveAddIssue:function(){var a=this;if($("#issueForm").find("input[name=count]").val()==""){DialogUtils.error("提示","请输入数量再进行发行",$("div.issueEdit"));
return;}var b=$("#issueForm").find("input[name=id]").val();ButtonUtils.disableBtn("issueBtn");FormUtils.submit(CashSetting._CONS_.SAVE_ISSUE_URL,"count="+$("#issueForm").find("input[name=count]").val()+"&expireDate="+$("#issueForm").find("input[name=expireDate]").val()+"&settingId="+b,function(c){ButtonUtils.enableBtn("issueBtn");
if(c.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG,$("div.issueEdit"));a._initCashHi(b);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg,$("div.issueEdit"));
}},function(){ButtonUtils.enableBtn("issueBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG,$("div.issueEdit"));});},_saveAdd:function(){var a=this;
if($("#cashSettingBody").find("input[name=name]:last").val()==""){DialogUtils.error("提示","请输入名称再进行添加");return;}if($("#cashSettingBody").find("input[name=money]:last").val()==""){DialogUtils.error("提示","请输入金额再进行添加");
return;}ButtonUtils.disableBtn("cashSettingAdd");FormUtils.submit(CashSetting._CONS_.SAVE_ADD_URL,"name="+$("#cashSettingBody").find("input[name=name]:last").val()+"&money="+$("#cashSettingBody").find("input[name=money]:last").val(),function(b){ButtonUtils.enableBtn("cashSettingAdd");
if(b.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);a._addChangeTable($.parseJSON(b.msg));}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);
}},function(){ButtonUtils.enableBtn("cashSettingAdd");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_addChangeTable:function(b){var a=parseInt($(".lastTr").attr("countNumVar"));
$(".lastTr").before(this._buildLineStr(a,b));a++;$(".lastTr").attr("countNumVar",a);$(".lastCountNumTd").html(a);$(".lastTr").find("input[name=name]").first().val("");
$(".lastTr").find("input[name=money]").first().val("");},_initTable:function(b){var a=this;$("#cashSettingBody").empty();FormUtils.loadData(CashSetting._CONS_.LIST_DATA_URL+"?"+b,function(c){var d=new StringBuffer();
var e=0;if(c!=null){for(;e<c.length;e++){$("#cashSettingBody").append(a._buildLineStr(e+1,c[e]));}}if(ResUtils.canShow("cashSetting.button.add")){d.append("<tr class='lastTr' countNumVar='").append(e+1).append("'><td class='lastCountNumTd'>").append(e+1).append("</td>");
d.append("<td><input type='text' placeholder='输入名称' class='form-control' name='name' validateType='default'></td>");d.append("<td><input type='number' placeholder='输入金额' class='form-control' name='money' validateType='default'></td>");
d.append("<td><button type='button' class='jt-btn-opt cashSettingAdd'>添加</button></td>");d.append("</tr>");$("#cashSettingBody").append(d.toString());}});
},_buildLineStr:function(c,b){var a=new StringBuffer();a.append("<tr idVal='").append(b.id).append("' statusVal='").append(b.status).append("' pubSumVal='").append(b.pubSum).append("' useSumVal='").append(b.useSum).append("'>");
a.append("<td>"+c+"</td>");a.append("<td><input type='text' placeholder='输入名称' class='form-control' name='name' validateType='default' org-value='"+b.name+"' value='").append(b.name).append("'></td>");
a.append("<td><input type='number' placeholder='输入金额' class='form-control' name='money' validateType='default' org-value='"+b.money+"' value='").append(b.money).append("'");
if(b.status=="publish"){a.append("readonly");}a.append("></td>");a.append("<td>"+b.pubSum+"</td>");a.append("<td>"+b.useSum+"</td>");a.append("<td>");if(b.status=="init"){a.append("未发行");
}else{a.append("已发行");}a.append("</td>");a.append("<td>");a.append("<button type='button' class='jt-btn-opt toIssueBtn'>发行</button>");a.append(" <button type='button' class='jt-btn-error deleteBtn'>删除</button>");
a.append("</td>");a.append("</tr>");return a.toString();},_toIssue:function(b){var a=this;layer.open({type:1,title:"发行设置",maxmin:false,move:false,scrollbar:false,shadeClose:false,area:["75%","70%"],content:$(".issueEdit"),success:function(c,d){FormUtils.clear("issueForm");
$("input[name=id]").val(b.id);$("span[name=name]").text(b.name);if("init"==b.init){$("span[name=status]").text("未发行");}else{$("span[name=status]").text("已发行");
}$("span[name=money]").text(b.money);$("span[name=pubSum]").text(b.pubSum);$("span[name=useSum]").text(b.useSum);$("span[name=unuseSum]").text(b.pubSum-b.useSum);
$("span[name=userPrecent]").text(b.pubSum==0?0:(b.useSum/b.pubSum).toFixed(2)+"%");a._initCashHi(b.id);}});},_initCashHi:function(b){var a="Q__S__EQ__hi.setting_id_="+b+"&"+$("#issueForm").serialize();
FormUtils.loadData(CashSetting._CONS_.SETTING_HI_LIST_URL+"?"+a,function(d){var e=new StringBuffer();for(var c=0;c<d.length;c++){e.append("<tr>");e.append('<td style="width: 10%">');
e.append(c+1);e.append("</td>");e.append('<td style="width: 15%">');e.append(d[c].code+'<input id="cashCodeText" value="'+d[c].code+'" style="opacity: 0;position: absolute;" type="text">');
e.append(' <button type="button" class="btn btn-sm btn-primary jt-form-select copyCodeBtn">复制</button>');e.append("</td>");e.append('<td style="width: 15%">');
e.append(d[c].createTime);e.append("</td>");e.append('<td style="width: 15%">');e.append(d[c].expireDate);e.append("</td>");e.append('<td style="width: 10%">');
if("unused"==d[c].status){e.append("未使用");}else{e.append("已使用");}e.append("</td>");e.append('<td style="width: 10%">');e.append(d[c].soNo);e.append("</td>");
e.append('<td style="width: 10%">');if(d[c].csCode){e.append(d[c].csName+":"+d[c].csCode);}e.append("</td>");e.append('<td style="width: 15%">');e.append(d[c].useTime);
e.append("</td>");e.append("</tr>");}$("#issueTableContainer").empty().append(e.toString());});}};