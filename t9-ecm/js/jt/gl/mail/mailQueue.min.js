$(function(){var a=new MailQueue();a.init();});function MailQueue(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.canSubmit=false;
}MailQueue._CONS_={EDIT_URL:ctx+"/gl/mail/mailQueue/edit.htm",DETAIL_URL:ctx+"/gl/mail/mailQueue/detail.htm",DELETE_URL:ctx+"/gl/mail/mailQueue/delete.htm",SAVE_ADD_URL:ctx+"/gl/mail/mailQueue/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/mail/mailQueue/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/mail/mailQueue/listData.htm",LIST_HI_DATA_URL:ctx+"/gl/mail/mailQueueHi/list.htm",SEND_MAIL_URL:ctx+"/gl/mail/mailQueue/sendEmail.htm",RESEND_URL:ctx+"/gl/mail/mailQueue/resendEmail.htm",GET_CS_ADDR_URL:ctx+"/gl/mail/mailQueue/getAddr.htm",SAVE_DRAFT_URL:ctx+"/gl/mail/mailQueue/saveDraft.htm",EDIT_FORM_ID:"mailQueueForm",GRID:"#mailQueueGrid",PAGER:"#mailQueuePager"};
MailQueue.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._bindSummernote();}this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.dataAudit.mailQueue";glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mailQueue.button.detail")){$(".mailQueueDetail").hide();
}if(!ResUtils.canShow("mailQueue.button.add")){$(".mailQueueAdd").hide();}if(!ResUtils.canShow("mailQueue.button.edit")){$(".mailQueueEdit").hide();}if(!ResUtils.canShow("mailQueue.button.delete")){$(".mailQueueDel").hide();
}if(!ResUtils.canShow("mailQueue.button.resend")){$(".mailQueueResend").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;a.canSubmit=false;$(".form_wrapper .sendBtn").show();$(".form_wrapper .draftBtn").show();$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(":input").removeAttr("disabled","disabled");
$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(".panel-body").attr("contenteditable","true");$("#summernote").summernote("code","");$(".chosen-choices").empty();
FormUtils.clear(MailQueue._CONS_.EDIT_FORM_ID);FormUtils.enableForm(MailQueue._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_add:function(){this.canSubmit=true;this._showFormWrapper();$(".form_wrapper .reSendBtn").hide();},_edit:function(b,a){this._showFormWrapper();
this.edit=true;this.canSubmit=true;if(a=="resend"){$(".form_wrapper .draftBtn").hide();$(".form_wrapper .sendBtn").hide();$(".form_wrapper .reSendBtn").show();
this._loadData(b,true);}else{$(".form_wrapper .sendBtn").show();$(".form_wrapper .reSendBtn").hide();this._loadData(b);}},_detail:function(a){this._showFormWrapper();
this._loadData(a,true);$(".form_wrapper .sendBtn").hide();$(".form_wrapper .draftBtn").hide();$(".form_wrapper .reSendBtn").hide();FormUtils.disableForm(MailQueue._CONS_.EDIT_FORM_ID);
},_loadData:function(id,isdetail){var self=this;var url=isdetail?MailQueue._CONS_.DETAIL_URL:MailQueue._CONS_.EDIT_URL;FormUtils.loadData(url+"?id="+id,function(data){var content=eval("("+data.mailContent+")");
$("input[name=id]").val(data.id);$("input[name=title]").val(data.title);$("input[name=cateId]").val(data.cateId);$("input[name=sendType]").val(data.sendType);
$("input[name=sendCount]").val(data.sendCount);$("input[name=repeatCount]").val(data.repeatCount);$("input[name=sendTime]").val(data.sendTime);$("input[name=errorMsg]").val(data.errorMsg);
$("input[name=status]").val(data.status);$("input[name=createTime]").val(data.createTime);$("input[name=createBy]").val(data.createBy);$("input[name=updateTime]").val(data.updateTime);
$("input[name=updateBy]").val(data.updateBy);$("input[name=tos]").val(content.tos);$("input[name=csId]").val(data.csId);$("#summernote").summernote("code",content.content);
if(isdetail){self._loadEmailAddress(content.tos,true,data.csId);}else{self._loadEmailAddress(content.tos,false,data.csId);}var tos=content.tos;if(!(status==""||status==null||status=="draft")||isdetail){$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(":input").attr("disabled","disabled");
$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(".panel-body").attr("contenteditable","fasle");}if(data.status=="success"||data.status=="sending"){ButtonUtils.disableBtn("sendBtn");
FormUtils.disableForm(MailQueue._CONS_.EDIT_FORM_ID);}});},_delete:function(c,b,d){if(b==d){DialogUtils.error(msgCode.ERROR,"选中的数据不可删除");return;}var a=this;
DialogUtils.confirmWithOptions({title:"确定删除记录吗？",text:"您一共删除"+d+"条记录，有"+b+"条已发送成功，不可删除！",confirmButtonText:"删除",yesFunc:function(){FormUtils.del(MailQueue._CONS_.DELETE_URL,c,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,e.msg);}});}});},_bindSummernote:function(){SummernoteUtils.init({},"summernote");},_submitForm:function(){$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(":input").removeAttr("disabled","disabled");
$("#"+MailQueue._CONS_.EDIT_FORM_ID).find(".panel-body").attr("contenteditable","true");if(!this.canSubmit){return false;}var b=$("input[name=status]").val();
if(b=="success"||b=="sending"){return false;}var c=this;var a=MailQueue._CONS_.SEND_MAIL_URL;var d=c._setValues();if(!d){return;}if($("#mailQueueForm").valid()){ButtonUtils.disableBtn("sendBtn");
FormUtils.submitByFormId(a,MailQueue._CONS_.EDIT_FORM_ID,function(e){ButtonUtils.enableBtn("sendBtn");if(e.success){DialogUtils.success(msgCode.INFO,"添加到邮件队列成功！");
c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("sendBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_resendEmails:function(c,b,d){if(b==d){DialogUtils.error(msgCode.ERROR,"选中的数据不可重发");return;}var a=this;DialogUtils.confirmWithOptions({title:"确定重发邮件吗？",text:"您一共选中"+d+"条记录，有"+b+"条不可重发！",confirmButtonText:"重发",yesFunc:function(){FormUtils.del(MailQueue._CONS_.RESEND_URL,c,function(f){if(f.success){DialogUtils.success(msgCode.INFO,"重发成功！");
var e=$(this).closest("form").serialize();a.reloadJqgrid(e);}else{DialogUtils.error(msgCode.ERROR,f.msg);}});}});},_setValues:function(){var f=$(".chosen-choices").find("li");
var c=[];var a=[];for(var b=0;b<f.length;b++){var e={};e.name=$(f[b]).attr("nameVal");e.email=$(f[b]).attr("emailVal");c.push(e);var g=$(f[b]).attr("id");
a.push(g);}if(c.length<=0){DialogUtils.error(msgCode.ERROR,"收件人不能为空!");return false;}$("#tos").val(JSON.stringify(c));$("#csId").val(a);if(f.length>1){$("#csId").val("");
}var d=decodeURIComponent(SummernoteUtils.getCode("summernote"));$("#mailContent").val(d);if(d==null||d==""){DialogUtils.error(msgCode.ERROR,"邮件内容不能为空！");
return false;}return true;},_loadEmailAddress:function(d,c,a){for(var b=0;b<d.length;b++){var e="<li "+(a?("id='"+a+"'"):"")+"nameVal='"+d[b].name+"' emailVal='"+d[b].email+"'class='search-choice'><span>";
e+=d[b].name+"&lt;"+d[b].trueEmail+"&gt;</span>";if(!c){e+="<a class='search-choice-close' ></a>";}e+="</li>";$(".chosen-choices").append(e);}},_saveDraft:function(){var c=this;
var b=$("#status").val();if(!(b==""||b==null||b=="draft")){DialogUtils.error(msgCode.FAIL_MSG,"该邮件发送过，不能保存为草稿");return;}var d=c._setValues();if(!d){return;
}var a=MailQueue._CONS_.SAVE_DRAFT_URL;if($("#mailQueueForm").valid()){ButtonUtils.disableBtn("draftBtn");FormUtils.submitByFormId(a,MailQueue._CONS_.EDIT_FORM_ID,function(e){ButtonUtils.enableBtn("draftBtn");
if(e.success){DialogUtils.success(msgCode.INFO,"保存草稿成功");c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,"保存草稿失败");}},function(){ButtonUtils.enableBtn("draftBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){ButtonUtils.enableBtn("sendBtn");
FormUtils.enableForm(MailQueue._CONS_.EDIT_FORM_ID);$("#summernote").summernote("code","");a.clear(false);});$(document).on("click",".sendBtn",function(){a._submitForm();
});$(document).on("click",".reSendBtn",function(){var b=$("#id").val();FormUtils.del(MailQueue._CONS_.RESEND_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"重发成功！");
a.clear(true);a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});$(document).on("click",".draftBtn",function(){a._saveDraft();});$("#"+MailQueue._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+MailQueue._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".list_wrapper").on("click",".mailQueueSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#mailQueueSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);
return false;}});$("body").on("click",".mailQueueAdd",function(){a._add();});$("body").on("click",".mailQueueEdit",function(){a.isEdit=true;var c=$(this).attr("idVal");
if(!c){c=$(MailQueue._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要编辑的记录");return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.ERROR,"不能同时编辑多条记录");
return;}}}var d=$(MailQueue._CONS_.GRID).jqGrid("getRowData",c);var b=d.status;var e=d.sendType;if(b.indexOf("发送成功")>0||b.indexOf("发送失败")>0||b.indexOf("发送中")>0||b.indexOf("待重发")>0||e.indexOf("系统生成")>0){DialogUtils.error(msgCode.error,"所选记录不可编辑！");
return;}a._edit(c,"edit");});$("body").on("click",".mailQueueDel",function(){var c=$(this).attr("idVal");if(!c){c=$(MailQueue._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}var f=1;var e=0;var h="";if(c instanceof Array){f=c.length;
h=c.slice(0);for(var d=0;d<h.length;d++){var g=$(MailQueue._CONS_.GRID).jqGrid("getRowData",h[d]);var b=g.status;var j=g.sendType;if(b.indexOf("发送成功")>0||b.indexOf("发送中")>0||j.indexOf("系统生成")>0){h.splice(d,1);
e++;d--;}}}else{var g=$(MailQueue._CONS_.GRID).jqGrid("getRowData",c);var b=g.status;var j=g.sendType;if(b.indexOf("发送成功")>0||b.indexOf("发送中")>0||j.indexOf("系统生成")>0){DialogUtils.error(msgCode.error,"所选记录不可删除！");
return;}}a._delete(c,e,f);});$("body").on("click",".mailQueueDetail",function(){a.isEdit=true;a._bindSummernote();var b=$(this).attr("idVal");if(!b){b=$(MailQueue._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("body").on("click",".mailQueueResend",function(){a.isEdit=true;var e=$(this).attr("idVal");if(!e){e=$(MailQueue._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(e==null||e.length==0){DialogUtils.error(msgCode.error,"请选择要重发的记录");return;}else{if(e&&e.length>1){var j=0;var k=e.length;var c=e.slice(0);for(var g=0;
g<c.length;g++){var d=$(MailQueue._CONS_.GRID).jqGrid("getRowData",c[g]);var f=d.status;var b=d.sendType;if(f.indexOf("发送成功")>0||f.indexOf("发送中")>0||b.indexOf("系统生成")>0){c.splice(g,1);
j++;g--;}}a._resendEmails(e,j,k);}else{h(e);}}}else{h(e);}function h(l){var m=$(MailQueue._CONS_.GRID).jqGrid("getRowData",l);var i=m.status;var n=m.sendType;
if(i.indexOf("发送成功")>0||i.indexOf("发送中")>0){DialogUtils.error(msgCode.error,"所选记录不可重发！");return;}a._edit(l,"resend");}});$("body").on("click",".selectCustomer",function(){var c={selectedMulti:true,callBack:function(d){a._getCustomerEmail(d);
}};var b=new CustomerSelect();b.init(c);});$(document).on("click",".search-choice-close",function(){$(this).parent("li").remove();});},_getCustomerEmail:function(d){if(d!=null){var b=[];
for(var c=0;c<d.length;c++){b.push(d[c].id);}var e=$("#emailAddress").val();var a=MailQueue._CONS_.GET_CS_ADDR_URL;FormUtils.submit(a,{csId:b},function(k){if(k.success){var r=JSON.parse(k.msg);
for(var l=0;l<r.length;l++){var n=r[l].trueEmail;var p=r[l].email;var f=r[l].name;var m=r[l].id;var g=$(".chosen-choices").find("li");var o=false;for(var h=0;
h<g.length;h++){if(p==$(g[h]).attr("emailVal")&&f==$(g[h]).attr("nameVal")){DialogUtils.error(msgCode.error,"重复客户！");o=true;}}if(o){continue;}var q="<li  id='"+m+"'nameVal='"+f+"' emailVal='"+p+"'class='search-choice'><span>";
q+=f+"&lt;"+n+"&gt;</span><a class='search-choice-close' ></a></li>";$(".chosen-choices").append(q);}if(d.length!=r.length){DialogUtils.error(msgCode.error,"其余客户未设置邮箱地址，不可发送！");
}}else{DialogUtils.error(msgCode.error,"客户未设置邮件地址，不可发送！");}});}},_bindFormValidation:function(){var a={rules:{title:{required:true},emailAddress:{required:true}},messages:{}};
FormUtils.bindFormValidation(MailQueue._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(){var a=$("#mailQueueSearchForm").serialize();JTJqgridUtils.reloadJqgrid(MailQueue._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("mailQueue.button.delete")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["删除"]],btnClasses:[["btn btn-danger mailQueueDel"]],iconClasses:[["fa fa-remove"]]}});
}if(ResUtils.canShow("mailQueue.button.edit")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["编辑"]],btnClasses:[["btn btn-primary mailQueueEdit"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("mailQueue.button.resend")){a.push({switchCol:{colName:"status",colVals:["resend","failure"],colLables:[["重发"],["重发"]],btnClasses:[["btn btn-primary mailQueueResend"],["btn btn-primary mailQueueResend"]],iconClasses:[["fa fa-edit"],["fa fa-edit"]]}});
}if(ResUtils.canShow("mailQueue.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary mailQueueDetail",iconClasses:"fa fa-list"});
}return a;},_initJqgrid:function(b){var a=new Date();a=new Date(a.getTime()-7*24*3600*1000);a=a.currentDate()+" 00:00:00";$(".minPlaceTime").val(a);b={"Q__D__BW__mail.create_time_":a};
$(MailQueue._CONS_.GRID).JTJqgrid({url:MailQueue._CONS_.LIST_DATA_URL,pager:MailQueue._CONS_.PAGER,postData:b,colNames:["邮件标题","业务分类","发送方式","已发送次数","剩余重发次数","最后发送时间","状态","创建时间","创建ID","创建者","操作"],colModel:[{name:"title",index:"title_",width:120,sortable:false},{name:"cateId",index:"cate_id_",width:120,sortable:false},{name:"sendType",index:"send_type_",width:120,sortable:false,formatter:function(c){if(c=="manual"){return"人工";
}else{if(c=="sys"){return"系统生成";}else{return"";}}}},{name:"sendCount",index:"send_count_",width:120,sortable:false},{name:"repeatCount",index:"repeat_count_",width:120,sortable:false},{name:"sendTime",index:"send_time_",width:120,sortable:false},{name:"status",index:"status_",width:120,sortable:false,formatter:function(c){if(c=="success"){return"<span >发送成功</span>";
}else{if(c=="sending"){return"<span class='text-success'>发送中</span>";}else{if(c=="resend"){return"<span class='text-warning'>待重发</p>";}else{if(c=="failure"){return"<span class='text-danger'>发送失败</span>";
}else{return"<span>草稿</span>";}}}}}},{name:"createTime",index:"create_time_",width:120,sortable:false},{name:"createBy",index:"create_by_",width:120,hidden:true,sortable:false},{name:"createName",index:"create_by_",width:120,sortable:false},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};