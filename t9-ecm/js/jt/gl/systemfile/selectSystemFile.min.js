$(function(){var a=new SelectSystemFile();a.init();});function SelectSystemFile(){this.folderId="";this.userId=userId;this.isMultiple=isMultiple;}SelectSystemFile._CONS_={LOAD_FOLDER_URL:ctx+"/gl/systemfile/systemFile/listFolder.htm",LOAD_FILE_URL:ctx+"/gl/systemfile/systemFile/listFile.htm",SAVE_ADD_URL:ctx+"/gl/systemfile/systemFile/saveAdd.htm",DELETE_FOLDER_URL:ctx+"/gl/systemfile/systemFile/deleteFolder.htm",UPLOAD_PARAMS:{"acceptTypes":"css,htm,txt,html,zip,rar,doc,docx,pdf,ppt,pptx,js,log,swf,xls,xlsx,mp4,amr,mp3","fileNumLimit":300,"fileSingleSizeLimit":1*1024*1024*50,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
SelectSystemFile.prototype={init:function(){this._loadFolderTree();this._bindEventHandler();},_loadFolderTree:function(){var a=this;var b={treeId:"folderTree",cateTypeKey:"system",rootKey:"default-file",userId:this.userId,disabledRoot:true,type:"userAndSystem",contextMenu:{add:{isShow:true,title:"添加文件夹",clickFn:function(c){},clazz:"addAlbumBtn"},update:{isShow:true,title:"更新文件夹",clickFn:function(){},clazz:"updateAlbumBtn"},del:{isShow:true,title:"删除文件夹",clickFn:function(d){var c={title:"您确定要删除《"+d.name+"》吗",text:msgCode.DELETE_TEXT,confirmButtonText:"确认",yesFunc:function(){FormUtils.del(SelectSystemFile._CONS_.DELETE_FOLDER_URL,d.id,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$.fn.zTree.getZTreeObj("folderTree").removeNode(d);$("#imageContainer").empty();}else{DialogUtils.error(msgCode.FAIL,msgCode.FAIL_MSG);}});}};DialogUtils.confirmWithOptions(c);
},clazz:"deleteAlbumBtn"},},saveFn:function(c){a.folderId=c.id;a._loadFileData();if(c.name.indexOf("【系统】")!=-1){$("#uploadBtn").hide();}else{$("#uploadBtn").show();
}},onClick:function(d){a.folderId=d.id;a._loadFileData();if(d.name.indexOf("【系统】")!=-1){$("#uploader").hide();$("#fileContainer").show();$("#uploadBtn").hide();
}else{var c=$("#uploadBtn");if(c.text()==="取消上传"){c.trigger("click");}else{$("#uploadBtn").show();}}}};ZtreeUtils.init(b);},_bindEventHandler:function(){var a=this;
$("#fileContainer").on("mouseenter",".photo-item-edit",function(){if(!$(this).hasClass("photo-item-shadow-red")){$(this).addClass("photo-item-edit-default");
}});$("#fileContainer").on("mouseleave",".photo-item-edit",function(){$(this).removeClass("photo-item-edit-default");});if(this.isMultiple==1){$("#fileContainer").on("click",".selectSystemFile",function(b){b.stopPropagation();
$.log("click");if(!$(this).parent().parent().hasClass("photo-item-shadow-red")){$(this).parent().parent().removeClass("photo-item-edit-default");$(this).parent().parent().addClass("photo-item-shadow-red");
}else{$(this).parent().parent().removeClass("photo-item-shadow-red");}});$("#fileContainer").on("click",".photo-item-edit",function(){if(!$(this).hasClass("photo-item-shadow-red")){$(this).removeClass("photo-item-edit-default");
$(this).addClass("photo-item-shadow-red");}else{$(this).removeClass("photo-item-shadow-red");}});}else{if(this.isMultiple==0){$("#fileContainer").on("click",".selectSystemFile",function(b){b.stopPropagation();
$(".photo-item-edit").removeClass("photo-item-shadow-red");if(!$(this).parent().parent().hasClass("photo-item-shadow-red")){$(this).parent().parent().removeClass("photo-item-edit-default");
$(this).parent().parent().addClass("photo-item-shadow-red");}else{$(this).parent().parent().removeClass("photo-item-shadow-red");}});$("#fileContainer").on("click",".photo-item-edit",function(){$(".photo-item-edit").removeClass("photo-item-shadow-red");
if(!$(this).hasClass("photo-item-shadow-red")){$(this).removeClass("photo-item-edit-default");$(this).addClass("photo-item-shadow-red");}else{$(this).removeClass("photo-item-shadow-red");
}});}}$("#uploadBtn").click(function(){if($(this).text()=="取消上传"){$("#uploader").hide();$("#fileContainer").show();$(this).text("上传文件");$(this).removeClass("btn-danger");
$(this).addClass("btn-primary");}else{$(this).text("取消上传");$("#fileContainer").hide();$("#uploader").show();$(this).removeClass("btn-primary");$(this).addClass("btn-danger");
a._bindWebuploader();}$(this).show();});},_bindWebuploader:function(){var c=this;var b=[];var d=0;function e(j,h){if(h.flag){var l=h.localPath;var m=h.fileName;
var k=h.byteCount;var i={path:l,name:m,cateId:c.folderId,byteCount:k,sort:d++,saveType:"relative"};b.push(i);}}function a(h,i){alert("上传"+h.name+"失败，原因是"+i);
}function f(){FormUtils.submit(SelectSystemFile._CONS_.SAVE_ADD_URL,$.param({fileJson:JSON.stringify(b)}),function(h){$("#fileContainer").show().append(c._createFileStr(h));
$("#uploadBtn").text("上传文件");$("#uploadBtn").removeClass("btn-danger");$("#uploadBtn").addClass("btn-primary");$("#uploader").hide();});}var g=new JTWebUploader({config:SelectSystemFile._CONS_.UPLOAD_PARAMS,container:"uploader","caption":"支持上传："+SelectSystemFile._CONS_.UPLOAD_PARAMS.acceptTypes+"格式文件，单个文件最大为50MB",success:e,error:a,finish:f});
g.init();},_loadFileData:function(){var a=this;FormUtils.loadData(SelectSystemFile._CONS_.LOAD_FILE_URL+"?cateId="+this.folderId,function(b){$("#fileContainer").show().empty().append(a._createFileStr(b));
});},_createFileStr:function(d){if(d&&d.length){var f=new StringBuffer();for(var c=0;c<d.length;c++){var b=d[c];var a=ImageUtils.getFileCoverUrl(b.name);
var e=b.name;f.append("<div value='"+b.id+"' imageByteCount='"+b.byteCount+"' imageUrl='"+b.path+"' imageName='"+b.name+"' class='photo-item-edit'>").append("<div>").append("<img alt='image' class='selectSystemFile' style='width: 100px; height: 100px;' src='"+a+"' />").append("</div>").append("<div class='item-ft'>").append("<div>").append("<span style='height: 20px; overflow: hidden; font-size: 8px;' title='"+b.name+"'>"+e+"</span>").append("</div>").append("</div>").append("<div style='clear: both'>").append("</div>").append("</div>");
}return f.toString();}}};