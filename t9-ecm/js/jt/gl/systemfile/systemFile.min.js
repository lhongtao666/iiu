function SystemFile(){this.userId=userId;this.type=type;this.folderId="";}SystemFile._CONS_={TYPE_KEY:"system",CATE_P_KEY:"default-file",LOAD_FOLDER_DATA_URL:ctx+"/gl/systemfile/systemFile/listFolder.htm",LOAD_FILE_DATA_URL:ctx+"/gl/systemfile/systemFile/listFile.htm",DELETE_URL:ctx+"/gl/systemfile/systemFile/delete.htm",DELETE_FOLDER_URL:ctx+"/gl/systemfile/systemFile/deleteFolder.htm",SAVE_ADD_URL:ctx+"/gl/systemfile/systemFile/saveAdd.htm",UPLOAD_PARAMS:{"acceptTypes":"silk,css,htm,txt,html,zip,rar,doc,docx,pdf,ppt,pptx,js,log,swf,xls,xlsx,mp4,amr,mp3","fileNumLimit":300,"fileSingleSizeLimit":1*1024*1024*50,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
SystemFile.prototype={init:function(){this._loadFolderTree();this._bindEventHandler();$("#fileContainer").show();$("#uploadFileContainer").hide();$("#folderFormContainer").hide();
$(".addFolderBtn").show();this._hideNotGrantBtn();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("sys.delete.img")){$("button.batchManageBtn").hide();
}},_loadFolderTree:function(){var a=this;var c="";if(this.userId){c="user";}else{c="system";}var b={treeId:"folderTree",cateTypeKey:"system",rootKey:"default-file",userId:this.userId,type:c,disabledRoot:true,contextMenu:{upload:{isShow:true,title:"上传附件",clazz:"uploadFileBtn"},add:{isShow:true,title:"添加文件夹",clickFn:function(d){},clazz:"addFileBtn"},update:{isShow:true,title:"更新文件夹",clickFn:function(){},clazz:"updateFileBtn"},del:{isShow:true,title:"删除文件夹",clickFn:function(e){var d={title:"您确定要删除《"+e.name+"》吗",text:msgCode.DELETE_TEXT,confirmButtonText:"确认",yesFunc:function(){FormUtils.del(SystemFile._CONS_.DELETE_FOLDER_URL,e.id,function(f){if(f.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$.fn.zTree.getZTreeObj("folderTree").removeNode(e);$("#fileContainer").empty();}else{DialogUtils.error(msgCode.FAIL,f.msg);}});}};DialogUtils.confirmWithOptions(d);
},clazz:"deleteFileBtn"},},saveFn:function(d){a._selectFolder(d.id);},onClick:function(d){a._selectFolder(d.id);}};ZtreeUtils.init(b);},_selectFolder:function(a){this.folderId=a;
$("button.uploadFileBtn").show();$("button.cancelUploadFileBtn").hide();$("button.cancelDeleteBatchBtn").trigger("click");this._loadSystemFile();},_loadSystemFile:function(){var a=this;
FormUtils.loadData(SystemFile._CONS_.LOAD_FILE_DATA_URL+"?cateId="+this.folderId,function(b){var c=new StringBuffer();if(b!=null&&b.length>0){$("#fileContainer").show();
$("#uploadFileContainer").hide();$("#fileContainer").empty().append(FileUtils.createFileDivStr(b));}else{$("#fileContainer").show();$("#uploadFileContainer").hide();
$("#fileContainer").empty();}});},_bindEventHandler:function(){var a=this;$(".batchManageBtn").on("click",function(){a._status="selecting";$("button.batchManageBtn").hide();
$("button.deleteBatchBtn").show();$("button.cancelDeleteBatchBtn").show();$("img.deleteFile").hide();FileUtils.offEventHander();});$("#fileContainer").on("click",".file",function(){if(a._status=="selecting"){var b=$(this).find("img.deleteFile");
if(b.is(":visible")){b.hide();}else{b.attr("src",ctx+"/img/jt/success.png");b.show();}}});$("button.deleteBatchBtn").on("click",function(){var c=[];$("img.deleteFile").each(function(){if($(this).is(":visible")&&$(this).attr("src").endWith("success.png")){var d=$(this).attr("idVal");
c.push(d);}});if(c&&c.length){var b={title:"确定要删除"+c.length+"个附件吗",yesFunc:function(){FormUtils.submit(SystemFile._CONS_.DELETE_URL,{ids:c},function(d){DialogUtils.success(msgCode.SUCCESS,"删除成功");
a._loadSystemFile();$("button.cancelDeleteBatchBtn").trigger("click");});}};DialogUtils.confirmWithOptions(b);}});$("button.cancelDeleteBatchBtn").on("click",function(){$("button.batchManageBtn").show();
$("button.deleteBatchBtn").hide();$("button.cancelDeleteBatchBtn").hide();$("img.deleteFile").each(function(){$(this).attr("src",ctx+"/img/jt/delete.png");
}).show();a._status="";FileUtils.bindEventHandler(function(b){FormUtils.submit(SystemFile._CONS_.DELETE_URL,{ids:b},function(){DialogUtils.success(msgCode.SUCCESS,"删除成功");
});});});FileUtils.bindEventHandler(function(b){FormUtils.submit(SystemFile._CONS_.DELETE_URL,{ids:b},function(){DialogUtils.success(msgCode.SUCCESS,"删除成功");
});});$(".uploadFileBtn").on("click",function(){if(a.folderId){$("#fileContainer").hide();$("#uploadFileContainer").show();a._bindWebuploader();$("button.uploadFileBtn").hide();
$("button.cancelUploadFileBtn").show();$("button.batchManageBtn").hide();$("button.deleteBatchBtn").hide();$("button.cancelDeleteBatchBtn").hide();}else{DialogUtils.error(msgCode.SUCCESS,"请添加文件夹后再上传附件");
}});$(".cancelUploadFileBtn").on("click",function(){$("#fileContainer").show();$("#uploadFileContainer").hide();$("button.cancelUploadFileBtn").hide();
$("button.uploadFileBtn").show();$("button.cancelDeleteBatchBtn").trigger("click");});$("#fileContainer").on("mouseenter",".file-box",function(){if(a._status!="selecting"){$(this).addClass("animated "+"pulse");
}});$("#fileContainer").on("mouseleave",".file-box",function(){if(a._status!="selecting"){var b=$(this);window.setTimeout(function(){b.removeClass("animated "+"pulse");
},2000);}});},_bindWebuploader:function(){var c=this;var b=[];var d=0;function e(j,h){if(h.flag){var l=h.localPath;var m=h.fileName;var k=h.byteCount;var i={path:l,name:m,cateId:c.folderId,byteCount:k,sort:d++,saveType:"relative"};
b.push(i);}}function a(h,i){alert("上传"+h.name+"失败，原因是"+i);}function f(){$("button.cancelUploadFileBtn").trigger("click");FormUtils.submit(SystemFile._CONS_.SAVE_ADD_URL,$.param({fileJson:JSON.stringify(b)}),function(h){$("#fileContainer").append(FileUtils.createFileDivStr(h));
});}var g=new JTWebUploader({config:SystemFile._CONS_.UPLOAD_PARAMS,container:"fileUploader",success:e,error:a,caption:"支持上传："+SystemFile._CONS_.UPLOAD_PARAMS.acceptTypes+"格式文件，单个文件最大为50MB",finish:f});
g.init();}};