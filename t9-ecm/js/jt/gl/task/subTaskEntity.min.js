function TaskEntity(){this.hadInit=false;this.hadInitCalendar=false;this.isEdit=false;this.isFormDataChange=false;this.isDateView=false;this.params="";
this.isUnfinishLoad=false;this.isFinishLoad=false;}TaskEntity._CONS_={EDIT_URL:ctx+"/gl/task/taskEntity/edit.htm",DETAIL_URL:ctx+"/gl/task/taskEntity/detail.htm",DELETE_URL:ctx+"/gl/task/taskEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/task/taskEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/task/taskEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/task/taskEntity/listData.htm",UPDATE_TASK_STATUS:ctx+"/gl/task/taskEntity/updateTaskStatus.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",EDIT_FORM_ID:"taskEntityForm",REVIEW_FORM_ID:"prodEntityFormDiv",LOAD_SO_DETAIL:ctx+"/ec/salesorder/soEntity/detail.htm",LOAD_CS_DETAIL:ctx+"/crm/cs/csEntity/detail.htm",GET_CS_BY_CODE:ctx+"/crm/cs/csEntity/getCsByCode.htm",UNFINISH_GRID:"#unfinishTaskEntityGrid",UNFINISH_PAGER:"#unfinishTaskEntityPager"};
TaskEntity.prototype={_init:function(a){if(!this.hadInit){this.hadInit=true;this._initUnfinishJqgrid();this._initEndJqgrid();this._bindEventHandler();$(TaskEntity._CONS_.UNFINISH_GRID).trigger("resize");
$("#endTaskEntityGrid").trigger("resize");}this._hideButton();this._locateToGlHelp();},_locateToGlHelp:function(){if(choose==3){var a="glHelp.tools.appointedTaskEntity";
}else{var a="glHelp.tools.taskEntity";}glHelpUtil.init(a);},_hideButton:function(){if(choose&&choose=="3"){$(".taskEntityAdd").hide();$(".taskEntityDel").hide();
$(".taskEntityEdit").hide();$(".taskEntityDate").hide();$(".taskEntityList").hide();$(".markTaskDoneStatus").hide();$(".markTaskProcessingStatus").hide();
}},_chooseEmployee:function(a){var c=new EmployeesSelect();var b=0;if(ResUtils.canShow("employeeSelector.button.task")){b:1;}var d={isShowAllGroup:b,grantType:"/task/",isMultiple:0,isSale:0,mode:0,callBack:function(e){if(!a){$("[name='partyName']").val(e[0].name);
$("[name='partyId']").val(e[0].id);}else{a(e);}}};c.init(d);},_bindEventHandler:function(){var a=this;$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(d,c){$("input[name=belongOgn]").val(c);
FormUtils.loadData(TaskEntity._CONS_.EMPLOYEE_LIST_URL+"?groupKeys="+c+"&type=statistics,dept_manager",function(f){var g=new StringBuffer();g.append('<option value="">请选择</option>');
for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}$("#belongEmployee").empty().append(g.toString());
});}};GroupUtils.selectGroupTreeBox(b);});$(".list_wrapper").on("click",".taskEntitySearch",function(){var b=$(this).closest("form").serialize();if(!a.isDateView){a.reloadUnfinishJqgrid(b);
}else{a.useCalendarSearch=true;a.reloadCalendar();}});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$("body").on("click",".endTaskEntityDetail",function(){var c=$(this);var b=c.attr("idVal");if(!b){b=$("#endTaskEntityGrid").jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(b.length>1){DialogUtils.error("错误","不能同时操作多条记录");return;}}if(b){OperateTask.detailTaskDialog({id:b,});
}});$("body").on("click",".taskEntityAdd",function(){OperateTask.addTaskDialog({createSuccessFn:function(){a.reloadUnfinishJqgrid();}});});$("body").on("click",".taskEntityDel",function(){var b=a._getMultiSelectedId($(this));
if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;}a._delete(b);});$("body").on("click",".taskEntityEdit",function(){var b=a._getSingleSelectedId($(this));
if(b){OperateTask.editTaskDialog({id:b,updateSuccessFn:function(){a.reloadUnfinishJqgrid();},});}});$("body").on("click",".taskForword",function(){var b=a._getMultiSelectedId($(this));
if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;}var c=b;a._chooseEmployee(function(e){var d=e[0].name;DialogUtils.confirmWithOptions({title:"确定把任务转发给《"+d+"》吗",text:"若任务创建人是你,则可以在指派的待办看到该任务,否则无法看到",confirmButtonText:"确认",yesFunc:function(){var f=jQuery.isArray(c)?c.join(","):c;
FormUtils.submit(ctx+"/gl/task/taskEntity/forward.htm",{ids:f,partyId:e[0].id},function(g){if(g.success){DialogUtils.success(msgCode.INFO,"转发成功");$(".closeDialog").trigger("click");
a.reloadUnfinishJqgrid();}else{DialogUtils.error(msgCode.ERROR,g.msg);}});}});});});$("body").on("click",".taskEntityDate",function(){$(".task-list").hide();
$(".task-calendar").show();if(a.hadInitCalendar==false){a._initCalendar();a.hadInitCalendar=true;}else{a.reloadCalendar();}});$("body").on("click",".taskEntityList",function(){$(".task-calendar").hide();
$(".task-list").show();$(TaskEntity._CONS_.UNFINISH_GRID).trigger("resize");$("#endTaskEntityGrid").trigger("resize");});$("body").on("click",".taskEntityDetail",function(){var b=a._getSingleSelectedId($(this));
if(b){OperateTask.detailTaskDialog({id:b,});}});$("body").on("click",".markTaskDoneStatus",function(){var b=a._getMultiSelectedId($(this));if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;
}a._updateStatus("done",b);});$("body").on("click",".markTaskProcessingStatus",function(){var b=a._getMultiSelectedId($(this));if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;
}a._updateStatus("processing",b);});TaskUtils._bindEventHandler();},_updateStatus:function(a,c){var b=this;FormUtils.del(TaskEntity._CONS_.UPDATE_TASK_STATUS+"?status="+a,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
b.reloadUnfinishJqgrid();if(a=="done"){b.reloadEndJqgrid();}}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},reloadCalendar:function(){if(this.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");
}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(TaskEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadUnfinishJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_getSingleSelectedId:function(b){var a=b.attr("idVal");if(!a){a=$(TaskEntity._CONS_.UNFINISH_GRID).jqGrid("getGridParam","selarrrow");
if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(a.length>1){DialogUtils.error("错误","不能同时操作多条记录");return;}}return a;},_getMultiSelectedId:function(b){var a=b.attr("idVal");
if(!a){a=$(TaskEntity._CONS_.UNFINISH_GRID).jqGrid("getGridParam","selarrrow");if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}}return a;
},_initUnfinishJqgrid:function(a){if(a==null||typeof a==undefined){a={};}this._initJqgrid(a,{type:"unfinish",grid:"#unfinishTaskEntityGrid",pager:"#unfinishTaskEntityPager",url:TaskEntity._CONS_.LIST_DATA_URL+"?taskType=unfinish"});
},reloadUnfinishJqgrid:function(a){this.reloadJqgrid(a,{type:"end",grid:"#unfinishTaskEntityGrid"});},_initEndJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}this._initJqgrid(a,{grid:"#endTaskEntityGrid",pager:"#endTaskEntityPager",url:TaskEntity._CONS_.LIST_DATA_URL+"?taskType=end"});},reloadEndJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}this.reloadJqgrid(a,{grid:"#endTaskEntityGrid"});},reloadJqgrid:function(c,a){var b=this;JTJqgridUtils.reloadJqgrid(a.grid,c);},_initCalendar:function(){var a=this;
$("#calendar").fullCalendar({header:{left:"prev,next",center:"title",right:"month,agendaWeek,agendaDay"},editable:false,droppable:false,drop:function(d,e){var c=$(this).data("eventObject");
var b=$.extend({},c);b.start=d;b.allDay=e;$("#calendar").fullCalendar("renderEvent",b,true);if($("#drop-remove").is(":checked")){$(this).remove();}},events:function(d,f,j){var g=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
var c=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();var h=new StringBuffer();h.append("?Q__D__BW__notify_time_");h.append("=");h.append("["+g+","+c+"]");
h.append("&taskType=unfinish");h.append("&rows=").append("9999999");h.append("&page=").append("1");h.append("&choose=").append("4");var k=$("#taskSearchForm").find("[name=belongOgn]").val();
var e=$("#taskSearchForm").find("[name=belongEmployee]").val();h.append("&belongOgn=").append(k);h.append("&belongEmployee=").append(e);var i="";if(a.useCalendarSearch){i="taskSearchForm";
}else{i="";}var b=TaskEntity._CONS_.LIST_DATA_URL+h.toString();b=b.replace("[","%5B").replace("]","%5D");FormUtils.submitByFormId(b,i,function(l){var o=l.rows;
var n=[];for(var m=0;m<o.length;m++){n.push({id:o[m].id,title:o[m].name,start:o[m].notifyTime,end:o[m].endTime,className:"ellipsis-class",color:o[m].statusColor});
}j(n);},null);},eventClick:function(d,c,b){a._calendarEventClick(d);},});},_calendarEventClick:function(b){var a=this;OperateTask.openDetailTaskDialog(b.id,function(){if(a.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");
}});},_initJqgrid:function(c,a){var b=this;if(c==null||typeof c==undefined){c={};}$(a.grid).JTJqgrid({url:a.url+"&choose="+choose,pager:a.pager,postData:c,colNames:["名称","类型","状态","安排人","跟进人","待办时间","备注"],colModel:[{name:"name",index:"name_",width:170,formatter:function(d,e,f){return"<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'><span>"+TaskUtils.dealTaskName(f)+"</span></div>";
},},{name:"typeName",index:"type_",width:60,},{name:"status",index:"status_",width:60,formatter:function(d,e,f){return f.statusNameStr;},},{name:"createByName",sortable:false,width:60},{name:"partyName",sortable:false,width:60},{name:"notifyTime",index:"notify_time_",width:90,formatter:function(d){return DateUtils.mini2Time(d);
}},{name:"desc",index:"desc_",width:170,formatter:function(f,d,e){return"<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>"+f+"</div>";
},}],ondblClickRow:function(d){var e=$(a.grid).jqGrid("getRowData",d);if(e.status=="awaiting"||e.status=="processing"||e.status=="收集"||e.status=="处理中"){if(choose&&choose=="3"){OperateTask.detailTaskDialog({id:d,});
}else{OperateTask.editTaskDialog({id:d,updateSuccessFn:function(){b.reloadUnfinishJqgrid();},});}}else{OperateTask.detailTaskDialog({id:d,});}}});}};