function TaskEntity(){this.hadInit=false;this.hadInitCalendar=false;this.isEdit=false;this.isFormDataChange=false;this.isDateView=false;this.params="";
this.isUnfinishLoad=false;this.isFinishLoad=false;}TaskEntity._CONS_={EDIT_URL:ctx+"/gl/task/taskEntity/edit.htm",DETAIL_URL:ctx+"/gl/task/taskEntity/detail.htm",DELETE_URL:ctx+"/gl/task/taskEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/task/taskEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/task/taskEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/task/taskEntity/listData.htm",UPDATE_TASK_STATUS:ctx+"/gl/task/taskEntity/updateTaskStatus.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",EDIT_FORM_ID:"taskEntityForm",REVIEW_FORM_ID:"prodEntityFormDiv",LOAD_SO_DETAIL:ctx+"/ec/salesorder/soEntity/detail.htm",LOAD_CS_DETAIL:ctx+"/crm/cs/csEntity/detail.htm",GET_CS_BY_CODE:ctx+"/crm/cs/csEntity/getCsByCode.htm",UNFINISH_GRID:"#unfinishTaskEntityGrid",UNFINISH_PAGER:"#unfinishTaskEntityPager"};
TaskEntity.prototype={_init:function(b){if(!this.hadInit){this.hadInit=true;this._hideNotGrantBtn();var a={};if($("#selfTaskManage").is(":hidden")){if($("#toTaskManage").is(":visible")){a+="&choose="+3;
$("#toTaskManage").addClass("active");$("#toTaskManage").siblings().removeClass("active");this._initUnfinishJqgrid(a);this._initEndJqgrid(a);}else{if($("#subTaskManage").is(":visible")){a+="&choose="+4;
$("#subTaskManage").addClass("active");$("#subTaskManage").siblings().removeClass("active");this._initUnfinishJqgrid(a);this._initEndJqgrid(a);}}}else{this._initUnfinishJqgrid();
this._initEndJqgrid();}this._bindEventHandler();$(TaskEntity._CONS_.UNFINISH_GRID).trigger("resize");$("#endTaskEntityGrid").trigger("resize");}this._hideButton();
this._locateToGlHelp();},_locateToGlHelp:function(){if(choose==3){var a="glHelp.csEntity.taskEntity";}else{var a="glHelp.tools.taskEntity";}glHelpUtil.init(a);
},_hideButton:function(){if(choose&&choose=="3"){$(".taskEntityAdd").hide();$(".taskEntityDel").hide();$(".taskEntityEdit").hide();$(".taskEntityDate").hide();
$(".taskEntityList").hide();$(".markTaskDoneStatus").hide();$(".markTaskProcessingStatus").hide();}else{$(".taskEntityAdd").show();$(".taskEntityDel").show();
$(".taskEntityEdit").show();$(".taskEntityDate").show();$(".taskEntityList").show();$(".markTaskDoneStatus").show();$(".markTaskProcessingStatus").show();
}},_chooseEmployee:function(a){var c=new EmployeesSelect();var b=0;if(ResUtils.canShow("employeeSelector.button.task")){b:1;}var d={isShowAllGroup:b,grantType:"/task/",isMultiple:0,isSale:0,mode:0,callBack:function(e){if(!a){$("[name='partyName']").val(e[0].name);
$("[name='partyId']").val(e[0].id);}else{a(e);}}};c.init(d);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("selfTaskManage.button")){$("#selfTaskManage").hide();
}if(!ResUtils.canShow("subTaskManage.button")){$("#subTaskManage").hide();}if(!ResUtils.canShow("toTaskManage.button")){$("#toTaskManage").hide();}},_bindEventHandler:function(){var a=this;
$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(d,c){$("input[name=belongOgn]").val(c);
FormUtils.loadData(TaskEntity._CONS_.EMPLOYEE_LIST_URL+"?groupKeys="+c+"&type=statistics,dept_manager",function(f){var g=new StringBuffer();g.append('<option value="">请选择</option>');
for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}$("#belongEmployee").empty().append(g.toString());
});}};GroupUtils.selectGroupTreeBox(b);});$(".list_wrapper").on("click",".taskEntitySearch",function(){var b=$(this).closest("form").serialize();b+="&choose="+choose;
if(!a.isDateView){a.reloadUnfinishJqgrid(b);}else{a.useCalendarSearch=true;a.reloadCalendar();}});$(".list_wrapper").on("click",".subTaskEntitySearch",function(){var b=$(this).closest("form").serialize();
b+="&choose="+choose;if(!a.isDateView){a.reloadUnfinishJqgrid(b);}else{a.useCalendarSearch=true;a.reloadCalendar();}});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
c+="&choose="+choose;a.reloadJqgrid(c);return false;}});$(document).on("click","#toTaskManage",function(){choose="3";$(".taskEntityGrid").jqGrid("clearGridData");
$(".task-calendar").hide();$(".task-list").show();var b=$("#taskSearchForm").closest("form").serialize();b+="&choose="+choose;a._hideButton();a._taskFromType(choose);
a.reloadUnfinishJqgrid(b);a.reloadEndJqgrid(b);});$(document).on("click","#selfTaskManage",function(){choose="";$(".taskEntityGrid").jqGrid("clearGridData");
var b=$("#taskSearchForm").closest("form").serialize();b+="&choose="+choose;a._hideButton();a._taskFromType(choose);a.reloadUnfinishJqgrid(b);a.reloadEndJqgrid(b);
if($("#wrapper-content").is(":visible")){$(".taskEntityDate").trigger("click");}});$(document).on("click","#subTaskManage",function(){choose="4";$(".taskEntityGrid").jqGrid("clearGridData");
var b=$("#subTaskSearchForm").closest("form").serialize();b+="&choose="+choose;a._hideButton();a._taskFromType(choose);a.reloadUnfinishJqgrid(b);a.reloadEndJqgrid(b);
if($("#wrapper-content").is(":visible")){$(".taskEntityDate").trigger("click");}});$(document).on("click",".taskManage",function(){$(this).addClass("active");
$(this).siblings().removeClass("active");});$("body").on("click",".endTaskEntityDetail",function(){var c=$(this);var b=c.attr("idVal");if(!b){b=$("#endTaskEntityGrid").jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(b.length>1){DialogUtils.error("错误","不能同时操作多条记录");return;}}if(b){OperateTask.detailTaskDialog({id:b,});
}});$("body").on("click",".taskEntityAdd",function(){OperateTask.addTaskDialog({createSuccessFn:function(){a.reloadUnfinishJqgrid(a._reloadData());}});
});$("body").on("click",".taskEntityDel",function(){var b=a._getMultiSelectedId($(this));if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;}a._delete(b);
});$("body").on("click",".taskEntityEdit",function(c){var b=$(this).attr("idVal");if(!b){b=a._getSingleSelectedId($(this));}if(b){OperateTask.editTaskDialog({id:b,updateSuccessFn:function(){a.reloadUnfinishJqgrid();
},});}});$("body").on("click",".taskForword",function(){var b=a._getMultiSelectedId($(this));if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;
}var c=b;a._chooseEmployee(function(e){var d=e[0].name;DialogUtils.confirmWithOptions({title:"确定把任务转发给《"+d+"》吗",text:"若任务创建人是你,则可以在指派的待办看到该任务,否则无法看到",confirmButtonText:"确认",yesFunc:function(){var f=jQuery.isArray(c)?c.join(","):c;
FormUtils.submit(ctx+"/gl/task/taskEntity/forward.htm",{ids:f,partyId:e[0].id},function(g){if(g.success){DialogUtils.success(msgCode.INFO,"转发成功");$(".closeDialog").trigger("click");
a.reloadUnfinishJqgrid(a._reloadData());}else{DialogUtils.error(msgCode.ERROR,g.msg);}});}});});});$("body").on("click",".taskEntityDate",function(){$(".task-list").hide();
$(".task-calendar").show();if(a.hadInitCalendar==false){a._initCalendar();a.hadInitCalendar=true;}else{a.reloadCalendar();}});$("body").on("click",".taskEntityList",function(){$(".task-calendar").hide();
$(".task-list").show();$(TaskEntity._CONS_.UNFINISH_GRID).trigger("resize");$("#endTaskEntityGrid").trigger("resize");});$("body").on("click",".taskEntityDetail",function(c){var b=$(this).attr("idVal");
if(!b){b=a._getSingleSelectedId($(this));}if(b){OperateTask.detailTaskDialog({id:b,});}c.preventDefault();c.stopPropagation();});$("body").on("click",".markTaskDoneStatus",function(){var b=a._getMultiSelectedId($(this));
if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;}a._updateStatus("done",b);});$("body").on("click",".markTaskProcessingStatus",function(){var b=a._getMultiSelectedId($(this));
if(($.isArray(b)&&!b.length)||(!$.isArray(b)&&!b)){return;}a._updateStatus("processing",b);});TaskUtils._bindEventHandler();},_taskFromType:function(a){if(a==4){$("#taskSearchForm").hide();
$("#subTaskSearchForm").show();}else{$("#taskSearchForm").show();$("#subTaskSearchForm").hide();}},_updateStatus:function(a,c){var b=this;FormUtils.del(TaskEntity._CONS_.UPDATE_TASK_STATUS+"?status="+a,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
b.reloadUnfinishJqgrid(b._reloadData());if(a=="done"){b.reloadEndJqgrid(b._reloadData());}}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},reloadCalendar:function(){if(this.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");
}},_reloadData:function(){var a="";if($("#taskSearchForm").is(":visible")){a=$("#taskSearchForm").closest("form").serialize();}else{if($("#subTaskSearchForm").is(":visible")){a=$("#subTaskSearchForm").closest("form").serialize();
}}a+="&choose="+choose;return a;},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(TaskEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadUnfinishJqgrid(a._reloadData());}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_getSingleSelectedId:function(b){var a=b.attr("idVal");if(!a){a=$(TaskEntity._CONS_.UNFINISH_GRID).jqGrid("getGridParam","selarrrow");
if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(a.length>1){DialogUtils.error("错误","不能同时操作多条记录");return;}}return a;},_getMultiSelectedId:function(b){var a=b.attr("idVal");
if(!a){a=$(TaskEntity._CONS_.UNFINISH_GRID).jqGrid("getGridParam","selarrrow");if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}}return a;
},_initUnfinishJqgrid:function(a){this._initJqgrid(a,{type:"unfinish",grid:"#unfinishTaskEntityGrid",pager:"#unfinishTaskEntityPager",url:TaskEntity._CONS_.LIST_DATA_URL+"?taskType=unfinish"});
},reloadUnfinishJqgrid:function(a){this.reloadJqgrid(a,{type:"end",grid:"#unfinishTaskEntityGrid"});},_initEndJqgrid:function(a){this._initJqgrid(a,{grid:"#endTaskEntityGrid",pager:"#endTaskEntityPager",url:TaskEntity._CONS_.LIST_DATA_URL+"?taskType=end"});
},reloadEndJqgrid:function(a){this.reloadJqgrid(a,{grid:"#endTaskEntityGrid"});},reloadJqgrid:function(c,a){var b=this;JTJqgridUtils.reloadJqgrid(a.grid,c);
},_initCalendar:function(){var a=this;$("#calendar").fullCalendar({header:{left:"prev,next",center:"title",right:"month,agendaWeek,agendaDay"},editable:false,droppable:false,drop:function(d,e){var c=$(this).data("eventObject");
var b=$.extend({},c);b.start=d;b.allDay=e;$("#calendar").fullCalendar("renderEvent",b,true);if($("#drop-remove").is(":checked")){$(this).remove();}},events:function(d,f,j){var g=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
var c=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();var h=new StringBuffer();h.append("?Q__D__BW__notify_time_="+g);h.append("&Q__D__BW__notify_time_="+c);
h.append("&taskType=unfinish");h.append("&rows=").append("9999999");h.append("&page=").append("1");if(choose==4){h.append("&choose=").append("4");var k=$("#taskSearchForm").find("[name=belongOgn]").val();
var e=$("#taskSearchForm").find("[name=belongEmployee]").val();h.append("&belongOgn=").append(k);h.append("&belongEmployee=").append(e);}var i="";if(a.useCalendarSearch){i="taskSearchForm";
}else{i="";}var b=TaskEntity._CONS_.LIST_DATA_URL+h.toString();b=b.replace("[","%5B").replace("]","%5D");FormUtils.submitByFormId(b,i,function(l){var o=l.rows;
var n=[];for(var m=0;m<o.length;m++){var p=new StringBuffer();p.append("<span class='taskEntityDetail' idVal='"+o[m].id+"' >"+o[m].name+"</span>");n.push({id:o[m].id,title:o[m].name,start:o[m].notifyTime,end:o[m].endTime,className:"ellipsis-class",color:o[m].statusColor});
}j(n);},null);},eventClick:function(d,c,b){a._calendarEventClick(d);},});},_calendarEventClick:function(b){var a=this;OperateTask.openDetailTaskDialog(b.id,function(){if(a.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");
}});},_getManagerBtns:function(b){var a=[];a.push({lable:"明细",btnClasses:"btn btn-primary taskEntityDetail",iconClasses:"fa fa-list"});if(b!="unfinish"){return a;
}if(choose!=3){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger taskEntityDel",iconClasses:"fa fa-remove"});}if(choose!=3){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary taskEntityEdit",iconClasses:"fa fa-edit"});
}a.push({switchCol:{colName:"status",colVals:["collect","awaiting","processing"],colLables:[["转工号"],["转工号"],["转工号"],],btnClasses:[["btn btn-primary taskForword"],["btn btn-primary taskForword"],["btn btn-primary taskForword"],]}});
if(choose!=3){a.push({switchCol:{colName:"status",colVals:["awaiting","processing"],colLables:[["标记为处理中"],["标记为完成"],],btnClasses:[["btn btn-success markTaskProcessingStatus"],["btn btn-info markTaskDoneStatus"]]}});
}return a;},_initJqgrid:function(c,a){var b=this;if(c==null||typeof c==undefined){c={};}c.choose=choose;$(a.grid).JTJqgrid({url:a.url,pager:a.pager,postData:c,colNames:["名称","类型","状态","安排人","跟进人","待办时间","备注","操作"],colModel:[{name:"name",index:"name_",width:170,formatter:function(d,e,f){return"<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'><span class=''>"+TaskUtils.dealTaskName(f)+"</span></div>";
},},{name:"typeName",index:"type_",width:60,},{name:"status",index:"status_",width:60,formatter:function(d,e,f){return f.statusNameStr;},},{name:"createByName",sortable:false,width:60,},{name:"partyName",sortable:false,width:60,},{name:"notifyTime",index:"notify_time_",width:90,formatter:function(d){return DateUtils.mini2Time(d);
}},{name:"desc",index:"desc_",width:170,formatter:function(f,d,e){return"<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>"+f+"</div>";
},},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns(a.type),}],ondblClickRow:function(f,i,d,h){h.preventDefault();
h.stopPropagation();var g=$(a.grid).jqGrid("getRowData",f);if(g.status=="awaiting"||g.status=="processing"||g.status=="收集"||g.status=="处理中"){if(choose&&choose=="3"){OperateTask.detailTaskDialog({id:f,});
}else{OperateTask.editTaskDialog({id:f,updateSuccessFn:function(){b.reloadUnfinishJqgrid();},});}}else{OperateTask.detailTaskDialog({id:f,});}}});}};