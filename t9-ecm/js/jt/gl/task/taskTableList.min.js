var TaskTableList=function(){this.hadInit=false;this.hadInitCalendar=false;this.isEdit=false;this.isFormDataChange=false;this.isDateView=false;this.params="";
this.entityId="";this.type="";this.enable=true;this.refreshCalendar=null;this.refreshList=null;this.typeName="";this.entityName="";this.addButtonSelector="";
this.cancelButtonSelector="";};TaskTableList._CONS_={EDIT_URL:ctx+"/gl/task/taskEntity/edit.htm",DETAIL_URL:ctx+"/gl/task/taskEntity/detail.htm",DELETE_URL:ctx+"/gl/task/taskEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/task/taskEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/task/taskEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/task/taskEntity/listData.htm",LIST_ALL_DATA_URL:ctx+"/gl/task/taskEntity/listAllByEntityId.htm",UPDATE_TASK_STATUS:ctx+"/gl/task/taskEntity/updateTaskStatus.htm",EDIT_FORM_ID:"taskEntityForm",GRID:"#taskEntityGrid",PAGER:"#taskEntityPager"};
TaskTableList.prototype={init:function(a,b){if(!this.hadInit){this.hadInit=true;this.addButtonSelector=a;this.cancelButtonSelector=b;this._initEventHander();
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("taskEntity.button.edit")){$(".add-entity-task").hide();}if(!ResUtils.canShow("taskEntity.button.forward")){$(".taskEntityDel").hide();
}if(!ResUtils.canShow("taskEntity.button.saveAddReview")){$(".saveRelOrgBtn").hide();}if(!ResUtils.canShow("taskEntity.button.delete")){$(".taskEntityDel").hide();
}if(!ResUtils.canShow("taskEntity.button.updateTaskStatus")){$(".update-status").hide();}},reInit:function(d,b,a,c){this.entityId=b;this.type=d;this.entityName=c;
this.typeName=a;this._hideNotGrantBtn();this._destoryCalendar();},_initCalendar:function(){var a=this;$("#calendar").fullCalendar({header:{left:"prev,next",center:"title",right:"month,agendaWeek,agendaDay"},editable:false,droppable:false,drop:function(d,e){var c=$(this).data("eventObject");
var b=$.extend({},c);b.start=d;b.allDay=e;$("#calendar").fullCalendar("renderEvent",b,true);if($("#drop-remove").is(":checked")){$(this).remove();}},events:function(h,b,g){var d=h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();
var c=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate();var f=new StringBuffer();f.append("?Q__D__BW__create_time_");f.append("=");f.append("["+d+","+c+"]");
f.append("&Q__S__EQ__entity_id_="+a.entityId);f.append("&Q__S__EQ__type_="+a.type);f.append("&rows=").append("9999999");f.append("&page=").append("1");
var e="";if(a.useCalendarSearch){e="taskSearchForm";}else{e="";}FormUtils.submitByFormId(TaskTableList._CONS_.LIST_DATA_URL+f.toString(),e,function(j){var n=j.rows;
var m=[];for(var l=0;l<n.length;l++){var k="";switch(n[l].status){case"collect":k="#DBDBDB";break;case"awaiting":k="#F8CD9D";break;case"processing":k="#6BB4E3";
break;case"done":k="#6FE2E3";break;case"expired":k="#F199A3";break;}m.push({id:n[l].id,title:n[l].name,start:n[l].createTime,color:k});}g(m);},null);},eventClick:function(d,c,b){a._calendarEventClick(d);
},});},_destoryCalendar:function(){this.isDateView=false;this._showListWrapper();$("#calendar").fullCalendar("destroy");this.hadInitCalendar=false;},_calendarEventClick:function(b){var a=this;
OperateTask.openDetailTaskDialog(b.id,function(){if(a.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");}});},clear:function(b){var a=this;
$("#taskContainer").empty();if(b){a.loadTable(a.params);}},_showTaskDate:function(){var a=this;$(".task-list").hide();$(".task-calendar").show();if(a.hadInitCalendar==false){a._initCalendar();
a.hadInitCalendar=true;}else{a.reloadCalendar();}},_showListWrapper:function(){$(".task-list").show();$(".task-calendar").hide();},_clickSwitchView:function(){if(!this.isDateView){this._showTaskDate();
$(".switch-label").text("切换为列表");}else{this._showListWrapper();$(".switch-label").text("切换为日历");}this.isDateView=!this.isDateView;},reloadCalendar:function(){if(this.hadInitCalendar){$("#calendar").fullCalendar("refetchEvents");
}},_updateStatus:function(a,c,d,e){var b=this;FormUtils.del(TaskTableList._CONS_.UPDATE_TASK_STATUS+"?status="+a,c,function(f){if(f.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
if(d){d(e);}else{b.clear(true);}}else{DialogUtils.error(msgCode.ERROR,f.msg);}});},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(TaskTableList._CONS_.DELETE_URL,b,function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
if(b instanceof Array){for(var c=0;c<b.length;c++){a.reloadRowData(b[c],true);}}else{a.reloadRowData(b,true);}}else{DialogUtils.error(msgCode.ERROR,d.msg);
}});});},reloadRowData:function(d,c){var a=this;if(c){var b=$("tr[idVal="+d+"]");b.replaceWith("");return;}FormUtils.loadData(TaskTableList._CONS_.EDIT_URL+"?id="+d,function(f){var e=$("tr[idVal="+d+"]");
e.replaceWith(a._dealRow(f));});},loadTable:function(b){var a=this;if(b==null||typeof b==undefined){var c=new StringBuffer();c.append("Q__S__EQ__entity_id_="+a.entityId);
c.append("&entityId="+a.entityId);c.append("&taskType="+a.type);b=c.toString();}a.params=b;$("#taskContainer").empty();FormUtils.submit(TaskTableList._CONS_.LIST_ALL_DATA_URL,b,function(d){$("#taskContainer").append(a._dealRows(d));
});},showTasks:function(){$(".relate-task").show();},hideTasks:function(){$(".relate-task").hide();},_initEventHander:function(){var a=this;if(a.addButtonSelector){$(document).on("click",a.addButtonSelector,function(){a.hideTasks();
});}if(a.cancelButtonSelector){$(document).on("click",a.cancelButtonSelector,function(){a.showTasks();});}$("#taskContainer").on("click",".td",function(c){if(a.enable){var b=$(this).parent("tr").attr("idVal");
console.log("row-"+b);OperateTask.openDetailTaskDialog(b,function(){a.reloadRowData(b);});c.stopPropagation();}});$(document).on("click",".taskEntityDate",function(){a._clickSwitchView();
});$(document).on("click",".add-entity-task",function(){OperateTask.openAddTaskDialog(a.type,a.entityId,a.typeName,a.entityName,function(){a.loadTable();
});});$("#taskContainer").on("click",".taskEntityDelete",function(c){if(a.enable){var b=$(this).attr("idVal");console.log("delete-"+b);a._delete(b);c.stopPropagation();
}});$("#taskContainer").on("click",".update-status",function(d){if(a.enable){var b=$(this).attr("idVal");var c=$(this).attr("statusVal");console.log("updatestatus-status-"+c+"--"+b);
a._updateStatus(c,b,function(){a.reloadRowData(b);},b);d.stopPropagation();}});},_disableForm:function(){var a=this;a.enable=false;$(".operation").attr("disabled","disabled").hide();
},_enableForm:function(){var a=this;a.enable=true;$(".operation").attr("disabled","").show();},_dealRows:function(c){var a=this;var d=new StringBuffer();
for(var b=0;b<c.length;b++){d.append(a._dealRow(c[b]));}return d.toString();},_dealRow:function(b){var a=this;var c=new StringBuffer();c.append('<tr class="task-row" idVal="'+b.id+'">');
c.append('<td class="td">');c.append((function(d){var e=new StringBuffer();e.append("<div style='width:95%;' class='ellipsis-class'>");e.append(d);e.append("</div>");
return e.toString();})(b.name));c.append("</td>");c.append('<td class="td">');c.append(a._dealStatus(b.status));c.append("</td>");c.append('<td class="td">');
c.append((function(e){var d="";switch(e){case"simple":d="日常任务";break;case"jt_cs_care":d="客户关怀";break;case"jt_cs_complain":d="客户投诉";break;case"jt_contract_entity":d="合同";
break;case"jt_oppo_entity":d="商机";break;}return d;})(b.type));c.append("</td>");c.append('<td class="td">');c.append(b.endTime);c.append("</td>");c.append('<td class="td">');
c.append(b.notifyCount);c.append("</td>");c.append('<td class="td">');c.append(b.createTime);c.append("</td>");c.append('<td class="td">');c.append(b.updateTime);
c.append("</td>");c.append('<td class="td">');c.append(b.partyName);c.append("</td>");c.append('<td class="td">');c.append(b.createByName);c.append("</td>");
c.append("<td >");c.append(a._dealOperateBtn(b.id,b.status));c.append("</td>");c.append("</tr>");return c.toString();},_dealStatus:function(b){var a="";
var c="";switch(b){case"awaiting":c="label-warning";a="待办";break;case"processing":a="处理中";c="label-success";break;case"done":a="处理完毕";c="label-info";break;
case"expired":a="过期";c="label-danger";break;}var d=new StringBuffer();d.append("<label type='label' disabled='disabled' class='label "+c+"'>");d.append(a);
d.append("</label>");return d.toString();},_dealOperateBtn:function(c,a){var b=new StringBuffer();b.append('<div class="btn-group operation">');b.append('<button data-toggle="dropdown" class="btn btn-default dropdown-toggle ">操作 <span class="caret"></span>');
b.append("</button>");b.append('<ul class="dropdown-menu">');b.append("<li>");b.append('<button type="button" class="btn btn-outline btn-danger btn-block taskEntityDelete" idVal="'+c+'" >删除</button>');
b.append("</li>");if(a=="awaiting"){b.append("<li>");b.append('<button type="button" statusVal="processing" idVal="'+c+'"  class="btn btn-outline btn-success btn-block update-status">标记为处理中</button>');
b.append("</li>");}if(a=="processing"){b.append("<li>");b.append('<button type="button" statusVal="done" idVal="'+c+'"  class="btn btn-outline btn-info btn-block update-status">标记为完成</button>');
b.append("</li>");}b.append("</ul>");b.append("</div>");return b.toString();},};