$(function(){var a=new Tag();a.init();});function Tag(){}Tag._CONS_={SAVE_ADD_URL:ctx+"/gl/eav/tag/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/eav/tag/saveEdit.htm",EDIT_URL:ctx+"/gl/eav/tag/edit.htm",};
Tag.prototype={init:function(){this._bindEventHanlder();this._bindFormValidation();this._loadData();this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.systemconfig.tag";
glHelpUtil.init(a);},_loadData:function(){var a=this;FormUtils.loadData(Tag._CONS_.EDIT_URL,function(d){if(d.id){$("input[name='id']").val(d.id);$("input[name='name']").val(d.name);
$("input[name='key']").val(d.key);$("textarea[name='comment']").val(d.comment);$("input[name='sort']").val(d.sort);$("input[name='createBy']").val(d.createBy);
$("input[name='createTime']").val(d.createTime);$("input[name='status']").val(d.status);if(d.skuItems.length){for(var c=0;c<d.skuItems.length;c++){var b=d.skuItems[c];
a._addSkuTr(b.id,b.name,b.skuItemOptPos);}}}else{$("input[name='key']").val("cs_tag");$(".editBtn").text("添加");}a._disableForm();});},_disableForm:function(){$(".saveBtn").hide();
$(".prevBtn").hide();$(".editBtn").show();FormUtils.disableForm("eavSetForm");$(".deleteAttrBtn").hide();$(".editAttrBtn").hide();$(".addNewAttrBtn").hide();
$(".removeSkuAttrBtn").hide();$("#addSkuTrBtn").hide();$("input[name='key']").attr("readonly","readonly");},_enableForm:function(){$(".saveBtn").show();
$(".prevBtn").show();$(".editBtn").hide();FormUtils.enableForm("eavSetForm");$(".deleteAttrBtn").show();$(".editAttrBtn").show();$(".addNewAttrBtn").show();
$(".removeSkuAttrBtn").show();$("#addSkuTrBtn").show();$("input[name='key']").attr("readonly","readonly");},_bindEventHanlder:function(){var a=this;$(".editBtn").on("click",function(){a._enableForm();
});$("#skuAttrContainer").on("click",".deleteAttrBtn",function(){var b=$("input[name='id']").val(),d=$(this).parents("tr").attr("idVal"),e=$(this).parents("li"),c=e.attr("nameVal");
FormUtils.submit(ctx+"/gl/eav/tag/hasRecordValue.htm",{tagEavSetId:b,attrId:d,tagOptName:c},function(g){if(g.success){var f={title:"该标签已经录入客户跟进数据，是否要删除",text:"点击保存，将一起删除客户跟进数据",yesFunc:function(){e.remove();
}};DialogUtils.confirmWithOptions(f);}else{e.remove();}});});$("#skuAttrContainer").on("click",".editAttrBtn",function(){$("#csTagContainer").modal("show");
var e=$(this).parents("li").attr("nameVal");var c=$(this).parents("li").attr("optTypeVal");var b=$(this).parents("li").attr("optOptionsVal");var d=$("#csTagForm");
d.find("input[name=optValue]").val(e);d.find("select[name=optType]").val(c);d.find("input[name=optOptions]").val(b);d.find("input[name=attrId]").val($(this).parents("tr").attr("idVal"));
d.find("input[name=nameVal]").val(e);$("select[name=optType]").trigger("change");});$(".prevBtn").on("click",function(){$("#skuAttrContainer").empty();
a._loadData();});$(".saveBtn").on("click",function(){a._save();});$("#saveNewAttrBtn").on("click",function(){var b=$("input[name='newSkuAttrName']").val();
if(!b){$("input[name='newSkuAttrName']").focus();DialogUtils.error(msgCode.ERROR,"客户标签不允许为空");return;}a._addSkuTr("",b);$("input[name='newSkuAttrName']").val("");
});$("#addSkuTrBtn").on("click",function(){$("#addSkuTrContainer").show();$(this).hide();$("#cancelSkuTrBtn").show();});$("#cancelSkuTrBtn").on("click",function(){$("#addSkuTrContainer").hide();
$(this).hide();$("#addSkuTrBtn").show();});$("#skuAttrContainer").on("click",".removeSkuAttrBtn",function(){var b=$(this).parents("tr");DialogUtils.confirm(function(){b.remove();
});});$("body").on("change","select[name=optType]",function(){var b=$(this).val();var c=$(this).parent().next().find("input[name=optOptions]");if("single"==b||"multi"==b){c.show();
}else{c.hide();c.val("");}});$("#skuAttrContainer").on("click",".addNewAttrBtn",function(){var c=$(this).parent().prev().find("input[name=optValue]").val().trim();
var b=$(this).parent().prev().find("select[name=optType]").val().trim();var e=$(this).parent().prev().find("input[name=optOptions]").val().trim();if(!c){DialogUtils.error(msgCode.ERROR,"标签值不能为空");
return;}if(("single"==b||"multi"==b)&&!e){DialogUtils.error(msgCode.ERROR,"选项值不能为空");return;}var d=false;$(this).parents("td").prev().find(".tag-list").find("li").each(function(){if($(this).attr("nameVal")==c){d=true;
return false;}});if(d){DialogUtils.error(msgCode.ERROR,c+"是重复标签值");$(this).parent().prev().find("input").focus();return;}else{var f=new StringBuffer();
f.append("<li nameVal='"+c+"' optTypeVal='"+b+"' optOptionsVal='"+e+"'>");f.append("<a href='javascript: void(0);'>"+c);f.append("&nbsp;&nbsp;<button class='btn btn-primary btn-xs editAttrBtn' type='button'><i class='fa fa-edit'></i></button>");
f.append("&nbsp;<button class='btn btn-danger btn-xs deleteAttrBtn' type='button'><i class='fa fa-remove'></i></button>");f.append("</a>");f.append("</li>");
$(this).parent().prev().find("input").val("");$(this).parents("td").prev().find(".tag-list").append(f.toString());}});$(document).on("click","#addNewAttrBtn",function(){var c=$(this).parent().parent().find("input[name=optValue]").val().trim();
var b=$(this).parent().parent().find("select[name=optType]").val().trim();var d=$(this).parent().parent().find("input[name=optOptions]").val().trim();var g=$("#csTagForm").find("input[name='attrId']").val();
var f=$("#skuAttrContainer").find("tr[idVal='"+g+"']");var e=$("#csTagForm").find("input[name=nameVal]").val();if(!c){DialogUtils.error(msgCode.ERROR,"标签值不能为空");
return;}if(("single"==b||"multi"==b)&&!d){DialogUtils.error(msgCode.ERROR,"选项值不能为空");return;}f.find(".tag-list").find("li").each(function(){if($(this).attr("nameVal")==e){$(this).attr("nameVal",c);
$(this).attr("optTypeVal",b);$(this).attr("optOptionsVal",d);var h=new StringBuffer();h.append("<a href='javascript: void(0);'>"+c);h.append("&nbsp;&nbsp;<button class='btn btn-primary btn-xs editAttrBtn' type='button'><i class='fa fa-edit'></i></button>");
h.append("&nbsp;<button class='btn btn-danger btn-xs deleteAttrBtn' type='button'><i class='fa fa-remove'></i></button>");$(this).empty().append(h.toString());
$("#csTagContainer").modal("hide");}else{if($(this).attr("nameVal")==c){DialogUtils.error(msgCode.ERROR,c+"是重复标签值");$(this).parent().parent().find("input").focus();
return;}}});});},_isValid:function(){var a=$("#eavSetForm").valid();if(a){if($("#skuAttrContainer").find("tr").length){$("#skuAttrContainer").find("tr").each(function(){if(!$(this).find("td:eq(1)").find("ul li").length){a=false;
DialogUtils.error(msgCode.ERROR,"《"+$(this).find("td:eq(0)").text()+"》属性没有设置标签值");return false;}});return a;}else{DialogUtils.error(msgCode.ERROR,"sku属性不能为空");
return false;}}else{return false;}},_bindFormValidation:function(){var a={rules:{name:{required:true},key:{required:true,chrnum:true}}};jQuery.validator.addMethod("chrnum",function(c,b,e){var d=/^[0-9a-z_]+$/;
return d.test(c);},jQuery.validator.format("由小写字母，数组，下划线组成"));FormUtils.bindFormValidation("eavSetForm",a);},_save:function(){if(!this._isValid()){return;
}if($(".saveBtn").length){ButtonUtils.disableBtn("saveBtn");}var c={};c.id=$("input[name='id']").val()?$("input[name='id']").val():"";c.createBy=$("input[name='createBy']").val()?$("input[name='createBy']").val():"";
c.createTime=$("input[name='createTime']").val()?$("input[name='createTime']").val():"";c.name=$("input[name='name']").val();c.status=$("input[name='status']").val();
c.key="cs_tag";c.comment=$("textarea[name='comment']").val();c.bizType="tag";c.sort=$("input[name='sort']").val()?$("input[name='sort']").val():0;c.entityType="cs";
c.skuItemsJson="";var d=[];$("#skuAttrContainer").find("tr").each(function(){var e={};e.name=$(this).find("td:eq(0)").text().trim();e.key=new Date().getTime()+$(this).index();
e.bizType="tag";e.entityType="cs";e.dataType="options";e.inputType="option_checkbox";e.validateKey="";e.isMain="n";e.id=$(this).attr("idVal");e.sort=$(this).index();
e.status="actived";var f=[];$(this).find("td:eq(1) ul li").each(function(){var g={};g.value=$(this).attr("nameVal");g.type=$(this).attr("optTypeVal");g.options=$(this).attr("optOptionsVal");
f.push(g);});e.skuItemOptPos=f;d.push(e);});c.skuItemsJson=JSON.stringify(d);var b=Tag._CONS_.SAVE_ADD_URL;if(c.id){b=Tag._CONS_.SAVE_EDIT_URL;}var a=this;
FormUtils.submit(b,c,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);a._disableForm();}else{DialogUtils.error(msgCode.ERROR,e.msg);
}if($(".saveBtn").length){ButtonUtils.enableBtn("saveBtn");}},function(){if($(".saveBtn").length){ButtonUtils.enableBtn("saveBtn");}});},_addSkuTr:function(d,a,c){var e=new StringBuffer();
e.append("<tr idVal='"+d+"'>");e.append("<td>"+a+"</td>");e.append("<td>");e.append("<ul class='tag-list' style='padding: 0'>");if(c&&c.length){for(var b=0;
b<c.length;b++){e.append("<li nameVal='"+c[b].value+"' optTypeVal='"+c[b].type+"' optOptionsVal='"+c[b].options+"'>");e.append("<a href='javascript: void(0);'>"+c[b].value);
e.append("&nbsp;&nbsp;<button class='btn btn-primary btn-xs editAttrBtn' type='button'><i class='fa fa-edit'></i></button>");e.append("&nbsp;<button class='btn btn-danger btn-xs deleteAttrBtn' type='button'><i class='fa fa-remove'></i></button>");
e.append("</a>");e.append("</li>");}}e.append("</ul>");e.append("</td>");e.append("<td>");e.append("<div class='col-sm-11'>");e.append("<div class='col-sm-4'>");
e.append("<input type='text' name='optValue' class='col-sm-4 form-control' validateType='default'>");e.append("</div>");e.append("<div class='col-sm-4'>");
e.append("<select class='form-control' name='optType' validateType='default'>");e.append("<option value='string'>字符串</option>");e.append("<option value='single'>单选</option>");
e.append("<option value='multi'>多选</option>");e.append("<option value='double'>浮点</option></select>");e.append("</div>");e.append("<div class='col-sm-4'>");
e.append("<input type='text' placeholder='多个请用中文逗号(，)隔开' class='form-control' name ='optOptions' validateType='default' style='display:none;'>");e.append("</div>");
e.append("</div>");e.append("<div class='col-sm-1'>");e.append("<button class='btn btn-sm btn-primary addNewAttrBtn' type='button'><i class='fa fa-plus'></i></button>");
e.append("</div>");e.append("</td>");e.append("<td><button type='button' class='btn btn-sm btn-danger removeSkuAttrBtn'><i class='fa fa-remove'></i></button></td>");
e.append("</tr>");$("#skuAttrContainer").append(e.toString());$("#addSkuTrContainer").hide();$("#addSkuTrBtn").show();$("#cancelSkuTrBtn").hide();},};