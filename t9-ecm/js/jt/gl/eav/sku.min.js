$(function(){var a=new Sku();a.init();});function Sku(){if(!(this instanceof Sku)){return new Sku();}else{this.eavSet=new EavSet();}}Sku._CONS_={SAVE_ADD_URL:ctx+"/gl/eav/sku/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/eav/sku/saveEdit.htm",EDIT_URL:ctx+"/gl/eav/sku/edit.htm",};
Sku.prototype={init:function(){this._initJqgrid();this._bindEventHandler();this._bindFormValidation();this._hideNotGrantBtn();new Switchery($(".js-switch")[0]);
this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.prodEntity.prodEavAttr.sku";glHelpUtil.init(a);},clear:function(a){FormUtils.clear("eavSetForm");
FormUtils.enableForm("eavSetForm");$("#skuAttrContainer").empty();$("#eavSetForm").find("span.switchery").remove();$("input[name='usedStatusName']").attr("type","hidden");
$("input.js-switch").attr("checked","checked");$("input[name='status']").val("actived");$("input[name='key']").removeAttr("readonly");$("#skusContainer").parents(".form-group").show();
$("#copySkuBtn").removeAttr(".disabled");$("#copySkuBtn").show();$(".saveBtn").show();$("#addSkuTrBtn").show();$("#skuAttrContainer").parents("table").find("tr").each(function(){$(this).find("td:gt(2)").show();
$(this).find("th:gt(2)").show();});new Switchery($(".js-switch")[0]);this.eavSet._showListWrapper();if(a){this.eavSet.reloadJqgrid();}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("sku.button.detail")){$(".eavSetDetail").hide();
}if(!ResUtils.canShow("sku.button.add")){$(".eavSetAdd").hide();}if(!ResUtils.canShow("sku.button.edit")){$(".eavSetEdit").hide();}if(!ResUtils.canShow("sku.button.delete")){$(".eavSetDel").hide();
}},_initJqgrid:function(){this.eavSet._initJqgrid(function(){var a=[];var b={colName:"status",colVals:["inactive","actived","used"],colLables:[[],[],[]],btnClasses:[[],[],[]],iconClasses:[[],[],[]]};
if(ResUtils.canShow("sku.button.edit")){b.colLables[0].push("编辑");b.colLables[1].push("编辑");b.colLables[2].push("编辑");b.btnClasses[0].push("btn btn-primary eavSetEdit");
b.iconClasses[0].push("fa fa-edit");b.btnClasses[1].push("btn btn-primary eavSetEdit");b.iconClasses[1].push("fa fa-edit");b.btnClasses[2].push("btn btn-primary eavSetEdit");
b.iconClasses[2].push("fa fa-edit");}if(ResUtils.canShow("sku.button.delete")){b.colLables[0].push("删除");b.colLables[1].push("删除");b.btnClasses[0].push("btn btn-danger eavSetDel");
b.iconClasses[0].push("fa fa-remove");b.btnClasses[1].push("btn btn-danger eavSetDel");b.iconClasses[1].push("fa fa-remove");}if(ResUtils.canShow("sku.button.detail")){b.colLables[0].push("明细");
b.colLables[1].push("明细");b.colLables[2].push("明细");b.btnClasses[0].push("btn btn-primary eavSetDetail");b.iconClasses[0].push("fa fa-list");b.btnClasses[1].push("btn btn-primary eavSetDetail");
b.iconClasses[1].push("fa fa-list");b.btnClasses[2].push("btn btn-primary eavSetDetail");b.iconClasses[2].push("fa fa-list");}a.push({switchCol:b});return a;
});},reloadJqgrid:function(a){this.eavSet.reloadJqgrid(a);},_bindEventHandler:function(){var a=this;$(".prevBtn").on("click",function(){a.clear(false);
});$("#skuAttrContainer").on("ifChecked","input.icheckInput",function(b){$(this).parents("tr").siblings("tr").find("input.icheckInput").iCheck("uncheck");
$(this).parents("tr").siblings("tr").attr("isMain","n");$(this).parents("tr").attr("isMain","y");});$(".eavSetSearch").on("click",function(){var b={Q__S__LK__name_:$("input[name='Q__S__LK__name_']").val(),Q__S__LK__key_:$("input[name='Q__S__LK__key_']").val(),Q__S__EQ__status_:$("select[name='Q__S__EQ__status_']").val()};
if(b.Q__D__BW__create_time_==","){b.Q__D__BW__create_time_="";}a.reloadJqgrid(b);});$("#eavSetSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".eavSetSearch").eq(0).trigger("click");
}});$("body").on("click",".eavSetAdd",function(){a._add();});$("body").on("click",".eavSetEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(EavSet._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_NO_SELECT_EDIT);return;}if(b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}a._edit(b);});$("body").on("click",".eavSetDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(EavSet._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_NO_SELECT_RECORD);return;}if(b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}a._detail(b);});$("body").on("click",".eavSetDel",function(){var b=$(this).attr("idVal");if(!b){b=$(EavSet._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_NO_SELECT_DELETE);return;}}a.eavSet._delete(b);});$("#copySkuBtn").on("click",function(){var b=$("#skusContainer").val();
if(!b){DialogUtils.error(msgCode.ERROR,"请选择要复制的sku");return;}if($("#skuAttrContainer").find("tr").length){DialogUtils.confirmWithOptions({title:"是否覆盖已经存在的sku属性",text:"覆盖后，已经录入的数据将会丢失",confirmButtonText:"覆盖",yesFunc:function(){FormUtils.loadData(Sku._CONS_.EDIT_URL+"?id="+b,function(e){$("#skuAttrContainer").empty();
if(e.skuItems.length){for(var d=0;d<e.skuItems.length;d++){var c=e.skuItems[d];a._addSkuTr("",c.name,c.skuItemOptPos,c.isMain);}}});}});}else{FormUtils.loadData(Sku._CONS_.EDIT_URL+"?id="+b,function(e){if(e.skuItems.length){for(var d=0;
d<e.skuItems.length;d++){var c=e.skuItems[d];a._addSkuTr("",c.name,c.skuItemOptPos,c.isMain);}}});}});$(".saveBtn").on("click",function(){a._save();});
$("#skuAttrContainer").on("click",".addNewAttrBtn",function(){var b=$(this).parent().prev().find("input").val().trim();if(!b){DialogUtils.error(msgCode.ERROR,"选项值不能为空");
return;}var c=false;$(this).parents("td").prev().find(".tag-list").find("li").each(function(){if($(this).attr("nameVal")==b){c=true;return false;}});if(c){DialogUtils.error(msgCode.ERROR,b+"是重复选项值");
$(this).parent().prev().find("input").focus();return;}else{var d=new StringBuffer();d.append("<li nameVal='"+b+"'>");d.append("<a href='javascript: void(0);'>"+b);
d.append("&nbsp;&nbsp;&nbsp;&nbsp;<button class='btn btn-danger btn-xs deleteAttrBtn' type='button'><i class='fa fa-remove'></i></button>");d.append("</a>");
d.append("</li>");$(this).parent().prev().find("input").val("");$(this).parents("td").prev().find(".tag-list").append(d.toString());}});$("#skuAttrContainer").on("click",".deleteAttrBtn",function(){$(this).parents("li").remove();
});$("#addSkuTrBtn").on("click",function(){$("#addSkuTrContainer").show();$(this).hide();$("#cancelSkuTrBtn").show();});$("#cancelSkuTrBtn").on("click",function(){$("#addSkuTrContainer").hide();
$(this).hide();$("#addSkuTrBtn").show();});$("#skuAttrContainer").on("click",".removeSkuAttrBtn",function(){var b=$(this).parents("tr");DialogUtils.confirm(function(){b.remove();
});});$("#saveNewAttrBtn").on("click",function(){var b=$("input[name='newSkuAttrName']").val();if(!b){$("input[name='newSkuAttrName']").focus();DialogUtils.error(msgCode.ERROR,"sku属性不能为空");
return;}a._addSkuTr("",b);$("input[name='newSkuAttrName']").val("");});$(".js-switch").change(function(){var b=$(this).is(":checked");if(b){$("input[name='status']").val("actived");
}else{$("input[name='status']").val("inactive");}});},_addSkuTr:function(e,b,d,a){var f=new StringBuffer();if(!a){a="n";}f.append("<tr idVal='"+e+"' isMain='"+a+"'>");
f.append("<td width='10%'>"+b+"</td>");f.append("<td width='10%'><input type='checkbox' class='icheckInput'></td>");f.append("<td width='50%'>");f.append("<ul class='tag-list' style='padding: 0'>");
if(d&&d.length){for(var c=0;c<d.length;c++){f.append("<li nameVal='"+d[c].value+"' optTypeVal='"+d[c].type+"' optOptionsVal='"+d[c].options+"'>");f.append("<a href='javascript: void(0);'>"+d[c].value);
f.append("&nbsp;&nbsp;&nbsp;&nbsp;<button class='btn btn-danger btn-xs deleteAttrBtn' type='button'><i class='fa fa-remove'></i></button>");f.append("</a>");
f.append("</li>");}}f.append("</ul>");f.append("</td>");f.append("<td width='20%'>");f.append("<div class='col-sm-10'>");f.append("<input type='text' name='optValue' class='form-control' validateType='default'>");
f.append("</div>");f.append("<div class='col-sm-2'>");f.append("<button class='btn btn-sm btn-outline btn-primary addNewAttrBtn' type='button'><i class='fa fa-plus'></i></button>");
f.append("</div>");f.append("</td>");f.append("<td width='10%'><button type='button' class='btn btn-sm btn-outline btn-danger removeSkuAttrBtn'><i class='fa fa-remove'></i></button></td>");
f.append("</tr>");$("#skuAttrContainer").append(f.toString());$("#addSkuTrContainer").hide();$("#addSkuTrBtn").show();$("#cancelSkuTrBtn").hide();$("#skuAttrContainer").find("tr:last").find(".icheckInput").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",});
if(a&&a=="y"){$("#skuAttrContainer").find("tr:last").find("td:eq(1) input").iCheck("check");}},_add:function(){this._loadSkus();this.eavSet._showFormWrapper();
},_detail:function(a){this._loadSkus();this.eavSet._showFormWrapper();this._loadData(a,false);},_loadSkus:function(){FormUtils.loadData(ctx+"/gl/eav/eavSet/listData.htm?entityType="+entityType+"&Q__S__EQ__biz_type_="+bizType,function(c){var b=c.rows;
var d=new StringBuffer();if(b&&b.length){d.append("<option value=''>请选择</option>");for(var a=0;a<b.length;a++){d.append("<option value='"+b[a].id+"'>"+b[a].name+"</option>");
}}$("#skusContainer").empty().append(d.toString());});},_edit:function(a){this._loadSkus();this.eavSet._showFormWrapper();this._loadData(a,true);},_loadData:function(c,b){var a=this;
if(!b){$(".saveBtn").hide();}FormUtils.loadData(Sku._CONS_.EDIT_URL+"?id="+c,function(f){$("input[name='id']").val(f.id);$("input[name='name']").val(f.name);
$("input[name='key']").val(f.key);$("textarea[name='comment']").val(f.comment);$("input[name='sort']").val(f.sort);$("input[name='createBy']").val(f.createBy);
$("input[name='createTime']").val(f.createTime);$("input[name='status']").val(f.status);if(f.status=="used"){$("#eavSetForm").find("span.switchery").remove();
$("input[name='usedStatusName']").attr("type","text").val("已用");}else{if(f.status=="actived"){$("input.js-switch").attr("checked","checked");}else{$("input.js-switch").removeAttr("checked");
}$("#eavSetForm").find("span.switchery").remove();if(b){new Switchery($(".js-switch")[0]);}else{new Switchery($(".js-switch")[0],{disabled:true});}}if(f.skuItems.length){for(var e=0;
e<f.skuItems.length;e++){var d=f.skuItems[e];a._addSkuTr(d.id,d.name,d.skuItemOptPos,d.isMain);}}if(f.status=="used"){$("input[name='key']").attr("readonly","readonly");
$("#copySkuBtn").hide();$(".removeSkuAttrBtn").hide();$("#addSkuTrBtn").hide();$(".deleteAttrBtn").hide();$("#skusContainer").parents(".form-group").hide();
$("#skuAttrContainer input.icheckInput").iCheck("disable");}if(!b){$("#copySkuBtn").hide();$(".removeSkuAttrBtn").hide();$("#addSkuTrBtn").hide();$(".deleteAttrBtn").hide();
$("#skuAttrContainer input.icheckInput").iCheck("disable");$("#skusContainer").parents(".form-group").hide();$("#skuAttrContainer").parents("table").find("tr").each(function(){$(this).find("th:gt(2)").hide();
$(this).find("td:gt(2)").hide();});FormUtils.disableForm("eavSetForm");}});},_isValid:function(){var b=$("#eavSetForm").valid();if(b){if($("#skuAttrContainer").find("tr").length){var a=false;
$("#skuAttrContainer").find("tr").each(function(){if($(this).attr("isMain")=="y"){a=true;}if(!$(this).find("td:eq(2)").find("ul li").length){b=false;DialogUtils.error(msgCode.ERROR,"《"+$(this).find("td:eq(0)").text()+"》属性没有设置选项值");
return false;}});if(b){if(!a){DialogUtils.error(msgCode.ERROR,"请设置该sku的默认属性");return false;}}return b;}else{DialogUtils.error(msgCode.ERROR,"sku属性不能为空");
return false;}}else{return false;}},_save:function(){if(!this._isValid()){return;}if($(".saveBtn").length){ButtonUtils.disableBtn("saveBtn");}var c=$("input[name='sort']").val()||0;
$("input[name='sort']").val(c);var d="sku";var e="prod";var g=[];$("#skuAttrContainer").find("tr").each(function(){var h={};h.name=$(this).find("td:eq(0)").text().trim();
h.key=new Date().getTime()+$(this).index();h.bizType="sku";h.entityType="prod";h.dataType="options";h.inputType="option_checkbox";h.validateKey="";h.isMain=$(this).attr("isMain");
h.id=$(this).attr("idVal");h.sort=$(this).index();h.status="actived";var i=[];$(this).find("td:eq(2) ul li").each(function(){var j={};j.value=$(this).attr("nameVal");
j.type=$(this).attr("optTypeVal");j.options=$(this).attr("optOptionsVal");i.push(j);});h.skuItemOptPos=i;g.push(h);});var f=$("#eavSetForm").serialize()+"&bizType="+d+"&entityType="+e+"&skuItemsJson="+JSON.stringify(g);
var b=Sku._CONS_.SAVE_ADD_URL;if($("[name=id]").val()){b=Sku._CONS_.SAVE_EDIT_URL;}var a=this;FormUtils.submit(b,f,function(h){if(h.success){DialogUtils.success(msgCode.SUCCESS,h.msg);
a.clear(true);}else{DialogUtils.error(msgCode.ERROR,h.msg);}if($(".saveBtn").length){ButtonUtils.enableBtn("saveBtn");}},function(){if($(".saveBtn").length){ButtonUtils.enableBtn("saveBtn");
}});},_bindFormValidation:function(){var a={rules:{name:{required:true},key:{required:true,chrnum:true}}};jQuery.validator.addMethod("chrnum",function(c,b,e){var d=/^[0-9a-z_]+$/;
return d.test(c);},jQuery.validator.format("由小写字母，数组，下划线组成"));FormUtils.bindFormValidation("eavSetForm",a);},};