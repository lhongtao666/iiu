$(function(){var a=new ApiEntity();a.init();});function ApiEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}ApiEntity._CONS_={EDIT_URL:ctx+"/gl/api/apiEntity/edit.htm",DETAIL_URL:ctx+"/gl/api/apiEntity/detail.htm",DELETE_URL:ctx+"/gl/api/apiEntity/delete.htm",SAVE_ADD_URL:ctx+"/gl/api/apiEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/gl/api/apiEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/gl/api/apiEntity/listData.htm",EDIT_FORM_ID:"apiEntityForm",GRID:"#apiEntityGrid",PAGER:"#apiEntityPager"};
ApiEntity.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._initTree();this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();
this._showListWrapper();CateUtils.getOptions([{typeKey:"system",pKey:"apiBusinessType",container:"nameSearch"}]);CateUtils.getOptions([{typeKey:"system",pKey:"apiOptions",container:"selectApi"},{typeKey:"system",pKey:"apiBusinessType",container:"selectType"}]);
CateUtils.getOptions({typeKey:"system",pKey:"apiParamType",container:"selectParamType",fn:function(b){if(b&&b.length){var f=new StringBuffer();var e="";
for(var c=0;c<b.length;c++){var d="";f.append("<option class='apiLi' idVal='").append(b[c].id).append("' name='"+b[c].name+"'>").append(b[c].name).append("</option>");
}$("#selectParamType").empty().append(f.toString());}}});}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("apiEntity.button.detail")){$(".apiEntityDetail").hide();
}if(!ResUtils.canShow("apiEntity.button.add")){$(".apiEntityAdd").hide();}if(!ResUtils.canShow("apiEntity.button.edit")){$(".apiEntityEdit").hide();}if(!ResUtils.canShow("apiEntity.button.delete")){$(".apiEntityDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$(".createList").show();
FormUtils.clear(ApiEntity._CONS_.EDIT_FORM_ID);FormUtils.enableForm(ApiEntity._CONS_.EDIT_FORM_ID);$("#whiteVisitListContainer").empty();$("#blackVisitListContainer").empty();
if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){this._changeStatus();this._showFormWrapper();
$("#apiEntityForm").find("#clickShow").hide();},_edit:function(a){this._showFormWrapper();this.edit=true;this._changeStatus();this._loadData(a,false);},_detail:function(a){this._showFormWrapper();
this._loadData(a,true);$(".form_wrapper .saveBtn").hide();$(".createList").hide();FormUtils.disableForm(ApiEntity._CONS_.EDIT_FORM_ID);},_changeStatus:function(){$(".blackListLi").removeClass("active");
$("#blackListTab").removeClass("active").removeClass("in");$("#whiteListTab").removeClass("active").removeClass("in");$(".whiteListLi").removeClass("active");
$("#testApiTab").addClass("active").addClass("in");$(".testApiLi").addClass("active");},_loadData:function(c,b){var a=this;FormUtils.loadData(ApiEntity._CONS_.EDIT_URL+"?id="+c,function(d){$("input[name=id]").val(d.id);
$("select[name=group]").val(d.group);$("select[name=type]").val(d.type);$("select[name=urlType]").val(d.urlType);$("input[name=version]").val(d.version);
$("input[name=url]").val(d.url);$("input[name=doc]").val(d.doc);$("#desc").val(d.desc);$("select[name='isOpen']").val(d.isOpen);$("select[name='hasWhite']").val(d.hasWhite);
$("select[name='hasBlack']").val(d.hasBlack);$("input[name=createTime]").val(d.createTime);$("input[name=updateTime]").val(d.updateTime);$("input[name=startPeriod]").val(d.startPeriod);
$("input[name=endPeriod]").val(d.endPeriod);a._loadVisitData(d,b);a._loadApiData(d);a._setReadOnly();});},_initTree:function(){var a=this;FormUtils.loadData(ctx+"/gl/cate/cateOpt/listData4CateId.htm?cateId=912861206308585472",function(b){var c=b.cateOptPos;
if(c&&c.length){var g=new StringBuffer();var f="";for(var d=0;d<c.length;d++){var e="";g.append("<li class='apiLi' idVal='").append(c[d].id).append("' name='"+c[d].name+"'>").append(c[d].name).append("</li>");
}$(".apiUl").empty().append(g.toString());$(".apiUl").find("li:eq(0)").addClass("active");$(".apiUl").find("li:eq(0)").trigger("click");a._initJqgrid();
}});},_setReadOnly:function(){var a=$("select[name='isOpen']").val();if(a=="n"){$("input[name=startPeriod]").attr("readOnly","true");$("input[name=endPeriod]").attr("readOnly","true");
}else{$("input[name=startPeriod]").removeAttr("readOnly");$("input[name=endPeriod]").removeAttr("readOnly");}var b=$("#apiEntityForm").find("input[name=doc]").val();
if(b){$("#apiEntityForm").find("#clickShow").show();}else{$("#apiEntityForm").find("#clickShow").hide();}},_clearApiParam:function(){$("#selectParamType").each(function(b,a){$(a).find("option:selected").attr("selected",false);
$(a).find("option").first().attr("selected",true);});$("#paramName").val("");$("#testDesc").val("");$("#example").val("");$("#resContent").val("");$("#testApiDiv input[type=radio][name='isReq']:first").prop("checked",true);
$("#serverTime").val("-");$("#clientTime").val("-");},_loadVisitData:function(d,b){var j=this;var h=new StringBuffer();var a=new StringBuffer();var f;for(var e=0;
e<d.visitList.length;e++){f=d.visitList[e].type;if(f=="white"){var c=j._buildTableBody(d.visitList[e],b);h.append(c);}else{var g=j._buildTableBody(d.visitList[e],b);
a.append(g);}}$("#whiteVisitListContainer").empty().append(h.toString());$("#blackVisitListContainer").empty().append(a.toString());},_loadApiData:function(c){var a=this;
var d=new StringBuffer();var b=c.apiParam;if(b&&b!=null){$("#testApiDiv select[name=paramType]").val(b.type);$("#paramName").val(b.name);$("#testApiDiv #testDesc").val(b.desc);
$("#testApiDiv #example").val(b.example);$("#testApiDiv input:radio[value='"+b.isReq+"']").prop("checked",true);$("#resContent").val("");$("#serverTime").val("-");
$("#clientTime").val("-");}},_buildTableBody:function(b,a){var c=new StringBuffer();c.append("<tr>");c.append("<td><input type='text' class='form-control' readonly='readonly' value='"+b.ip+"'></td>");
c.append("<td>"+"<button class='btn btn-sm btn-outline btn-primary deleteVisitListBtn' id='deleteVisitListBtn' "+(a?"disabled":"")+" name='deleteList'>删除</button>"+"</td>");
c.append("</tr>");return c.toString();},_createNewList:function(){var a=new StringBuffer();a.append("<tr >");a.append("<td><input type='text' name='newInputText' placeholder='请输入ip地址' validateType='default' class='form-control newInputText'> </td>");
a.append("<td>"+"<button class='btn btn-sm btn-outline btn-primary deleteVisitListBtn' name='deleteList'>删除</button>"+"</td>");a.append("</tr>");return a.toString();
},_save:function(){var m=this;var b=$("#id").val();var l=null;if(b!=null&&b!=""){l=ApiEntity._CONS_.SAVE_EDIT_URL;}else{l=ApiEntity._CONS_.SAVE_ADD_URL;
}if($("#visitListForm").valid()&&$("#apiEntityForm").valid()){ButtonUtils.disableBtn("saveBtn");var f=$("#"+ApiEntity._CONS_.EDIT_FORM_ID).serialize();
var k=$("#testApiDiv input[type=radio][name='isReq']:checked").val();var a=$("#testApiDiv #selectParamType").val();var g=$("#testApiDiv #paramName").val();
var d=$("#testApiDiv #example").val();var i=$("#testApiDiv #testDesc").val();var c=$("#apiEntityForm input[name=url]").val();var h=[];var e=[];if(g!=""){var j={isReq:k,type:a,name:g,example:d,desc:i};
e.push(j);}if(c==""){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,"请填写url");return;}$("#whiteVisitListContainer").find("tr").each(function(){var n={type:"white",ip:$(this).find("td:first input").val()};
h.push(n);});$("#blackVisitListContainer").find("tr").each(function(){var n={type:"black",ip:$(this).find("td:first input").val()};h.push(n);});params=f+"&visitLists="+JSON.stringify(h);
if(e&&e!=""){params+="&apiParams="+JSON.stringify(e);}FormUtils.submit(l,params,function(n){ButtonUtils.enableBtn("saveBtn");if(n.success){if(n.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(n.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}m._clearApiParam();m.isEdit=false;m.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,n.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(ApiEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_postParams:function(){var b=$("#apiEntitySearchForm").closest("form").serialize();
var a=$(".apiUl li.active").text();b+="&Q__S__EQ__group_="+a;return b;},_bindEventHander:function(){var a=this;$(document).on("click","#isOpenSelect",function(){$("#isOpenSelect").trigger("change");
});$(document).on("click",".showApiDocument",function(){var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(b,"API文档");});$(document).on("click","#showDoc",function(){var b=$("#path").val();
JTTabUtils.addOrRefreshTab(b,"API文档");});$(document).on("click",".createList",function(){var c=a._createNewList();var b=$("#visitDiv").find(".tab-pane.active").find("table").attr("listType");
if(b=="white"){$("#visitWhiteListTable").append(c);}else{$("#visitBlackListTable").append(c);}$("input[name=newInputText]").focus();return false;});$(document).on("click",".deleteVisitListBtn",function(){$(this).closest("tr").remove();
});$(document).on("click",".prevBtn",function(){a.clear(false);a._clearApiParam();});$(document).on("click",".saveBtn",function(){a._save();});$("#"+ApiEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+ApiEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){var b=$("#apiEntityForm").find("select[name=isOpen]").val();if(b=="n"){$("input[name=startPeriod]").attr("readOnly","true");
$("input[name=endPeriod]").attr("readOnly","true");}else{$("input[name=startPeriod]").removeAttr("readOnly");$("input[name=endPeriod]").removeAttr("readOnly");
}a.isFormDataChange=true;}});$("#"+ApiEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#apiEntitySearch").on("click",function(){a.reloadJqgrid();
});$("#apiEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".apiEntitySearch").trigger("click");}});$("body").on("click",".apiLi",function(){$(".apiUl li.active").removeClass("active");
$(this).addClass("active");a.reloadJqgrid();});$("body").on("click",".apiEntityAdd",function(){a._add();});$("#visitListForm").on("click",".sendSever",function(){var d=new Date().getTime();
var f=$("#apiEntityForm select[name=urlType]").val();var e=$("input[name=name]").val();var b=$("#apiEntityForm input[name=url]").val();if(b==""){DialogUtils.error(msgCode.ERROR,"请填写url");
return;}var c="reqMethod="+f;c+="&serverUrl="+b;if(e!=""){c+="&params="+e;}FormUtils.submit(ctx+"/gl/tool/interfaceTest/severTest.htm",c,function(h){ButtonUtils.enableBtn("sendSever");
if(h.success){var g=new Date().getTime();$("#resContent").val(JSON.parse(h.msg).result);DialogUtils.success(msgCode.SUCCESS,"请求成功");}else{DialogUtils.error(msgCode.ERROR,"请求失败");
}$("#clientTime").html(g-d);$("#serverTime").html(JSON.parse(h.msg).reqTime);},function(){ButtonUtils.enableBtn("sendSever");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".reSetForm",function(){a._clearApiParam();});$("body").on("click",".apiEntityEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(ApiEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".apiEntityDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(ApiEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".apiEntityDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ApiEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});},_bindFormValidation:function(){jQuery.validator.addMethod("isDate",function(d,c){return this.optional(c)||/^(20|21|22|23|[0-1]{1}[0-9]{1}):[0-5]{1}[0-9]{1}$/.test(d);
},"格式必须是HH:mm");jQuery.validator.addMethod("isIp",function(d,c){var d=d;var f=c;var g=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
return this.optional(c)||(g.test(d)&&(RegExp.$1<256&&RegExp.$2<256&&RegExp.$3<256&&RegExp.$4<256));},"Ip地址格式错误");var a={rules:{group:{required:true,},type:{required:true,},version:{required:true,},version:{required:true,},isOpen:{required:true,},hasWhite:{required:true,},hasBlack:{required:true,},startPeriod:{isDate:true,},endPeriod:{isDate:true,},},messages:{}};
FormUtils.bindFormValidation(ApiEntity._CONS_.EDIT_FORM_ID,a);var b={rules:{newInputText:{required:true,isIp:true,},},messages:{newInputText:{isIp:"Ip地址格式错误",},}};
FormUtils.bindFormValidation("visitListForm",b);},reloadJqgrid:function(b){var a=this;JTJqgridUtils.reloadJqgrid(ApiEntity._CONS_.GRID,a._postParams());
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("apiEntity.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"apiEntityDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("apiEntity.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"apiEntityEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("apiEntity.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"apiEntityDetail",iconClasses:"fa fa-list"});
}return a;},_initJqgrid:function(b){if(b==null||typeof b==undefined){var a=$(".apiUl li.active").text();b="Q__S__EQ__group_="+a;}$(ApiEntity._CONS_.GRID).JTJqgrid({url:ApiEntity._CONS_.LIST_DATA_URL,pager:ApiEntity._CONS_.PAGER,postData:b,colNames:["分组","API业务类型","版本","是否开放","开放时段","文档路径"],colModel:[{name:"group",index:"group_",width:120},{name:"type",index:"type_",width:120},{name:"version",index:"version_",width:60},{name:"isOpen",index:"is_open_",width:60},{name:"period",width:120},{name:"doc",index:"doc_",width:120,formatter:function(c,d,e){return"<a class='showApiDocument' value='"+c+"' style='text-decoration:underline;color:blue'>"+c+"</a>";
}}]});}};