$(function(){var a=new CreditEntity();a.init();});function CreditEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}CreditEntity._CONS_={DETAIL_URL:ctx+"/credit/core/creditEntity/detail.htm",DELETE_URL:ctx+"/credit/core/creditEntity/delete.htm",SAVE_ADD_URL:ctx+"/credit/core/creditEntity/saveAdd.htm",LIST_DATA_URL:ctx+"/credit/core/creditEntity/listData.htm",CHECK_DATA_URL:ctx+"/credit/core/creditEntity/check.htm",FIND_ALL_URL:ctx+"/credit/core/creditEntity/findAll.htm",FIND_CREDITRUN_URL:ctx+"/credit/core/creditEntity/findCreditRun.htm",FIND_CREDITDEV_URL:ctx+"/credit/core/creditEntity/findCreditDev.htm",GET_NOTIFY_URL:ctx+"/credit/core/creditEntity/getCreditNotify.htm",SAVE_NOTIFYADD_URL:ctx+"/credit/core/creditEntity/saveNotifyAdd.htm",SAVE_NOTIFYEDIT_URL:ctx+"/credit/core/creditEntity/saveNotifyEdit.htm",GET_EMP_PHONE_URL:ctx+"/crm/ou/employee/getEmpPhone.htm",EDIT_FORM_ID:"creditEntityForm",GRID:"#creditEntityGrid",PAGER:"#creditEntityPager"};
CreditEntity.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._findCreditRun();this._findCreditDev();this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.systemconfig.creditEntity";glHelpUtil.init(a);
},_hideNotGrantBtn:function(){if(!ResUtils.canShow("creditEntity.button.add")){$(".creditEntityAdd").hide();}if(!ResUtils.canShow("creditEntity.button.detail")){$(".creditEntityDetail").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$(".checkBtn").show();
$("#creditEntityForm").find("p").empty();FormUtils.clear(CreditEntity._CONS_.EDIT_FORM_ID);FormUtils.clear("creditNotifyForm");$("#creditCode").removeAttr("readonly");
if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".notify_wrapper").hide();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".notify_wrapper").hide();$(".form_wrapper").show();
},_showNotifyWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").hide();$(".notify_wrapper").show();},_add:function(){this._showFormWrapper();
},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();
$("#creditCode").attr("readonly","readonly");},_showNotify:function(b,a){this._showNotifyWrapper();this._loadNotifyData(b,a);},_check:function(){var a=this;
var b=$("#trueCreditCode").val();FormUtils.submit(CreditEntity._CONS_.CHECK_DATA_URL,{creditCode:b},function(c){if(c.success){a._setData(JSON.parse(c.msg));
}else{DialogUtils.error(msgCode.FAIL_MSG,"授权码错误！");}});},_setData:function(c){if(c!=null&&c!=""){$("#alias").empty().append(c.alias);$("#sysAlias").empty().append(c.sysAlias);
var b=this._getType(c.type);var a=this._getPayType(c.payType);$("#type").empty().append(b);$("#payType").empty().append(a);$("#users").empty().append(c.users);
$("#beginTime").empty().append(c.beginTime.replace(/00:00:00/,""));$("#endTime").empty().append(c.endTime.replace(/00:00:00/,"").replace(/23:59:59/,""));
}},_findCreditRun:function(){var a=this;FormUtils.loadData(CreditEntity._CONS_.FIND_CREDITRUN_URL,function(f){var b=f.items;var e=f.total;var h="";h+="<td colspan='2'><table >";
for(var c=0;c<b.length;c++){var d=b[c];var g=d.entityId?d.entityId:"";if(d.always){$("#creditRunAlways").empty().append("<tr><td style='text-align:right;width:50%;min-width:220px;'>永久 授权数量:</td><td style='text-align:left;font-weight:bold'> "+d.users+"</td></tr>");
}else{h+="<tr idVal='"+g+"'><td style='text-align:right;width:50%;min-width:220px;'>"+d.beginDate.replace(/00:00:00/,"")+"至"+d.endDate.replace(/00:00:00/,"")+"授权数量:</td><td style='text-align:left;width:50%;font-weight:bold'> "+d.users+"&nbsp;&nbsp;<span id='"+g+"'><span></td></tr>";
}}h+="</table></td>";$("#creditRun").empty().append(h);for(var c=0;c<b.length;c++){var d=b[c];var g=d.entityId?d.entityId:"";if(!d.always){a._loadNotify(g);
}}$("#creditRunTotal").empty().append("<tr><td style='text-align:right;width:50%;min-width:220px;'>&nbsp;</td><td style='text-align:left;font-weight:bold'> "+e+"</td></tr>");
});},_findCreditDev:function(){var a=this;FormUtils.loadData(CreditEntity._CONS_.FIND_CREDITDEV_URL,function(b){var c="";c+="<tr><td style='text-align:right;width:50%'>当前总可以开发授权数量:</td><td style='text-align:left;font-weight:bold'>"+b.total+"</td></tr>";
c+="<tr><td style='text-align:right;width:50%'>已使用开发授权数量:</td><td style='text-align:left;font-weight:bold'>"+b.use+"</td></tr>";$("#creditDev").empty().append(c);
});},_loadData:function(b){var a=this;$(".checkBtn").hide();FormUtils.loadData(CreditEntity._CONS_.DETAIL_URL+"?id="+b,function(c){$("input[name=creditCode").val(c.creditCode);
a._setData(c);});},_loadNotify:function(b){var a=b;FormUtils.loadData(CreditEntity._CONS_.GET_NOTIFY_URL+"?entityId="+a,function(c){if(c.entityId){$("#"+b).append('<a class="changeNotify" style="text-decoration:underline">(更改预警)</a>');
}else{$("#"+b).append('<a class="setNotify" style="text-decoration:underline">(设置预警)</a>');}});},_loadNotifyData:function(b,a){if(a){FormUtils.loadData(CreditEntity._CONS_.GET_NOTIFY_URL+"?entityId="+b,function(e){if(e.entityId){$("#creditNotifyForm input[name=id]").val(e.id);
$("#creditNotifyForm input[name=entityId]").val(e.entityId);$("#creditNotifyForm input[name=type]").val(e.type);var d=$("#creditNotifyForm input[name=types]");
for(var c=0;c<d.length;c++){if(e.types.indexOf(d[c].value)>=0){d[c].checked=true;}}$("#creditNotifyForm input[name=employeeName]").val(e.employeeName);
$("#creditNotifyForm input[name=beginTime]").val(e.beginTime);$("#creditNotifyForm input[name=count]").val(e.count);$("#creditNotifyForm input[name=employeeId]").val(e.employeeId);
$("#creditNotifyForm input[name=mobile]").val(e.mobile);$("#creditNotifyForm textarea[name='content']").val(e.content);$("#creditNotifyForm input[name=createBy]").val(e.createBy);
$("#creditNotifyForm input[name=createTime]").val(e.createTime);}else{DialogUtils.error(msgCode.FAIL_MSG,"加载数据失败！");}});}else{$("#creditNotifyForm input[name=entityId]").val(b);
}},_loadEmployeePhone:function(a){FormUtils.loadData(CreditEntity._CONS_.GET_EMP_PHONE_URL+"?employeeId="+a,function(b){if(b.success){$("#creditNotifyForm input[name=mobile]").val(b.msg);
}});},_save:function(){var b=this;var c=$("#trueCreditCode").val();var a=CreditEntity._CONS_.SAVE_ADD_URL;if($("#creditEntityForm").valid()){ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(a,{creditCode:c},function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){b.clear(true);b._findCreditRun();}else{if(d.msgCode=="creditError"){DialogUtils.error(msgCode.FAIL_MSG,"授权码错误！");
}else{if(d.msgCode=="creditOther"){DialogUtils.error(msgCode.FAIL_MSG,"该授权码不归属本公司！");}else{if(d.msgCode=="creditExpire"){DialogUtils.error(msgCode.FAIL_MSG,"授权码过期！");
}else{if(d.msgCode=="creditMacError"){DialogUtils.error(msgCode.FAIL_MSG,"授权码和当前机器码不匹配！");}else{if(d.msgCode=="creditNoMac"){DialogUtils.error(msgCode.FAIL_MSG,"获取不到当前的机器码,可能该系统未激活！");
}else{DialogUtils.error(msgCode.FAIL_MSG,"未知错误！");}}}}}}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_saveNotify:function(){var b=this;var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=CreditEntity._CONS_.SAVE_NOTIFYEDIT_URL;}else{a=CreditEntity._CONS_.SAVE_NOTIFYADD_URL;
}if($("#creditNotifyForm").valid()){ButtonUtils.disableBtn("saveNotifyBtn");FormUtils.submitByFormId(a,"creditNotifyForm",function(d){ButtonUtils.enableBtn("saveNotifyBtn");
if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;b.clear(true);b._findCreditRun();}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("saveNotifyBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(CreditEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_setTrueValue:function(b,e,c){if(!b){b=e;}else{if(b.length>e.length){b=b.substring(0,c)+b.substring(c+b.length-e.length,b.length);
}else{b=b.substring(0,c+b.length-e.length)+e.substring(c+b.length-e.length,c)+b.substring(c+b.length-e.length,b.length);}}$("#trueCreditCode").val(b);$("#creditCode").val(b.length>20?(b.substring(0,20)+b.substring(20,b.length).replace(/./g,"*")):b);
var d=document.getElementById("creditCode");if(d.setSelectionRange){d.focus();d.setSelectionRange(c,c);}else{if(d.createTextRange){var a=d.createTextRange();
a.collapse(true);a.moveEnd("character",c);a.moveStart("character",c);a.select();}}},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$(document).on("click",".saveNotifyBtn",function(){a._saveNotify();});$(document).on("click",".detail",function(){var b=$(this).parents("tr").attr("id");
a._detail(b);});$(document).on("click",".setNotify",function(){var b=$(this).parents("tr").attr("idVal");a._showNotify(b,false);});$(document).on("click",".changeNotify",function(){var b=$(this).parents("tr").attr("idVal");
a._showNotify(b,true);});$("body").on("click","#selectEmployee",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.core")){b:1;}var d={isShowAllGroup:b,grantType:"/core/",callBack:function(e){if(e!=null&&e.length>0){$("#employeeId").val(e[0].id);
$("#employeeName").val(e[0].name);a._loadEmployeePhone(e[0].id);}}};var c=new EmployeesSelect();c.init(d);});$("body").on("keyup","#creditCode",function(){var c=a._getCursorPosition();
var b=$("#trueCreditCode").val();var d=$(this).val();a._setTrueValue(b,d,c);});$("#"+CreditEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+CreditEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+CreditEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".creditEntitySearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$("body").on("click",".checkBtn",function(){a._check();});$("body").on("click",".creditEntityAdd",function(){a._add();
});$("body").on("click",".creditEntityDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(CreditEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("body").on("click",".devRes",function(){$("[name=password]").val("");$("#passwordModalContainer").modal("show");});},_bindFormValidation:function(){var a={rules:{trueCreditCode:{required:true},},messages:{}};
var b={rules:{types:{required:true},beginTime:{required:true},count:{required:true},employeeId:{required:true},mobile:{required:true,mobile:true},content:{required:true}},messages:{}};
FormUtils.bindFormValidation(CreditEntity._CONS_.EDIT_FORM_ID,a);FormUtils.bindFormValidation("creditNotifyForm",b);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(CreditEntity._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("creditEntity.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary creditEntityDetail",iconClasses:"fa fa-list"});
}return a;},_getType:function(b){var a="";if(b=="dev"){a="开发授权";}else{if(b=="run"){a="部署授权";}}return a;},_getPayType:function(b){var a="";if(b=="year"){a="年费";
}else{if(b=="year_always"){a="年费永久";}else{if(b=="always"){a="一次性永久";}else{if(b=="gift"){a="赠送";}}}}return a;},_getCursorPosition:function(){var c=document.getElementById("creditCode");
var b=-1;if(c.selectionStart||c.selectionStart===0){b=c.selectionStart;}else{var a=document.selection.createRange();a.moveStart("character",-c.value.length);
b=a.text.length;}return b;},_initJqgrid:function(b){if(b==null||typeof b==undefined){b={};}var a=this;$(CreditEntity._CONS_.GRID).JTJqgrid({url:CreditEntity._CONS_.LIST_DATA_URL,pager:CreditEntity._CONS_.PAGER,postData:b,colNames:["公司别名","产品系统别名","授权类型","付费类型","用户数","有效期开始","有效期结束","状态","创建时间","操作"],colModel:[{name:"alias",index:"alias_",width:120},{name:"sysAlias",index:"sys_alias_",width:120},{name:"type",index:"type_",width:110,formatter:function(c){return a._getType(c);
}},{name:"payType",index:"pay_type_",width:110,formatter:function(c){return a._getPayType(c);}},{name:"users",index:"users_",width:80},{name:"beginTime",index:"begin_time_",width:130,formatter:function(c){return c.replace(/00:00:00/,"");
}},{name:"endTime",index:"end_time_",width:130,formatter:function(c){return c.replace(/00:00:00/,"");}},{name:"status",index:"status_",width:60,formatter:function(c){if(c=="actived"){return"<label class='label label-primary'>激活</label>";
}else{if(c=="avail"){return"<label class='label label-danger'>无效</label>";}else{return"";}}}},{name:"createTime",index:"create_time_",width:130,classes:"autoHideCol",formatter:function(c){return DateUtils.miniTime(c);
}},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});}};