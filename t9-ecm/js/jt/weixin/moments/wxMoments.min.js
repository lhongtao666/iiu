$(function(){var a=new WxMoments();a.init();});function WxMoments(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}WxMoments._CONS_={EDIT_URL:ctx+"/weixin/moments/wxMoments/edit.htm",DETAIL_URL:ctx+"/weixin/moments/wxMoments/detail.htm",DELETE_URL:ctx+"/weixin/moments/wxMoments/delete.htm",SAVE_ADD_URL:ctx+"/weixin/moments/wxMoments/saveAdd.htm",SAVE_EDIT_URL:ctx+"/weixin/moments/wxMoments/saveEdit.htm",LIST_DATA_URL:ctx+"/weixin/moments/wxMoments/listData.htm",FIND_ALL_WX_URL:ctx+"/gl/ou/employeeWeiXin/findAll.htm",EDIT_FORM_ID:"wxMomentsForm",GRID:"#wxMomentsGrid",PAGER:"#wxMomentsPager"};
WxMoments.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
CateUtils.getOptions([{typeKey:"system",pKey:"weixinLabel",container:"labelNames"}]);this._initEmployeeWeixin();}},_initEmployeeWeixin:function(){var a=new StringBuffer();
a.append("<option value=''>请选择</option>");FormUtils.loadData(WxMoments._CONS_.FIND_ALL_WX_URL,function(c){for(var b=0;b<c.length;b++){if(c[b].status==2){a.append("<option value='"+c[b].userName+"'>").append(c[b].nickName).append("【").append(c[b].alias).append("】</option>");
}}$("#employeeWeixins").empty().append(a.toString());});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("wxMoments.button.detail")){$(".wxMomentsDetail").hide();
}if(!ResUtils.canShow("wxMoments.button.add")){$(".wxMomentsAdd").hide();}if(!ResUtils.canShow("wxMoments.button.edit")){$(".wxMomentsEdit").hide();}if(!ResUtils.canShow("wxMoments.button.delete")){$(".wxMomentsDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(WxMoments._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(WxMoments._CONS_.EDIT_FORM_ID);$("#moments-video").empty();$("#moments-img").empty();if(c){a.reloadJqgrid();}$("[name='status']").attr("disabled","disabled");
}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){$("input[name='type'][value=1]").trigger("click");$("input[name='type']").trigger("change");
$("input[name='toScope'][value=all]").trigger("click");$("input[name='toScope']").trigger("change");$("input[name='sendTimeType'][value=1]").trigger("click");
$("input[name='sendTimeType']").trigger("change");$("input[name='publicMode'][value=0]").trigger("click");$("input[name='publicMode']").trigger("change");
this._showFormWrapper();},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_copy:function(a){this._showFormWrapper();this._loadData(a,false,true);
},_detail:function(a){this._showFormWrapper();this._loadData(a,true);$(".form_wrapper .saveBtn").hide();},_loadData:function(d,c,a){var b=this;FormUtils.loadData(WxMoments._CONS_.EDIT_URL+"?id="+d,function(h){$("input[name=id]").val(h.id);
$("input[name='type']").attr("checked",false);$("input[name='type'][value="+h.type+"]").trigger("click");$("textarea[name=content]").val(h.content);$("input[name='toScope']").attr("checked",false);
$("input[name='toScope'][value="+h.toScope+"]").trigger("click");$("input[name='publicMode']").attr("checked",false);$("input[name='publicMode'][value="+h.publicMode+"]").trigger("click");
$("input[name=toTags]").val(h.toTags);$("input[name='sendTimeType']").attr("checked",false);$("input[name='sendTimeType'][value="+h.sendTimeType+"]").trigger("click");
$("input[name=sendTime]").val(h.sendTime);$("select[name=intervals]").val(h.intervals);$("select[name=status]").val(h.status);$("input[name=createBy]").val(h.createBy);
$("input[name=createTime]").val(h.createTime);$("input[name=updateBy]").val(h.updateBy);$("input[name=updateTime]").val(h.updateTime);$("#employeeWeixins").val(h.employeeWeixins.split(",")).trigger("chosen:updated");
$("#labelNames").val(h.toTags.split(",")).trigger("chosen:updated");if(h.type=="2"){var g=[];for(var f=0;f<h.wxMomentsFilePos.length;f++){var e={};e.url=h.wxMomentsFilePos[f].path;
g.push(e);}b._initImage(g);}else{if(h.type=="3"){var g=[];for(var f=0;f<h.wxMomentsFilePos.length;f++){var e={};e.url=h.wxMomentsFilePos[f].path;e["name"]="视频.mp4";
g.push(e);}$("#moments-video").append(FileUtils.createFileDivStr(g));}else{if(h.type=="4"){$("#wxMomentsForm input[name='link']").val(h.wxMomentsFilePos[0].path);
}}}if(c){FormUtils.disableForm(WxMoments._CONS_.EDIT_FORM_ID);}if(a){$("input[name=id]").val("");}});},_save:function(){var c=this;var e=$("#id").val();
var a=null;if(e!=null&&e!=""){a=WxMoments._CONS_.SAVE_EDIT_URL;}else{a=WxMoments._CONS_.SAVE_ADD_URL;}var b=$("#employeeWeixins").val();if($("[name='toScope']:checked").val()=="specify"){if(b==""||b==null){DialogUtils.error(msgCode.FAIL_MSG,"请选择微信号");
return;}}if($("#wxMomentsForm").valid()){ButtonUtils.disableBtn("saveBtn");var d=$("#"+WxMoments._CONS_.EDIT_FORM_ID).serialize()+"&"+c._getFileJson();
FormUtils.submit(a,d,function(f){ButtonUtils.enableBtn("saveBtn");if(f.success){if(f.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(f.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_getFileJson:function(){var a=$("input[name='type']:checked").val();
if(a==2){return this._getImages();}else{if(a==3){return this._getFiles();}else{if(a==4){return this._getLink();}else{return"fileJson=";}}}},_getImages:function(){var a=[];
$("#moments-img").find("li").each(function(){var d={};var b=$(this).find("div.file-box div.file");var c=b.attr("urlVal");d.path=c.replace("?dm=_mm","");
a.push(d);});return"fileJson="+encodeURIComponent(JSON.stringify(a));},_getFiles:function(){var a=[];$("#moments-video").find(".file-box").each(function(){var b={};
var c=$(this).find(".file a").eq(0).attr("urlVal");b.path=c;a.push(b);});return"fileJson="+encodeURIComponent(JSON.stringify(a));},_getLink:function(){var a=[];
var b={};b.path=$("#wxMomentsForm input[name='link']").val();a.push(b);return"fileJson="+encodeURIComponent(JSON.stringify(a));},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(WxMoments._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$(".wxMomentsSearch").on("click",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);
});$("#wxMomentsSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".wxMomentsSearch").trigger("click");}});$("body").on("click",".wxMomentsAdd",function(){a._add();
});$("body").on("click",".wxMomentsCopy",function(){var b=$(this).attr("idVal");if(!b){b=$(WxMoments._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._copy(b);});$("body").on("click",".wxMomentsEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(WxMoments._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}var c=$(WxMoments._CONS_.GRID).jqGrid("getRowData",b);
if(c["status"]!="awaiting"){DialogUtils.error(msgCode.error,"只有待发送的能编辑");return;}a._edit(b);});$("body").on("click",".wxMomentsDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(WxMoments._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".wxMomentsDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(WxMoments._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("input[name='publicMode']").on("change",function(){var b=$("input[name='publicMode']:checked").val();if(b==2){$(".wx-label").show();
$("#labelNames").chosen("destroy").chosen();}else{if(b==3){$(".wx-label").show();$("#labelNames").chosen("destroy").chosen();}else{$(".wx-label").hide();
}}});$("input[name='sendTimeType']").on("change",function(){var b=$("input[name='sendTimeType']:checked").val();if(b==1){$(".sendTime").hide();}else{if(b==2){$(".sendTime").show();
}}});$("input[name='toScope']").on("change",function(){var b=$("input[name='toScope']:checked").val();if(b=="all"){$(".employee-weixin").hide();}else{if(b=="specify"){$(".employee-weixin").show();
$("#employeeWeixins").chosen("destroy").chosen();}}});$("input[name='type']").on("change",function(){var b=$("input[name='type']:checked").val();if(b==1){$(".video").hide();
$(".img").hide();$(".link").hide();}else{if(b==2){$(".link").hide();$(".video").hide();$(".img").show();}else{if(b==3){$(".link").hide();$(".img").hide();
$(".video").show();}else{if(b==4){$(".img").hide();$(".video").hide();$(".link").show();}}}}});$("#selectCommonImageBtn").on("click",function(){ImageUtils.selectImage(1,function(b){a._initImage(b);
});});$("#selectCommonVideoBtn").on("click",function(){FileUtils.selectFile(0,function(b){if(b&&b.length>0){$("#moments-video").append(FileUtils.createFileDivStr(b));
}});});},_initImage:function(c){var b=$("#moments-img");if(b.find("ul").length==0){var d=new StringBuffer();d.append("<ul class='dragsort'>");for(var a=0;
a<c.length;a++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[a]],true));d.append("</li>");}d.append("</ul>");b.append(d.toString());}else{var d=new StringBuffer();
for(var a=0;a<c.length;a++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[a]],true));d.append("</li>");}b.find("ul").append(d.toString());}},_bindFormValidation:function(){var a={rules:{},messages:{}};
FormUtils.bindFormValidation(WxMoments._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WxMoments._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(WxMoments._CONS_.GRID).JTJqgrid({url:WxMoments._CONS_.LIST_DATA_URL,pager:WxMoments._CONS_.PAGER,postData:a,colNames:["类型","文案","范围","发送标签","时间类型","推送时间","时间间隔","状态","状态","发送人","操作"],colModel:[{name:"type",index:"type_",width:120,formatter:function(b){if(b==1){return"文字";
}else{if(b=="2"){return"图片";}else{if(b=="3"){return"视频";}else{if(b=="4"){return"链接";}}}}}},{name:"content",index:"content_",width:120},{name:"toScope",index:"to_scope_",width:120,formatter:function(b){if(b=="specify"){return"指定微信";
}else{if(b=="all"){return"全部微信";}}}},{name:"toTags",index:"to_tags_",width:120},{name:"sendTimeType",index:"send_time_type_",width:120,formatter:function(b){if(b=="1"){return"立即开始";
}else{if(b=="2"){return"定时执行";}}}},{name:"sendTime",index:"send_time_",width:120},{name:"intervals",index:"intervals_",width:120,formatter:function(b){return b+"分";
}},{name:"statusShow",index:"status_",width:120,formatter:function(b,c,d){if(d["status"]=="awaiting"){return"待发送";}else{if(d["status"]=="sending"){return"发送中";
}else{return"完成";}}}},{name:"status",index:"status_",width:120,hidden:true},{name:"createBy",index:"create_by_",width:120},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};