$(function(){var a=new Migration();a.init();});function Migration(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}Migration._CONS_={EDIT_URL:ctx+"/k8/log/k8Log/edit.htm",DETAIL_URL:ctx+"/k8/log/k8Log/detail.htm",DELETE_URL:ctx+"/k8/log/k8Log/delete.htm",SAVE_ADD_URL:ctx+"/k8/log/k8Log/saveAdd.htm",SAVE_EDIT_URL:ctx+"/k8/log/k8Log/saveEdit.htm",LIST_DATA_URL:ctx+"/k8/log/k8Log/listData.htm",PRODUCT_MODULE:"product",EMPLOYEE_MODULE:"employee",SETTING_MODULE:"setting",CUSTOMER_MODULE:"customer",ORDER_MODULE:"order",FOLLOW_MODULE:"follow",EDIT_FORM_ID:"k8LogForm",GRID:"#k8LogGrid",PAGER:"#k8LogPager"};
Migration.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(Migration._CONS_.GRID,a);
},clear:function(){var a=this;a._clearInterval();$("#logText").empty();$(".startRemove").removeAttr("disabled");},_bindEventHander:function(){var a=this;
$("body").on("click","#adminFenzu",function(){$("#label").empty().append("开始迁移员工部门");a.clear();$(".startRemove").attr("entity",Migration._CONS_.EMPLOYEE_MODULE);
a._reloadText();$(".pageModelInfo").hide();$(".pageMigration").hide();});$("body").on("click","#product",function(){$("#label").empty().append("开始迁移产品数据");
a.clear();$(".startRemove").attr("entity",Migration._CONS_.PRODUCT_MODULE);a._reloadText();$(".pageModelInfo").hide();$(".pageMigration").hide();});$("body").on("click","#userOpt",function(){$("#label").empty().append("开始迁移客户选项");
a.clear();$(".startRemove").attr("entity",Migration._CONS_.SETTING_MODULE);a._reloadText();$(".pageModelInfo").hide();$(".pageMigration").hide();});$("body").on("click","#userInfo",function(){$("#label").empty().append("开始迁移客户");
a.clear();$(".startRemove").attr("entity",Migration._CONS_.CUSTOMER_MODULE);a._reloadText();$(".pageModelInfo").show();$(".pageMigration").show();});$("body").on("click","#userService",function(){$("#label").empty().append("开始迁移客户跟进");
a.clear();$(".startRemove").attr("entity",Migration._CONS_.FOLLOW_MODULE);a._reloadText();$(".pageModelInfo").show();$(".pageMigration").show();});$("body").on("click","#order",function(){$("#label").empty().append("开始迁移订单");
a.clear();$(".startRemove").attr("entity",Migration._CONS_.ORDER_MODULE);a._reloadText();$(".pageModelInfo").show();$(".pageMigration").show();});$("body").on("click",".migrationLog",function(){a.clear();
var b=$(".startRemove").attr("entity");if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");return;}a._loadLog(b,"migration");});$("body").on("click",".infoLog",function(){a.clear();
var b=$(".startRemove").attr("entity");if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");return;}a._loadLog(b,"info");});$("body").on("click",".timeLog",function(){a._clearInterval();
var b=$(".startRemove").attr("entity");if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");return;}DialogUtils.success(msgCode.SUCCESS,"开启实时日志成功,将会每5秒获取一次迁移信息");
a.currentInterval=a._startInterval();});$("body").on("click",".pageModelInfo",function(){a.clear();var b=$(".startRemove").attr("entity");if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");
return;}FormUtils.del(ctx+"/k8/migration/info/"+b+".htm",null,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);}else{DialogUtils.error(msgCode.SUCCESS,c.msg);
}});});$("body").on("click",".stopLog",function(){a._clearInterval();});$("body").on("click",".pageMigration",function(){var b=$(".startRemove").attr("entity");
if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");return;}$("#pageInfo").modal("show");FormUtils.bindFormValidation("pageForm",{});});$("body").on("click","#savePage",function(){if(!$("#pageForm").valid()){return;
}var d=$("[name=pageStart]").val();var c=$("[name=pageEnd]").val();var b=$(".startRemove").attr("entity");FormUtils.del(ctx+"/k8/migration/executor/page/"+b+".htm?pageStart="+d+"&pageEnd="+c+"",null,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);
$(".startRemove").attr("disabled","disabled");a.currentInterval=a._startInterval();$("#pageInfo").modal("hide");}else{DialogUtils.error(msgCode.SUCCESS,e.msg);
}});});$("body").on("click",".startRemove",function(){var b=$(this).attr("entity");if(!b){DialogUtils.error(msgCode.ERROR,"没有选择模块");return;}else{$(".startRemove").attr("disabled","disabled");
FormUtils.del(ctx+"/k8/migration/executor/"+b+".htm",null,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);a.currentInterval=a._startInterval();
}else{DialogUtils.error(msgCode.SUCCESS,c.msg);}});}});},_reloadText:function(){var b=this;var a=$(".startRemove").attr("entity");b._loadLog(a,"info");
},_loadLog:function(b,c){var a=this;FormUtils.loadData(ctx+"/k8/log/k8Log/listData.htm?Q__S__EQ__entity_="+b+"&Q__S__EQ__type_="+c+"&rows=20",function(d){if(d&&d.rows.length>0){var g=new StringBuffer();
for(var e=0;e<d.rows.length;e++){var f=d.rows[e];g.append(a._createTr(f));}$("#logText").empty().append(g.toString());}});},_createTr:function(a){var b=new StringBuffer();
b.append('<div class="panel panel-default">');b.append('<div class="panel-heading">');b.append('<label style="padding-left:2px;" >');b.append(a.title);
b.append("</label>");b.append('<code style="margin-left:30px;" >');b.append(a.createTime);b.append("</code>");b.append("</div>");b.append("</div>");return b.toString();
},_clearInterval:function(){var a=this;clearInterval(a.currentInterval);a.currentInterval=null;},_startInterval:function(){var a=this;var b=setInterval(function(){a._reloadText();
},5000);return b;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(Migration._CONS_.GRID).JTJqgrid({url:Migration._CONS_.LIST_DATA_URL,pager:Migration._CONS_.PAGER,postData:a,colNames:["关联id","关联实体类型","标题","类型(success,fail)","日志内容","操作"],colModel:[{name:"entityId",index:"entity_id_",width:120},{name:"entity",index:"entity_",width:120},{name:"title",index:"title",width:120},{name:"type",index:"type",width:120},{name:"log",index:"log",width:120},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};