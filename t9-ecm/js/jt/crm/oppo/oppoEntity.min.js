function OppoEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.coId="";this.customerName="";this.saveSuccessFn="";}OppoEntity._CONS_={EDIT_URL:ctx+"/crm/oppo/oppoEntity/edit.htm",DETAIL_URL:ctx+"/crm/oppo/oppoEntity/detail.htm",DELETE_URL:ctx+"/crm/oppo/oppoEntity/delete.htm",SAVE_ADD_URL:ctx+"/crm/oppo/oppoEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/oppo/oppoEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/oppo/oppoEntity/listData.htm",UPDATE_STAGE_URL:ctx+"/crm/oppo/oppoEntity/updateStage.htm",SAVE_SUMMARY_URL:ctx+"/crm/oppo/oppoEntity/saveSummary.htm",EDIT_FORM_ID:"oppoEntityForm",GRID:"#oppoEntityGrid",PAGER:"#oppoEntityPager"};
OppoEntity.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();}},initAdd:function(b,a){if(!this.hadInit){this.hadInit=true;
this._bindEventHander();this.saveSuccessFn=this._createSaveSuccessFn;this._hideNotGrantBtn();}if(b){this.coId=b;$("[name=coId]").val(b);}if(a){this.customerName=a;
$("[name=customerName]").val(a);}this._showFormWrapper();$("[name=stage]").trigger("change");},_createSaveSuccessFn:function(){var a=parent.layer.getFrameIndex(window.name);
parent.layer.close(a);this.clear(true);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("oppoEntity.button.detail")){$(".oppoEntityDetail").hide();}if(!ResUtils.canShow("oppoEntity.button.add")){$(".oppoEntityAdd").hide();
}if(!ResUtils.canShow("oppoEntity.button.edit")){$(".oppoEntityEdit").hide();}if(!ResUtils.canShow("oppoEntity.button.delete")){$(".oppoEntityDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(OppoEntity._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(OppoEntity._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();
this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(OppoEntity._CONS_.EDIT_FORM_ID);},_loadData:function(b){var a=this;FormUtils.loadData(OppoEntity._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);
$(".oppo-key").text(c.key);$("input[name=name]").val(c.name);$("input[name=cateId]").val(c.cateId);$("input[name=coId]").val(c.coId);$("input[name=desc]").val(c.desc);
$("input[name=stage]").val(c.stage);$("input[name=srcType]").val(c.srcType);$("input[name=interest]").val(c.interest);$("input[name=profitMin]").val(c.profitMin);
$("input[name=profitMax]").val(c.profitMax);$("input[name=rate]").val(c.rate);$("input[name=endTime]").val(c.endTime);$("input[name=summary]").val(c.summary);
$("input[name=summary]").attr("summaryVal",c.summary);$("input[name=createBy]").val(c.createBy);$("input[name=createTime]").val(c.createTime);$("input[name=updateBy]").val(c.updateBy);
$("input[name=updateTime]").val(c.updateTime);$("input[name=entityType]").val(c.entityType);$("input[name=entityId]").val(c.entityId);});},_save:function(){var b=this;
var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=OppoEntity._CONS_.SAVE_EDIT_URL;}else{a=OppoEntity._CONS_.SAVE_ADD_URL;}if($("#oppoEntityForm").valid()){if($(".saveBtn").length){ButtonUtils.disableBtn("saveBtn");
}FormUtils.submitByFormId(a,OppoEntity._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){if(d.msgCode==actionCode.CREATE){b.isEdit=false;
DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);if(b.saveSuccessFn){b.saveSuccessFn();}else{b.clear(true);}}else{if(d.msgCode==actionCode.UPDATE){b.isEdit=false;
DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);if(b.saveSuccessFn){b.saveSuccessFn();}else{b.clear(true);}}}}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(OppoEntity._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_updateStage:function(c,b){var a=this;var d=new StringBuffer();d.append("stage="+b);
d.append("&ids="+c);d=d.toString();FormUtils.submit(OppoEntity._CONS_.UPDATE_STAGE_URL,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});},_openSummaryDialog:function(b,a){var d=new StringBuffer();d.append('<div class="wrapper ">');
d.append(' <div  class="row form_wrapper ibox-content">');d.append('<form method="get" class="form-horizontal">');d.append('<div class="form-group">');
d.append(' <label class="col-sm-2 control-label">最终总结: &nbsp;</span></label>');d.append('<div class="col-sm-9">');d.append('<textarea id="summary" rows="1" class="col-sm-12" autocomplete="off" style="height: 100px; margin: 0px;">');
d.append("</textarea>");d.append("</div>");d.append("</div>");d.append('<input type="hidden" value="'+b+'" id="oppoEntityId"/>');d.append("</form>");d.append("</div>");
d.append("</div>");var c=d.toString();layer.open({type:1,title:"最终总结",shadeClose:false,btn:["保存","关闭"],area:["700px","300px"],content:c,success:function(e,f){console.log("success");
},yes:function(f,e){var g={};g.summary=$("#summary").val();g.id=$("#oppoEntityId").val();if(!g.summary){DialogUtils.error(msgCode.FAIL_MSG,"最终总结不能为空.");
return;}if(g.summary.length>64){DialogUtils.error(msgCode.FAIL_MSG,"最终总结不能超过64个字符");return;}FormUtils.submit(OppoEntity._CONS_.SAVE_SUMMARY_URL,g,function(h){if(h.success){a(g.summary,f);
}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);}});},cancel:function(){}});},_bindFormValidation:function(b){var a={rules:{name:{required:true,},coId:{required:true,},customerName:{required:true,},summary:{required:false,maxlength:[64],},desc:{required:false,maxlength:[1024],},profitMin:{required:false,digits:true,min:0,},profitMax:{required:false,digits:true,min:0,},rate:{required:false,digits:true,range:[1,4]},endTime:{required:false,date:true}},messages:{}};
FormUtils.bindFormValidation(OppoEntity._CONS_.EDIT_FORM_ID,a,b);},_bindEventHander:function(){var a=this;$("body").on("change","[name=stage]",function(){var b=$(this).val();
if(b=="win"||b=="lost"){$("[name=summary]").val("").removeAttr("readonly").removeAttr("disabled");$("#summary-form-group").show();}else{$("[name=summary]").val($(this).attr("summaryVal")).attr("readonly","readonly").attr("disabled","disabled");
$("#summary-form-group").hide();}});$("body").on("input","[name=summary]",function(){$(this).attr("summaryVal",$(this).val());});$("body").on("click",".push-oppo",function(){var c=$(this).attr("class");
var d=c.indexOf("stage-");var b="";if(d>0){b=c.substring(d+6,c.length);}console.log(b);var e=$(this).attr("idVal");if(b==="win"){a._openSummaryDialog(e,function(g,f){layer.close(f);
a._updateStage(e,"win");});}else{a._updateStage(e,b);}});$("body").on("click",".lost-oppo",function(b){var c=$(this).attr("idVal");a._openSummaryDialog(c,function(e,d){layer.close(d);
a._updateStage(c,"lost");});});$("body").on("click",".win-oppo",function(b){var c=$(this).attr("idVal");a._openSummaryDialog(c,function(e,d){layer.close(d);
a._updateStage(c,"win");});});$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){a._save();});
$("#"+OppoEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+OppoEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+OppoEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".list_wrapper").on("click",".oppoEntitySearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);
}});$("body").on("click",".oppoEntityAdd",function(){layer.open({title:"添加商机",type:2,area:["85%","90%"],btn:["保存","取消"],fix:false,maxmin:false,zIndex:1000,scrollbar:false,content:ctx+"/crm/oppo/oppoEntity/oppoEntityAdd.htm.htm",success:function(c,d){var b=layer.getChildFrame("body",d);
a._bindFormValidation(b);},yes:function(e,d){var c=layer.getChildFrame("body",e);var b=$("#id",c).val()?OppoEntity._CONS_.SAVE_EDIT_URL:OppoEntity._CONS_.SAVE_ADD_URL;
var f=$("#oppoEntityForm",c).serialize();if($("#oppoEntityForm",c).valid()){FormUtils.submit(b,f,function(g){if(g.success){if(g.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(g.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}layer.close(e);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);
}});}},});});$("body").on("click",".oppoEntityDel",function(){var b=$(this).attr("idVal");if(!b){b=$(OppoEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".oppoEntityDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(OppoEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}var c=b;var d=$(this).hasClass("isDetailBtn");
layer.open({title:"商机详情",type:2,area:["85%","90%"],btn:!d?["保存","取消"]:[],fix:false,maxmin:false,zIndex:1000,scrollbar:false,content:ctx+"/crm/oppo/oppoEntity/openOppoDetail.htm?id="+c+"&isDetailBtn="+d,success:function(f,g){var e=layer.getChildFrame("body",g);
a._bindFormValidation(e);},yes:function(h,g){var f=layer.getChildFrame("body",h);var e=$("#id",f).val()?OppoEntity._CONS_.SAVE_EDIT_URL:OppoEntity._CONS_.SAVE_ADD_URL;
var i=$("#oppoEntityForm",f).serialize();if($("#oppoEntityForm",f).valid()){FormUtils.submit(e,i,function(j){if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}layer.close(h);}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);
}});}}});});$("body").on("click",".oppoEntityEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(OppoEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}var c=b;var d=$(this).hasClass("isDetailBtn");layer.open({title:"商机编辑",type:2,area:["85%","90%"],btn:["保存","取消"],fix:false,maxmin:false,zIndex:1000,scrollbar:false,content:ctx+"/crm/oppo/oppoEntity/openOppoDetail.htm?id="+c+"&isDetailBtn="+d,success:function(f,g){var e=layer.getChildFrame("body",g);
a._bindFormValidation(e);},yes:function(h,g){var f=layer.getChildFrame("body",h);var e=$("#id",f).val()?OppoEntity._CONS_.SAVE_EDIT_URL:OppoEntity._CONS_.SAVE_ADD_URL;
var i=$("#oppoEntityForm",f).serialize();if($("#oppoEntityForm",f).valid()){FormUtils.submit(e,i,function(j){if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}layer.close(h);}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);
}});}}});});$("body").on("click",".selectCustomer",function(){var b=new CustomerSelect();var c={callBack:function(d){if(d&&d.length>0){var e=d[0];$("input[name='coId']").val(e.id);
$("input[name='customerName']").val(e.name);$("input[name='customerName']").trigger("change");$("input[name='customerName']").trigger("input");$("input[name='customerName']").trigger("blur");
}}};b.init(c);});$("body").on("click",".closeDialog",function(){var b=parent.layer.getFrameIndex(window.name);parent.layer.close(b);});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(OppoEntity._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(canShow("oppoEntity.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger oppoEntityDel",iconClasses:"fa fa-remove"});
}if(canShow("oppoEntity.button.detail")){a.push({lable:"明细",btnClasses:"btn btn-primary oppoEntityDetail isDetailBtn",iconClasses:"fa fa-list"});}if(canShow("oppoEntity.button.edit")){a.push({lable:"编辑",btnClasses:"btn btn-primary oppoEntityEdit",iconClasses:"fa fa-edit"});
}if(canShow("oppoEntity.button.updateStage")){a.push({switchCol:{colName:"stage",colVals:["begin","interest","project","agree","discuss","",undefined],colLables:[["推进","丢单","赢单"],["推进","丢单","赢单"],["推进","丢单","赢单"],["推进","丢单","赢单"],["丢单","赢单"],["推进","丢单","赢单"],["推进","丢单","赢单"]],btnClasses:[["btn btn-primary push-oppo stage-interest","btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary push-oppo stage-project","btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary push-oppo stage-agree","btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary push-oppo stage-discuss","btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary push-oppo stage-begin","btn btn-primary lost-oppo","btn btn-primary win-oppo"],["btn btn-primary push-oppo stage-begin","btn btn-primary lost-oppo","btn btn-primary win-oppo"],]}});
}return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(OppoEntity._CONS_.GRID).JTJqgrid({url:OppoEntity._CONS_.LIST_DATA_URL,pager:OppoEntity._CONS_.PAGER,postData:a,colNames:["商机编号","商机名称","阶段","兴趣","来源","预期成交(元)","成功概率","预期结束时间","目标客户","操作"],colModel:[{name:"key",index:"key_",width:120},{name:"name",index:"name_",width:210,formatter:function(b){return"<div class='ellipsis-class'>"+b+"</div>";
}},{name:"stage",index:"stage_",width:110,formatter:function(b){var c="";switch(b){case"begin":c='<label type="lable" class="label label-default">挖掘商机</label>';
break;case"interest":c='<label type="lable" class="label label-warning">确定客户意向</label>';break;case"project":c='<label type="lable" class="label label-warning">引导客户立项</label>';
break;case"agree":c='<label type="lable" class="label label-success">赢得客户认可</label>';break;case"discuss":c='<label type="lable" class="label label-success">进行商务谈判</label>';
break;case"win":c='<label type="lable" class="label label-info">赢单</label>';break;case"lost":c='<label type="lable" class="label label-danger">丢单</label>';
break;}return c;}},{name:"interest",index:"interest_",width:90,formatter:function(c){var b=new StringBuffer();switch(c){case 1:b.append('<label type="lable" class="label label-default">');
b.append("很小");break;case 2:b.append('<label type="lable" class="label label-warning">');b.append("普通");break;case 3:b.append('<label type="lable" class="label label-info">');
b.append("较大");break;case 4:b.append('<label type="lable" class="label label-info">');b.append("很大");break;}b.append("</label>");return b.toString();}},{name:"srcType",index:"src_type_",width:70,formatter:function(c){var b="";
switch(c){case"qq":b="QQ";break;case"wechart":b="微信";break;case"tel":b="电话";break;case"other":b="其它";break;}return b;}},{name:"profitRange",index:"profit_range_",width:140},{name:"rate",index:"rate_",width:100,formatter:function(c){var b=new StringBuffer();
if(c==1){b.append('<label type="lable" class="label label-default">');b.append("很小");b.append("</label>");}else{if(c==2){b.append('<label type="lable" class="label label-warning">');
b.append("普通");b.append("</label>");}else{if(c==3){b.append('<label type="lable" class="label label-info">');b.append("较大");b.append("</label>");}else{if(c==4){b.append('<label type="lable" class="label label-info">');
b.append("很大");b.append("</label>");}else{if(c>4&&c<10){b.append('<label type="lable" class="label label-info">');b.append("很大");b.append("</label>");}}}}}return b.toString();
}},{name:"endTime",index:"end_time_",width:130},{name:"customerName",index:"customer_name_",width:110},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};