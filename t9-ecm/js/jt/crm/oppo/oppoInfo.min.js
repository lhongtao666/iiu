function OppoInfo(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.oppoId="";this.taskTableList=new TaskTableList();this.taskTableList.init(".contractEntityAdd",".prevBtn");
this.entityId="";this.type="jt_oppo_entity";this.typeName="商机";this.entityName="";this.isFormChange=false;this.isAttachFormChange=false;this.options=null;
}OppoInfo._CONS_={OPPO_DETAIL_URL:ctx+"/crm/oppo/oppoEntity/detail.htm",ADD_OPPO_RECORD_URL:ctx+"/crm/oppo/oppoEntity/saveAddRecord.htm",LIST_OPPO_RECORD_URL:ctx+"/crm/oppo/oppoEntity/listRecordsByOppoId.htm",ADD_OPPO_PROD_URL:ctx+"/crm/oppo/oppoEntity/saveOppoProds.htm",ADD_OPPO_FILE_URL:ctx+"/crm/oppo/oppoEntity/saveOppoFiles.htm",EDIT_FORM_ID:"oppoEntityForm",};
OppoInfo.prototype={initDetailOppo:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHanlder();}this.oppoId=b;
this._loadOppo(b);},initDetailAndEditOppo:function(d,b){this.options=b;var c=(b&&b.custmerName)?b.custmerName:"";if(b&&(b.isDetailBtn==true||b.isDetailBtn=="true")){a();
}this.initDetailOppo(d,c);function a(){$(".dataBtns .editBtn").remove();$(".dataBtns .saveBtn").remove();$(".fileBtns").remove();$(".prodBtns").remove();
$("#summary-form-group").remove();$(".dataBtns").remove();$("#record-edit-save").remove();$(".fileBtns").remove();$(".prodBtns").remove();$(".selectCustomer").hide();
}},_loadOppo:function(b){var a=this;FormUtils.loadData(OppoInfo._CONS_.OPPO_DETAIL_URL+"?id="+b,function(d){console.log(d);a._createRecords(d.oppoRecordPos);
var c=false;if(d.stage==="lost"||d.stage==="win"){c=true;}a._loadOppoData(d,c);a._createOppoAttachItems(d.oppoFilePos,c);a._loadTasks(b,d.name);a._createOppoSkuItems(d.oppoProdPos,c);
a.isFormChange=false;},null);},_loadTasks:function(b,c){var a=this;a.entityId=b;a.entityName=c;a.taskTableList.reInit(a.type,b,a.typeName,a.entityName);
this.taskTableList.loadTable();},_clearRecord:function(){$("textarea[name=content]").val("");},_createRecords:function(b){var f=new StringBuffer();for(var d=0;
d<b.length;d++){var e=b[d];var c=new StringBuffer();c.append('<div class="alert alert-warning">');c.append('<p><a class="text-info" href="javascript:void(0)">').append(e.employName).append("&nbsp;&nbsp;&nbsp; </a>");
c.append("").append(e.content).append("</p>");c.append('<small class="block text-muted"><i class="fa fa-clock-o"></i>').append(e.createTime).append("</small>");
c.append("</div>");f.append(c.toString());}var a=f.toString();$("#recordsContainer").empty();$("#recordsContainer").append(f.toString());},_loadOppoData:function(e,d){var a=this;
$("[name=name]").val(e.name);$("[name=id]").val(e.id);$(".oppo-key").text(e.key);var c="";if(e.entityType==="contract"){c="合同";}else{if(e.entityType==="solesorder"){c="订单";
}}$("[name=entityType]").val(e.entityType);$("[name=entityTypeName]").val(c);$("select[name=interest]").val(e.interest);$("select[name=cateId]").val(e.cateId);
$("select[name=stage]").val(e.stage);$("[name=coId]").val(e.coId);$("[name=customerName]").val(e.customerName);$("[name=desc]").val(e.desc);$("[name=srcType]").val(e.srcType);
$("[name=profitMin]").val(e.profitMin);$("[name=profitMax]").val(e.profitMax);var b=e.rate;if(b>=0&&b<=2){b="很小";b=2;}else{if(b>=3&&b<=5){b="一般";b=5;}else{if(b>=6&&b<=8){b="较大";
b=7;}else{if(b>=9){b="很大";b=9;}}}}$("[name=rate]").val(b);$("[name=endTime]").val(e.endTime?e.endTime.substring(0,10):e.endTime);$("[name=summary]").val(e.summary);
$("[name=createBy]").val(e.createBy);$("[name=createTime]").val(e.createTime);$("[name=updateBy]").val(e.updateBy);$("[name=updateTime]").val(e.updateTime);
$("[name=entityId]").val(e.entityId);$(".saveBtn").hide();$(".editBtn").show();$(".prevBtn").hide();if(a.options.isDetailBtn=="true"){this._disableForm();
}if(d){$(".dataBtns").hide();}else{$(".dataBtns").show();}if($(".dataBtns .editBtn").length&&!(e.statge=="win"||e.stage=="lost")){$(".dataBtns .editBtn").trigger("click");
}$("[name=stage]").trigger("change");},_reloadOppoRecords:function(b){var a=this;FormUtils.loadData(OppoInfo._CONS_.LIST_OPPO_RECORD_URL+"?oppoId="+b,function(c){console.log(c);
a._createRecords(c);},null);},_saveAddRecord:function(b,c){var a=this;var d=new StringBuffer();d.append("oppoId="+this.oppoId);d.append("&createBy="+b);
d.append("&content="+c);FormUtils.submit(OppoInfo._CONS_.ADD_OPPO_RECORD_URL,d.toString(),function(e){a._clearRecord();a._reloadOppoRecords(a.oppoId);},function(e){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_createOppoSkuItems:function(b,c){if(b&&b.length){var e=new StringBuffer();for(var a=0;a<b.length;a++){e.append("<tr prodIdVal='"+b[a].prodId+"' skuIdVal='"+b[a].skuId+"' skuKeyVal='"+b[a].skuCode+"'>");
var d=ImageUtils.getUrl({url:b[a].imgUrl},"mm");e.append("<td><img src='"+d+"' style='width: 30px; height: 30px;'></th>");e.append("<td>"+b[a].prodName+"</th>");
e.append("<td>"+b[a].skuCode+"</td>");e.append("<td><input type='text' class='form-control' name='count' value='1'></td>");e.append("<td>"+b[a].unit+"</td>");
e.append("<td><button class='btn btn-danger deleteSkuBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>");e.append("</tr>");}$("#skuContainer").append(e.toString());
}if(c){$(".prodBtns").hide();}else{$(".prodBtns").show();}},_createOppoAttachItems:function(b,a){$("#fileContainer").append(FileUtils.createFileDivStr(b));
if(a){$("#saveFileBtn").hide();$("#selectFileBtn").hide();$(".fileBtns").hide();}else{$(".fileBtns").show();}},_disableForm:function(b){var a="";if(b){a=b.stage;
}else{a=$("[name=stage]").val();}if(a=="win"||a=="lost"){$("[name=summary]").removeAttr("disabled");}else{$("[name=summary]").attr("disabled","disabled");
}FormUtils.disableForm("oppoEntityForm");},_enableForm:function(b){var a="";if(b){a=b.stage;}else{a=$("[name=stage]").val();}FormUtils.enableForm("oppoEntityForm");
if(a=="win"||a=="lost"){$("[name=summary]").removeAttr("disabled");}else{$("[name=summary]").attr("disabled","disabled");}},_save:function(){var b=this;
var c=$("#id").val();var a=null;a=ctx+"/crm/oppo/oppoEntity/saveEdit.htm";if($("#oppoEntityForm").valid()){ButtonUtils.disableBtn("saveBtn");FormUtils.submitByFormId(a,"oppoEntityForm",function(d){ButtonUtils.enableBtn("saveBtn");
if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}$(".saveBtn").hide();$(".editBtn").show();$(".prevBtn").hide();b._disableForm();},function(){ButtonUtils.enableBtn("saveBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_bindEventHanlder:function(){var a=this;$("body").on("change","[name=stage]",function(){var b=$(this).val();
if(b=="win"||b=="lost"){$("[name=summary]").val("").removeAttr("readonly").removeAttr("disabled");$("#summary-form-group").show();}else{$("[name=summary]").val($(this).attr("summaryVal")).attr("readonly","readonly").attr("disabled","disabled");
$("#summary-form-group").hide();}});$("body").on("input","#oppoEntityForm",function(){if(a.isEdit){a.isFormDataChange=true;}$(".saveBtn").removeAttr("disabled");
});$(document).on("click",".saveBtn",function(){a._save();});$(document).on("click",".editBtn",function(){a._enableForm();$(".saveBtn").show().attr("disabled","disabled");
$(this).hide();$(".prevBtn").show();});$(document).on("click",".prevBtn",function(){if(a.isFormDataChange){a._loadOppo(a.oppoId);}$(".saveBtn").hide();
$(".editBtn").show();$(".prevBtn").hide();a._disableForm();});$("body").on("click",".add-oppo-record",function(){var b=$("textarea[name=content]").val();
if(!b){DialogUtils.error(msgCode.ERROR,"添加的动态内容不能为空");return;}a._saveAddRecord(currentUserId,b);});$("#selectSkuBtn").on("click",function(){SelectProdService.selectSku({isMultiple:1,hideCanSale:"y",fn:function(b){a._createOppoSkuItems(b);
$("#saveSkuBtn").removeAttr("disabled","disabled");}});});$("#skuContainer").on("change","[name=count]",function(){$("#saveSkuBtn").removeAttr("disabled","disabled");
});$("#skuContainer").on("click",".deleteSkuBtn",function(){var b=this;DialogUtils.confirm(function(){$(b).parents("tr").remove();$("#saveSkuBtn").removeAttr("disabled","disabled");
});});$("#selectFileBtn").on("click",function(){FileUtils.selectFile(1,function(b){a._createOppoAttachItems(b);$("#saveFileBtn").removeAttr("disabled");
});});$(".deleteFile").on("click",function(){$("#saveFileBtn").removeAttr("disabled");});$("#saveSkuBtn").on("click",function(){ButtonUtils.disableBtn("saveSkuBtn");
var b=[];$("#skuContainer").find("tr").each(function(){var c={oppoId:a.oppoId,skuId:$(this).attr("skuIdVal"),count:$(this).find("[name=count]").val(),};
b.push(c);});params="oppoId="+a.oppoId+"&oppoProdPos="+JSON.stringify(b);FormUtils.submit(OppoInfo._CONS_.ADD_OPPO_PROD_URL,params,function(c){ButtonUtils.enableBtn("saveSkuBtn");
if(c.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);$("#saveSkuBtn").attr("disabled","disabled");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){ButtonUtils.enableBtn("saveSkuBtn");});});$("#saveFileBtn").on("click",function(){ButtonUtils.disableBtn("saveFileBtn");var b=[];$("#fileContainer").find(".file-box").each(function(){var c={name:$(this).find(".file").attr("nameVal"),filePath:$(this).find(".file").attr("urlVal"),oppoId:a.oppoId,};
b.push(c);});params="oppoId="+a.oppoId+"&oppoFilePos="+JSON.stringify(b);FormUtils.submit(OppoInfo._CONS_.ADD_OPPO_FILE_URL,params,function(c){ButtonUtils.enableBtn("saveFileBtn");
if(c.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);$("#saveFileBtn").attr("disabled","disabled");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){ButtonUtils.enableBtn("saveFileBtn");});});$("body").on("click",".selectCustomer",function(){var b=new CustomerSelect();var c={callBack:function(d){if(d&&d.length>0){var e=d[0];
$("input[name='coId']").val(e.id);$("input[name='customerName']").val(e.name);$("input[name='customerName']").trigger("change");$("#oppoEntityForm").trigger("input");
}}};b.init(c);});},_bindFormValidation:function(){var a={rules:{name:{required:true,},coId:{required:true,},customerName:{required:true,},summary:{required:false,maxlength:[64],},desc:{required:false,maxlength:[1024],},profitMin:{required:false,digits:true,min:0,},profitMax:{required:false,digits:true,min:0,},rate:{required:false,digits:true,range:[1,4]},endTime:{required:false,date:true}},messages:{}};
FormUtils.bindFormValidation(OppoInfo._CONS_.EDIT_FORM_ID,a);},};