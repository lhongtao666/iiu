$(function(){var a=new WechatRecord();a.init();});function WechatRecord(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.followerList={page:1,total:0,rows:30,status:true,sord:"desc",sidx:"ext.last_reply_time_",};
this.recordData={rows:100,page:1,records:0,total:0};this.lastHistoryTime="";this.hadInitJqgrid=false;}WechatRecord._CONS_={EDIT_URL:ctx+"/crm/wx/wechatRecord/edit.htm",DETAIL_URL:ctx+"/crm/wx/wechatRecord/detail.htm",DELETE_URL:ctx+"/crm/wx/wechatRecord/delete.htm",SAVE_ADD_URL:ctx+"/crm/wx/wechatRecord/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/wx/wechatRecord/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/wx/wechatRecord/listData.htm",LIST_ALL_PLATFORM_URL:ctx+"/crm/wx/wechatPlatform/findAll.htm",LIST_FOLLOWER_URL:ctx+"/crm/wx/wechatFollower/listData.htm",LIST_ALIAS_TAG_URL:ctx+"/crm/wx/wechatTag/findByWechatAlias.htm",UPDATE_MSG_TARGET_URL:ctx+"/crm/wx/wechatRecord/updateMsgTarget.htm",EDIT_FORM_ID:"wechatRecordForm",GRID:"#wechatRecordGrid",PAGER:"#wechatRecordPager"};
WechatRecord.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();
this._loadPlatform();this._dealStyle();this._initWxlabel();this._initEmployeeSelect("");}},_dealStyle:function(){var a=$("body").height();a=a-$(".nav-tabs").outerHeight()-5*2;
tempHight=a;a=tempHight-($(".rows-title").outerHeight()+1*2+3);$("#wechat-alias-list").height(a);$("#user-alias-list").height(tempHight-35-110-7-30-5);
$("#chat-list").height(tempHight-35-110-7-135-10-25-5);},_initWxlabel:function(c){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=wxMsgTag";
FormUtils.loadData(b,function(d){if(d.length>0){var f=new StringBuffer();f.append("<option value=''>请选择</option>");for(var e=0;e<d.length;e++){f.append("<option value='"+d[e].value+"'>"+d[e].value+"</option>");
}$("#wx-msg-target_").empty().append(f.toString());$("#jt-search-tag").empty().append(f.toString());$("#jt-select-tag").empty().append(f.toString());}});
},_loadPlatform:function(){var a=this;FormUtils.loadData(WechatRecord._CONS_.LIST_ALL_PLATFORM_URL,function(d){var e=new StringBuffer();var c=new StringBuffer();
c.append("<option value=''>请选择</option>");for(var b=0;b<d.length;b++){e.append("<li title='"+d[b].name+"' class='wechat-alias-li' wechat-alias='"+d[b].alias+"'>").append("<img onerror='onImageError();' class='avatar'  src='"+ImageUtils.getTrueUrl(d[b].headImgUrl)+"'>").append("<span class='nickName'>"+d[b].name+"</span>");
e.append("</li>");c.append("<option value='"+d[b].alias+"'>"+d[b].name+"</option>");}$("#wechat-alias-list").empty().append(e.toString());$("#wechat-alias-list").find("li:eq(0)").trigger("click");
$("#jt-search-wechatAlias").empty().append(c.toString());});},_loadTags:function(){var a=this;FormUtils.loadData(WechatRecord._CONS_.LIST_ALIAS_TAG_URL+"?wechatAlias="+a.wechatAlias,function(c){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].tagId+"'>").append(c[b].name).append("</option>");
}$("#wx-label_").empty().append(d.toString());});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("wechatRecord.button.tag")){$(".wechatRecordTag").hide();
}if(!ResUtils.canShow("wechatRecord.button.delete")){$(".wechatRecordDel").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(WechatRecord._CONS_.EDIT_FORM_ID);FormUtils.enableForm(WechatRecord._CONS_.EDIT_FORM_ID);
if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(WechatRecord._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(WechatRecord._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=openId]").val(c.openId);
$("input[name=wechatAlias]").val(c.wechatAlias);$("input[name=employeeId]").val(c.employeeId);$("input[name=nickName]").val(c.nickName);$("input[name=content]").val(c.content);
$("input[name=contentType]").val(c.contentType);$("input[name=type]").val(c.type);$("input[name=headImgUrl]").val(c.headImgUrl);$("input[name=employeeHeadImg]").val(c.employeeHeadImg);
$("input[name=msgTarget]").val(c.msgTarget);$("input[name=isSensitive]").val(c.isSensitive);$("input[name=createTime]").val(c.createTime);});},_save:function(){var b=this;
var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=WechatRecord._CONS_.SAVE_EDIT_URL;}else{a=WechatRecord._CONS_.SAVE_ADD_URL;}if($("#wechatRecordForm").valid()){ButtonUtils.disableBtn("saveBtn");
FormUtils.submitByFormId(a,WechatRecord._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(WechatRecord._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_selectTags:function(b,c){var a=this;layer.open({title:"<span style='font-weight:600;font-size:18px'>选择标签</span>",type:1,btnAlign:"c",btn:["确定"],area:["400px","400px"],zIndex:"9999",skin:"layui-layer-demo",closeBtn:1,anim:2,content:$(".jt-select-tag"),shadeClose:true,yes:function(e,d){layer.close(e);
var f=$("#jt-select-tag").val();a._updateMsgTarget(b,f,true);},});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$("#"+WechatRecord._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+WechatRecord._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+WechatRecord._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".wechatRecordSearch").on("click",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$("#wechatRecordSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".wechatRecordSearch").trigger("click");
}});$("body").on("click",".wechatRecordDel",function(){var b=$(this).attr("idVal");if(!b){b=$(WechatRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".wechatRecordTag",function(){var b=$(this).attr("idVal");
if(!b){b=$(WechatRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._selectTags(b);});$(document).on("click",".wechat-alias-li",function(){$(".wechat-alias-li.on").removeClass("on");$(this).addClass("on");a.wechatAlias=$(this).attr("wechat-alias");
$("#chat-list").find("ul").empty();$(".rows-chat-head").find(".r-c-h-right").find("font").eq(1).text(0);var b=$("#friendsSearchForm").closest("form").serialize();
a.followerList.page=1;a._loadFollowerList(true,b);a.reChatList();a._loadTags();});$(".friendsAliasSearch").on("click",function(){$("#chat-list").find("ul").empty();
$(".rows-chat-head").find(".r-c-h-right").find("font").eq(1).text(0);a.reChatList();var b=$("#friendsSearchForm").closest("form").serialize();a.followerList.page=1;
a._loadFollowerList(true,b);});$("#user-alias-list").scroll(function(){var b=$(this)[0].scrollHeight-$(this).height()-$(this).scrollTop();if(b<10&&a.followerList.status&&a.followerList.page<a.followerList.total){var c=$("#friendsSearchForm").closest("form").serialize();
a.followerList.page=a.followerList.page+1;a._loadFollowerList(false,c);}});$(document).on("click",".user-alias-li",function(){$(".user-alias-li").removeClass("on");
$(this).addClass("on");var c=$(this).attr("open-id");a.openId=c;a.reChatList();a.recordData.page=1;var b="startDate="+$("#friendsSearchForm").find(".startDate").val()+"&endDate="+$("#friendsSearchForm").find(".endDate").val();
a.lastHistoryTime="";a._loadRecord(true,b);});$("#chat-list").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.recordData.status&&a.recordData.page<a.recordData.total){a.recordData.page=a.recordData.page+1;
a._loadRecord(false);}});$(document).on("click",".chat-sign",function(){var b=this;if($(this).is(".current-sign")){return false;}a.reTips({obj:b});$(".current-sign").removeClass("current-sign");
$(this).addClass("current-sign");});$(document).on("click",".msg-target-box li",function(c){var d=$(".current-sign").parent().find(".chat-sign").attr("data-id");
var b=$(this).attr("data-val");a._updateMsgTarget(d,b);if(!$(this).is(".reset-sign")){$(".current-sign").find(".sign-content").text($(this).text()).end().addClass("chat-signing").removeClass("current-sign");
}else{$(".current-sign").find(".sign-content").empty().end().removeClass("chat-signing").removeClass("current-sign");}layer.close(a.temp);a.temp=null;a.tips=null;
});$(document).on("click",".chat-search-btn",function(){a.reChatList();var b=$("#chat-content-search").closest("form").serialize();b+="&startDate="+$("#friendsSearchForm").find(".startDate").val()+"&endDate="+$("#friendsSearchForm").find(".endDate").val();
a.lastHistoryTime="";a.recordData.page=1;a._loadRecord(true,b);});$(document).on("click",".weixinAudio",function(c){if($(c.target).hasClass("download-file")){return;
}var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();$(".audio_area").removeClass("playing");clearTimeout(a.audioEndTime);}a.audio=d.find(".media")[0];
d.find(".audio_area").addClass("playing");var b=a.audio.duration;a.audio.currentTime=0;a.audio.play();a.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");
},b*1000);});$(document).on("click",".jt-video",function(b){b.stopPropagation();b.preventDefault();var c=$(this).attr("src-data");WeiXinUtil.showPlayVideotLayer(c);
return false;});$(document).on("click",".layui-layer-close",function(){var b=$(this).parents(".layui-layer-page").find("#jt-wx-video");if(b.length>0){$("#jt-wx-video").trigger("pause");
}});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");var c=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;
});$(document).on("click",".jt-lager-img",function(c){c.stopPropagation();var b=$(this).attr("src");var d="大图";$.fancybox.open([{href:b,title:d}]);});$(document).on("click",".jt-audio",function(){var d=$(this);
if(a.audio&&a.audio!=null){a.audio.pause();$(".jt-audio").find("i").css({"background-position":"-4px center"});clearInterval(a.audioEndTime);clearInterval(a.timer_);
}var e=d.find("i").attr("src-value");if(!d.find("audio").attr("src")){d.find("audio").attr("src",e);d.find("audio")[0].load();}if(!d.find("span").is(".is-ready")){d.find("span").addClass("is-ready").empty().append("加载中...");
}var c=-4,b=0;a.audioEndTime=setInterval(function(){if(d.find("audio")[0].readyState){a.audio=d.find("audio")[0];d.find("span").empty().append(d.find("audio")[0].duration.toFixed(1)+"''");
d.find("audio")[0].play();clearInterval(a.audioEndTime);a.timer_=setInterval(function(){c-=18;d.find("i").css({"background-position":c+"px center"});if(c==-58){c=14;
}if(d.find("audio")[0].ended){clearInterval(a.timer_);d.find("i").css({"background-position":"-4px center"});a.audio=null;}},500);}if(b/(1000*60)>=5){clearInterval(timer);
a.playing=null;}b+=500;},500);});$(".rows-chat-list").on("click",function(b){if($(b.target).is(".fa-tag")&&$(b.target).parent().is(".current-sign")){return false;
}else{if($(b.target).is(".chat-sign")&&$(b.target).is(".current-sign")){return false;}}if(a.tips){$(".current-sign").removeClass("current-sign");layer.close(a.temp);
a.temp=null;a.tips=null;}});$(".tabli").on("click",function(){var b=$(this).attr("id");if(b=="oldRecordTabLi"){a.hadInitJqgrid=true;a._initJqgrid();}});
$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"all",fn:function(c){$("input[name=belongOgn]").val(c);
a._initEmployeeSelect(c);}};GroupUtils.selectGroupTreeBox(b);});},_initEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#employeeId").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");
}$("#employeeId").append(d.toString()).select2();}},null,true);},_updateMsgTarget:function(c,b,d){var a=WechatRecord._CONS_.UPDATE_MSG_TARGET_URL;var e={ids:c,msgTarget:b};
FormUtils.submit(a,e,function(f){DialogUtils.success(msgCode.INFO,f.msg);if(d){$(".wechatRecordSearch").trigger("click");}},function(){DialogUtils.error(msgCode.ERROR,"后台异常");
});},_loadRecord:function(d,e){var a=this;var c=$(".m-message").find("ul");if(d){c.empty();}var b=WechatRecord._CONS_.LIST_DATA_URL+"?Q__S__EQ__open_id_="+a.openId+"&page="+this.recordData.page+"&rows="+this.recordData.rows+"&sord=desc&sidx=create_time_";
if(e){b=b+"&"+e;}FormUtils.loadData(b,function(f){var h=f.rows;a.recordData.total=f.total;$(".rows-chat-head").find(".r-c-h-right").find("font").eq(1).empty().html(f.records);
var j=new StringBuffer();for(var g=h.length-1;g>=0;g--){j.append(a._getChartLi(h[g]));}$("#chat-list").find("ul").prepend(j.toString());if(d){$("#chat-list").scrollTop($(".m-message")[0].scrollHeight);
}else{scrollTop=$("#chat-list").find("ul").height()-scrollTop;$("#chat-list").scrollTop(scrollTop);}},function(){},true);},_getChartLi:function(b){var c=false;
if(this.lastHistoryTime==""){this.lastHistoryTime=b.createTime;c=true;}else{var d=DateUtils.getDateDiff(this.lastHistoryTime,b.createTime,"minute");if(Math.abs(d)>=3){this.lastHistoryTime=b.createTime;
c=true;}}var a=DateUtils.getDateDiff(b.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");var e=new StringBuffer();e.append("<li id='"+b.id+"' >");
if(c){if(Math.abs(a)<24){e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"HH:mm")+"</span></p>");}else{e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"yyyy-MM-dd HH:mm")+"</span></p>");
}}e.append("<div class='main "+(b.type=="out"?"self":"")+"'>");if(b.type=="out"){e.append("<div class='msg-employee-info'>"+b.employeeAid+":"+b.employeeName+"</div>");
}e.append("<img class='avatar' width='30' height='30' src='"+WechatUtil._getHeadImgUrl(b)+"' />").append("<div class='text'>"+WechatUtil._getMsgType(b)+"</div>").append("<div  data-id='"+b.id+"' class='chat-sign "+(b.msgTarget?"chat-signing":"")+"'><i class='fa fa-tag'></i><font class='sign-content'>"+b.msgTarget+"</font></div>").append("</div></li>");
return e.toString();},reTips:function(b){var a=this;var c="<div class='overflow-box'><ul class='msg-target-box'>";$.each($("#wx-msg-target_").find("option"),function(f,g){if($(this).text()!="请选择"){c+="<li  data-val='"+$(this).attr("value")+"'>"+$(this).attr("value")+"</li>";
}else{c+="<li class='reset-sign' data-val=''>取消标签</li>";}});c+="</ul></div>";a.temp=layer.tips(c,b.obj,{tips:[($(b.obj).parent().is(".self")?4:2),"#78BA32"],time:0,area:["100px","auto"],scrollbar:false,success:function(e,f){a.tips=e[0];
}});if(a.tips){var d=$(window).height()-a.tips.offsetTop-a.tips.clientHeight;if(d<0){a.temp=layer.tips(c,b.obj,{tips:[1,"#78BA32"],time:0,area:["100px","auto"],scrollbar:false,success:function(e,f){a.tips=e[0];
}});}}},reChatList:function(){var a=this;$("#chat-list").find("ul").empty();if(a.tips){layer.close(a.temp);a.tips=null;a.temp=null;}},_loadFollowerList:function(c,d){var a=this;
if(c){$("#user-alias-list").empty();}var b=WechatRecord._CONS_.LIST_FOLLOWER_URL+"?Q__S__EQ__wechat_alias_="+a.wechatAlias+"&page="+a.followerList.page+"&rows="+a.followerList.rows+"&sord="+a.followerList.sord+"&sidx="+a.followerList.sidx;
if(d){b+="&"+d;}a.followerList.status=false;FormUtils.loadData(b,function(f){a.followerList.records=f.records;a.followerList.total=f.total;a.followerList.status=true;
$(".rows-friends-head").find(".r-f-h-right").find("font").eq(1).empty().html(f.records);var g=new StringBuffer();for(var e=0;e<f.rows.length;e++){g.append("<li title='"+f.rows[e].nickName+"' class='user-alias-li' open-id='"+f.rows[e].openId+"'>").append("<img onerror='onImageError();' class='avatar'  src='"+ImageUtils.getTrueUrl(f.rows[e].headImgUrl)+"'>").append("<span class='nickName'>"+f.rows[e].nickName+"</span>").append("<span class='lastChat'>"+WechatUtil.getContent(f.rows[e])+"</span>").append("</li>");
}$("#user-alias-list").append(g.toString());});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(WechatRecord._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WechatRecord._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("wechatRecord.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"wechatRecordDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("wechatRecord.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"wechatRecordEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("wechatRecord.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"wechatRecordDetail",iconClasses:"fa fa-list"});
}return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(WechatRecord._CONS_.GRID).JTJqgrid({url:WechatRecord._CONS_.LIST_DATA_URL,pager:WechatRecord._CONS_.PAGER,postData:a,colNames:["昵称","公众号","公众号ID","员工","内容","类型","消息标签","创建时间","操作"],colModel:[{name:"nickName",index:"nick_name_",width:100},{name:"wechatName",index:"wechat_alias_",width:100},{name:"wechatAlias",index:"wechat_alias_",width:100},{name:"employeeId",index:"employee_id_",width:100,formatter:function(b,c,d){return d.employeeAid+":"+d.employeeName;
}},{name:"content",index:"content_",width:150,formatter:function(b,c,f){var e="";var g=f.contentType;if("text"==g){e=WeiXinUtil.replaceFace(b);}else{if("image"==g){var d=b.split(";");
if(d.length>1){e="<img style='display: inline; height:35px;' src-value='"+d[1]+"' src='"+ImageUtils.getTrueUrl(d[1])+"'>";}else{e="<img style='display: inline; height:35px;' src-value='"+f.content+"'  src='"+ImageUtils.getTrueUrl(f.content)+"'>";
}}else{if("voice"==g){if(f.content&&f.content.indexOf("UploadedFile")!=-1){e=WeiXinUtil.getAudioSpan(f);}else{e=f.content;}}else{if(g=="video"){e=WeiXinUtil.getVideoMsg(f);
}else{e=b;}}}}return e;}},{name:"type",index:"type_",width:60,formatter:function(b,c,d){if(b=="in"){return"<span style='color:red;'>收</span>";}else{return"发";
}}},{name:"msgTarget",index:"msg_target_",width:120},{name:"createTime",index:"create_time",width:120},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};