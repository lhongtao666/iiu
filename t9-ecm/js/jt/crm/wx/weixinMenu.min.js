$(function(){var a=new WeixinMenu();a.init();});function WeixinMenu(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.itemArry=new Array();
this.saveBtn="";this.type_click="click";this.type_view="view";this.itemNum=1;}WeixinMenu._CONS_={REFRESH_URL:ctx+"/crm/wx/weixinMenu/wxMenuTree.htm",SYNC_MENU_URL:ctx+"/crm/wx/weixinMenu/syncWxMenu.htm",ADD_MENU_URL:ctx+"/crm/wx/weixinMenu/addWxMenu.htm",UPDATE_MENU_URL:ctx+"/crm/wx/weixinMenu/updateWxMenu.htm",DELELE_MENU_URL:ctx+"/crm/wx/weixinMenu/deleteWxMenu.htm",FIND_MENU_URL:ctx+"/crm/wx/weixinMenu/findWxMenu.htm",EDIT_FORM_ID:"weixinMenuForm",GRID:"#weixinMenuGrid",PAGER:"#weixinMenuPager"};
WeixinMenu.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantBtn();this._refreshMenu();}},_refreshMenu:function(){var a=this;
$("#menuList").empty();FormUtils.loadData(WeixinMenu._CONS_.REFRESH_URL,function(c){var b="";b=a._createMenu(b,c);$("#menuList").append(b);$("#menuList div ul li").on("click",function(){$("#menuList div ul li").removeClass("current");
$(this).addClass("current");});});},_hideNotGrantBtn:function(){},_createMenu:function(d,f){if(f!=null&&f.length>0){var e=f.length;var c=(e<2)?2:3;for(var b=0;
b<e;b++){var a=f[b];d+="<li class='jsMenu pre_menu_item grid_item jslevel1 ui-sortable ui-sortable-disabled size1of"+c+"'>";d+="<a data-id='"+a.id+"' draggable='false' class='pre_menu_link find-menu' href='javascript:void(0);'>";
d+="<i class='icon_menu_dot js_icon_menu_dot dn'></i>";d+="<i class='icon20_common sort_gray'></i>";d+="<span class='js_l1Title'>"+a.name+"</span>";d+="</a>";
d=this._createSubMenu(d,a.id,a.nodes);d+="</li>";}if(e<3){d+="<li class='js_addMenuBox pre_menu_item grid_item no_extra size1of"+c+"'>";d+="<a draggable='false' title='最多添加3个一级菜单' class='pre_menu_link js_addL1Btn' href='javascript:void(0);'>";
d+="<i class='icon14_menu_add'></i>";d+="</a>";d+="</li>";}}else{d+="<li class='js_addMenuBox pre_menu_item grid_item no_extra size1of1'>";d+="<a draggable='false' title='最多添加3个一级菜单' class='pre_menu_link js_addL1Btn' href='javascript:void(0);' >";
d+="<i class='icon14_menu_add'></i>";d+="</a>";d+="</li>";}return d;},_createSubMenu:function(d,b,a){d+="<div class='sub_pre_menu_box js_l2TitleBox'>";
d+="<ul class='sub_pre_menu_list'>";if(a!=null&&a.length>0){for(var c=0;c<a.length;c++){var e=a[c];d+="<li class='jslevel2'>";d+="<a data-id='"+e.id+"' draggable='false' class='jsSubView find-menu' href='javascript:void(0);'>";
d+="<span class='sub_pre_menu_inner js_sub_pre_menu_inner'>";d+="<i class='icon20_common sort_gray'></i>";d+="<span class='js_l2Title'>"+e.name+"</span>";
d+="</span>";d+="</a>";d+="</li>";}if(a.length<5){d+="<li class='js_addMenuBox'>";d+="<a data-pid='"+b+"' draggable='false' title='最多添加5个子菜单' class='jsSubView js_addL2Btn ' href='javascript:void(0);' >";
d+="<span class='sub_pre_menu_inner js_sub_pre_menu_inner'>";d+="<i class='icon14_menu_add'></i>";d+="</span>";d+="</a>";d+="</li>";}}else{d+="<li class='js_addMenuBox'>";
d+="<a data-pid='"+b+"' draggable='false' title='最多添加5个子菜单' class='jsSubView js_addL2Btn' href='javascript:void(0);' >";d+="<span class='sub_pre_menu_inner js_sub_pre_menu_inner'>";
d+="<i class='icon14_menu_add'></i>";d+="</span>";d+="</a>";d+="</li>";}d+="</ul>";d+="<i class='arrow arrow_out'></i> <i class='arrow arrow_in'></i>";
d+="</div>";return d;},_findMenu:function(b){var a=this;a._cleanForm();FormUtils.loadData(WeixinMenu._CONS_.FIND_MENU_URL+"?id="+b,function(c){a._setForm(c);
$("#delMenuBtn").removeClass("hide");});a.saveBtn="edit";},_newMenu:function(a){this._cleanForm();if(a&&a!=null&&a!=""){$("#menuForm input[name$='pId']").val(a);
$("#menuTile").html("新增二级菜单");}else{$("#menuList div ul li").removeClass("current");$("#menuTile").html("新增一级菜单");}this.saveBtn="add";},_setForm:function(b){var a=b;
$("#menuForm input[name$='id']").val(a.id);$("#menuForm input[name$='keyId']").val(a.keyId);var e=a.parentId;if("0"!=e){$("#menuForm input[name$='pId']").val(e);
$("#menuTile").html("编辑二级菜单【"+a.name+"】");}else{$("#menuList div ul li").removeClass("current");$("#menuTile").html("编辑一级菜单【"+a.name+"】");}$("#menuForm input[name$='name']").val(a.name);
$("#menuForm input[name$='sort']").val(a.sort);var g=a.type;if(g=="view"){$("#selectUrl").removeClass("hide");$("#selectMessage").addClass("hide");$("#menuForm input[name$='url']").val(a.url);
$("#menuForm input[name$='type']").val(this.type_view);$("#menuForm input[name$='selectType'][value='1']").parent("label").trigger("click");}else{$("#selectMessage").removeClass("hide");
$("#selectUrl").addClass("hide");$("#menuForm input[name$='type']").val(this.type_click);$("#menuForm input[name$='selectType'][value='0']").parent("label").trigger("click");
var h=a.selectType;var f=a.items;if("text"==h){this._removeTab();$("#tabText").addClass("active");$("#text").addClass("active");if(f!=null&&f.length>0){$("#menuForm textarea[name$='text']").val(f[0].content);
}}else{if("imageText"==h){this._removeTab();$("#tabimageText").addClass("active");$("#imageText").addClass("active");if(f!=null&&f.length>0){var d="";for(var c=0;
c<f.length;c++){var j=f[c];d+="<tr id='temtr"+this.itemNum+"' >";d+="<td>"+j.title+"</td>";d+="<td>"+j.content+"</td>";d+="<td>"+j.url+"</td>";if(j.picUrl&&j.picUrl!=""&&j.picUrl!=null){d+="<td class='center' ><img height='30' width='30' src='"+j.picUrl+"' ></td>";
}else{d+="<td></td>";}d+="<td>"+j.sort+"</td>";d+="<td class='center' >";d+="<button type='button' class='btn btn-sm btn-primary aBtnNoTD editItem' data-item-id='"+this.itemNum+"'  title='修改' href='#'><i class='fa fa-edit'></i></button>";
d+="<button type='button' class='btn btn-sm btn-danger aBtnNoTD delItem'  data-item-id='"+this.itemNum+"'  title='删除' href='#'><i class='fa fa-remove'></i></button>";
d+="<input type='hidden' name='items'id='item"+this.itemNum+"' value='"+this.itemNum+"' itemTitle='"+j.title+"' itemUrl='"+j.url+"' itemSort='"+j.sort+"' itemPicUrl='"+j.picUrl+"' itemContent='"+j.content+"'  >";
d+="</td>";d+="</tr>";this.itemNum++;}$("#itemsTable").append(d);}}else{if("image"==h){this._removeTab();$("#tabimage").addClass("active");$("#image").addClass("active");
if(f!=null&&f.length>0){$("#menuForm input[name$='picUrl']").val(f[0].picUrl);}}}}}},_save:function(){var b=this;var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=WeixinMenu._CONS_.SAVE_EDIT_URL;
}else{a=WeixinMenu._CONS_.SAVE_ADD_URL;}if($("#weixinMenuForm").valid()){ButtonUtils.disableBtn("saveBtn");FormUtils.submitByFormId(a,WeixinMenu._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");
if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_cleanForm:function(){$("#menuTile").html("选择菜单位置");$("#delMenuBtn").addClass("hide");$("#menuForm input[name$='id']").val("");$("#menuForm input[name$='pId']").val("0");
$("#menuForm input[name$='sort']").val("1");$("#menuForm input[name$='type']").val(this.type_click);$("#menuForm input[name$='keyId']").val("");$("#menuForm input[name$='name']").val("");
$("#menuForm input[name$='sort']").val(1);$("#menuForm textarea[name$='text']").val("");$("#selectMessage").removeClass("hide");$("#selectUrl").addClass("hide");
$("#menuForm input[name$='selectType'][value='0']").parent("label").trigger("click");this.itemArry=new Array();this.itemNum=1;$("#itemDiv input[name$='sort']").val("1");
$("#itemsTable tbody").empty();this._removeTab();$("#tabText").addClass("active");$("#text").addClass("active");},_removeTab:function(){$("#tabText").removeClass("active");
$("#text").removeClass("active");$("#tabimageText").removeClass("active");$("#imageText").removeClass("active");$("#tabimage").removeClass("active");$("#image").removeClass("active");
},_saveMenu:function(){this.itemArry=new Array();var c=$("#menuForm input[name$='id']").val();var g=$("#menuForm input[name$='pId']").val();var k=$("#menuForm input[name$='keyId']").val();
var b=$("#menuForm input[name$='name']").val();var h=$("#menuForm input[name$='type']").val();var e=$("#menuForm input[name$='sort']").val();var i="";if(c!=null&&c!=""){i=WeixinMenu._CONS_.UPDATE_MENU_URL;
}else{i=WeixinMenu._CONS_.ADD_MENU_URL;}var d={id:c,parentId:g,keyId:k,name:b,type:h,sort:e,url:a};if(this.type_view==h){var a=$("#menuForm input[name$='url']").val();
d.url=encodeURIComponent(a);}else{if(this.type_click==h){if($("#text").hasClass("active")){var j=$("#menuForm textarea[name$='text']").val();var m={content:encodeURIComponent(j)};
this.itemArry.push(m);d.itemsJson=JSON.stringify(this.itemArry);d.selectType="text";}else{if($("#imageText").hasClass("active")){this._setItemArry();d.itemsJson=JSON.stringify(this.itemArry);
d.selectType="imageText";}else{if($("#image").hasClass("active")){var f=$("#menuForm input[name$='picUrl']").val();var m={picUrl:encodeURIComponent(f)};
this.itemArry.push(m);d.itemsJson=JSON.stringify(this.itemArry);d.selectType="image";}}}}}var l=this;FormUtils.submit(i,d,function(n){if(n.success){if(n.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(n.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}l._refreshMenu();}else{DialogUtils.error(msgCode.FAIL_MSG,n.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_delMenu:function(){var a=this;DialogUtils.confirmWithOptions({title:"确认要删除菜单吗",text:"",confirmButtonText:"确定",yesFunc:function(){var b=$("#menuForm input[name$='id']").val();
FormUtils.submit(WeixinMenu._CONS_.DELELE_MENU_URL,{id:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);a._refreshMenu();}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},_syncMenu:function(){DialogUtils.confirmWithOptions({title:"确认要发布菜单吗",text:"",confirmButtonText:"确定",yesFunc:function(){FormUtils.submit(WeixinMenu._CONS_.SYNC_MENU_URL,{},function(a){if(a.success){DialogUtils.success(msgCode.INFO,a.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,a.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},_setItemArry:function(){var h=$("#itemsTable input[name='items']").map(function(){return $(this).val();
}).get().join(",");if(h&&h!=""&&h!=null){var a=h.split(",");for(var e=0;e<a.length;e++){var f=a[e];var b=$("#item"+f).attr("itemTitle");var g=$("#item"+f).attr("itemContent");
var c=$("#item"+f).attr("itemUrl");var d=$("#item"+f).attr("itemSort");var j=$("#item"+f).attr("itemPicUrl");var k={title:encodeURIComponent(b),url:encodeURIComponent(c),sort:d,picUrl:encodeURIComponent(j),content:encodeURIComponent(g)};
this.itemArry.push(k);}}},_cleanItemForm:function(){$("#itemDiv input[name$='sort']").val("1");},_bindEventHander:function(){var a=this;$(document).on("click",".find-menu",function(){var b=$(this).attr("data-id");
a._findMenu(b);});$(document).on("click",".js_addL1Btn",function(){a._newMenu();});$(document).on("click",".js_addL2Btn",function(){var b=$(this).attr("data-pid");
a._newMenu(b);});$(".saveMenu").on("click",function(){a._saveMenu();});$(".syncMenu").on("click",function(){a._syncMenu();});$("#menuForm input[name$='selectType']").on("click",function(){var b=this.value;
if(b==0){$("#selectMessage").removeClass("hide");$("#selectUrl").addClass("hide");$("#menuForm input[name$='type']").val(a.type_click);}else{$("#selectUrl").removeClass("hide");
$("#selectMessage").addClass("hide");$("#menuForm input[name$='type']").val(a.type_view);}});$("#delMenuBtn").on("click",function(){a._delMenu();});$("#itemformAdd").on("click",function(b){a._cleanItemForm();
layer.open({type:1,title:"新增图文",maxmin:false,move:true,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["650px","450px"],content:$(".jt-wx-add-pictrue"),success:function(c,d){},yes:function(f,c){var h="";
var j=$("#itemDiv input[name$='title']").val();var g=$("#itemDiv input[name$='sort']").val();var e=$("#itemDiv input[name$='url']").val();var d=$("#itemDiv input[name$='picUrl']").val();
var i=$("#itemDiv input[name$='content']").val();h+="<tr id='temtr"+a.itemNum+"' >";h+="<td>"+j+"</td>";h+="<td>"+i+"</td>";h+="<td>"+e+"</td>";if(d&&d!=""&&d!=null){h+="<td class='center' ><img height='30' width='30' src='"+d+"' ></td>";
}else{h+="<td></td>";}h+="<td>"+g+"</td>";h+="<td class='center'>";h+="<button type='button' class='btn btn-sm btn-primary aBtnNoTD editItem' data-item-id='"+a.itemNum+"'  title='修改' href='#'><i class='fa fa-edit'></i>修改</button>";
h+="<button type='button' class='btn btn-sm btn-danger aBtnNoTD delItem'  data-item-id='"+a.itemNum+"'  title='删除' href='#'><i class='fa fa-remove'></i>删除</button>";
h+="<input type='hidden' name='items'id='item"+a.itemNum+"' value='"+a.itemNum+"' itemTitle='"+j+"' itemUrl='"+e+"' itemSort='"+g+"' itemPicUrl='"+d+"' itemContent='"+i+"'  >";
h+="</td>";h+="</tr>";a.itemNum++;$("#itemsTable").append(h);layer.close(f);},cancel:function(){}});});$(document).on("click",".editItem",function(){var b=$(this).attr("data-item-id");
a._editItem(b);});$(document).on("click",".delItem",function(){var b=$(this).attr("data-item-id");a._delItem(b);});},_editItem:function(f){this._cleanItemForm();
var a=$("#item"+f).attr("itemTitle");var d=$("#item"+f).attr("itemContent");var c=$("#item"+f).attr("itemSort");var e=$("#item"+f).attr("itemUrl");var b=$("#item"+f).attr("itemPicUrl");
$("#itemDiv input[name$='title']").val(a);$("#itemDiv input[name$='content']").val(d);$("#itemDiv input[name$='sort']").val(c);$("#itemDiv input[name$='url']").val(e);
$("#itemDiv input[name$='picUrl']").val(b);layer.open({type:1,title:"修改图文",maxmin:false,move:true,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["650px","450px"],content:$(".jt-wx-add-pictrue"),success:function(g,h){},yes:function(j,g){var m=$("#itemDiv input[name$='title']").val();
var l=$("#itemDiv input[name$='content']").val();var k=$("#itemDiv input[name$='sort']").val();var i=$("#itemDiv input[name$='url']").val();var h=$("#itemDiv input[name$='picUrl']").val();
$("#item"+f).attr("itemTitle",m);$("#item"+f).attr("itemContent",l);$("#item"+f).attr("itemSort",k);$("#item"+f).attr("itemUrl",i);$("#item"+f).attr("itemPicUrl",h);
$("#temtr"+f).find("td").eq(0).html(m);$("#temtr"+f).find("td").eq(1).html(l);$("#temtr"+f).find("td").eq(2).html(i);if(h&&h!=""&&h!=null){$("#temtr"+f).find("td").eq(3).html("<img height='30' width='30' src='"+h+"' ></td>");
}else{$("#temtr"+f).find("td").eq(3).html("");}$("#temtr"+f).find("td").eq(4).html(k);layer.close(j);},cancel:function(){}});},_delItem:function(a){DialogUtils.confirmWithOptions({title:"确认要删除该图文吗",text:"",confirmButtonText:"确定",yesFunc:function(){$("#temtr"+a).remove();
}});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(WeixinMenu._CONS_.EDIT_FORM_ID,a);},};