$(function(){var a=new Wechat();a.init();});function Wechat(){this.hadInit=false;this.wechatAlias="";this.followerList={page:1,total:0,rows:30,status:true,sord:"desc",sidx:"ext.last_reply_time_",};
this.searchParam="";this.wechatForm=new WechatForm();}Wechat._CONS_={WECHAT_LIST_URL:ctx+"/crm/wx/wechatPlatform/findByEmployeeId.htm",FOLLOWER_LIST_URL:ctx+"/crm/wx/wechatFollower/listData.htm",};
Wechat.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadWechatList();this.initChatLayer();this.bindLayerEvent();
this.wechatForm.init();}},_dealStyle:function(){$(".jt-employee-wx-img").each(function(a,d){var b=$(".sidebar-left").width();var c=50*(b/60);$(this).parent().css({"transform":"scale("+(b/60)+")","margin-left":((b-c)/2)+"px","left":"-"+(25*(1-(b/60)))+"px"});
});},initChatLayer:function(){var b=this;var a=$("body").width();var d="750px";if($("body").height()<750){d=$("body").height()*0.95+"px";}if(a<=1280){b.minLeft=260;
b.minCenter=500;var c=(a-760)/2;if(c<0){c=0;}b.centerLayer=this.chatLayer({top:"2.5%",left:(c+260)+"px",zIndex:2,width:500+"px",height:d,skin:"layer-center-list",move:".layer-move-div",content:$(".chat-main-layer")});
b.leftLayer=this.chatLayer({top:"2.5%",left:(c)+"px",zIndex:3,width:260+"px",height:d,skin:"layer-left-list",move:".layer-move-div",content:$(".chat-list-layer")});
}else{b.minLeft=360;b.minCenter=600;var c=(a-960)/2;if(c<0){c=0;}b.centerLayer=this.chatLayer({top:"2.5%",left:(c+360)+"px",zIndex:2,width:600+"px",height:d,skin:"layer-center-list",move:".layer-move-div",content:$(".chat-main-layer")});
b.leftLayer=this.chatLayer({top:"2.5%",left:(c)+"px",zIndex:3,width:360+"px",height:d,skin:"layer-left-list",move:".layer-move-div",content:$(".chat-list-layer")});
}},chatLayer:function(b){var a=this;if(b.content){$(b.content).append("<div class='layer-move-div'></div>");}var c=layer.open({type:1,skin:b.skin?b.skin:"",id:b.id?b.id:"",closeBtn:false,title:"",shade:0,fixed:true,anim:1,resize:true,resizing:function(d){a.getMaxIndex();
if($(d).is(".layer-left-list")){$(".layer-left-list").css({"z-index":++maxIndex});}else{if($(d).is(".layer-center-list")){$(".layer-center-list").css({"z-index":++maxIndex});
}else{if($(d).is(".layer-right-list")){$(".layer-right-list").css({"z-index":++maxIndex});}}}if($(d).is(".layer-left-list")){$(d).find(".m-list").height($(d).height()-155);
if($(d).width()<360){$(".sidebar").addClass("sidebar-min");}else{if($(d).width()>=360&&$(".sidebar").is(".sidebar-min")){$(".sidebar").removeClass("sidebar-min");
}}if($(d).width()<a.minLeft){layer.style(a.leftLayer,{width:a.minLeft+"px"});}$(".jt-employee-wx-img").each(function(f,j){var g=$(".sidebar-left").width();
var h=50*(g/60);$(this).parent().css({"transform":"scale("+(g/60)+")","margin-left":((g-h)/2)+"px","left":"-"+(25*(1-(g/60)))+"px"});});}if($(d).is(".layer-right-list")){$("#csinfo-field-binded").height($(".layer-right-list").height()-$("#csinfo-button-field").outerHeight()-$(".detail-info-tab").outerHeight()-40);
}},offset:[(b.top?b.top:"auto"),(b.left?b.left:"auto")],scrollbar:false,zIndex:(b.index||b.index==0)?b.index:1,area:[(b.width?b.width:"500px"),(b.height?b.height:"500px")],move:b.move?b.move:"",moveOut:false,moveEnd:function(d){a.getMaxIndex();
if($(d).is(".layer-left-list")){$(".layer-left-list").css({"z-index":++maxIndex});}else{if($(d).is(".layer-center-list")){$(".layer-center-list").css({"z-index":++maxIndex});
}else{if($(d).is(".layer-right-list")){$(".layer-right-list").css({"z-index":++maxIndex});}}}},content:b.content?b.content:"<h3>面板初始化失败...</h3>",success:function(d,e){a.getMaxIndex();
if($(d).is(".layer-left-list")){if($(d).width()<360){$(d).find(".sidebar").addClass("sidebar-min");}$(d).find(".m-list").height($(d).height()-125);}}});
return c;},getMaxIndex:function(){var b=this;var a=[$(".layer-left-list"),$(".layer-center-list"),$(".layer-right-list")];$.each(a,function(d,f){if($(this).length>0){var c=$(this).css("z-index");
if(c>maxIndex){maxIndex=c;}}});console.log(maxIndex);},bindLayerEvent:function(){var a=this;$(document).on("mousedown",".layui-layer-page",function(b){if($(this).is(".layer-left-list")){$(".layer-left-list").css({"z-index":++maxIndex});
}else{if($(this).is(".layer-center-list")){$(".layer-center-list").css({"z-index":++maxIndex});}else{if($(this).is(".layer-right-list")){$(".layer-right-list").css({"z-index":++maxIndex});
}}}});$(window).on("resize",function(){var b=750;if($("body").height()<750){b=$("body").height()*0.95;}var c=$("body").width();if(c<=1280){var d=(c-760)/2;
if(d<0){d=0;}layer.style(a.leftLayer,{width:260+"px",height:b+"px",left:d+"px"});layer.style(a.centerLayer,{width:500+"px",height:b+"px",left:260+2+d+"px"});
}else{var d=(c-960)/2;if(d<0){d=0;}layer.style(a.leftLayer,{width:360+"px",height:b+"px",left:d+"px"});layer.style(a.centerLayer,{width:600+"px",height:b+"px",left:360+2+d+"px"});
}$(".jt-employee-wx-img").each(function(f,j){var g=$(".sidebar-left").width();var h=50*(g/60);$(this).parent().css({"transform":"scale("+(g/60)+")","margin-left":((g-h)/2)+"px","left":"-"+(25*(1-(g/60)))+"px"});
});});},_loadWechatList:function(){var a=this;FormUtils.loadData(Wechat._CONS_.WECHAT_LIST_URL+"?employeeId="+currentUserId,function(e){var g=new StringBuffer();
var b=false;for(var d=0;d<e.length;d++){var c=(e[d].headImgUrl==null||e.headImgUrl=="")?("/img/jt/wx/images/head_default.jpg"):e[d].headImgUrl;c=ctx+c;
g.append("<div id="+e[d].alias+" class='"+(d==0?"current-opt-employee":"")+"'><div>");g.append("<img onerror='onImageError();' class='jt-employee-wx-img "+(d==0?"on":"")+"' alias ='"+e[d].alias+"' title='"+e[d].name+"' alt='"+e[d].name+"' src='"+c+"'>");
g.append("</div>");if(e[d].unreadCount>0){var f=e[d].unreadCount;if(f>99){f=99;}g.append("<span class='badge badge-danger pull-right msg-not-read' data-notread='"+e[d].unreadCount+"'>"+f+"</span>");
}g.append("</div>");if(d==0){$(".jt-selected-employee-wx-img").attr("src",c);$(".employee-nickname").empty().append(e[d].name);a.wechatAlias=e[d].alias;
a.wechatForm.wechatAlias=a.wechatAlias;a._loadFollowerList();}}$(".my-wexin-list").empty().append(g.toString());a._dealStyle();});},_loadFollowerList:function(d){var a=this;
var c=Wechat._CONS_.FOLLOWER_LIST_URL+"?Q__S__EQ__ext.employee_id_="+currentUserId+"&Q__S__EQ__wechat_alias_="+a.wechatAlias+"&page="+a.followerList.page+"&rows="+a.followerList.rows+"&sord="+a.followerList.sord+"&sidx="+a.followerList.sidx+"&searchParam="+a.searchParam;
var b=$("#tabRecent").find(".m-list").find("ul");if(d){b.empty();}FormUtils.loadData(c,function(f){a.followerList.status=true;a.followerList.total=f.total;
$("#tabRecent-total").empty().append(f.records);$("#tabRecent-current").empty().append((a.followerList.page-1)*(a.followerList.rows)+f.rows.length);$("#tabRecent-total-page").empty().append(f.total);
$("#tabRecent-current-page").empty().append(a.followerList.page);if(f.rows&&f.rows.length){var g=new StringBuffer();for(var e=0;e<f.rows.length;e++){g.append(WechatUtil.getRecentLi(f.rows[e]));
}b.append(g.toString());}},function(){},true);},_search:function(){var a=this;var b=$(".jt-search").val();a.searchParam=b;a._loadFollowerList(true);},_showChat:function(b){$(".main-show").hide();
$(".main-hide").show("fast");this.wechatForm.record.page=1;this.wechatForm.record.status=false;this.wechatForm.goToTop=true;this.wechatForm.lastChatTime="";
this.wechatForm.initChat(b);var a=$(".chat-history").height()-$("#csinfo-button-field").outerHeight()-$(".detail-info-tab").outerHeight();$("#csinfo-field-binded").height(a-40);
},_bindEventHander:function(){var a=this;$(document).on("click",".jt-employee-wx-img",function(){$(".jt-employee-wx-img").removeClass("on");$(".current-opt-employee").removeClass("current-opt-employee");
$(this).addClass("on").parent().parent().addClass("current-opt-employee");a.wechatAlias=$(this).attr("alias");a.wechatForm.wechatAlias=a.wechatAlias;a.wechatForm.initWxlabel();
var b=$(this).attr("title");var c=$(this).attr("src");$(".jt-selected-employee-wx-img").attr("src",c);$(".employee-nickname").empty().append(b);a.followerList.page=1;
a._loadFollowerList(true);$(".main-hide").hide();$(".main-show").show("fast");});$(document).on("click",".m-list li",function(f){var g=$(this).attr("data-nickname");
var d=$(this).attr("data-openid");var b=$(this).attr("data-tagids");var c=$(this).find(".msg-not-read");var h=$(this).attr("data-id");if(c.length>0){WechatUtil.addWechatNotRead(-parseInt(c.attr("data-notread")),a.wechatAlias);
WechatUtil.removeNotRead(d);c.remove();}$(".m-list li.active").removeClass("active");$(this).addClass("active");a.wechatForm.openId=d;a.wechatForm.tagIds=b;
a.wechatForm.followerId=h;a.wechatForm.wechatAlias=a.wechatAlias;$("#chat-person").empty().append(g);a._showChat($(this).hasClass("overtime"));});$(document).on("keyup",".jt-search",function(b){if((b.keyCode==13)){a._search();
}});$(document).on("change",".jt-search",function(){var b=$(".jt-search").val();a.searchParam=b;});$(document).on("click","#jt-weixin-search",function(){a._search();
});$("body").on("click",".remove-search-param",function(){$(".jt-search").val("");a.searchParam="";a._search();});$("#tabRecent .m-list").scroll(function(){var b=$(this)[0].scrollHeight-$(this).height()-$(this).scrollTop();
if(b<10&&a.followerList.status&&a.followerList.page<a.followerList.total){a.followerList.status=false;a.followerList.page=a.followerList.page+1;a._loadFollowerList();
}});}};