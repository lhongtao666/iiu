$(function(){var a=new WechatFollower();a.init();});function WechatFollower(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.hadInitJQgrid=false;
}WechatFollower._CONS_={EDIT_URL:ctx+"/crm/wx/wechatFollower/edit.htm",DETAIL_URL:ctx+"/crm/wx/wechatFollower/detail.htm",DELETE_URL:ctx+"/crm/wx/wechatFollower/delete.htm",SAVE_ADD_URL:ctx+"/crm/wx/wechatFollower/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/wx/wechatFollower/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/wx/wechatFollower/listData.htm",LIST_ALL_PLATFORM_URL:ctx+"/crm/wx/wechatPlatform/findAll.htm",LIST_ALIAS_TAG_URL:ctx+"/crm/wx/wechatTag/findByWechatAlias.htm",TAGGING_URL:ctx+"/crm/wx/wechatFollower/tagging.htm",UN_TAGGING_URL:ctx+"/crm/wx/wechatFollower/untagging.htm",EDIT_FORM_ID:"wechatFollowerForm",GRID:"#wechatFollowerGrid",PAGER:"#wechatFollowerPager"};
WechatFollower.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._loadPlatform();
this._hideNotGrantBtn();this._dealStyle();}},_dealStyle:function(){var a=$("body").height();a=a-$(".nav-tabs").outerHeight()-5*2;tempHight=a;a=tempHight-($(".rows-title").outerHeight()+1*2+3);
$("#wechat-alias-list").height(a);},_loadPlatform:function(){var a=this;FormUtils.loadData(WechatFollower._CONS_.LIST_ALL_PLATFORM_URL,function(c){var d=new StringBuffer();
for(var b=0;b<c.length;b++){d.append("<li title='"+c[b].name+"' class='wechat-alias-li' wechat-alias='"+c[b].alias+"'>").append("<img onerror='onImageError();' class='avatar'  src='"+ImageUtils.getTrueUrl(c[b].headImgUrl)+"'>").append("<span class='nickName'>"+c[b].name+"</span>");
d.append("</li>");}$("#wechat-alias-list").empty().append(d.toString());$("#wechat-alias-list").find("li:eq(0)").trigger("click");});},_loadTags:function(){var a=this;
FormUtils.loadData(WechatFollower._CONS_.LIST_ALIAS_TAG_URL+"?wechatAlias="+a.wechatAlias,function(c){var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].tagId+"'>").append(c[b].name).append("</option>");
}$("#jt-select-tag").empty().append(d.toString());});},_selectTags:function(b,c){var a=this;layer.open({title:"<span style='font-weight:600;font-size:18px'>选择标签</span>",type:1,btnAlign:"c",btn:["确定"],area:["400px","400px"],zIndex:"9999",skin:"layui-layer-demo",closeBtn:1,anim:2,content:$(".jt-select-tag"),shadeClose:true,success:function(){a._loadTags();
},yes:function(e,d){layer.close(e);if(c){a._tagging(b);}else{a._untagging(b);}},});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("wechatFollower.button.tag")){$(".wechatFollowerTag").hide();
}if(!ResUtils.canShow("wechatFollower.button.untag")){$(".wechatFollowerUntag").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(WechatFollower._CONS_.EDIT_FORM_ID);FormUtils.enableForm(WechatFollower._CONS_.EDIT_FORM_ID);
if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(WechatFollower._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(WechatFollower._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=openId]").val(c.openId);
$("input[name=wechatAlias]").val(c.wechatAlias);$("input[name=subscribe]").val(c.subscribe);$("input[name=nickName]").val(c.nickName);$("input[name=sex]").val(c.sex);
$("input[name=city]").val(c.city);$("input[name=country]").val(c.country);$("input[name=province]").val(c.province);$("input[name=language]").val(c.language);
$("input[name=headImgUrl]").val(c.headImgUrl);$("input[name=subscribeTime]").val(c.subscribeTime);$("input[name=unionId]").val(c.unionId);$("input[name=remark]").val(c.remark);
$("input[name=groupId]").val(c.groupId);$("input[name=tagIds]").val(c.tagIds);$("input[name=createTime]").val(c.createTime);});},_save:function(){var b=this;
var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=WechatFollower._CONS_.SAVE_EDIT_URL;}else{a=WechatFollower._CONS_.SAVE_ADD_URL;}if($("#wechatFollowerForm").valid()){ButtonUtils.disableBtn("saveBtn");
FormUtils.submitByFormId(a,WechatFollower._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(WechatFollower._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_tagging:function(c){var b=$("#jt-select-tag").val();var a=WechatFollower._CONS_.TAGGING_URL;
var d={ids:c,tagId:b};FormUtils.submit(a,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);$(".wechatFollowerSearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,"失败");});},_untagging:function(c){var b=$("#jt-select-tag").val();
var a=WechatFollower._CONS_.UN_TAGGING_URL;var d={ids:c,tagId:b};FormUtils.submit(a,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
$(".wechatFollowerSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,"失败");});},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){a._save();});$("#"+WechatFollower._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+WechatFollower._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+WechatFollower._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".wechatFollowerSearch").on("click",function(){var b=$(this).closest("form").serialize()+"&Q__S__EQ__follower.wechat_alias_="+a.wechatAlias;a.reloadJqgrid(b);
});$("#wechatFollowerSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".wechatFollowerSearch").trigger("click");}});$("body").on("click",".wechatFollowerAdd",function(){a._add();
});$("body").on("click",".wechatFollowerEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(WechatFollower._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}a._edit(b);});$("body").on("click",".wechatFollowerDel",function(){var b=$(this).attr("idVal");if(!b){b=$(WechatFollower._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".wechatFollowerDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(WechatFollower._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(".wechatFollowerTag").on("click",function(){var b=$(this).attr("idVal");
if(!b){b=$(WechatFollower._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._selectTags(b,true);});$(".wechatFollowerUntag").on("click",function(){var b=$(this).attr("idVal");if(!b){b=$(WechatFollower._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}DialogUtils.confirmWithOptions({title:"您确定取消标签吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._selectTags(b,false);
}});});$(document).on("click",".wechat-alias-li",function(){$(".wechat-alias-li.on").removeClass("on");$(this).addClass("on");var b=$(this).attr("employee-alias");
a.wechatAlias=$(this).attr("wechat-alias");if(a.hadInitJQgrid){var c=$("#wechatFollowerSearchForm").serialize()+"&Q__S__EQ__follower.wechat_alias_="+a.wechatAlias;
a.reloadJqgrid(c);}else{a._initJqgrid();}});},_showWxlabelsPane:function(b){var a=this;layer.open({type:1,title:"打标签",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["400px","400px"],content:$(".jt-wx-label-pane"),success:function(c,d){$("#wxLabels").val("");
},yes:function(d,c){var e=$("#wxLabels").val();layer.close(d);DialogUtils.confirmWithOptions({title:"确定将选中的好友打标签吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._tagging(b,e);
}});},cancel:function(){}});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(WechatFollower._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WechatFollower._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}a["Q__S__EQ__follower.wechat_alias_"]=this.wechatAlias;this.hadInitJQgrid=true;$(WechatFollower._CONS_.GRID).JTJqgrid({url:WechatFollower._CONS_.LIST_DATA_URL,pager:WechatFollower._CONS_.PAGER,postData:a,colNames:["用户头像","微信昵称","归属员工","备注","微信公众号","公众号ID","性别","标签","用户关注时间","操作"],colModel:[{name:"headImgUrl",index:"head_img_url_",width:120,formatter:function(b,e,f){var d="<img onerror='onImageError()' style='display: inline; height:35px;' ";
if(b!=""&&b!=null){var c={url:b,name:"",id:""};d=d+" src='"+ImageUtils.getUrl(c)+"' ";}else{d=d+" src='"+ctx+"/img/jt/defaulTouXiang.png' ";}d+=" >";return d;
}},{name:"nickName",index:"nick_name_",width:120},{name:"employeeAid",index:"emplyee_id_",width:120,formatter:function(b,c,d){return d.employeeAid+":"+d.employeeName;
}},{name:"remark",index:"remark_",width:120},{name:"wechatName",index:"wechat_alias_",width:120},{name:"wechatAlias",index:"wechat_alias_",width:120},{name:"sex",index:"sex_",width:120,formatter:function(b,c,d){if(b==1){return"男";
}else{if(b==2){return"女";}else{return"未知";}}}},{name:"tagNames",index:"tag_ids_",width:120},{name:"subscribeTime",index:"subscribe_time_",width:120},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
}};