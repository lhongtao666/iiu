function WechatForm(){this.lastChatTime="";var a=new Date();a.setDate(a.getDate()-7);this.record={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59"};
this.history={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59",contentSearchParam:"",contentType:"",createTime:""};
this.openId="";this.tagIds="";this.followerId="";this.wechatAlias="";this.weixinTextarea=new WeixinTextarea();}WechatForm._CONS_={LIST_RECODE_DATA_URL:ctx+"/crm/wx/wechatRecord/listData.htm",SAVE_RECODE_URL:ctx+"/crm/wx/wechatRecord/saveAdd.htm",GET_BY_OPEN_ID_URL:ctx+"/crm/wx/wechatFollower/getByOpenId.htm",TAGGING_URL:ctx+"/crm/wx/wechatFollower/tagging.htm",UN_TAGGING_URL:ctx+"/crm/wx/wechatFollower/untagging.htm",FIND_COM_LAN_URL:ctx+"/crm/cs/weixinCommonLan/findByUserId.htm",UPLOAD_PARAMS:{"acceptTypes":"gif,jpg,jpeg,bmp,png,mp3,mp4,avi","mimeTypes":".gif,.jpg,.jpeg,.bmp,.png,.mp3,.mp4,.avi","fileSingleSizeLimit":10*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
WechatForm.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindWebuploader();this.weixinTextarea.init({container:"#chat-textarea"});
this._initCommonLan();}},initWxlabel:function(){var a=this;var b=ctx+"/crm/wx/wechatTag/findByWechatAlias.htm?wechatAlias="+a.wechatAlias;FormUtils.loadData(b,function(c){$(".jt-wx-label-div").empty();
if(c.length>0){var e=new StringBuffer();for(var d=0;d<c.length;d++){e.append("<button class='btn btn-sm btn-info btn-outline jt-wx-label' data-tagid='"+c[d].tagId+"'>"+c[d].name+"</button>");
}$(".jt-wx-label-div").css({height:"34px"});$(".jt-wx-label-div").append(e.toString());}});},_initCommonLan:function(){var a=WechatForm._CONS_.FIND_COM_LAN_URL;
FormUtils.loadData(a,function(b){var d=new StringBuffer();for(var c=0;c<b.length;c++){d.append("<p class='jt-com-lan-p'>"+b[c].content+"</p>");}$("#myComLandiv").empty().append(d.toString());
});},hideChatTextarea:function(){$("#cannot-send-msg-div").show();$("#send-msg-div").hide();},showChatTextarea:function(){$("#cannot-send-msg-div").hide();
$("#send-msg-div").show();},_bindWebuploader:function(){var b=this;function c(g,f){if(f.flag){var h={path:f.localPath,name:f.fileName,size:g.size};b._beforeSendFile(h);
}}function a(f,g){alert("上传"+f.name+"失败，原因是"+g);}function d(){}var e=new JTWebUploader({config:WechatForm._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：.xls格式文件，单个文件最大为1MB",success:c,error:a,finish:d,auto:true});
e.init();},_beforeSendFile:function(b){var a=this;var c=ctx+b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='width:55px;height:66px;' type-value='1' src='"+c+"' class='jt-lager-img'>";
}else{if(c.indexOf(".mp4")!=-1||c.indexOf(".MP4")!=-1){d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='8'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";
}else{d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='7'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";}}$("#chat-textarea").append(d);
a._bindWebuploader();},initChat:function(a){this.lastChatTime="";$("#chat-textarea").attr("contenteditable",true);$(".jt-weixin-sendMsgBtn").attr("disabled",false);
$(".web_wechat_face").removeClass("disabled");$(".web_wechat_pic").removeClass("disabled");this.loadRecord(true);$("#chat-textarea").empty().focus();this._setSearchDate();
this._selectWxLabel();if(a){this.hideChatTextarea();}else{this.showChatTextarea();}},_selectWxLabel:function(){$(".jt-wx-label").removeClass("jt-wx-label-selected");
var b=this.tagIds;if(b!=""&&b!=null){var a=b.split(",");for(var c=0;c<a.length;c++){$(".jt-wx-label[data-tagid='"+a[c]+"']").addClass("jt-wx-label-selected");
}}},_setSearchDate:function(){var a=new Date();a.setDate(a.getDate()-7);this.history.startDate=DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00";this.history.endDate=DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59";
this.history.page=1;this.history.status=false;this.history.contentSearchParam="";this.history.isSign="";this.history.contentType="";$("input[name='startDate']").val(this.history.startDate);
$("input[name='endDate']").val(this.history.endDate);$("input[name='contentSearchParam']").val("");},_showFaceDiv:function(){$("#jt-wx-face-div").show();
$("#jt-wx-face-div").css({top:"-260px",left:"20px"});$(".web_wechat_face").addClass("on");},_hideFaceDiv:function(){$("#jt-wx-face-div").hide();$(".web_wechat_face").removeClass("on");
},_showComLanDiv:function(){$("#jt-wx-common-lan-div").show();$("#jt-wx-common-lan-div").css({top:"-272px",left:"20px"});$(".web_wechat_common_lan").addClass("on");
},_hideComLanDiv:function(){$("#jt-wx-common-lan-div").hide();$(".web_wechat_common_lan").removeClass("on");},loadRecord:function(d){var a=this;var c=$(".m-message").find("ul");
if(d){c.empty();}var b=WechatForm._CONS_.LIST_RECODE_DATA_URL+"?Q__S__EQ__open_id_="+a.openId+"&page="+this.record.page+"&rows="+this.record.rows+"&sord=desc&sidx=create_time_";
FormUtils.loadData(b,function(h){var f=h.rows;a.record.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=$(".m-message").find("ul").height();
for(var e=f.length-1;e>=0;e--){j.append(a._getChartLi(f[e]));}c.prepend(j.toString());if(d){a._gotoBottom();}else{g=$(".m-message").find("ul").height()-g;
$(".m-message").scrollTop(g);}}a.record.status=true;if(a.record.total>a.record.page){$(".jt-more-record-div").show();}else{$(".jt-more-record-div").hide();
}},function(){},true);},_loatRecordHistory:function(d){var b=this;var a=$(".history-message-box").find(".inner-div");if(d){a.empty();}b.lastHistoryTime="";
var c=WechatForm._CONS_.LIST_RECODE_DATA_URL+"?Q__S__EQ__open_id_="+b.openId+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_&"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&Q__S__LK__content_="+encodeURIComponent(this.history.contentSearchParam)+"&Q__S__EQ__content_type_="+this.history.contentType;
FormUtils.loadData(c,function(h){var f=h.rows;b.history.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=a.height();for(var e=f.length-1;e>=0;
e--){if(f[e].type=="out"){f[e].headImgUrl=(f[e].employeeHeadImg==""?ctx+"/img/jt/logos/t9.png":f[e].employeeHeadImg);}j.append(b._getHistoryLi(f[e],true));
}a.prepend(j.toString());if(d){$(".history-message-box").scrollTop($(".history-message-box")[0].scrollHeight);}else{g=a.height()-g;$(".history-message-box").scrollTop(g);
}}b.history.status=true;});},_getHistoryLi:function(d,a){if($("#history-"+d.id).length>0){return"";}var f=new StringBuffer();var e=false;if(this.lastHistoryTime==""){this.lastHistoryTime=DateUtils.format(new Date(d.createTime),"yyyy-MM-dd");
e=true;}else{var b=DateUtils.format(new Date(d.createTime),"yyyy-MM-dd");if(this.lastHistoryTime!=b){this.lastHistoryTime=b;e=true;}}var c=DateUtils.getDateDiff(d.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");
var f=new StringBuffer();if(e){f.append("<p class='time'><span>"+DateUtils.format(new Date(d.createTime),"yyyy-MM-dd")+"</span></p>");}f.append("<div id='history-"+d.id+"' >");
if(d.type=="out"){f.append("<p style='color:#1ab394'>"+(d.employeeAid+":"+d.employeeName)+"  "+DateUtils.format(new Date(d.createTime),"HH:mm"));}else{f.append("<p style='color:#0035ff'>"+(d.nickName)+"  "+DateUtils.format(new Date(d.createTime),"HH:mm"));
}f.append("</p>").append("<p class='history-text'>"+(this._isSearch(a)?("<a class='show-before-and-after' id-value='"+d.id+"' createTime='"+d.createTime+"'>"+WechatUtil._getMsgType(d,a)+"</a>"):WechatUtil._getMsgType(d))).append("</p>").append("</div>");
return f.toString();},_isSearch:function(a){if(a&&!(this.history.isSign==""&&this.history.contentSearchParam=="")){return true;}else{return false;}},_getChartLi:function(b){var c=false;
if(this.lastChatTime==""){this.lastChatTime=b.createTime;c=true;}else{var d=DateUtils.getDateDiff(this.lastChatTime,b.createTime,"minute");if(Math.abs(d)>=3){this.lastChatTime=b.createTime;
c=true;}}var a=DateUtils.getDateDiff(b.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");var e=new StringBuffer();e.append("<li id='"+b.id+"' >");
if(c){if(Math.abs(a)<24){e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"HH:mm")+"</span></p>");}else{e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"yyyy-MM-dd HH:mm")+"</span></p>");
}}e.append("<div class='main-li "+(b.type=="out"?"self":"")+"'>");e.append("<img class='avatar' width='30' height='30' src='"+WechatUtil._getHeadImgUrl(b)+"'>").append("<div class='text'>"+WechatUtil._getMsgType(b)+"</div>");
e.append("</div></li>");return e.toString();},_gotoBottom:function(){$(".m-message").scrollTop($(".m-message")[0].scrollHeight);},_receiveMessage:function(b){var a=this;
if(a.wechatAlias!=b.wechatAlias){WechatUtil.addWechatNotRead(1,b.wechatAlias);}else{var d=$("#"+b.openId);if(d&&d.length>0){d.remove();if(b.type=="in"){d.removeClass("overtime");
d.find(".is-overtime").remove();}$("#tabRecent .m-list ul").prepend(d);d.find(".last-content").empty().append(WechatUtil.getContent(b));if(b.type=="out"){$(".m-message").find("ul").append(a._getChartLi(b));
a._gotoBottom();}else{if(!d.hasClass("active")){var f=d.find(".msg-not-read");if(f.length>0){var e=parseInt(f.attr("data-notread"));var c=e+1;if(c>99){c=99;
}f.empty().append(c).attr("data-notread",e+1);}else{d.find(".avatar").after("<span class='badge badge-danger pull-right msg-not-read' data-notread='1'>1</span>");
}WechatUtil.addWechatNotRead(1,b.wechatAlias);}else{$(".m-message").find("ul").append(a._getChartLi(b));a._gotoBottom();WechatUtil.removeNotRead(b.openId);
}}}else{a._loadByOpenId(b.openId,function(){},true);}}},_loadByOpenId:function(e,c,d){var a=this;var b=WechatForm._CONS_.GET_BY_OPEN_ID_URL;FormUtils.loadData(b+"?openId="+e,function(f){if(f){$("#tabRecent .m-list ul").prepend(WechatUtil.getRecentLi(f));
}if(c&&typeof c=="function"){c();}if(d){}},function(){},true);},_bindEventHander:function(){var a=this;window.onmessage=function(c){var b=JSON.parse(c.data);
if(b&&b.messageType=="wechatMsg"){a._receiveMessage(b);}};$("body").on("click","#chat-textarea",function(){a._hideFaceDiv();a._hideComLanDiv();});$(".web_wechat_face").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideFaceDiv();}else{a._hideComLanDiv();a._showFaceDiv();}});$(".web_wechat_common_lan").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideComLanDiv();}else{a._hideFaceDiv();a._showComLanDiv();}});$(document).on("click",".face",function(){if($(this).hasClass("conten-face")){return;
}var c=$(this).html();var b=$(this).attr("class");$("#chat-textarea").append(c);a._hideFaceDiv();});$(document).on("click",".jt-com-lan-p",function(){var b=$(this).text();
$("#chat-textarea").append(b);a._hideComLanDiv();});$(".web_wechat_pic").on("click",function(){if($(this).hasClass("disabled")){return false;}$("#filePicker").find(".webuploader-element-invisible").click();
});$(document).on("click",".jt-weixin-sendMsgBtn",function(){a.send();});$(document).on("keydown","#chat-textarea",function(b){var c=$(this).val();if(b.keyCode==13){if(!b.ctrlKey){a.send();
}}});$(document).on("click",".jt-video",function(){var b=$(this).attr("src-data");WeiXinUtil.showPlayVideotLayer(b);});$(document).on("click",".jt-lager-img",function(c){c.stopPropagation();
var b=$(this).attr("src");var d="大图";$.fancybox.open([{href:b,title:d}]);});$(document).on("click",".jt-audio",function(){var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();
$(".jt-audio").find("i").css({"background-position":"-4px center"});clearInterval(a.audioEndTime);clearInterval(a.timer_);}var e=d.find("i").attr("src-value");
if(!d.find("audio").attr("src")){d.find("audio").attr("src",e);d.find("audio")[0].load();}var g=$(this).attr("id-value");var f=$(this).attr("createtime");
if(!d.find("span").is(".is-ready")){d.find("span").addClass("is-ready").empty().append("加载中...");}var c=-4,b=0;a.audioEndTime=setInterval(function(){if(d.find("audio")[0].readyState){a.audio=d.find("audio")[0];
d.find("span").empty().append(d.find("audio")[0].duration.toFixed(1)+"''");d.find("audio")[0].play();clearInterval(a.audioEndTime);a.timer_=setInterval(function(){c-=18;
d.find("i").css({"background-position":c+"px center"});if(c==-58){c=14;}if(d.find("audio")[0].ended){clearInterval(a.timer_);d.find("i").css({"background-position":"-4px center"});
a.audio=null;}},500);}if(b/(1000*60)>=5){clearInterval(timer);a.playing=null;}b+=500;},500);});$(".m-message").scroll(function(){var b=$(this).scrollTop();
if(b<10&&a.record.status&&a.record.page<a.record.total){a.record.status=false;a.record.page=a.record.page+1;a.loadRecord();}});$(document).on("click",".jt-weixin-history",function(){var b=$("body").height();
if(b<600){b=b*0.9;}else{b=600;}a.recordLayer=layer.open({type:1,title:"聊天记录",shade:false,area:["650px",b+"px"],offset:"5%",content:$(".jt-new-weixin-record-pane"),scrollbar:true,success:function(c,d){$("#recordAllTabLi").trigger("click");
$(".record-history-tab li").removeClass("active");$("#recordAllTabLi").addClass("active");},yes:function(d,c){}});});$(document).on("click",".record-history-tab li",function(){var b=$(this).attr("data-contentType");
a.history.contentType=b;$(".search-history-btn").trigger("click");});$(document).on("click",".search-history-btn",function(){a.history.page=1;a.history.status=false;
a.history.startDate=$("input[name='startDate']").val();a.history.endDate=$("input[name='endDate']").val();a.history.contentSearchParam=$("input[name='contentSearchParam']").val();
a._loatRecordHistory(true);});$(document).on("click",".clear-history-btn",function(){$("input[name='contentSearchParam']").val("");});$(document).on("click",".prePage",function(){var b=$("input[name='startDate']").val();
var c=$("input[name='endDate']").val();$("input[name='startDate']").val(DateUtils.getBeforeDate(7,b)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getBeforeDate(7,c)+" 23:59:59");
$(".search-history-btn").trigger("click");$(this).blur();});$(document).on("click",".nextPage",function(){var b=$("input[name='startDate']").val();var c=$("input[name='endDate']").val();
$("input[name='startDate']").val(DateUtils.getAfterDate(7,b)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getAfterDate(7,c)+" 23:59:59");$(".search-history-btn").trigger("click");
$(this).blur();});$(".history-message-box").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.history.status&&a.history.page<a.history.total){a.history.status=false;
a.history.page=a.history.page+1;a._loatRecordHistory();}});$(".jt-wx-label-div").on("mouseenter",function(){$(this).css({height:"auto"});}).on("mouseleave",function(){$(this).css({height:"34px"});
});$(document).on("click",".jt-wx-label",function(){var b=$(this).attr("data-tagid");if($(this).hasClass("jt-wx-label-selected")){a._untagging(b,this);
}else{a._tagging(b,this);}$(this).blur();});$("#jt-edit-con-lan").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weixinCommonLan/list.htm","我的常用语");
});},_tagging:function(c,d){var b=WechatForm._CONS_.TAGGING_URL;var e={ids:this.followerId,tagId:c};var f=this.openId;var a=this;FormUtils.submit(b,e,function(g){if(g.success){DialogUtils.success(msgCode.INFO,g.msg);
$(d).addClass("jt-wx-label-selected");a._addTag(f,c);}else{DialogUtils.error(msgCode.ERROR,g.msg);}},function(){DialogUtils.error(msgCode.ERROR,"失败");});
},_untagging:function(c,d){var b=WechatForm._CONS_.UN_TAGGING_URL;var e={ids:this.followerId,tagId:c};var f=this.openId;var a=this;FormUtils.submit(b,e,function(g){if(g.success){DialogUtils.success(msgCode.INFO,g.msg);
$(d).removeClass("jt-wx-label-selected");a._removeTag(f,c);}else{DialogUtils.error(msgCode.ERROR,g.msg);}},function(){DialogUtils.error(msgCode.ERROR,"失败");
});},_removeTag:function(e,d){var c=$("#"+e).attr("data-tagids");var a=c.split(",");var f="";for(var b=0;b<a.length;b++){if(a[b]!=d){f=f+a[b]+",";}}if(f!=""){$("#"+e).attr("data-tagids",f.substring(0,f.length-1));
}else{$("#"+e).attr("data-tagids","");}},_addTag:function(c,b){var a=$("#"+c).attr("data-tagids");if(a){$("#"+c).attr("data-tagids",a+","+b);}else{$("#"+c).attr("data-tagids",b);
}},send:function(){var a=this;var c=a.weixinTextarea.getValue();$("#chat-textarea").empty();for(var b=0;b<c.length;b++){var d={content:encodeURIComponent(c[b].content),contentType:a._getContenType(c[b].contentType),employeeId:currentUserId,openId:a.openId,wechatAlias:a.wechatAlias};
a._sendFinal(d);}},_getContenType:function(a){if(a==0){return"text";}else{if(a==1){return"image";}else{if(a==2){return"voice";}else{if(a==8){return"video";
}}}}},_sendFinal:function(b){var a=this;FormUtils.submit(WechatForm._CONS_.SAVE_RECODE_URL,b,function(c){if(c.success){}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},};