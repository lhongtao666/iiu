function ImService(){this.base=IMbase;this.hadInit=false;this.isOnline="n";this.onlineTextarea=new OnlineTextarea();this.sdk=null;this.friendImUserId="";
this.access={id:imUserId,server:IMserver,token:token};this.aimJson=null;this.img="/img/jt/defaulTouXiang.png";this.winPage={pageSize:50,pageNo:1,total:0};
this.sessionList=[];this.timeoutReference=null;}ImService._CONS_={LIST_GROUP_URL:ctx+"/gl/ou/group/findAllGroupWithEmployee.htm",LIST_EMPLOYEE_URL:ctx+"/crm/ou/employee/findImEmpByGroupId.htm",LIST_SEARCH_EMP_URL:ctx+"/crm/ou/employee/findImEmpByParam.htm",SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CS_DETAIL_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",};
ImService.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._initGroup();$(".pg-pm-thumb").show();this._bindEventHander();this.onlineTextarea.init({container:"#online-textarea"});
this.linkToServer();this.loadOnlineCurrentList();}},loading:function(d,a,e){var b=this;var c="<div style='width:100%;margin-top:10px;text-align: center;color: #999;cursor:"+(a?"wait":"pointer")+";'>";
if(a){c+="<i class='fa fa-spinner fa-pulse' style='font-size:1.35em;margin-right: 5px;'></i>正在努力加载数据....";}else{c+="<i class='fa fa-frown-o' style='font-size:1.35em;margin-right: 5px;'></i>没有可查阅的数据....";
}c+="</div>";if(e){$(d).empty();}$(d).append(c);},resizeImg:function(c,a){var b=this;},timeToDate:function(b,k,a){var d="年",j="月",m="日 ";if(k){d=k;if(k&&a){j=a;
}else{if(k&&!a){j=k;}}m=" ";}var l=new Date(b),i=l.getFullYear(),h=l.getMonth()+1,e=l.getDate(),g=l.getHours(),f=l.getMinutes(),c=l.getSeconds();if(h<10){h="0"+h;
}if(e<10){e="0"+e;}if(g<10){g="0"+g;}if(f<10){f="0"+f;}if(c<10){c="0"+c;}return i+d+h+j+e+m+g+":"+f+":"+c;},loadOnlineCurrentList:function(){var a=this;
var c=0;var b="";onlineUtils.ajax(a.base+"/imsession/getUserSessionList",{pageSize:1000,pageNo:1},"GET",function(e){console.log(e);if(e.code!=0||!e.data){return false;
}var d="";a.sessionList=e.data.list;$.each(e.data.list,function(f,g){d+=a.onlineCurrentLi(this);c+=this.msgNum;});if(d){$("#online-current-list").empty().append(d);
a.resizeImg($("#online-current-list .head-img-span img"),45);}else{a.loading($("#online-current-list"),false,true);}if(c>0){$(".pg-pm-thumb .num").empty().append(c).show();
}},function(d,f,e){console.log("请求失败...");},{"x-token":a.access.token});},caculateUnread:function(){var b=0;var a=$(".online-current-list li");$.each(a,function(d,f){var c=$(this).find(".user-msg-unread").text();
b+=parseInt(c?c:0);});if(b>0){$(".pg-pm-thumb .num").empty().append(b).show();}else{$(".pg-pm-thumb .num").empty().append(b).hide();}},onlineCurrentLi:function(c,d){var a=this;
var e=new StringBuffer();var b=ctx+a.img;if(c.toUserInfo.headImg){b=onlineUtils.getRealUrl(c.toUserInfo.headImg);}e.append("<li "+(d?"class='online-current-active'":"")+"data-headImg='"+c.toUserInfo.headImg+"'data-nickname='"+c.toUserInfo.nickName+"'"+" data-id='"+c.toUserId+"' data-sId='"+c.sId+"' data-toUserId='"+c.toUserId+"' data-empsId='"+c.id+"' data-sysId='"+c.toUserInfo.sysId+"' data-reply='"+c.recTime+"'"+(c.toUserInfo.phone?(" data-phone='"+c.toUserInfo.phone+"'"):"")+" data-type='"+c.toUserInfo.type+"'"+(c.firstReplyTime?(" data-first='"+c.firstReplyTime+"'"):"")+">").append("<div class='online-user-img'><span class='head-img-span'><img onerror='onImageError()' src='"+b+"' draggable='false'></span>");
if(c.msgNum&&c.msgNum>0){e.append("<div class='user-msg-unread' data-unread='"+c.msgNum+"'>"+((c.msgNum>99)?99:c.msgNum)+"</div>");}e.append("</div>").append("<div class='online-user-msg'>").append("<div class='user-msg-top' data-name='"+c.toUserInfo.nickName+"' title='"+c.toUserInfo.nickName+"'>"+c.toUserInfo.nickName).append("</div>").append("<div class='user-msg-bottom'>").append(onlineUtils.getNewestMsg(c)).append("</div>").append("</div>").append("</li>");
return e.toString();},loadOnlineContnet:function(a){var b=this;var d="";var c=1;if(a){c=a;}if(!$(".online-ss-main").is(".win-loading")){$(".online-ss-main").addClass("win-loading");
}if(!b.aimJson.sid){return;}onlineUtils.ajax(b.base+"/msg/getImMessageList",{pageSize:b.winPage.pageSize,pageNo:c,sId:b.aimJson.sid},"GET",function(i){b.timestamp=i.timestamp;
b.winPage.pageNo=i.data.pageNum;b.winPage.total=i.data.total;b.winPage.fn="loadOnlineContnet";if(a){$(".online-ss-list").children("div").remove();}if(i.data&&i.data.list.length>0){var e=null;
var h=null;var g=i.data.list.length;$.each(i.data.list,function(k,l){g--;var j=b.timeToDate(this.sendTime,"-");d=b.onlineWindowsLi(this)+d;if(!e||(e&&j.indexOf(e.substr(0,16))==-1)){d=onlineUtils.loadSysMessage(j)+d;
h=j;}else{if(g==0){d=onlineUtils.loadSysMessage(j)+d;}}e=j;});d=onlineUtils.loadSysMessage(b.timeToDate(e))+d;}if(!a){$(".online-ss-list").empty().append(d);
b.rollToBottom($(".online-ss-main"));b.removeUnRead();if($(".online-ss-main").is(".win-loading")){$(".online-ss-main").removeClass("win-loading");}}else{var f=$(".online-ss-list").html();
$(".online-ss-list").empty().append(d);b.rollToBottom($(".online-ss-main"),1);$(".online-ss-list").append(f);$(".online-ss-main").removeClass("win-loading");
}},function(e,g,f){$(".online-ss-main").removeClass("win-loading");},{"x-token":b.access.token});},isExist:function(b){var a=this;var c=false;$("#online-current-list").find("li").each(function(d,f){if($(this).attr("data-touserid")==b){c=$(this);
return false;}});return c;},removeUnRead:function(){var a=this;var b=a.isExist(a.aimJson.id);onlineUtils.ajax(a.base+"/imsession/cleanSessionMsg",{sId:a.aimJson.sid},"GET",function(c){$(b).find(".user-msg-unread").empty().removeAttr("data-unread").hide();
a.caculateUnread();},function(c,e,d){},{"x-token":a.access.token});},linkToServer:function(){var a=this;a.sdk=new imSDK("ws://"+a.access.server+"/im/"+a.access.token,a.access.id,function(b){a.sCallBack(b);
},true);},sCallBack:function(d){var c=this;var b={id:0,msgBody:d.getMsgdata().getMsgbody(),msgType:d.getMsgdata().getMsgtype(),createTime:"",fromUserId:Long.fromValue(d.getMsgdata().getFromuser().getId()).toString(),profile:""};
if(c.aimJson&&b.fromUserId==c.aimJson.id){$(".online-ss-list").append(c.onlineWindowsLi(b));c.rollToBottom($(".online-ss-main"));c.removeUnRead();}else{var a=$(".pg-pm-thumb .num").text();
var e=parseInt(a?a:0)+1;$(".pg-pm-thumb .num").empty().append(e).show();c.matchMessage(b.fromUserId,Long.fromValue(d.getMsgdata().getSessionid()).toString());
}$("#online-current-list").find("[data-touserid='"+b.fromUserId+"']").find(".user-msg-bottom").empty().append(onlineUtils.getNewestMsg2(b));},matchMessage:function(e,c){var a=this;
var d=false;var b=$("#online-current-list").children();b.each(function(f,g){if($(this).attr("data-touserid")==e){a.loadUnRead(this,1);d=true;return false;
}});if(!d){console.log("没有匹配的记录");a.findSsBySid(c);}},findSsBySid:function(b){var a=this;onlineUtils.ajax(a.base+"/imsession/getSessionInfo",{sId:b},"GET",function(d){console.log(d);
a.timestamp=d.timestamp;var c=d.data;c.id=d.data.empSid;a.addOneLi($("#online-current-list"),c);},function(c,e,d){console.log("请求失败...");},{"x-token":a.access.token});
},addOneLi:function(c,b){var a=this;if($(c).children("li").length==0){$(c).empty();}if(!a.isExist(b.toUserId)){$(a.onlineCurrentLi(b)).prependTo(c).each(function(d,f){});
}},loadUnRead:function(e,b){var a=this;var d="<div class='user-msg-unread' data-unread='"+b+"'>"+(b>99?99:b)+"</div>";if($(e).find(".user-msg-unread").length>0){var f=$(e).find(".user-msg-unread");
var c=0;if(f.attr("data-unread")){c=parseInt(f.attr("data-unread"));}if(c<99){f.attr("data-unread",c+1).empty().text(c+1).show();}else{f.attr("data-unread",c+1).show();
}}else{$(e).find(".online-user-img").append(d);}a.toTop($("#online-current-list"),e);},toTop:function(b,d){var a=this;var c=$(d).clone(true);$(b).prepend(c);
$(d).remove();},_initGroup:function(){var a=ImService._CONS_.LIST_GROUP_URL+"?isOnline="+this.isOnline;FormUtils.loadData(a,function(c){var d=new StringBuffer();
for(var b=0;b<c.length;b++){d.append("<li class='jt-im-group-li'").append("data-id='"+c[b].id+"'").append(" >").append("<div class='jt-im-group-name'>"+c[b].name+"<span class='blue'>("+c[b].employeeCount+")</span></div>").append("<ul class='jt-im-employee-ul'></ul>").append("</li>");
}$("#im-friends-ul").empty().append(d.toString());});},_initEmployee:function(d,c){var a=this;var b=ImService._CONS_.LIST_EMPLOYEE_URL+"?groupId="+c+"&isOnline="+this.isOnline;
FormUtils.loadData(b,function(g){var h=new StringBuffer();for(var f=0;f<g.length;f++){var e=ctx+a.img;if(g[f].profile){e=onlineUtils.getRealUrl(g[f].profile);
}h.append("<li class='jt-im-employee-li'").append("data-id='"+g[f].id+"'").append("data-name='"+g[f].name+"'").append("data-aid='"+g[f].aid+"'").append("data-profile='"+g[f].profile+"'").append("data-imuserid='"+g[f].imUserId+"'").append(" >").append("<div class='online-user-img'>").append("<span class='head-img-span'>").append("<img onerror='onImageError()' src='"+e+"'>").append("</span></div>").append("<div class='online-user-msg'>").append("<div class='user-msg-top'>").append(g[f].aid+":"+g[f].name).append("</div><div class='user-msg-bottom "+(g[f].isOnline=="y"?"on":"leav")+"'>").append(g[f].isOnline=="y"?"在线":"离线").append("</div></div>").append("</li>");
}d.find(".jt-im-employee-ul").empty().append(h.toString()).slideDown(500);});},searchImEmployee:function(){var a=this;var c=$(".search-text").val();if(c==""||c==null){return;
}var b=ImService._CONS_.LIST_SEARCH_EMP_URL+"?searchParam="+c;FormUtils.loadData(b,function(f){if(f.length<=0){$(".pm-no-history").empty().append("没有找到 “"+c+"” 的相关搜索结果");
$(".pg-pm-searchtab .message-tab").show();$(".pg-pm-searchtab .jt-im-search-ul").hide();$(".jt-im-search-ul").empty();}else{var g=new StringBuffer();for(var e=0;
e<f.length;e++){var d=ctx+a.img;if(f[e].profile){d=onlineUtils.getRealUrl(f[e].profile);}g.append("<li class='jt-im-search-li'").append("data-id='"+f[e].id+"'").append("data-name='"+f[e].name+"'").append("data-aid='"+f[e].aid+"'").append("data-profile='"+f[e].profile+"'").append("data-imuserid='"+f[e].imUserId+"'").append(" >").append("<div class='online-user-img'>").append("<span class='head-img-span'>").append("<img onerror='onImageError()' src='"+d+"'>").append("</span></div>").append("<div class='online-user-msg'>").append("<div class='user-msg-top'>").append(f[e].aid+":"+f[e].name).append("</div><div class='user-msg-bottom "+(f[e].isOnline=="y"?"on":"leav")+"'>").append(f[e].isOnline=="y"?"在线":"离线").append("</div></div>").append("</li>");
}$(".pg-pm-searchtab .message-tab").hide();$(".pg-pm-searchtab .jt-im-search-ul").show();$(".jt-im-search-ul").empty().append(g.toString());}});},uploader:function(){var c=this;
c.files=[];function d(i,h){if(h.flag){var j={height:h.height,width:h.width,path:h.localPath,name:h.fileName,size:i.size};c.files.push(j);c.beforeSendFile();
}}function a(h,i){alert("上传"+h.name+"失败，原因是"+i);}function e(){}var g=".*",b=".*";var f=new JTWebUploader({config:{"acceptTypes":g,"mimeTypes":b,"fileSingleSizeLimit":100*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"},container:"uploader",caption:"支持所有格式的文件上传！单个文件不得超过100M，一次最多上传10个文件！",success:d,error:a,finish:e,auto:true});
f.init();setTimeout(function(){$("#filePicker").find(".webuploader-element-invisible").trigger("click");},1);},beforeSendFile:function(){var a=this;var b=a.files[a.files.length-1];
var c=b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='height:66px;' data-src='"+c+"'  src='"+onlineUtils.getRealUrl(c)+"' class='online-large-img'/>";
}else{if(c.indexOf(".mp3")!=-1||c.indexOf(".amr")!=-1||c.indexOf(".MP3")!=-1){d="<img src='"+onlineUtils.getFileCoverUrl(c)+"' file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"' data-type='audio'>";
}else{d="<img src='"+onlineUtils.getFileCoverUrl(c)+"' file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"' data-type='file'>";}}$("#online-textarea").append(d);
},onlineWindowsLi:function(d){var b=this;if(d.msgType=="system"){return onlineUtils.loadSysMessage(d.msgBody);}if(d.msgType=="custom"){var a=d.msgBody;
if(typeof a=="string"){a=JSON.parse(d.msgBody);}if(a.type=="connecting"){return"";}}var f=new StringBuffer();var c=ctx+b.img;if(b.aimJson.id==d.fromUserId){c=onlineUtils.getRealUrl(b.aimJson.profile);
}else{if(d.formUserBo){if(d.formUserBo.headImg){c=onlineUtils.getRealUrl(d.formUserBo.headImg);}}else{if(d.profile){c=onlineUtils.getRealUrl(d.profile);
}}}var e="";if((b.aimJson.id!=d.fromUserId)&&d.fromUserId!=b.access.id){e=" is-not-mine";}f.append("<li class='"+(b.aimJson.id==d.fromUserId?"online-ss-in":"online-ss-out")+e+"' data-id='"+d.id+"' data-time='"+d.sendTime+"'>").append(" <img onerror='onImageError()' class='avatar' width='35' height='35' draggable='false' src='"+c+"'>").append("<div class='text "+(d.msgType=="text"?"pure-text":"")+"'>"+onlineUtils.chgMessage(d.msgBody,d.msgType)+"</div>");
f.append("</li>");return f.toString();},send:function(){var a=this;var b=a.onlineTextarea.getValue();console.log(b);if(b.length==0){DialogUtils.error(msgCode.ERROR,"请输入消息内容...");
return false;}$.each(b,function(f,g){var d=this.content;var c={id:0,msgBody:this.content,msgType:this.contentType,createTime:"",fromUserId:a.access.id,profile:currentUserProfile};
if(this.contentType=="file"){d=JSON.stringify(this.contents);c.msgBody=this.contents;}a.sdk.send("",a.aimJson.id,1,this.contentType,d);$(".online-ss-list").append(a.onlineWindowsLi(c));
a.rollToBottom($(".online-ss-main"));$("#online-current-list").find("[data-touserid='"+a.aimJson.id+"']").find(".user-msg-bottom").empty().append(onlineUtils.getNewestMsg2(c));
});$("#online-textarea").empty();},rollToBottom:function(d,b){var a=this;var c=250;if(b){c=b;}$(d).animate({scrollTop:$(d).children().height()},c);},getAimJson:function(c,b){this.aimJson={id:c,profile:b};
for(var a=0;a<this.sessionList.length;a++){if(this.sessionList[a].toUserId==c){this.aimJson={id:c,profile:b?b:this.sessionList[a].toUserInfo.headImg,sid:this.sessionList[a].sId};
break;}}},initFancybox:function(b){var a=this;$.fancybox(b);},_bindEventHander:function(){var a=this;$(document).on("click",".online-large-img",function(d){d.stopPropagation();
var c=$(this).attr("src");var f="大图";a.initFancybox([{title:f,href:c}]);});$("#communicateTabLi").on("click",function(){a.loadOnlineCurrentList();});$("body").on("click",".soTab",function(){var c=$(this).attr("value");
JTTabUtils.addOrRefreshTab(ImService._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+c,c+"明细");});$(document).on("click",".csTab",function(d){var c=$(this).attr("value");
if(!c){DialogUtils.error("错误","客户编号为空,无法找到该客户");return;}FormUtils.submit(ctx+"/crm/cs/csEntity/getCsByCode.htm",{csCode:c},function(e){if(!$.isEmptyObject(e)){var f=e.id;
JTTabUtils.addOrRefreshTab(ImService._CONS_.CS_DETAIL_PAGE_URL+"?csId="+f,"客户["+e.name+"]明细");}else{DialogUtils.error("错误","没有找到客户,可能已被删除,请通过客户查询查找客户");
}});d.preventDefault();d.stopPropagation();});$(".search-text").on("focus",function(){$(".pg-pm-content .tabs-container").hide();$(".pg-pm-content .pg-pm-searchtab").show();
$(".pg-pm-search .cancel").show();});var b="input";if(navigator.userAgent.indexOf("MSIE")!=-1){b="propertychange";}$(".search-text").on(b,function(c){if(a.timeoutReference){clearTimeout(a.timeoutReference);
}a.timeoutReference=setTimeout(function(){a.searchImEmployee();},500);});$(".pg-pm-search .cancel").on("click",function(){$(".pg-pm-search .cancel").hide();
$(".pg-pm-content .tabs-container").show();$(".pg-pm-content .pg-pm-searchtab").hide();$(".search-text").val("");$(".pg-pm-searchtab .message-tab").show();
$(".pg-pm-searchtab .jt-im-search-ul").hide();$(".jt-im-search-ul").empty();$(".pm-no-history").empty().append("搜索：同事姓名、工号");});$(".pg-pm-thumb").on("click",function(){$(".pg-pm-content").show();
});$(".pg-pm-close").on("click",function(){$(".pg-pm-content").hide();$(".pg-pm-messagebox").hide();$(".online-current-active").removeClass("online-current-active");
a.aimJson={};});$(".pm-messagebox-header .close").on("click",function(){$(".pg-pm-messagebox").hide();$(".online-current-active").removeClass("online-current-active");
a.aimJson={};});$(document).on("click",".jt-im-group-name",function(){if($(this).hasClass("active")){$(this).removeClass("active");$(this).parents(".jt-im-group-li").find(".jt-im-employee-ul").slideUp(500);
}else{$(".jt-im-group-name").removeClass("active");$(".jt-im-group-li").find(".jt-im-employee-ul").slideUp(500);$(this).addClass("active");var d=$(this).parents(".jt-im-group-li");
var c=d.attr("data-id");a._initEmployee(d,c);}});$(document).on("click",".jt-im-employee-li",function(){if($(this).is(".jt-im-employee-li-active")){}else{$(".jt-im-employee-li-active").removeClass("jt-im-employee-li-active");
$(this).addClass("jt-im-employee-li-active");}var d=$(this).attr("data-imuserid");var c=$(this).attr("data-name");var f=$(this).attr("data-aid");var e=$(this).attr("data-profile");
a.getAimJson(d,e);$(".pm-messagebox-header .name").empty().append(f+":"+c);$(".online-ss-list").empty();$(".pg-pm-messagebox").show();a.loadOnlineContnet();
});$(document).on("click",".jt-im-search-li",function(){if($(this).is(".jt-im-search-li-active")){}else{$(".jt-im-search-li-active").removeClass("jt-im-search-li-active");
$(this).addClass("jt-im-search-li-active");}var d=$(this).attr("data-imuserid");var c=$(this).attr("data-name");var f=$(this).attr("data-aid");var e=$(this).attr("data-profile");
a.getAimJson(d,e);$(".pm-messagebox-header .name").empty().append(f+":"+c);$(".online-ss-list").empty();$(".pg-pm-messagebox").show();a.loadOnlineContnet();
});$(document).on("click",".online-current-list li",function(){if($(this).is(".online-current-active")){}else{$(".online-current-active").removeClass("online-current-active");
$(this).addClass("online-current-active");}var e=$(this).attr("data-id");var d=$(this).attr("data-nickname");var f=$(this).attr("data-headImg");var c=$(this).attr("data-sid");
a.aimJson={id:e,profile:f,sid:c};$(".pm-messagebox-header .name").empty().append(d);$(".online-ss-list").empty();$(".pg-pm-messagebox").show();a.loadOnlineContnet();
});$(document).on("click",".online-editor-btn a",function(i){var h=$(this);if(h.is(".web_wechat_face")){if($(".online-face-layer").is(":hidden")){$(".online-ss-layer").hide();
$(".online-face-layer").show();}else{$(".online-ss-layer").hide();}}else{if(h.is(".web_wechat_file")){a.uploader();}else{if(h.is(".web_wechat_so")){if($(".online-so-layer").is(":hidden")){$(".online-ss-layer").hide();
$(".online-so-layer").show();var g=$("iframe:visible");if(g.length>0){var d=$(g[0].contentWindow.document).find("input[name='soNo']").val();if(!d){var f=$(g[0].contentWindow.document).find("iframe:visible");
if(f.length>0){d=$(f[0].contentWindow.document).find("input[name='soNo']").val();}}$(".online-so-layer").find("input[name='im-so']").val(d?d:"");}}else{$(".online-ss-layer").hide();
}}else{if(h.is(".web_wechat_cs")){if($(".online-cs-layer").is(":hidden")){$(".online-ss-layer").hide();$(".online-cs-layer").show();var g=$("iframe:visible");
if(g.length>0){var c=$(g[0].contentWindow.document).find("input[name='csCode']").val();if(!c){var f=$(g[0].contentWindow.document).find("iframe:visible");
if(f.length>0){c=$(f[0].contentWindow.document).find("input[name='csCode']").val();}}$(".online-cs-layer").find("input[name='im-cs']").val(c?c:"");}}else{$(".online-ss-layer").hide();
}}}}}});$(document).on("click","body",function(d){var c=$(d.target);if(!c.is(".online-face-layer,.qqface,.web_wechat_face")&&!$(".online-face-layer").is(":hidden")){$(".online-face-layer").hide();
}if(c.parents(".online-so-layer").length<=0&&!c.is(".online-so-layer,.web_wechat_so")&&!$(".online-so-layer").is(":hidden")){$(".online-so-layer").hide();
}if(c.parents(".online-cs-layer").length<=0&&!c.is(".online-cs-layer,.web_wechat_cs")&&!$(".online-cs-layer").is(":hidden")){$(".online-cs-layer").hide();
}});$(document).on("click",".qq_face .qqface",function(c){$("#online-textarea").append("<img src='"+ctx+"/img/jt/wx/images/blank.png' class='"+$(this).attr("class")+"' data-value='"+$(this).text()+"' />");
a.onlineTextarea.focusin();});$(document).on("click",".online-sending-btn",function(c){a.send();});$(document).on("keydown","#online-textarea",function(d){var c=$(this).val();
if(d.keyCode==13){if(!d.ctrlKey){a.send();}}});$(document).on("click",".download-file",function(){window.location.href=ctx+"/crm/components/upload/download.htm?dname="+encodeURIComponent($(this).attr("download-name"))+"&durl="+encodeURIComponent($(this).attr("download-url"));
});$(".online-so-layer .jt-form-select").on("click",function(){var d=$(".online-so-layer").find("input[name='im-so']").val();if(!d){DialogUtils.error(msgCode.ERROR,"请输入订单号");
return;}else{var c=/^[0-9]*$/;if(!c.test(d)){DialogUtils.error(msgCode.ERROR,"请确定是否是正确的单号");}else{d="#S"+d+"#";$("#online-textarea").append(d);$(".online-so-layer").find("input[name='im-so']").val("");
$(".online-so-layer").hide();}}});$(".online-cs-layer .jt-form-select").on("click",function(){var d=$(".online-cs-layer").find("input[name='im-cs']").val();
if(!d){DialogUtils.error(msgCode.ERROR,"请输入客户编号");return;}else{var c=/^[0-9]*$/;if(!c.test(d)){DialogUtils.error(msgCode.ERROR,"请确定是否是正确的客户编号");}else{d="#C"+d+"#";
$("#online-textarea").append(d);$(".online-cs-layer").find("input[name='im-cs']").val("");$(".online-cs-layer").hide();}}});$(".online-ss-main").on("scroll",function(){var c=Math.ceil($(this).scrollTop());
if(c==0){if(!$(this).is(".win-loading")){$("<div style='width:100%;margin:10px 0;text-align: center;color: #999;cursor:wait;'><i class='fa fa-spinner fa-pulse' style='font-size:1.35em;margin-right: 5px;'></i>正在努力加载数据....</div>").prependTo(".online-ss-list");
$(this).addClass("win-loading");if(a.winPage.pageSize*a.winPage.pageNo<a.winPage.total){a.loadOnlineContnet(a.winPage.pageNo+1);}else{if($(".online-ss-list").children("div").length>0){$(this).removeClass("win-loading");
}}$(".online-ss-list").children("div").remove();}else{}}});},};