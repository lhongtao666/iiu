$(function(){var a=new LevelChange();a.init();});function LevelChange(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}LevelChange._CONS_={DIARY_URL:ctx+"/crm/point/levelChange/diary.htm",EDIT_URL:ctx+"/crm/point/levelChange/detail.htm",LIST_DATA_URL:ctx+"/crm/point/levelChange/listData.htm",KEYSEARCH_URL:ctx+"/crm/point/levelChange/keySearch.htm",EDIT_FORM_ID:"levelChangeForm",GRID:"#levelChangeGrid",PAGER:"#levelChangePager"};
LevelChange.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._searchKey();}var b=new StringBuffer();b.append(" <tr>"+"<th width='12%'>客户编号</th>"+"<th width='12%'>客户名称</th>"+"<th width='12%'>原级别名称</th>"+"<th width='5%'>原级别</th>"+"<th width='12%'>现级别名称</th>"+"<th width='5%'>现级别</th>"+"<th width='12%'>升级或降级</th>"+"<th width='12%'>获得时间</th>");
$("#diaryHeaderContainer").empty().append(b.toString());$("#levelChangeDiaryForm").hide();this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.dataAudit.leveChange";
glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("levelChange.button.detail")){$("button.levelChangeDetail").hide();}},clear:function(c){var a=this;
function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$("#diaryContainer").empty();FormUtils.clear(LevelChange._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(LevelChange._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();
this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(LevelChange._CONS_.EDIT_FORM_ID);$("#levelChangeDiaryForm").show();},_loadData:function(b){var a=this;
FormUtils.loadData(LevelChange._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=csId]").val(c.code);$("input[name=srcLevelName]").val(c.srcLevelName);
$("input[name=srcLevel]").val(c.srcLevel);$("input[name=levelName]").val(c.levelName);$("input[name=level]").val(c.level);$("select[name=dirType]").val(c.dirType);
$("input[name=createTime]").val(c.createTime);a._loadCsData(c.csId);});},_loadCsData:function(b){var a=this;FormUtils.loadData(LevelChange._CONS_.DIARY_URL+"?id="+b,function(e){var f=new StringBuffer();
if(e&&e.length>0){for(var c=0;c<e.length;c++){f.append("<tr>");f.append("<td width='10%'>"+e[c].code+"</td>");f.append("<td width='10%'>"+e[c].csName+"</td>");
f.append("<td width='10%'>"+e[c].srcLevelName+"</td>");f.append("<td width='10%'>"+e[c].srcLevel+"</td>");f.append("<td width='10%'>"+e[c].levelName+"</td>");
f.append("<td width='10%'>"+e[c].level+"</td>");if(e[c].dirType=="upgrade"){var d="升级";}if(e[c].dirType=="degrade"){var d="降级";}f.append("<td width='10%'>"+d+"</td>");
f.append("<td width='20%'>"+e[c].createTime+"</td>");f.append("</tr>");}}$("#diaryContainer").append(f.toString());});},_save:function(){var b=this;var c=$("#id").val();
var a=null;if(c!=null&&c!=""){a=LevelChange._CONS_.SAVE_EDIT_URL;}else{a=LevelChange._CONS_.SAVE_ADD_URL;}if($("#levelChangeForm").valid()){ButtonUtils.disableBtn("saveBtn");
FormUtils.submitByFormId(a,LevelChange._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(LevelChange._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;a._bindSearchEventHandler();$(document).on("click",".prevBtn",function(){a.clear(false);
$("#levelChangeDiaryForm").hide();});$(document).on("click",".saveBtn",function(){a._save();});$("#"+LevelChange._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+LevelChange._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+LevelChange._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("body").on("click",".levelChangeAdd",function(){a._add();});$("body").on("click",".levelChangeEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(LevelChange._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".levelChangeDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(LevelChange._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".levelChangeDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(LevelChange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要查看明细的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("#codeSearchIpt").on("change",function(){if(!$(this).val()){$("#searchCode").val("");}});},_bindSearchEventHandler:function(){var a=this;
$(".list_wrapper").on("click",".levelChangeSearch",function(){if(!$("#startTimeSearch").val()&&!$("#endTimeSearch").val()){var b={"Q__S__LK__entity.code_":$("input[name='Q__S__LK__entity.code_']").val(),"Q__S__EQ__changeL.dir_type_":$("select[name='Q__S__EQ__dir_type_']").val(),"Q__D__BW__changeL.create_time_":""};
}else{var b={"Q__S__LK__entity.code_":$("input[name='Q__S__LK__entity.code_']").val(),"Q__S__EQ__changeL.dir_type_":$("select[name='Q__S__EQ__dir_type_']").val(),"Q__D__BW__changeL.create_time_":$("#startTimeSearch").val()+","+$("#endTimeSearch").val()+" 23:59:59"};
}a.reloadJqgrid(b);});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){$(".levelChangeSearch").eq(0).trigger("click");}});},_searchKey:function(){var a=this;
$("#codeSearchIpt").bsSuggest({url:LevelChange._CONS_.KEYSEARCH_URL+"?code=",allowNoKeyword:false,multiWord:false,showBtn:false,separator:" ",autoSelect:false,getDataMethod:"url",idField:"code",keyField:"csName",effectiveFields:["code","csName"],searchFields:["code","csName"],effectiveFieldsAlias:{code:"客户编号",csName:"名字"},listStyle:{"padding-top":0,"max-height":"400px","max-width":"1333px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onSetSelectValue",function(c,b){$("#codeSearchIpt").val(b.key);
$("#searchCode").val(b.id);});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(LevelChange._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(f){var e={};if(f&&jQuery.type(f)=="string"){f=decodeURIComponent(f,true);var b=f.split("&");if(b.length){for(var c=0;c<b.length;
c++){var d=b[c].split("=");if(d.length==2&&d[1]){e[d[0]]=d[1];}else{e[d[0]]=d[1];}}}}else{e=f;}var a=$(LevelChange._CONS_.GRID).jqGrid("getGridParam","postData");
$.extend(a,e);$(LevelChange._CONS_.GRID).jqGrid("setGridParam",{search:true}).trigger("reloadGrid",[{page:1}]);},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}$(LevelChange._CONS_.GRID).JTJqgrid({url:LevelChange._CONS_.LIST_DATA_URL,pager:LevelChange._CONS_.PAGER,postData:a,colNames:["客户 ID","客户编号","原级别名称","原级别","现级别名称","现级别","升/降","变更时间","操作"],colModel:[{name:"csId",index:"cs_id_",width:120,hidedlg:true,hidden:true},{name:"code",width:80},{name:"srcLevelName",index:"src_level_name_",width:120,formatter:function(b,d,e){var c="<img style='display: inline; height:25px;width:25px;' ";
c=c+" src='"+ctx+e.srcLevelImage+"' ";c+=" > "+e.srcLevelName;return c;}},{name:"srcLevel",index:"src_level_",width:80},{name:"levelName",index:"level_name_",width:120,formatter:function(b,d,e){var c="<img style='display: inline; height:25px;width:25px;' ";
c=c+" src='"+ctx+e.levelImage+"' ";c+=" > "+e.levelName;return c;}},{name:"level",index:"level_",width:100},{name:"dirType",width:80,formatter:function(b){switch(b){case"upgrade":return"<span>升级</span>";
break;case"degrade":return"<span style='color:red;'>降级</span>";break;}}},{name:"createTime",index:"create_time_",width:120},{name:"__manage",width:80,formatter:function(b,c,d){return"<button type='button' class='btn btn-sm btn-outline btn-primary levelChangeDetail' idVal='"+d.id+"'><i class='fa fa-list'>明细</i></button>";
}}]});}};