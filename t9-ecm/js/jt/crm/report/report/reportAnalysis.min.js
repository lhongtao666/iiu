$(function(){var a=new ReportAnalysis();a.init();});function ReportAnalysis(){this.hadInit=false;this.reportsMap={};}ReportAnalysis._CONS_={FIND_PERSONAL_REPORT_RES:ctx+"/crm/report/reportEntity/findPersonalReportRes.htm?sys=ecm",};
ReportAnalysis.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadNewReports();var a=DateUtils.format(new Date(),"yyyy-MM-dd");
$(".beginDate").val(a+" 00:00:00");$(".endDate").val(a+" 23:59:59");this._dealStyle();}},_dealStyle:function(){var a=$("body").height()-$(".panel-body").outerHeight()-10;
$("#report-container").css({"max-height":a});},_bindEventHander:function(){var a=this;$(window).on("resize",function(){a._dealStyle();});$(document).on("click",".obtain",function(){if($(this).find(".glyphicon-chevron-right").length>0){$(this).find(".glyphicon-chevron-right").removeClass("glyphicon-chevron-right").addClass("glyphicon glyphicon-chevron-down");
$(this).parent("li").find(".secondary").show();}else{$(this).find(".glyphicon-chevron-down").removeClass("glyphicon-chevron-down").addClass("glyphicon glyphicon-chevron-right");
$(this).parent("li").find(".secondary").hide();}});$(".time-select-span").on("click",function(){$(".time-select-span").removeClass("on");$(this).addClass("on");
var b=$(this).attr("value");if(b==1){var d=DateUtils.format(new Date(),"yyyy-MM-dd");$(".beginDate").val(d+" 00:00:00");$(".endDate").val(d+" 23:59:59");
a._sendIframeMsg();}else{if(b==2){var d=DateUtils.getBeforeDate(1,new Date()).substring(0,10);$(".beginDate").val(d+" 00:00:00");$(".endDate").val(d+" 23:59:59");
a._sendIframeMsg();}else{if(b==3){var e=DateUtils.format(DateUtils.getCurrentMonthFirst(),"yyyy-MM-dd");var c=DateUtils.format(DateUtils.getCurrentMonthLast(),"yyyy-MM-dd");
$(".beginDate").val(e+" 00:00:00");$(".endDate").val(c+" 23:59:59");a._sendIframeMsg();}else{if(b==4){var e=DateUtils.format(DateUtils.getCurrentMonthFirst(new Date(DateUtils.getBeforeMonth(1))),"yyyy-MM-dd");
var c=DateUtils.format(DateUtils.getCurrentMonthLast(new Date(DateUtils.getBeforeMonth(1))),"yyyy-MM-dd");$(".beginDate").val(e+" 00:00:00");$(".endDate").val(c+" 23:59:59");
a._sendIframeMsg();}else{if(b==5){layer.open({type:1,title:"选择时间",shadeClose:false,area:["500px","300px"],scrollbar:false,btn:["确定","取消"],content:$(".time-select-pane"),success:function(f,g){},yes:function(g,f){var i=$(".select-beginDate").val();
var h=$(".select-endDate").val();if(i==""||i==null||h==""||h==null){DialogUtils.error(msgCode.ERROR,"请选择时间");return;}$(".beginDate").val(i);$(".endDate").val(h);
layer.close(g);a._sendIframeMsg();}});}}}}}});$(document).on("click",".csCommun",function(){$("#csCommunication-container").show();$("#report-container").hide();
var e=$(this).attr("id");var b=a.reportsMap[e];var d=12;if(window.innerWidth<=1024){d=12;}if(b){var f=new StringBuffer();for(var c=0;c<b.length;c++){f.append("<div class='col-sm-"+d+" record"+c+"'>");
f.append("<iframe class='J_iframe' name='reportIframe' style='width: 100%; height: 780px;' frameborder='0'  src='"+a._getUrl(b[c])+"'>");f.append("</iframe>");
f.append("</div>");}$(".csCommRecord").empty().append(f.toString());}else{$("").empty();}$(".record1").hide();$(".record2").hide();});$(document).on("click",".record",function(){var b=$(this).attr("id");
if(b=="ctiRecord"){$(".record1").show();$(".record0").hide();$(".record2").hide();}else{if(b=="turnoverRecord"){$(".record2").show();$(".record1").hide();
$(".record0").hide();}else{$(".record0").show();$(".record1").hide();$(".record2").hide();}}});$(document).on("click",".report-menu-li",function(){if($(this).is(".csCommun")){$("#report-container").hide();
$("#csCommunication-container").show();$("#report-container").empty();return;}else{$("#report-container").show();$("#csCommunication-container").hide();
}var e=$(this).attr("id");var b=a.reportsMap[e];var d=6;if(window.innerWidth<=1024){d=12;}if(b){var f=new StringBuffer();for(var c=0;c<b.length;c++){f.append("<div class='col-sm-"+d+"'>");
f.append("<iframe class='J_iframe' name='reportIframe' style='width: 100%; height: 420px;' frameborder='0'  src='"+a._getUrl(b[c])+"'>");f.append("</iframe>");
f.append("</div>");}$("#report-container").empty().append(f.toString());}else{$("#report-container").empty();}});},_getUrl:function(a){var b=ctx+a.url;
if(b.indexOf("?")!=-1){b=b+"&beginDate="+$(".beginDate").val()+"&endDate="+$(".endDate").val();}else{b=b+"?beginDate="+$(".beginDate").val()+"&endDate="+$(".endDate").val();
}return b;},_loadNewReports:function(){var a=this;var b=ctx+"/gl/cate/cate/loadCateTreeData.htm?cateTypeKey=reportAnalysisNew&rootKey=reportAnalysisNew-root";
FormUtils.loadData(b,function(d){if(d&&d.length>0){var c=ReportAnalysis._CONS_.FIND_PERSONAL_REPORT_RES+"&isNew=y";FormUtils.loadData(c,function(h){var l=new StringBuffer();
if(h.length>0){a._addReportToCateTree(d,h);var k=JTOtherUtils.listToTree("id","parentId",d);var e=k[0];if(!e.children){return;}for(var g=0;g<e.children.length;
g++){l.append("<li>");l.append('<h2 class="obtain">'+e.children[g].name+'<i class="glyphicon glyphicon-chevron-down"></i></h2>');l.append('<div class="secondary">');
for(var f=0;f<e.children[g].children.length;f++){if(e.children[g].children[f].name=="客户沟通"){l.append('<h3 id="'+e.children[g].children[f].id+'" class="report-menu-li csCommun">'+e.children[g].children[f].name+"["+(e.children[g].children[f].reports?e.children[g].children[f].reports.length:0)+"]</h3>");
}else{l.append('<h3 id="'+e.children[g].children[f].id+'" class="report-menu-li">'+e.children[g].children[f].name+"["+(e.children[g].children[f].reports?e.children[g].children[f].reports.length:0)+"]</h3>");
}if(e.children[g].children[f].reports){a.reportsMap[e.children[g].children[f].id]=e.children[g].children[f].reports;}}l.append("</div>");l.append("</li>");
}}else{l.append("<li>无可查看报表</li>");}$("#report-menu").empty().append(l.toString());});}});},_addReportToCateTree:function(a,d){for(var c=0;c<a.length;c++){for(var b=0;
b<d.length;b++){if(a[c].id==d[b].cateId&&d[b].checked){if(a[c].reports){a[c].reports.push(d[b]);}else{a[c].reports=[d[b]];}}}}},_sendIframeMsg:function(){var b={messageType:"reloadIframe",beginDate:$(".beginDate").val(),endDate:$(".endDate").val()};
var c=$("#report-container").find("iframe");if(c.length>0){for(var a=0;a<c.length;a++){c[a].contentWindow.postMessage(JSON.stringify(b),"*");}}var c=$("#csCommunication-container").find("iframe");
if(c.length>0){for(var a=0;a<c.length;a++){c[a].contentWindow.postMessage(JSON.stringify(b),"*");}}},};