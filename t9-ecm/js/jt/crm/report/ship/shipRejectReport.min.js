$(function(){var a=new ShipRejectReport();a.init();});function ShipRejectReport(){this.hadInit=false;}ShipRejectReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listShipData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportShip.htm",GRID:"#shipRejectReportGrid",PAGER:"#shipRejectReportPager"};
ShipRejectReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();$("#timeTypeSearch").val("month");ReportDateUtil.initDate(".report-content");
$("#timeTypeSearch").change();a._initJqgrid();a._getPieData(a.toPostParam());if($(".ship").val()=="1"){$(".ship").attr("disabled",true);}else{$(".place").attr("disabled",true);
}}},_bindEventHander:function(){var a=this;$(".report-content").off("click","#searchBtn");$(".report-content").on("click","#searchBtn",function(){a.reloadJqgrid(a.toPostParam());
a._getPieData(a.toPostParam());return false;});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",isSale:true,fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$(".report-content").off("click",".exportExcel");$(".report-content").on("click",".exportExcel",function(){ButtonUtils.disableBtn("exportExcel");
FormUtils.submit(ShipRejectReport._CONS_.EXPORT_URL,a.toPostParam(),function(b){ButtonUtils.enableBtn("exportExcel");if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".ship").on("click",function(){var b=$("#infoSearchFrom").serialize();
b+="&Q__D__BW__ship_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=ship";$(".place").val("0");$(this).val("1");$(".place").attr("disabled",false);
$(".ship").attr("disabled",true);a.reloadJqgrid(b);});$(".place").on("click",function(){var b=$("#infoSearchFrom").serialize();b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
b+="&timeType=place";$(".ship").val("0");$(this).val("1");$(".place").attr("disabled",true);$(".ship").attr("disabled",false);a.reloadJqgrid(b);});$(document).on("click",".detail",function(){var f=$(this).attr("profitType");
var e=$(this).attr("value");var g={};if($("input[name=belongOgn]").val()){g.belongOgn=$("input[name=belongOgn]").val();}g.Q__S__EQ__sc_name_=e;g.Q__S__EQ__type_=f;
g.type="ship";if($(".ship").val()=="1"){g.timeType="ship";}else{g.timeType="place";}var d=ReportDateUtil.getStartDateTimeRangeStr();var b=ReportDateUtil.getEndDateTimeRangeStr();
var c="/crm/report/performanceForEmpReport/detail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(g))+"&timeStart="+d+"&timeEnd="+b;JTTabUtils.addOrRefreshTab(ctx+c,e+"-业绩明细");
});},_getPieData:function(a){var b=this;$.ajax({type:"GET",url:ShipRejectReport._CONS_.LIST_DATA_URL,data:a,contentType:"application/json",dataType:"json",success:function(c){b.createReport(c.rows);
},error:function(c){DialogUtils.error(msgCode.ERROR,c);}});},createReport:function(b){var h=this;var j=new Report();var d=0;var g=0;if(b!=null&&b!=""){$(".pieDataDiv").show();
for(var c=0;c<b.length;c++){g=g+b[c].shipCount;d=d+b[c].rejectCount;}for(var c=0;c<b.length;c++){var e="";if(b[c].shipCount!=0&&g!=0){e=(b[c].shipCount/g*100).toFixed(0)+"%";
}else{e=0+"%";}b[c].scCode=b[c].scName+"("+e+")";}j.data=b;j.setLegend(true,null,"scCode");j.initSeries([{type:"pie",colName:"shipCount",legendName:"数量"}],"scCode");
j._initChart("shipRejectReportChart","发货数量饼图");var a=new Report();for(var c=0;c<b.length;c++){var f="";if(b[c].rejectCount!=0&&d!=0){f=(b[c].rejectCount/d*100).toFixed(0)+"%";
}else{f=0+"%";}b[c].scName=b[c].scName+"("+f+")";}a.data=b;a.setLegend(true,null,"scName");a.initSeries([{type:"pie",colName:"rejectCount",legendName:"数量"}],"scName");
a._initChart("shipRejectReportBarChart","拒收数量饼图");}else{$(".pieDataDiv").hide();}},_initJqgrid:function(){var b={};var a=this;if($(".ship").val()=="1"){b.Q__D__BW__ship_time_=ReportDateUtil.getDateTimeRangeStr();
}else{b.Q__D__BW__place_time_=ReportDateUtil.getDateTimeRangeStr();}$(ShipRejectReport._CONS_.GRID).JTJqgrid({url:ShipRejectReport._CONS_.LIST_DATA_URL,postData:b,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["名称","发货","金额","发货/金额","拒收","金额","拒收/金额","拒收率","签收","金额","签收/金额","签收率",],colModel:[{name:"scName",index:"sc_name",width:70,sortable:false},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(c,d,e){return e.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",width:70,sortable:false,formatter:function(c,d,e){if(e.scName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+e.scName+"'><span style='color:red;'>"+e.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"rejectCount",index:"reject_count_",hidedlg:true,hidden:true,sortable:false},{name:"rejectAmountHide",index:"reject_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(c,d,e){return e.rejectAmount;
}},{name:"rejectAmount",index:"reject_amount_",width:70,sortable:false,formatter:function(c,d,e){if(e.scName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.rejectAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='reject' value='"+e.scName+"'><span style='color:red;'>"+e.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.rejectAmount).toFixed(2)+"</span></a>";
}}},{name:"reject",index:"reject_",width:42,formatter:function(c,d,e){if(e.rejectCount!=0&&e.shipCount==0){return 100+"%";}else{if(e.rejectCount!=0&&e.shipCount!=0){return(e.rejectCount/e.shipCount*100).toFixed(0)+"%";
}else{if(e.rejectCount==0){return 0+"%";}}}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(c,d,e){return e.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:70,sortable:false,formatter:function(c,d,e){if(e.scName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.signAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='complete' value='"+e.scName+"'><span style='color:red;'>"+e.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(e.signAmount).toFixed(2)+"</span></a>";
}}},{name:"sign",index:"sign_",width:42,formatter:function(c,d,e){if(e.signCount!=0&&e.shipCount==0){return 100+"%";}else{if(e.signCount!=0&&e.shipCount!=0){return(e.signCount/e.shipCount*100).toFixed(0)+"%";
}else{if(e.signCount==0){return 0+"%";}}}}},],gridComplete:function(){var j=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","shipCount",true,"sum");var f=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","shipAmountHide",true,"sum");
var n=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","rejectCount",true,"sum");var e=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","rejectAmountHide",true,"sum");
var k=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","signCount",true,"sum");var i=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","signAmountHide",true,"sum");
var d=$(ShipRejectReport._CONS_.GRID).jqGrid("getCol","performanceAmount",true,"sum");var g=$(ShipRejectReport._CONS_.GRID).jqGrid("getGridParam","records");
var m="";if(n!=0&&j==0){m=100+"%";}else{if(n!=0&&j!=0){m=(n/j*100).toFixed(0)+"%";}else{if(n==0){m=0+"%";}}}var c="";if(k!=0&&j==0){c=100+"%";}else{if(k!=0&&j!=0){c=(k/j*100).toFixed(0)+"%";
}else{if(k==0){c=0+"%";}}}$(ShipRejectReport._CONS_.GRID).footerData("set",{"scName":"总计：<span style='color:red;'>"+g+"</span>个","shipCount":j.toFixed(0),"shipAmount":f.toFixed(2),"rejectCount":n.toFixed(0),"rejectAmount":e.toFixed(2),"reject":m,"signCount":k.toFixed(0),"signAmount":i.toFixed(2),"sign":c,});
var h=$(ShipRejectReport._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");h.find("td").css({"font-weight":400});var l=$(window).height()-$(".panel-heading").outerHeight()-$(".ui-jqgrid-hdiv").outerHeight()-200;
$(ShipRejectReport._CONS_.GRID).jqGrid("setGridHeight",l);},});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ShipRejectReport._CONS_.GRID,a);},toPostParam:function(){var a=$("#infoSearchFrom").serialize();
if($(".ship").val()=="1"){a+="&Q__D__BW__ship_time_="+ReportDateUtil.getDateTimeRangeStr();}else{a+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
}a+="&reportType="+$("input[name=reportKey]").val();return a;}};