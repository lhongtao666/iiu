$(function(){var a=new SoStatisticsReport();a.init();});function SoStatisticsReport(){this.hadInit=false;this.isEdit=false;this.soTypeCatePos=null;this.type="pie";
this.soEntityExport=new SoEntityExport();}SoStatisticsReport._CONS_={INDEX_URL:ctx+"/crm/report/soStatisticsReport/getPieData.htm",SO_LIST_URL:ctx+"/ec/salesorder/soEntity/listData.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",GRID:"#soStatisticsReportGrid",PAGER:"#soStatisticsReportPager"};
SoStatisticsReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();a._buildEmployeeSelect();CateUtils.findCatePos({typeKey:"soEntity",pKey:"soType",fn:function(c){soTypeCatePos=c;
},});$("#timeTypeSearch").val("month");ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();$("#partyTypeSearch").change();$(".graphPieAmountBtn").attr("disabled",true);
a._getData(a.toPostParam($(this).closest("form").serialize()),"pie");a._initJqgrid(a.toPostParam($(this).closest("form").serialize()));}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString()).select2();
}}});},createPieReport:function(c){var a=new Report();for(var b=0;b<c.detailStatusVos.length;b++){c.detailStatusVos[b].statusName=c.detailStatusVos[b].statusName+"("+c.detailStatusVos[b].percent+")";
}a.data=c.detailStatusVos;a.setLegend(true,null,"statusName");a.initSeries([{type:"pie",colName:"statusAmount",legendName:"金额"}],"statusName");if(window.localStorage.getItem("ts_money_reduce")=="true"){a._initChart("soStatisticsReportChart","订单状态分布图(总订单金额:"+(c.totalAmount/10).toFixed(2)+"元)");
}else{a._initChart("soStatisticsReportChart","订单状态分布图(总订单金额:"+c.totalAmount+"元)");}},createPieCountReport:function(c){var a=new Report();for(var b=0;b<c.detailStatusVos.length;
b++){c.detailStatusVos[b].statusName=c.detailStatusVos[b].statusName+"("+c.detailStatusVos[b].percent+")";}a.data=c.detailStatusVos;a.setLegend(true,null,"statusName");
a.initSeries([{type:"pie",colName:"statusCount",legendName:"数量"}],"statusName");a._initChart("soStatisticsReportChart","订单状态分布图(总订单数:"+c.totalCount/10+"单)");
},createBarReport:function(c){var a=new Report();for(var b=0;b<c.detailStatusVos.length;b++){if(c.detailStatusVos[b].statusName=="包裹丢失"){c.detailStatusVos[b].statusName="丢失("+c.detailStatusVos[b].percent+")";
}else{if(c.detailStatusVos[b].statusName=="订单拒收"){c.detailStatusVos[b].statusName="拒收("+c.detailStatusVos[b].percent+")";}else{c.detailStatusVos[b].statusName=c.detailStatusVos[b].statusName+"("+c.detailStatusVos[b].percent+")";
}}if(window.localStorage.getItem("ts_money_reduce")=="true"){c.detailStatusVos[b].statusAmount=(c.detailStatusVos[b].statusAmount/10).toFixed(2);}}a.data=c.detailStatusVos;
a.setLegend(true,null,"statusName");a.setBarSeriesStyle(true,"right","{c}");a.setGridX(100);a.initSeries([{type:"bar",colName:"statusAmount",legendName:"金额"},{type:"bar",colName:"statusCount",legendName:"数量"}],"statusName",null,"transverse");
if(window.localStorage.getItem("ts_money_reduce")=="true"){a._initChart("soStatisticsReportChart","订单状态分布图(总订单金额:"+(c.totalAmount/10).toFixed(2)+"元)");
}else{a._initChart("soStatisticsReportChart","订单状态分布图(总订单金额:"+c.totalAmount+"元)");}},_bindEventHander:function(){var a=this;$("body").on("click","#soStatisticsReportSearchBtn",function(){a.reloadJqgrid(a.toPostParam($(this).closest("form").serialize()));
a._getData(a.toPostParam($(this).closest("form").serialize()),a.type);return false;});$("body").on("click",".exportExcel",function(){var c=a.toExportParam($(this).closest("form").serialize());
var b=$(SoStatisticsReport._CONS_.GRID).jqGrid("getGridParam","records");a.soEntityExport.init({params:c,toatolCount:b});});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
a.buildEmployeeOption(c,"","statistics,dept_manager");}};GroupUtils.selectGroupTreeBox(b);});$("body").on("click",".graphPieAmountBtn",function(){$(".graphName").text("金额饼图");
$(this).attr("disabled",true);$(".graphBarBtn").attr("disabled",false);$(".graphPieCountBtn").attr("disabled",false);a.type="amountPie";a._getData(a.toPostParam($(this).closest("form").serialize()),"pie");
});$("body").on("click",".graphPieCountBtn",function(){$(".graphName").text("数量饼图");$(this).attr("disabled",true);$(".graphBarBtn").attr("disabled",false);
$(".graphPieAmountBtn").attr("disabled",false);a.type="countPie";a._getData(a.toPostParam($(this).closest("form").serialize()),"pieCount");});$("body").on("click",".graphBarBtn",function(){$(".graphName").text("柱形图");
$(this).attr("disabled",true);$(".graphPieCountBtn").attr("disabled",false);$(".graphPieAmountBtn").attr("disabled",false);a.type="bar";a._getData(a.toPostParam($(this).closest("form").serialize()),"bar");
});$("body").on("click",".soTab",function(){var c=$(this).attr("csNameVal");var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(SoStatisticsReport._CONS_.DETAIL_PAGE_URL+"?soNo="+b,c+"的订单明细");
});$("body").on("click",".csTab",function(){var c=$(this).text();var b=$(this).attr("value");if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(SoStatisticsReport._CONS_.DETAIL_CS_PAGE_URL+"?csId="+b,"客户["+c+"]明细");
});},_getData:function(a,c){var b=this;$.ajax({type:"GET",url:SoStatisticsReport._CONS_.INDEX_URL,data:a,contentType:"application/json",dataType:"json",success:function(d){if(c=="pie"){b.createPieReport(d);
}else{if(c=="bar"){b.createBarReport(d);}else{if(c=="pieCount"){b.createPieCountReport(d);}}}},error:function(d){DialogUtils.error(msgCode.ERROR,d);}});
},buildEmployeeOption:function(b,c,d){var a=d?d:"dept_manager";$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm?groupId="+b+"&type="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f&&f.length>0){var g=new StringBuffer();
g.append("<option value=''>请选择</option>");for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}if(c){$("#"+c).empty().append(g.toString());
}else{$("#belongEmployeeSearch").empty().append(g.toString());}}}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(SoStatisticsReport._CONS_.GRID,a);
},_initJqgrid:function(a){$(SoStatisticsReport._CONS_.GRID).JTJqgrid({url:SoStatisticsReport._CONS_.SO_LIST_URL,postData:a,pager:SoStatisticsReport._CONS_.PAGER,multiselect:false,footerrow:true,hidegrid:false,colNames:["订单编号","客户","订单类型","订单状态","货款方式","产品总数量","产品金额","总金额","渠道","下单人","下单时间","发货时间"],colModel:[{name:"soNo",width:90,index:"entity.so_no_",formatter:function(b,c,d){if(d.soNo!=null&&d.soNo!=""){return"<a href='#'  class='soTab' csNameVal ='"+d.csName+"' value='"+d.soNo+"' >"+d.soNo+"</a>";
}return d.csName;}},{name:"csName",width:90,index:"entity.cs_name_",formatter:function(b,c,d){if(d.csName!=null&&d.csName!=""){return"<a href='#'  class='csTab' value='"+d.csId+"' >"+d.csName+"</a>";
}return d.csName;}},{name:"soType",width:90,index:"entity.so_type_",formatter:function(b,e,g){for(var d=0;d<soTypeCatePos.length;d++){var f=soTypeCatePos[d].key;
var c=soTypeCatePos[d].name;if(g.soType&&g.soType==f){return c;}}}},{name:"status",width:90,index:"entity.status_",formatter:function(b,d,e){var c=e.status;
if(e.status=="awaiting_pay"){c="<span>等待支付</span>";}else{if(e.status=="awaiting_post"){c="<span>待提交</span>";}else{if(e.status=="awaiting_comfirm"){c="<span>待审核</span>";
}else{if(e.status=="comfirm"){c="<span>待发货</span>";}else{if(e.status=="shipping"){c="<span>已发货</span>";}else{if(e.status=="complete"){c="<span>已签收</span>";
}else{if(e.status=="close"){c="<span>订单关闭</span>";}else{if(e.status=="close_reject"){c="<span>拒收</span>";}else{if(e.status=="close_lost"){c="<span>包裹丢失</span>";
}}}}}}}}}return c;}},{name:"cashType",width:90,index:"entity.cash_type_",formatter:function(b,d,e){var c=e.cashType;if(e.cashType=="pay"){c="<span>款到发货</span>";
}else{if(e.cashType=="pay_sub"){c="<span>支付订金</span>";}else{if(e.cashType=="cod"){c="<span>货到付款</span>";}else{if(e.cashType=="free"){c="<span>免费已付</span>";
}else{if(e.cashType=="green"){c="<span>绿色通道</span>";}}}}}return c;}},{name:"prodQty",width:90,index:"entity.prod_qty_"},{name:"prodAmount",width:90,index:"entity.prod_amount_",formatter:function(b,c,d){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat(d.prodAmount/10).toFixed(2);
}else{return d.prodAmount;}}},{name:"totalAmount",width:90,index:"entity.total_amount_",formatter:function(b,c,d){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat(d.totalAmount/10).toFixed(2);
}else{return d.totalAmount;}}},{name:"channelName",index:"entity.channel_name_",width:80},{name:"placerName",width:90,index:"entity.placer_id_"},{name:"createTime",width:120,formatter:function(b){return DateUtils.miniTime(b);
}},{name:"shipTime",index:"entity.ship_time_",width:120,formatter:function(b){return DateUtils.miniTime(b);}},],});},toExportParam:function(d){var c=ReportDateUtil.getDateTimeRangeStr().split(",");
var a="";for(var b=0;b<c.length;b++){a+="&Q__D__BW__entity.create_time_="+c[b];}d=d+"&currentUserId="+currentUserId+"&positionType=statistics,dept_manager&Q__S__NEQ__entity.so_type_=point";
d=d+"&selectType=statistics"+a;return d;},toPostParam:function(e){e=e+"&currentUserId="+currentUserId+"&positionType=statistics,dept_manager&Q__S__NEQ__entity.so_type_=point&Q__D__BW__entity.create_time_="+ReportDateUtil.getDateTimeRangeStr();
e=e+"&selectType=statistics";var d={};if(e&&jQuery.type(e)=="string"){e=decodeURIComponent(e,true);var a=e.split("&");if(a.length){for(var b=0;b<a.length;
b++){var c=a[b].split("=");if(c.length==2){d[c[0]]=c[1];}else{d[c[0]]="";}}}}else{d=e;}return d;}};