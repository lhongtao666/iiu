$(function(){var a=new ReportEntity();a.init();});function ReportEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.positionOptionStr=null;
}ReportEntity._CONS_={EDIT_URL:ctx+"/crm/report/reportEntity/edit.htm",DETAIL_URL:ctx+"/crm/report/reportEntity/detail.htm",DELETE_URL:ctx+"/crm/report/reportEntity/delete.htm",SAVE_ADD_URL:ctx+"/crm/report/reportEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/report/reportEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/report/reportEntity/listData.htm",EDIT_FORM_ID:"reportEntityForm",GRID:"#reportEntityGrid",PAGER:"#reportEntityPager",CATE_TREE_URL:ctx+"/gl/cate/cate/loadCateTreeData.htm",EMPTY_AUTH_TIP:"<div style='color:red;font-weight:bold;'>没有授权信息！</div>",LIST_ROLE_DATA_URL:ctx+"/crm/ou/role/listRoleData.htm",};
ReportEntity.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=this;PositionUtils.loadPositionOptions({fn:function(c){var e=new StringBuffer();
for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].id+"'>"+c[d].name+"</option>");}a.positionOptionStr=e.toString();}});FormUtils.loadData(ReportEntity._CONS_.LIST_ROLE_DATA_URL+"?id="+id,function(f){if(f.success){var c=JSON.parse(f.msg);
var e=new StringBuffer();for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].name+"</option>");}a.roleOptionStr=e.toString();}else{DialogUtils.error("错误",f.msg);
}});this._bindFormValidation();this._bindEventHander();this._initJqgrid(b);this._hideNotGrantBtn();}},_hideNotGrantBtn:function(){if(reportEntityIsNew=="n"){if(!ResUtils.canShow("reportEntity.button.detail")){$(".reportEntityDetail").hide();
}if(!ResUtils.canShow("reportEntity.button.add")){$(".reportEntityAdd").hide();}if(!ResUtils.canShow("reportEntity.button.edit")){$(".reportEntityEdit").hide();
}if(!ResUtils.canShow("reportEntity.button.delete")){$(".reportEntityDel").hide();}}else{if(!ResUtils.canShow("reportEntityNew.button.detail")){$(".reportEntityDetail").hide();
}if(!ResUtils.canShow("reportEntityNew.button.add")){$(".reportEntityAdd").hide();}if(!ResUtils.canShow("reportEntityNew.button.edit")){$(".reportEntityEdit").hide();
}if(!ResUtils.canShow("reportEntityNew.button.delete")){$(".reportEntityDel").hide();}}},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(ReportEntity._CONS_.EDIT_FORM_ID);FormUtils.enableForm(ReportEntity._CONS_.EDIT_FORM_ID);
if(c){a.reloadJqgrid();}$("[name=name]").attr("readonly",false);$("[name=key]").attr("readonly",false);$("[name=name]").attr("readonly",false);$("[name=url]").attr("readonly",false);
$("[name=cateId]").attr("readonly",false);$(".selectReportKey").attr("disabled",false);}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_add:function(){this._showFormWrapper();$(".authTable").empty().append(ReportEntity._CONS_.EMPTY_AUTH_TIP);},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(ReportEntity._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(ReportEntity._CONS_.EDIT_URL+"?id="+b,function(d){$("input[name=id]").val(d.id);$("input[name=cateId]").val(d.cateId);
$("input[name=cateName]").val(d.cateName);$("input[name=name]").val(d.name);$("input[name=key]").val(d.key);var e=document.getElementById("type").options;
for(var c=0;c<e.length;c++){if(e[c].value==d.type){e[c].selected=true;break;}}$("input[name=url]").val(d.url);$("input[name=sort]").val(d.sort);$("input[name=createBy]").val(d.createBy);
$("input[name=createTime]").val(d.createTime);$("input[name=updateBy]").val(d.updateBy);$("input[name=updateTime]").val(d.updateTime);$("input[name='isNew']").val(d.isNew);
a.addOldAuthTr2Table(d.reportAuthPos);});},_save:function(){var c=this;var e=$("#id").val();var a=null;if(e!=null&&e!=""){a=ReportEntity._CONS_.SAVE_EDIT_URL;
}else{a=ReportEntity._CONS_.SAVE_ADD_URL;$("input[name='isNew']").val(reportEntityIsNew);}if($("#reportEntityForm").valid()){var b=false;$("select[name=authPartyId]").each(function(){if($(this).val()==""||$(this).val()==null){$(this).next().addClass("validate_input_error");
DialogUtils.error("提示","请选择授权对象");b=true;return;}});if(b==true){return;}ButtonUtils.disableBtn("saveBtn");var d=$("#reportEntityForm").serialize()+"&"+c._getAuthJSON();
FormUtils.submit(a,d,function(f){ButtonUtils.enableBtn("saveBtn");if(f.success){if(f.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(f.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(ReportEntity._CONS_.DELETE_URL,b,function(c){if(c.success){if(c.msgCode==actionCode.DELETE){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$(ReportEntity._CONS_.EDIT_FORM_ID).on("change",".form_wrapper input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(ReportEntity._CONS_.EDIT_FORM_ID).on("change",".form_wrapper select",function(){if(a.isEdit){a.isFormDataChange=true;}});$(ReportEntity._CONS_.EDIT_FORM_ID).on("change",".form_wrapper textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".reportEntitySearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$(".list_wrapper").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$(".list_wrapper").on("click",".reportEntityAdd",function(){a._add();});$("body").on("click",".reportEntityEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ReportEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".reportEntityDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(ReportEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".reportEntityDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ReportEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$(".form_wrapper").on("click",".selectReportKey",function(){a.initReportTree();});$(".form_wrapper").on("click",".addAuth",function(){a.addAuthTr2Table();
});$(".form_wrapper").on("click",".removeAuth",function(){$(this).closest("tr").remove();if($(".authTable tr").length==0){$(".authTable").append(ReportEntity._CONS_.EMPTY_AUTH_TIP);
}});$(".form_wrapper").on("change","select[name=authType]",function(){var b=$(this).closest("tr").find("select[name=authPartyId]").first();var c=$(this).closest("tr").find(".selectAutoParty").first();
b.empty();if($(this).val()=="position"){b.attr("data-placeholder","请下拉选择授权对象");b.append(a.positionOptionStr);b.chosen("destroy").chosen({enable_split_word_search:false,single_backstroke_delete:false});
c.hide();}else{if($(this).val()=="role"){b.attr("data-placeholder","请下拉选择授权对象");b.append(a.roleOptionStr);b.chosen("destroy").chosen({enable_split_word_search:false,single_backstroke_delete:false});
c.hide();}else{b.attr("data-placeholder","请在后面按钮选择授权对象");c.show();b.chosen("destroy").chosen({max_selected_options:1,enable_split_word_search:false,single_backstroke_delete:false});
}}});$(".form_wrapper").on("change","select[name=authPartyId]",function(){$(this).next().removeClass("validate_input_error");if(($(this).val()==""||$(this).val()==null)&&$("select[name=authType]").val()!="position"){$(this).empty();
$(this).trigger("chosen:updated");}});$(".form_wrapper").on("click",".selectAutoParty",function(){var b=$(this).closest("tr").find("select[name=authType]").first().val();
var c=$(this).closest("td").find("select[name=authPartyId]").first();if(b=="group"){var f={isMultiple:1,selectedGroupId:$('select[name="authPartyId"]').val(),nolimit:true,fn:function(j){if(j.length>0){var g=""+c.val();
c.children("option").each(function(){if(g.indexOf($(this).val()+",")==-1&&g.indexOf(","+$(this).val()+",")==-1&&g.indexOf(","+$(this).val())==-1&&$(this).val()!=g){(this).remove();
}});var k=new StringBuffer();for(var h=0;h<j.length;h++){if(g.indexOf(j[h].id+",")==-1&&g.indexOf(","+j[h].id+",")==-1&&g.indexOf(","+j[h].id)==-1&&j[h].id!=g){k.append("<option value='"+j[h].id+"' selected>"+j[h].name+"</option>");
}}c.append(k.toString());c.trigger("chosen:updated");c.next().removeClass("validate_input_error");}}};GroupUtils.selectGroup(f);}else{if(b=="employee"){var d=0;
if(ResUtils.canShow("employeeSelector.button.report")){d:1;}var f={isShowAllGroup:d,grantType:"/report/",isMultiple:1,callBack:function(j){if(j!=null||j.length<1){var g=""+c.val();
c.children("option").each(function(){if(g.indexOf($(this).val()+",")==-1&&g.indexOf(","+$(this).val()+",")==-1&&g.indexOf(","+$(this).val())==-1&&$(this).val()!=g){(this).remove();
}});var k=new StringBuffer();for(var h=0;h<j.length;h++){if(g.indexOf(j[h].id+",")==-1&&g.indexOf(","+j[h].id+",")==-1&&g.indexOf(","+j[h].id)==-1&&j[h].id!=g){k.append("<option value='"+j[h].id+"' selected>"+j[h].name+"</option>");
}}c.append(k.toString());c.trigger("chosen:updated");c.next().removeClass("validate_input_error");}}};var e=new EmployeesSelect();e.init(f);}}});},_bindFormValidation:function(){var a={rules:{"name":{required:true,},"cateName":{required:true,},},messages:{}};
FormUtils.bindFormValidation("reportEntityForm",a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ReportEntity._CONS_.GRID,a);},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}$(ReportEntity._CONS_.GRID).JTJqgrid({url:ReportEntity._CONS_.LIST_DATA_URL+"?Q__S__EQ__is_new_="+reportEntityIsNew,pager:ReportEntity._CONS_.PAGER,postData:a,colNames:["分类 ID","所属分类","名称","业务键","报表类型","排序号","创建者","创建时间","更新者","更新时间"],colModel:[{name:"cateId",width:120,hidedlg:true,hidden:true},{name:"cateName",width:120},{name:"name",index:"entity.name_",width:120},{name:"key",width:140,hidedlg:true,hidden:true},{name:"type",width:80,hidedlg:true,hidden:true,formatter:function(b,c,d){if(d.type=="data"){return"<span class='label label-primary'>数据表</span>";
}else{if(d.type=="chart"){return"<span class='label label-info'>数据图</span>";}}return d.type;}},{name:"sort",index:"entity.sort_",width:70},{name:"createBy",width:120,hidedlg:true,hidden:true},{name:"createTime",index:"entity.create_time_",width:100,formatter:function(b){return DateUtils.miniTime(b);
}},{name:"updateBy",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"entity.update_time_",width:100,formatter:function(b){return DateUtils.miniTime(b);
}}],});},initReportTree:function(){var a=this;a.layerIndex=layer.open({type:1,title:"报表业务类型",maxmin:true,shadeClose:false,btn:["确定","关闭"],area:["350px","410px"],content:'<ul id="reportKeySelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(b,c){a._initReportKeyTree("reportKeySelTree");
},yes:function(d,b){var c=$.fn.zTree.getZTreeObj("reportKeySelTree");var e=c.getSelectedNodes();if(e.length<1){alert("请选择分类");return false;}if(e[0].parentId==null){alert("不能选择根节点");
return false;}$("input[name=cateName]").val(e[0].name);$("input[name=cateId]").val(e[0].id);layer.close(a.layerIndex);}});},_initReportKeyTree:function(c){var b={cateTypeKey:"reportAnalysis",rootKey:"reportAnalysis-root"};
if(reportEntityIsNew=="y"){b={cateTypeKey:"reportAnalysisNew",rootKey:"reportAnalysisNew-root"};}var a={async:{enable:true,url:ReportEntity._CONS_.CATE_TREE_URL,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:b},callback:{},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"},key:{name:"name"}},view:{selectedMulti:false}};
$.fn.zTree.init($("#"+c),a);},addAuthTr2Table:function(){var a=new StringBuffer();a.append("<tr class='authTr' >").append("<td ><select class='form-control' name='authType'  validateType='default'>").append("<option value='group'>按部门</option>").append("<option value='employee'>按用户</option>").append("<option value='position'>按岗位</option>").append("<option value='role'>按角色</option>").append("</select></td>").append("<td><div class='input-group'>").append("<select multiple data-placeholder='请在后面按钮选择授权对象' class='chosen-select form-control' name='authPartyId' validateType='default'></select>").append("<div class='input-group-btn'><button type='button' class='btn btn-sm btn-outline btn-primary  selectAutoParty'>选择授权对象</button></div>").append("</div></td>").append("<td>").append("<button type='button' class='addAuth btn btn-primary'><i class='fa fa-plus'></i></button>&nbsp").append("<button type='button' class='removeAuth btn btn-danger'><i class='fa fa-minus'></i></button>").append("</td>").append("</tr>");
if($(".authTable tr").length==0){$(".authTable").empty();}$(".authTable").append(a.toString());$(".authTable tr:last-child select[name=authPartyId]").chosen({max_selected_options:1,enable_split_word_search:false,single_backstroke_delete:false});
},addOldAuthTr2Table:function(a){var b=this;$(".authTable").empty();for(var h=0;h<a.length;h++){var g=new StringBuffer();g.append("<tr class='authTr' idVal='").append(a[h].id).append("' ceateTimeVal='").append(a[h].ceateTime).append("'>").append("<td ><select class='form-control' name='authType'  validateType='default'>").append("<option value='group' ").append(a[h].type=="group"?"selected":"").append(" >按部门</option>").append("<option value='employee' ").append(a[h].type=="employee"?"selected":"").append(" >按用户</option>").append("<option value='position' ").append(a[h].type=="position"?"selected":"").append(" >按岗位</option>").append("<option value='role' ").append(a[h].type=="role"?"selected":"").append(" >按角色</option>").append("</select></td>").append("<td><div class='input-group'>").append("<select multiple data-placeholder='请").append((a[h].type=="position"||a[h].type=="role")?"下拉":"在后面按钮").append("选择授权对象' class='chosen-select form-control' name='authPartyId' validateType='default'></select>").append("<div class='input-group-btn' ><button type='button' class='btn btn-sm btn-outline btn-primary  selectAutoParty'>选择授权对象</button></div>").append("</div></td>").append("<td>").append("<button type='button' class='addAuth btn btn-primary'><i class='fa fa-plus'></i></button>&nbsp").append("<button type='button' class='removeAuth btn btn-danger'><i class='fa fa-minus'></i></button>").append("</td>").append("</tr>");
$(".authTable").append(g.toString());var d=$(".authTable tr:last-child select[name=authPartyId]");if(a[h].type=="position"){d.append(b.positionOptionStr);
d.children("option").each(function(){if(a[h].partyId.indexOf($(this).val()+",")>-1||a[h].partyId.indexOf(","+$(this).val()+",")>-1||a[h].partyId.indexOf(","+$(this).val())>-1|$(this).val()==a[h].partyId){(this).selected=true;
}});d.chosen({enable_split_word_search:false,single_backstroke_delete:false});d.closest("tr").find(".selectAutoParty").first().hide();}else{if(a[h].type=="role"){d.append(b.roleOptionStr);
d.children("option").each(function(){if(a[h].partyId.indexOf($(this).val()+",")>-1||a[h].partyId.indexOf(","+$(this).val()+",")>-1||a[h].partyId.indexOf(","+$(this).val())>-1|$(this).val()==a[h].partyId){(this).selected=true;
}});d.chosen({enable_split_word_search:false,single_backstroke_delete:false});d.closest("tr").find(".selectAutoParty").first().hide();}else{var e=a[h].partyId.split(",");
var f=a[h].authPartyNames.split(",");var g=new StringBuffer();for(var c=0;c<e.length;c++){g.append("<option value='"+e[c]+"' selected>"+f[c]+"</option>");
}d.empty().append(g.toString());d.chosen({max_selected_options:1,enable_split_word_search:false,single_backstroke_delete:false});}}}},_getAuthJSON:function(){var b=new StringBuffer();
var a=0;$(".authTable").find(".authTr").each(function(){var e=$(this).attr("idVal");var c=$(this).find("select[name=authType]").first().val();var d=$(this).find("select[name=authPartyId]").first().val();
b.append("reportAuthPos[").append(a).append("].partyId=").append(d).append("&").append("reportAuthPos[").append(a).append("].type=").append(c).append("&");
if(e){b.append("reportAuthPos[").append(a).append("].id=").append(e).append("&").append("reportAuthPos[").append(a).append("].createTime=").append($(this).attr("createTimeVal")).append("&");
}a++;});return b.toString();}};