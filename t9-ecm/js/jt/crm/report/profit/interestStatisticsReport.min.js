$(function(){var a=new InterestStatisticsReport();a.init();});function InterestStatisticsReport(){this.hadInit=false;this.isEdit=false;this.sortColumn="";
this.sortorder="";}InterestStatisticsReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listInterestData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportInterest.htm",GRID:"#interestStatisticsReportGrid",PAGER:"#interestStatisticsReportPager"};
InterestStatisticsReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;ReportDateUtil1.initDate(".report-content1");$("#timeTypeSearch1").change();
a._bindEventHander();a._initJqgrid();a._getPieData(a.toPostParam());CateUtils.getOptions({typeKey:"system",pKey:"CsEntryType",container:"entrySearch"});
}},_bindEventHander:function(){var a=this;$(document).on("click","#interestSearchBtn",function(){a.reloadJqgrid(a.toPostParam());a._getPieData(a.toPostParam());
});$(document).on("click",".interestHistory",function(){var d=encodeURI(encodeURI($(this).attr("value")));var c=$(".timeType").val();var b="";if($("input[name=searchType]:checked").val()=="interest"){b="interest";
}else{if($("input[name=searchType]:checked").val()=="productName"){b="productName";}}JTTabUtils.addOrRefreshTab(ctx+"/crm/report/performanceForEmpReport/history.htm?type="+b+"&timeType="+c+"&param="+d,"业绩历史详情");
});$("#groupName1").on("click",function(){var b={isMultiple:0,selectedGroupId:$("#belongOgn1").val(),container:"groupName1",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("#belongOgn1").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$(".exportExcel1").on("click",function(){ButtonUtils.disableBtn("exportExcel1");FormUtils.submit(InterestStatisticsReport._CONS_.EXPORT_URL,a.toPostParam()+"&sidx="+a.sortColumn+"&sord="+a.sortorder,function(b){ButtonUtils.enableBtn("exportExcel1");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".interestDetail",function(){var b=$(this).attr("profitType");var c=$(this).attr("value");ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(e){var d={};
ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(k){if(e.success&&b=="place"){d.Q__S__IN__type_="place";}else{if(k.success&&b=="place"){d.Q__S__IN__type_="place,post";
}else{d.Q__S__EQ__type_=b;}}if($("input[name=searchType]:checked").val()=="interest"){d.interestsName=c;}else{if($("input[name=searchType]:checked").val()=="productName"){d.productName=c;
}}d.type="interests";if($(".opterate").val()=="1"){d.timeType="oper";}else{d.timeType="place";}if($("#channelSearch").val()){d.Q__S__EQ__channel_id_=$("#channelSearch").val();
}if($("#entrySearch").val()){d.Q__S__EQ__cs_entry_=$("#entrySearch").val();}var j=ReportDateUtil1.getStartDateTimeRangeStr();var g=ReportDateUtil1.getEndDateTimeRangeStr();
var h="/crm/report/performanceForEmpReport/detail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(d))+"&timeStart="+j+"&timeEnd="+g;var i="";var f="";
h+="&withOut="+f+"&channelId="+i;JTTabUtils.addOrRefreshTab(ctx+h,c+"业绩明细");});});});},_getPieData:function(a){var b=this;$.ajax({type:"GET",url:InterestStatisticsReport._CONS_.LIST_DATA_URL,data:a,contentType:"application/json",dataType:"json",success:function(c){b.createReport(c.rows);
},error:function(c){DialogUtils.error(msgCode.ERROR,c);}});},createReport:function(b){var g=$("#interestSearchForm").find("input[name=searchType]:checked").val();
var m=this;var n=new Report();var e=0;var d=0;var j=[];var l=[];if(b!=null&&b!=""){$(".insterestPieDataDiv").show();for(var a=0;a<b.length;a++){e=e+b[a].placeAmount;
d=d+b[a].newCsCount;}for(var a=0;a<b.length;a++){var k=0;var h="";if(b[a].newCsCount!=0){k=(b[a].newCsCount/d*100).toFixed(0);h=k+"%";}else{h=0+"%";continue;
}if(k>0){if(g=="interest"){b[a].aid=b[a].interest+"("+h+")";}if(g=="productName"){b[a].aid=b[a].productName+"("+h+")";}j.push(b[a]);}}n.data=j;n.setLegend(true,null,"aid");
n.initSeries([{type:"pie",colName:"newCsCount",legendName:"数量"}],"aid");n._initChart("interestStatisticsReportChart","客户数量饼图");var n=new Report();for(var a=0;
a<b.length;a++){var f=0;var c="";if(b[a].placeAmount!=0){f=(b[a].placeAmount/e*100).toFixed(0);c=f+"%";}else{c=0+"%";continue;}if(f>0){if(g=="interest"){b[a].auditAmount=b[a].interest+"("+c+")";
}if(g=="productName"){b[a].auditAmount=b[a].productName+"("+c+")";}l.push(b[a]);}}n.data=l;n.setLegend(true,null,"auditAmount");n.initSeries([{type:"pie",colName:"placeAmount",legendName:"金额(元)"}],"auditAmount");
n._initChart("interestStatisticsReportBarChart","下单金额饼图");}else{$(".insterestPieDataDiv").hide();}},_initJqgrid:function(){var d={};var a=this;d.positionType="statistics,dept_manager";
d.Q__D__BW__oper_time_=ReportDateUtil1.getDateTimeRangeStr();d.timeType="oper";d.searchType="interest";var b=false;var c=false;ConfigUtils.findByKey("profit.isAddNewOther",function(e){if(e.success){b=true;
$(".addNewOther").show();$(".notAddNewOther").hide();}ConfigUtils.findByKey("profit.isHideNewMember",function(f){if(f.success){c=true;$(".addNewOther").hide();
$(".notAddNewOther").hide();}$(InterestStatisticsReport._CONS_.GRID).JTJqgrid({url:InterestStatisticsReport._CONS_.LIST_DATA_URL,postData:d,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["意向","新进客户","新进会员","新进其它","下单","金额","下单/金额","成单率(按单)","审单","金额","审单/金额","发货","金额","发货/金额","签收","金额","签收/金额","签收率(按单)","历史"],colModel:[{name:"interest",index:"interest_",width:52,sortable:false},{name:"newCsCount",index:"new_cs_count_",width:52,sortable:false},{name:"newMemberCount",index:"new_member_count_",width:52,hidden:c},{name:"newOthersCount",index:"new_others_count_",width:52,hidden:c},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(g,h,i){return i.placeAmount;
}},{name:"placeAmount",index:"place_amount_",width:70,sortable:false,formatter:function(g,h,i){if(i.interest.indexOf("总计：")>-1){return"<span style='color:red;'>"+i.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='interestDetail' profitType='place' value='"+i.interest+"'><span style='color:red;'>"+i.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"doneRate",index:"doneRate",width:50,sortable:false},{name:"auditCount",index:"audit_count_",hidedlg:true,hidden:true,sortable:false},{name:"auditAmountHide",index:"audit_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(g,h,i){return i.auditAmount;
}},{name:"auditAmount",index:"audit_amount_",width:70,sortable:false,formatter:function(g,h,i){if(i.interest.indexOf("总计：")>-1){return"<span style='color:red;'>"+i.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.auditAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='interestDetail' profitType='confirm' value='"+i.interest+"'><span style='color:red;'>"+i.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.auditAmount).toFixed(2)+"</span></a>";
}}},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(g,h,i){return i.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",width:70,sortable:false,formatter:function(g,h,i){if(i.interest.indexOf("总计：")>-1){return"<span style='color:red;'>"+i.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='interestDetail' profitType='ship' value='"+i.interest+"'><span style='color:red;'>"+i.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(g,h,i){return i.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:70,sortable:false,formatter:function(g,h,i){if(i.interest.indexOf("总计：")>-1){return"<span style='color:red;'>"+i.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.signAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='interestDetail' profitType='complete' value='"+i.interest+"'><span style='color:red;'>"+i.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.signAmount).toFixed(2)+"</span></a>";
}}},{name:"signRate",index:"signRate",width:50,sortable:false},{name:"history",width:40,formatter:function(g,h,i){return"<a href='#' class='interestHistory' value='"+i.interest+"'>历史</a>";
}},],gridComplete:function(){var u=$(window).height()-220;$(".ui-jqgrid-bdiv").height(u);var l=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","newCsCount",true,"sum");
var i=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","newMemberCount",true,"sum");var p=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","newOthersCount",true,"sum");
var h=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","placeCount",true,"sum");var t=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","placeAmountHide",true,"sum");
var j=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","auditCount",true,"sum");var r=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","auditAmountHide",true,"sum");
var q=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","shipCount",true,"sum");var m=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","shipAmountHide",true,"sum");
var s=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","signCount",true,"sum");var o=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getCol","signAmountHide",true,"sum");
var n=$(InterestStatisticsReport._CONS_.GRID).jqGrid("getGridParam","records");var k="0.0%";var g="0.0%";ConfigUtils.findByKey("profit.signExceptAudit",function(v){if(v.success){if(j==0&&s!=0){k="100%";
}else{if(s==0){k="0.0%";}else{k=(s*100/j).toFixed(1)+"%";}}}else{if(q==0&&s!=0){k="100%";}else{if(s==0){k="0.0%";}else{k=(s*100/q).toFixed(1)+"%";}}}ConfigUtils.findByKey("profit.isAddNewOther",function(w){if(w){var x=l+i+p;
if(x==0&&h!=0){g="100%";}else{if(h==0){g="0.0%";}else{g=(h*100/x).toFixed(1)+"%";}}}else{if(l==0&&h!=0){g="100%";}else{if(h==0){g="0.0%";}else{g=(h*100/l).toFixed(1)+"%";
}}}$(InterestStatisticsReport._CONS_.GRID).footerData("set",{"interest":"总计：<span style='color:red;'>"+n+"</span>个","newCsCount":l,"newMemberCount":i,"newOthersCount":p,"placeCount":h.toFixed(0),"placeAmount":t.toFixed(2),"doneRate":g,"auditCount":j.toFixed(0),"auditAmount":r.toFixed(2),"shipCount":q.toFixed(0),"shipAmount":m.toFixed(2),"signCount":s.toFixed(0),"signAmount":o.toFixed(2),"signRate":k});
});});},onSortCol:function(h,i,g){a.sortColumn=h;a.sortorder=g;}});});});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(InterestStatisticsReport._CONS_.GRID,a);
},toPostParam:function(){var a=$("#interestSearchForm").serialize();if($(".timeType").val()=="oper"){a+="&Q__D__BW__oper_time_="+ReportDateUtil1.getDateTimeRangeStr();
a+="&timeType=oper";}else{a+="&Q__D__BW__place_time_="+ReportDateUtil1.getDateTimeRangeStr();a+="&timeType=place";}a+="&reportType="+$("input[name=reportKey]").val();
return a;}};