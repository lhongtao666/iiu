$(function(){var a=new ProfitTimeReport();a.init();});function ProfitTimeReport(){this.hadInit=false;this.isEdit=false;}ProfitTimeReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listEntryTimeData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportProfitTime.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",PIE_REPORT_URL:ctx+"/ec/rp/reportProfit/profitTimePieData.htm",GRID:"#profitTimeReportGrid",PAGER:"#profitTimeReportPager"};
ProfitTimeReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();
a._initJqgrid();a._getData(a.toPostParam());a._buildEmployeeSelect();a._channelSearch();CateUtils.getOptions({typeKey:"system",pKey:"CsInterestType",container:"interstSearch"});
if($(".opterate").val()=="1"){$(".opterate").attr("disabled",true);}else{$(".place").attr("disabled",true);}}},_buildEmployeeSelect:function(){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(b){if(b&&b.length>0){var c=new StringBuffer();
c.append("<option value=''>请选择</option>");for(var a=0;a<b.length;a++){c.append("<option value='"+b[a].id+"'>"+b[a].aid+":"+b[a].name+"</option>");}$("#belongEmployeeSearch").empty().append(c.toString()).select2();
}}});},_channelSearch:function(){ChannelUtils.getOptions({container:"channelQry",caption:"",type:"noChannelId"});},_getData:function(a){var b=this;$.ajax({type:"GET",url:ProfitTimeReport._CONS_.PIE_REPORT_URL,data:a,contentType:"application/json",dataType:"json",success:function(c){dataInfo=c;
b.createBarReport(c);},error:function(c){DialogUtils.error(msgCode.ERROR,c);}});},createBarReport:function(c){var a=new Report();for(var b=0;b<c.length;
b++){c[b].timeFrame=c[b].timeFrame+"-"+(c[b].timeFrame+1)+"点";}a.data=c;a.setLegend(true,null,"timeFrame");a.setBarSeriesStyle(true,"right","{c}");a.setGridX(100);
a.initSeries([{type:"bar",colName:"auditAmount",legendName:"审单金额(元)"},{type:"bar",colName:"timeFrame",legendName:"时段"}],"timeFrame",null,null);a._initChart("profitTimeReportChart","业绩时段分布图");
},createCsBarReport:function(c){var a=new Report();for(var b=0;b<c.length;b++){c[b].timeFrame=c[b].timeFrame+"-"+(c[b].timeFrame+1)+"点";}a.data=c;a.setLegend(true,null,"timeFrame");
a.setBarSeriesStyle(true,"right","{c}");a.setGridX(100);a.initSeries([{type:"bar",colName:"newCsCount",legendName:"新进客户(个)"},{type:"bar",colName:"timeFrame",legendName:"时段"}],"timeFrame",null,null);
a._initChart("profitTimeReportChart","新进客户时段分布图");},clearTimeFrame:function(b){for(var a=0;a<b.length;a++){b[a].timeFrame=a;}},_bindEventHander:function(){var a=this;
$(document).on("click","#withOutChannel",function(){if($(this).val()==1){$(this).val("0");$(this).removeAttr("checked");}else{$(this).val("1");$(this).attr("checked","checked");
}});$(document).on("click","#newCs",function(){$("#profitTimeReportChart").empty();$(this).addClass("choseActive");$("#profitPin").removeClass("choseActive");
a.clearTimeFrame(dataInfo);a.createCsBarReport(dataInfo);});$(document).on("click","#profitPin",function(){$("#profitTimeReportChart").empty();$(this).addClass("choseActive");
$("#newCs").removeClass("choseActive");a.clearTimeFrame(dataInfo);a.createBarReport(dataInfo);});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
FormUtils.loadData(ProfitTimeReport._CONS_.EMPLOYEE_LIST_URL+"?groupId="+c+"&type=statistics,dept_manager",function(e){var f=new StringBuffer();f.append('<option value="">请选择</option>');
for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].id+"'>"+e[d].aid+":"+e[d].name+"</option>");}$("#belongEmployee").empty().append(f.toString());
});}};GroupUtils.selectGroupTreeBox(b);});$("#searchBtn").on("click",function(){$("#profitPin").addClass("choseActive");$("#newCs").removeClass("choseActive");
a.reloadJqgrid(a.toPostParam());a._getData(a.toPostParam());});$(".opterate").on("click",function(){var b=$("#profixSearchForm").serialize();b+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();
b+="&timeType=oper";$(".place").val("0");$(this).val("1");$(".place").attr("disabled",false);$(".opterate").attr("disabled",true);a.reloadJqgrid(b);a._getData(b);
});$(".place").on("click",function(){var b=$("#profixSearchForm").serialize();b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=place";
$(".opterate").val("0");$(this).val("1");$(".place").attr("disabled",true);$(".opterate").attr("disabled",false);a.reloadJqgrid(b);a._getData(b);});$(".exportExcel").on("click",function(){ButtonUtils.disableBtn("exportExcel");
FormUtils.submit(ProfitTimeReport._CONS_.EXPORT_URL,a.toPostParam(),function(b){ButtonUtils.enableBtn("exportExcel");if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".detail",function(){var c=$(this).attr("profitType");
var b=$(this).attr("value");ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(e){var d={};ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(k){if(e.success&&c=="place"){d.Q__S__IN__type_="place";
}else{if(k.success&&c=="place"){d.Q__S__IN__type_="place,post";}else{d.Q__S__EQ__type_=c;}}d.timeFrame=b;d.type="timeFrame";if($(".opterate").val()=="1"){d.timeType="oper";
}else{d.timeType="place";}if($("#channelSearch").val()){d.Q__S__EQ__channel_id_=$("#channelSearch").val();}if($(".interstSearch").val()){d.interests=$(".interstSearch").val();
}if($("input[name=belongOgn]").val()){d.belongOgn=$("input[name=belongOgn]").val();}if($("#belongEmployee").val()){d.belongEmployee=$("#belongEmployee").val();
}var j=ReportDateUtil.getStartDateTimeRangeStr();var g=ReportDateUtil.getEndDateTimeRangeStr();var h="/crm/report/performanceForEmpReport/groupDetail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(d))+"&timeStart="+j+"&timeEnd="+g;
var l=$("#channelQry option:selected").length;if(l!=0){h=a._buildDetailChanelSearch(l,h);}else{var i="";var f="";h+="&withOut="+f+"&channelId="+i;}JTTabUtils.addOrRefreshTab(ctx+h,b+"-"+(parseInt(b)+1)+"点业绩明细");
});});});$("#searchChannel").on("change",function(){if(!$(this).val()){$(".searchChannelVal").val("");}});},_initJqgrid:function(){var e={};var a=this;
e.Q__D__BW__place_time_=ReportDateUtil.getDateTimeRangeStr();e.timeType="place";var b=false;var d=false;var c=true;ConfigUtils.findByKey("profit.isAddNewOther",function(f){if(f.success){b=true;
$(".addNewOther").show();$(".notAddNewOther").hide();}ConfigUtils.findByKey("profit.isHideNewMember",function(g){if(g.success){d=true;$(".addNewOther").hide();
$(".notAddNewOther").hide();}ConfigUtils.findByKey("salesorder.isAddCreateProfit",function(i){if(i.success){c=false;}var h="下单/金额";if(!c){h="提交/金额";}$(ProfitTimeReport._CONS_.GRID).JTJqgrid({url:ProfitTimeReport._CONS_.LIST_DATA_URL,postData:e,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["时段","新进客户","新进会员","新进其它","下单","金额","下单/金额","提交","金额",h,"提交率","成单率","审单","金额","审单/金额","核单率","发货","金额","发货/金额","拒丢","金额","拒丢/金额","签收","金额","签收/金额","签收率","业绩金额"],colModel:[{name:"timeFrame",index:"time_frame_",width:52,sortable:false,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return l.timeFrame;
}else{return l.timeFrame+"-"+(l.timeFrame+1)+"点";}}},{name:"newCsCount",index:"new_cs_count_",width:52,sortable:false,},{name:"newMemberCount",index:"new_member_count_",width:52,hidden:d},{name:"newOthersCount",index:"new_others_count_",width:52,hidden:d},{name:"createCount",index:"create_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"createAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.createAmount;
}},{name:"createAmount",index:"create_amount_",width:70,hidden:c,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='create' value='"+l.timeFrame+"'><span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span></a>";
}}},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.placeAmount;
}},{name:"placeAmount",index:"place_amount_",sortable:false,width:70,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='place' value='"+l.timeFrame+"'><span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"postRate",index:"post_rate_",width:42,hidden:c,formatter:function(j,k,o){var n=$("#countType").val();if(n=="money"){var l=o.placeAmount;if(o.placeAmount!=0&&o.createAmount==0){return 100+"%";
}else{if(o.createAmount!=0&&l!=0){return(l/o.createAmount*100).toFixed(0)+"%";}else{return 0+"%";}}}else{var m=o.placeCount;if(o.placeCount!=0&&o.createCount==0){return 100+"%";
}else{if(o.createCount!=0&&m!=0){return(m/o.createCount*100).toFixed(0)+"%";}else{return 0+"%";}}}}},{name:"doneRate",index:"done_rate_",width:42,sortable:true},{name:"auditCount",index:"audit_count_",hidedlg:true,hidden:true,sortable:false},{name:"auditAmountHide",index:"audit_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.auditAmount;
}},{name:"auditAmount",index:"audit_amount_",width:70,sortable:false,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='confirm' value='"+l.timeFrame+"'><span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span></a>";
}}},{name:"check",index:"check_",width:42,sortable:false,formatter:function(j,k,m){var l=$("#countType").val();if(l=="money"){if(m.auditAmount!=0&&m.placeAmount==0){return 100+"%";
}else{if(m.auditAmount!=0&&m.placeAmount!=0){return(m.auditAmount/m.placeAmount*100).toFixed(0)+"%";}else{if(m.auditAmount==0){return 0+"%";}}}}else{if(m.auditCount!=0&&m.placeCount==0){return 100+"%";
}else{if(m.auditCount!=0&&m.placeCount!=0){return(m.auditCount/m.placeCount*100).toFixed(0)+"%";}else{if(m.auditCount==0){return 0+"%";}}}}}},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",sortable:false,width:70,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+l.timeFrame+"'><span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"rejectCount",index:"reject_count_",hidedlg:true,hidden:true,sortable:false},{name:"rejectAmountHide",index:"reject_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.rejectAmount;
}},{name:"rejectAmount",index:"reject_amount_",sortable:false,width:70,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='reject' value='"+l.timeFrame+"'><span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span></a>";
}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.signAmount;
}},{name:"signAmount",index:"sign_amount_",sortable:false,width:70,formatter:function(j,k,l){if((l.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+l.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.signAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='complete' value='"+l.timeFrame+"'><span style='color:red;'>"+l.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.signAmount).toFixed(2)+"</span></a>";
}}},{name:"sign",index:"sign_",width:42,sortable:false,formatter:function(j,k,m){var l=$("#countType").val();if(l=="money"){if(m.signAmount!=0&&m.shipAmount==0){return 100+"%";
}else{if(m.signAmount!=0&&m.shipAmount!=0){return(m.signAmount/m.shipAmount*100).toFixed(0)+"%";}else{if(m.signAmount==0){return 0+"%";}}}}else{if(m.signCount!=0&&m.shipCount==0){return 100+"%";
}else{if(m.signCount!=0&&m.shipCount!=0){return(m.signCount/m.shipCount*100).toFixed(0)+"%";}else{if(m.signCount==0){return 0+"%";}}}}}},{name:"performanceAmount",sortable:false,width:70,index:"performance_amount_",formatter:function(j,k,l){return parseFloat(l.performanceAmount).toFixed(2);
}},],gridComplete:function(){var q=$("#countType").val();var D=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","newCsCount",true,"sum");var p=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","newMemberCount",true,"sum");
var v=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","newOthersCount",true,"sum");var u=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","createCount",true,"sum");
var k=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","createAmountHide",true,"sum");var n=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","placeCount",true,"sum");
var l=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","placeAmountHide",true,"sum");var F=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","auditCount",true,"sum");
var r=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","auditAmountHide",true,"sum");var x=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","shipCount",true,"sum");
var B=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","shipAmountHide",true,"sum");var j=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","rejectCount",true,"sum");
var z=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","rejectAmountHide",true,"sum");var t=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","signCount",true,"sum");
var A=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","signAmountHide",true,"sum");var o=$(ProfitTimeReport._CONS_.GRID).jqGrid("getCol","performanceAmount",true,"sum");
var w=$(ProfitTimeReport._CONS_.GRID).jqGrid("getGridParam","records");var s="";var y=D+p;if(b){y+=v;}if(n!=0&&y==0){s=100+"%";}else{if(n!=0&&y!=0){s=(n/y*100).toFixed(0)+"%";
}else{if(n==0){s=0+"%";}}}var m=0+"%";if(q=="money"){if(l!=0&&k==0){m=100+"%";}else{if(l!=0&&k!=0){m=(l/k*100).toFixed(0)+"%";}else{if(l==0){m=0+"%";}}}}else{if(n!=0&&u==0){m=100+"%";
}else{if(n!=0&&u!=0){m=(n/u*100).toFixed(0)+"%";}else{if(n==0){m=0+"%";}}}}var C="";if(q=="money"){if(r!=0&&l==0){C=100+"%";}else{if(r!=0&&l!=0){C=(r/l*100).toFixed(0)+"%";
}else{if(r==0){C=0+"%";}}}}else{if(F!=0&&n==0){C=100+"%";}else{if(F!=0&&n!=0){C=(F/n*100).toFixed(0)+"%";}else{if(F==0){C=0+"%";}}}}var E="";if(q=="money"){if(A!=0&&B==0){E=100+"%";
}else{if(A!=0&&B!=0){E=(A/B*100).toFixed(0)+"%";}else{if(A==0){E=0+"%";}}}}else{if(t!=0&&x==0){E=100+"%";}else{if(t!=0&&x!=0){E=(t/x*100).toFixed(0)+"%";
}else{if(t==0){E=0+"%";}}}}$(ProfitTimeReport._CONS_.GRID).footerData("set",{"timeFrame":"总计：","newCsCount":D,"newMemberCount":p,"newOthersCount":v,"placeCount":n.toFixed(0),"createCount":u.toFixed(0),"createAmount":k.toFixed(2),"postRate":m,"placeAmount":l.toFixed(2),"doneRate":s,"auditCount":F.toFixed(),"auditAmount":r.toFixed(2),"check":C,"shipCount":x.toFixed(0),"shipAmount":B.toFixed(2),"rejectCount":j.toFixed(0),"rejectAmount":z.toFixed(2),"signCount":t.toFixed(0),"signAmount":A.toFixed(2),"sign":E,"performanceAmount":o.toFixed(2)});
},onSortCol:function(k,l,j){a.sortColumn=k;a.sortorder=j;a.reloadJqgrid(a.toPostParam()+"&sortColumn="+a.sortColumn+"&sortorder="+a.sortorder);}});});});
});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ProfitTimeReport._CONS_.GRID,a);},toPostParam:function(){var a=this;var c=$("#profixSearchForm").serialize();
if($(".opterate").val()=="1"){c+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();c+="&timeType=oper";}else{c+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
c+="&timeType=place";}c+="&reportType="+$("input[name=reportKey]").val();c.timeType="place";var b=$("#channelQry option:selected").length;if(channelQry!=0){c=a._buildChanelSearch(c,b);
}if($("#withOutChannel").is(":checked")){c+="&withOut="+"withOut";}return c;},_buildChanelSearch:function(d,c){var b=this;var e=new StringBuffer();var a=null;
$("#channelQry option:selected").each(function(f){if($(this).val()==""){a="withOut";}e.append($(this).val());if(f==c-1){return false;}else{e.append(",");
}});d=d+"&channelId="+e.toString();if(a){d+="&withOut="+"withOut";}return d;},_buildDetailChanelSearch:function(d,c){var b=this;var e=new StringBuffer();
var a="";$("#channelQry option:selected").each(function(f){if($(this).val()==""){a="withOut";}e.append($(this).val());if(f==d-1){return false;}else{e.append(",");
}});c+="&channelId="+e.toString()+"&withOut="+a;return c;}};