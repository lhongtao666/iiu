$(function(){var a=new ProfitForCityReport();a.init();});function ProfitForCityReport(){this.hadInit=false;this.isEdit=false;this.sortColumn="";this.sortorder="";
}ProfitForCityReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listCityData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportCity.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",EMPLOYEE_TAG_URL:ctx+"/crm/report/levelStatisticReport/employeeTag.htm",GRID:"#profitForCityReportGrid",PAGER:"#profitForCityReportPager"};
ProfitForCityReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();ReportDateUtil.initDate(".report-content");
$("#timeTypeSearch").change();$("#beginDate").val(timeStart);$("#endDate").val(timeEnd);a._initJqgrid();CateUtils.getOptions({typeKey:"system",pKey:"CsInterestType",container:"interstSearch"});
if($(".opterate").val()=="1"){$(".opterate").attr("disabled",true);}else{$(".place").attr("disabled",true);}}},_bindEventHander:function(){var a=this;$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$("#searchBtn").on("click",function(){a.reloadJqgrid(a.toPostParam());});$(".opterate").on("click",function(){var b=$("#profixSearchForm").serialize();
b+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=oper";b+="&Q__S__EQ__province_="+province;$(".place").val("0");$(this).val("1");
$(".place").attr("disabled",false);$(".opterate").attr("disabled",true);a.reloadJqgrid(b);});$(".place").on("click",function(){var b=$("#profixSearchForm").serialize();
b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=place";b+="&Q__S__EQ__province_="+province;$(".opterate").val("0");$(this).val("1");
$(".place").attr("disabled",true);$(".opterate").attr("disabled",false);a.reloadJqgrid(b);});$(document).on("click",".history",function(){var c=$(this).attr("value");
if($(".opterate").val()=="1"){var b="oper";}else{var b="place";}JTTabUtils.addOrRefreshTab(ctx+"/crm/report/performanceForEmpReport/history.htm?type=city&timeType="+b+"&param="+c,"业绩历史详情");
});$(".exportExcel").on("click",function(){FormUtils.submit(ProfitForCityReport._CONS_.EXPORT_URL,a.toPostParam()+"&sidx="+a.sortColumn+"&sord="+a.sortorder,function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".detail",function(){var b=$(this).attr("profitType");var d=$(this).attr("value");var c={};ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(e){ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(i){if(e.success&&b=="place"){c.Q__S__IN__type_="place";
}else{if(i.success&&b=="place"){c.Q__S__IN__type_="place,post";}else{c.Q__S__EQ__type_=b;}}c.Q__S__EQ__city_=d;c.type="city";if($(".opterate").val()=="1"){c.timeType="oper";
}else{c.timeType="place";}if($(".interstSearch").val()){c.interests=$(".interstSearch").val();}if($("input[name=belongOgn]").val()){c.belongOgn=$("input[name=belongOgn]").val();
}var h=ReportDateUtil.getStartDateTimeRangeStr();var f=ReportDateUtil.getEndDateTimeRangeStr();var g="/crm/report/performanceForEmpReport/groupDetail.htm?paramsDetail="+JSON.stringify(c)+"&timeStart="+h+"&timeEnd="+f;
JTTabUtils.addOrRefreshTab(ctx+g,d+"业绩明细");});});});},_initJqgrid:function(){var e={};var a=this;e.Q__S__EQ__province_=province;e.Q__D__BW__place_time_=ReportDateUtil.getDateTimeRangeStr();
e.timeType="place";var b=false;var d=false;var c=true;ConfigUtils.findByKey("profit.isAddNewOther",function(f){if(f.success){b=true;$(".addNewOther").show();
$(".notAddNewOther").hide();}ConfigUtils.findByKey("profit.isHideNewMember",function(g){if(g.success){d=true;$(".addNewOther").hide();$(".notAddNewOther").hide();
}ConfigUtils.findByKey("salesorder.isAddCreateProfit",function(i){if(i.success){c=false;}var h="下单/金额";if(!c){h="提交/金额";}$(ProfitForCityReport._CONS_.GRID).JTJqgrid({url:ProfitForCityReport._CONS_.LIST_DATA_URL,postData:e,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["地区","新进客户","删除客户","新进会员","新进其它","下单","金额","下单/金额","提交","金额",h,"提交率","成单率","审单","金额","审单/金额","比例","发货","金额","发货/金额","拒丢","金额","拒丢/金额","签收","金额","签收/金额","业绩金额","历史"],colModel:[{name:"city",width:62,index:"city_",sortable:false,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return l.city;
}else{return province+","+l.city;}}},{name:"newCsCount",index:"new_cs_count_",width:52},{name:"deleteCsCount",index:"delete_cs_count_",width:45,sortable:true},{name:"newMemberCount",index:"new_member_count_",width:52,hidden:d},{name:"newOthersCount",index:"new_others_count_",width:52,hidden:d},{name:"createCount",index:"create_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"createAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.createAmount;
}},{name:"createAmount",index:"create_amount_",width:70,hidden:c,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='create' value='"+l.city+"'><span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span></a>";
}}},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.placeAmount;
}},{name:"placeAmount",index:"place_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='place' value='"+l.city+"'><span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"postRate",index:"post_rate_",width:42,hidden:c,formatter:function(j,k,o){var n=$("#countType").val();if(n=="money"){var l=o.placeAmount;if(o.placeAmount!=0&&o.createAmount==0){return 100+"%";
}else{if(o.createAmount!=0&&l!=0){return(l/o.createAmount*100).toFixed(0)+"%";}else{return 0+"%";}}}else{var m=o.placeCount;if(o.placeCount!=0&&o.createCount==0){return 100+"%";
}else{if(o.createCount!=0&&m!=0){return(m/o.createCount*100).toFixed(0)+"%";}else{return 0+"%";}}}}},{name:"done",width:42,sortable:true,formatter:function(j,l,m){var k=m.newCsCount;
if(b){k+=m.newOthersCount+m.newMemberCount;}if(m.placeCount!=0&&k<=0){return 100+"%";}else{if(m.placeCount!=0&&k!=0){return(m.placeCount/k*100).toFixed(1)+"%";
}else{if(m.placeCount==0){return 0+"%";}}}}},{name:"auditCount",index:"audit_count_",hidedlg:true,hidden:true,sortable:false},{name:"auditAmountHide",index:"audit_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.auditAmount;
}},{name:"auditAmount",index:"audit_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='confirm' value='"+l.city+"'><span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span></a>";
}}},{name:"check",width:42,sortable:false,formatter:function(j,k,m){var l=$("#countType").val();if(l=="money"){if(m.auditAmount!=0&&m.placeAmount==0){return 100+"%";
}else{if(m.auditAmount!=0&&m.placeAmount!=0){return(m.auditAmount/m.placeAmount*100).toFixed(0)+"%";}else{if(m.auditAmount==0){return 0+"%";}}}}else{if(m.auditCount!=0&&m.placeCount==0){return 100+"%";
}else{if(m.auditCount!=0&&m.placeCount!=0){return(m.auditCount/m.placeCount*100).toFixed(0)+"%";}else{if(m.auditCount==0){return 0+"%";}}}}}},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+l.city+"'><span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"rejectCount",index:"reject_count_",hidedlg:true,hidden:true,sortable:false},{name:"rejectAmountHide",index:"reject_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.rejectAmount;
}},{name:"rejectAmount",index:"reject_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='reject' value='"+l.city+"'><span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span></a>";
}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:70,formatter:function(j,k,l){if(l.city&&l.city.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+l.city+"'><span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"performanceAmount",width:70,index:"performance_amount_",formatter:function(j,k,l){return parseFloat(l.performanceAmount).toFixed(2);}},{name:"history",width:40,formatter:function(j,k,l){return"<a href='#' class='history' value='"+l.city+"'>历史</a>";
}},],gridComplete:function(){if(a.footerData){var j=$(ProfitForCityReport._CONS_.GRID).jqGrid("getGridParam","records");a.footerData.city="总计：<span style='color:red;'>"+j+"</span>个";
$(ProfitForCityReport._CONS_.GRID).footerData("set",a.footerData);}},beforeProcessing:function(k){var j={city:"总计：",newCsCount:k.footData.newCsCount,deleteCsCount:k.footData.deleteCsCount,newMemberCount:k.footData.newMemberCount,newOthersCount:k.footData.newOthersCount,createCount:k.footData.createCount.toFixed(0),createAmount:k.footData.createAmount.toFixed(2),placeCount:k.footData.placeCount.toFixed(0),placeAmount:k.footData.placeAmount.toFixed(2),delayCount:k.footData.delayCount.toFixed(0),delayAmount:k.footData.delayAmount.toFixed(2),postRate:k.footData.postRate,doneRate:k.footData.doneRate,auditCount:k.footData.auditCount.toFixed(0),auditAmount:k.footData.auditAmount.toFixed(2),checkRate:k.footData.checkRate,shipCount:k.footData.shipCount.toFixed(0),shipAmount:k.footData.shipAmount.toFixed(2),rejectCount:k.footData.rejectCount.toFixed(0),rejectAmount:k.footData.rejectAmount.toFixed(2),signCount:k.footData.signCount.toFixed(0),signAmount:k.footData.signAmount.toFixed(2),signRate:k.footData.signRate,delaySignCount:(k.footData.signCount+k.footData.delayCount).toFixed(0),delaySignAmountHide:(k.footData.signAmount+k.footData.delayAmount).toFixed(2),delaySignAmount:k.footData.signAmount.toFixed(2)+k.footData.delayAmount.toFixed(2)};
a.footerData=j;},onSortCol:function(k,l,j){a.sortColumn=k;a.sortorder=j;}});});});});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ProfitForCityReport._CONS_.GRID,a);
},toPostParam:function(){var a=$("#profitSearchForm").serialize();a+="&positionType=statistics,dept_manager";a+="&Q__S__EQ__province_="+province;if($(".opterate").val()=="1"){a+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();
}else{a+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();}a+="&reportType="+$("input[name=reportKey]").val();return a;}};