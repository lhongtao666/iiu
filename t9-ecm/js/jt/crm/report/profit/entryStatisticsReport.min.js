$(function(){var a=new EntryStatisticsReport();a.init();});function EntryStatisticsReport(){this.hadInit=false;this.isEdit=false;}EntryStatisticsReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listEntryData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportEntry.htm",GRID:"#entryStatisticsReportGrid",PAGER:"#entryStatisticsReportPager"};
EntryStatisticsReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();
a._getPieData(a.toPostParam());a._bindEventHander();a._initJqgrid();FindChannelSelect.initSelect("channelSearch",null,null);if($(".opterate").val()=="1"){$(".opterate").attr("disabled",true);
}else{$(".place").attr("disabled",true);}}},_bindEventHander:function(){var a=this;$(window).resize(function(){var b=$(window).height()-220;$(".ui-jqgrid-bdiv").height(b);
});$("#entrySearchBtn").on("click",function(){a.reloadJqgrid(a.toPostParam());a._getPieData(a.toPostParam());});$(document).on("click",".history",function(){var b=$(this).attr("value");
if($(".opterate").val()=="1"){var c="oper";}else{var c="place";}JTTabUtils.addOrRefreshTab(ctx+"/crm/report/performanceForEmpReport/history.htm?type=entry&timeType="+c+"&param="+b,"业绩历史详情");
});$(document).on("click",".detail",function(){var c=$(this).attr("profitType");var b=$(this).attr("value");ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(e){var d={};
ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(k){if(e.success&&c=="place"){d.Q__S__IN__type_="place";}else{if(k.success&&c=="place"){d.Q__S__IN__type_="place,post";
}else{d.Q__S__EQ__type_=c;}}d.Q__S__EQ__cs_entry_=b;d.type="entry";if($(".opterate").val()=="1"){d.timeType="oper";}else{d.timeType="place";}if($("#channelSearch").val()){d.Q__S__EQ__channel_id_=$("#channelSearch").val();
}if($("input[name=belongOgn]").val()){d.belongOgn=$("input[name=belongOgn]").val();}var j=ReportDateUtil.getStartDateTimeRangeStr();var g=ReportDateUtil.getEndDateTimeRangeStr();
var h="/crm/report/performanceForEmpReport/groupDetail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(d))+"&timeStart="+j+"&timeEnd="+g;var i="";
var f="";h+="&withOut="+f+"&channelId="+i;JTTabUtils.addOrRefreshTab(ctx+h,b+"业绩明细");});});});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("#belongOgn").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("#belongOgn").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$(".exportExcel").on("click",function(){ButtonUtils.disableBtn("exportExcel");FormUtils.submit(EntryStatisticsReport._CONS_.EXPORT_URL,a.toPostParam(),function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(".opterate").on("click",function(){var b=$("#entrySearchForm").serialize();b+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=oper";
$(".place").val("0");$(this).val("1");$(".place").attr("disabled",false);$(".opterate").attr("disabled",true);a.reloadJqgrid(b);});$(".place").on("click",function(){var b=$("#entrySearchForm").serialize();
b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=place";$(".opterate").val("0");$(this).val("1");$(".place").attr("disabled",true);
$(".opterate").attr("disabled",false);a.reloadJqgrid(b);});},_getPieData:function(a){var b=this;$.ajax({type:"GET",url:EntryStatisticsReport._CONS_.LIST_DATA_URL,data:a,contentType:"application/json",dataType:"json",success:function(c){b.createReport(c.rows);
},error:function(c){DialogUtils.error(msgCode.ERROR,c);}});},createReport:function(b){var h=this;var j=new Report();var d=0;var g=0;if(b!=null&&b!=""){$(".pieDataDiv").show();
for(var c=0;c<b.length;c++){d=d+b[c].placeAmount;g=g+b[c].signAmount;}for(var c=0;c<b.length;c++){var e="";if(b[c].placeAmount!=0&&d!=0){e=(b[c].placeAmount/d*100).toFixed(0)+"%";
}else{e=0+"%";}b[c].newCsCount=b[c].entry+"("+e+")";}j.data=b;j.setLegend(true,null,"newCsCount");j.initSeries([{type:"pie",colName:"placeAmount",legendName:"金额(元)"}],"newCsCount");
j._initChart("entryStatisticsReportChart","下单金额饼图");var a=new Report();for(var c=0;c<b.length;c++){var f="";if(b[c].signAmount!=0&&g!=0){f=(b[c].signAmount/g*100).toFixed(0)+"%";
}else{f=0+"%";}b[c].newCsCount=b[c].entry+"("+f+")";}a.data=b;a.setLegend(true,null,"newCsCount");a.initSeries([{type:"pie",colName:"signAmount",legendName:"金额(元)"}],"newCsCount");
a._initChart("entryStatisticsReportBarChart","签收金额饼图");}else{$(".pieDataDiv").hide();}},_initJqgrid:function(){var c={};var a=this;c.Q__D__BW__oper_time_=ReportDateUtil.getDateTimeRangeStr();
var b=false;ConfigUtils.findByKey("profit.isHideNewMember",function(d){if(d.success){b=true;$(".addNewOther").hide();$(".notAddNewOther").hide();}$(EntryStatisticsReport._CONS_.GRID).JTJqgrid({url:EntryStatisticsReport._CONS_.LIST_DATA_URL,postData:c,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["进线方式","新进客户","新进会员","新进其它","下单","金额","下单/金额","成单率(按单)","审单","金额","审单/金额","发货","金额","发货/金额","拒丢","金额","拒丢/金额","签收","金额","签收/金额","签收率(按单)","历史"],colModel:[{name:"entry",index:"entry_",width:52,sortable:false},{name:"newCsCount",index:"new_cs_count_",sortable:false,width:52},{name:"newMemberCount",index:"new_member_count_",sortable:false,width:52,hidden:b},{name:"newOthersCount",index:"new_others_count_",sortable:false,width:52,hidden:b},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(e,f,g){return g.placeAmount;
}},{name:"placeAmount",index:"place_amount_",width:70,sortable:false,formatter:function(e,f,g){if(g.entry.indexOf("总计：")>-1){return"<span style='color:red;'>"+g.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='place' value='"+g.entry+"'><span style='color:red;'>"+g.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"doneRate",index:"doneRate",width:50,sortable:false},{name:"auditCount",index:"audit_count_",hidedlg:true,hidden:true,sortable:false},{name:"auditAmountHide",index:"audit_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(e,f,g){return g.auditAmount;
}},{name:"auditAmount",index:"audit_amount_",width:70,sortable:false,formatter:function(e,f,g){if(g.entry.indexOf("总计：")>-1){return"<span style='color:red;'>"+g.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.auditAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='confirm' value='"+g.entry+"'><span style='color:red;'>"+g.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.auditAmount).toFixed(2)+"</span></a>";
}}},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(e,f,g){return g.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",width:70,sortable:false,formatter:function(e,f,g){if(g.entry.indexOf("总计：")>-1){return"<span style='color:red;'>"+g.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+g.entry+"'><span style='color:red;'>"+g.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"rejectCount",index:"reject_count_",hidedlg:true,hidden:true,sortable:false},{name:"rejectAmountHide",index:"reject_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(e,f,g){return g.rejectAmount;
}},{name:"rejectAmount",index:"reject_amount_",width:70,sortable:false,formatter:function(e,f,g){if(g.entry.indexOf("总计：")>-1){return"<span style='color:red;'>"+g.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.rejectAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='reject' value='"+g.entry+"'><span style='color:red;'>"+g.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.rejectAmount).toFixed(2)+"</span></a>";
}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(e,f,g){return g.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:70,sortable:false,formatter:function(e,f,g){if(g.entry.indexOf("总计：")>-1){return"<span style='color:red;'>"+g.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.signAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='complete' value='"+g.entry+"'><span style='color:red;'>"+g.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(g.signAmount).toFixed(2)+"</span></a>";
}}},{name:"signRate",index:"signRate",width:50,sortable:false},{name:"history",width:40,formatter:function(e,f,g){return"<a href='#' class='history' value='"+g.entry+"'>历史</a>";
}},],gridComplete:function(){var n=$(window).height()-220;$(".ui-jqgrid-bdiv").css("height",n);var l=$("#countType").val();var v=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","newCsCount",true,"sum");
var k=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","newMemberCount",true,"sum");var p=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","newOthersCount",true,"sum");
var g=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","placeCount",true,"sum");var f=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","placeAmountHide",true,"sum");
var w=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","auditCount",true,"sum");var m=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","auditAmountHide",true,"sum");
var q=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","shipCount",true,"sum");var u=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","shipAmountHide",true,"sum");
var e=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","rejectCount",true,"sum");var s=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","rejectAmountHide",true,"sum");
var o=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","signCount",true,"sum");var t=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","signAmountHide",true,"sum");
var h=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getCol","performanceAmount",true,"sum");var r=$(EntryStatisticsReport._CONS_.GRID).jqGrid("getGridParam","records");
var j="0.0%";var i="0.0%";ConfigUtils.findByKey("profit.signExceptAudit",function(x){if(x.success){if(w==0&&o!=0){j="100%";}else{if(o==0){j="0.0%";}else{j=(o*100/w).toFixed(1)+"%";
}}}else{if(q==0&&o!=0){j="100%";}else{if(o==0){j="0.0%";}else{j=(o*100/q).toFixed(1)+"%";}}}ConfigUtils.findByKey("profit.isAddNewOther",function(y){if(y){var z=v+k+p;
if(z==0&&g!=0){i="100%";}else{if(g==0){i="0.0%";}else{i=(g*100/z).toFixed(1)+"%";}}}else{if(v==0&&g!=0){i="100%";}else{if(g==0){i="0.0%";}else{i=(g*100/v).toFixed(1)+"%";
}}}$(EntryStatisticsReport._CONS_.GRID).footerData("set",{"entry":"总计：<span style='color:red;'>"+r+"</span>个","newCsCount":v,"newMemberCount":k,"newOthersCount":p,"placeCount":g.toFixed(0),"placeAmount":f.toFixed(2),"doneRate":i,"auditCount":w.toFixed(0),"auditAmount":m.toFixed(2),"shipCount":q.toFixed(0),"shipAmount":u.toFixed(2),"rejectCount":e.toFixed(0),"rejectAmount":s.toFixed(2),"signCount":o.toFixed(0),"signAmount":t.toFixed(2),"signRate":j});
});});},});});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(EntryStatisticsReport._CONS_.GRID,a);},toPostParam:function(){var a=$("#entrySearchForm").serialize();
if($(".timeType").val()=="oper"){a+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();a+="&timeType=oper";}else{a+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
a+="&timeType=place";}a+="&reportType="+$("input[name=reportKey]").val();return a;}};