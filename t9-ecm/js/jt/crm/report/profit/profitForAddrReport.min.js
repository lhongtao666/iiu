$(function(){var a=new ProfitForAddrReport();a.init();});function ProfitForAddrReport(){this.hadInit=false;this.isEdit=false;this.sortColumn="";this.sortorder="";
}ProfitForAddrReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listAddrData.htm",LIST_PIE_URL:ctx+"/ec/rp/reportProfit/listAddrPieData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportAddr.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",GRID:"#profitForAddrReportGrid",PAGER:"#profitForAddrReportPager"};
ProfitForAddrReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();ReportDateUtil.initDate(".report-content");
$("#timeTypeSearch").change();a._initJqgrid();a._getData(a.toPostParam());a._channelSearch();CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interstSearch"},{typeKey:"system",pKey:"CsEntryType",container:"entryQry"}]);
CateUtils.findCatePos({typeKey:"soEntity",pKey:"soType",container:"soTypeQry"});if($(".opterate").val()=="1"){$(".opterate").attr("disabled",true);}else{$(".place").attr("disabled",true);
}}},_getData:function(a){var b=this;$.ajax({type:"GET",url:ProfitForAddrReport._CONS_.LIST_PIE_URL,data:a,contentType:"application/json",dataType:"json",success:function(e){reapteData=e;
var g=new Array();for(var c=0;c<e.length;c++){if(e[c].newCsCount){g.push(e[c]);}}var f="newCs";b.createPieReport(g,f);},error:function(c){DialogUtils.error(msgCode.ERROR,c);
}});},createPieReport:function(b,c){var a=new Report();a.data=b;a.setLegend(true,null,"province");if("newCs"==c){a.initSeries([{type:"pie",colName:"newCsCount",legendName:"客户数"}],"province");
a._initChart("profitAddrReportChart","地区客户数分布图");}else{if("create"==c){a.initSeries([{type:"pie",colName:"createCount",legendName:"下单数"}],"province");a._initChart("profitAddrReportChart","地区下单数分布图");
}else{if("audit"==c){a.initSeries([{type:"pie",colName:"auditCount",legendName:"审单数"}],"province");a._initChart("profitAddrReportChart","地区审单数分布图");}else{if("ship"==c){a.initSeries([{type:"pie",colName:"shipCount",legendName:"发货数"}],"province");
a._initChart("profitAddrReportChart","地区发货数分布图");}else{if("sign"==c){a.initSeries([{type:"pie",colName:"signCount",legendName:"签收数"}],"province");a._initChart("profitAddrReportChart","地区签收数分布图");
}else{if("reject"==c){a.initSeries([{type:"pie",colName:"rejectCount",legendName:"拒丢数"}],"province");a._initChart("profitAddrReportChart","地区拒丢数分布图");}}}}}}},_channelSearch:function(){ChannelUtils.getOptions({container:"channelQry",caption:"",type:"noChannelId"});
},_bindEventHander:function(){var a=this;$(document).on("click","#withOutChannel",function(){if($(this).val()==1){$(this).val("0");$(this).removeAttr("checked");
}else{$(this).val("1");$(this).attr("checked","checked");}});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$("#searchBtn").on("click",function(){a.reloadJqgrid(a.toPostParam());$("#csCount").addClass("activeBtn");$("#csCount").siblings().removeClass("activeBtn");
a._getData(a.toPostParam());});$(".reaptType").on("click",function(){$(this).addClass("activeBtn");$(this).siblings().removeClass("activeBtn");var f=$(this).attr("id");
var e=new Array();var c="";if("csCount"==f){for(var b=0;b<reapteData.length;b++){if(reapteData[b].newCsCount){e.push(reapteData[b]);}}c="newCs";a.createPieReport(e,c);
}else{if("createCount"==f){for(var b=0;b<reapteData.length;b++){if(reapteData[b].createCount){e.push(reapteData[b]);}}c="create";a.createPieReport(e,c);
}else{if("comfirmCount"==f){for(var b=0;b<reapteData.length;b++){if(reapteData[b].auditCount){e.push(reapteData[b]);}}c="audit";a.createPieReport(e,c);
}else{if("shipCount"==f){for(var b=0;b<reapteData.length;b++){if(reapteData[b].shipCount){e.push(reapteData[b]);}}c="ship";a.createPieReport(e,c);}else{if("completeCount"==f){for(var b=0;
b<reapteData.length;b++){if(reapteData[b].signCount){e.push(reapteData[b]);}}c="sign";a.createPieReport(e,c);}else{if("lostCount"==f){for(var b=0;b<reapteData.length;
b++){if(reapteData[b].rejectCount){e.push(reapteData[b]);}}c="reject";a.createPieReport(e,c);}}}}}}});$(".opterate").on("click",function(){var b=$("#profitSearchForm").serialize();
b+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=oper";$(".place").val("0");$(this).val("1");$(".place").attr("disabled",false);
$(".opterate").attr("disabled",true);a.reloadJqgrid(b);a._getData(b);});$(".place").on("click",function(){var b=$("#profitSearchForm").serialize();b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
b+="&timeType=place";$(".opterate").val("0");$(this).val("1");$(".place").attr("disabled",true);$(".opterate").attr("disabled",false);a.reloadJqgrid(b);
a._getData(b);});$(document).on("click",".history",function(){var b=$(this).attr("value");if($(".opterate").val()=="1"){var c="oper";}else{var c="place";
}JTTabUtils.addOrRefreshTab(ctx+"/crm/report/performanceForEmpReport/history.htm?type=province&timeType="+c+"&param="+b,"业绩历史详情");});$(document).on("click",".cityTab",function(){var b=$(this).attr("value");
if($(".opterate").val()=="1"){var d="oper";}else{var d="place";}var e=ReportDateUtil.getStartDateTimeRangeStr();var c=ReportDateUtil.getEndDateTimeRangeStr();
JTTabUtils.addOrRefreshTab(ctx+"/crm/report/profitForAddrReport/city.htm?province="+b+"&timeType="+d+"&timeStart="+e+"&timeEnd="+c,b+"城市统计报表");});$(".exportExcel").on("click",function(){FormUtils.submit(ProfitForAddrReport._CONS_.EXPORT_URL,a.toPostParam()+"&sidx="+a.sortColumn+"&sord="+a.sortorder,function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".detail",function(){var c=$(this).attr("profitType");var b=$(this).attr("value");var d={};ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(f){var e={};
ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(l){if(f.success&&c=="place"){e.Q__S__IN__type_="place";}else{if(l.success&&c=="place"){e.Q__S__IN__type_="place,post";
}else{e.Q__S__EQ__type_=c;}}e["Q__S__EQ__profit.province_"]=b;e.type="province";if($(".opterate").val()=="1"){e.timeType="oper";}else{e.timeType="place";
}if($(".interstSearch").val()){e.interests=$(".interstSearch").val();}if($("input[name=belongOgn]").val()){e.belongOgn=$("input[name=belongOgn]").val();
}var k=ReportDateUtil.getStartDateTimeRangeStr();var h=ReportDateUtil.getEndDateTimeRangeStr();var i="/crm/report/performanceForEmpReport/groupDetail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(e))+"&timeStart="+k+"&timeEnd="+h;
var m=$("#channelQry option:selected").length;if(m!=0){i=a._buildDetailChanelSearch(m,i);}else{var j="";var g="";i+="&withOut="+g+"&channelId="+j;}JTTabUtils.addOrRefreshTab(ctx+i,b+"业绩明细");
});});});$("#searchChannel").on("change",function(){if(!$(this).val()){$(".searchChannelVal").val("");}});},_initJqgrid:function(){var e={};var a=this;
e.Q__D__BW__place_time_=ReportDateUtil.getDateTimeRangeStr();e.timeType="place";var b=false;var d=false;var c=true;ConfigUtils.findByKey("profit.isAddNewOther",function(f){if(f.success){b=true;
$(".addNewOther").show();$(".notAddNewOther").hide();}ConfigUtils.findByKey("profit.isHideNewMember",function(g){if(g.success){d=true;$(".addNewOther").hide();
$(".notAddNewOther").hide();}ConfigUtils.findByKey("salesorder.isAddCreateProfit",function(i){if(i.success){c=false;}var h="下单/金额";if(!c){h="提交/金额";}$(ProfitForAddrReport._CONS_.GRID).JTJqgrid({url:ProfitForAddrReport._CONS_.LIST_DATA_URL,postData:e,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["地区","新进客户","删除客户","新进会员","新进其它","下单","金额","下单/金额","提交","金额",h,"提交率","成单率","审单","金额","审单/金额","比例","发货","金额","发货/金额","拒丢","金额","拒丢/金额","签收","金额","签收/金额","签收率","业绩金额","历史"],colModel:[{name:"province",width:62,index:"province_",sortable:false,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return l.province;
}else{return l.province+"<a href='#' class='cityTab' value='"+l.province+"'>[城市]</a>";}}},{name:"newCsCount",index:"new_cs_count_",width:52},{name:"deleteCsCount",index:"delete_cs_count_",width:45,sortable:true},{name:"newMemberCount",index:"new_member_count_",width:52,hidden:d},{name:"newOthersCount",index:"new_others_count_",width:52,hidden:d},{name:"createCount",index:"create_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"createAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.createAmount;
}},{name:"createAmount",index:"create_amount_",width:70,hidden:c,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='create' value='"+l.province+"'><span style='color:red;'>"+l.createCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.createAmount).toFixed(2)+"</span></a>";
}}},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.placeAmount;
}},{name:"placeAmount",index:"place_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='place' value='"+l.province+"'><span style='color:red;'>"+l.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"postRate",index:"post_rate_",width:42,hidden:c,sortable:false},{name:"doneRate",index:"done_rate_",width:42,sortable:true},{name:"auditCount",index:"audit_count_",hidedlg:true,hidden:true,sortable:false},{name:"auditAmountHide",index:"audit_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.auditAmount;
}},{name:"auditAmount",index:"audit_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='confirm' value='"+l.province+"'><span style='color:red;'>"+l.auditCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.auditAmount).toFixed(2)+"</span></a>";
}}},{name:"checkRate",width:42,sortable:false},{name:"shipCount",index:"ship_count_",hidedlg:true,hidden:true,sortable:false},{name:"shipAmountHide",index:"ship_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.shipAmount;
}},{name:"shipAmount",index:"ship_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='ship' value='"+l.province+"'><span style='color:red;'>"+l.shipCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.shipAmount).toFixed(2)+"</span></a>";
}}},{name:"rejectCount",index:"reject_count_",hidedlg:true,hidden:true,sortable:false},{name:"rejectAmountHide",index:"reject_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.rejectAmount;
}},{name:"rejectAmount",index:"reject_amount_",width:70,sortable:false,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='reject' value='"+l.province+"'><span style='color:red;'>"+l.rejectCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.rejectAmount).toFixed(2)+"</span></a>";
}}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(j,k,l){return l.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:70,formatter:function(j,k,l){if(l.province&&l.province.indexOf("总计：")>-1){return"<span style='color:red;'>"+l.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.signAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='complete' value='"+l.province+"'><span style='color:red;'>"+l.signCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(l.signAmount).toFixed(2)+"</span></a>";
}}},{name:"signRate",width:42,sortable:false},{name:"performanceAmount",width:70,index:"performance_amount_",formatter:function(j,k,l){return parseFloat(l.performanceAmount).toFixed(2);
}},{name:"history",width:40,formatter:function(j,k,l){return"<a href='#' class='history' value='"+l.province+"'>历史</a>";}},],beforeProcessing:function(k){var j={province:"总计：",newCsCount:k.footData.newCsCount,deleteCsCount:k.footData.deleteCsCount,newMemberCount:k.footData.newMemberCount,newOthersCount:k.footData.newOthersCount,createCount:k.footData.createCount.toFixed(0),createAmount:k.footData.createAmount.toFixed(2),placeCount:k.footData.placeCount.toFixed(0),placeAmount:k.footData.placeAmount.toFixed(2),delayCount:k.footData.delayCount.toFixed(0),delayAmount:k.footData.delayAmount.toFixed(2),postRate:k.footData.postRate,doneRate:k.footData.doneRate,auditCount:k.footData.auditCount.toFixed(0),auditAmount:k.footData.auditAmount.toFixed(2),checkRate:k.footData.checkRate,shipCount:k.footData.shipCount.toFixed(0),shipAmount:k.footData.shipAmount.toFixed(2),rejectCount:k.footData.rejectCount.toFixed(0),rejectAmount:k.footData.rejectAmount.toFixed(2),signCount:k.footData.signCount.toFixed(0),signAmount:k.footData.signAmount.toFixed(2),signRate:k.footData.signRate,delaySignCount:(k.footData.signCount+k.footData.delayCount).toFixed(0),delaySignAmountHide:(k.footData.signAmount+k.footData.delayAmount).toFixed(2),delaySignAmount:k.footData.signAmount.toFixed(2)+k.footData.delayAmount.toFixed(2)};
a.footerData=j;},gridComplete:function(){if(a.footerData){var j=$(ProfitForAddrReport._CONS_.GRID).jqGrid("getGridParam","records");a.footerData.province="总计：<span style='color:red;'>"+j+"</span>个";
$(ProfitForAddrReport._CONS_.GRID).footerData("set",a.footerData);}},onSortCol:function(k,l,j){a.sortColumn=k;a.sortorder=j;a.reloadJqgrid(a.toPostParam()+"&sortColumn="+a.sortColumn+"&sortorder="+a.sortorder);
}});});});});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ProfitForAddrReport._CONS_.GRID,a);},toPostParam:function(){var a=this;var c=$("#profitSearchForm").serialize();
if($(".opterate").val()=="1"){c+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();}else{c+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();
}c+="&reportType="+$("input[name=reportKey]").val();var b=$("#channelQry option:selected").length;if(channelQry!=0){c=a._buildChanelSearch(c,b);}if($("#withOutChannel").is(":checked")){c+="&withOut="+"withOut";
}return c;},_buildChanelSearch:function(d,c){var b=this;var e=new StringBuffer();var a=null;$("#channelQry option:selected").each(function(f){if($(this).val()==""){a="withOut";
}e.append($(this).val());if(f==c-1){return false;}else{e.append(",");}});d=d+"&channelId="+e.toString();if(a){d+="&withOut="+"withOut";}return d;},_buildDetailChanelSearch:function(d,c){var b=this;
var e=new StringBuffer();var a="";$("#channelQry option:selected").each(function(f){if($(this).val()==""){a="withOut";}e.append($(this).val());if(f==d-1){return false;
}else{e.append(",");}});c+="&channelId="+e.toString()+"&withOut="+a;return c;}};