$(function(){var a=new EntryTimeReport();a.init();});function EntryTimeReport(){this.hadInit=false;this.isEdit=false;}EntryTimeReport._CONS_={LIST_DATA_URL:ctx+"/ec/rp/reportProfit/listEntryTimeData.htm",EXPORT_URL:ctx+"/crm/report/performanceForEmpReport/exportEntryTime.htm",PIE_REPORT_URL:ctx+"/ec/rp/reportProfit/profitTimePieData.htm",GRID:"#entryTimeReportGrid",PAGER:"#entryTimeReportPager"};
EntryTimeReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();
a._initJqgrid();a._getData(a.toPostParam());CateUtils.getOptions({typeKey:"system",pKey:"CsInterestType",container:"interstSearch"});}},_bindEventHander:function(){var a=this;
$("#searchBtn").on("click",function(){a.reloadJqgrid(a.toPostParam());});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$(".report-content").on("click",".exportExcel",function(){FormUtils.submit(EntryTimeReport._CONS_.EXPORT_URL,a.toPostParam(),function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".detail",function(){var d=$(this).attr("profitType");var c=$(this).attr("value");var b=null;ConfigUtils.findByKey("salesorder.isAddCloseProfit",function(f){var e={};
ConfigUtils.findByKey("salesorder.isAddAwaitPostProfit",function(j){if(f.success&&d=="place"){e.Q__S__IN__type_="place";}else{if(j.success&&d=="place"){e.Q__S__IN__type_="place,post";
}else{e.Q__S__EQ__type_=d;}}if(c!="undefined"&&c!=""){e.timeFrame=c;b=c+"-"+(parseInt(c)+1);e.type="timeFrame";}else{b="0点-24";}e.reportType="entryTimeReport";
if($(".opterate").val()=="1"){e.timeType="oper";}else{e.timeType="place";}if($(".interstSearch").val()){e.interests=$(".interstSearch").val();}var i=ReportDateUtil.getStartDateTimeRangeStr();
var g=ReportDateUtil.getEndDateTimeRangeStr();var h="/crm/report/performanceForEmpReport/groupDetail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(e))+"&timeStart="+i+"&timeEnd="+g;
JTTabUtils.addOrRefreshTab(ctx+h,b+"点业绩明细");});});});$(document).on("click",".csDetail",function(){var e=$(this).attr("value");var g={};var d=null;if(e!="undefined"&&e!=""){g.timeFrame=e;
d=e+"-"+(parseInt(e)+1);}else{d="0点-24";}g.reportType="entryTimeReport";g.type="newcs";if($(".opterate").val()=="1"){g.timeType="oper";}else{g.timeType="place";
}if($(".interstSearch").val()){g.interests=$(".interstSearch").val();}var f=ReportDateUtil.getStartDateTimeRangeStr();var b=ReportDateUtil.getEndDateTimeRangeStr();
var c="/crm/report/performanceForEmpReport/csDetail.htm?paramsDetail="+encodeURIComponent(JSON.stringify(g))+"&timeStart="+f+"&timeEnd="+b;JTTabUtils.addOrRefreshTab(ctx+c,d+"点客户明细");
});},_initJqgrid:function(){var d={};var a=this;d.Q__D__BW__oper_time_=ReportDateUtil.getDateTimeRangeStr();d.reportType="entryTimeReport";var b=false;
var c=false;ConfigUtils.findByKey("profit.isAddNewOther",function(e){if(e.success){b=true;$(".addNewOther").show();$(".notAddNewOther").hide();}ConfigUtils.findByKey("profit.isHideNewMember",function(f){if(f.success){c=true;
$(".addNewOther").hide();$(".notAddNewOther").hide();}$(EntryTimeReport._CONS_.GRID).JTJqgrid({url:EntryTimeReport._CONS_.LIST_DATA_URL,postData:d,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["注册时段","新进客户","新进会员","新进其它","客户数（隐藏）","下单","金额","下单/金额","比例"],colModel:[{name:"timeFrame",index:"time_frame_",width:52,sortable:false,formatter:function(g,h,i){return i.timeFrame+"-"+(i.timeFrame+1)+"点";
}},{name:"newCsCount",index:"new_cs_count_",sortable:false,width:52,formatter:function(g,h,i){if((i.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+i.newCsCount+"</span>";
}else{return"<a href='#' class='csDetail' value='"+i.timeFrame+"'><span style='color:red;'>"+i.newCsCount+"</span></a>";}}},{name:"newMemberCount",index:"new_member_count_",sortable:false,width:52,hidden:c},{name:"newOthersCount",index:"new_others_count_",sortable:false,width:52,hidden:c},{name:"newCsCountHide",index:"newCsCount",sortable:false,hidedlg:true,hidden:true,formatter:function(g,h,i){return i.newCsCount;
}},{name:"placeCount",index:"place_count_",width:70,hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",width:70,hidedlg:true,hidden:true,sortable:false,formatter:function(g,h,i){return i.placeAmount;
}},{name:"placeAmount",index:"place_amount_",sortable:false,width:70,formatter:function(g,h,i){if((i.timeFrame+"").indexOf("总计：")>-1){return"<span style='color:red;'>"+i.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.placeAmount).toFixed(2)+"</span>";
}else{return"<a href='#' class='detail' profitType='place' value='"+i.timeFrame+"'><span style='color:red;'>"+i.placeCount+"</span>"+"/<span style='color:blue;'>"+parseFloat(i.placeAmount).toFixed(2)+"</span></a>";
}}},{name:"done",index:"done_",width:42,sortable:false,formatter:function(h,j,k){var g="";var i=k.newCsCount;if(b){i+=k.newOthersCount+k.newMemberCount;
}if(k.placeCount!=0&&i==0){g=100+"%";}else{if(k.placeCount!=0&&i!=0){g=(k.placeCount/i*100).toFixed(0)+"%";}else{if(k.placeCount==0){g=0+"%";}}}return g;
}},],gridComplete:function(){var m=$(EntryTimeReport._CONS_.GRID).jqGrid("getCol","newCsCountHide",true,"sum");var i=$(EntryTimeReport._CONS_.GRID).jqGrid("getCol","newMemberCount",true,"sum");
var j=$(EntryTimeReport._CONS_.GRID).jqGrid("getCol","newOthersCount",true,"sum");var l=$(EntryTimeReport._CONS_.GRID).jqGrid("getCol","placeCount",true,"sum");
var k=$(EntryTimeReport._CONS_.GRID).jqGrid("getCol","placeAmountHide",true,"sum");var h="";if(l!=0&&m==0){h=100+"%";}else{if(l!=0&&m!=0){h=(l/m*100).toFixed(0)+"%";
}else{if(l==0){h=0+"%";}}}var g=$(EntryTimeReport._CONS_.GRID).jqGrid("getGridParam","records");$(EntryTimeReport._CONS_.GRID).footerData("set",{"newCsCount":m,"newMemberCount":i,"newOthersCount":j,"placeCount":l.toFixed(0),"placeAmount":k.toFixed(2),"done":h});
},});});});},reloadJqgrid:function(b){var a=this;JTJqgridUtils.reloadJqgrid(EntryTimeReport._CONS_.GRID,b);a._getData(a.toPostParam());},toPostParam:function(){var a=$("#profixSearchForm").serialize();
a+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();a+="&reportType=entryTimeReport";return a;},_getData:function(a){var b=this;$.ajax({type:"GET",url:EntryTimeReport._CONS_.PIE_REPORT_URL,data:a,contentType:"application/json",dataType:"json",success:function(c){b.createBarReport(c);
},error:function(c){DialogUtils.error(msgCode.ERROR,c);}});},createBarReport:function(c){var a=new Report();for(var b=0;b<c.length;b++){c[b].timeFrame=c[b].timeFrame+"-"+(c[b].timeFrame+1)+"点";
}a.data=c;a.setLegend(true,null,"timeFrame");a.setBarSeriesStyle(true,"right","{c}");a.setGridX(100);a.initSeries([{type:"bar",colName:"newCsCount",legendName:"新进客户"},{type:"bar",colName:"timeFrame",legendName:"时段"}],"timeFrame",null,null);
a._initChart("entryTimeReportChart","进线时段分布图");}};