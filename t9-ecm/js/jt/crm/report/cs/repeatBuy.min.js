$(function(){var a=new RepeatBuy();a.init();});function RepeatBuy(){this.hadInit=false;}RepeatBuy._CONS_={LIST_URL:ctx+"/crm/report/repeatBuy/repeatListData.htm",GRID:"#repeatBuyGrid",PAGER:"#repeatBuyPager",EXPORT_URL:ctx+"/crm/report/repeatBuy/exportExcel.htm",};
RepeatBuy.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindEventHander();ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();
this._initJqgrid();if($(".opterate").val()=="1"){$(".opterate").attr("disabled",true);}else{$(".place").attr("disabled",true);}}},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(RepeatBuy._CONS_.GRID,a);
},_bindEventHander:function(){var a=this;$("#repeatBuySearchForm").on("click",".repeatBuySearchBtn",function(){a.reloadJqgrid(a._postParams());});$(".opterate").on("click",function(){var b=$("#repeatBuySearchForm").serialize();
if(b==null||typeof b==undefined){b={};}b+="&Q__D__BW__entity.last_complete_time_="+ReportDateUtil.getDateTimeRangeStr();if($("#belongEmployee").val()!=""&&$("#belongEmployee").val()!=null){b+="&Q__S__EQ__entity.employee_id_="+$("#belongEmployee").val();
}if(ReportDateUtil.getDateTimeRangeStr()!=","){b+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();}b+="&timeStart="+ReportDateUtil.getStartDateTimeRangeStr()+" 00:00:00";
b+="&timeEnd="+ReportDateUtil.getEndDateTimeRangeStr()+" 23:59:59";b+="&timeType=oper";$(".place").val("0");$(this).val("1");$(".place").attr("disabled",false);
$(".opterate").attr("disabled",true);a.reloadJqgrid(b);});$(".place").on("click",function(){var b=$("#repeatBuySearchForm").serialize();if(b==null||typeof b==undefined){b={};
}b+="&Q__D__BW__entity.last_complete_time_="+ReportDateUtil.getDateTimeRangeStr();if($("#belongEmployee").val()!=""&&$("#belongEmployee").val()!=null){b+="&Q__S__EQ__entity.employee_id_="+$("#belongEmployee").val();
}if(ReportDateUtil.getDateTimeRangeStr()!=","){b+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();b+="&timeType=place";}b+="&timeStart="+ReportDateUtil.getStartDateTimeRangeStr()+" 00:00:00";
b+="&timeEnd="+ReportDateUtil.getEndDateTimeRangeStr()+" 23:59:59";b+="&countType=count";$(".opterate").val("0");$(this).val("1");$(".place").attr("disabled",true);
$(".opterate").attr("disabled",false);a.reloadJqgrid(b);});$("#repeatBuySearchForm").on("click",".repeatBuyExportExcel",function(){a._exportExcel();});
$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$(document).on("click",".empDetail",function(){var c=$(this).attr("belongOgn");var h=ReportDateUtil.getStartDateTimeRangeStr();
var b=ReportDateUtil.getEndDateTimeRangeStr();var g=ReportDateUtil.getDateTimeRangeStr();var d=$("#saleLine").val();var f="";if(ReportDateUtil.getDateTimeRangeStr()!=","){if($(".opterate").val()=="1"){f="oper";
}else{f="place";}}var e="/crm/report/repeatBuy/empDetail.htm?belongOgn="+c+"&timeType="+f+"&saleLine="+d+"&timeStart="+h+"&timeEnd="+b+"&dateTime="+g;JTTabUtils.addOrRefreshTab(ctx+e,"员工复购客户统计");
});$(document).on("click",".tabDetail",function(){var e=$(this).attr("belongOgn");var c=$(this).attr("repeatCount");var g=ReportDateUtil.getStartDateTimeRangeStr();
var b=ReportDateUtil.getEndDateTimeRangeStr();var f=ReportDateUtil.getDateTimeRangeStr();var d="/crm/report/repeatBuy/detail.htm?groupId="+e+"&employeeId="+"&repeatCount="+c+"&timeStart="+g+"&timeEnd="+b+"&dateTime="+f;
JTTabUtils.addOrRefreshTab(ctx+d,"复购客户明细");});},_initJqgrid:function(){var a=this;$(RepeatBuy._CONS_.GRID).JTJqgrid({url:RepeatBuy._CONS_.LIST_URL,postData:a._postParams(),multiselect:false,rowNum:-1,footerrow:true,colNames:["部门","总客户数","复购金额","复购客户","复购客户/金额","占比率","新进客户","下单","金额","下单/金额","签收","金额","签收/金额","一购客户/最新订单金额","一次复购","金额","二购客户/最新订单金额","二次复购","金额","三购客户/最新订单金额","三次复购","金额","四购客户/最新订单金额","四次复购","金额","五购客户/最新订单金额","五次复购","金额",],colModel:[{name:"groupName",width:60,index:"groupName",sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return d.groupName;
}else{return"<a href='javascript:void(0)' class='empDetail' belongOgn='"+d.groupId+"'>"+d.groupName+"</a>";}}},{name:"entityCount",index:"entityCount",width:60,hidedlg:true,sortable:false},{name:"sumSoTotal",index:"sumSoTotal",width:60,hidden:true,hidedlg:true},{name:"sumRepeatHide",index:"sumRepeat",width:60,hidden:true,hidedlg:true,formatter:function(b,c,d){return d.sumRepeat;
}},{name:"sumRepeat",index:"sumRepeat",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.sumRepeat+"/"+d.sumSoTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='0' belongOgn='"+d.groupKey+"'>"+d.sumRepeat+"/"+d.sumSoTotal+"</a>";}}},{name:"repeatRate",index:"repeatRate",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){return d.repeatRate;
}},{name:"newCsCount",index:"new_cs_count_",width:52,sortable:false},{name:"placeCount",index:"place_count_",hidedlg:true,hidden:true,sortable:false},{name:"placeAmountHide",hidedlg:true,hidden:true,sortable:false,formatter:function(b,c,d){return d.placeAmount;
}},{name:"placeAmount",index:"place_amount_",width:60,sortable:false,formatter:function(b,c,d){return"<span>"+d.placeCount+"/"+parseFloat(d.placeAmount).toFixed(2)+"</span>";
}},{name:"signCount",index:"sign_count_",hidedlg:true,hidden:true,sortable:false},{name:"signAmountHide",index:"sign_amount_",hidedlg:true,hidden:true,sortable:false,formatter:function(b,c,d){return d.signAmount;
}},{name:"signAmount",index:"sign_amount_",width:60,sortable:false,formatter:function(b,c,d){return"<span>"+d.signCount+"/"+parseFloat(d.signAmount).toFixed(2)+"</span>";
}},{name:"firstBuy",index:"firstBuy",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.firstBuy+"/"+d.firstTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='1' belongOgn='"+d.groupKey+"'>"+d.firstBuy+"</a>/<span style='color:red'>"+d.firstTotal+"</span>";
}}},{name:"firstBuyHide",index:"firstBuy",width:60,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.firstBuy;}},{name:"firstTotal",index:"firstTotal",width:60,hidedlg:true,hidden:true},{name:"secondBuy",index:"secondBuy",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.secondBuy+"/"+d.secondTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='2' belongOgn='"+d.groupKey+"'>"+d.secondBuy+"</a>/<span style='color:red'>"+d.secondTotal+"</span>";
}}},{name:"secondBuyHide",index:"secondBuy",width:60,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.secondBuy;}},{name:"secondTotal",index:"secondTotal",width:60,hidedlg:true,hidden:true},{name:"thirdBuy",index:"thirdBuy",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.thirdBuy+"/"+d.thirdTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='3' belongOgn='"+d.groupKey+"'>"+d.thirdBuy+"</a>/<span style='color:red'>"+d.thirdTotal+"</span>";
}}},{name:"thirdBuyHide",index:"thirdBuy",width:60,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.thirdBuy;}},{name:"thirdTotal",index:"thirdTotal",width:60,hidedlg:true,hidden:true},{name:"fourBuy",index:"fourBuy",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.fourBuy+"/"+d.fourTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='4' belongOgn='"+d.groupKey+"'>"+d.fourBuy+"</a>/<span style='color:red'>"+d.fourTotal+"</span>";
}}},{name:"fourBuyHide",index:"fourBuy",width:60,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.fourBuy;}},{name:"fourTotal",index:"fourTotal",width:60,hidedlg:true,hidden:true},{name:"fiveBuy",index:"fiveBuy",width:60,hidedlg:true,sortable:false,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span>"+d.fiveBuy+"/"+d.fiveTotal+"</span>";
}else{return"<a href='javascript:void(0)' class='tabDetail' repeatCount='5' belongOgn='"+d.groupKey+"'>"+d.fiveBuy+"</a>/<span style='color:red'>"+d.fiveTotal+"</span>";
}}},{name:"fiveBuyHide",index:"fiveBuy",width:60,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.fiveBuy;}},{name:"fiveTotal",index:"fiveTotal",width:60,hidedlg:true,hidden:true},],loadComplete:function(){var u=[];
var q=$(RepeatBuy._CONS_.GRID).jqGrid("getGridParam","records");var c=0;var m=0;var e=0;var k=0;var t=0;var j=0;var s=0;var h=0;var n=0;var o=0;var g=0;
var l=0;var f=0;var p=0;var b=0;var w=0;var r=0;var v=0;var i=$(RepeatBuy._CONS_.GRID).jqGrid("getRowData")[0];if(q!=0){c=i.entityCount;m=i.sumRepeatHide;
e=i.sumSoTotal;k=i.firstBuyHide;t=i.secondBuyHide;j=i.thirdBuyHide;s=i.fourBuyHide;h=i.fiveBuyHide;n=i.firstTotal;o=i.secondTotal;g=i.thirdTotal;l=i.fourTotal;
f=i.fiveTotal;p=i.newCsCount;b=i.placeCount;w=i.signCount;r=i.placeAmountHide;v=i.signAmountHide;}var d=0+"%";if(m!=0&&c==0){d=100+"%";}else{if(m!=0&&c!=0){d=(m/c*100).toFixed(0)+"%";
}}$(RepeatBuy._CONS_.GRID).jqGrid("footerData","set",{"groupName":"总计："+q+"条","entityCount":+c,"sumRepeat":m,"sumSoTotal":e,"repeatRate":d,"newCsCount":p,"placeCount":b,"placeAmount":r,"signCount":w,"signAmount":v,"firstBuy":k,"firstTotal":n,"secondTotal":o,"secondBuy":t,"thirdBuy":j,"thirdTotal":g,"fourBuy":s,"fourTotal":l,"fiveBuy":h,"fiveTotal":f});
u[0]=[k,t,j,s,h];u[1]=[n,o,g,l,f];a._createEntityRepeatEchart(u);}});$(window).bind("resize",function(){$(RepeatBuy._CONS_.GRID).setGridWidth($(".report-content").width()-4);
});},_postParams:function(){var a=$("#repeatBuySearchForm").serialize();if(a==null||typeof a==undefined){a={};}a+="&Q__D__BW__entity.last_complete_time_="+ReportDateUtil.getDateTimeRangeStr();
if($("#belongEmployee").val()!=""&&$("#belongEmployee").val()!=null){a+="&Q__S__EQ__entity.employee_id_="+$("#belongEmployee").val();}if(ReportDateUtil.getDateTimeRangeStr()!=","){if($(".opterate").val()=="1"){a+="&Q__D__BW__oper_time_="+ReportDateUtil.getDateTimeRangeStr();
a+="&timeType=oper";}else{a+="&Q__D__BW__place_time_="+ReportDateUtil.getDateTimeRangeStr();a+="&timeType=place";}}a+="&timeStart="+ReportDateUtil.getStartDateTimeRangeStr()+" 00:00:00";
a+="&timeEnd="+ReportDateUtil.getEndDateTimeRangeStr()+" 23:59:59";a+="&countType=count";return a;},_exportExcel:function(){var a=this;var b=a._postParams();
FormUtils.submit(RepeatBuy._CONS_.EXPORT_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_createEntityRepeatEchart:function(f){var l=this;var e="一次复购",d="二次复购",c="三次复购",b="四次复购",a="五次复购";
var k="",j="",i="",h="",g="";if(f[0]){e=(f[0][0]);d=(f[0][1]);c=(f[0][2]);b=(f[0][3]);a=(f[0][4]);}if(f[1]){k=(f[1][0]);j=(f[1][1]);i=(f[1][2]);h=(f[1][3]);
g=(f[1][4]);}option={height:350,toolbox:{show:true,feature:{saveAsImage:{show:true}}},grid:{x:35,y:15,x2:35,y2:10,borderWidth:1},tooltip:{trigger:"axis",formatter:function(m){if(m[0].name=="一次复购"){return m[0].data+"/"+k;
}if(m[0].name=="二次复购"){return m[0].data+"/"+j;}if(m[0].name=="三次复购"){return m[0].data+"/"+i;}if(m[0].name=="四次复购"){return m[0].data+"/"+h;}if(m[0].name=="五次复购"){return m[0].data+"/"+g;
}}},calculable:true,xAxis:[{type:"category",data:["一次复购","二次复购","三次复购","四次复购","五次复购"]}],yAxis:[{name:"复购数",type:"value"}],series:[{name:"复购数",type:"bar",smooth:true,stack:"总量",barWidth:60,data:[e,d,c,b,a]}]};
if(!l.echarts){l.echarts=echarts.init(document.getElementById("entityRepeatChart"));}l.echarts.setOption(option);$("#entityRepeatChart").height($(window).height()*0.8);
}};