$(function(){var a=new SaleStockReport();a.init();});function SaleStockReport(){this.hadInit=false;}SaleStockReport._CONS_={GRID:"#saleStockReportGrid",PAGER:"#saleStockReportPager",URL_LIST_DATA:ctx+"/crm/report/reportEntity/saleStockReport.htm",};
SaleStockReport.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid(a);this._initSelect();this._prodSearch();
StoreUtils.loadStores("","storeIdSearch");}},_initSelect:function(){},_bindEventHander:function(){var a=this;$("body").on("click","[name=groupName]",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$('input[name="groupId"]').val(),container:"groupName",fn:function(c,b){$('input[name="groupId"]').val(c);
$('input[name="groupKey"]').val(b);}});});$("body").on("click",".export",function(){if(!$('input[name="startTime"]').val()){var b=new Date();var c=b.currentDate()+"00:00:00";
$('input[name="startTime"]').val(c);}var d=$("#searchForm").closest("form").serialize();FormUtils.submit(ctx+"/crm/report/reportEntity/exportSaleStockReport.htm",d,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);
}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".list_wrapper").on("click",".saleStockSearch",function(){if(!$('input[name="startTime"]').val()){var b=new Date();
var c=b.currentDate()+"00:00:00";$('input[name="startTime"]').val(c);}if(!$(".searchProd").attr("data-id")){$(".skuSearch").val("");}var d=$(this).closest("form").serialize();
a.reloadJqgrid(d);});$("#searchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".saleStockSearch").trigger("click");}});$(document).on("click",".skuSearchImg",function(){SelectProdService.selectSku({isMultiple:0,hideCanSale:"y",fn:function(b){for(var c=0;
c<b.length;c++){$("#skuSearch").val(b[c].skuCode);$("#skuId").val(b[c].skuId);}}});});$("body").on("click",".openDetail",function(){var g=$(this).attr("startTime");
var e=$(this).attr("endTime");var d=$(this).attr("groupKey");var f=$(this).attr("type");var c="";var b="";if($(this).attr("storeId")!="null"){c=$(this).attr("storeId");
}if($(this).attr("skuId")!="null"){b=$(this).attr("skuId");}var i="明细";if("awaitingPost"===f){i="未确认";}else{if("sale"===f){i="销售数";}else{if("hasCommit"===f){i="已审核";
}else{if("awaitingShip"===f){i="待发货";}else{if("actualShipped"===f){i="实际出库";}else{if("close"===f){i="已作废";}}}}}}var h="startTime="+g+"&endTime="+e+"&groupKey="+d+"&type="+f+"&skuId="+b+"&storeId="+c;
JTTabUtils.addOrRefreshTab(ctx+"/crm/report/reportEntity/openSaleStockDetail.htm?"+h,i);});},_prodSearch:function(a){$(".searchProd").bsSuggest("destroy");
var b=this;var e=$(".searchProd").width()+"px";var c="entity";var f="n";var d="n";$(".searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+f+"&storeId="+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuId",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(g){b.searchProds=g.value;
return g;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(h,g){b.searchProds=g.value;
}).on("onSetSelectValue",function(j,g){for(var h=0;h<b.searchProds.length;h++){if(b.searchProds[h].skuId==g.id){b.currentProd=b.searchProds[h];break;}}$(".searchProd").val(b.currentProd.prodName);
$(".skuSearch").val(b.currentProd.skuId);}).on("onUnsetSelectValue",function(g){b.currentProd={};});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(SaleStockReport._CONS_.GRID,a);
},_decorateData:function(c,e,f){var b=e.split("/");var d=b[0];var a=b[1];return"<a skuId='"+f.skuId+"' storeId='"+f.storeId+"' startTime='"+f.startTime+"' groupKey='"+f.groupKey+"' href='javascript: void(0);' endTime='"+f.endTime+"' type='"+c+"' class='openDetail'>"+"<span style='color:red;'>"+d+"</span>"+"/<span style='color:blue;'>"+a+"</span>"+"</a>";
},_initJqgrid:function(d){if(d==null||typeof d==undefined){d={};}var b=this;var a=new Date();var c=a.currentDate()+" 00:00:00";$('input[name="startTime"]').val(c);
$(SaleStockReport._CONS_.GRID).JTJqgrid({url:SaleStockReport._CONS_.URL_LIST_DATA,postData:{startTime:c,},pager:SaleStockReport._CONS_.PAGER,footerrow:true,multiselect:false,colNames:["部门","未确认","销售数","已审核","待发货","实际销售出库","已作废"],colModel:[{name:"groupName",width:120,sortable:false,formatter:function(f,e,g){return g.groupName;
}},{name:"awaitingPost",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("awaitingPost",f.awaitingPost,f);}},{name:"sale",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("sale",f.sale,f);
}},{name:"hasCommit",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("hasCommit",f.hasCommit,f);}},{name:"awaitingShip",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("awaitingShip",f.awaitingShip,f);
}},{name:"actualShipped",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("actualShipped",f.actualShipped,f);}},{name:"close",width:120,sortable:false,formatter:function(g,e,f){return b._decorateData("close",f.close,f);
}},],beforeProcessing:function(f){if(f.rows&&f.rows.length){var e={groupName:"总计：",awaitingPost:f.footData.awaitingPost,sale:f.footData.sale,hasCommit:f.footData.hasCommit,awaitingShip:f.footData.awaitingShip,actualShipped:f.footData.actualShipped,close:f.footData.close,};
b.footerData=e;}},gridComplete:function(){if(b.footerData){var e=$(SaleStockReport._CONS_.GRID).jqGrid("getGridParam","records");b.footerData.groupName="总计：<span style='color:red;'>"+e+"</span>个";
$(SaleStockReport._CONS_.GRID).footerData("set",b.footerData);}},});}};