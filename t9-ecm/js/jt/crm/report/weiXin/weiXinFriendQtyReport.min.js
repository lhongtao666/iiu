$(function(){var a=new WeiXinFriendQtyReport();a.init();});function WeiXinFriendQtyReport(){this.hadInit=false;this.baseUrl=ctx+"/crm/report/weiXinFriendQtyReport/listData.htm";
}WeiXinFriendQtyReport._CONS_={EXPORT_URL:ctx+"/crm/report/weiXinFriendQtyReport/export.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",GRID:"#weiXinFriendQtyReportGrid",};
WeiXinFriendQtyReport.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();$("#timeTypeSearch").val("day");ReportDateUtil.initDate(".report-content");
$("#timeTypeSearch").change();this._initJqgrid(this.toPostParam());this._buildEmployeeSelect();this._channelSearch();}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString()).select2();
}}});},_bindEventHander:function(){var a=this;$(document).on("click","#withOutChannel",function(){if($(this).val()==1){$(this).val("0");$(this).removeAttr("checked");
}else{$(this).val("1");$(this).attr("checked","checked");}});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c,d){$("input[name=belongOgn]").val(d);
FormUtils.loadData(WeiXinFriendQtyReport._CONS_.EMPLOYEE_LIST_URL+"?groupId="+c+"&type=statistics,dept_manager",function(f){var g=new StringBuffer();g.append('<option value="">请选择</option>');
for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}$("#belongEmployeeSearch").empty().append(g.toString());
});}};GroupUtils.selectGroupTreeBox(b);});$(".report-content").off("click","#searchBtn");$(".report-content").on("click","#searchBtn",function(){a.reloadJqgrid(a.toPostParam());
});$(".report-content").off("click",".exportExcel");$(".report-content").on("click",".exportExcel",function(){ButtonUtils.disableBtn("exportExcel");FormUtils.submit(WeiXinFriendQtyReport._CONS_.EXPORT_URL,a.toPostParam(),function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".showFriendDetail",function(){var e=$(this).attr("value").split(",");var c=ReportDateUtil.getDateTimeRangeStr().split(",");
var b=$("input[type='radio']:checked").val();var d={beginTime:c[0],endTime:c[1],employeeName:e[0],employeeId:e[1],radioValue:b,employeeAlias:e[2],};JTTabUtils.addOrRefreshTab(ctx+"/crm/report/weiXinFriendQtyReport/toDetailList.htm?beginTime="+d.beginTime+"&endTime="+d.endTime+"&employeeId="+d.employeeId+"&radioValue="+d.radioValue+"&employeeAlias="+d.employeeAlias,d.employeeName+"进粉明细");
});$(document).on("click",".showDelFriendDetail",function(){var c=$(this).attr("value").split(",");var b=ReportDateUtil.getDateTimeRangeStr().split(",");
var d={beginTime:b[0],endTime:b[1],employeeUserName:c[0],employeeName:c[1],friendForType:"employee"};var e=ctx+"/crm/report/weiXinFriendDeleteReport/toDetailList.htm?beginTime="+d.beginTime+"&endTime="+d.endTime+"&employeeUserName="+d.employeeUserName+"&friendForType="+d.friendForType;
JTTabUtils.addOrRefreshTab(e,d.employeeName+"删粉明细");});$(document).on("click",".validCountDetail",function(){var c=$(this).attr("value").split(",");var b=ReportDateUtil.getDateTimeRangeStr().split(",");
var d={beginTime:b[0],endTime:b[1],employeeAlias:c[0],employeeName:c[1],countType:"validCount"};var e=ctx+"/crm/report/weiXinFriendQtyReport/toDetailCount.htm?beginTime="+d.beginTime+"&endTime="+d.endTime+"&employeeAlias="+d.employeeAlias+"&countType="+d.countType;
JTTabUtils.addOrRefreshTab(e,"["+d.employeeName+"]有效沟通明细");});$(document).on("click",".sessionCountDetail",function(){var c=$(this).attr("value").split(",");
var b=ReportDateUtil.getDateTimeRangeStr().split(",");var d={beginTime:b[0],endTime:b[1],employeeAlias:c[0],employeeName:c[1],countType:"sessionCount"};
var e=ctx+"/crm/report/weiXinFriendQtyReport/toDetailCount.htm?beginTime="+d.beginTime+"&endTime="+d.endTime+"&employeeAlias="+d.employeeAlias+"&countType="+d.countType;
JTTabUtils.addOrRefreshTab(e,"["+d.employeeName+"]聊天明细");});$(".report-content").on("click","#clearSearchBtn",function(){FormUtils.clear("weiXinFriendQtySearchForm");
$("#timeTypeSearch").val("day");ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();if(a._getContainer("channelQry")){a._getContainer("channelQry").selectpicker("refresh");
}});},_getContainer:function(b){var a=this;var c=false;if(b){c=$("#"+b);if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");if(c.length==0){return false;
}}}}return c;},_initJqgrid:function(b){var a=this;$(WeiXinFriendQtyReport._CONS_.GRID).JTJqgrid({url:this.baseUrl,postData:b,multiselect:false,footerrow:true,sortable:true,rowNum:-1,colNames:["部门","员工/工号","员工微信号","微信状态","推广员","昵称备注","渠道","总粉","底粉","进粉","删粉数量(hidden)","删粉","有效沟通(hidden)","有效沟通","聊天人数(hidden)","聊天人数"],colModel:[{name:"groupName",width:120,sortable:false},{name:"employeeName",width:120,sortable:false,formatter:function(c,d,e){return"<a class='showFriendDetail' value='"+e.employeeName+","+e.employeeId+","+e.employeeAlias+"'>"+e.employeeName+" : "+e.aid+"</a>";
}},{name:"employeeAlias",width:120,sortable:false,formatter:function(c,d,e){return e.employeeAlias+" : "+e.nickName;}},{name:"weixinStatus",width:120,sortable:false},{name:"mgrName",width:120,sortable:false},{name:"employeeRemark",width:120,sortable:false},{name:"channelName",width:120,sortable:false},{name:"totalCount",index:"total_count",width:120,sortable:true},{name:"basisCount",index:"basis_count",width:120,sortable:true},{name:"friendQty",index:"friend_qty",width:120,sortable:true},{name:"delFriendQty",width:120,hidden:true},{name:"delFriendQty",index:"del_friend_qty",width:120,sortable:true,formatter:function(c,d,e){if(e.groupName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.delFriendQty+"</span>";
}else{return"<a class='showDelFriendDetail' value='"+e.employeeAlias+","+e.employeeName+"'>"+e.delFriendQty+"</a>";}}},{name:"validCount",width:120,hidden:true},{name:"validCount",index:"valid_count",width:120,sortable:true,formatter:function(c,d,e){if(e.groupName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.validCount+"</span>";
}else{if(e.validCount!=""){return"<a class='validCountDetail' value='"+e.employeeAlias+","+e.employeeName+"'>"+e.validCount+"</a>";}else{return"<a class='validCountDetail' value='"+e.employeeAlias+","+e.employeeName+"'>0</a>";
}}}},{name:"sessionCount",width:120,hidden:true},{name:"sessionCount",index:"session_count",width:120,sortable:true,formatter:function(c,d,e){if(e.groupName.indexOf("总计：")>-1){return"<span style='color:red;'>"+e.sessionCount+"</span>";
}else{if(e.validCount!=""){return"<a class='sessionCountDetail' value='"+e.employeeAlias+","+e.employeeName+"'>"+e.sessionCount+"</a>";}else{return"<a class='sessionCountDetail' value='"+e.employeeAlias+","+e.employeeName+"'>0</a>";
}}}}],gridComplete:function(){var d=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getGridParam","records");var h=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","friendQty",true,"sum");
var i=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","relateQty",true,"sum");var g=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","basisCount",true,"sum");
var c=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","validCount",true,"sum");var f=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","sessionCount",true,"sum");
var e=$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("getCol","delFriendQty",true,"sum");$(WeiXinFriendQtyReport._CONS_.GRID).jqGrid("footerData","set",{"groupName":"总计：<span style='color:red;'>"+d+"</span>条","basisCount":"<span style='color:red;'>"+g+"</span>","friendQty":"<span style='color:red;'>"+h+"</span>","delFriendQty":"<span style='color:red;'>"+e+"</span>","relateQty":"<span style='color:red;'>"+i+"</span>","validCount":"<span style='color:red;'>"+c+"</span>","sessionCount":"<span style='color:red;'>"+f+"</span>"});
},onSortCol:function(d,e,c){a.sortColumn=d;a.sortorder=c;a.reloadJqgrid(a.toPostParam()+"&sortColumn="+a.sortColumn+"&sortorder="+a.sortorder);}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WeiXinFriendQtyReport._CONS_.GRID,a);
},toPostParam:function(){var a=this;var b=ReportDateUtil.getDateTimeRangeStr().split(",");var d="beginTime="+b[0]+"&endTime="+b[1]+"&radioValue="+$("input[type='radio']:checked").val()+"&groupKey="+$("input[name='belongOgn']").val()+"&nickNameRemark="+$("input[name='Q__S__LK__empwx.nick_name_remark_']").val();
var c=$("#channelQry option:selected").length;if($("select[name='belongEmployee']").val()){d+="&belongEmployee="+$("select[name='belongEmployee']").val();
}if(c!=0){d=a._buildChanelSearch(d,c);}return d;},_buildChanelSearch:function(d,c){var b=this;var e=new StringBuffer();var a=null;$("#channelQry option:selected").each(function(f){if($(this).val()==""){a="withOut";
}e.append($(this).val());if(f==c-1){return false;}else{e.append(",");}});d=d+"&channelId="+e.toString();if(a){d+="&withOut="+"withOut";}return d;},_channelSearch:function(){ChannelUtils.getOptions({container:"channelQry",caption:"",type:"noChannelId"});
}};