$(function(){var a=new WeiXinCsSleepReport();a.init();});function WeiXinCsSleepReport(){this.hadInit=false;}WeiXinCsSleepReport._CONS_={LIST_URL:ctx+"/crm/report/csSleepStatistic/weiXinListData.htm",GRID:"#weiXinCsSleepReportGrid",PAGER:"#weiXinCsSleepReportPager",EXPORT_URL:ctx+"/crm/report/csSleepStatistic/weiXinExportExcel.htm",DETAIL_URL:ctx+"/crm/report/csSleepStatistic/weiXinDetailData.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",};
WeiXinCsSleepReport.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid();this._buildEmployeeSelect();
}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString()).select2();
}}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WeiXinCsSleepReport._CONS_.GRID,a);},_bindEventHander:function(){var a=this;$("#weiXinCsSleepSearchForm").on("click",".weiXinCsSleepSearchBtn",function(){var b=a._handleParams();
a.reloadJqgrid(b);});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("#groupId").val(),container:"groupName",nolimit:true,positionType:"statistics,dept_manager",fn:function(c){$("#groupId").val(c);
FormUtils.loadData(WeiXinCsSleepReport._CONS_.EMPLOYEE_LIST_URL+"?groupId="+c+"&type=statistics,dept_manager",function(e){var f=new StringBuffer();f.append('<option value="">请选择</option>');
for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].id+"'>"+e[d].aid+":"+e[d].name+"</option>");}$("#belongEmployee").empty().append(f.toString());
});}};GroupUtils.selectGroupTreeBox(b);});$("#weiXinCsSleepSearchForm").on("click",".weiXinCsSleepExportExcel",function(){a._exportExcel();});$(document).on("click",".detail",function(){var d=$(this).attr("value");
var c=$(this).attr("valueAid");var f=$(this).attr("valueName");var e=$(".sleepCountDay").val();var b="/crm/report/weiXinReport/weiXinCsSleep/reportDetail.htm?employeeId="+d+"&sleepCountDay="+e+"&employeeName="+f+"&employeeAid="+c;
JTTabUtils.addOrRefreshTab(ctx+b,c+"沉睡客户");});$(document).on("click","#clearSearchBtn",function(){FormUtils.clear("weiXinCsSleepSearchForm");});},_initJqgrid:function(a){$(WeiXinCsSleepReport._CONS_.GRID).JTJqgrid({url:WeiXinCsSleepReport._CONS_.LIST_URL,pager:WeiXinCsSleepReport._CONS_.PAGER,postData:this._handleParams(a),multiselect:false,footerrow:true,colNames:["部门","员工","沉睡数量","沉睡数量","最长沉睡天数","最短沉睡天数"],colModel:[{name:"groupName",width:120},{name:"employeeName",width:120,formatter:function(b,c,d){if(d.employeeAid){return d.employeeAid+":"+d.employeeName;
}return d.employeeName;}},{name:"csCountHide",width:120,hidedlg:true,hidden:true,formatter:function(b,c,d){return d.csCount;}},{name:"csCount",width:120,formatter:function(b,c,d){if(d.groupName.indexOf("总计：")>-1){return"<span style='color:red;'>"+d.csCount+"</span>";
}else{return"<a href='#' class='detail' value='"+d.employeeId+"' valueAid='"+d.employeeAid+"' valueName='"+d.employeeName+"'><span style='color:red;'>"+d.csCount+"</span></a>";
}}},{name:"maxDays",width:120},{name:"minDays",width:120}],gridComplete:function(){var c=$(WeiXinCsSleepReport._CONS_.GRID).jqGrid("getCol","csCountHide",true,"sum");
var b=$(WeiXinCsSleepReport._CONS_.GRID).jqGrid("getGridParam","records");$(WeiXinCsSleepReport._CONS_.GRID).footerData("set",{"groupName":"总计：<span style='color:red;'>"+b+"</span>人","csCount":+c,});
}});},_handleParams:function(d){if(d==null||typeof d==undefined){d={};}d.reportType=reportType;var a=$("#groupId").val();if(a){d.groupId=a;}var c=$(".sleepCountDay").val();
if(c){d.sleepCountDay=c;}var b=$("#belongEmployeeSearch").val();if(b){d.belongEmployee=b;}return d;},_exportExcel:function(){var a=this._handleParams();
FormUtils.submit(WeiXinCsSleepReport._CONS_.EXPORT_URL,a,function(b){if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},};