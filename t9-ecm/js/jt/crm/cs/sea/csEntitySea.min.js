function CsEntitySea(a){this.isFormDataChange=false;this.titleCates=null;this.selectedJqgrid=new Array();this.addressServiceSearch=new AddressService("addrContainerSearch");
this.addressServiceSearch2=new AddressService("addrContainerSearch2");this.type=a.type;this.grid="#"+a.grid;this.pager="#"+a.pager;this.tabContainer="#"+a.tabContainer;
this.isInit=false;this.formFrontConfig=new FormConfig({"formId":"csEntitySearchForm",title:"公海客户查询配置",isHidden:true,forceParam:[],"endLess":[],modular:"csEntitySeaSearchList"});
}CsEntitySea._CONS_={LIST_DATA_URL:ctx+"/crm/cs/csEntity/listData.htm",ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",POINT_ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place/pointOrder.htm",ORDER_LIST_URL:ctx+"/ec/salesorder/soEntity/list.htm",ORG_LIST_URL:ctx+"/gl/ou/group/getOrganizations.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",IMPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/importExcel.htm",IMPORT_ORDER_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importOrderExcel.htm",EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/exportExcel.htm",SYNC_EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/syncExportExcel.htm",ORDER_AFTER_LIST_URL:ctx+"/ec/salesorder/soEntity/saleafter/list.htm",BATCH_DELETE_URL:ctx+"/crm/cs/csEntity/batchDeleteLogic.htm",CS_RETURN_BYIDS_URL:ctx+"/crm/cs/csEntitySea/csReturnByIds.htm",CS_CHANGE_GROUP_URL:ctx+"/crm/cs/csEntitySea/csSeaChangeGroup.htm",CLAIM_CS_SEA_URL:ctx+"/crm/cs/csEntitySea/claimCsSea.htm",};
CsEntitySea.prototype={init:function(){if(!this.isInit){this.isInit=true;this._bindEventHander();this._initJqgrid();this.addressServiceSearch.init({isSelect:"y",isNotRequired:true},function(){});
this._locateToGlHelp();this.formFrontConfig.init();}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.csEntity.sea");},_hideNotGrantBtn:function(){if(self.type=="self"){if(!ResUtils.canShow("csEntity.button.edit")){$(".csEntityEdit").hide();
}if(!ResUtils.canShow("csEntity.button.assignCs")){$(".csEntityEmployee").hide();}if(!ResUtils.canShow("csEntity.button.soAdd")){$(".csEntitySoAdd").hide();
}if(!ResUtils.canShow("csEntity.button.soPointAdd")){$(".csEntitySoPointAdd").hide();}if(!ResUtils.canShow("csEntity.button.batchSms")){$(".csEntityBatchSendSms").hide();
}if(!ResUtils.canShow("csEntity.button.batchUpdate")){$(".csEntityBatchUpdate").hide();}if(!ResUtils.canShow("csEntity.button.soList")){$(".csEntitySoList").hide();
}if(!ResUtils.canShow("csEntity.button.saleAfter")){$(".csEntitySoAfterList").hide();}if(!ResUtils.canShow("csEntity.button.exportExcel")){$(".toExportExcel").hide();
}if(!ResUtils.canShow("csEntity.button.importExcel")){$(".importExcel").hide();}if(!ResUtils.canShow("csEntity.button.genExcel")){$(".toGenExcel").hide();
}if(!ResUtils.canShow("csEntity.button.delete")){$(".batchDelete").hide();}if(!ResUtils.canShow("csEntitySea.button.csReturnsByIds")){$(".csReturnsByIds").hide();
}}else{if(self.type=="mysub"){if(!ResUtils.canShow("csEntity.button.editSub")){$(".csEntityEdit").hide();}if(!ResUtils.canShow("csEntity.button.assignCsSub")){$(".csEntityEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.soAddSub")){$(".csEntitySoAdd").hide();}if(!ResUtils.canShow("csEntity.button.soPointAddSub")){$(".csEntitySoPointAdd").hide();
}if(!ResUtils.canShow("csEntity.button.soListSub")){$(".csEntitySoList").hide();}if(!ResUtils.canShow("csEntity.button.batchSmsSub")){$(".csEntityBatchSendSms").hide();
}if(!ResUtils.canShow("csEntity.button.batchUpdateSub")){$(".csEntityBatchUpdate").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSub")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcelSub")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importExcelSub")){$(".importExcel").hide();
}if(!ResUtils.canShow("csEntity.button.genExcelSub")){$(".toGenExcel").hide();}if(!ResUtils.canShow("csEntity.button.deleteSub")){$(".batchDelete").hide();
}if(!ResUtils.canShow("csEntitySea.button.claimCsSea")){$(".claimCsSea").hide();}if(!ResUtils.canShow("csEntitySea.button.csSeaChangeGroup")){$(".csSeaChangeGroup").hide();
}}}},_bulidInterests:function(c,b){var a=this;var d=new StringBuffer();$("#interestSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;
}else{d.append(",");}});c=c+"&interests="+d.toString();return c;},_bindEventHander:function(){var a=this;$(a.tabContainer).on("click",".csEntitySearch",function(){var c=$(this).closest("form").serialize();
var b=$("#interestSearch option:selected").length;if(b!=0){c=a._bulidInterests(c,b);}a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$(".inPhone").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum=13533435687&inNum=18300123456","客户信息");
});$(a.tabContainer).on("click",".csEntityEmployee",function(){var c=$(this).attr("idVal");if(c){var b=new CsAssign([c],"csEntity");b.init();}else{c=$(a.grid).jqGrid("getGridParam","selarrrow");
if(c&&c.length){var b=new CsAssign(c,"csEntity");b.init();}else{DialogUtils.confirmWithOptions({title:"使用查询结果[不支持一键查询]进行分配,确定吗?",text:"",confirmButtonText:"确定",yesFunc:function(){var e=a._getSearchParam();
e.type=a.type;e["is_sea_"]="y";var d=$(a.grid).jqGrid("getGridParam","records");FormUtils.submit(ctx+"/crm/cs/csEntity/listCsIds.htm",e,function(g){var f=new CsAssign(g,"csEntity");
f.init();});},noFunc:function(){DialogUtils.error(msgCode.ERROR,"请选择要分配的客户");},});}}});$(a.tabContainer).on("click",".csEntityEdit",function(){var b=$(this).attr("idVal");
if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要更新的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时编辑多条记录");
return;}b=a.selectedJqgrid[0];}a._edit(b);});$(a.tabContainer).on("click",".csEntityEditTmp",function(){var b=$(this).attr("attr-id");a._edit(b);});$(a.tabContainer).on("click",".csEntitySoAdd",function(){var b=$(this);
ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placeGeneralOrderMethod(b,a);}else{if(h.msg!=null&&h.msg.trim()==""){a._placeGeneralOrderMethod(b,a);
return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var f=DateUtils.timeRangeJudge(c,d);if(!f){a._placeGeneralOrderMethod(b,a);}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});});$(a.tabContainer).on("click",".csEntitySoPointAdd",function(){var b=$(this);
ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placePointOrderMethod(b,a);}else{if(h.msg!=null&&h.msg.trim()==""){a._placeGeneralOrderMethod(b,a);
return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var f=DateUtils.timeRangeJudge(c,d);if(!f){a._placePointOrderMethod(b,a);}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});});$(a.tabContainer).on("click",".csEntitySoList",function(){var b=$(this).attr("idVal");
if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要查看客户的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多条记录");
return;}b=a.selectedJqgrid[0];}var c=$(a.grid).jqGrid("getRowData",b);var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntitySea._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+d+"]订单");
});$(a.tabContainer).on("click",".csEntitySoListTmp",function(){var b=$("#csEntityForm").find("[name=id]").val();var c=$("#csEntityForm").find("[name=name]").val();
if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(CsEntitySea._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+c+"]订单");});$(a.tabContainer).on("click",".csEntityBatchUpdate",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){a._csEntityBatchUpdate(b);}else{DialogUtils.confirmWithOptions({title:"确定批量修改当前全部查询结果？",text:"",confirmButtonText:"确定",yesFunc:function(){a._csEntityBatchUpdate(b);
}});}});$(a.tabContainer).on("click",".csEntitySoAfterList",function(){var b=$(this).attr("idVal");if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要退换货的客户");
return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多个客户");return;}b=a.selectedJqgrid[0];}var c=$(a.grid).jqGrid("getRowData",b);var d=c["name"];
if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntitySea._CONS_.ORDER_AFTER_LIST_URL+"?csId="+b,"客户["+d+"]退换货订单");
});$(a.tabContainer).on("keypress",function(b){if(b.keyCode=="13"){$(".csEntitySearch").eq(0).trigger("click");}});$("button.clearCsEntitySearchFormBtn").on("click",function(){FormUtils.clear("csEntitySearchForm");
});$(a.tabContainer).on("click",".newSearch",function(){var b="turnNew=y";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(a.tabContainer).on("click",".notFollowSearch",function(){var b=DateUtils.getBeforeDate(7);
var c="hightFollowTime="+b+"&includeNotFollow=true";a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$(a.tabContainer).on("click",".birthdaySearch",function(){var b="csCare=birthday";
a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(a.tabContainer).on("click",".buyWeekSearch",function(){var b="csCare=buyWeek";a.selectedJqgrid=new Array();
a.reloadJqgrid(b);});$(a.tabContainer).on("click",".buyMonthSearch",function(){var b="csCare=buyMonth";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});
$(a.tabContainer).on("click",".toDayRegisterPlace",function(){var b=new Date();var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";
c+="&toDayRegisterPlace=toDayRegisterPlace";a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$(document).on("click",".toDayRegister",function(){var b=new Date();
var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";a.selectedJqgrid=new Array();a.reloadJqgrid(c);
});$(a.tabContainer).on("click","#seniorSearch",function(){if($(this).text().indexOf("展开")!=-1){$(a.tabContainer).find("#seniorSearchDiv").slideDown("fast",function(){});
$(this).empty().append('收起<span class="fa fa-sort-up"></span>');if(a._getContainer("bizTypeSearch")){a._getContainer("bizTypeSearch").selectpicker("refresh");
}if(a._getContainer("eavSearch")){a._getContainer("eavSearch").selectpicker("refresh");}}else{$(this).empty().append('展开<span class="fa fa-sort-down"></span>');
$(a.tabContainer).find("#seniorSearchDiv").slideUp("fast");}});$(a.tabContainer).on("click","#seniorSearch2",function(){$(a.tabContainer).find("#seniorSearch").empty().append('展开<span class="fa fa-sort-down"></span>');
$(a.tabContainer).find("#seniorSearchDiv").slideUp("fast");});$(a.tabContainer).on("change",".numberInput",function(){if($(this).val()>=0){}else{$(this).val(0);
}});$(a.tabContainer).on("click",".toGenExcel",function(){excelUtil.toGenExcel("csEntity","生成客户excel模板","客户模板");});$(a.tabContainer).on("click",".importExcel",function(){var b={"importUrl":CsEntitySea._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入客户excel数据"};
excelUtil.importExcel(b);});$(a.tabContainer).on("click",".importOrderExcel",function(){var b={"importUrl":CsEntitySea._CONS_.IMPORT_ORDER_EXCEL_URL,"tabTitle":"导入订单excel数据"};
excelUtil.importExcel(b);});$(a.tabContainer).on("click",".toExportExcel",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");a._toExportExcel(b);
});$(a.tabContainer).on("click",".exportExcel",function(){a._exportExcel();});$(a.tabContainer).on("click","#allCheck",function(){var b=true;if(!$(this).is(":checked")){b=false;
}$("#columnContainer").find(".columnCheckBox").each(function(){$(this).prop("checked",b);});});$(a.tabContainer).on("click",".prevBtn",function(){a._toList();
});$(a.tabContainer).on("click",".batchDelete",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认要删除选中的客户资料吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchDelete(b);
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");}});$(a.tabContainer).on("click",".csEntityBatchSendSms",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){var d=new SendMessage();var c={csIds:b};d.openBatchSendMessageView(c);}else{DialogUtils.error(msgCode.ERROR,"请选择要发短信的客户");}});$(a.tabContainer).on("click",".csReturnsByIds",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,"请选择要归还的客户");return;}DialogUtils.confirmWithOptions({title:"确认要归还选中的客户吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._csReturnsByIds(b);
}});});$(a.tabContainer).on("click",".csSeaChangeGroup",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,"请选择要转移的客户");
return;}$("input[name=selectedIds]").val(b);$("#changeGroupModalContainer").modal("show");});$(a.tabContainer).on("click",".claimCsSea",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,"请选择要领取的客户");return;}DialogUtils.confirmWithOptions({title:"确认要领取选中的客户吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._claimCsSea(b);
}});});if(a.type=="mysub"){$("body").on("click","#csSeaChangeGroupSave",function(){var b=$("input[name=selectedIds]").val();var c=$("input[name=groupId]").val();
a._csSeaChangeGroup(b,c);});}},_csEntityBatchUpdate:function(c){var a=this;var e=a._getSearchParam();e.type=a.type;var d=0;if(c&&c.length>0){d=c.length;
e.ids=c;}else{d=$(a.grid).jqGrid("getGridParam","records");}var b=new CsEntityBatchUpdate();b.init({count:d,searchParam:e,isSea:true});},_csSeaChangeGroup:function(d,c){var a=this;
var b=CsEntitySea._CONS_.CS_CHANGE_GROUP_URL;FormUtils.submit(b,{"ids":d,"groupId":c},function(e){if(e.success){DialogUtils.success(msgCode.INFO,"客户转移成功");
$("#changeGroupModalContainer").modal("hide");$(a.tabContainer).find(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}});},_claimCsSea:function(c){var a=this;var b=CsEntitySea._CONS_.CLAIM_CS_SEA_URL;FormUtils.submit(b,{"ids":c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"客户领取成功");
$(a.tabContainer).find(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},reloadJqgrid:function(a){window.localStorage.setItem("csentity_need_clear_selectedJqgrid","true");
JTJqgridUtils.reloadJqgrid(this.grid,a);},_csReturnsByIds:function(c){var a=this;var b=CsEntitySea._CONS_.CS_RETURN_BYIDS_URL;FormUtils.submit(b,{"ids":c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
$(a.tabContainer).find(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_initJqgrid:function(){var a=this;var b=CsEntitySea._CONS_.LIST_DATA_URL+"?1=1&Q__S__EQ__entity.is_sea_=y";
b=b+"&type="+a.type;if("mysub"==a.type){b=b+"&isCsWaitSea=y";}var d=true;var c=$(window).width();$(a.grid).JTJqgrid({url:b,pager:a.pager,width:"100%",autowidth:true,colNames:["客户编号","姓名","姓名(隐藏)","性别","关怀","分类","成交","N次","消费(元)","意向","渠道","关联微信","地区","最新跟进","跟进标签","转单时间","最新签收","工号","部门","注册时间","操作"],colModel:[{name:"code",index:"entity.code_",width:100,formatter:function(e,f,g){if(g.footData){return g.code;
}else{var h=new StringBuffer();h.append("<div class='nameClass'><a class='csEntitySoAdd' idVal='"+g.id+"'>订</a>&nbsp;");if(g.turnNew=="y"){h.append("<span style='color:red'>新</span>");
}if(c<1024){h.append("<br>");}else{h.append("&nbsp;");}h.append(g.code);h.append("</div>");return h.toString();}}},{name:"nicName",index:"entity.nicName_",width:65,formatter:function(e,f,g){return"<a class='csEntityEditTmp' attr-id='"+g.id+"'>"+g.name+"</a>";
}},{name:"name",index:"entity.name_",hidden:true,},{name:"gender",index:"entity.gender_",width:35},{name:"care",index:"care",width:65,formatter:function(e,m,f){var h=new StringBuffer();
var k=new Date();var i=DateUtils.format(k,"yyyy-MM-dd")+" 00:00:00";var j=k.getFullYear()+"-"+f.birthday.substring(5,f.birthday.length)+" 00:00:00";var g=DateUtils.getDateDiff(i,j,"day");
if(g<=7&&g>=0){var l=ctx+"/img/jt/cake.png";h.append("<div style='background-image:url(/t9-ecm/img/jt/cake.png);width:20px; height:20px;float:left;'></div><i class='fa' style='margin-right:3px;'>["+g+"]</i>");
}if(f.lastCompleteTime){if(DateUtils.getDateDiff(f.lastCompleteTime,i,"day")>=7){h.append("<i class='fa' style='margin-right:3px;color:red;'>(7)</i>");
}if(DateUtils.getDateDiff(f.lastCompleteTime,i,"day")>=28){h.append("<i class='fa' style='margin-right:3px;color:red;'>(28)</i>");}}return h.toString();
}},{name:"bizType",index:"entity.biz_type_",width:70,sortable:true},{name:"hasDeal",index:"entity.so_total_",width:35,sortable:true,formatter:function(e,f,h){var g="<p style='color:red;'>√</p>";
if(h.soComplete&&h.soComplete>0){return g;}else{return"";}}},{name:"soComplete",index:"soComplete",width:35},{name:"soTotal",index:"entity.so_total_",width:70,formatter:function(e,f,g){return g.soTotal;
}},{name:"interests",index:"entity.interests_",width:80,sortable:true},{name:"srcNames",index:"entity.srcs_",width:80,sortable:true},{name:"relatedWeixin",index:"entity.related_weixin_",width:80,sortable:true,formatter:function(e,f,g){if(e=="y"){return"是";
}else{return"否";}}},{name:"prName",index:"entity.pr_name_",width:120,sortable:true,formatter:function(e,g,h){var i=new StringBuffer();if(h.prName){i.append(h.prName);
}if(h.ciName){i.append(",").append(h.ciName);}var f=i.toString();if(f){f=f.replace("省","");f=f.replace("市","");f=f.replace("自治区","");f=f.replace("自治州","");
}return f;}},{name:"lastFollowTime",index:"entity.last_follow_time_",width:82,formatter:function(e){var f=new StringBuffer();if(e&&0==DateUtils.getDateDiff(e,DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),"day")){f.append("<span style='color:red;'>√</span>");
}f.append(DateUtils.mini2Time(e));return f.toString();}},{name:"follow",index:"entity.follow_",width:140},{name:"turnTime",index:"entity.turn_time_",width:82,formatter:function(e){return DateUtils.mini2Time(e);
}},{name:"lastCompleteTime",index:"entity.last_complete_time_",width:82,formatter:function(e){return DateUtils.mini2Time(e);}},{name:"employeeName",index:"entity.employee_id_",width:100,hidden:d,formatter:function(e,f,g){if(g.employeeAid){return g.employeeAid+":"+g.employeeName;
}return g.employeeAid;}},{name:"groupName",index:"entity.group_Id_",width:70,hidden:d},{name:"createTime",index:"entity.create_time_",width:82,formatter:function(e){return DateUtils.mini2Time(e);
}},{name:"__manage",width:60,hidden:true,classes:"rowOps",sortable:false,align:"center",formatter:"manage",title:"操作",formatoptions:[]}],footerrow:true,userDataOnFooter:true,loadComplete:function(){if("true"==window.localStorage.getItem("csentity_need_clear_selectedJqgrid")){a.selectedJqgrid=new Array();
window.localStorage.removeItem("csentity_need_clear_selectedJqgrid");}for(var f=0;f<a.selectedJqgrid.length;f++){$(a.grid).jqGrid("setSelection",a.selectedJqgrid[f]);
}if($(a.grid).jqGrid("getGridParam","records")<1000){$("#endExportNum").val($(a.grid).jqGrid("getGridParam","records"));}else{$("#endExportNum").val(1000);
}a._hideNotGrantBtn();var e=$(a.grid).getGridParam("width");$(a.grid).setGridWidth(e);},gridComplete:function(){var e=$(a.grid).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
e.find('td[aria-describedby*="rn"],td[aria-describedby*="cb"],td[aria-describedby*="care"],td[aria-describedby*="srcNames"],td[aria-describedby*="relatedWeixin"],td[aria-describedby*="name"],td[aria-describedby*="gender"],td[aria-describedby*="bizType"],td[aria-describedby*="winePurpose"],td[aria-describedby*="taste"],td[aria-describedby*="hasDeal"],td[aria-describedby*="soRepeatBuy"],td[aria-describedby*="soTotal"],td[aria-describedby*="interests"],td[aria-describedby*="productName"],td[aria-describedby*="follow"],td[aria-describedby*="turnTime"],td[aria-describedby*="lastCompleteTime"],td[aria-describedby*="employeeName"],td[aria-describedby*="levelName"],td[aria-describedby*="lastFollowTime"],td[aria-describedby*="canPlaceSo"],td[aria-describedby*="soComplete"],td[aria-describedby*="jdPoint"],td[aria-describedby*="prName"],td[aria-describedby*="desc"],td[aria-describedby*="groupName"],td[aria-describedby*="createTime"]').hide();
e.find('td[aria-describedby*="csEntityGrid_code"]').show();},onSelectAll:function(g,e){if(g&&g.length>0){for(var f=0;f<g.length;f++){if(e){if(a.selectedJqgrid.indexOf(g[f])==-1){a.selectedJqgrid.push(g[f]);
}}else{a.selectedJqgrid.remove(g[f]);}}}},onSelectRow:function(f,e){if(e){if(a.selectedJqgrid.indexOf(f)==-1){a.selectedJqgrid.push(f);}}else{a.selectedJqgrid.remove(f);
}},ondblClickRow:function(e){if(e){a._edit(e);}}});},_edit:function(c){var a=this;var b="客户["+$(a.grid).jqGrid("getRowData",c).name+"]";if("self"==a.type){if(ResUtils.canShow("csEntity.button.edit")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+a.type+"&csId="+c,b);
}}else{if("mysub"==a.type){if(ResUtils.canShow("csEntity.button.editSub")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+a.type+"&csId="+c,b);
}}}},_toExportExcel:function(b){var a=this;$(".list_wrapper").hide();$(".form_wrapper").hide();$(".excel_wrapper").show();$(".prevBtn").show();$(".exportExcel").attr("disabled",false);
if(b&&b.length>0){$("#endExportNum").val(b.length);}var c=[];var d=LocalStorageUtils.get("CS_EXPORT_COLUMNS_"+currentUserId);if(d){c=d.split(",");}excelUtil.findExportColByModule("csEntity",true,function(f){var g=new StringBuffer();
if(f&&f.length>0){for(var e=0;e<f.length;e++){g.append("<div class='checkbox checkbox-success checkbox-inline'>");if($.inArray(f[e].devCode,c)!=-1){g.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}else{g.append("<input type='checkbox' class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}g.append("</div>");}}$("#columnContainer").empty().append(g.toString());});},_toList:function(){$(".list_wrapper").show();$(".form_wrapper").hide();$(".excel_wrapper").hide();
},_exportExcel:function(){var b=this;var d=$("#columnContainer").find(".columnCheckBox");var e=[];$(d).each(function(){if($(this).is(":checked")){e.push($(this).val());
}});var a=$("#beginExportNum").val();var c=$("#endExportNum").val();if(!a){DialogUtils.error(msgCode.ERROR,"请填写正确的开始记录");return;}if(!c){DialogUtils.error(msgCode.ERROR,"请填写正确的结束记录");
return;}if(parseInt(a)>parseInt(c)){DialogUtils.error(msgCode.ERROR,"开始记录不能大于结束记录");return;}if(parseInt(a)-parseInt($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records"))>0){DialogUtils.error(msgCode.ERROR,"开始记录不能大于记录总条数");
return;}if(!c){c=a;}DialogUtils.confirmWithOptions({title:"是否确认导出客户资料",text:"若已经导出过，请勿重复导出",confirmButtonText:"确认",yesFunc:function(){LocalStorageUtils.set("CS_EXPORT_COLUMNS_"+currentUserId,e.toString());
var f=$("#csEntitySearchForm").serialize();window.location.href=CsEntitySea._CONS_.EXPORT_EXCEL_URL+"?"+f+"&columns="+e.toString()+"&beginExportNum="+a+"&endExportNum="+c+"&type="+b.type+"&excelType="+$('input:radio[name="excelType"]:checked').val();
}});},_batchDelete:function(b){var a=CsEntitySea._CONS_.BATCH_DELETE_URL;FormUtils.submit(a,{"ids":b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"客户资料删除成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},_getSearchParam:function(){var f=$("#csEntitySearchForm").serialize();
var e={};f=decodeURIComponent(f,true);var a=f.split("&");if(a.length){for(var b=0;b<a.length;b++){var d=a[b].split("=");if(d.length==2){if(e.hasOwnProperty(d[0])){if(jQuery.type(e[d[0]])=="string"){var c=[];
c.push(e[d[0]]);d[1]=d[1].replaceAll("\\+"," ");c.push(d[1]);e[d[0]]=c;}else{if(jQuery.type(e[d[0]])=="array"){d[1]=d[1].replaceAll("\\+"," ");e[d[0]].push(d[1]);
}}}else{d[1]=d[1].replaceAll("\\+"," ");e[d[0]]=d[1];}}else{if(d.length>2){e[d[0]]=a[b].substring(a[b].indexOf("=")+1).replaceAll("\\+"," ");}}}}return e;
},_placeGeneralOrderMethod:function(e,b){var a=e.attr("idVal");if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");
return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");return;}a=b.selectedJqgrid[0];}var c=$(b.grid).jqGrid("getRowData",a);var d=c["name"];
if(d.length>5){d="*"+d.substring(d.length-5,d.length);}JTTabUtils.addOrRefreshTab(CsEntitySea._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=false&csId="+a+"&type="+b.type,"["+d+"]下订单");
},_getContainer:function(b){var a=this;var c=false;if(b){c=$("#"+b);if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");if(c.length==0){return false;
}}}}return c;},_placePointOrderMethod:function(e,b){var a=e.attr("idVal");if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");
return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");return;}a=b.selectedJqgrid[0];}var c=$(b.grid).jqGrid("getRowData",a);var d=c["name"];
if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntitySea._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=true&csId="+a+"&type="+b.type,"客户["+d+"]下积分订单");
},};