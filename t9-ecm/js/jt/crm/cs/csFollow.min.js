function CsFollow(){this.hadInit=false;this.needTable=true;this.fn=null;this.employeeId="";this.csType="";this.permissionType="";this.partyInfo=null;this.followType="";
this.contentExt="";this.isWeixin=false;}CsFollow._CONS_={EDIT_URL:ctx+"/crm/cs/csFollow/edit.htm",DELETE_URL:ctx+"/crm/cs/csFollow/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/csFollow/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csFollow/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/csFollow/findByCsId.htm",EDIT_FORM_ID:"csFollowForm"};
CsFollow.prototype={init:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindFormValidation();}if(b){this.needTable=b.needTable;
this.fn=b.fn;this.employeeId=b.employeeId;this.csType=b.csType;this.permissionType=b.permissionType;this.followType=b.followType;this.contentExt=b.contentExt;
this._initInputAndOption(b);if(b.isWeixin){this.isWeixin=b.isWeixin;}if(b.shipQry){this.entityId=b.entityId;this.soNo=b.soNo;this.csPhone=b.csPhone;this._addFollowBtn();
}}if(this.needTable){this._initTable();}this.partyInfo=a;},clear:function(c){var a=this;b();function b(){var d=$("#csFollowForm");d.find('input[name="hasTask"]').val(["n"]).trigger("change");
d.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");var e=document.querySelector(".js-switch");
var f=new Switchery(e,{className:"switchery switchery-small"});d.find("[name=csFollowId]").val("");d.find("#followType option:first").prop("selected","selected");
d.find("#satisfy option:first").prop("selected","selected");d.find("[name=content]").val("");d.find("#taskTimeDiv").hide();d.find("#followEmployeeDiv").hide();
d.find("input[name=taskTime]").val("").removeClass("validate_input_error");d.find("input[name=partyShow]").val("").removeClass("validate_input_error");
d.find("input[name=partyId]").val("");d.find("input[name=employeeAid]").val("");}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_save:function(){var h=this;var d=$("#csFollowForm");var a=d.find("[name=csFollowId]").val();var g=a?CsFollow._CONS_.SAVE_EDIT_URL:CsFollow._CONS_.SAVE_ADD_URL;
var f=new StringBuffer();var i=d.find("[name=type]").val();if(!$("#csFollowForm").valid()){return;}if("so"==this.followType){type="订单跟进";}var e=d.find("[name=content]").val();
e=e.replace("&","");d.find("[name=content]").val(e);var c="";if(this.contentExt){c=i+"："+this.contentExt+e;}else{c=i+"："+e;}var b={id:a,type:d.find("[name=type]").val(),content:encodeURI(d.find("[name=content]").val()),smsContent:encodeURI(d.find("[name=smsContent]").val()),contentExt:encodeURI(c),hasTask:d.find('input[name="hasTask"]').val(),satisfy:d.find("[name=satisfy]").val(),csId:d.find("input[name='csId']").val(),csCode:d.find("input[name='csCode']").val(),createAid:currentUserAid,entityId:$("#soEntityForm").find('input[name="id"]').val()||$("#csEntityForm").find('input[name="id"]').val()||this.entityId,seconds:d.find("[name=seconds]").val(),soNo:$("[name=soNo]").val()||this.soNo,isSms:$("[name=isSms]").val(),};
if(d.find("input[name=partyId]").val()&&d.find('input[name="hasTask"]').val()=="y"){b.taskTime=d.find("[name=taskTime]").val();b.partyId=d.find("input[name=partyId]").val();
b.employeeAid=d.find("input[name=employeeAid]").val();b.csPhone=d.find("input[name='csFollowPhone']").val()||$("#soEntityForm").find(".addrMobile").val()||this.csPhone;
b.status="new";}else{b.partyId=currentUserId;b.employeeAid=currentUserAid;b.status="done";}if(b.isSms=="y"){if(b.csPhone==""){DialogUtils.error(msgCode.FAIL_MSG,"该客户无手机号码，不能发送短信!");
return;}}FormUtils.submit(g,b,function(j){if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}if(h.needTable){h._initTable();}if(h.fn&&(typeof h.fn=="function")){b.content=d.find("[name=content]").val();h.fn(b);}layer.close(h.layerIndex);h.clear();
if(h.isWeixin){$("#reload-follow").trigger("click");}}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindEventHander:function(){var a=this;var b=$("#csFollowForm");$("#followRecordTab").on("click",".deleteCsFollow",function(){var c={csId:$(this).attr("csIdVal"),id:$(this).attr("idVal")};
DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/cs/csFollow/delete.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
a._initTable();}});});});b.on("change","input[name='hasTask']",function(){if($(this).val()=="y"){b.find("#taskTimeDiv").hide();b.find("#followEmployeeDiv").hide();
b.find("#smsContentDiv").hide();b.find("input[name=partyShow]").removeClass("validate_input_error");b.find("input[name=taskTime]").removeClass("validate_input_error");
$(this).val("n");$("#isSmsDivContainer").hide();$("input[name='isSms']").val("n");b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");
var d=document.querySelector(".js-switch2");var f=new Switchery(d,{className:"switchery switchery-small"});layer.style(a.layerIndex,{height:"250px"});}else{b.find("#taskTimeDiv").show();
b.find("#followEmployeeDiv").show();var c=$(".followCount").height();layer.style(a.layerIndex,{height:"310px"});$(this).val("y");if(a.partyInfo){b.find("input[name=partyId]").val(a.partyInfo.partyId);
b.find("input[name=employeeAid]").val(a.partyInfo.partyAid);b.find("input[name=partyShow]").val(a.partyInfo.partyAid+":"+a.partyInfo.partyName);}else{b.find("input[name=partyId]").val(currentUserId);
b.find("input[name=employeeAid]").val(currentUserAid);b.find("input[name=partyShow]").val(currentUserAid+":"+currentUserName);}var e=new Date();now=e.current();
b.find("input[name=taskTime]").val(now.substr(0,16));$("#isSmsDivContainer").show();}});b.on("change","input[name='isSms']",function(){if($(this).val()=="y"){$(this).val("n");
b.find("#smsContentDiv").hide();layer.style(a.layerIndex,{height:"310px"});}else{$(this).val("y");b.find("#smsContentDiv").show();var c=$(".followCount").height();
layer.style(a.layerIndex,{height:"400px"});}});b.on("click",".selectEmployee",function(){$("input[name=partyShow]").removeClass("validate_input_error");
var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=partyShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=partyId]").val(f[0].id);b.find("input[name=employeeAid]").val(f[0].aid);}}};var d=new EmployeesSelect();d.init(e);});$(document).on("click","#followTaskTime",function(){b.find("input[name=taskTime]").removeClass("validate_input_error");
});$(document).on("click",".appendFollow",function(){$(this).hide();$("#csFollowFormDiv").show();});$('select[name="suffix"]').on("change",function(){a._initTable();
});$(document).on("click",".saveAddFollow",function(){if(a.valid()){a._save();}});$(document).on("click","#addFollowBtn",function(){a._addFollowBtn();});
},_addFollowBtn:function(){var a=this;var b="form-config-layer";ButtonUtils.disableBtn("addFollowBtn");layer.close(a.layerIndex);a.layerIndex=layer.open({type:1,skin:"followCount",title:"跟进记录",shade:false,btn:["保存","取消"],area:["650px","auto"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,skin:b,success:function(c,d){ButtonUtils.enableBtn("addFollowBtn");
},yes:function(d,c){if(a.valid()){a._save();}},btn2:function(){a.clear();}});},_initTable:function(){var a=this;if(!a._hasPermission()){return;}var b=CsFollow._CONS_.LIST_DATA_URL+"?csId="+csId+"&suffix="+$("select[name='suffix']").val();
var d="";if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){d="<th width='7%'>操作</th>";
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){d="<th width='7%'>操作</th>";
}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){d="<th width='7%'>操作</th>";}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){d="<th width='7%'>操作</th>";
}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){d="<th width='7%'>操作</th>";}}}}}}$("#csFollowDiv").empty().append("<table class='table table-striped table-bordered' id='csFollowTable'>            <thead>                <tr>                    <th width='3%'></th>                    <th width='15%'>主题</th>                    <th width='35%'>待办内容</th>                    <th width='10%'>安排人</th>                    <th width='10%' >跟进人</th>                    <th width='10%'>记录时间</th>                    <th width='10%'>跟进时间</th>                    "+d+"                </tr>            </thead>        </table>");
var c=[{data:"lineNum",width:"3%"},{data:"type",},{data:"content",render:function(g,f,e){if(ResUtils.canShow("csEntity.button.viewFollowPhone")){return e.content;
}else{return MaskPhoneNum.maskDesc(e.content);}}},{data:"createName",render:function(g,f,e){if(e.createName.indexOf("null")>-1){return"[已删除]";}else{return e.createName;
}}},{data:"partyName",render:function(g,f,e){if(e.partyName.indexOf("null")>-1){return"[已删除]";}else{return e.partyName;}}},{data:"createTime",render:function(g,f,e){if(e.createTime){return DateUtils.miniTime(e.createTime);
}else{return"";}}},{data:"taskTime",render:function(g,f,e){if(e.taskTime){return DateUtils.miniTime(e.taskTime);}else{return"";}}},];if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<button class='btn btn-danger btn-sm btn-outline deleteCsFollow' csIdVal='"+e.csId+"' idVal='"+g+"' type='button' title='删除'><i class='fa fa-remove'></i></button>";
}});}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}}}}}$("#csFollowTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:true,ordering:true,order:[[5,"desc"]]});
},valid:function(){var a=true;var b=$("#csFollowForm");if(!b.valid()){a=false;}var c=b.find("[name = hasTask]:checkbox").val();if(c=="y"){if(!b.find("input[name=partyShow]").val()){b.find("input[name=partyShow]").addClass("validate_input_error");
a=false;}if(!b.find("input[name=taskTime]").val()){b.find("input[name=taskTime]").addClass("validate_input_error");a=false;}}return a;},_enableInput:function(){var b=$("#csFollowForm");
b.find("#followType").attr("disabled",false);b.find("#followContent").attr("readonly",false);b.find("[name=hasTask]").attr("disabled",false);b.find("#followTaskTime").attr("disabled",false);
b.find("#satisfy").attr("disabled",false);b.find("#seconds").attr("disabled",false);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});b.find(".selectEmployee").show();$(".appendFollow").show();
$("#csFollowFormDiv").hide();},_initInputAndOption:function(f){var b=$("#csFollowForm");b.find("input[name=csId]").val(f.csId);b.find("input[name=csCode]").val(f.csCode);
b.find("input[name=contentExt]").val(f.contentExt);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});if("so"==this.followType){b.find("#followType").empty().append("<option value='订单跟进'>订单跟进</option>");
if(ResUtils.canShow("soEntity.button.addFollowBtn")){$(".addFollow").show();}else{$(".addFollow").hide();}}else{CateUtils.getOptions({typeKey:"system",pKey:"CsFollowType",container:"followType",fn:function(h){var j=new StringBuffer();
if(h&&h.length>0){for(var g=0;g<h.length;g++){j.append("<option value='"+h[g].value+"'>"+h[g].name+"</option>");}}b.find("#followType").append(j.toString());
}});if(this.csType){$(".addFollow").show();if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtn")){$(".addFollow").hide();
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtnSub")){$(".addFollow").hide();
}}else{if("task"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnTask")){$(".addFollow").hide();}}else{if("callRecord"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnCallRecord")){$(".addFollow").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addFollowBtnSearch")){$(".addFollow").hide();}}}}}if(f.fn&&typeof f.fn=="function"){f.fn();}}}},_bindFormValidation:function(){var a={rules:{"content":{required:true,maxlength:1023},"seconds":{required:true,min:0},}};
FormUtils.bindFormValidation("csFollowForm",a);},_initFollowEmp:function(){var a=$("#csFollowForm");a.find("[name=content]").attr("disabled",false);a.find("input[name=partyShow]").val(currentUserAid+"："+currentUserName);
a.find("input[name=partyId]").val(currentUserId);a.find("input[name=employeeAid]").val(currentUserAid);},_prodSearch:function(a){$("#partyShow").bsSuggest("destroy");
if(a==null||a==""){return;}var b=this;$("#searchProd").bsSuggest({url:ctx+"/crm/ou/employee/selectEmployee.htm",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"姓名"},showBtn:false,idField:"id",keyField:"name",autoSelect:false,getDataMethod:"url",listStyle:{"padding-top":0,"max-height":"500px","max-width":width,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(d,c){b.searchProds=c.value;
}).on("onSetSelectValue",function(f,c){for(var d=0;d<b.searchProds.length;d++){if(b.searchProds[d].skuId==c.id){b.currentProd=b.searchProds[d];break;}}$("#searchProd").val("");
}).on("onUnsetSelectValue",function(c){b.searchProds=[];b.currentProd={};});},_initEmployeeSuggest:function(){var a=this;$("input[name='partyShow']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?grantType=/cs/&keyword=",effectiveFields:["aid"],searchFields:["aid"],effectiveFieldsAlias:{aid:"工号"},showBtn:false,idField:"id",keyField:"aid",getDataMethod:"url",processData:function(b){var e={value:[]};
if(b&&b.value){for(var d=0;d<b.value.length;d++){var c=b.value[d];e.value.push({id:c.id,aid:c.aid+"："+c.name});}}return e;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onSetSelectValue",function(d,b){var c=$("#csFollowForm");
c.find("input[name=partyId]").val(b.id);c.find("input[name=employeeAid]").val(b.aid);});},_hasPermission:function(){var a=true;if("self"==type||(this.permissionType&&"self"==this.permissionType)){}else{if("mysub"==type||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.viewFollowSub")){a=false;
}}else{if("task"==type){if(!ResUtils.canShow("csEntity.button.viewFollowTask")){a=false;}}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.viewFollowCallRecord")){a=false;
}}else{if(!ResUtils.canShow("csEntity.button.viewFollowSearch")){a=false;}}}}}return a;}};