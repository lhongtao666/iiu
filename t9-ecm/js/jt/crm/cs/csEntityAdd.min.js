$(function(){var a=new CsEntityAdd();a.init();});function CsEntityAdd(){this.csPhone=new CsPhone();}CsEntityAdd._CONS_={SAVE_ADD_URL:ctx+"/crm/cs/csEntity/saveAdd.htm",ADDR_LIST_URL:ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm"};
CsEntityAdd.prototype={init:function(b){this._initPhone();this._initTabName();this._initAddr();this._initEmployee();CsEntityUtils.init();this._prodSearch();
this._hideNotGrantedBtn();this._bindEventHandler();this._bindFormValidation();this._csMessageIshide();this.initIpAddr("ChinaCityCateType-root","csProvince");
var a=$("[name=type]").val();if(a&&1==a){$(".redTip").hide();}},_hideNotGrantedBtn:function(){if(type=="self"){if(!ResUtils.canShow("csEntity.button.changeEmployeeForAdd")){$("button.changRelEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.csDesc")){$("textarea[name=desc]").attr("disabled",true);}else{$("textarea[name=desc]").attr("disabled",false);}}else{if(type=="mysub"){if(!ResUtils.canShow("csEntity.button.changeEmployeeForAddSub")){$("button.changRelEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.csDescSub")){$("textarea[name=desc]").attr("disabled",true);}else{$("textarea[name=desc]").attr("disabled",false);
}}else{if(type=="search"){if(!ResUtils.canShow("csEntity.button.changeEmployeeForAddSearch")){$("button.changRelEmployee").hide();}}}}},_bindEventHandler:function(){var a=this;
$(".saveBtn").on("click",function(){ConfigUtils.findByKey("csEntity.isChannel",function(c){if(c.success){var b=$("#srcs").val();if(b&&b!=""){a._validBizType();
}else{DialogUtils.error(msgCode.ERROR,"请填写渠道来源");return;}}else{a._validBizType();}});});$(".saveBtnContinue").on("click",function(){ConfigUtils.findByKey("csEntity.isChannel",function(c){if(c.success){var b=$("#srcs").val();
if(b&&b!=""){a._validBizType(true);}else{DialogUtils.error(msgCode.ERROR,"请填写渠道来源");return;}}else{a._validBizType(true);}});});$(document).on("click",".changRelEmployee",function(){a._changeEmployee();
});$(document).on("blur","#maskPhoneNum",function(){if(!csPhone){var c=$(this).val();var d=$("select[name=phoneType]").val();$("[name=phoneNum]").val(c);
$("#phoneTip").hide();if(c){if(a.csPhone._checkIsPhone(c,d)){a.csPhone.findCsByPhone(c,function(e){if(e&&e.success){var g=new StringBuffer;var f=JSON.parse(e.msg);
g.append("号码重复，客户["+'<a id="csEntity" csId="'+f.id+'">'+f.code+"</a> :"+f.name+"]已拥有该号码！");$("#phoneTip").empty().append(g.toString());$("#phoneTip").css("color","red").show();
}else{a.csPhone._getPhoneArea(c,function(h){a._initAddr("ChinaCityCateType-root",h.provinceCateKey,h.cityCateKey);});}});}else{if(d=="座机"){if(!a.csPhone._checkIsTel(c)){var b="座机号格式错误";
$("#phoneTip").css("color","red").text(b).show();}else{a.csPhone.findCsByPhone(c,function(e){if(e&&e.success){var g=new StringBuffer;var f=JSON.parse(e.msg);
g.append("号码重复，客户["+'<a id="csEntity" csId="'+f.id+'">'+f.code+"</a> :"+f.name+"]已拥有该号码！");$("#phoneTip").empty().append(g.toString());$("#phoneTip").css("color","red").show();
}});}}else{$("#phoneTip").css("color","red").text("非手机类型请选座机").show();}}}}});$(document).on("change","[name=phoneType]",function(){$("#maskPhoneNum").trigger("blur");
});$(document).on("change","#employeeWeixin",function(){a._getChannelByWeixin();});$(document).on("change","",function(){});$("body").on("click","input[name='passTime']",function(){console.log(DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"));
laydate({istime:true,format:"YYYY-MM-DD hh:mm:ss",max:DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),choose:function(b){a._getChannelByWeixin();}});
});$(document).on("click","#csEntity",function(){var c=$(this).parent("span").text();var b=$(this).attr("csId");if(c.length>4){c="*"+c.substring(c.length-3,c.length);
}JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.DETAIL_CS_PAGE_URL+"?csId="+b,"客户["+c+"]明细");});$(document).on("click",".makePhone",function(){$(".makePhone").attr("disabled","disabled");
$(".makePhoneAddZero").attr("disabled","disabled");if(csPhone&&csPhone.startsWith("020")){csPhone=csPhone.substring(3);}window.top.jtCtiService.dialout("9"+csPhone);
setTimeout(function(){$(".makePhone").removeAttr("disabled");$(".makePhoneAddZero").removeAttr("disabled");},5000);});$(document).on("click",".makePhoneAddZero",function(){$(".makePhone").attr("disabled","disabled");
$(".makePhoneAddZero").attr("disabled","disabled");var b=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;if(csPhone&&csPhone.startsWith("020")){csPhone=csPhone.substring(3);
}if(b.test(csPhone)){window.top.jtCtiService.dialout("90"+csPhone);}else{window.top.jtCtiService.dialout("9"+csPhone);}setTimeout(function(){$(".makePhone").removeAttr("disabled");
$(".makePhoneAddZero").removeAttr("disabled");},5000);});$(document).on("change","select[name=province_],select[name=city_],select[name=area_],select[name=town_]",function(){var b="-"+$("select[name=province_] option:selected").text();
if($("select[name=city_]").val()){b+="-"+$("select[name=city_] option:selected").text();}if($("select[name=area_]").val()){b+="-"+$("select[name=area_] option:selected").text();
}if($("select[name=town_]").val()){b+="-"+$("select[name=town_] option:selected").text();}$(".addrDetaileDescribe").text(b);});$(document).on("change","select[name=csProvince]",function(){$("#ipLocations").val("");
var b=$("select[name=csProvince] option:selected").text();$("#ipLocations").val(b);$("select[name=csCity]").remove();a.initIpAddr($("select[name=csProvince]").val(),"csCity");
});$(document).on("change","select[name=csCity]",function(){$("#ipLocations").val("");var b=$("select[name=csProvince] option:selected").text();if($("select[name=csCity]").val()){b+=$("select[name=csCity] option:selected").text();
}$("#ipLocations").val(b);});},_getChannelByWeixin:function(){var b=$("#employeeWeixin").val();var a=$("input[name='passTime']").val();if(b==null||b==""){return;
}$("#srcs").val("");FormUtils.loadData(ctx+"/ec/media/mediaChannel/findByEmployeeWeixin.htm"+"?employeeWeixin="+b+"&passTime="+a,function(c){if(c){$("#srcs").val(c.id);
}});},initIpAddr:function(b,c){var a=CsEntityAdd._CONS_.ADDR_LIST_URL+"?cateType=AddressCateType&parentKey="+b;FormUtils.loadData(a,function(f){if(f.success){if(f.msg!=null&&f.msg!=""){var g=new StringBuffer();
var e=JSON.parse(f.msg);if(e&&e.length>0){g.append("<select class='col-sm-5' style='margin-right:10px;' name='"+c+"'>");g.append("<option value=''>请选择</option>");
for(var d=0;d<e.length;d++){g.append("<option idValue='"+e[d].id+"' value='"+e[d].value+"'>"+e[d].name+"</option>");}$("#addrIpContainer").append(g.toString());
}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_initProdSearch:function(){var c="entity";var f="n";var e="common";var d="n";var a="";
var b=ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+f+"&storeId="+a+"&priceType="+e+"&limitProdCate="+d+"&keyword=";FormUtils.loadData(b,function(j){if(j){var k="";
var l=new StringBuffer();var h=j.value;for(var g=0;g<h.length;g++){l.append("<option value="+h[g].prodName);l.append(">");l.append(h[g].prodName);l.append("</option>");
}$("#searchProducts").empty().append(l.toString());}});},_prodSearch:function(a){$("#searchProd").bsSuggest("destroy");var b=this;var e=$("#searchProd").width()+"px";
var c="entity";var f="n";var d="n";$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+f+"&storeId="+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(g){b.searchProds=g.value;
return g;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(h,g){b.searchProds=g.value;
}).on("onSetSelectValue",function(j,g){for(var h=0;h<b.searchProds.length;h++){if(b.searchProds[h].skuId==g.id){b.currentProd=b.searchProds[h];break;}}$("#searchProd").val(b.currentProd.prodName);
}).on("onUnsetSelectValue",function(g){b.currentProd={};});},_changeEmployee:function(){var a=0;if(ResUtils.canShow("employeeSelector.button.cs")){a:1;
}var c={isShowAllGroup:a,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,callBack:function(d){if(d!=null){if(d.length>0){$("input[name=employeeId]").val(d[0].id);
$("input[name=employeeShow]").val(d[0].aid+"："+d[0].name);}}}};var b=new EmployeesSelect();b.init(c);},_initAddr:function(c,a,b){this.addressService=new AddressService("addressContainer");
this.addressService.init({country:c,province:a?a:"",city:b?b:"",area:"",isNotRequired:true});},_initEmployee:function(){$("input[name=employeeShow]").val(currentUserAid+"："+currentUserName);
$("input[name=employeeId]").val(currentUserId);$("input[name=createByInfo]").val(currentUserAid+"："+currentUserName);},_validBizType:function(b){var a=this;
ConfigUtils.findByKey("csEntity.isBizType",function(d){if(d.success){var c=$("#bizType").val();if(c&&c!=""){a._saveAdd(b);}else{DialogUtils.error(msgCode.ERROR,"请填写客户分类");
return;}}else{a._saveAdd(b);}});},_saveAdd:function(c){var b=this;var a=CsEntityAdd._CONS_.SAVE_ADD_URL;b._validPhone(function(){if($("#csEntityFormForAdd").valid()){ButtonUtils.disableBtn("saveBtn");
var e=$("#csEntityFormForAdd").serialize();var d=($("[name=interests]").val()&&$("[name=interests]").val().length>0)?$("[name=interests]").val().join(","):"";
e.interests=d;FormUtils.submit(a,e,function(h){if(h.success){b._refreshDefault();CsEntityUtils.refreshListTab();var f=$("[name=type]").val();var i=$('input[name="name"]').val()||"新客户";
if(c){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/add.htm?type="+type+"&csType="+f);}else{var i=$("#csEntityFormForAdd").find('input[name="name"]').val();
i="客户["+i+"]";JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?csId="+h.msg+"&type="+type,i);JTTabUtils.closeTab("/t9-ecm/crm/cs/csEntity/add.htm?type="+type+"&csType="+f);
if(csPhone){var g="/t9-ecm/crm/cs/csEntity/in.htm?phoneNum="+csPhone+"&inType=csEntityAdd&inNum="+inNum;JTTabUtils.closeTab(g);}}DialogUtils.success("提示","添加成功");
}else{DialogUtils.error("失败",h.msg);}ButtonUtils.enableBtn("saveBtn");},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error("错误","后台异常，请稍后重试");
});}});},_validPhone:function(e){var b=$("[name=type]").val();if(b&&1==b){e();return;}var c=$("[name=phoneNum]").val();var d=$("[name=phoneType]").val();
if(c){if(!this.csPhone._checkIsPhone(c,d)){if(d=="座机"){if(!this.csPhone._checkIsTel(c,d)){var a="座机号格式错误";DialogUtils.error("提示",a);return;}}else{DialogUtils.error("提示","非手机类型请选座机");
return;}}this.csPhone.findCsByPhone(c,function(f){if(f&&f.success){DialogUtils.error("提示","号码重复");}else{e();}});}else{DialogUtils.error("提示","请输入客户手机号码");
}},_isValid:function(){var a=true;return a;},_initPhone:function(){if(csPhone){$("#csEntityFormForAdd").find('input[name="phoneNum"]').val(csPhone);$("#csEntityFormForAdd").find("#maskPhoneNum").val(CsEntityUtils.maskPhoneNum(csPhone)).attr("readonly",true);
this._getChannel(function(a){CsEntityUtils._initChannelSelect(a.channel);CsEntityUtils._initInterestsSelect(a.interest);});$(".makePhoneDiv").show();}},_getChannel:function(b){var a=this;
FormUtils.loadData(ctx+"/ec/media/mediaChannel/findByPhone.htm?outPhone="+outNum+"&inPhone="+inNum,function(c){var d={};if(c&&c.length>0&&c[0].id){d.channel=c[0].id;
d.interest=c[0].interst;}if(b&&typeof b==="function"){b(d);}});},_bindFormValidation:function(){var a={rules:{email:{email:true}},messages:{}};FormUtils.bindFormValidation("csEntityFormForAdd",a);
},_refreshDefault:function(){var a=$("#csEntityFormForAdd").find("[name=srcs]").val();var b=$("#csEntityFormForAdd").find("[name=interests]").val();window.localStorage.setItem("CREATE_CS_SRC_"+currentUserId,a);
window.localStorage.setItem("CREATE_CS_INTEREST_"+currentUserId,b);},_initTabName:function(){if(!csPhone){var b="新增客户";var a=$("[name=type]").val();if(a&&1==a){b="新增微信客户";
}JTTabUtils.renameForActiveTab(b);}else{JTTabUtils.renameForActiveTab("新客户来电：["+$("#maskPhoneNum").val()+"]");}},_csMessageIshide:function(){ConfigUtils.findByKey("csEntity.limit.wineIndustry",function(a){if(a.msg=="y"){$(".heightWeightDiv").hide();
$(".wineIndustry").show();}else{$(".heightWeightDiv").show();$(".wineIndustry").hide();}});}};