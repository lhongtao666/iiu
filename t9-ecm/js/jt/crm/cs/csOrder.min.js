function CsOrder(){this.hadInit=false;this.params=null;this.permissionType=null;}CsOrder._CONS_={SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",PLACE_PAGE_URL:ctx+"/ec/salesorder/soEntity/place.htm",COMFIRM_PAGE_URL:ctx+"/ec/salesorder/soEntity/comfirm/comfirm.htm",FOLLOW_PAGE:ctx+"/ec/salesorder/soEntity/toFollow.htm",MERGE_SO_URL:ctx+"/ec/salesorder/soEntity/mergeSo.htm",};
CsOrder.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this.params=a;this.permissionType=a.permissionType;}this._initTable(a);
},_bindEventHander:function(){var a=this;$("body").on("click",".soTab",function(){var f=$(this).attr("attr-csId");if(f){return false;}var g=$(this).attr("attr-id");
var i=$("#csEntityForm").find("[name=name]").val();var e=$(this).attr("value");var d=$(this).attr("attr-placerId");var b=$(this).attr("attr-status");var h=$(this).attr("attr-soType");
var c=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";if("awaiting_post"==b&&d==currentUserId){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.PLACE_PAGE_URL+"?soId="+g,"订单["+e+"]提交");
}else{if("awaiting_comfirm"==b&&ResUtils.canShow("soEntityComfirm.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)&&ResUtils.canShow("soEntity.button.comfirm")){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.COMFIRM_PAGE_URL+"?soId="+g,"订单["+e+"审核");
}else{if("shipping"==b&&ResUtils.canShow("soEntity.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.FOLLOW_PAGE+"?soId="+g+"&soNo="+e,"订单["+e+"]跟进");
}else{JTTabUtils.addOrRefreshTab(CsOrder._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+e+"&canShowScTrankNo="+c,i+"的订单明细");}}}});$("body").on("click",".mergeSo",function(){var e=$(".checkchild:checked");
var b=[];for(var f=0;f<e.length;f++){var d={soNo:$(e[f]).val(),soId:$(e[f]).attr("so-id"),status:$(e[f]).attr("status")};b.push(d);}if(b.length<2){DialogUtils.error(msgCode.FAIL_MSG,"选中的订单必须大于等于2");
return false;}var c=b[0].status;for(var f=1;f<b.length;f++){if(c!=b[f].status){DialogUtils.error(msgCode.FAIL_MSG,"必须是相同状态的订单才能合并");return false;}}a._showMergeSo(b);
});$(document).on("click",".edit_items",function(){var d=window.localStorage.getItem("csOrderTableConfigItems");function c(i){if(!i){return false;}var h=i;
if(typeof i!="object"){h=JSON.parse(i);}var j="";var g=true;$.each(h,function(k,l){if(this.id!="thAll"){j+='<div class="col-sm-3">'+'<div class="checkbox checkbox-success checkbox-inline checkboxDiv">'+'<input type="checkbox" class="columnCheckBox" name="listTitleCheck" data-id="'+this.id+'" '+(this.isShow?'checked="checked"':"")+">"+'<label for="648c21b860f84870822946ac25f06f08">'+this.name+"</label>"+"</div>"+"</div>";
if(!this.isShow&&g){g=false;}}});j='<div class="col-sm-3"><div class="checkbox checkbox-success checkbox-inline checkboxDiv"><input type="checkbox" class="columnCheckBox" data-id="thAll" name="allCheck" data-column="-1" '+(g?'checked="checked"':"")+'><label for="allCheck">全选</label></div></div>'+j;
$("#layListTitle").empty().append(j);}var b=$("#csOrderTable");var f=[];$("#csOrderTable thead tr th").each(function(g,h){if(g!=0&&$(this).text()){f.push({id:$(this).attr("id"),index:g,name:$(this).text(),isShow:true});
}});function e(h,g){$.each(h,function(j,l){var k=this;$.each(g,function(m,n){if(this.name==k.name){k.isShow=this.isShow;return false;}});});}if(typeof d=="string"){e(f,JSON.parse(d));
c(f);}else{c(f);}a.layerIndex=layer.open({type:1,title:"编辑表头",shade:false,btn:["确定","关闭"],area:["51%","53%"],content:$(".listTitleEditDiv"),scrollbar:false,success:function(g,h){},yes:function(i,h){var g=$("#csOrderTable");
var j=[];$("#layListTitle input[type=checkbox]").each(function(m,n){var l={id:$(this).attr("data-id"),name:$(this).next("label").text(),isShow:$(this).prop("checked")};
j.push(l);if(!$(this).prop("checked")){var k=-1;$("#"+l.id).parent().children().each(function(o,p){if($(this).attr("id")==l.id){k=o;$(this).hide();g.find("tbody tr").each(function(q,r){$(this).children().eq(k).hide();
});return false;}});}else{var k=-1;$("#"+l.id).parent().children().each(function(o,p){if($(this).attr("id")==l.id){k=o;$(this).show();g.find("tbody tr").each(function(q,r){$(this).children().eq(k).show();
});return false;}});}});window.parent.localStorage.setItem("csOrderTableConfigItems",JSON.stringify(j));layer.close(a.layerIndex);},on:function(h,g){layer.close(a.layerIndex);
},cancel:function(){layer.close(a.layerIndex);}});});$(document).on("click",".checkboxDiv",function(c){var d=$(this).find('input[type = "checkbox"]');if(!$(c.target).is('input[type = "checkbox"]')){d.trigger("click");
}if(d.attr("name")=="allCheck"){$(".columnCheckBox").each(function(f,g){if($(this).attr("name")!="allCheck"){$(this).prop("checked",d.prop("checked"));
}});}else{var b=true;$(".columnCheckBox").each(function(f,g){if(!$(this).prop("checked")&&$(this).attr("name")!="allCheck"){b=false;return false;}});$("input.columnCheckBox[name='allCheck']").prop("checked",b);
}});},_showMergeSo:function(b){var a=this;a.layerIndex=layer.open({type:1,title:'订单合并<span style="color:red;padding-left:10px;">请谨慎操作，合并后无法恢复</span>',shadeClose:false,btn:["保存","关闭"],area:["30%","40%"],content:$(".mergeSoPanel"),scrollbar:false,success:function(c,d){var f=new StringBuffer();
for(var e=0;e<b.length;e++){f.append("<option value='"+b[e].soNo+"'>"+b[e].soNo+"</option>");}$("#mergeToSo").empty().append(f.toString());},yes:function(d,c){var e=$("#mergeToSo").val();
a._mergeSo(e,b);},cancel:function(){}});},_mergeSo:function(g,f){var b=this;var a=CsOrder._CONS_.MERGE_SO_URL;var e=[];for(var c=0;c<f.length;c++){e.push(f[c].soNo);
}var d=[];for(var c=0;c<f.length;c++){d.push(f[c].soId);}FormUtils.submit(a,{toSo:g,soNos:e,soIds:d},function(h){if(h.success){DialogUtils.success(msgCode.INFO,h.msg);
layer.close(b.layerIndex);b._initTable(b.params);}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);layer.close(b.layerIndex);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_initTable:function(d){var b=this;var c=false;if(type=="self"){if(ResUtils.canShow("csEntity.button.merge")){c=true;}}if(type=="mysub"){if(ResUtils.canShow("csEntity.button.mergeSub")){c=true;
}}if(type=="search"){if(ResUtils.canShow("csEntity.button.mergeSearch")){c=true;}}var a=false;if(d.showThirdSoNo&&"y"==d.showThirdSoNo){a=true;}ConfigUtils.findByKey("soEntity.isReceivePhone",function(l){var e=true;
if(!l.success){e=false;}var i=JSON.parse(window.parent.localStorage.getItem("csOrderTableConfigItems"));function k(m,o){if(m){var n=true;$.each(m,function(p,q){if(this.id==(o+"Th")&&!this.isShow){n=false;
}});return n;}else{return true;}}function j(m){if(m){return"";}else{return"hideColumn";}}function f(m){return"<th id='"+m.id+"' width='"+m.width+"'>"+m.name+"</th>";
}$columns=[{id:"lineNumTh",width:"4%",name:"序号",isShow:true},{id:"soNoTh",width:"6%",name:"订单编号",isShow:true},{id:"originSoIdTh",width:"6%",name:"关联订单",isShow:true},{id:"thirdSoNoTh",width:"6%",name:"外部单号",isShow:true},{id:"scTrackingNoTh",width:"8%",name:"快递单号",isShow:true},{id:"partyNameTh",width:"5%",name:"收件人",isShow:true},{id:"partyAddrTh",width:"6%",name:"收件地址",isShow:true},{id:"partyMaskPhoneTh",width:"6%",name:"收件号码",isShow:true},{id:"totalAmountTh",width:"6%",name:"订单金额",isShow:true},{id:"thirdStoreNameTh",width:"6%",name:"店铺名称",isShow:true},{id:"prodNamesTh",width:"7%",name:"产品名称",isShow:true},{id:"placeTimeTh",width:"6%",name:"下单时间",isShow:true},{id:"completeTimeTh",width:"6%",name:"完成时间",isShow:true},{id:"cashTypeTh",width:"6%",name:"货款方式",isShow:true},{id:"isSplitOrderTh",width:"4%",name:"拆分",isShow:true},{id:"statusTh",width:"4%",name:"状态",isShow:true},{id:"placerNameTh",width:"6%",name:"下单人",isShow:true},{id:"profitsTh",width:"6%",name:"业绩工号",isShow:true},{id:"tranPhoneTh",width:"6%",name:"成交手机编号",isShow:true},{id:"recPhoneTh",width:"6%",name:"收款手机编号",isShow:true}];
var h="<table class='table table-bordered table-stripped' id='csOrderTable'><thead><tr id='csOrderTr'><th width='2%'><button type='button' class='btn btn-default btn-sm edit_items' data-id='csOrderTable'><span class='glyphicon glyphicon-cog ' aria-hidden='true' ></span></button></th>";
$.each($columns,function(m,n){h+=f(this);});h+="</tr></thead></table>";$("#csOrderDiv").empty().append(h);var g=ctx+"/ec/salesorder/soEntity/findByCsId.htm?csId="+d.csId+"&canShowScTrankNo="+b._canShowScTrankNo()+"&canViewPhone="+b._canViewPhone();
$("#csOrderTable").DataTable({ajax:{url:g},searching:false,columns:[{data:"soNoShow",render:function(o,n,m){return"<input type='checkbox'  class='checkchild jt-middle-check' so-id='"+m.id+"'  value='"+m.soNo+"' status ='"+m.status+"' />";
}},{data:"lineNum",className:j(k(i,"lineNum"))},{data:"soNo",className:j(k(i,"soNo")),render:function(o,n,m){if(o!=null&&o!=""){var q=new StringBuffer();
var p="";if(m.baseType=="back"){p="<a href='#' title='"+o+"' class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(退)</a>";
}else{if(m.baseType=="back_before_exchange"){p="<a href='#'  title='"+o+"' class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(退换)</a>";
}else{if(m.baseType=="exchange"){p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(换)</a>";
}else{if(!m.baseType||m.baseType=="common"){if(m.backExchangeCount){p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"<span style='color:red'>["+m.backExchangeCount+"退换]</span>"+"</a>";
}else{p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"</a>";
}}}}}q.append(p);if(m.cashCode){q.append("&nbsp;<span style='color:blue'>券</span>");}if(m.soType=="soSupplementary"){q.append("&nbsp;<span style='color:blue'>(补)</span>");
}return q.toString();}return o;}},{data:"originSoId",render:function(q,p,o){if(o.baseType=="back"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(原)</a>";
return m;}else{if(o.baseType=="back_before_exchange"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(原)</a>";
if(o.linkSoNo){var n="<a title='"+o.linkSoNo+"' href='#' class='soTab' value='"+o.linkSoNo+"' csIdVal='"+d.csId+"'>"+o.linkSoNo+"(换)</a>";return m+" ，"+n;
}else{var n="";return m;}}else{if(o.baseType=="exchange"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(退换)</a>";
var n="<a title='"+o.linkSoNo+"' href='#' class='soTab' value='"+o.linkSoNo+"' csIdVal='"+d.csId+"'>"+o.linkSoNo+"(原)</a>";return m+"，"+n;}else{if(!o.baseType||o.baseType=="common"){console.log(o.linkSoIdAndType4Common);
}}}}return"";}},{data:"thirdSoNo",bVisible:a,className:j(a&&k(i,"thirdSoNo"))},{data:"scTrackingNo",bVisible:a,className:j(k(i,"scTrackingNo"))},{data:"partyName",bVisible:a,className:j(a&&k(i,"partyName"))},{data:"partyAddr",bVisible:a,className:j(a&&k(i,"partyAddr"))},{data:"partyMaskPhone",bVisible:a,className:j(a&&k(i,"partyMaskPhone"))},{data:"totalAmount",className:j(k(i,"totalAmount"))},{data:"thirdStoreName",bVisible:a,className:j(a&&k(i,"thirdStoreName"))},{data:"prodNames",className:j(k(i,"prodNames"))},{data:"placeTime",className:j(k(i,"placeTime")),render:function(p,o,n){var m="<span title='"+p+"'>"+DateUtils.miniTime(p)+"</span>";
return m;}},{data:"completeTime",className:j(k(i,"completeTime")),render:function(p,o,n){var m="<span title='"+p+"'>"+DateUtils.miniTime(p)+"</span>";return m;
}},{data:"cashType",className:j(k(i,"cashType")),render:function(m,o,n){return SoEntityUtils.formatCashType(m);}},{data:"isSplitOrder",className:j(k(i,"isSplitOrder")),render:function(o,n,m){if(m.isSplitOrder=="y"){return"是";
}else{return"否";}}},{data:"status",className:j(k(i,"status")),render:function(m,o,n){return SoEntityUtils.formatStatus(n);}},{data:"placerName",className:j(k(i,"placerName")),render:function(o,n,m){if(m.placerName.indexOf("null")>-1){return"[已删除]";
}else{return m.placerName;}}},{data:"profits",className:j(k(i,"profits"))},{data:"tranPhone",bVisible:e,className:j(e&&k(i,"tranPhone"))},{data:"recPhone",bVisible:e,className:j(e&&k(i,"recPhone"))}],rowId:"id",lengthMenu:[[20],],fnRowCallback:function(p,o,n,m){if($(".csOrderTable-total-layer").length==0){$("#csOrderTable").after("<div class='csOrderTable-total-layer'>"+(c?"<button class='jt-form-select mergeSo'>合并</button>":"")+"<span style='padding-left:20px;'>总金额(合计)：</span><span id='totalAmountsum'>0</span>"+"</div>");
}if(n==0){addd=0;}addd+=parseFloat(o["totalAmount"]);$("#totalAmountsum").html(addd.toFixed(2)+"(元)");return p;},paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,bSort:false,order:[1,"asc"]});
});},_canShowScTrankNo:function(){var a="cannot";if(this.params.csType){if("self"==this.params.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.showScTrackNo")){a="can";
}}else{if("mysub"==this.params.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.showScTrackNoSub")){a="can";
}}else{if("task"==this.params.csType){if(ResUtils.canShow("csEntity.button.showScTrackNoTask")){a="can";}}else{if("callRecord"==this.params.csType){if(ResUtils.canShow("csEntity.button.showScTrackNoCallRecord")){a="can";
}}else{if(ResUtils.canShow("csEntity.button.showScTrackNoSearch")){a="can";}}}}}}return a;},_canViewPhone:function(){var a="n";if(this.params.csType){if("self"==this.params.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewPhoneBtn")){a="y";
}}else{if("mysub"==this.params.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewPhoneBtnSub")){a="y";
}}else{if("task"==this.params.csType){if(ResUtils.canShow("csEntity.button.viewPhoneBtnTask")){a="y";}}else{if("callRecord"==this.params.csType){if(ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")){a="y";
}}else{if(ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")){a="y";}}}}}}return a;}};