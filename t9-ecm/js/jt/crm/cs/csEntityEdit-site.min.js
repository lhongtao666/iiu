function OppoEntityList(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.params="";this.coId="";this.oppoTable=null;}OppoEntityList._CONS_={EDIT_URL:ctx+"/crm/oppo/oppoRecord/edit.htm",DETAIL_URL:ctx+"/crm/oppo/oppoRecord/detail.htm",DELETE_URL:ctx+"/crm/oppo/oppoEntity/delete.htm",SAVE_ADD_URL:ctx+"/crm/oppo/oppoRecord/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/oppo/oppoRecord/saveEdit.htm",LIST_ENTITY_DATA_URL:ctx+"/crm/oppo/oppoEntity/listData.htm",LIST_ENTITY_BY_CS_URL:ctx+"/crm/oppo/oppoEntity/findByCsId.htm",UPDATE_STAGE_URL:ctx+"/crm/oppo/oppoEntity/updateStage.htm",EDIT_FORM_ID:"oppoRecordForm",GRID:"#oppoRecordGrid",PAGER:"#oppoRecordPager"};
OppoEntityList.prototype={initInfo:function(){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}},reloadEntityList:function(c,b){var a=this;
a.coId=b;a.params=c;FormUtils.submit(OppoEntityList._CONS_.LIST_ENTITY_BY_CS_URL+"?coId="+b,null,function(d){a._dealEntityRows(d.data);},null,true);},_dealEntityRows:function(b){var c=this;
var f=new StringBuffer();for(var d=0;d<b.length;d++){var e=b[d];var a=c._dealEntity2(e);f.append(a);}$("#oppoContainer").empty().append(f.toString());},_dealEntity2:function(b){var i=this;
var g=new StringBuffer();g.append('<tr class="oppo-row" idVal="'+b.id+'">');g.append('<td class="td">');g.append(b.key);g.append("</td>");g.append('<td class="td ellipsis-class">');
g.append(b.name);g.append("</td>");g.append('<td class="td">');var f="";switch(b.stage){case"begin":f='<label type="lable" class="label label-default">挖掘商机</label>';
break;case"interest":f='<label type="lable" class="label label-warning">确定客户意向</label>';break;case"project":f='<label type="lable" class="label label-warning">引导客户立项</label>';
break;case"agree":f='<label type="lable" class="label label-success">赢得客户认可</label>';break;case"discuss":f='<label type="lable" class="label label-success">进行商务谈判</label>';
break;case"win":f='<label type="lable" class="label label-info">赢单</label>';break;case"lost":f='<label type="lable" class="label label-danger">丢单</label>';
break;}g.append(f);g.append("</td>");g.append('<td class="td">');var d="";var e=new StringBuffer();switch(b.interest){case 1:e.append('<label type="lable" class="label label-default">');
e.append("很小");break;case 2:e.append('<label type="lable" class="label label-warning">');e.append("普通");break;case 3:e.append('<label type="lable" class="label label-info">');
e.append("较大");break;case 4:e.append('<label type="lable" class="label label-info">');e.append("很大");break;}e.append("</label>");d=e.toString();g.append(d);
g.append("</td>");g.append('<td class="td">');var a="";switch(b.srcType){case"qq":a="QQ";break;case"wechart":a="微信";break;case"tel":a="电话";break;case"other":a="其它";
break;}g.append(a);g.append("</td>");g.append('<td class="td">');g.append(b.profitRange);g.append("</td>");g.append('<td class="td">');var c="";var h=new StringBuffer();
if(b.rate===1){h.append('<label type="lable" class="label label-default">');h.append("很小");h.append("</label>");}else{if(b.rate===2){h.append('<label type="lable" class="label label-warning">');
h.append("普通");h.append("</label>");}else{if(b.rate===3){h.append('<label type="lable" class="label label-info">');h.append("较大");h.append("</label>");
}else{if(b.rate===4){h.append('<label type="lable" class="label label-info">');h.append("很大");h.append("</label>");}}}}c=h.toString();g.append(c);g.append("</td>");
g.append('<td class="td">');g.append(b.endTime);g.append("</td>");g.append("<td >");g.append(i._dealOperateBtn(b.id,b.stage));g.append("</td>");return g.toString();
},_dealOperateBtn:function(e,b){var d=new StringBuffer();d.append('<div class="btn-group operation">');d.append('<button data-toggle="dropdown" class="btn btn-default dropdown-toggle ">操作 <span class="caret"></span>');
d.append("</button>");d.append('<ul class="dropdown-menu">');d.append("<li>");d.append('<button type="button" class="btn btn-outline btn-danger delete-oppo" idVal="'+e+'" >删除</button>');
d.append("</li>");d.append("<li>");d.append('<button type="button" class="btn btn-outline btn-primary detail-oppo" idVal="'+e+'" >编辑</button>');d.append("</li>");
if(b!="win"&&b!="lost"){var a="";var c="";switch(b){case"":a="begin";c="挖掘商机";break;case"begin":a="interest";c="确定客户意向";break;case"interest":a="project";
c="引导客户立项";break;case"project":a="agree";c="赢得客户认可";break;case"agree":a="discuss";c="进行商务谈判";break;}if(a){d.append("<li>");d.append('<button type="button" next-stage="'+a+'" current-statge="'+b+'" class="btn btn-outline btn-primary push-oppo" idVal="'+e+'" >推进</button>');
d.append("</li>");}if(b!="lost"||b!="win"){if(b!="lost"){d.append("<li>");d.append('<button type="button"  next-stage="lost"  current-statge="'+b+'" class="btn btn-outline btn-primary push-oppo" idVal="'+e+'" >丢单</button>');
d.append("</li>");}if(b!="win"){d.append("<li>");d.append('<button type="button"  next-stage="win"  current-statge="'+b+'" class="btn btn-outline btn-primary push-oppo" idVal="'+e+'" >赢单</button>');
d.append("</li>");}}}d.append("</ul>");d.append("</div>");return d.toString();},_bindEventHander:function(){var a=this;$("body").on("click",".add-oppo-record",function(){var b=$("[name=content]").val();
a._saveOppoRecord();});$("body").on("click",".detail-oppo",function(){var b=$(this).attr("idVal");if(!b){$(this).parent().attr("idVal");}layer.open({title:["商机详情","text-align:center;"],type:2,area:["85%","90%"],fix:false,maxmin:true,scrollbar:false,content:ctx+"/crm/oppo/oppoEntity/openOppoDetail.htm?id="+b,end:function(){a.reloadEntityList(a.params,a.coId);
}});});$("body").on("click",".delete-oppo",function(c){var b=$(this).attr("idVal");a._delete(b);c.stopPropagation();});$("body").on("click",".push-oppo",function(c){var d=new StringBuffer();
var b=$(this).attr("next-stage");var f=$(this).attr("idVal");d.append("stage="+b);d.append("&ids="+f);d=d.toString();FormUtils.submit(OppoEntityList._CONS_.UPDATE_STAGE_URL,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
a.reloadEntityList(a.params,a.coId);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});});$("body").on("click",".add-entity-oppo",function(){var b=a.coId;
layer.open({title:["添加商机","text-align:center;"],type:2,area:["85%","90%"],fix:false,maxmin:true,scrollbar:false,content:ctx+"/crm/oppo/oppoEntity/oppoEntityAdd.htm.htm?coId="+b,end:function(){a.reloadEntityList(a.params,a.coId);
}});});},init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
}},_hideNotGrantBtn:function(){},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(OppoEntityList._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadEntityList(a.params);}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},};function CsAddr(){this.csType="";this.employeeId="";this.permissionType="";
this.hasFlash=false;}CsAddr.prototype={init:function(){this._bindEventHander();},_bindEventHander:function(){var a=this;$(document).on("click",".addAddr",function(){var c=new ShopAddrOpt();
var b=$("input[name=id]").val();c.init({csId:b,callBack:function(f){$(".noConformData").empty();$(".addrli").hide();var e=[];e.push(f);$(".addrDiv").append(a.fillAddr(a,e));
$(".addrDivBtn").empty();for(var d=0;d<e.length;d++){a.loadArea(e[d],"addressContainer"+e[d].id);}$(".addrDiv li").last().show();if($(".addrDiv li").length>1){$(".showAddrList").show();
}else{$(".showAddrList").hide();}}});});$(document).on("click",".showMapWeather",function(){var c=$(this).attr("idVal");var d=$(this).parents("li").find("select[name=city_]").val();
var b=$(this).parents("li").find("select[name=city_]").find('option[value="'+d+'"]').text();FormUtils.submit(ctx+"/crm/cs/csEntity/addr/loadMapInfo.htm",{addrId:c},function(e){if(e.status=="200"){DialogUtils.error("提示",e.message);
}else{JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/mapWeatherForm.htm?cityName="+b+"&longitude="+e.result.locationPo.lng+"&latitude="+e.result.locationPo.lat,"地图|天气");
}});});$(document).on("click",".edit-addr",function(){$(this).hide();$(this).next().show();var h=$(this).attr("idVal");var g=$(this).parents("li");g.find("input,select").removeAttr("disabled");
var f=g.find("select[name=country_]").val();var b=g.find("select[name=province_]").val();var e=g.find("select[name=city_]").val();var d=g.find("select[name=area_]").val();
var c=g.find("select[name=town_]").val();this.addressService=new AddressService("addressContainer"+h);this.addressService.init({country:f,province:b,city:e,area:d,town:c,isSelect:"y",isNotRequired:true,disabled:false});
}),$(document).on("change",".addrMobile",function(){$(this).next().val($(this).val());});$(document).on("change",".csAddrDetail",function(){$(this).next().val($(this).val());
});$(document).on("click",".save-addr",function(){var e=$(this).attr("idVal");var k=$(this);var l=$(this).parents("li");var h="id="+e;h+="&csId="+$("input[name=id]").val();
var b=l.find("input[name=addrName]").val();var n=l.find("input[name=addr]");var f=l.find("select[name=province_]").val();var o=l.find("select[name=province_]").find('option[value="'+f+'"]').text();
var i=l.find("select[name=city_]").val();var q=l.find("select[name=city_]").find('option[value="'+i+'"]').text();var d=l.find("select[name=area_]").val();
var j=l.find("select[name='area_']").find("option[value='"+d+"']").text();var m=l.find("select[name=town_]").val();var p=l.find("select[name='town_']").find("option[value='"+m+"']").text();
var c=l.find("input[name=mobile]");var g=l.find("select[name=isDefault]").val();if(b){h+="&name="+b;}else{DialogUtils.error("提示","请填写联系人");return;}if(n.val()){h+="&addr="+n.val();
}else{DialogUtils.error("提示","请填写地址");return;}if(f){h+="&prRid="+f;h+="&prName="+o;}else{DialogUtils.error("提示","请填写省市区");return;}if(i){h+="&ciRid="+i;
h+="&ciName="+q;}else{DialogUtils.error("提示","请填写省市区");return;}if(c.val()){h+="&mobile="+c.val();}else{DialogUtils.error("提示","请填写手机号码");return;}if(d){h+="&arRid="+d;
h+="&arName="+j;}if(m){h+="&toRid="+m;h+="&toName="+p;}h+="&isDefault="+g;FormUtils.submit(ctx+"/crm/cs/csEntity/addr/partyAddrEditSave.htm",h,function(s){if(s.success){var r={csId:s.partyAddrPo.partyId,csType:a.csType,employeeId:a.employeeId,permissionType:a.permissionType,};
a.loadData(r);k.hide();k.prev().show();}else{DialogUtils.error("失败",s.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$(document).on("click",".addrli",function(d){var c=d||window.event;
var b=c.target||c.srcElement;if(b.tagName.toLowerCase()=="button"){return;}$("input[name='soShipPos[0].addrId']").val($(this).attr("value"));$(".addrli").hide();
$(this).show();});$(document).on("click",".showAddrList",function(){$(".addrli").show();});$(document).on("click",".remove-addr",function(){var c=$(this).attr("idval");
var b=$("input[name=id]").val();DialogUtils.confirm(function(){if(c){FormUtils.submit(CsEntityEdit._CONS_.DEL_ADDR_URL,{id:c},function(e){if(e.success){var d={csId:b,csType:a.csType,employeeId:a.employeeId,permissionType:a.permissionType,};
a.loadData(d);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});}});});},loadArea:function(d,b){var a=this;var c=new StringBuffer();c.append("<div class='col-sm-12'>");
c.append("<div class='col-sm-10 container' style='padding-left:0px !important;'>");c.append("<div class='col-sm-3' style='padding-left:0px !important;'>");
c.append("<select class='form-control' name='province_' disabled='disabled'>");if(d.prRid){c.append("<option selected='selected' value='"+d.prRid+"'>"+d.prName+"</option>");
}else{c.append("<option selected='selected' value=''>请选择</option>");}c.append("</select>");c.append("</div>");if(d.ciRid){c.append("<div class='col-sm-3' style='padding-left:0px !important;'>");
c.append("<select class='form-control' name='city_' disabled='disabled'>");c.append("<option selected='selected' value='"+d.ciRid+"'>"+d.ciName+"</option>");
c.append("</select>");c.append("</div>");}if(d.arRid){c.append("<div class='col-sm-3' style='padding-left:0px !important;'>");c.append("<select class='form-control' name='area_' disabled='disabled'>");
c.append("<option selected='selected' value='"+d.arRid+"'>"+d.arName+"</option>");c.append("</select>");c.append("</div>");}if(d.toRid){c.append("<div class='col-sm-3' style='padding-left:0px !important;'>");
c.append("<select class='form-control' name='town_' disabled='disabled'>");c.append("<option selected='selected' value='"+d.toRid+"'>"+d.toName+"</option>");
c.append("</select>");c.append("</div>");}c.append("</div>");c.append("</div>");$("#"+b).empty().append(c.toString());},loadData:function(b){var a=this;
a.csType=b.csType;a.employeeId=b.employeeId;a.permissionType=b.permissionType;FormUtils.loadData(CsEntityEdit._CONS_.EDIT_INFO_URL+"?party_id_="+b.csId,function(d){$(".addrDiv").empty();
if(d&&d.length>0){$(".addrDiv").append(a.fillAddr(d));for(var c=0;c<d.length;c++){a.loadArea(d[c],"addressContainer"+d[c].id);}a.showTheHideAddr(d);if($(".addrDiv li").length>1){$(".showAddrList").show();
}else{$(".showAddrList").hide();}}else{$(".addrDiv").append("<div class='noConformData' style='color:red;'>没有符合数据！</div>");$(".addrDivBtn").empty().append(a.buildAddBtn());
$(".showAddrList").hide();}if(b.fn&&typeof b.fn==="function"){b.fn();}},function(){},true);},buildAddBtn:function(){var a=new StringBuffer();a.append("<div class='form-group' style='margin-top: 2px;'>");
a.append("<div class='col-sm-4 pull-right'>");a.append("<button type='button' class='jt-form-select addAddr'>添加</button>");a.append("</div>");a.append("</div>");
return a.toString();},fillAddr:function(c){var a=this;var d=new StringBuffer();for(var b=0;b<c.length;b++){if(c[b].isSnapshot=="n"){d.append("<li class='addrli' id='"+c[b].id+"'"+"style='border:1px solid #CCC;list-style-type:none;position:relative;margin-top:2px;");
if((c[b].isDefault=="y"||(c.length==1&&c[b].isDefault=="n"))){$("input[name=addrId]").val(c[b].id);d.append("'>");}else{d.append("display:none;' idval=''>");
}d.append("<div class='form-group'>");d.append("<div class='col-sm-4'>");d.append("<label class='col-sm-4 control-label'>联系人</label>");d.append("<div class='col-sm-8'>");
d.append("<input type='text' name='addrName' disabled='disabled' class='form-control' validateType='default' value='"+c[b].name+"'>");d.append("</div>");
d.append("</div>");d.append("<div class='col-sm-5'>");d.append("<label class='col-sm-4 control-label'>联系方式</label>");d.append("<div class='col-sm-8'>");
d.append("<input type='text' name='addrMobile' disabled='disabled' class='form-control addrMobile' validateType='default' value='"+c[b].mobile+"'>");d.append("<input type='hidden' name='mobile' value='"+c[b].maskMobile+"'>");
d.append("</div>");d.append("</div>");d.append("<div class='col-sm-3'><label class='col-sm-4 control-label'>默认</label>");d.append("<div class='col-sm-6'>");
d.append("<select class='form-control' name='isDefault' validatetype='default' disabled='disabled'>");if(c[b].isDefault=="y"){d.append("<option value='y' selected='selected'>是</option>");
d.append("<option value='n'>否</option>");}else{d.append("<option value='y'>是</option>");d.append("<option value='n' selected='selected'>否</option>");}d.append("</select>");
d.append("</div>");d.append("</div>");d.append("</div>");d.append("<div class='form-group'>");d.append("<div class='col-sm-11'>");d.append("<label class='col-sm-1 control-label' style='margin-left:13px;'>地区</label>");
d.append("<div class='col-sm-10' id='addressContainer"+c[b].id+"'></div>");d.append("</div>");d.append("</div>");d.append("<div class='form-group'>");d.append("<div class='col-sm-8'>");
d.append("<label class='col-sm-2 control-label'>地址</label>");d.append("<div class='col-sm-10'>");if(this.csType){if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewAddrBtn")){d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+c[b].addr+"'>");
}else{d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+MaskPhoneNum.maskAddr(c[b].addr)+"'>");
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewAddrBtnSub")){d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+c[b].addr+"'>");
}else{d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+MaskPhoneNum.maskAddr(c[b].addr)+"'>");
}}else{if("task"==this.csType){if(ResUtils.canShow("csEntity.button.viewAddrBtnTask")){d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+c[b].addr+"'>");
}else{d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+MaskPhoneNum.maskAddr(c[b].addr)+"'>");
}}else{if("callRecord"==this.csType){if(ResUtils.canShow("csEntity.button.viewAddrBtnCallRecord")){d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+c[b].addr+"'>");
}else{d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+MaskPhoneNum.maskAddr(c[b].addr)+"'>");
}}else{if(ResUtils.canShow("csEntity.button.viewAddrBtnSearch")){d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+c[b].addr+"'>");
}else{d.append("<input type='text' name='addr' disabled='disabled' class='form-control csAddrDetail' validateType='default' value='"+MaskPhoneNum.maskAddr(c[b].addr)+"'>");
}}}}}}d.append("<input type='hidden' name='maskAddr' value='"+c[b].maskAddr+"'>");d.append("</div>");d.append("</div>");d.append("</div>");d.append("</div>");
d.append("<div class='form-group'>");d.append("<div class='col-sm-1'>");d.append("</div>");d.append("<div class='col-sm-6'>");d.append("<button type='button' class='btn btn-sm btn-outline btn-primary showMapWeather'  idVal='"+c[b].id+"'>地图|天气</button>");
d.append("</div>");d.append("<div class='col-sm-5'>");d.append("<button type='button' class='btn btn-sm btn-outline btn-primary edit-addr' idVal='"+c[b].id+"'>编辑</button>");
d.append("<button type='button' class='btn btn-sm btn-outline btn-primary save-addr' style='display:none;' idVal='"+c[b].id+"'>保存</button>");d.append("&nbsp;<button type='button' class='btn btn-sm btn-outline btn-primary addAddr'>添加</button>");
d.append("&nbsp;<button type='button' class='btn btn-sm btn-outline btn-primary showAddrList'>更多地址</button>&nbsp;");if(this.csType){if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.deleteAddrBtn")){d.append("<button type='button' class='btn btn-sm btn-outline btn-danger remove-addr' idval='"+c[b].id+"'>删除</button>");
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.deleteAddrBtnSub")){d.append("<button type='button' class='btn btn-sm btn-outline btn-danger remove-addr' idval='"+c[b].id+"'>删除</button>");
}}else{if("task"==this.csType&&ResUtils.canShow("csEntity.button.deleteAddrBtnTask")){d.append("<button type='button' class='btn btn-sm btn-outline btn-danger remove-addr' idval='"+c[b].id+"'>删除</button>");
}else{if("callRecord"==this.csType&&ResUtils.canShow("csEntity.button.deleteAddrBtnCallRecord")){d.append("<button type='button' class='btn btn-sm btn-outline btn-danger remove-addr' idval='"+c[b].id+"'>删除</button>");
}else{if(ResUtils.canShow("csEntity.button.deleteAddrBtnSearch")){d.append("<button type='button' class='btn btn-sm btn-outline btn-danger remove-addr' idval='"+c[b].id+"'>删除</button>");
}}}}}}d.append("</div>");d.append("</div>");d.append("</li>");}}return d.toString();},showTheHideAddr:function(a){if($(".addrDiv").find("li[idval]").length==a.length){$(".addrDiv").find(".addrli").eq(0).show();
}}};function CsFollow(){this.hadInit=false;this.needTable=true;this.fn=null;this.employeeId="";this.csType="";this.permissionType="";this.partyInfo=null;
this.followType="";this.contentExt="";this.isWeixin=false;}CsFollow._CONS_={EDIT_URL:ctx+"/crm/cs/csFollow/edit.htm",DELETE_URL:ctx+"/crm/cs/csFollow/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/csFollow/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csFollow/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/csFollow/findByCsId.htm",EDIT_FORM_ID:"csFollowForm"};
CsFollow.prototype={init:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindFormValidation();}if(b){this.needTable=b.needTable;
this.fn=b.fn;this.employeeId=b.employeeId;this.csType=b.csType;this.permissionType=b.permissionType;this.followType=b.followType;this.contentExt=b.contentExt;
this._initInputAndOption(b);if(b.isWeixin){this.isWeixin=b.isWeixin;}if(b.shipQry){this.entityId=b.entityId;this.soNo=b.soNo;this.csPhone=b.csPhone;this._addFollowBtn();
}}if(this.needTable){this._initTable();}this.partyInfo=a;},clear:function(c){var a=this;b();function b(){var d=$("#csFollowForm");d.find('input[name="hasTask"]').val(["n"]).trigger("change");
d.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");var e=document.querySelector(".js-switch");
var f=new Switchery(e,{className:"switchery switchery-small"});d.find("[name=csFollowId]").val("");d.find("#followType option:first").prop("selected","selected");
d.find("#satisfy option:first").prop("selected","selected");d.find("[name=content]").val("");d.find("#taskTimeDiv").hide();d.find("#followEmployeeDiv").hide();
d.find("input[name=taskTime]").val("").removeClass("validate_input_error");d.find("input[name=partyShow]").val("").removeClass("validate_input_error");
d.find("input[name=partyId]").val("");d.find("input[name=employeeAid]").val("");}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_save:function(){var h=this;var d=$("#csFollowForm");var a=d.find("[name=csFollowId]").val();var g=a?CsFollow._CONS_.SAVE_EDIT_URL:CsFollow._CONS_.SAVE_ADD_URL;
var f=new StringBuffer();var i=d.find("[name=type]").val();if(!$("#csFollowForm").valid()){return;}if("so"==this.followType){type="订单跟进";}var e=d.find("[name=content]").val();
e=e.replace("&","");d.find("[name=content]").val(e);var c="";if(this.contentExt){c=i+"："+this.contentExt+e;}else{c=i+"："+e;}var b={id:a,type:d.find("[name=type]").val(),content:encodeURI(d.find("[name=content]").val()),smsContent:encodeURI(d.find("[name=smsContent]").val()),contentExt:encodeURI(c),hasTask:d.find('input[name="hasTask"]').val(),satisfy:d.find("[name=satisfy]").val(),csId:d.find("input[name='csId']").val(),csCode:d.find("input[name='csCode']").val(),createAid:currentUserAid,entityId:$("#soEntityForm").find('input[name="id"]').val()||$("#csEntityForm").find('input[name="id"]').val()||this.entityId,seconds:d.find("[name=seconds]").val(),soNo:$("[name=soNo]").val()||this.soNo,isSms:$("[name=isSms]").val(),};
if(d.find("input[name=partyId]").val()&&d.find('input[name="hasTask"]').val()=="y"){b.taskTime=d.find("[name=taskTime]").val();b.partyId=d.find("input[name=partyId]").val();
b.employeeAid=d.find("input[name=employeeAid]").val();b.csPhone=d.find("input[name='csFollowPhone']").val()||$("#soEntityForm").find(".addrMobile").val()||this.csPhone;
b.status="new";}else{b.partyId=currentUserId;b.employeeAid=currentUserAid;b.status="done";}if(b.isSms=="y"){if(b.csPhone==""){DialogUtils.error(msgCode.FAIL_MSG,"该客户无手机号码，不能发送短信!");
return;}}FormUtils.submit(g,b,function(j){if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}if(h.needTable){h._initTable();}if(h.fn&&(typeof h.fn=="function")){b.content=d.find("[name=content]").val();h.fn(b);}layer.close(h.layerIndex);h.clear();
if(h.isWeixin){$("#reload-follow").trigger("click");}}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindEventHander:function(){var a=this;var b=$("#csFollowForm");$("#followRecordTab").on("click",".deleteCsFollow",function(){var c={csId:$(this).attr("csIdVal"),id:$(this).attr("idVal")};
DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/cs/csFollow/delete.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
a._initTable();}});});});b.on("change","input[name='hasTask']",function(){if($(this).val()=="y"){b.find("#taskTimeDiv").hide();b.find("#followEmployeeDiv").hide();
b.find("#smsContentDiv").hide();b.find("input[name=partyShow]").removeClass("validate_input_error");b.find("input[name=taskTime]").removeClass("validate_input_error");
$(this).val("n");$("#isSmsDivContainer").hide();$("input[name='isSms']").val("n");b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");
var d=document.querySelector(".js-switch2");var f=new Switchery(d,{className:"switchery switchery-small"});layer.style(a.layerIndex,{height:"250px"});}else{b.find("#taskTimeDiv").show();
b.find("#followEmployeeDiv").show();var c=$(".followCount").height();layer.style(a.layerIndex,{height:"310px"});$(this).val("y");if(a.partyInfo){b.find("input[name=partyId]").val(a.partyInfo.partyId);
b.find("input[name=employeeAid]").val(a.partyInfo.partyAid);b.find("input[name=partyShow]").val(a.partyInfo.partyAid+":"+a.partyInfo.partyName);}else{b.find("input[name=partyId]").val(currentUserId);
b.find("input[name=employeeAid]").val(currentUserAid);b.find("input[name=partyShow]").val(currentUserAid+":"+currentUserName);}var e=new Date();now=e.current();
b.find("input[name=taskTime]").val(now.substr(0,16));$("#isSmsDivContainer").show();}});b.on("change","input[name='isSms']",function(){if($(this).val()=="y"){$(this).val("n");
b.find("#smsContentDiv").hide();layer.style(a.layerIndex,{height:"310px"});}else{$(this).val("y");b.find("#smsContentDiv").show();var c=$(".followCount").height();
layer.style(a.layerIndex,{height:"400px"});}});b.on("click",".selectEmployee",function(){$("input[name=partyShow]").removeClass("validate_input_error");
var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=partyShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=partyId]").val(f[0].id);b.find("input[name=employeeAid]").val(f[0].aid);}}};var d=new EmployeesSelect();d.init(e);});$(document).on("click","#followTaskTime",function(){b.find("input[name=taskTime]").removeClass("validate_input_error");
});$(document).on("click",".appendFollow",function(){$(this).hide();$("#csFollowFormDiv").show();});$('select[name="suffix"]').on("change",function(){a._initTable();
});$(document).on("click",".saveAddFollow",function(){if(a.valid()){a._save();}});$(document).on("click","#addFollowBtn",function(){a._addFollowBtn();});
},_addFollowBtn:function(){var a=this;var b="form-config-layer";ButtonUtils.disableBtn("addFollowBtn");layer.close(a.layerIndex);a.layerIndex=layer.open({type:1,skin:"followCount",title:"跟进记录",shade:false,btn:["保存","取消"],area:["650px","auto"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,skin:b,success:function(c,d){ButtonUtils.enableBtn("addFollowBtn");
},yes:function(d,c){if(a.valid()){a._save();}},btn2:function(){a.clear();}});},_initTable:function(){var a=this;if(!a._hasPermission()){return;}var b=CsFollow._CONS_.LIST_DATA_URL+"?csId="+csId+"&suffix="+$("select[name='suffix']").val();
var d="";if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){d="<th width='7%'>操作</th>";
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){d="<th width='7%'>操作</th>";
}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){d="<th width='7%'>操作</th>";}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){d="<th width='7%'>操作</th>";
}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){d="<th width='7%'>操作</th>";}}}}}}$("#csFollowDiv").empty().append("<table class='table table-striped table-bordered' id='csFollowTable'>            <thead>                <tr>                    <th width='3%'></th>                    <th width='15%'>主题</th>                    <th width='35%'>待办内容</th>                    <th width='10%'>安排人</th>                    <th width='10%' >跟进人</th>                    <th width='10%'>记录时间</th>                    <th width='10%'>跟进时间</th>                    "+d+"                </tr>            </thead>        </table>");
var c=[{data:"lineNum",width:"3%"},{data:"type",},{data:"content",render:function(g,f,e){if(ResUtils.canShow("csEntity.button.viewFollowPhone")){return e.content;
}else{return MaskPhoneNum.maskDesc(e.content);}}},{data:"createName",render:function(g,f,e){if(e.createName.indexOf("null")>-1){return"[已删除]";}else{return e.createName;
}}},{data:"partyName",render:function(g,f,e){if(e.partyName.indexOf("null")>-1){return"[已删除]";}else{return e.partyName;}}},{data:"createTime",render:function(g,f,e){if(e.createTime){return DateUtils.miniTime(e.createTime);
}else{return"";}}},{data:"taskTime",render:function(g,f,e){if(e.taskTime){return DateUtils.miniTime(e.taskTime);}else{return"";}}},];if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<button class='btn btn-danger btn-sm btn-outline deleteCsFollow' csIdVal='"+e.csId+"' idVal='"+g+"' type='button' title='删除'><i class='fa fa-remove'></i></button>";
}});}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}}}}}$("#csFollowTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:true,ordering:true,order:[[5,"desc"]]});
},valid:function(){var a=true;var b=$("#csFollowForm");if(!b.valid()){a=false;}var c=b.find("[name = hasTask]:checkbox").val();if(c=="y"){if(!b.find("input[name=partyShow]").val()){b.find("input[name=partyShow]").addClass("validate_input_error");
a=false;}if(!b.find("input[name=taskTime]").val()){b.find("input[name=taskTime]").addClass("validate_input_error");a=false;}}return a;},_enableInput:function(){var b=$("#csFollowForm");
b.find("#followType").attr("disabled",false);b.find("#followContent").attr("readonly",false);b.find("[name=hasTask]").attr("disabled",false);b.find("#followTaskTime").attr("disabled",false);
b.find("#satisfy").attr("disabled",false);b.find("#seconds").attr("disabled",false);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});b.find(".selectEmployee").show();$(".appendFollow").show();
$("#csFollowFormDiv").hide();},_initInputAndOption:function(f){var b=$("#csFollowForm");b.find("input[name=csId]").val(f.csId);b.find("input[name=csCode]").val(f.csCode);
b.find("input[name=contentExt]").val(f.contentExt);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});if("so"==this.followType){b.find("#followType").empty().append("<option value='订单跟进'>订单跟进</option>");
if(ResUtils.canShow("soEntity.button.addFollowBtn")){$(".addFollow").show();}else{$(".addFollow").hide();}}else{CateUtils.getOptions({typeKey:"system",pKey:"CsFollowType",container:"followType",fn:function(h){var j=new StringBuffer();
if(h&&h.length>0){for(var g=0;g<h.length;g++){j.append("<option value='"+h[g].value+"'>"+h[g].name+"</option>");}}b.find("#followType").append(j.toString());
}});if(this.csType){$(".addFollow").show();if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtn")){$(".addFollow").hide();
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtnSub")){$(".addFollow").hide();
}}else{if("task"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnTask")){$(".addFollow").hide();}}else{if("callRecord"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnCallRecord")){$(".addFollow").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addFollowBtnSearch")){$(".addFollow").hide();}}}}}if(f.fn&&typeof f.fn=="function"){f.fn();}}}},_bindFormValidation:function(){var a={rules:{"content":{required:true,maxlength:1023},"seconds":{required:true,min:0},}};
FormUtils.bindFormValidation("csFollowForm",a);},_initFollowEmp:function(){var a=$("#csFollowForm");a.find("[name=content]").attr("disabled",false);a.find("input[name=partyShow]").val(currentUserAid+"："+currentUserName);
a.find("input[name=partyId]").val(currentUserId);a.find("input[name=employeeAid]").val(currentUserAid);},_prodSearch:function(a){$("#partyShow").bsSuggest("destroy");
if(a==null||a==""){return;}var b=this;$("#searchProd").bsSuggest({url:ctx+"/crm/ou/employee/selectEmployee.htm",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"姓名"},showBtn:false,idField:"id",keyField:"name",autoSelect:false,getDataMethod:"url",listStyle:{"padding-top":0,"max-height":"500px","max-width":width,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(d,c){b.searchProds=c.value;
}).on("onSetSelectValue",function(f,c){for(var d=0;d<b.searchProds.length;d++){if(b.searchProds[d].skuId==c.id){b.currentProd=b.searchProds[d];break;}}$("#searchProd").val("");
}).on("onUnsetSelectValue",function(c){b.searchProds=[];b.currentProd={};});},_initEmployeeSuggest:function(){var a=this;$("input[name='partyShow']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?grantType=/cs/&keyword=",effectiveFields:["aid"],searchFields:["aid"],effectiveFieldsAlias:{aid:"工号"},showBtn:false,idField:"id",keyField:"aid",getDataMethod:"url",processData:function(b){var e={value:[]};
if(b&&b.value){for(var d=0;d<b.value.length;d++){var c=b.value[d];e.value.push({id:c.id,aid:c.aid+"："+c.name});}}return e;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onSetSelectValue",function(d,b){var c=$("#csFollowForm");
c.find("input[name=partyId]").val(b.id);c.find("input[name=employeeAid]").val(b.aid);});},_hasPermission:function(){var a=true;if("self"==type||(this.permissionType&&"self"==this.permissionType)){}else{if("mysub"==type||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.viewFollowSub")){a=false;
}}else{if("task"==type){if(!ResUtils.canShow("csEntity.button.viewFollowTask")){a=false;}}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.viewFollowCallRecord")){a=false;
}}else{if(!ResUtils.canShow("csEntity.button.viewFollowSearch")){a=false;}}}}}return a;}};function CsLevelChange(){this.hadInit=false;}CsLevelChange._CONS_={DIARY_URL:ctx+"/crm/point/levelChange/csLevelChange.htm",};
CsLevelChange.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;}this._initTable(a);},_initTable:function(c){var a=this;$("#csLevelChangeDiv").empty().append("<table class='table table-striped table-bordered' id='csLevelChangeTable'>"+"<thead><tr><th>原级别名称</th><th>原级别</th><th>现级别名称</th><th>现级别</th><th>升/降</th><th>获得时间</th></tr></thead></table>");
var b=CsLevelChange._CONS_.DIARY_URL+"?id="+c.csId;$("#csLevelChangeTable").DataTable({ajax:{url:b},columns:[{data:"srcLevelName",width:"15%",render:function(f,e,d){if(f){return f;
}else{return"";}}},{data:"srcLevel",width:"15%"},{data:"levelName",width:"15%"},{data:"level",width:"15%"},{data:"dirType",width:"15%",render:function(g,f,e){if(g){var d=g;
if(g=="upgrade"){temp="升级";}else{if(g=="degrade"){temp="降级";}}return temp;}else{return"";}}},{data:"createTime",width:"25%"},],rowId:"id",lengthMenu:[[20],],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false});
}};function CsMailHistory(){this.hadInit=false;}CsMailHistory._CONS_={LIST_DATA_URL:ctx+"/gl/mail/mailQueue/getMailHistory.htm",};CsMailHistory.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;
}this.initTable(a);},initTable:function(d){var a=this;var e=new StringBuffer();e.append("<div id='mailHistoryDiv'>");e.append("<table class='table table-striped table-bordered' id='mailHistoryTable'>");
e.append("<thead><tr>");e.append("<th>接收人邮箱</th>");e.append("<th>邮件标题</th>");e.append("<th>发送结果</th>");e.append("<th>发送人</th>");e.append("<th>发送时间</th>");
e.append("</tr></thead>");e.append("</table>");e.append("</div>");$("#mailHistoryDiv").empty().append(e.toString());var c=CsMailHistory._CONS_.LIST_DATA_URL;
var b=$("#id").val();c=c+"?csId="+d.csId;$("#mailHistoryTable").DataTable({ajax:{url:c},columns:[{data:"maskEmail",width:"15%"},{data:"title",width:"15%"},{data:"email",render:function(i,h,g){var f=g.status;
if(f=="success"){return"<label class='label label-primary'>发送成功</label>";}else{return"<label class='label label-info'>发送失败</label>";}},width:"15%"},{data:"addresser",width:"15%"},{data:"createTime",width:"15%"},],rowId:"id",lengthMenu:[[6,10],[6,10]],paging:false,bFilter:false,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false,});
}};function CsComplainAdd(){this.hadInit=false;}CsComplainAdd._CONS_={EDIT_URL:ctx+"/crm/cs/csComplain/edit.htm",SAVE_ADD_URL:ctx+"/crm/cs/csComplain/saveAdd.htm",FIND_ALL_EMPLOYEE:ctx+"/crm/ou/employee/listEmployees.htm",FIND_ORDER:ctx+"/ec/salesorder/soEntity/findOrderByCsId.htm",FIND_ORDER_ITEM:ctx+"/ec/salesorder/soEntity/findSoItem.htm",FIND_BY_CSID:ctx+"/crm/cs/csComplain/findByCsId.htm",};
CsComplainAdd.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initInputAndOption(a);
this.findAllEmployees();}this.findOrders(a.csId);this._initTable(a.csId);},clear:function(){$("#csComplainAddForm").find("[name=complainId]").val("");$("#csComplainAddForm").find("[name=soId]").val("");
$("#csComplainAddForm").find("[name=skuIds]").empty();$("#csComplainAddForm").find("[name=followId]").val("");$("#csComplainAddForm").find("[name=type]").val("");
$("#csComplainAddForm").find("[name=desc]").val("");$("#csComplainAddForm").find("[name=dealResult]").val("");$("[name=status]").val("");},_save:function(){var c=this;
if($("#csComplainAddForm").valid()){var a=CsComplainAdd._CONS_.SAVE_ADD_URL;var e=$("#csComplainAddForm").serialize()+"&csId="+$("input[name='id']").val();
var b=$("#csComplainType option:selected").attr("firstCateId");var d=$("#csComplainType option:selected").val();if(b){e=e+"&firstType="+b;}if(d==b){e=e+"&isFirstType=true";
}else{e=e+"&isFirstType=false";}FormUtils.submit(a,e,function(f){if(f.success){DialogUtils.success("提示","投诉提交成功");c._initTable($("input[name='id']").val());
c.clear();layer.close(c.layerIndex);}else{DialogUtils.error("失败","投诉提交失败，请稍后重试");}});}},_bindEventHander:function(){var a=this;$("[name=soId]").on("change",function(){$("#skuIdsDiv").empty().append("<select multiple data-placeholder='请选择' class='chosen-select form-control' name='skuIds' ></select>");
if($(this).val()){a.findSoItem($(this).val());}else{$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();}});$(document).on("click",".addComplain",function(){a._add();
});$(document).on("click",".viewComplain",function(){a._detail($(this).attr("attr-id"));});},_bindFormValidation:function(){var a={rules:{"type":{required:true,},"soId":{required:true,}}};
FormUtils.bindFormValidation("csComplainAddForm",a);},findAllEmployees:function(){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ALL_EMPLOYEE+"?type=all",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("select[name=complainId]").empty().append(d.toString());
$("select[name=followId]").empty().append(d.toString());}}});},findOrders:function(b){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ORDER+"?csId="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){var e=new StringBuffer();
e.append("<option value=''>请选择</option>");if(d&&d.length>0){for(var c=0;c<d.length;c++){if("green"!=d[c].cashType){e.append("<option value='"+d[c].id+"'>"+d[c].createTime+"（"+d[c].soNo+"）</option>");
}}}$("[name=soId]").empty().append(e.toString());}});},findSoItem:function(b){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ORDER_ITEM+"?soId="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d&&d.length>0){var e=new StringBuffer();
for(var c=0;c<d.length;c++){e.append("<option value='"+d[c].skuId+"'>"+d[c].prodName+"（"+d[c].skuKey+"）</option>");}$("[name=skuIds]").empty().append(e.toString());
}$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();}});},_initTable:function(c){var a=this;$("#csComplainDiv").empty().append("<table class='table table-striped table-bordered' id='csComplainTable'><thead><tr><th>类型</th><th>订单</th><th>产品</th><th>投诉工号</th><th>跟进工号</th><th>投诉时间</th><th>状态</th><th>操作</th></tr></thead></table>");
var b=CsComplainAdd._CONS_.FIND_BY_CSID+"?csId="+c;$("#csComplainTable").DataTable({ajax:{url:b},columns:[{data:"type",render:function(f,e,d){if(f){return d.typeName;
}else{return d.firstTypeName;}},width:"15%"},{data:"soNo",width:"10%"},{data:"skuNames",width:"20%"},{data:"complainAid",width:"12%"},{data:"followAid",width:"12%"},{data:"createTime",width:"12%",render:function(f,e,d){if(d.createTime){return DateUtils.miniTime(d.createTime);
}else{return"";}}},{data:"status",render:function(g,f,e){var d=e.status;if(d=="new"){d="新增";}else{if(d=="follow"){d="跟进中";}else{if(d=="complete"){d="完成";
}}}return d;},width:"10%"},{data:"id",render:function(f,e,d){return"<input type='button' value='查看' attr-id='"+d.id+"' class='btn btn-sm btn-outline btn-primary viewComplain' style='margin: 0px 0px 0px 15px;' />";
},width:"10%"},],rowId:"id",lengthMenu:[[5,10],[5,10]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[5,"desc"]]});
},_add:function(){var a=this;$("#csComplainAddForm").find(".editInfoDiv").hide();a.ableButton();a.openEditView("add");},_detail:function(b){var a=this;
$("#csComplainAddForm").find(".editInfoDiv").show();a.disableButton();a.loadData(b);a.openEditView("detail");},openEditView:function(b){var a=this;a.clear();
a.layerIndex=layer.open({type:1,title:"客户投诉",shadeClose:false,btn:["保存","关闭"],area:["50%","60%"],content:$(".csComplainEdit"),scrollbar:false,success:function(c,d){if("detail"==b){$(".layui-layer-btn0").hide();
}else{$(".layui-layer-btn0").show();$("[name=desc]").attr("disabled",false);}$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();
$("select[name=complainId]").select2();$("select[name=followId]").select2();},yes:function(d,c){a._save();},cancel:function(){a.clear();}});},ableButton:function(){$("#csComplainAddForm").find("select").attr("disabled",false);
$("#csComplainAddForm").find("textarea").attr("readonly",false);},disableButton:function(){$("#csComplainAddForm").find("select").attr("disabled",true);
$("#csComplainAddForm").find("textarea").attr("readonly",true);},loadData:function(b){var a=this;FormUtils.loadData(CsComplainAdd._CONS_.EDIT_URL+"?id="+b,function(c){a._fillForm(c);
});},_fillForm:function(b){var a=this;$("#csComplainAddForm").find("[name=complainId]").val(b.complainId);$("#csComplainAddForm").find("[name=soId]").val(b.soId);
$("#csComplainAddForm").find("[name=followId]").val(b.followId);if(b.type!=""){$("#csComplainAddForm").find("[name=type]").val(b.type);}else{$("#csComplainAddForm").find("[name=type]").find("[firstcateid="+b.firstType+"]")[0].selected="selected";
}$("#csComplainAddForm").find("[name=desc]").val(b.desc);$("#csComplainAddForm").find("[name=dealResult]").val(b.dealResult);$("[name=status]").val(b.status);
a.fillOrders(b.soEntityPos,b.soId,b.skuIds);$("select[name=complainId]").select2();$("select[name=followId]").select2();},fillOrders:function(e,d,b){var a=this;
var f=new StringBuffer();f.append("<option value=''>请选择</option>");if(e&&e.length>0){for(var c=0;c<e.length;c++){if(e[c].id==d){f.append("<option value='"+e[c].id+"' selected>"+e[c].soNo+"</option>");
a.fillSkuIds(e[c].soItemPos,b);}else{f.append("<option value='"+e[c].id+"'>"+e[c].soNo+"</option>");}}}$("[name=soId]").empty().append(f.toString());},fillSkuIds:function(d,b){var a=this;
if(d&&d.length>0){var e=new StringBuffer();for(var c=0;c<d.length;c++){if(b.indexOf(d[c].skuId)!=-1){e.append("<option value='"+d[c].skuId+"' selected>"+d[c].prodName+"</option>");
}else{e.append("<option value='"+d[c].skuId+"'>"+d[c].prodName+"</option>");}}$("#skuIdsDiv").empty().append("<select multiple data-placeholder='请选择' class='chosen-select form-control' name='skuIds' ></select>");
$("[name=skuIds]").empty().append(e.toString());$("[name=skuIds]").attr("disabled",true);$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();
}},_initInputAndOption:function(a){CateUtils.getOptions({typeKey:"system",pKey:"ComplainDealResult",container:"dealResult"});ComplainTypeOption.getTypeOption(function(b){$("#csComplainType").append(b);
});$(".addComplain").show();if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(!ResUtils.canShow("csEntity.button.addComplainBtn")){$(".addComplain").hide();
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(!ResUtils.canShow("csEntity.button.addComplainBtnSub")){$(".addComplain").hide();
}}else{if("task"==a.csType){if(!ResUtils.canShow("csEntity.button.addComplainBtnTask")){$(".addComplain").hide();}}else{if("callRecord"==a.csType){if(!ResUtils.canShow("csEntity.button.addComplainBtnCallRecord")){$(".addComplain").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addComplainBtnSearch")){$(".addComplain").hide();}}}}}}}};function CsOrder(){this.hadInit=false;this.params=null;
this.permissionType=null;}CsOrder._CONS_={SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",PLACE_PAGE_URL:ctx+"/ec/salesorder/soEntity/place.htm",COMFIRM_PAGE_URL:ctx+"/ec/salesorder/soEntity/comfirm/comfirm.htm",FOLLOW_PAGE:ctx+"/ec/salesorder/soEntity/toFollow.htm",MERGE_SO_URL:ctx+"/ec/salesorder/soEntity/mergeSo.htm",};
CsOrder.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this.params=a;this.permissionType=a.permissionType;}this._initTable(a);
},_bindEventHander:function(){var a=this;$("body").on("click",".soTab",function(){var f=$(this).attr("attr-csId");if(f){return false;}var g=$(this).attr("attr-id");
var i=$("#csEntityForm").find("[name=name]").val();var e=$(this).attr("value");var d=$(this).attr("attr-placerId");var b=$(this).attr("attr-status");var h=$(this).attr("attr-soType");
var c=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";if("awaiting_post"==b&&d==currentUserId){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.PLACE_PAGE_URL+"?soId="+g,"订单["+e+"]提交");
}else{if("awaiting_comfirm"==b&&ResUtils.canShow("soEntityComfirm.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)&&ResUtils.canShow("soEntity.button.comfirm")){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.COMFIRM_PAGE_URL+"?soId="+g,"订单["+e+"审核");
}else{if("shipping"==b&&ResUtils.canShow("soEntity.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.FOLLOW_PAGE+"?soId="+g+"&soNo="+e,"订单["+e+"]跟进");
}else{JTTabUtils.addOrRefreshTab(CsOrder._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+e+"&canShowScTrankNo="+c,i+"的订单明细");}}}});$("body").on("click",".mergeSo",function(){var e=$(".checkchild:checked");
var b=[];for(var f=0;f<e.length;f++){var d={soNo:$(e[f]).val(),soId:$(e[f]).attr("so-id"),status:$(e[f]).attr("status")};b.push(d);}if(b.length<2){DialogUtils.error(msgCode.FAIL_MSG,"选中的订单必须大于等于2");
return false;}var c=b[0].status;for(var f=1;f<b.length;f++){if(c!=b[f].status){DialogUtils.error(msgCode.FAIL_MSG,"必须是相同状态的订单才能合并");return false;}}a._showMergeSo(b);
});$(document).on("click",".edit_items",function(){var d=window.localStorage.getItem("csOrderTableConfigItems");function c(i){if(!i){return false;}var h=i;
if(typeof i!="object"){h=JSON.parse(i);}var j="";var g=true;$.each(h,function(k,l){if(this.id!="thAll"){j+='<div class="col-sm-3">'+'<div class="checkbox checkbox-success checkbox-inline checkboxDiv">'+'<input type="checkbox" class="columnCheckBox" name="listTitleCheck" data-id="'+this.id+'" '+(this.isShow?'checked="checked"':"")+">"+'<label for="648c21b860f84870822946ac25f06f08">'+this.name+"</label>"+"</div>"+"</div>";
if(!this.isShow&&g){g=false;}}});j='<div class="col-sm-3"><div class="checkbox checkbox-success checkbox-inline checkboxDiv"><input type="checkbox" class="columnCheckBox" data-id="thAll" name="allCheck" data-column="-1" '+(g?'checked="checked"':"")+'><label for="allCheck">全选</label></div></div>'+j;
$("#layListTitle").empty().append(j);}var b=$("#csOrderTable");var f=[];$("#csOrderTable thead tr th").each(function(g,h){if(g!=0&&$(this).text()){f.push({id:$(this).attr("id"),index:g,name:$(this).text(),isShow:true});
}});function e(h,g){$.each(h,function(j,l){var k=this;$.each(g,function(m,n){if(this.name==k.name){k.isShow=this.isShow;return false;}});});}if(typeof d=="string"){e(f,JSON.parse(d));
c(f);}else{c(f);}a.layerIndex=layer.open({type:1,title:"编辑表头",shade:false,btn:["确定","关闭"],area:["51%","53%"],content:$(".listTitleEditDiv"),scrollbar:false,success:function(g,h){},yes:function(i,h){var g=$("#csOrderTable");
var j=[];$("#layListTitle input[type=checkbox]").each(function(m,n){var l={id:$(this).attr("data-id"),name:$(this).next("label").text(),isShow:$(this).prop("checked")};
j.push(l);if(!$(this).prop("checked")){var k=-1;$("#"+l.id).parent().children().each(function(o,p){if($(this).attr("id")==l.id){k=o;$(this).hide();g.find("tbody tr").each(function(q,r){$(this).children().eq(k).hide();
});return false;}});}else{var k=-1;$("#"+l.id).parent().children().each(function(o,p){if($(this).attr("id")==l.id){k=o;$(this).show();g.find("tbody tr").each(function(q,r){$(this).children().eq(k).show();
});return false;}});}});window.parent.localStorage.setItem("csOrderTableConfigItems",JSON.stringify(j));layer.close(a.layerIndex);},on:function(h,g){layer.close(a.layerIndex);
},cancel:function(){layer.close(a.layerIndex);}});});$(document).on("click",".checkboxDiv",function(c){var d=$(this).find('input[type = "checkbox"]');if(!$(c.target).is('input[type = "checkbox"]')){d.trigger("click");
}if(d.attr("name")=="allCheck"){$(".columnCheckBox").each(function(f,g){if($(this).attr("name")!="allCheck"){$(this).prop("checked",d.prop("checked"));
}});}else{var b=true;$(".columnCheckBox").each(function(f,g){if(!$(this).prop("checked")&&$(this).attr("name")!="allCheck"){b=false;return false;}});$("input.columnCheckBox[name='allCheck']").prop("checked",b);
}});},_showMergeSo:function(b){var a=this;a.layerIndex=layer.open({type:1,title:'订单合并<span style="color:red;padding-left:10px;">请谨慎操作，合并后无法恢复</span>',shadeClose:false,btn:["保存","关闭"],area:["30%","40%"],content:$(".mergeSoPanel"),scrollbar:false,success:function(c,d){var f=new StringBuffer();
for(var e=0;e<b.length;e++){f.append("<option value='"+b[e].soNo+"'>"+b[e].soNo+"</option>");}$("#mergeToSo").empty().append(f.toString());},yes:function(d,c){var e=$("#mergeToSo").val();
a._mergeSo(e,b);},cancel:function(){}});},_mergeSo:function(g,f){var b=this;var a=CsOrder._CONS_.MERGE_SO_URL;var e=[];for(var c=0;c<f.length;c++){e.push(f[c].soNo);
}var d=[];for(var c=0;c<f.length;c++){d.push(f[c].soId);}FormUtils.submit(a,{toSo:g,soNos:e,soIds:d},function(h){if(h.success){DialogUtils.success(msgCode.INFO,h.msg);
layer.close(b.layerIndex);b._initTable(b.params);}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);layer.close(b.layerIndex);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_initTable:function(d){var b=this;var c=false;if(type=="self"){if(ResUtils.canShow("csEntity.button.merge")){c=true;}}if(type=="mysub"){if(ResUtils.canShow("csEntity.button.mergeSub")){c=true;
}}if(type=="search"){if(ResUtils.canShow("csEntity.button.mergeSearch")){c=true;}}var a=false;if(d.showThirdSoNo&&"y"==d.showThirdSoNo){a=true;}ConfigUtils.findByKey("soEntity.isReceivePhone",function(l){var e=true;
if(!l.success){e=false;}var i=JSON.parse(window.parent.localStorage.getItem("csOrderTableConfigItems"));function k(m,o){if(m){var n=true;$.each(m,function(p,q){if(this.id==(o+"Th")&&!this.isShow){n=false;
}});return n;}else{return true;}}function j(m){if(m){return"";}else{return"hideColumn";}}function f(m){return"<th id='"+m.id+"' width='"+m.width+"'>"+m.name+"</th>";
}$columns=[{id:"lineNumTh",width:"4%",name:"序号",isShow:true},{id:"soNoTh",width:"6%",name:"订单编号",isShow:true},{id:"originSoIdTh",width:"6%",name:"关联订单",isShow:true},{id:"thirdSoNoTh",width:"6%",name:"外部单号",isShow:true},{id:"scTrackingNoTh",width:"8%",name:"快递单号",isShow:true},{id:"partyNameTh",width:"5%",name:"收件人",isShow:true},{id:"partyAddrTh",width:"6%",name:"收件地址",isShow:true},{id:"partyMaskPhoneTh",width:"6%",name:"收件号码",isShow:true},{id:"totalAmountTh",width:"6%",name:"订单金额",isShow:true},{id:"thirdStoreNameTh",width:"6%",name:"店铺名称",isShow:true},{id:"prodNamesTh",width:"7%",name:"产品名称",isShow:true},{id:"placeTimeTh",width:"6%",name:"下单时间",isShow:true},{id:"completeTimeTh",width:"6%",name:"完成时间",isShow:true},{id:"cashTypeTh",width:"6%",name:"货款方式",isShow:true},{id:"isSplitOrderTh",width:"4%",name:"拆分",isShow:true},{id:"statusTh",width:"4%",name:"状态",isShow:true},{id:"placerNameTh",width:"6%",name:"下单人",isShow:true},{id:"profitsTh",width:"6%",name:"业绩工号",isShow:true},{id:"tranPhoneTh",width:"6%",name:"成交手机编号",isShow:true},{id:"recPhoneTh",width:"6%",name:"收款手机编号",isShow:true}];
var h="<table class='table table-bordered table-stripped' id='csOrderTable'><thead><tr id='csOrderTr'><th width='2%'><button type='button' class='btn btn-default btn-sm edit_items' data-id='csOrderTable'><span class='glyphicon glyphicon-cog ' aria-hidden='true' ></span></button></th>";
$.each($columns,function(m,n){h+=f(this);});h+="</tr></thead></table>";$("#csOrderDiv").empty().append(h);var g=ctx+"/ec/salesorder/soEntity/findByCsId.htm?csId="+d.csId+"&canShowScTrankNo="+b._canShowScTrankNo()+"&canViewPhone="+b._canViewPhone();
$("#csOrderTable").DataTable({ajax:{url:g},searching:false,columns:[{data:"soNoShow",render:function(o,n,m){return"<input type='checkbox'  class='checkchild jt-middle-check' so-id='"+m.id+"'  value='"+m.soNo+"' status ='"+m.status+"' />";
}},{data:"lineNum",className:j(k(i,"lineNum"))},{data:"soNo",className:j(k(i,"soNo")),render:function(o,n,m){if(o!=null&&o!=""){var q=new StringBuffer();
var p="";if(m.baseType=="back"){p="<a href='#' title='"+o+"' class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(退)</a>";
}else{if(m.baseType=="back_before_exchange"){p="<a href='#'  title='"+o+"' class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(退换)</a>";
}else{if(m.baseType=="exchange"){p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"(换)</a>";
}else{if(!m.baseType||m.baseType=="common"){if(m.backExchangeCount){p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"<span style='color:red'>["+m.backExchangeCount+"退换]</span>"+"</a>";
}else{p="<a href='#' title='"+o+"'  class='soTab' value='"+o+"' csIdVal='"+d.csId+"' attr-status='"+m.status+"' attr-placerId='"+m.placerId+"' attr-soType='"+m.soType+"' attr-id='"+m.id+"'>"+o+"</a>";
}}}}}q.append(p);if(m.cashCode){q.append("&nbsp;<span style='color:blue'>券</span>");}if(m.soType=="soSupplementary"){q.append("&nbsp;<span style='color:blue'>(补)</span>");
}return q.toString();}return o;}},{data:"originSoId",render:function(q,p,o){if(o.baseType=="back"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(原)</a>";
return m;}else{if(o.baseType=="back_before_exchange"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(原)</a>";
if(o.linkSoNo){var n="<a title='"+o.linkSoNo+"' href='#' class='soTab' value='"+o.linkSoNo+"' csIdVal='"+d.csId+"'>"+o.linkSoNo+"(换)</a>";return m+" ，"+n;
}else{var n="";return m;}}else{if(o.baseType=="exchange"){var m="<a title='"+o.originSoNo+"' href='#' class='soTab' value='"+o.originSoNo+"' csIdVal='"+d.csId+"'>"+o.originSoNo+"(退换)</a>";
var n="<a title='"+o.linkSoNo+"' href='#' class='soTab' value='"+o.linkSoNo+"' csIdVal='"+d.csId+"'>"+o.linkSoNo+"(原)</a>";return m+"，"+n;}else{if(!o.baseType||o.baseType=="common"){console.log(o.linkSoIdAndType4Common);
}}}}return"";}},{data:"thirdSoNo",bVisible:a,className:j(a&&k(i,"thirdSoNo"))},{data:"scTrackingNo",bVisible:a,className:j(k(i,"scTrackingNo"))},{data:"partyName",bVisible:a,className:j(a&&k(i,"partyName"))},{data:"partyAddr",bVisible:a,className:j(a&&k(i,"partyAddr"))},{data:"partyMaskPhone",bVisible:a,className:j(a&&k(i,"partyMaskPhone"))},{data:"totalAmount",className:j(k(i,"totalAmount"))},{data:"thirdStoreName",bVisible:a,className:j(a&&k(i,"thirdStoreName"))},{data:"prodNames",className:j(k(i,"prodNames"))},{data:"placeTime",className:j(k(i,"placeTime")),render:function(p,o,n){var m="<span title='"+p+"'>"+DateUtils.miniTime(p)+"</span>";
return m;}},{data:"completeTime",className:j(k(i,"completeTime")),render:function(p,o,n){var m="<span title='"+p+"'>"+DateUtils.miniTime(p)+"</span>";return m;
}},{data:"cashType",className:j(k(i,"cashType")),render:function(m,o,n){return SoEntityUtils.formatCashType(m);}},{data:"isSplitOrder",className:j(k(i,"isSplitOrder")),render:function(o,n,m){if(m.isSplitOrder=="y"){return"是";
}else{return"否";}}},{data:"status",className:j(k(i,"status")),render:function(m,o,n){return SoEntityUtils.formatStatus(n);}},{data:"placerName",className:j(k(i,"placerName")),render:function(o,n,m){if(m.placerName.indexOf("null")>-1){return"[已删除]";
}else{return m.placerName;}}},{data:"profits",className:j(k(i,"profits"))},{data:"tranPhone",bVisible:e,className:j(e&&k(i,"tranPhone"))},{data:"recPhone",bVisible:e,className:j(e&&k(i,"recPhone"))}],rowId:"id",lengthMenu:[[20],],fnRowCallback:function(p,o,n,m){if($(".csOrderTable-total-layer").length==0){$("#csOrderTable").after("<div class='csOrderTable-total-layer'>"+(c?"<button class='jt-form-select mergeSo'>合并</button>":"")+"<span style='padding-left:20px;'>总金额(合计)：</span><span id='totalAmountsum'>0</span>"+"</div>");
}if(n==0){addd=0;}addd+=parseFloat(o["totalAmount"]);$("#totalAmountsum").html(addd.toFixed(2)+"(元)");return p;},paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,bSort:false,order:[1,"asc"]});
});},_canShowScTrankNo:function(){var a="cannot";if(this.params.csType){if("self"==this.params.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.showScTrackNo")){a="can";
}}else{if("mysub"==this.params.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.showScTrackNoSub")){a="can";
}}else{if("task"==this.params.csType){if(ResUtils.canShow("csEntity.button.showScTrackNoTask")){a="can";}}else{if("callRecord"==this.params.csType){if(ResUtils.canShow("csEntity.button.showScTrackNoCallRecord")){a="can";
}}else{if(ResUtils.canShow("csEntity.button.showScTrackNoSearch")){a="can";}}}}}}return a;},_canViewPhone:function(){var a="n";if(this.params.csType){if("self"==this.params.csType||(this.permissionType&&"self"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewPhoneBtn")){a="y";
}}else{if("mysub"==this.params.csType||(this.permissionType&&"mysub"==this.permissionType)){if(ResUtils.canShow("csEntity.button.viewPhoneBtnSub")){a="y";
}}else{if("task"==this.params.csType){if(ResUtils.canShow("csEntity.button.viewPhoneBtnTask")){a="y";}}else{if("callRecord"==this.params.csType){if(ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")){a="y";
}}else{if(ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")){a="y";}}}}}}return a;}};var SoEntityUtils={formatStatus:function(e){var b="";var a=e.status;
var d=e.delayConfirmTime;var c=e.delayShipTime;if(a=="awaiting_pay"){b="待支付";}else{if(a=="awaiting_post"){b="待提交";}else{if(a=="awaiting_comfirm"){if(d!=null){b="待审核"+"<span style='color:red;font-size: 8px;'>[延审]</span>";
}else{b="待审核";}}else{if(a=="comfirm"){if(c!=null){b="待发货"+"<span style='color:red;font-size: 8px;'>[延发]</span>";}else{b="待发货";}}else{if(a=="shipping"){b="已发货";
}else{if(a=="complete"){b="已签收";}else{if(a=="close"){b="已作废";}else{if(a=="close_reject"){b="已拒收";}else{if(a=="close_lost"){b="已丢失";}}}}}}}}}return b;},formatCashType:function(b){var a="";
if(b=="pay"){a="款到发货";}else{if(b=="pay_sub"){a="支付订金";}else{if(b=="green"){a="绿色通道";}else{if(b=="green_by"){a="绿色通道订金";}else{if(b=="cod"){a="货到付款";}else{if(b=="free"){a="免费已付";
}else{if(b=="point"){a="积分付款";}}}}}}}return a;},formatPayType:function(b){var a="";if(b=="alipay"){a="支付宝";}else{if(b=="weixin"){a="微信支付";}else{if(b=="weixinhongbao"){a="微信红包";
}else{if(b=="bank"){a="银行转账";}else{if(b=="cash"){a="现金支付";}else{if(b=="point"){a="积分支付";}}}}}}return a;},getTurnBackStr:function(b,a){var c="";switch(b){case"awaiting_post":if(!(a==null||a==""||a=="awaiting_post")){c="&nbsp;<span style='color:red'>撤</span>";
}break;case"awaiting_comfirm":if(!(a=="awaiting_post"||a=="awaiting_comfirm")){c="&nbsp;<span style='color:red'>撤</span>";}break;case"comfirm":if(!(a=="awaiting_post"||a=="awaiting_comfirm"||a=="awaiting_pay"||a=="comfirm")){c="&nbsp;<span style='color:red'>撤</span>";
}break;}return c;},confirm:function(b,a){window.localStorage.setItem("comfirm_"+currentUserId,b.toString());JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_TO_COMFIRM_URL+"?soId="+b[0],"订单["+a+"审核");
},toDeliver:function(a){window.localStorage.setItem("deliver_"+currentUserId,JSON.stringify(a));ConfigUtils.findByKey("soEntity.isEditSaveSo",function(b){if(b.success&&ResUtils.canShow("soEntity.button.saveSoComfirmBtn")){JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+a[0].id,"订单["+a[0].soNo+"发货");
}else{JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a[0].id,"订单["+a[0].soNo+"发货");}});},backDeliver:function(b,a){DialogUtils.confirmWithOptions({title:"确定撤销发货吗？",text:"",confirmButtonText:"确认",yesFunc:function(){var c=SoEntityUtils._CONS_.BACK_DELIVER_URL;
FormUtils.submit(c,{ids:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"撤销发货成功");if(a&&typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},confirmBatch:function(d,c,b){var a=SoEntityUtils._CONS_.COMFIRM_BATCH_URL;FormUtils.submit(a,{ids:d,isRepeatAudit:c,operComment:b,isBatch:"y"},function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}$(".sowait_wrapper").find(".soEntitySearch").click();$(".so_delay_wrapper").find(".soEntitySearch").click();
},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},buildEmployeeOption:function(b,c,d){var a=d?d:"dept_manager";$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm?groupId="+b+"&type="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f&&f.length>0){var g=new StringBuffer();
g.append("<option value=''>请选择</option>");for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}if(c){$("#"+c).empty().append(g.toString());
}else{$("#belongEmployeeSearch").empty().append(g.toString());}}}});},trunDownOrderLayer:function(d,c,b){var a=this;layer.open({type:1,title:"订单驳回",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","450px"],content:$(".soEntityTurnDownPane"),success:function(e,f){var h=new StringBuffer();
for(var g=0;g<c.length;g++){if(g!=0){h.append("，");}h.append("<span style='line-height:30px;'>"+c[g]+"</span>");}$("#trunDownSaveReForm").find(".soNoDiv").empty().append(h.toString());
$("#trunDownSaveReForm").find("#soIds").val(d.toString());(function(){var i=this;$("#trunDownSaveReFormComment").bsSuggest("destroy");$("#trunDownSaveReFormComment").bsSuggest({url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=NotApprovedType",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"驳回备注"},showBtn:false,inputWarnColor:"",showHeader:false,idField:"id",keyField:"name",getDataMethod:"url",processData:function(l){var k,j,m={value:[]};
if(!l||l.records===0){return false;}j=l.length;for(k=0;k<j;k++){m.value.push({id:l[k].id,name:l[k].name});}return m;}});})();},yes:function(g,e){var f=$("#trunDownSaveReForm").find("input[name=trunDownSaveReFormComment]").val();
if(!f){DialogUtils.error("","请选择驳回原因");}else{FormUtils.submit(SoEntityUtils._CONS_.TURN_DOWN_URL,"soIds="+$("#trunDownSaveReForm").find("#soIds").val()+"&comment="+$("input[name=trunDownSaveReFormComment]").val(),function(h){if(h.success){DialogUtils.success(msgCode.INFO,h.msg);
$(".soEntitySearch").click();layer.close(g);if(b&&typeof b==="function"){b();}}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);layer.close(g);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},cancel:function(){FormUtils.clear("trunDownSaveReForm");}});},closeOrderLayer:function(d,c,b){var a=this;layer.open({type:1,title:"订单作废确认",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","450px"],content:$(".soEntityClosePane"),success:function(e,g){var j=new StringBuffer();
for(var h=0;h<c.length;h++){if(h!=0){j.append("，");}j.append("<span style='line-height:30px;'>"+c[h]+"</span>");}$("#closeSaveReForm").find(".soNoDiv").empty().append(j.toString());
$("#closeSaveReForm").find("#soIds").val(d.toString());var f={rules:{closeSaveReFormComment:{required:true,maxlength:["512"],}}};FormUtils.bindFormValidation("closeSaveReForm",f);
},yes:function(f,e){if($("#closeSaveReForm").valid()){FormUtils.submit(SoEntityUtils._CONS_.CLOSE_URL,"soIds="+$("#closeSaveReForm").find("#soIds").val()+"&comment="+$("textarea[name=closeSaveReFormComment]").val()+"&isNeddValid=y",function(g){if(g.success){DialogUtils.success(msgCode.INFO,g.msg);
if(b&&typeof b==="function"){b();}$(".soEntitySearch").click();layer.close(f);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);layer.close(f);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},cancel:function(){FormUtils.clear("closeSaveReForm");}});},submit:function(b,a,c){JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_PLACE_URL+"?soId="+b+"&type=self","订单["+a+"]提交");
},deleteSoEntity:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(SoEntityUtils._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"删除成功");
$(".end_wrapper").find(".soEntitySearch").click();}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},lock:function(c,d,a){var b=this;FormUtils.submit(SoEntityUtils._CONS_.LOCK_URL,"soIds="+c,function(e){if(e.success){$("#soEntityForm").find("[name=isLock]").val("y");
DialogUtils.success(msgCode.INFO,e.msg);if(d){b.reloadJqgrid(d,selectedId);}if(typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},unLock:function(c,d,a){var b=this;FormUtils.submit(SoEntityUtils._CONS_.UNLOCK_URL,"soIds="+c,function(e){if(e.success){$("#soEntityForm").find("[name=isLock]").val("n");
DialogUtils.success(msgCode.INFO,e.msg);if(d){b.reloadJqgrid(d,selectedId);}if(typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},initDetail:function(a){var b=this;$(".csName").attr("readonly",true);$(".changeAddr").hide();
$(".addAddr").hide();$("#prod-price-type").hide();$("#hasStock").parent().hide();$("#searchProd").parents(".form-group").hide();$(".prodPrice").attr("readonly",true);
$(".soItemCount").attr("readonly",true);$("select[name=storeId]").attr("disabled",true);$(".delSoItem").hide();$("select[id=scCode]").attr("disabled",true);
$("select[name=cashType]").attr("disabled",true);$("select[name=isCloudWarehourse]").attr("disabled",true);$("select[name=payType]").attr("disabled",true);
$("select[name=soType]").attr("disabled",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=subAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
$("input[name=waitPayAmount]").attr("readonly",true);$("#selectEmpBtn").hide();$(".soProfitPercent").attr("readonly",true);$(".delSoProfit").hide();$("select[name=isFast]").attr("disabled",true);
$("select[name=billType]").attr("disabled",true);$("input[name=billAmount]").attr("readonly",true);$("textarea[name=billTitle]").attr("readonly",true);
$("textarea[name=billContent]").attr("readonly",true);$("textarea[name=comment]").attr("readonly",true);$("select[name=account]").attr("disabled",true);
$("input[name=shipFollow]").attr("readonly",true);$(".othersDiv").find("#delayConfirmTime").attr("readonly",true);$(".updateSoFollow").hide();if(a&&a.length>0){$(".uploadImage").hide();
$("#imageContainer").empty().append(ImageUtils.createImageDivStr(a,null,true,true,true));var c=b.buildImages(a);$(".downLoadFile").find("img").ImageEnlarge({isNotShowImage:true,imageGroup:c});
}if($("input[name=status]").val()!="shipping"&&$("input[name=status]").val()!="close_lost"){$(".uploadImage").hide();}if($("select[name=cashType]").val()=="cod"||$("select[name=cashType]").val()=="free"||$("select[name=cashType]").val()=="point"){$(".financeAttachDiv").hide();
}ConfigUtils.findByKey("soEntity.isReceivePhone",function(d){if(d.success){$("#receivePhoneDiv").show();$("input[name=tranPhone]").attr("readonly",true);
$("input[name=recPhone]").attr("readonly",true);}else{$("#receivePhoneDiv").hide();}});$(".cashSettingDiv").hide();if($("input[name=cashCode]").val()){$(".cashSettingInfoDiv").show();
}},buildImages:function(b){var a=[];for(var c=0;c<b.length;c++){var d={href:ctx+b[c].path,title:(c+1)+" / "+b.length};a.push(d);}return a;}};SoEntityUtils._CONS_={LIST_URL:ctx+"/ec/salesorder/soEntity/listData.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",SO_TO_COMFIRM_URL:ctx+"/ec/salesorder/soEntity/toComfirm.htm",SO_TO_DELIVER_URL:ctx+"/ec/salesorder/soEntity/toDeliver.htm",BACK_DELIVER_URL:ctx+"/ec/salesorder/soEntity/backDeliver.htm",COMFIRM_BATCH_URL:ctx+"/ec/salesorder/soEntity/comfirm.htm",TURN_DOWN_URL:ctx+"/ec/salesorder/soEntity/turndown.htm",DELETE_URL:ctx+"/ec/salesorder/soEntity/delete.htm",CLOSE_URL:ctx+"/ec/salesorder/soEntity/close.htm",LOCK_URL:ctx+"/ec/salesorder/soEntity/lockSo.htm",UNLOCK_URL:ctx+"/ec/salesorder/soEntity/unLockSo.htm",SO_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",FOLLOW_PAGE:ctx+"/ec/salesorder/soEntity/toFollow.htm",EXCHANGEORBACK_URL:ctx+"/ec/salesorder/soEntity/exchange.htm",BATCHRECEIVED_URL:ctx+"/ec/salesorder/soEntity/batchReceived.htm",BACKRECEIVED_URL:ctx+"/ec/salesorder/soEntity/backReceived.htm",STOCK_MANY_URL:ctx+"/ec/salesorder/soEntity/stockForMany.htm",BACK_COMPLETE_URL:ctx+"/ec/salesorder/soEntity/backComplete.htm",REVISIT_PAGE_URL:ctx+"/ec/salesorder/soEntity/toRevisit.htm",IMPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importSoStatus.htm",FOLLOW:function(a,b){window.localStorage.setItem("follow_so_ids_"+currentUserId,a.toString());
window.localStorage.setItem("follow_so_nos_"+currentUserId,b.toString());JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.FOLLOW_PAGE+"?soId="+a[0]+"&soNo="+b[0],"订单["+b[0]+"]跟进");
}};function CsCallRecord(){this.hadInit=false;}CsCallRecord.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;}this._initTable(a);},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);
};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());},_initTable:function(d){var a=this;var e=new StringBuffer();e.append("<table id='csCallRecordContainer' class='table table-bordered table-stripped'>");
e.append("<thead><tr>");e.append("<th></th>");e.append("<th>方向</th>");e.append("<th>类型</th>");e.append("<th>分机</th>");e.append("<th>工号</th>");e.append("<th>客户号码</th>");
e.append("<th>开始时间</th>");e.append("<th>通话时长</th>");e.append("<th>呼叫时长</th>");e.append("<th>来源</th>");if(showPJ!="hidden"){e.append("<th>评价</th>");}e.append("<th>录音</th>");
e.append("</tr></thead>");e.append("</table>");$("#callRecordDiv").empty().append(e.toString());var b=ctx+"/gl/cti/tRKSheetRecord/findByCsId.htm?csId="+d.csId;
var c=[{data:"lineNum"},{data:"direction",render:function(g,f,h){if(g==0){return"<label class='label label-success'>呼出</label>";}else{if(g==1){return"<label class='label label-primary'>呼入</label>";
}}}},{data:"isrouteagent",render:function(h,f,g){if(!g.recfile){return"<label class='label label-danger'>未接</label>";}else{return"<label class='label label-primary'>已接</label>";
}}},{data:"adn"},{data:"agentid",render:function(h,g,f){if(h!=-1){return f.employeeAid+":"+f.employeeName;}else{return"-1";}}},{data:"csPhone"},{data:"begtime"},{data:"duration",render:function(g,f,h){if(h.recfile){return DateUtils.toChineseTime(g);
}else{return"";}}},{data:"ringduration",render:function(h,f,g){if(!g.recfile){return DateUtils.toChineseTime(g.duration);}else{return"";}}},{data:"source",}];
if(showPJ!="hidden"){c.push({data:"uud",render:function(g,f,h){if(!g){return"无";}if(g.indexOf("PJ:1")!=-1){return"满意";}else{if(g.indexOf("PJ:2")!=-1){return"一般";
}else{if(g.indexOf("PJ:3")!=-1){return"不满意";}}}return"无";}});}c.push({data:"recfile",render:function(i,h,j){if(i){var k=new StringBuffer();var f=a._generateCode();
var g=j?j.recordid:"";if(d.csType){if("self"==d.csType||(d.permissionType&&"self"==d.permissionType)){if(ResUtils.canShow("csEntity.button.listenCall")){k.append("<button  id-value ='"+g+"' uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordTranslate")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.downloadCall")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCall")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecomm")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordHiCall")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.viewCall")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.scoreCall")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}else{if("mysub"==d.csType||(d.permissionType&&"mysub"==d.permissionType)){if(ResUtils.canShow("csEntity.button.listenCallSub")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordTranslateSub")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.downloadCallSub")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCallSub")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecommSub")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordHiCallSub")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.viewCallSub")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.scoreCallSub")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}else{if("task"==d.csType){if(ResUtils.canShow("csEntity.button.listenCallTask")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
if(ResUtils.canShow("csEntity.button.operateRecordTranslateTask")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}}if(ResUtils.canShow("csEntity.button.downloadCallTask")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCallTask")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecommTask")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordHiCallTask")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.viewCallTask")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.scoreCallTask")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}else{if("callRecord"==d.csType){if(ResUtils.canShow("trkSheetRecord.button.listen")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordTranslate")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.download")){k.append("<button  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCall")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecomm")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.operateRecordHi")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.view")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("trkSheetRecord.button.score")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}else{if(ResUtils.canShow("csEntity.button.listenCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
if(ResUtils.canShow("csEntity.button.operateRecordTranslateSearch")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}}if(ResUtils.canShow("csEntity.button.downloadCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCallSearch")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-bookmark'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecommSearch")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-up'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordHiCallSearch")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.viewCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.scoreCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}}}}}else{if(ResUtils.canShow("csEntity.button.listenCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='试听' recfileVal='"+i+"' class='listenBtn btn btn-xs btn-primary'><i class='fa fa-caret-square-o-left'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordTranslateSearch")){k.append("<button title='翻译' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordTrans2WordBtn btn btn-xs btn-primary'><i class='fa fa-language'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.downloadCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='下载' recfileVal='"+i+"' class='downloadBtn btn btn-xs btn-primary'><i class='fa fa-download'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordMarkCallSearch")){k.append("<button title='标识' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordMarkBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordRecommSearch")){k.append("<button title='推荐' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordShareBtn btn btn-xs btn-primary'><i class='fa fa-thumbs-o-upi></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.operateRecordHiCallSearch")){k.append("<button title='操作记录' uniqueCode='"+f+"' id-value ='"+g+"' recfileVal='"+i+"' class='operateRecordHiBtn btn btn-xs btn-primary'><i class='fa fa-list'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.viewCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='记录' recfileVal='"+i+"' class='recordBtn btn btn-xs btn-primary'><i class='fa fa-file-text'></i></button>&nbsp;&nbsp;");
}if(ResUtils.canShow("csEntity.button.scoreCallSearch")){k.append("<button  id-value ='"+g+"'  uniqueCode='"+f+"' title='评分' recfileVal='"+i+"' class='evaluateBtn btn btn-xs btn-primary'><i class='fa fa-star'></i></button>");
}}return k.toString();}else{return"";}}});$("#csCallRecordContainer").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,ordering:true,order:[[6,"desc"]]});
}};function CsEav(){this.eavCommon=null;this.eavTag=null;this.csEavTag=null;}CsEav.prototype={init:function(){var b={bizType:"common",entityType:"jt_cs_entity",eavSetKey:"customer",containerId:"eavCommonContainer"};
this.eavCommon=new Eav(b);var a={bizType:"tag",entityType:"cs",eavSetKey:"cs_tag",isShowTag:true,containerId:"tagContainer"};this.eavTag=new Eav(a);this._bindEventHander();
},_bindEventHander:function(){var a=this;if(!isNewPage){$(document).on("click",".tabView",function(){$("#tagTableContainer").hide();$("#tagContainer").slideDown();
$(".tabView").attr("disabled",true);$(".shrinkView").attr("disabled",false);$(".csTagDown").animate({top:["0px","swing"]},250);$(".csTagUp").animate({top:["-25px","swing"]},250);
});$(document).on("click",".shrinkView",function(){$("#tagContainer").hide();$("#tagTableContainer").slideDown();$(".tabView").attr("disabled",false);$(".shrinkView").attr("disabled",true);
$(".csTagDown").animate({top:["0","swing"]},250);$(".csTagUp").animate({top:["-25px","swing"]},250);});}$(document).on("click",".csTagUp",function(){$(this).animate({top:["-25px","swing"]},250);
$(this).prev().animate({top:["0px","swing"]},250);$("#tagContainer").slideUp();$("#tagTableContainer").slideUp();});$(document).off("click",".csTagAddFollow").on("click",".csTagAddFollow",function(){layer.close(a.layerIndex);
var b=$(this);a.layerIndex=layer.open({type:1,title:"跟进记录",shade:false,btn:["保存","关闭"],area:["650px","400px"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,success:function(c,d){$("#csFollowForm").find("[name=type]").val("档案情况跟进");
var e="【"+b.attr("attrVal")+"】档案属性："+b.attr("optVal")+"。提醒内容：";if(b.attr("contentval")){e="【"+b.attr("attrVal")+"】档案属性："+b.attr("optVal")+"。档案记录："+b.attr("contentval")+"。提醒内容：";
}$("#csFollowForm").find("[name=content]").val(e);$("#csFollowForm").find('input[name="hasTask"][value="n"]').trigger("click");},yes:function(d,c){$("#csFollowForm").find(".saveAddFollow").trigger("click");
layer.close(a.layerIndex);}});});$(document).on("click",".uploadImage",function(){$("#recordUploader").show();var b=new UploadImageUtil();b._bindWebuploader();
});},loadDataEavCommon:function(b){var a=this;a.eavCommon.setEavSetKey(CsEntityEdit._CONS_.CUSTOMER_EAV_KEY);a.eavCommon.setEntityId(b.csId);a.eavCommon.renderEavForm(function(){var c=$("#eavCommonContainer");
var d=c.find(".form-group");$.each(d,function(g,e){var f=$(this).children("div");});if(b.isDetail){c.find("input").attr("disabled",true);c.find("button").hide();
c.find("select").attr("disabled",true);}});},loadDataEavTag:function(c,b){var a=this;a.eavTag.setEntityId(c.csId);a.eavTag.renderEavForm(function(e){var f=$("#tagContainer");
f.find("form legend").remove();if(c.isDetail){f.find("input").attr("disabled",true);f.find("button").hide();f.find("select").attr("disabled",true);}var d=$("#tagTableContainer");
a.eavTag.createCsEavTable(e,d);if(b){b();}});},getEavInfoParams:function(){return this.eavCommon.getEavParams();},getEavTagParams:function(){return this.eavTag.getEavParams();
},};function CsAccount(){this.hadInit=false;}CsAccount._CONS_={EDIT_URL:ctx+"/crm/cs/csAccount/edit.htm",DETAIL_URL:ctx+"/crm/cs/csAccount/detail.htm",DELETE_URL:ctx+"/crm/cs/csAccount/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/csAccount/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csAccount/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/csEntity/findAccountByCsId.htm",EDIT_FORM_ID:"csAccountForm",GRID:"#csAccountGrid",PAGER:"#csAccountPager",GRID_ID:"csAccountGrid",PAGER_ID:"csAccountPager"};
CsAccount.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;}this._initTable(a);},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(CsAccount._CONS_.EDIT_FORM_ID);FormUtils.enableForm(CsAccount._CONS_.EDIT_FORM_ID);
if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(CsAccount._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(CsAccount._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=csId]").val(c.csId);
$("input[name=accountType]").val(c.accountType);$("input[name=account]").val(c.account);$("input[name=comment]").val(c.comment);$("input[name=createTime]").val(c.createTime);
$("input[name=updateTime]").val(c.updateTime);});},_save:function(){var b=this;var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=CsAccount._CONS_.SAVE_EDIT_URL;
}else{a=CsAccount._CONS_.SAVE_ADD_URL;}if($("#csAccountForm").valid()){ButtonUtils.disableBtn("saveBtn");FormUtils.submitByFormId(a,CsAccount._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");
if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(CsAccount._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$("#"+CsAccount._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+CsAccount._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+CsAccount._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".csAccountSearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$(".toolbar-panel").on("keypress","form",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$("body").on("click",".csAccountAdd",function(){a._add();});$("body").on("click",".csAccountEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(CsAccount._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".csAccountDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(CsAccount._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".csAccountDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(CsAccount._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(CsAccount._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(CsAccount._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("csAccount.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger csAccountDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("csAccount.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary csAccountEdit",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("csAccount.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary csAccountDetail",iconClasses:"fa fa-detail"});
}return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$("#csAccountGridDiv").empty().append('<table id="'+CsAccount._CONS_.GRID_ID+'"></table>                <div id="'+CsAccount._CONS_.PAGER_ID+'"></div>');
$(CsAccount._CONS_.GRID).jqGrid({datatype:"json",url:ctx+"/crm/cs/csEntity/searchAccount.htm?Q__S__EQ__cs_id_="+a.csId,height:200,width:$("."+a.widthWId).width(),shrinkToFit:true,rowNum:10,mtype:"POST",viewrecords:false,multiselect:false,rownumbers:true,pager:CsAccount._CONS_.PAGER,colNames:["账户类型","账号","描述"],colModel:[{name:"accountType",index:"account_type_",width:150,formatter:function(b,d,e){var c=e.accountType;
if(e.accountType=="alipay"){c="支付宝";}else{if(e.accountType=="weixin"){c="微信支付";}else{if(e.accountType=="bank"){c="银行转账";}}}return c;}},{name:"account",index:"account_",width:200},{name:"comment",index:"comment_",width:200}],gridComplete:function(){var b=$(CsAccount._CONS_.GRID).jqGrid("getGridParam","records");
if(b<=0){if($(CsAccount._CONS_.GRID).parent().find(".norecords").html()==null){$(CsAccount._CONS_.GRID).parent().append('<div class="norecords">没有符合数据！</div>');
$(CsAccount._CONS_.GRID).parent().find(".norecords").show();}else{$(CsAccount._CONS_.GRID).parent().find(".norecords").show();}}else{$(CsAccount._CONS_.GRID).parent().find(".norecords").hide();
}},});$(window).bind("resize",function(){var b;if(a.widthWId){b=$("."+a.widthWId).width();}else{b=$(".jqGrid_wrapper").width();}$(CsAccount._CONS_.GRID).setGridWidth(b);
});},_initTable:function(c){var a=this;$("#csAccountDiv").empty().append("<table class='table table-striped table-bordered' id='csAccountTable'><thead><tr><th>账户类型</th><th>账号</th><th>描述</th></tr></thead></table>");
var b=CsAccount._CONS_.LIST_DATA_URL+"?csId="+c.csId;$("#csAccountTable").DataTable({ajax:{url:b},columns:[{data:"accountType",render:function(g,f,e){var d=g;
if(g=="alipay"){d="支付宝";}else{if(g=="weixin"){d="微信支付";}else{if(g=="bank"){d="银行转账";}}}return d;},width:"30%"},{data:"account",width:"30%"},{data:"comment",width:"40%"}],rowId:"id",lengthMenu:[[5,10],[5,10]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"desc"]]});
}};function CsPhone(){this.hadInit=false;}CsPhone._CONS_={FIND_PHONES_URL:ctx+"/crm/cs/csEntity/findPhonesByCsId.htm",FIND_CS_BY_PHONE:ctx+"/crm/cs/csEntity/getByPhone.htm",GET_PHONE_AREA:ctx+"/crm/cs/csPhoneArea/getArea.htm",VALID_PHONE:ctx+"/crm/cs/csEntity/validPhoneIsUsed.htm",DELETE_PHONE:ctx+"/crm/cs/csEntity/deletePhone.htm",};
CsPhone.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindEventHandler();}},_bindEventHandler:function(){var a=this;$(".showInvalidPhone").on("click",function(){$(this).hide();
$(".hideInvalidPhone").show();$("#invalidPhoneNumDiv").show();});$(".hideInvalidPhone").on("click",function(){$(this).hide();$(".showInvalidPhone").show();
$("#invalidPhoneNumDiv").hide();});$(document).on("click",".addCsPhone",function(){$("#phoneNumDiv").append(a.genNewTemplate());});$("#phoneNumDiv").on("click",".removePhone",function(){$(this).parents(".form-group").remove();
});$("#phoneNumDiv").on("click",".makePhone",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;}$(".makePhone").addClass("BtnFlag");
$(".makePhoneAddZero").addClass("BtnFlag");}var f=$(this).attr("attr-num");var d=new Date().getTime()+"";var c="";var g=JTEncoder.encode(f);var e=JTEncoder.encode(f+c+d);
var b=CryptoUtils.encrypt(g+e,f,d);var h={number:f,encoder1:g,encoder2:e,checkCode:b,randomCode:d,};if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");
$(".makePhoneAddZero").removeClass("BtnFlag");},5000);}});$("#phoneNumDiv").on("click",".makePhoneAddZero",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;
}$(".makePhone").addClass("BtnFlag");$(".makePhoneAddZero").addClass("BtnFlag");}var b=$(this).attr("attr-num");var c=/^(((1[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{9})$/;
FormUtils.loadData(CsPhone._CONS_.CALL_PHONE_URL+"?number="+b,function(e){var d=e.msg.toString();if(d.startsWith("020")){b=d.substring(3);}else{b=d;}if(c.test(b)){window.top.jtCtiService.dialout("90"+b);
}else{window.top.jtCtiService.dialout("9"+b);}});if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");$(".makePhoneAddZero").removeClass("BtnFlag");
},5000);}});$("#phoneNumDiv").on("click",".sendMessage",function(){var f=this;var c=$("#csEntityForm").find("[name=id]").val();var d=new SendMessage();
var e=$(f).attr("attr-num");if(!e){e=$(f).parent().parent().parent().parent().find(".newPhone").val();var b={csId:c,number:e,maskNum:e,fn:function(g){d.initTable({csId:g});
}};d.openSendMessageView(b);}else{var b={csId:c,number:e,maskNum:$(f).attr("attr-maskNum"),fn:function(g){d.initTable({csId:g});}};d.openSendMessageView(b);
}});$("#phoneNumDiv").on("click",".viewPhone",function(){var c=this;var b=$(this).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DECRYPT_NUMBER_URL+"?number="+b,function(e){var d=e.msg;
$(c).parent().parent().parent().find(".oldPhone").val(d);});});$(document).on("blur",".newPhone",function(){var e=this;var c=$(e).val();var d=$(e).parent().next().find("select").val();
$(e).parents(".form-group").eq(0).find("p").text("").hide();$(e).parents(".form-group").eq(0).find(".tip").text("").hide();if(c){if(a._checkIsPhone(c,d)){a._getPhoneArea(c,function(f){$(e).parents(".form-group").eq(0).find(".tip").css("color","green").text(f.province+f.city).show();
});a.findCsByPhone(c,function(g){if(g&&g.success){var h=JSON.parse(g.msg);var f="号码重复，客户["+h.code+"]已拥有该号码";$(e).parents(".form-group").eq(0).find("p").text(f).show();
}});}else{if(d=="座机"){if(!a._checkIsTel(c)){var b="座机号格式错误";$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text(b).show();}}else{$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text("非手机类型请选座机").show();
}}}});$(document).on("change",".phoneType",function(){$(this).attr("attr-hasChange","true");var b=$(this).parent().prev().find(".newPhone");if(b){b.trigger("blur");
}});$("#phoneNumDiv").on("click",".deletePhone",function(){var b=this;DialogUtils.confirmWithOptions({title:"是否要删除选中的联系电话",text:"点击确认将删除，并无法恢复",confirmButtonText:"确认",yesFunc:function(){var c=$("#csEntityForm").find("[name=id]").val();
var d=$(b).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DELETE_PHONE+"?number="+d+"&csId="+c,function(e){if(e.success){DialogUtils.success("成功","删除号码成功");
$(b).parents(".form-group").remove();}else{DialogUtils.error("失败","删除号码失败");}});}});});},_getTypeSelectStr:function(a,c){var b=this;var d=new StringBuffer();
d.append("<select class='form-control phoneType' "+(a?" disabled='disabled'":"''")+">");if(c&&"首选"==c){d.append("<option value='首选' selected>首选</option>");
}else{d.append("<option value='首选'>首选</option>");}if(c&&"停用"==c){d.append("<option value='停用' selected>停用</option>");}else{d.append("<option value='停用'>停用</option>");
}if(c&&"本人"==c){d.append("<option value='本人' selected>本人</option>");}else{d.append("<option value='本人'>本人</option>");}if(c&&"老公"==c){d.append("<option value='老公' selected>老公</option>");
}else{d.append("<option value='老公'>老公</option>");}if(c&&"老婆"==c){d.append("<option value='老婆' selected>老婆</option>");}else{d.append("<option value='老婆'>老婆</option>");
}if(c&&"家人"==c){d.append("<option value='家人' selected>家人</option>");}else{d.append("<option value='家人'>家人</option>");}if(c&&"他人"==c){d.append("<option value='他人' selected>他人</option>");
}else{d.append("<option value='他人'>他人</option>");}if(c&&"朋友"==c){d.append("<option value='朋友' selected>朋友</option>");}else{d.append("<option value='朋友'>朋友</option>");
}if(c&&"座机"==c){d.append("<option value='座机' selected>座机</option>");}else{d.append("<option value='座机'>座机</option>");}d.append("</select>");return d.toString();
},_getCsPhoneButtonStr:function(c){var e=new StringBuffer();if("actived"==c.status){var d=ctx+"/img/jt/phone.png'";var a=ctx+"/img/jt/phoneAddZero.png";
var b=ctx+"/img/jt/message.png";e.append("<div class='col-sm-4' style='display: inline;'>");if(ResUtils.canShow("csEntity.button.deletePhone")||ResUtils.canShow("csEntity.button.deletePhoneSub")||ResUtils.canShow("csEntity.button.deletePhoneSearch")||ResUtils.canShow("csEntity.button.deletePhoneTask")){e.append("<span style='line-height:30px;''><i class='fa fa-remove deletePhone' title='删除号码'' style='color: red; cursor: pointer;'' attr-num='"+c.number+"' ></i></span>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneBtn")||ResUtils.canShow("csEntity.button.callPhoneBtnSub")||ResUtils.canShow("csEntity.button.callPhoneBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='本地号码' src='"+d+"' class='makePhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneAddZeroBtn")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSub")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='外地号码加0' src='"+a+"' class='makePhoneAddZero' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.sendMsgBtn")||ResUtils.canShow("csEntity.button.sendMsgBtnSub")||ResUtils.canShow("csEntity.button.sendMsgBtnSearch")||ResUtils.canShow("csEntity.button.sendMsgBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='短信' src='"+b+"' class='sendMessage' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if((ResUtils.canShow("soDeliver.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtnSub")||ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")||ResUtils.canShow("csEntity.button.viewPhoneBtnTask"))&&c.number){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='查看联系电话明文' src='"+ctx+"/img/jt/view.png' class='viewPhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>");
}e.append("</div>");}else{e.append("<span class='col-sm-3' style='color:red;line-height:30px;'>无效号码</span>");}return e.toString();},initTemplate:function(b){var a=this;
var c=new StringBuffer();c.append("<div class='form-group'>");c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control oldPhone' attr-id='"+b.id+"' validateType='default' value='"+b.maskPhone+"' readonly>");
c.append("<input type='hidden' value='"+b.number+"' readonly>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr("actived"!=b.status,b.type));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genInTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control' validateType='default' value='"+a.maskPhoneNum(b.phone)+"' readonly>");
c.append("<input type='hidden' readonly class='newPhone' value='"+b.phone+"'>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-1' style='color:red;line-height:30px;'>通话</span>");c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genNewTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control newPhone' validateType='default' value=''>");
c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));c.append("</div>");if(!b){c.append("<span class='col-sm-1' style='line-height:30px;'><i class='fa fa-remove removePhone' title='删除号码' style='color: red; cursor: pointer;'></i></span>");
}c.append("<span class='col-sm-3 tip' style='line-height:30px;'></span>");if(b){c.append("<div class='col-sm-1'>");c.append("<button type='button' class='btn btn-sm btn-outline btn-primary addCsPhone'>添加</button>");
c.append("</div>");}c.append("</div>");c.append("</div>");c.append("<p class='ceshi' style='color:red;display:none;'></p>");return c.toString();},csPhoneData2Json:function(){var f=$(".newPhone");
var h=$(".oldPhone");var c=[];if(f&&f.length>0){for(var d=0;d<f.length;d++){if($(f[d]).val()){var e=$(f[d]).parent().next().find("select").val();var g=$.trim($(f[d]).val());
var b=$(f[d]).parent().next().next().find("input").val();if(e=="座机"&&g.indexOf("&")>-1){g=g.substr(0,g.indexOf("&"));}var a={id:"",pk:"",phone:g,type:e,linkman:b};
c.push(a);}}}if(h&&h.length>0){for(var d=0;d<h.length;d++){var e=$(h[d]).parent().next().find("select").val();var g=$(h[d]).next().val();var b=$(f[d]).parent().next().next().find("input").val();
if("true"==$(h[d]).parent().next().find("select").attr("attr-hasChange")){var a={id:$(h[d]).attr("attr-id"),pk:$(h[d]).attr("attr-id"),phone:"",number:g,type:e,linkman:b};
c.push(a);}}}return JSON.stringify(c);},bindFormValidation:function(){var a={rules:{"phone":{required:true,mobile:true,maxlength:["20"],}}};FormUtils.bindFormValidation("csPhoneAdd",a);
},maskPhoneNum:function(a){if(a){return PhoneEncryptUtils.encryptPhone(a);}return"";},loadData:function(b){var a=this;FormUtils.loadData(CsPhone._CONS_.FIND_PHONES_URL+"?csId="+b.csId,function(f){var e=new StringBuffer();
var d=new StringBuffer();if(f&&f.length>0){for(var c=0;c<f.length;c++){if("actived"==f[c].status){e.append(a.initTemplate(f[c])+"");$("#csFollowForm").find("input[name='csFollowPhone']").val(f[c].number);
}else{d.append(a.initTemplate(f[c],false)+"");}}}$("#phoneNumDiv").empty().append(e.toString());$("#phoneNumDiv").append(a.genNewTemplate(true));$("#invalidPhoneNumDiv").empty().append(d.toString());
if(d.toString().length>0){$(".showInvalidPhone").show();}else{$(".showInvalidPhone").hide();}if(b.fn&&typeof b.fn=="function"){b.fn();}},function(){},true);
},_checkIsPhone:function(a,c){if(c&&("微信"==c)){return true;}if(c&&("座机"==c)){return false;}var b=/^(1+\d{10})$/;if(b.test(a)){return true;}return false;
},_checkIsTel:function(a,c){if(c!="座机"&&c!=undefined){return false;}if(a.length<=6){return false;}else{if(a.startsWith("0")){return true;}else{if(isCheckQuhao&&isCheckQuhao=="y"){var b=/(^[0-9]*)$/;
if(b.test(a)){return true;}return false;}else{return true;}}}},_descryptPhoneNum:function(a,c,b){$.ajax({type:"GET",url:CsPhone._CONS_.DESCRYPT_PHONE_NUM+"?number="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success&&b&&typeof b=="function"){b(d.msg);
}}});},findCsByPhone:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.FIND_CS_BY_PHONE+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(b&&typeof b=="function"){b(c);
}}});},_getPhoneArea:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.GET_PHONE_AREA+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success){if(b&&typeof b=="function"){var c=JSON.parse(d.msg);
b(c);}}}});},vaildPhondIsUsed:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.VALID_PHONE+"?phones="+a.toString(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c.success){b();
}else{DialogUtils.error("错误","新增的手机号码重复");}}});},};function PointLog(){this.hadInit=false;}PointLog._CONS_={LIST_DATA_URL:ctx+"/crm/cs/csEntity/findPointLogs.htm",SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",PLACE_PAGE_URL:ctx+"/ec/salesorder/soEntity/place.htm",COMFIRM_PAGE_URL:ctx+"/ec/salesorder/soEntity/comfirm/comfirm.htm",FOLLOW_PAGE:ctx+"/ec/salesorder/soEntity/toFollow.htm",};
PointLog.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;}this._bindEventHander();this.initTable(a);},_bindEventHander:function(){var a=this;
$(document).on("click",".pointLogSoDetail",function(){var d=$("#csEntityForm").find("[name=name]").val();var c=$(this).attr("value");var b=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";
JTTabUtils.addOrRefreshTab(PointLog._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+c+"&canShowScTrankNo="+b,d+"的订单明细");});},initTable:function(d){var a=this;var e=new StringBuffer();
e.append("<table class='table table-striped table-bordered' id='pointLogTable'>");e.append("<thead><tr>");e.append("<th>序号</th>");e.append("<th>类型</th>");
e.append("<th>订单编号</th>");e.append("<th>订单状态</th>");e.append("<th>订单金额</th>");e.append("<th>数量</th>");e.append("<th>说明</th>");e.append("<th>创建时间</th>");
e.append("</tr></thead>");e.append("</table>");$("#pointLogDiv").empty().append(e.toString());var c=PointLog._CONS_.LIST_DATA_URL;var b=$("#id").val();
c=c+"?csId="+d.csId;$("#pointLogTable").DataTable({ajax:{url:c},columns:[{data:"lineNum",width:"6%"},{data:"type",render:function(h,g,f){if("point_get"==f.type){return"新增";
}else{if("point_use"==f.type){return"消费";}}},width:"8%"},{data:"soNo",width:"8%",render:function(h,g,f){if(h!=null&&h!=""){return"<a href='#' class='pointLogSoDetail' value='"+h+"'>"+h+"</a>";
}return h;}},{data:"soStatus",width:"8%",render:function(f,h,g){return SoEntityUtils.formatStatus(f);}},{data:"soTotal",width:"8%"},{data:"count",width:"8%",render:function(h,g,f){if("point_get"==f.type){return f.count;
}else{if("point_use"==f.type){return f.count*-1;}}},},{data:"comment",width:"40%"},{data:"createTime",width:"14%"},],rowId:"id",lengthMenu:[[20],],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false,});
}};function CsContract(){this.hadInit=false;}CsContract._CONS_={EDIT_URL:ctx+"/crm/contract/contractEntity/edit.htm",DETAIL_URL:ctx+"/crm/contract/contractEntity/detail.htm",DELETE_URL:ctx+"/crm/contract/contractEntity/delete.htm",SAVE_ADD_URL:ctx+"/crm/contract/contractEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/contract/contractEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/contract/contractEntity/listData.htm",GRID_ID:"csContractGrid",PAGER_ID:"csContractPager",GRID:"#csContractGrid",PAGER:"#csContractPager"};
CsContract.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;}this._initJqgrid(a);},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$("#fileContainer").empty();$("#skuContainer").empty();$("#employeeContainer").empty();
$("input[name='cno']").val("").attr("placeholder","系统生成");$(".nav.nav-tabs").find("li").removeClass("active");$(".tab-content").find(".tab-pane").removeClass("active");
$(".nav.nav-tabs").find("li:eq(0)").addClass("active");$("#tab-0").addClass("active");SummernoteUtils.setCode("","summernote");a.commonEav.setEntityId("");
a.commonEav.clear();$("#selectSkuBtn").removeAttr("disabled");$("#selectFileBtn").removeAttr("disabled");$("#selectEmployeeBtn").removeAttr("disabled");
$("#selectCustomerBtn").removeAttr("disabled");FormUtils.clear(CsContract._CONS_.EDIT_FORM_ID);FormUtils.enableForm(CsContract._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();
}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_add:function(){},_edit:function(a){},_detail:function(a){},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(CsContract._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(CsContract._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("contractEntity.button.add")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger contractEntityAdd",iconClasses:"fa fa-add"});
}if(ResUtils.canShow("contractEntity.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary contractEntityEdit",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("contractEntity.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary contractEntityDetail",iconClasses:"fa fa-list"});
}return a;},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}$("#csContractGridDiv").empty().append('<table id="'+CsContract._CONS_.GRID_ID+'"></table>                <div id="'+CsContract._CONS_.PAGER_ID+'"></div>');
$.jgrid.defaults.styleUI="Bootstrap";$(CsContract._CONS_.GRID).jqGrid({datatype:"json",url:CsContract._CONS_.LIST_DATA_URL+"?Q__S__EQ__cs_id_="+b.csId,height:200,width:$("."+b.widthWId).width(),shrinkToFit:true,rowNum:10,mtype:"POST",viewrecords:false,multiselect:false,rownumbers:true,pager:CsContract._CONS_.PAGER,colNames:["编号","金额","类型","付款方式","签约日期","状态",],colModel:[{name:"cno",index:"cno_",width:100},{name:"total",index:"total_",width:100},{name:"typeName",index:"type_",width:100,sortable:false},{name:"payTypeName",index:"pay_type_",width:100,classes:"autoHideCol"},{name:"signTime",index:"sign_time_",width:120,formatter:function(c){return c.substring(0,10);
}},{name:"statusName",index:"status_",width:100,formatter:function(c){return"<label class='label label-primary'>"+c+"</label>";}}],gridComplete:function(){var c=$(CsContract._CONS_.GRID).jqGrid("getGridParam","records");
if(c<=0){if($(CsContract._CONS_.GRID).parent().find(".norecords").html()==null){$(CsContract._CONS_.GRID).parent().append('<div class="norecords">没有符合数据！</div>');
$(CsContract._CONS_.GRID).parent().find(".norecords").show();}else{$(CsContract._CONS_.GRID).parent().find(".norecords").show();}}else{$(CsContract._CONS_.GRID).parent().find(".norecords").hide();
}},});$(window).bind("resize",function(){var c;if(b.widthWId){c=$("."+b.widthWId).width();}else{c=$(".jqGrid_wrapper").width();}$(CsContract._CONS_.GRID).setGridWidth(c);
});},};function EmployeesSelect(){}EmployeesSelect.prototype={init:function(b){var c=ctx+"/crm/ou/employee/selectEmployee.htm";var e=new StringBuffer();
for(var a in b){if(a!="callBack"){e.append("&"+a+"="+b[a]);}else{window.myCallBack=b.callBack;}}e.append("&treeNodeType=group");var d=e.toString();parent.layer.open({type:2,title:b.title?b.title:"选择员工",maxmin:false,shadeClose:true,btn:["确定","取消"],area:["85%","83%"],scrollbar:false,content:c+"?1=1"+d,success:function(f,g){f.myCallBack=b.callBack;
},end:function(){window.parent.myCallBack=null;},yes:function(j,g){var f=parent.layer.getChildFrame("body",j);var l=[];if(b&&b.isMultiple==1){var l=$("#employeeGrid",f).jqGrid("getGridParam","selarrrow");
}else{var n=$("#employeeGrid",f).jqGrid("getGridParam","selrow");if(n){l.push(n);}}if(l.length<0){DialogUtils.error(msgCode.ERROR,"请选择员工",f);return;}var m=[];
for(var k=0;k<l.length;k++){var h=$("#employeeGrid",f).jqGrid("getRowData",l[k]);h.id=l[k];m.push(h);}if(b.callBack){b.callBack(m);}parent.layer.close(j);
}});},initSelectComponent:function(a){function b(c){var d=null;if(c.container){if((typeof c.container)=="string"){d=$("#"+c.container);if(d.length==0){d=$("."+c.container);
if(d.length==0){d=$("[name='"+c.container+"']");if(d.length==0){d=null;throw Error(c.container+"容器不存在");}}}}else{if(c.container.length){d=c.container;}}}return d;
}FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+a.groupId+"",function(g){if(a.fn){a.fn(g);return;}var c=b(a);c.empty();if(a.buildSelector){var d='<select class="form-control '+a.buildSelector.className+'" name="'+a.buildSelector.name+'" ></select>';
var f=$(d);c.append(f);c=f;}var h=new StringBuffer();h.append("<option value=''>请选择</option>");if(g&&g.length){for(var e=0;e<g.length;e++){if(a.selectedIds&&a.selectedIds.indexOf(g[e].id)>-1){h.append("<option selected='selected' value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");
}else{h.append("<option value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");}}}c.append(h.toString());if("chosen"==a.containerType){c.chosen("destroy");
c.chosen();}else{c.select2();}},null,true);},};var GroupUtils={loadGroupOptions:function(a){a.url=ctx+"/gl/ou/group/listData.htm";if(!a.positionType){a.url=a.url+"?type=dept_manager";
}a.key="id";a.keyName="name";a.caption="请选择部门";return OptionsBaseUtils.getOptions(a);},selectGroupTreeBox:function(a){var b={selectedIds:jQuery.isArray(a.selectedGroupId)?a.selectedGroupId.toString():a.selectedGroupId,container:a.container,treeId:"menuContentForGroup"+a.container.split(" ")[0],isMultiple:a.isMultiple,otherParam:{selectedGroupId:a.selectedGroupId},url:ctx+"/gl/ou/group/listData.htm",fn:a.fn,isSale:a.isSale,positionType:a.positionType,hideSale:a.hideSale?a.hideSale:false,isSmsConfigHtml:a.isSmsConfigHtml,isReDisabled:a.isReDisabled?a.isReDisabled:false};
if(a.isEqWidth){b.isEqWidth=true;}if(a.isAutoHeight){b.isAutoHeight=true;}if(!b.positionType){b.url=b.url+"?type=dept_manager";}else{b.url=b.url+"?type="+b.positionType;
}if(a.isSale){b.url=b.url+"?type="+b.positionType+"&isSale=y";}if(a.agentId){b.url=b.url+"&agentId="+a.agentId;}b.dataFilter=function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"&&!b.hideSale){d.name=d.name+"【销】";d.font={"color":"red"};}}}if(a.dataFilter){return a.dataFilter(f,c,g);}else{return g;
}};CateUtils.selectTreeBox(b);},selectGroup:function(c){var e=c.selectedGroupId?c.selectedGroupId:"";var d=c.hasOwnProperty("isMultiple")&&c.isMultiple;
var a=this;var b=ctx+"/gl/ou/group/listData.htm";if(!c.positionType){b+="?type=dept_manager";}if(jQuery.isArray(e)){e=e.toString();}layer.open({type:1,title:"选择部门",shadeClose:false,btn:["确定","关闭"],area:["70%","70%"],scrollbar:false,maxmin:false,content:'<ul id="organizationSelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(f,i){var g=this;
var j={async:{enable:true,url:b,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:{selectedGroupId:e},dataFilter:function(n,k,o){if(o&&o.length){for(var m=0;
m<o.length;m++){var l=o[m];if(l.isSale=="y"){l.name=l.name+"【销】";l.font={"color":"red"};}}}return o;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},check:{enable:true,chkStyle:d?"checkbox":"radio",chkboxType:{"Y":"s","N":"s"},radioType:"all"},callback:{onClick:function h(l,o,n){var m=n.getCheckStatus().checked;
var k=$.fn.zTree.getZTreeObj("organizationSelTree");k.checkNode(n,!m,false);},onAsyncSuccess:function(m,o,n,p){var l=$.fn.zTree.getZTreeObj("organizationSelTree");
if(!n){var k=l.getNodes()[0];l.expandNode(k,true,false,true);}}}};$.fn.zTree.init($("#organizationSelTree"),j);},yes:function(j,g){var h=$.fn.zTree.getZTreeObj("organizationSelTree");
var f=h.getCheckedNodes(true);var l=[];for(var k=0;k<f.length;k++){var m={id:f[k].id,name:f[k].name};l.push(m);}if(c.fn){c.fn(l);}layer.close(j);}});}};
function SendMessage(){this.hadInit=false;}SendMessage._CONS_={LIST_DATA_URL:ctx+"/gl/sms/smsRecord/findByCsId.htm",SEND_MSG_URL:ctx+"/gl/sms/smsRecord/sendMsg.htm",SEND_ALI_TEMPLATE_URL:ctx+"/gl/sms/smsRecord/sendAliTemplateMsg.htm",RE_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/resend.htm",JUDGE_IS_PHONE_URL:ctx+"/crm/cs/csEntity/judgeIsPhone.htm",BATCH_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/batchSendMsg.htm",DIV:"#smsRecordGridDiv",GRID:"#smsRecordGrid",PAGER:"#smsRecordPager",GRID_ID:"smsRecordGrid",PAGER_ID:"smsRecordPager"};
SendMessage.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}this._initSelectPlatformType();},_initSelectPlatformType:function(){if("y"==isOpenSelectPlatform){$("body").find(".smsSelectPlatformDiv").show();
}else{$("body").find(".smsSelectPlatformDiv").remove();}},_bindEventHander:function(){var a=this;$("body").on("click",".resendMsg",function(){a.reSendMsg($(this).attr("attr-id"));
});$("body").on("click",".deleteMsgBtn",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/sms/smsRecord/delete.htm",{ids:b},function(){a.initTable(a.initParam);
});});});},initTable:function(e){var a=this;a.initParam=e;$("#sendMessageForm").find("[name=sendContent]").attr("disabled",false);var d="";if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){d="<th>操作</th>";
}$("#smsRecordDiv").empty().append("<table class='table table-bordered table-stripped' id='smsRecordTable'>            <thead>                <tr>                    <th></th>                    <th>手机号码</th>                    <th>短信内容</th>                    <th>收发</th>                    <th>平台</th>                    <th>结果</th>                    <th>发送人</th>                    <th>时间</th>"+d+"</tr>            </thead>        </table>");
var b=SendMessage._CONS_.LIST_DATA_URL+"?csId="+e.csId;var c=[{data:"lineNum"},{data:"mobile"},{data:"content"},{data:"type",render:function(f){if(f=="send"){return"<span class='text-success'>发送</span>";
}else{return"<span class='text-primary'>收到</span>";}}},{data:"platform",render:function(g){var f="短信猫";if(g){if(g.startsWith("gst")){f="高斯通";}else{if(g.startsWith("lsm")){f="螺丝帽";
}else{if(g.startsWith("ali")){f="阿里";}}}}return f;}},{data:"result",render:function(f,h,g){if(f=="SUCCESS"){return"<span class='text-success'>成功</span>";
}else{if(f=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";}else{if(f=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";
}else{if(f.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}else{if(f.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}}}}}}},{data:"employeeAid",render:function(h,g,f){if(f.type=="send"){return h;}else{return"无";}}},{data:"createTime"}];if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){c.push({data:"createTime",width:"10%",render:function(h,g,f){return"<button class='btn btn-sm btn-danger btn-outline deleteMsgBtn' idVal='"+f.id+"' type='button'>删除</button>";
}});}$("#smsRecordTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"asc"]]});
},openSendMessageView:function(c){var a=this;a.initForm();$("#sendMessageModalLabel").text("TO："+c.maskNum);var b=$("#sendMessageForm");b.find("[name=csId]").val(c.csId);
b.find("[name=sendPhoneNum]").val(c.number);b.find("[name=replyId]").val(c.replyId);$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){var d=b.find("[name=sendContent]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var e=new CateOptService();e.isHasSensitiveWord(d,function(j){if(j.isCanSendMsg!=null&&!j.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+j.msg,$("#sendMessageContainer"));
}else{var g=b.find("[name=csId]").val();var h=b.find("[name=sendPhoneNum]").val();var f=b.find("[name=replyId]").val();var i=b.find("[name=selectPlatformType]").val();
var k={csId:g,phone:h,sendContent:encodeURIComponent(d),selectPlatformType:i,replyId:f};$("#sendStatus").text("发送中...");FormUtils.submit(SendMessage._CONS_.SEND_MSG_URL,k,function(l){if(l.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,l.msg);$("#sendMessageContainer").modal("hide");}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});}});});},openBatchSendMessageView:function(c){var a=this;a._initSelectPlatformType();$("#sendMessageModalLabel").html("批量发短信&emsp;<span>批量给<font style='color:red;'>【"+c.csIds.length+"个】</font>个客户发短信<span>");
var b=$("#sendMessageForm");b.find("[name=sendContent]").val("");$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){DialogUtils.confirmWithOptions({title:"确定批量发短信？",text:"",confirmButtonText:"确定",yesFunc:function(){var f=c.csIds;
var d=b.find("[name=sendContent]").val();var e=b.find("[name=selectPlatformType]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var g=new CateOptService();g.isHasSensitiveWord(d,function(h){if(h.isCanSendMsg!=null&&!h.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+h.msg,$("#sendMessageContainer"));
}else{var i={"sendContent":encodeURIComponent(d),"csIds":f,selectPlatformType:e};FormUtils.submit(SendMessage._CONS_.BATCH_SEND_MSG_URL,i,function(j){if(j.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,j.msg);}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,j.msg);}},null);}});}});});},openAilTemplateMessageView:function(b){var a=this;
$("#aliTemplateModalCsIds").val(b.csIds);a.getAliTemplateSms();$("#aliTemplateModal").modal("show");$("#aliTemplateModal").removeAttr("tabindex");},initForm:function(){var a=$("#sendMessageModalLabel");
a.find("[name=csId]").val("");a.find("[name=sendPhoneNum]").val("");a.find("[name=sendContent]").val("");a.find(".tabli").removeClass("active").eq(0).addClass("active");
a.find(".tab-pane").removeClass("active").removeClass("in").eq(0).addClass("active").addClass("in");this._initSelectPlatformType();},reSendMsg:function(d){var a=this;
var b=SendMessage._CONS_.RE_SEND_MSG_URL;var c={"ids":d};DialogUtils.success(msgCode.SUCCESS,"发送中...");FormUtils.submit(b,c,function(e){if(e.success){a.initTable(a.initParam);
DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},null,true);},getTplOptions:function(c){var a=this;if(!c.type||!c.cateId){return;
}var b=window.sessionStorage.getItem("t9-ecm-loacaltpl"+c.type+c.cateId);if(b&&b!=null&&b!=""){a._apendData(c,JSON.parse(b));}else{FormUtils.loadData(ctx+"/gl/tpl/glTpl/findTplByTypeAndCateId.htm?type="+c.type+"&cateId="+c.cateId,function(d){window.sessionStorage.setItem("t9-ecm-loacaltpl"+c.type+c.cateId,JSON.stringify(d));
a._apendData(c,d);});}},getAliTemplateSms:function(){FormUtils.loadData(ctx+"/gl/tpl/glTpl/findAliTemplateSms.htm",function(a){var c=new StringBuffer();
if(a.length>0){var c=new StringBuffer();c.append('<option value="">请选择</option>');for(var b=0;b<a.length;b++){c.append("<option value='"+a[b].type+"' content='"+a[b].content+"'>"+a[b].templateName+"</option>");
}$(".aliTemplateModalSelect").empty().append(c.toString()).select2();}});},_apendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);
if(f.length==0){f=$("select[name='"+c.container+"']");if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");
}if(a&&a.length>0){var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].tplContent;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("'>").append(b).append("</option>");}else{g.append("<option value='").append(e).append("'>").append(b).append("</option>");
}}f.empty().append(g.toString());}f.off("change").on("change",function(){var h=c.fn;if(h&&typeof h==="function"){h(f.val());}});}};function CateOptService(){}CateOptService._CONS_={};
CateOptService.prototype={isHasSensitiveWord:function(b,a){var c={};$.ajax({type:"GET",url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=smsSensitiveWord",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){b=b.replace(/\s/g,"");
if(d&&d.length>0){for(var e=0;e<d.length;e++){if(b.indexOf(d[e].value)>-1){c.isCanSendMsg=false;c.msg=d[e].value;}}}if(a){a(c);}},error:function(d){if(a){a(c);
}}});}};function CustomerSelect(){this.hadInit=false;this.isEdit=false;this.layerIndex;this.options={callBack:null,partyId:null,selectedMulti:false,type:"self"};
if(typeof CustomerSelect.initialized=="undefined"){CustomerSelect.initialized=true;CustomerSelect.prototype.init=function(param){var self=this;if(param){if(!param.callBack){param.callBack=self.options.callBack;
}if(!param.selectedMulti){param.selectedMulti=self.options.selectedMulti;}if(!param.type){param.type=self.options.type;}}else{param=self.options;}self._openSelectCustomerDialog(param);
self._bindEventHander();};CustomerSelect.prototype._openSelectCustomerDialog=function(param){var self=this;var contentSB=new StringBuffer();contentSB.append("<div class='wrapper'>");
contentSB.append('<div id="searchFormContainer" class="row" style="margin-top: 5px;margin-right:0px;">');contentSB.append("<div class='col-sm-12'>");contentSB.append("<form role='form' class='form-inline searchCsForm'>");
contentSB.append("<div class='form-group'>");contentSB.append("<input id='searchValue' name='searchValue' class='form-control' placeholder='请输入查询条件'>");
contentSB.append("<div class='radio radio-info radio-inline'><input type='radio' id='csCode' value='csCode' name='searchParam' checked><label for='csCode'>客户编码</label></div>");
contentSB.append("<div class='radio radio-info radio-inline'><input type='radio' id='csName' value='csName' name='searchParam'><label for='csName'>真实姓名</label></div>");
contentSB.append("<div class='radio radio-info radio-inline'><input type='radio' id='phone' value='phone' name='searchParam'><label for='phone'>联系电话</label></div>");
contentSB.append("</div>");contentSB.append("<button style='margin-left: 5px;' class='btn btn-sm btn-outline csSearchBtn btn-primary' type='button'><i class='fa fa-search'></i>搜索</button>");
contentSB.append("</form>");contentSB.append("</div>");contentSB.append("</div>");contentSB.append("<div class='row' style='margin-top: 5px;margin-right:0px;'>");
contentSB.append('<div class="col-sm-12">');contentSB.append('<table id="selectCustomerGridLayer"></table><div id="selectCustomerPagerLayer"></div></div></div>');
contentSB.append("</div>");self.layerIndex=layer.open({type:1,title:"选择客户",maxmin:false,shadeClose:false,btn:["确定","关闭"],area:["700px","400px"],scrollbar:false,content:""+contentSB,success:function(layero,index){self._initJqgrid(param);
},yes:function(index,layero){if(param.callBack){var list=[];var idArr=[];if(param.selectedMulti){idArr=$(CustomerSelect.GRID).jqGrid("getGridParam","selarrrow");
}else{idArr=[$(CustomerSelect.GRID).jqGrid("getGridParam","selrow")];}if(idArr){for(var i=0;i<idArr.length;i++){var rowData=$(CustomerSelect.GRID).jqGrid("getRowData",idArr[i]);
list.push(rowData);}}var res=param.callBack(list);if(res==null||res==""||res==undefined){layer.close(self.layerIndex);}else{return false;}}layer.close(self.layerIndex);
}});};CustomerSelect.prototype._initJqgrid=function(params){var self=this;$.jgrid.defaults.styleUI="Bootstrap";var height=$(".layui-layer-content").height()-$(".ui-jqgrid-pager").outerHeight()-$(".layui-layer-btn").outerHeight()-50;
$(CustomerSelect.GRID).jqGrid({datatype:"json",url:ctx+"/crm/cs/csEntity/listSearchData.htm",height:190,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",viewrecords:true,multiselect:params.selectedMulti,rowList:[10,20,30],colNames:["ID","客户姓名","客户编号","归属工号"],colModel:[{name:"id",width:120,hidedlg:true,hidden:true},{name:"name",width:120},{name:"code",width:120},{name:"employeeAid",width:120,formatter:function(cellvalue,options,rowObject){return rowObject.employeeAid+"："+rowObject.employeeName;
}}],pager:CustomerSelect.PAGER,hidegrid:false,ondblClickRow:function(rowid,iRow,iCol,e){if(params.callBack){var rowData=$(CustomerSelect.GRID).jqGrid("getRowData",rowid);
var list=[{id:rowid,name:rowData["name"]}];var listJson=eval(list);var res=params.callBack(listJson);if(res==null||res==""||res==undefined){layer.close(self.layerIndex);
}else{return false;}}layer.close(self.layerIndex);}});};CustomerSelect.prototype._bindEventHander=function(){var self=this;$(document).on("click",".csSearchBtn",function(){var params=$(this).closest("form").serialize();
JTJqgridUtils.reloadJqgrid(CustomerSelect.GRID,params);});$(document).on("keypress","form.searchCsForm",function(e){if(e.keyCode==13){$(".csSearchBtn").trigger("click");
return false;}});};}}CustomerSelect.GRID="#selectCustomerGridLayer";CustomerSelect.PAGER="#selectCustomerPagerLayer";function AddressService(a){this.container=a;
this.isHideCountry=false;}AddressService._CONS_={CATE_TYPE_KEY:"AddressCateType",ROOT_KEY:"AddressCateType-root"};AddressService.prototype={init:function(b,a){if(!b||!b.isNotRequired){$("#"+this.container).empty().append("<div class='col-sm-12'><label class='control-label col-sm-2'>所在地<span style='color:red;'>*</span></label><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.isSelect&&b.isSelect=="y"){$("#"+this.container).empty().append("<div class='col-sm-12'><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.rowFit&&b.rowFit=="y"){$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-11 container' style='padding-left:0px !important;'></div>");
}else{$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-6 container'></div></div>");}}}this.params=b;
this._bindEventHandler();if(b.isHideCountry){self.isHideCountry=b.isHideCountry;this._loadProvinces("ChinaCityCateType-root");}else{this._loadCountrys();
}if(a&&typeof(a)=="function"){a();}},getAddress:function(){var e=$("#"+this.container).find('select[name="country_"]').val();var a=$("#"+this.container).find('select[name="province_"]').val();
var d=$("#"+this.container).find('select[name="city_"]').val();var c=$("#"+this.container).find('select[name="area_"]').val();var b=$("#"+this.container).find("select[name='town_']").val();
return{country:e,countryName:$("#"+this.container).find('select[name="country_"]').find('option[value="'+e+'"]').text(),province:a,provinceName:$("#"+this.container).find('select[name="province_"]').find('option[value="'+a+'"]').text(),city:d,cityName:$("#"+this.container).find('select[name="city_"]').find('option[value="'+d+'"]').text(),area:c,areaName:$("#"+this.container).find('select[name="area_"]').find('option[value="'+c+'"]').text(),town:b,townName:b?$("#"+this.container).find("select[name='town_']").find("option[value='"+b+"']").text():"",};
},isValid:function(b){var a=true;$("#"+this.container).find("select").each(function(){var c=$(this).attr("name");var e=$(this).val();if(!e&&c!="town_"){a=false;
var d="";switch(c){case"country_":d="请选择国家";break;case"province_":d="请选择省份";break;case"city_":d="请选择城市";break;case"area_":d="请选择区县";break;}DialogUtils.error(msgCode.ERROR,d,b);
return false;}});return a;},_loadCountrys:function(){this._loadCates(AddressService._CONS_.ROOT_KEY,"country_");},_loadProvinces:function(a){this._loadCates(a,"province_");
},_loadCitys:function(a){this._loadCates(a,"city_");},_loadAreas:function(a){this._loadCates(a,"area_");},_loadTowns:function(a){this._loadCates(a,"town_");
},_loadCates:function(c,d){var a=this;var b=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm";b+="?cateType="+AddressService._CONS_.CATE_TYPE_KEY+"&parentKey="+c;
FormUtils.loadData(b,function(h){if(h.success){if(h.msg!=null&&h.msg!=""){var j=new StringBuffer();var g=JSON.parse(h.msg);if(g&&g.length>0){j.append("<div class='col-sm-2' style='padding-left:0px !important;'>");
j.append("<select class='form-control' name='"+d+"'>");j.append("<option value=''>请选择</option>");for(var e=0;e<g.length;e++){var f="";if(a.params){switch(d){case"country_":if(g[e].value==a.params.country){f="selected='selected'";
}break;case"province_":if(g[e].value==a.params.province){f="selected='selected'";}break;case"city_":if(g[e].value==a.params.city){f="selected='selected'";
}break;case"area_":if(g[e].value==a.params.area){f="selected='selected'";}break;case"town_":if(g[e].value==a.params.town){f="selected='selected'";}break;
}}j.append("<option "+f+" idValue='"+g[e].id+"' value='"+g[e].value+"'>"+g[e].name+"</option>");}j.append("</select>");j.append("</div>");$("#"+a.container).find(".container").append(j.toString());
if(a.params&&a.params.disabled){$("#"+a.container).find(".container").find("select").attr("disabled","disabled");}if(a.params){switch(d){case"country_":if(a.params.country&&!a.isHideCountry){a._loadProvinces(a.params.country);
}break;case"province_":if(a.params.province){a._loadCitys(a.params.province);}break;case"city_":if(a.params.city){a._loadAreas(a.params.city);}break;case"area_":if(a.params.area){a._loadTowns(a.params.area);
}break;}}}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHandler:function(){var a=this;$("#"+this.container).off("change",'select[name="country_"]');
$("#"+this.container).off("change",'select[name="province_"]');$("#"+this.container).off("change",'select[name="city_"]');$("#"+this.container).off("change","select[name='area_']");
$("#"+this.container).find("select[name='area_']").off("change");$("#"+this.container).on("change",'select[name="country_"]',function(){a.params=null;var b=$(this).val();
if(b){$(this).parent().nextAll().remove();a._loadProvinces(b);}else{$("#"+a.container).find("select[name=province_]").empty().append("<option value=''>请选择</option>");
$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="province_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadCitys(b);}else{$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="city_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadAreas(b);}else{$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");}$.log("change");});$("#"+this.container).on("change","select[name='area_']",function(){a.params=null;
var b=$(this).val();if(b){$(this).parent().nextAll().remove();a._loadTowns(b);}else{$("#"+a.container).find("select[name='town_']").empty().append("<option value=''>请选择</option>");
}$.log("change");});}};function ShopAddrOpt(){this.hadInit=false;this.isEdit=false;this.isExist=false;this.addressService=new AddressService(ShopAddrOpt._CONS_.ADDR_CONTAINER);
this.options={callBack:null,};}ShopAddrOpt._CONS_={ADDR_CONTAINER:"shopAddrOptForm_cateContainer",EDIT_FROM_ID:"partyAddrEdidddddtForm",EDIT_URL:ctx+"/crm/cs/csEntity/addr/addrEditForm.htm",SAVE_URL:ctx+"/crm/cs/csEntity/addr/partyAddrAdd.htm",LISTNUM_BYCSID:ctx+"/crm/cs/csEntity/findPhonesByCsIdNotRepeat.htm",};
ShopAddrOpt.prototype={init:function(a){this._bindEventHander();this._openShopAddrDialog(a);this._bindFormValidation();},_openShopAddrDialog:function(d){var b=$(window).width();
var c=["650px","300px"];if(b<1024){c=["450px","230px"];}var a=this;layer.open({type:1,title:"收货地址处理",maxmin:false,shadeClose:false,btn:["保存","关闭"],skin:"addr-skin",area:c,content:$("."+ShopAddrOpt._CONS_.EDIT_FROM_ID),success:function(e,f){FormUtils.clear("shopAddrOptForm");
$(".addrDetaileDescribe").text("");$("input[id=shopAddrOptForm_types]").val("shipping");$("input[id=shopAddrOptForm_isSnapshot]").val("n");a._loadData(d.csId,d.addrId,d.isCs);
},yes:function(h,g){var f=$("div.partyAddrEdidddddtForm");if($("#shopAddrOptForm").valid()&&a.addressService.isValid(f)){$("textarea[name=addr]").val($("#shopAddrOptForm_addr").val());
if($("#shopAddrOptForm_mobile").val()==0){$("input[name=mobile]").val($("#maskNumber").val());}else{$("input[name=mobile]").val($("#shopAddrOptForm_mobile").val());
}var e=a.addressService.getAddress();$("input[name=coRid]").val(e.country);$("input[name=coName]").val(e.countryName);$("input[name=prRid]").val(e.province);
$("input[name=prName]").val(e.provinceName);$("input[name=ciRid]").val(e.city);$("input[name=ciName]").val(e.cityName);$("input[name=arRid]").val(e.area);
$("input[name=arName]").val(e.areaName);$("input[name=toRid]").val(e.town);$("input[name=toName]").val(e.townName);if($("#shopAddrOptForm_mobile").val()==0){if(!$("#maskNumber").val()){$(".tip").text("号码不能为空！").show();
return;}if(a.isExist){return;}}var i=$("#shopAddrOptForm").serialize();FormUtils.submit(ShopAddrOpt._CONS_.SAVE_URL,i,function(j){if(j.success){if(d.callBack){d.callBack(j.partyAddrPo);
}layer.close(h);}else{DialogUtils.error("失败",j.msg,f);}},function(){DialogUtils.error("错误","后台异常，请稍后重试",f);});}},cancel:function(){$("#shopAddrOptForm").validate().resetForm();
FormUtils.clear("shopAddrOptForm");}});},_loadData:function(d,c,b){var a=this;FormUtils.loadData(ShopAddrOpt._CONS_.EDIT_URL+"?csId="+d+"&addrId="+c,function(h){if(c){$("#shopAddrOptForm_isDefault").val(h.isDefault);
}else{if(h.isHaveDefault=="y"){$("#shopAddrOptForm_isDefault").val("n");}else{$("#shopAddrOptForm_isDefault").val("y");}}$("#shopAddrOptForm_partyId").val(d);
h.types&&$("input[id=shopAddrOptForm_types]").val(h["types"]);h.isSnapshot&&$("input[id=shopAddrOptForm_isSnapshot]").val(h["isSnapshot"]);if(b){h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("csEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}else{h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("soEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}h.addr&&$("textarea[name=addr]").val(h["addr"]);h.zipcode&&$("input[id=shopAddrOptForm_zipcode]").val(h["zipcode"]);h.name&&$("input[id=shopAddrOptForm_name]").val(h["name"]);
h.mobile&&$("input[id=mobile]").val(h["mobile"]);h.position&&$("input[id=shopAddrOptForm_position]").val(h["position"]);h.fax&&$("input[id=shopAddrOptForm_fax]").val(h["fax"]);
h.maskEmail&&$("input[id=shopAddrOptForm_email]").val(h["maskEmail"]);h.email&&$("input[name=email]").val(h["email"]);h.im&&$("input[id=shopAddrOptForm_im]").val(h["im"]);
h.createBy&&$("input[id=shopAddrOptForm_createBy]").val(h["createBy"]);h.createTime&&$("input[id=shopAddrOptForm_createTime]").val(h["createTime"]);h.id&&$("input[id=shopAddrOptForm_id]").val(h["id"]);
if(h.maskMobile){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();var f=$("#maskNumber");f.val("");}var g=new StringBuffer();
if(h.maskMobile){g.append("<option value="+h["mobile"]+" selected='selected'>"+h["maskMobile"]+"</option>");}if(h.csPhonePos&&h.csPhonePos.length){if(h.csPhonePos&&h.csPhonePos.length){for(var e=0;
e<h.csPhonePos.length;e++){g.append("<option value="+h.csPhonePos[e].number+">"+h.csPhonePos[e].maskPhone+"["+h.csPhonePos[e].type+"]</option>");}}}g.append("<option class='addNewNum' value='0'>添加新号码</option>");
$("#shopAddrOptForm_mobile").empty().append(g.toString());a.addressService.init({country:h["coRid"]?h["coRid"]:"ChinaCityCateType-root",province:h["prRid"],city:h["ciRid"],area:h["arRid"],town:h["toRid"],});
if($("#shopAddrOptForm_mobile").val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}});},_bindFormValidation:function(){jQuery.validator.addMethod("isPhone",function(c,b){return this.optional(b)||/^(1+\d{10})$/.test(c);
},"手机号码格式错误");var a={rules:{maskAddr:{required:true,maxlength:["1024"]},zipcode:{maxlength:["20"],zipcode:true},fax:{maxlength:["20"]},im:{maxlength:["64"]},name:{required:true,maxlength:["64"]},email:{required:true},maskNumber:{isPhone:true,},position:{maxlength:["64"]}},messages:{}};
FormUtils.bindFormValidation("shopAddrOptForm",a);},_bindEventHander:function(){var a=this;$(document).on("change","#maskNumber",function(){$(".tip").hide();
});$("#shopAddrOptForm").off("click","#shopAddrOptForm_email").on("click","#shopAddrOptForm_email",function(){if($("#shopAddrOptForm_email").val().indexOf("*")>0){$("#shopAddrOptForm_email").val("");
}});$("#shopAddrOptForm_mobile").off("change").on("change",function(){if($(this).val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();
var b=$("#maskNumber");b.val("");}});$("#maskNumber").off("blur").on("blur",function(){var b=$(this).val();if(b&&b.length>=7&&(!a.phonePrefix||a.phonePrefix!=b.substring(0,7))){FormUtils.loadData(ctx+"/crm/cs/csPhoneArea/getArea.htm?phone="+b,function(e){if(e.success){a.phonePrefix=b.substring(0,7);
var d=JSON.parse(e.msg);a.addressService.init({country:"ChinaCityCateType-root",province:d.provinceCateKey,city:d.cityCateKey,area:"",});}});}var c=new CsPhone();
if(b){if(c._checkIsPhone(b)){c.findCsByPhone(b,function(e){if(e&&e.success){var f=JSON.parse(e.msg);var d="号码重复，客户["+f.code+"]已拥有该号码";$(".tip").text(d).show();
a.isExist=true;}else{$(".tip").hide();a.isExist=false;}});}}});$(document).on("change","select[name=country_],select[name=province_],select[name=city_],select[name=area_],select[name=town_]",function(){var b=$("div.partyAddrEdidddddtForm");
var c=b.find("select[name=country_] option:selected").text();if(b.find("select[name=province_]").val()){c+="-"+b.find("select[name=province_] option:selected").text();
}if(b.find("select[name=city_]").val()){c+="-"+b.find("select[name=city_] option:selected").text();}if(b.find("select[name=area_]").val()){c+="-"+b.find("select[name=area_] option:selected").text();
}if(b.find("select[name=town_]").val()){c+="-"+b.find("select[name=town_] option:selected").text();}b.find(".addrDetaileDescribe").text(c);});}};var MaskPhoneNum={getMaskPhoneNum:function(a){if(a){if(a.length>=11){return a.substring(0,3)+"******"+a.substring(9,a.length);
}else{if(a.length>6&&a.length<11){return a.substring(0,1)+"******"+a.substring(7,a.length);}else{if(a.length>3&&a.length<=6){return a.substring(0,1)+"***"+a.substring(4,a.length);
}}}}return"";},maskEmail:function(a){var c=new StringBuffer();if(a){var b=a.indexOf("@");if(b>2){c.append(a.substring(0,b-2)).append("**").append(a.substring(b));
}else{if(b>=1){c.append(a.substring(0,b-1)).append("*").append(a.substring(b));}}}return c.toString();},maskAddr:function(b){var a=new StringBuffer();if(b){if(b.length>25){b=b.replace(b.substring(7,15),"*****");
}else{if(10<b.length<=25){b=b.replace(b.substring(6,13),"*****");}else{if(0<b.length<=10){b=b.replace(b.substring(5,6),"****");}}}}return b;},maskDesc:function(a){if(a){a=a.replace(" ","");
a=a.trim().replaceAll("\\d{11}","***********");}return a;}};var excelUtil={toGenExcel:function(a,b,c){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/toGenExcel.htm?module="+a+"&moduleText="+c,b);
},importExcel:function(a){if(a.isCreateSub){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl+"&isCreateSub="+a.isCreateSub,a.tabTitle);
}else{JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl,a.tabTitle);}},findExportColByModule:function(c,b,d){var a=ctx+"/gl/mc/moduleColumn/findByModule.htm?module="+c;
if(b){a=ctx+"/gl/mc/moduleColumn/findGrantCol.htm?module="+c;}FormUtils.loadData(a,function(e){if(d){d(e);}});}};function CsEmployee(a){this.caller=a;this.gridId="#csEntityGrid";
this.formId="#csEntitySearchForm";this.isSea="n";}CsEmployee._CONS_={SHOW_MORE:ctx+"/crm/cs/csEntity/showMoreTarget.htm",};CsEmployee.prototype={init:function(a,c,b){if(a){this.gridId=a;
}if(c){this.formId=c;}if(b){this.isSea=b;}this._bindEventHandler();},_bindEventHandler:function(){var a=this;$(document).on("click",".changRelEmployee",function(){a._changeEmployee($("#csEntityForm").find("[name=id]").val());
});$(document).on("click",".changRelEmployeeForAdd",function(){a._changeEmployee($("#csEntityForm").find("[name=id]").val());});$("body").on("click",".csEntityEmployee",function(){var c=$(this).attr("idVal");
if(c){var b=new CsAssign([c],"csEntity");b.init();}else{c=$(a.gridId).jqGrid("getGridParam","selarrrow");ConfigUtils.findByKey("csEntity.assignCsMaxVal",function(e){if(e.msg!=0&&e.msg<c.length){DialogUtils.error(msgCode.ERROR,"单次最多分配"+e.msg+"个客户");
return false;}else{if(c&&c.length){var d=new CsAssign(c,"csEntity");d.init();}else{DialogUtils.confirmWithOptions({title:"使用查询结果[不支持一键查询]进行分配,确定吗?",text:"",confirmButtonText:"确定",yesFunc:function(){var g=CsEntityUtils.getSearchParams(a.caller.rfmtSearch);
g=CsEntityUtils.getSearchParamToObj(g);g.type=type||a.caller.type;if(e.msg!=0){g.limitCount=e.msg;}if(a.isSea=="y"){g["is_sea_"]="y";}var f=$(a.caller.grid).jqGrid("getGridParam","records");
FormUtils.submit(ctx+"/crm/cs/csEntity/listCsIds.htm",g,function(i){var h=new CsAssign(i,"csEntity",null,e.msg);h.init();});},noFunc:function(){DialogUtils.error(msgCode.ERROR,"请选择要分配的客户");
},});}}});}});},_getSearchParam:function(){var f=$(this.formId).serialize();var e={};f=decodeURIComponent(f,true);var a=f.split("&");if(a.length){for(var b=0;
b<a.length;b++){var d=a[b].split("=");if(d.length==2){if(e.hasOwnProperty(d[0])){if(jQuery.type(e[d[0]])=="string"){var c=[];c.push(e[d[0]]);d[1]=d[1].replaceAll("\\+"," ");
c.push(d[1]);e[d[0]]=c;}else{if(jQuery.type(e[d[0]])=="array"){d[1]=d[1].replaceAll("\\+"," ");e[d[0]].push(d[1]);}}}else{d[1]=d[1].replaceAll("\\+"," ");
e[d[0]]=d[1];}}else{if(d.length>2){e[d[0]]=a[b].substring(a[b].indexOf("=")+1).replaceAll("\\+"," ");}}}}return e;},_changeEmployee:function(d,a){var b=0;
if(ResUtils.canShow("employeeSelector.button.cs")){b:1;}var e={isShowAllGroup:b,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,isOnlySelfGroup:1,type:"positionContext",callBack:function(g){if(g!=null){if(g.length>0){$("input[name=employeeId]").val(g[0].id);
$("input[name=employeeShow]").val(g[0].aid+"："+g[0].name);if(!a){var f=[];f.push({employeeId:g[0].id,csEntityIds:d});FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(f),csType:"csEntity"},function(h){if(h.success){DialogUtils.success("提示",h.msg);
}else{DialogUtils.error("失败",h.msg);}});}}}}};var c=new EmployeesSelect();c.init(e);},};function ComplainTypeOption(){}ComplainTypeOption._CONS_={FIND_COMPLAIN_TYPE:ctx+"/crm/cs/csComplain/findCompalinType.htm"};
ComplainTypeOption.getTypeOption=function(a){$.ajax({type:"GET",url:ComplainTypeOption._CONS_.FIND_COMPLAIN_TYPE+"?key=csComplainType&typeKey=csEntity",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d&&d.length>0){var g=new StringBuffer();
var f=null;for(var c=0;c<d.length;c++){if(f){if(f>d[c].depth){f=d[c].depth;}}else{f=d[c].depth;}}var e=new Array();for(var c=0;c<d.length;c++){if((parseInt(f)+1)==d[c].depth){d[c].secondCate=new Array();
e.push(d[c]);}}for(var c=0;c<d.length;c++){for(var b=0;b<e.length;b++){if(d[c].parentId==e[b].id){e[b].secondCate.push(d[c]);break;}}}var g=new StringBuffer();
for(var c=0;c<e.length;c++){g.append("<option value='"+e[c].id+"' firstCateId='"+e[c].id+"' secondCateId=''>");g.append(e[c].name);g.append("</option>");
for(var b=0;b<e[c].secondCate.length;b++){g.append("<option value='"+e[c].secondCate[b].id+"' firstCateId='"+e[c].id+"' secondCateId='"+e[c].secondCate[b].id+"'>");
g.append("--"+e[c].secondCate[b].name);g.append("</option>");}}if(a){a(g.toString());}}}});};function StatisticInfo(){this.hadInit=false;this.data=null;
this.csId="";}StatisticInfo._CONS_={DYNAMIC_URL:ctx+"/crm/cs/csEntity/findDynamicByCsId.htm",SAVE_HEAD_IMG_URL:ctx+"/crm/cs/csEntity/saveHeadImg.htm",};
StatisticInfo.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._dealStyle();this._fillDynamicData(a);this.csId=a;
if(type=="self"){$(".addHeadImg").show();}}},_dealStyle:function(){var a=this;$("#statisticInfoDiv").height($("body").height()-100);$("#cs-dynamic-info").width($("body").width()-420);
if(a.data){a._initLine(a.data);}},_bindEventHander:function(){var a=this;$("#csInfoOrderLi").on("click",function(){if(a.watchTab){return false;}a.watchTab=setInterval(function(){a.counterTab+=250;
if($("#csInfoOrderTab").is(":visible")||a.counterTab>=5000){a._initLine(a.data);clearInterval(a.watchTab);delete a.watchTab;delete a.counterTab;}},250);
});$(window).on("resize",function(){a._dealStyle();});$(document).on("click",".soTab",function(){var c=$(this).attr("value");var d=$("#csEntityForm").find("input[name='name']").val();
var b=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";if(c&&c!=""){JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/detail.htm?soNo="+c+"&canShowScTrankNo="+b,d+"的订单明细");
}});$(".addHeadImg").on("click",function(){ImageUtils.selectImage(0,function(b){if(b.length>=1){a._saveHeadImg(b[0].url);}});});},_saveHeadImg:function(b){var a=StatisticInfo._CONS_.SAVE_HEAD_IMG_URL;
var c={id:this.csId,profile:b};FormUtils.submit(a,c,function(d){if(d.success){$(".cs-head-img").attr("src",ctx+b);DialogUtils.success("提示","修改成功");}else{DialogUtils.error("失败","修改失败");
}});},_fillDynamicData:function(c){var a=this;var b=StatisticInfo._CONS_.DYNAMIC_URL+"?csId="+c;FormUtils.loadData(b,function(d){a._setDynamicData(d);a._setOrderData(d);
a._setFollowData(d);a._setCallData(d);});},_setDynamicData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;a++){if(b[a].type=="订单日志"&&!(b[a].content=="订单已签收"||b[a].content=="订单审核通过"||b[a].content.indexOf("订单拒收")!=-1||b[a].content.indexOf("订单包裹丢失")!=-1)){continue;
}if(b[a].type=="订单跟进"){continue;}if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");
}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">');
if(b[a].type=="客户跟进"||b[a].type=="档案情况跟进"){e.append("<b>"+b[a].type+"</b>：").append("<span style='color:red;'>"+b[a].content+"</span>");}else{e.append(b[a].contentExt!=""?b[a].contentExt:b[a].content);
}e.append("</div></div>");}$("#cs-dynamic-date-line").empty().append(e.toString());},_getDateName:function(a){if(DateUtils.getDateDiff(a,DateUtils.format(new Date(),"yyyy-MM-dd"),"day")<1){return"今天";
}else{if(DateUtils.getDateDiff(a,DateUtils.format(new Date(),"yyyy-MM-dd"),"day")<2){return"昨天";}else{return a.replaceAll("-",".");}}},_getIcon:function(a){if(a.type=="客户注册"){return ctx+"/img/jt/cs/timeRegister.png";
}else{if(a.type=="订单日志"){if(a.content=="订单已签收"){return ctx+"/img/jt/cs/complete.png";}else{if(a.content=="订单审核通过"){return ctx+"/img/jt/cs/confirm.png";
}else{if(a.content.indexOf("订单拒收")!=-1){return ctx+"/img/jt/cs/reject.png";}else{if(a.content.indexOf("订单包裹丢失")!=-1){return ctx+"/img/jt/cs/lost.png";}}}}}else{if(a.type.indexOf("通话记录")!=-1){return ctx+"/img/jt/cs/callTime.png";
}else{if(a.type=="档案情况跟进"){return ctx+"/img/jt/cs/eav.png";}else{if(a.type=="转工号"){return ctx+"/img/jt/cs/turn.png";}else{return ctx+"/img/jt/cs/follow.png";
}}}}}},_setOrderData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;a++){if(b[a].type=="订单日志"&&(b[a].content=="订单已签收"||b[a].content=="订单审核通过"||b[a].content.indexOf("订单拒收")!=-1)||b[a].content.indexOf("订单包裹丢失")!=-1){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);
}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">').append(b[a].contentExt!=""?b[a].contentExt:b[a].content).append("</div></div>");
}}$("#cs-order-date-line").empty().append(e.toString());},_setFollowData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;
a++){if(!(b[a].type=="订单日志"||b[a].type=="订单跟进"||b[a].type.indexOf("订单跟进")!=-1||b[a].type.indexOf("通话记录")!=-1)){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);
}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">');
if(b[a].type=="客户跟进"||b[a].type=="档案情况跟进"){e.append("<b>"+b[a].type+"</b>：").append("<span style='color:red;'>"+b[a].content+"</span>");}else{e.append(b[a].contentExt!=""?b[a].contentExt:b[a].content);
}e.append("</div></div>");}}$("#cs-follow-date-line").empty().append(e.toString());},_setCallData:function(b){var d=null,c=null;var e=new StringBuffer();
for(var a=0;a<b.length;a++){if(b[a].type.indexOf("通话记录")!=-1){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");
}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">').append(b[a].contentExt!=""?b[a].contentExt:b[a].content).append("</div></div>");
}}$("#cs-call-date-line").empty().append(e.toString());},_initLine:function(h){var d={};for(var f=h.length-1;f>=0;f--){var g=h[f];if(g.status=="complete"){var e=g.completeTime.substring(0,10);
if(!d.hasOwnProperty(e)){d[e]=g.totalAmount;}else{d[e]=d[e]+g.totalAmount;}}}var c=[];for(var e in d){var b={content:NumberFormat.format(d[e],2),name:e};
c.push(b);}var a=new Report();a.data=c;a.grid={left:66,right:50,bottom:50,top:50};a.textStyle={fontSize:14,fontWeight:"500",color:"#009688"};a.setLegend(false,null,"name");
a.setBarSeriesStyle(true,"top","{c}");a.initSeries([{type:"line",colName:"content",legendName:"数据"}],"name");a._initChart("csOrderLine","订单成交趋势图");},_fillSoCount:function(g){var h=0,b=0,f=0,d=0,a=0;
for(var c=0;c<g.length;c++){var e=g[c];if(e.soType=="soSupplementary"){continue;}if(e.status=="awaiting_comfirm"){h+=1;}else{if(e.status=="complete"){b+=1;
}else{if(e.status=="close_reject"){f+=1;}else{if(e.status=="close_lost"){d+=1;}else{if(e.status=="awaiting_pay"||e.status=="comfirm"||e.status=="shipping"){a+=1;
}}}}}}$(".cs-st-value-confirm").empty().append(h);$(".cs-st-value-doing").empty().append(a);$(".cs-st-value-complete").empty().append(b);$(".cs-st-value-reject").empty().append(f);
$(".cs-st-value-lost").empty().append(d);},_fillSoInfo:function(j){var b=0,c=0,n=0;var a=0,f=0,m=0;var k=0,h=0,l=0,e=0;for(var g=0;g<j.length;g++){var d=j[g];
if(d.soType=="soSupplementary"){continue;}if(d.status!="awaiting_post"&&d.status!="awaiting_comfirm"&&d.status!="close"){b+=1;a+=d.totalAmount;}if(d.status=="complete"){c+=1;
f+=d.totalAmount;if(DateUtils.getDateDiff(d.createTime,new Date(),"day")<=30){n+=1;m+=d.totalAmount;}e+=d.totalAmount;if(k==0){k=d.totalAmount;}if(h==0){h=d.totalAmount;
}if(k>d.totalAmount){k=d.totalAmount;}if(h<d.totalAmount){h=d.totalAmount;}}}l=(c==0?0:e/c);$("#confirm-order").empty().append(b);$("#confirm-money").empty().append("￥"+(((a+"").indexOf(".")==-1)?a:a.toFixed(2)));
$("#complete-order").empty().append(c);$("#complete-money").empty().append("￥"+(((f+"").indexOf(".")==-1)?f:f.toFixed(2)));$("#last30-order").empty().append(n);
$("#last30-money").empty().append("￥"+(((m+"").indexOf(".")==-1)?m:m.toFixed(2)));$("#max-amount").empty().append("￥"+(((h+"").indexOf(".")==-1)?h:h.toFixed(2)));
$("#min-amount").empty().append("￥"+(((k+"").indexOf(".")==-1)?k:k.toFixed(2)));$("#average-amount").empty().append("￥"+(((l+"").indexOf(".")==-1)?l:l.toFixed(2)));
},fillOtherInfo:function(c){var a=this;var b=ctx+"/ec/salesorder/soEntity/findSoByCsId.htm?csId="+c;FormUtils.loadData(b,function(d){a._fillSoCount(d);
a._fillSoInfo(d);a.data=d;});},fillInfo:function(g){$(".cs-st-value-money").empty().append("￥ "+g.soTotal);$(".cs-st-value-rebuy").empty().append(g.soRepeatBuy);
$(".cs-st-value-pointLv").empty().append(g.levelName);$(".cs-st-value-pointUseAble").empty().append(g.pointUsable);$(".cs-st-value-pointTotal").empty().append(g.pointTotal);
$(".cs-st-value-timeRegister").empty().append(g.createTime);$(".cs-st-value-timeComplete").empty().append(g.lastCompleteTime);$(".cs-st-value-timeFollow").empty().append(g.lastFollowTime);
$(".cs-st-value-timeLvUp").empty().append(g.upgTime);$(".cs-head-name").empty().append(g.code+"&nbsp;:&nbsp;"+g.name);var b=(g.profile==""||g.profile==null)?(ctx+"/img/jt/wx/images/head_default.jpg"):(ImageUtils.getTrueUrl(g.profile));
$(".cs-head-img").attr("src",b).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,74));});var c=parseInt(DateUtils.getDateDiff(g.createTime,new Date(),"day")/365)+1;
var h=new StringBuffer();h.append('<span class="cs-head-lv-name">会龄</span>');if(c<4){for(var d=0;d<c;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');
}}else{if(c<16){var j=parseInt(c/4);var e=c%4;for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');}for(var d=0;
d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');}}else{if(c<64){var f=parseInt(c/16);var j=parseInt((c%16)/4);var e=c%4;
for(var d=0;d<f;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv3.png" class="cs-head-lv-img">');}for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');
}for(var d=0;d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');}}else{if(c<256){var a=parseInt(c/64);var f=parseInt((c%64)/16);
var j=parseInt((c%16)/4);var e=c%4;for(var d=0;d<a;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv4.png" class="cs-head-lv-img">');}for(var d=0;d<f;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv3.png" class="cs-head-lv-img">');
}for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');}for(var d=0;d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');
}}}}}$(".cs-head-lv").empty().append(h.toString());$(".cs-head-lv").attr("title",c+"年");}};function imgStyle(b,c,a){if(b>c){return"height:100% !important;left:-"+(a*(1-(c/b)))/2+"px;width:auto !important;";
}else{if(b==c){return null;}else{if(b<c){return"top:-"+(a*(1-(b/c)))/2+"px;";}}}}function CsFinanceMeeting(){this.hadInit=false;this.params=null;this.csType="";
this.permissionType="";}CsFinanceMeeting._CONS_={SAVE_ADD_URL:ctx+"/crm/finance/financeMeeting/saveAdd.htm"};CsFinanceMeeting.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;
this._bindEventHander();this._bindFormValidation();this.params=a;this.csType=a.csType;this.permissionType=a.permissionType;CateUtils.getOptions({typeKey:"system",pKey:"financeMeetingArea",container:"meetingArea"});
}this._initTable(a);},_bindEventHander:function(){var a=this;$(document).on("click",".deleteCsMeeting",function(){var c={csId:$(this).attr("csIdVal"),ids:$(this).attr("idVal")};
DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/finance/financeMeeting/delete.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
a._initTable(a.params);}});});});$(document).on("click","#addMeetingBtn",function(){ButtonUtils.disableBtn("addMeetingBtn");layer.close(a.layerIndex);a.layerIndex=layer.open({type:1,title:"面谈记录",shade:false,btn:["保存","关闭"],area:["550px","350px"],offset:"10%",content:$(".csFinanceMeetingAdd"),scrollbar:true,success:function(c,d){ButtonUtils.enableBtn("addMeetingBtn");
a._initForm();},yes:function(d,c){if(!$("#csFinanceMeetingAdd").valid()){return;}a._save();}});});var b=$("#csFinanceMeetingAdd");b.on("click",".selectEmployeeId",function(){var c=0;
if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=employeeShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=employeeId]").val(f[0].id);b.find("input[name=employeeAid]").val(f[0].aid);b.find("input[name=employeeName]").val(f[0].name);}}};var d=new EmployeesSelect();
d.init(e);});b.on("click",".selectPartakeId",function(){var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=partakeShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=partakeId]").val(f[0].id);b.find("input[name=partakeAid]").val(f[0].aid);b.find("input[name=partakeName]").val(f[0].name);}}};var d=new EmployeesSelect();
d.init(e);});},_initForm:function(){FormUtils.clear("csFinanceMeetingAdd");var a=$("#csFinanceMeetingAdd");a.find("input[name=employeeShow]").val(currentUserAid+"："+currentUserName);
a.find("input[name=employeeId]").val(currentUserId);a.find("input[name=employeeAid]").val(currentUserAid);a.find("input[name=employeeName]").val(currentUserName);
a.find("input[name=csId]").val(this.params.csId);},_initTable:function(e){var a=this;var d="";if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csMeeting.button.deleteMyself")){d="<th width='7%'>操作</th>";
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csMeeting.button.deleteSub")){d="<th width='7%'>操作</th>";
}}}}$("#csMeetingDiv").empty().append("<table class='table table-bordered table-stripped' id='csMeetingTable'>"+"<thead><tr>"+"<th width='4%'></th><th width='8%'>时间</th><th width='8%'>面谈人</th>"+"<th width='8%'>参与人</th>"+"<th width='8%'>地点</th>"+"<th width='9%'>内容</th>"+"<th width='9%'>创建时间</th>"+d+"</tr>"+"</thead></table>");
var b=ctx+"/crm/finance/financeMeeting/findByCsId.htm?csId="+e.csId;var c=[{data:"lineNum"},{data:"meetingTime",render:function(i,h,g){var f="<span title='"+i+"'>"+DateUtils.miniTime(i)+"</span>";
return f;}},{data:"employeeName",render:function(h,g,f){return f.employeeAid+":"+h;}},{data:"partakeName",render:function(h,g,f){if(f.partakeId==null||f.partakeId==""){return"无";
}return f.partakeAid+":"+h;}},{data:"meetingArea"},{data:"meetingContent"},{data:"createTime",render:function(i,h,g){var f="<span title='"+i+"'>"+DateUtils.miniTime(i)+"</span>";
return f;}},];if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csMeeting.button.deleteMyself")){c.push({data:"id",width:"7%",render:function(h,g,f){return"<i class='fa fa-remove deleteCsMeeting' title='删除' csIdVal='"+f.csId+"' idVal='"+h+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csMeeting.button.deleteSub")){c.push({data:"id",width:"7%",render:function(h,g,f){return"<i class='fa fa-remove deleteCsMeeting' title='删除' csIdVal='"+f.csId+"' idVal='"+h+"'style='color: red; cursor: pointer;'></i>";
}});}}}}$("#csMeetingTable").DataTable({ajax:{url:b},columns:c,rowId:"id",lengthMenu:[[20],],searching:false,ing:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false,});
},_save:function(){var b=this;var a=CsFinanceMeeting._CONS_.SAVE_ADD_URL;FormUtils.submitByFormId(a,"csFinanceMeetingAdd",function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}layer.close(b.layerIndex);b._initTable(b.params);},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindFormValidation:function(){var a={rules:{"meetingTime":{required:true},"meetingContent":{required:true,},}};FormUtils.bindFormValidation("csFinanceMeetingAdd",a);
},};function CsFinanceTurnover(){this.hadInit=false;this.params=null;}CsFinanceTurnover._CONS_={SAVE_ADD_URL:ctx+"/crm/finance/financeTurnover/saveAdd.htm"};
CsFinanceTurnover.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindFormValidation();this.params=a;}this._initTable(a);
},_bindEventHander:function(){var a=this;$(document).on("click","#addTurnoverBtn",function(){ButtonUtils.disableBtn("addTurnoverBtn");layer.close(a.layerIndex);
a.layerIndex=layer.open({type:1,title:"成交记录",shade:false,btn:["保存","关闭"],area:["550px","350px"],offset:"10%",content:$(".csFinanceTurnoverAdd"),scrollbar:true,success:function(c,d){ButtonUtils.enableBtn("addTurnoverBtn");
a._initForm();},yes:function(d,c){if(!$("#csFinanceTurnoverAdd").valid()){return;}a._save();}});});var b=$("#csFinanceTurnoverAdd");b.on("click",".selectPlacerId",function(){var c=0;
if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=placerShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=placerId]").val(f[0].id);b.find("input[name=placerAid]").val(f[0].aid);b.find("input[name=placerName]").val(f[0].name);}}};var d=new EmployeesSelect();
d.init(e);});},_initForm:function(){FormUtils.clear("csFinanceTurnoverAdd");var a=$("#csFinanceTurnoverAdd");a.find("input[name=placerShow]").val(currentUserAid+"："+currentUserName);
a.find("input[name=placerId]").val(currentUserId);a.find("input[name=placerAid]").val(currentUserAid);a.find("input[name=placerName]").val(currentUserName);
a.find("input[name=csId]").val(this.params.csId);},_initTable:function(d){var a=this;var c=false;$("#csTurnoverDiv").empty().append("<table class='table table-bordered table-stripped' id='csTurnoverTable'>"+"<thead>"+"<tr>"+"<th width='4%'></th><th width='8%'>订单编号</th>"+"<th width='8%'>产品</th>"+"<th width='8%'>金额</th>"+"<th width='8%'>下单人</th>"+"<th width='9%'>开户时间</th>"+"<th width='9%'>到期时间</th></tr>"+"</thead></table>");
var b=ctx+"/crm/finance/financeTurnover/findByCsId.htm?csId="+d.csId;$("#csTurnoverTable").DataTable({ajax:{url:b},columns:[{data:"lineNum"},{data:"soNo"},{data:"prodName"},{data:"amount"},{data:"placerName"},{data:"startTime",render:function(h,g,f){var e="<span title='"+h+"'>"+DateUtils.miniTime(h)+"</span>";
return e;}},{data:"endTime",render:function(h,g,f){var e="<span title='"+h+"'>"+DateUtils.miniTime(h)+"</span>";return e;}}],rowId:"id",lengthMenu:[[20],],fnRowCallback:function(h,g,f,e){if(f==0){addd=0;
}addd+=parseFloat(g["amount"]);$("#totalAmountsum").html(addd.toFixed(2)+"(元)");return h;},paging:true,pagingType:"simple",searching:false,lengthChange:false,autoWidth:false,ordering:false,});
},_save:function(){var b=this;var a=CsFinanceTurnover._CONS_.SAVE_ADD_URL;FormUtils.submitByFormId(a,"csFinanceTurnoverAdd",function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}layer.close(b.layerIndex);b._initTable(b.params);},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindFormValidation:function(){var a={rules:{"soNo":{required:true},"amount":{required:true,},"prodName":{required:true,},"startTime":{required:true,},"endTime":{required:true,},}};
FormUtils.bindFormValidation("csFinanceTurnoverAdd",a);},};var callRecordOperate={init:function(){if(!this._hadInit){var a=this;$(document).on("click",".listenBtn",function(f){f.stopPropagation();
if(!$("#audioContainer").length){if($("#insideLineSheetRecordPager .jt-pagesize-message").length){$("#insideLineSheetRecordPager .jt-pagesize-message").append("<audio id='audioContainer' style='width:500px;' preload='metadata'  autoplay='autoplay' controls='controls'></audio>");
}if($("#csCallRecordContainer_info").length){$("#csCallRecordContainer_info").append("<audio id='audioContainer' style='position: absolute;width:500px;' autoplay='autoplay' preload='metadata'  controls='controls'></audio>");
}}var h=$(this).attr("recfileVal");var c=$(this).attr("uniqueCode");var d=$(this).attr("id-value");var g="recordId="+d+"&uniqueCode="+c+"&url="+encodeURIComponent(h);
FormUtils.submit(ctx+"/gl/cti/trkSheetRecordHi/addListenRecordHi.htm",g,null,null,true);var b=$("#audioContainer");if("y"==listenVoiceOutNet){FormUtils.submit(ctx+"/gl/cti/downloadWav/getListenVoiceUrl.htm",g,function(e){var i=e.msg;
a.audio=b[0];b.attr("src",i);},function(){var e=ctx+"/gl/cti/downloadWav/listenVoice.htm?recordId="+d+"&uniqueCode="+c+"&url="+encodeURIComponent(h);a.audio=b[0];
b.attr("src",e);},true);}else{url=h;a.audio=b[0];b.attr("src",url);}});$(document).on("click",".operateRecordHiBtn",function(f){f.stopPropagation();var c=$(this).attr("id-value");
var b=$(this).attr("uniqueCode");var d=ctx+"/gl/cti/trkSheetRecordHi/toRecordHi.htm?recordId="+c+"&uniqueCode="+b;layer.open({type:2,title:'<font style="color:red;">【'+"录音操作记录"+"】</font>",maxmin:false,shadeClose:true,area:["70%","65%"],scrollbar:false,content:d,yes:function(g,e){e.close(g);
}});});$(document).on("click",".operateRecordMarkBtn",function(f){f.stopPropagation();var c=$(this).attr("id-value");var b=$(this).attr("uniqueCode");var d=ctx+"/gl/cti/trksheetRecordMark/toRecordMark.htm?recordId="+c+"&uniqueCode="+b;
layer.open({type:2,title:'<font style="color:red;">【'+"通话记录标识"+"】</font>",maxmin:false,shadeClose:true,btn:["确定"],area:["70%","65%"],scrollbar:false,content:d,yes:function(g,e){layer.close(g);
}});});$(document).on("click",".operateRecordTrans2WordBtn",function(f){f.stopPropagation();var c=$(this).attr("id-value");var b=$(this).attr("uniqueCode");
var d=ctx+"/gl/cti/tRKSheetRecord/toRecordTranslate.htm?recordId="+c+"&uniqueCode="+b;layer.open({type:2,title:'<font style="color:red;">【'+"翻译"+"】</font>",maxmin:false,shadeClose:true,area:["900px","500px"],scrollbar:false,content:d,});
});$(document).on("click",".operateRecordShareBtn",function(f){f.stopPropagation();var c=$(this).attr("id-value");var b=$(this).attr("uniqueCode");var d=ctx+"/gl/cti/trksheetrecordRecomm/toRecordRecomm.htm?recordId="+c+"&uniqueCode="+b;
layer.open({type:2,title:'<font style="color:red;">【'+"录音推荐"+"】</font>",maxmin:false,shadeClose:true,btn:["确定"],area:["50%","400px"],scrollbar:false,content:d,yes:function(i,g){var e=layer.getChildFrame("body",i);
var h=$('[name="groupIds"]',e).val();var j=$("[name='AgentId']",e).val();var k=$("[name=recommReason]",e).val();if(!h&&!j){DialogUtils.error(msgCode.ERROR,"请选择要推荐部门或员工!");
return;}var l={recordId:c,groupIds:h,employeeIds:j,recommReason:k,};if(true){FormUtils.submit(ctx+"/gl/cti/trksheetrecordRecomm/shareRecord.htm",l,function(m){if(m.success){DialogUtils.success(msgCode.SUCCESS,"推荐成功!");
layer.close(i);}else{DialogUtils.error(msgCode.ERROR,m.msg);}},false);}}});});$("body").on("keyup",function(c){if(a.audio){if(c.keyCode==39){var b=a.audio.currentTime+5;
if(b>a.audio.duraction){a.audio.pause();}else{a.audio.currentTime=b;}}else{if(c.keyCode==37){var b=a.audio.currentTime-5;if(b<0){b=0;}a.audio.currentTime=a.audio.currentTime-5;
}else{if(c.keyCode==32){if(a.audio.paused){a.audio.play();}else{a.audio.pause();}}}}}});$(document).on("click",".downloadBtn",function(g){g.stopPropagation();
var f=$(this).attr("recfileVal");var d=$(this).attr("id-value");var c=$(this).attr("uniqueCode");var h="recordId="+d+"&uniqueCode="+c+"&url="+encodeURIComponent(f);
FormUtils.submit(ctx+"/gl/cti/trkSheetRecordHi/addDownloadRecordHi.htm",h,null,null,true);var b=ctx+"/gl/cti/downloadWav/download.htm?recordId="+d+"&uniqueCode="+c+"&url="+encodeURIComponent(f);
window.location.href=b;});$(document).on("click",".deleteBtn",function(b){var c=$(this).attr("id-value");a._deleteRecord(c);});$(document).on("click",".recordBtn",function(b){b.stopPropagation();
});$(document).on("click",".evaluateBtn",function(b){b.stopPropagation();$("#evaluateModalContainer").modal("show");});}},_deleteRecord:function(c){var b=this;
var a=ctx+"/gl/cti/tRKSheetRecord/deleteRecord.htm";DialogUtils.confirm(function(){FormUtils.del(a,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,"删除录音成功");
$(".insideLineSheetRecordSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,d.msg);}});});}};var GroupUtils={loadGroupOptions:function(a){a.url=ctx+"/gl/ou/group/listData.htm";
if(!a.positionType){a.url=a.url+"?type=dept_manager";}a.key="id";a.keyName="name";a.caption="请选择部门";return OptionsBaseUtils.getOptions(a);},selectGroupTreeBox:function(a){var b={selectedIds:jQuery.isArray(a.selectedGroupId)?a.selectedGroupId.toString():a.selectedGroupId,container:a.container,treeId:"menuContentForGroup"+a.container.split(" ")[0],isMultiple:a.isMultiple,otherParam:{selectedGroupId:a.selectedGroupId},url:ctx+"/gl/ou/group/listData.htm",fn:a.fn,isSale:a.isSale,positionType:a.positionType,hideSale:a.hideSale?a.hideSale:false,isSmsConfigHtml:a.isSmsConfigHtml,isReDisabled:a.isReDisabled?a.isReDisabled:false};
if(a.isEqWidth){b.isEqWidth=true;}if(a.isAutoHeight){b.isAutoHeight=true;}if(!b.positionType){b.url=b.url+"?type=dept_manager";}else{b.url=b.url+"?type="+b.positionType;
}if(a.isSale){b.url=b.url+"?type="+b.positionType+"&isSale=y";}if(a.agentId){b.url=b.url+"&agentId="+a.agentId;}b.dataFilter=function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"&&!b.hideSale){d.name=d.name+"【销】";d.font={"color":"red"};}}}if(a.dataFilter){return a.dataFilter(f,c,g);}else{return g;
}};CateUtils.selectTreeBox(b);},selectGroup:function(c){var e=c.selectedGroupId?c.selectedGroupId:"";var d=c.hasOwnProperty("isMultiple")&&c.isMultiple;
var a=this;var b=ctx+"/gl/ou/group/listData.htm";if(!c.positionType){b+="?type=dept_manager";}if(jQuery.isArray(e)){e=e.toString();}layer.open({type:1,title:"选择部门",shadeClose:false,btn:["确定","关闭"],area:["70%","70%"],scrollbar:false,maxmin:false,content:'<ul id="organizationSelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(f,i){var g=this;
var j={async:{enable:true,url:b,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:{selectedGroupId:e},dataFilter:function(n,k,o){if(o&&o.length){for(var m=0;
m<o.length;m++){var l=o[m];if(l.isSale=="y"){l.name=l.name+"【销】";l.font={"color":"red"};}}}return o;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},check:{enable:true,chkStyle:d?"checkbox":"radio",chkboxType:{"Y":"s","N":"s"},radioType:"all"},callback:{onClick:function h(l,o,n){var m=n.getCheckStatus().checked;
var k=$.fn.zTree.getZTreeObj("organizationSelTree");k.checkNode(n,!m,false);},onAsyncSuccess:function(m,o,n,p){var l=$.fn.zTree.getZTreeObj("organizationSelTree");
if(!n){var k=l.getNodes()[0];l.expandNode(k,true,false,true);}}}};$.fn.zTree.init($("#organizationSelTree"),j);},yes:function(j,g){var h=$.fn.zTree.getZTreeObj("organizationSelTree");
var f=h.getCheckedNodes(true);var l=[];for(var k=0;k<f.length;k++){var m={id:f[k].id,name:f[k].name};l.push(m);}if(c.fn){c.fn(l);}layer.close(j);}});}};
function SoEntityBase(){this.soCustomer=new SoCustomer();this.csFollow=new CsFollow();}SoEntityBase._CONS_={SO_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CS_DETAIL_URL:ctx+"/crm/cs/csEntity/edit.htm",EDIT_FORM_ID:"soEntityForm",};
SoEntityBase.prototype={init:function(){this._initBaseInfo();this.soCustomer.init(csId);this._initFollow();this._bindFormValidation();this._bindEventHander();
this._initPermissions();this._initServicePhone();this.priceFollowLog="";this.skuFollowLog="";},_initBaseInfo:function(){this._initSoItemPic();var b=$("input[name='status']").val();
if(""==b||"awaiting_post"==b||"awaiting_comfirm"==b||"awaiting_pay"==b){this._loadRecommendProds();var a=$("select[name=storeId]").val();if(a==undefined){a="";
}this._prodSearch(a);}this._calSoItemTotal();this._calWaitPayAmount();if("pay_sub"==$("[name=cashType]").val()){$("[name=subAmount]").attr("readonly",false);
}},_initServicePhone:function(){var a=$("#scCode").find("option:selected").attr("attr-mobile");$("#servicePhoneBtn").attr("masknum",a);},_initPermissions:function(){if(!ResUtils.canShow("mySoEntity.button.modifyProfit")){$("#selectEmpBtn").remove();
}if(!ResUtils.canShow("csEntity.totalPrice.modify")){$("input[name=totalAmount]").attr("readonly","readonly");}else{if(!$("input[name=totalAmount]").attr("readonly")){$("input[name=totalAmount]").removeAttr("readonly");
}}if(ResUtils.canShow("soEntity.button.viewPhoneBtn")){$(".viewPhone").show();}else{$(".viewPhone").hide();}if(!ResUtils.canShow("soEntitySearch.button.deleteSoLog")){$(".deleteSoLogTd").remove();
}ConfigUtils.findByKey("soEntity.isReceivePhone",function(a){if(a.success){$("#receivePhoneDiv").show();isReceivePhone=true;}else{$("#receivePhoneDiv").hide();
}});},_initFollow:function(){var b=this;var c=$("input[name=id]").val();if(c){var a="<a href='#' class='soTab' value='"+$("[name=soNo]").val()+"'>"+$("[name=soNo]").val()+"</a>，订单金额<span style='color:red'>"+$("[name=totalAmount]").val()+"元</span>)";
var d={csId:$("input[name=csId]").val(),csCode:$(".csCode").val(),entityId:c,needTable:false,followType:"so",contentExt:a,fn:function(e){b._addSoLog(e);
}};this.csFollow.init(d,{partyId:$("input[name=employeeId]").val(),partyAid:$("input[name=employeeAid]").val(),partyName:$("input[name=employeeName]").val()});
}},getSoItemData:function(){var e=[];var a=$("#soItemTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;b++){var d=$(a[b]);var c={};c.prodName=d.find(".prodShow").attr("nameValue");
c.id=d.attr("name");c.soId=d.find(".soId").val();c.skuId=d.find(".skuId").val();c.skuKey=d.find(".skuKey").val();c.isMain="y";c.salesPrice=d.find(".prodPrice").val();
c.count=d.find(".soItemCount").val();c.damageCount=d.find(".damageCount").val();c.damageReason=d.find(".damageReason").val();c.damageType=d.find(".damageType").val();
e.push(c);}}return JSON.stringify(e);},getSoProfitData:function(){var f=[];var a=$("#soProfitTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;
b++){var d=$(a[b]);var e={};var c=parseInt(parseFloat(d.find(".soProfitPercent").val())*100);if(c==0){continue;}e.partyId=d.find(".profitEmpId").val();
e.id=d.find(".profitId").val();e.percent=c;f.push(e);}}return JSON.stringify(f);},_loadRecommendProds:function(a){return;var a=$("select[name=storeId]").val();
$("#recomendProdsContainer").empty();var b=ctx+"/ec/salesorder/soEntity/getRecommendProds.htm?csId="+$("input[name=csId]").val()+"&storeId="+a+"&prodType=entity";
FormUtils.loadData(b,function(e){if(e&&e.length){var m=new StringBuffer();for(var g=0;g<e.length;g++){m.append("<div class='form-group' style='border-bottom: 1px solid #ddd;'>");
m.append("<div class='col-sm-2'>");m.append("<img src='"+ctx+e[g].path+"' style='height: 140px; width: 95px; padding-left:5px;'>");m.append("</div>");m.append("<div class='col-sm-5 skuContainer' imgUrlVal='"+e[g].path+"' selectedSkuIdVal='"+e[g].skuId+"' prodIdVal='"+e[g].id+"'>");
m.append("<p style='margin: 0 0 2px 0px;' class='prodNameContainer'><a nameValue='"+e[g].name+"' keyValue='"+e[g].key+"' class='prodShow' value='"+e[g].skuId+"' href='javascript:void(0);'>"+e[g].name+"</a></p>");
m.append("<p>"+e[g].subName+"</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("价格:");m.append("<strong style='color:red;' class='priceContainer'>￥"+e[g].price+"");
m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("sku:");m.append("<strong style='color: red;' class='skuCodeContainer'>");
m.append(e[g].skuCode);m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("库存数量:");m.append("<strong style='color: red;' class='stockContainer'>");
m.append(e[g].canSaleQty);m.append("</strong>");m.append("</p>");if(e[g].skuMap){for(var l in e[g].skuMap){m.append("<p class='chooseSku'>");m.append("<span>"+l+":</span>");
if(e[g].skuMap[l].length){for(var d=0;d<e[g].skuMap[l].length;d++){var f="btn-default";if(e[g].skuMap[l][d].isSelected=="y"){f="btn-primary";}m.append("<button valValue='"+e[g].skuMap[l][d].value+"' type='button' class='btn btn-xs "+f+" skuBtn'>"+e[g].skuMap[l][d].name+"</button>&nbsp;");
}}m.append("</p>");}}m.append("<p>");m.append("<button type='button' class='btn btn-xs  btn-primary addToCartBtn'>");m.append("购买</button>");m.append("</p>");
m.append("</div>");m.append("<div class='col-sm-5'>");for(var h in e[g].eavShowView.eavAttrValueMap){for(var c=0;c<e[g].eavShowView.eavAttrValueMap[h].length;
c++){for(var d=0;d<e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos.length;d++){if(e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].checked){m.append("<div class='checkbox checkbox-success checkbox-inline'>");
m.append("<input disabled='disabled' checked='checked' class='checkRes' type='checkbox'>");m.append("<label>"+e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].label+"</label>");
m.append("</div>");}}}}m.append("</div>");m.append("</div>");}$("#recomendProdsContainer").append(m.toString());}else{$("#recomendProdsContainer").append("<p>无推荐产品</p>");
}});},_bindEventHander:function(){var a=this;$("body").on("click",".viewPhone",function(){var d=this;var c=$(this).attr("attr-num");var b={number:c,callback:function(e){$(d).parents(".addrDiv").find(".addrMobile").val(e);
}};DecryptHelper.decrypt(b);});$(document).on("click",".delSoItem",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calSum();}});});$(document).on("change",".prodPrice",function(){var f=$(this).closest("tr");var g=$(f);var h=parseFloat(g.find(".originPrice").text());
var d=parseFloat(g.find(".skuPercentLimit").val());var b=parseFloat($(this).val());var j=0;var i="";var e=false;if(parseInt(percentLimit)){var k=parseFloat(h*(parseInt(percentLimit)/100)).toFixed(2);
j=k;if(parseFloat(k)>b){i="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+k;e=true;}}if(d){var k=parseFloat(h*(d/100)).toFixed(2);if(parseFloat(k)>b&&(parseFloat(k)<j||j<1)){i="该商品最低折扣为 "+d+"%，即最低金额为 "+k;
e=true;}else{if(parseFloat(k)<j||j<1){e=false;}}}if(e){$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+i+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(h);}a._calSum();});$(document).on("change",".soItemCount",function(){var e=$(this).closest("tr");
var g=$(e);var b=g.find(".buyLimit").val();if(parseFloat(b)){var j=g.find(".skuId").val();var l=$("#soItemTbody").find("tr");if(l&&l.length>0){var h=0;
for(var d=0;d<l.length;d++){var f=$(l[d]);if(f.find(".skuId").val()==j){h+=parseInt(f.find(".soItemCount").val());}}if(h>parseFloat(b)){var k="该商品数量超过每单限制"+b+"个";
$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+k+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(1);}}}a._calSum();});$("#recomendProdsContainer").on("click",".addToCartBtn",function(){var d=ctx+"/img/jt/nophoto.png";
var f=e.attr("imgUrlVal");if(f){var c={url:f,name:"",id:""};d=ImageUtils.getUrl(c);}var e=$(this).parents(".skuContainer");var b={prodId:e.attr("prodIdVal"),prodName:e.find(".prodNameContainer").text(),prodPic:e.attr("imgUrlVal"),prodSrc:d,skuId:e.attr("selectedskuidval"),skuCode:e.find(".skuCodeContainer").text(),isMain:"y",maindId:"",prodPrice:e.find(".priceContainer").text().substring(1),priceType:$("#prod-price-type").val(),canSaleQty:e.find(".stockContainer").text()};
a._addSoItem(b);});$(document).on("click",".delSoProfit",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calProfitPercent();}});});$(document).on("click",".deleteSoLog",function(){var c={id:$(this).attr("idVal")};var b=$(this).parents("tr");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/ec/salesorder/soEntity/deleteSoLog.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
b.remove();}});});});$(document).on("change",".soProfitPercent",function(){var c=$(this).val();$(this).val((parseFloat(c)).toFixed(2));var b=a._calProfitPercent();
if(b<0){}});$("#recomendProdsContainer").on("click",".skuBtn",function(){if($(this).hasClass("btn-default")){$(this).siblings("button").removeClass("btn-primary").addClass("btn-default");
$(this).removeClass("btn-default").addClass("btn-primary");var e=$(this).parents(".skuContainer");var b="";e.find(".chooseSku").each(function(){$(this).find(".skuBtn").each(function(){if($(this).hasClass("btn-primary")){b+=$(this).attr("valValue")+",";
return false;}});});b=b.substring(0,b.length-1);var d=e.attr("prodIdVal");var c=ctx+"/ec/product/prodEntity/switchSku.htm?prodEntityId="+d+"&skuJson="+b+"&storeId="+$("select[name=storeId]").val();
FormUtils.loadData(c,function(f){e.prev().find("img").attr("src",ctx+f.path);e.find(".priceContainer").text("￥"+f.price);e.find(".skuCodeContainer").text(f.skuCode);
e.find(".stockContainer").text(f.canSaleQty);e.attr("imgUrlVal",f.path);e.attr("selectedSkuIdVal",f.skuId);if(f.canSaleQty<=0){e.find(".addToCartBtn").attr("disabled","disabled");
}else{e.find(".addToCartBtn").removeAttr("disabled");}});}});$("#selectSkuBtn").on("click",function(){if(isSelectStoreInShip=="n"&&($("select[name=storeId]").val()==""||$("select[name=storeId]").val()==null)){DialogUtils.error(msgCode.WARING,"请先选择仓库");
return false;}var c="product";var b="y";if(isPoint){c="point";b="n";}a.hadClose=false;SelectProdService.selectSku({storeId:$("select[name=storeId]").val(),isMultiple:1,type:c,canSale:"y",isSale:"y",userId:currentUserId,priceType:$("#prod-price-type").val(),hasStock:$("#hasStock").is(":checked")?"y":"n",limitProdCate:b,fn:function(d){for(var e=0;
e<d.length;e++){if(a.checkIsCanAddSoItem(d[e])){a._addSoItem1({prodId:d[e].prodId,prodName:d[e].prodName,prodPic:d[e].imgUrl,skuId:d[e].skuId,skuCode:d[e].skuCode,isMain:"y",maindId:"",prodPrice:d[e].price,buyLimit:d[e].buyLimit,skuPercentLimit:d[e].skuPercentLimit,canSaleQty:d[e].totalQty,priceType:d[e].priceType,});
}}}});});$(document).on("click","#selectEmpBtn",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,callBack:function(h){if(h&&h.length>0){var f=[];
for(var e=0;e<h.length;e++){if(!a._hasAssignProfit(h[e].id)){var j={id:h[e].id,aid:h[e].aid,name:h[e].name,groupName:h[e].orgName};f.push(j);}}var g={employees:f};
a._addSoProfit(g);a._calProfitPercent();}}};var c=new EmployeesSelect();c.init(d);});$("#soEntityForm").on("change","select[name=storeId]",function(){var b=$(this).val();
var d=$("input[name=realStoreId]").val();var c=$("#soItemTbody").find("tr");if(c&&c.length>0){if(d){$("select[name=storeId]").val(d);}else{$(this).find("option").eq(0).prop("selected",true);
}DialogUtils.error(msgCode.WARING,"已有订购的商品，不能改变仓库");return;}$("input[name=realStoreId]").val(b);a._prodSearch(b);a._loadRecommendProds();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=shippingAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=subAmount]",function(){a._calSum(null,null,true);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=billAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=totalAmount]",function(){var c=$(this).val();var d="总价格从"+$("#totalAmount").val()+"变成"+c;
$("input[name=priceFollowLog]").val(d);var b=$(this);a._calSum(c,b);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=cashType]",function(){var b=$(this).val();
$("input[name=subAmount]").attr("readonly",false);$("input[name=shippingAmount]").attr("readonly",false);$("input[name=totalAmount]").attr("readonly",false);
if(b=="free"){$("input[name=subAmount]").val("0.00");$("input[name=shippingAmount]").val("0.00");$("input[name=totalAmount]").val("0.00");$("input[name=waitPayAmount]").val("0.00");
$("input[name=subAmount]").attr("readonly",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
}else{if(b!="pay_sub"){$("input[name=subAmount]").val("0.00");$("input[name=subAmount]").attr("readonly",true);a._calSum();}}if($(".myCsTotalAmount").hasClass("notModify")){$(".myCsTotalAmount").attr("readonly",true);
}if($(".subCsTotalAmount").hasClass("notModify")){$(".subCsTotalAmount").attr("readonly",true);}if(b=="cod"||b=="free"){$("select[name=payType]").empty().append("<option value='cash'>现金支付</option><option value='weixinhongbao'>微信红包</option><option value='QRCode'>收款码支付</option>");
}else{$("select[name=payType]").empty().append("<option value='alipay'>支付宝</option><option value='weixin'>微信支付</option><option value='weixinhongbao'>微信红包</option><option value='bank'>银行转账</option><option value='cash'>现金支付</option><option value='QRCode'>收款码支付</option>");
}$("select[name=payType]").trigger("change");});$(document).on("change","select[name=payType]",function(){var b=$(this).val();var d=$("select[name=account]").find("option");
if(d&&d.length>0){for(var c=0;c<d.length;c++){if($(d[c]).attr("attr-type")==b){$("select[name=account]").val($(d[c]).attr("value"));break;}else{$("select[name=account]").val("");
}}}if(b=="cash"){$("select[name=account]").attr("disabled",true);}else{$("select[name=account]").attr("disabled",false);}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=billType]",function(){if($("select[name=billType]").val()=="none"){a._hideBillInfo();
$("input[name=billAmount]").val("0").trigger("change");$("input[name=billTitle]").val("");$("input[name=billContent]").val("");}else{if($("select[name=billType]").val()=="common"){a._showBillInfo();
$("input[name=billAmount]").val("0").trigger("change");}else{if($("select[name=billType]").val()=="receipt"){a._showBillInfo();$("input[name=billAmount]").val("0").trigger("change");
}else{a._showBillInfo();}}}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".addAddr",function(){var b=new ShopAddrOpt();b.init({csId:$("input[name=csId]").val(),callBack:function(e){var d=$.templates("#addrTmpl");
var c=d.render(e);$(".defaultAddr").show().after(c);$(".csAddrDiv:first").find("[name=chooseAddr]").trigger("click");$(".changeAddr").show();$(".addAddrDiv").hide();
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".editAddr",function(){var b=$(this).parents(".csAddrDiv");var c=$(this).parents(".csAddrDiv").prevAll(".defaultAddr");
var d=new ShopAddrOpt();d.init({addrId:$(this).attr("idVal"),csId:$('input[name="csId"]').val(),isCs:false,callBack:function(f){b.find(".addrName").val(f.name);
b.find(".addrMobile").val(MaskPhoneNum.getMaskPhoneNum(f.mobile));var e="";if(f.prName){e+=f.prName+",";}if(f.ciName){e+=f.ciName+",";}if(f.arName){e+=f.arName+",";
}b.find(".addrInfo").val(e+f.toName+f.addr);b.find("[name=chooseAddr]").attr("coName",f.coName);b.find("[name=chooseAddr]").attr("prName",f.prName);b.find("[name=chooseAddr]").attr("ciName",f.ciName);
b.find("[name=chooseAddr]").attr("arName",f.arName);b.find("[name=chooseAddr]").attr("addrDetail",f.addr);b.find("[name=chooseAddr]").trigger("click");
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".changeAddr",function(){if($(".csAddrDiv").is(":hidden")){$(".csAddrDiv").show();}else{$(".csAddrDiv").hide();
}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click","[name=chooseAddr]",function(){var i=$(this).parents(".csAddrDiv");var h=$(".defaultAddr");var c=$(this).val();
var e=$(this).attr("coName");var l=$(this).attr("prName");var j=$(this).attr("ciName");var g=$(this).attr("arName");var k=$(this).attr("addrDetail");var b=i.find(".addrName").val();
var f=i.find(".addrMobile").val();var d=i.find(".addrInfo").val();h.find("[name=addrId]").val(c);h.find("[name=coName]").val(e);h.find("[name=prName]").val(l);
h.find("[name=ciName]").val(j);h.find("[name=arName]").val(g);h.find("[name=addrDetail]").val(k);h.find(".addrName").val(b);h.find(".addrMobile").val(f);
h.find(".addrInfo").val(d);$(".csAddrDiv").hide();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("focus","#searchProd",function(){var b=$("select[name=storeId]").val();
if(isSelectStoreInShip=="n"&&(b==null||b=="")){DialogUtils.error(msgCode.WARING,"请先选择仓库");}});$("#hasStock").on("change",function(){a._prodSearch($("select[name=storeId]").val());
});$("#prod-price-type").on("change",function(){a._prodSearch($("select[name=storeId]").val());});$(document).on("click",".soTab",function(){var c=$(this).attr("csNameVal");
var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(SoEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,b+"的订单明细");});$(document).on("click",".prodShow",function(){var c=$(this).attr("value");
var b=$(this).attr("nameValue");var d=b;if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品["+d+"",b);
});$(document).on("click",".copyCsBtn",function(){$("#csCodeText").select();document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});$(document).on("click",".copySoBtn",function(){$("#soCodeText").select();
document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});},destroyPopover:function(a){a.popover("destroy");},_hasAssignProfit:function(d){var a=false;
var c=$(".profitEmpId");if(c&&c.length>0){for(var b=0;b<c.length;b++){if(d==$(c[b]).val()){a=true;}}}return a;},_calProfitPercent:function(){var d=$(".soProfitPercent");
var c=0;$(".soProfitPercent").css("color","black");$("#soProfitTip").empty().hide();if(d&&d.length>1){for(var b=1;b<d.length;b++){if(parseFloat($(d[b]).val())<=0){$(d[b]).css("color","red");
$("#soProfitTip").empty().append("（员工绩效分成比例必须大于0）").show();}c=parseFloat(c)+parseFloat($(d[b]).val());}}var a=(parseFloat(100)-parseFloat(c)).toFixed(2);
$(d[0]).val(a);if(a<0){$(d[0]).css("color","red");$("#soProfitTip").empty().append("（员工分成比例总和必须等于100）").show();}},_validateAmount:function(a){try{$("input[name=totalAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=subAmount]").val()),messages:{}});
if(a){$("input[name=subAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=totalAmount]").val()),max:parseFloat($("input[name=totalAmount]").val()),messages:{min:"订金需等于总金额",max:"订金需等于总金额"}});
}else{$("input[name=subAmount]").rules("add",{required:true,number:true,min:0,max:parseFloat($("input[name=totalAmount]").val()),messages:{}});}}catch(b){}},_prodSearch:function(a){if(a==undefined){a="";
}$("#searchProd").bsSuggest("destroy");if(isSelectStoreInShip=="n"&&(a==null||a=="")){return;}var b=this;var e=$("#searchProd").width()+"px";if($("#searchProd").width()<=500){e=($(".itemDiv").width()*5/6)+"px";
}var c="entity";var g=$("#hasStock").is(":checked")?"y":"n";var f=$("#prod-price-type").val();var d="y";if(isPoint){d="n";c="point";}$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+g+"&storeId="+a+"&priceType="+f+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodPic","prodName","skuCode","cateName","unit","prodTotal","skuAttr","canSaleQty"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodPic:"图片",prodName:"产品名字",skuCode:"sku编码",cateName:"产品分类",unit:"单位",prodTotal:"价格",skuAttr:"sku属性",canSaleQty:"可售数量"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(h){for(var k=0;
k<h.value.length;k++){var j="<img style='display: inline; height:35px;' ";if(h.value[k].prodPic){j=j+" src='"+ctx+h.value[k].prodPic+"'>";}else{j=j+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";
}h.value[k].prodPic=j;}b.searchProds=h.value;return h;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(i,h){}).on("onSetSelectValue",function(k,h){for(var j=0;
j<b.searchProds.length;j++){if(b.searchProds[j].skuId==h.id){b.currentProd=b.searchProds[j];break;}}if(b.checkIsCanAddSoItem(b.currentProd)){b._addSoItem(b.currentProd);
$("#searchProd").val("");}}).on("onUnsetSelectValue",function(h){b.currentProd={};});},checkIsCanAddSoItem:function(b){if(parseFloat(b.buyLimit)){var a=$("#soItemTbody").find("tr");
if(a&&a.length>0){var e=0;for(var c=0;c<a.length;c++){var d=$(a[c]);if(d.find(".skuId").val()==b.skuId){e+=parseInt(d.find(".soItemCount").val());}}if((e+1)>parseFloat(b.buyLimit)){var f=b.prodName+", 每单数量限制不能大于"+b.buyLimit+"个";
$("#soItemWarm").attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+f+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soItemWarm").popover("show");setTimeout(function(){$("#soItemWarm").popover("destroy");},3000);return false;}}return true;}else{return true;}},_addSoItem1:function(f){if(!f.prodPic){f.prodPic="";
f.prodSrc=ctx+"/img/jt/nophoto.png";}else{var c={url:f.prodPic,name:"",id:""};f.prodSrc=ImageUtils.getUrl(c);f.prodPic=ImageUtils.getUrl(c);}if(f.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(f.priceType=="special"){f.spComment="特价";}else{if(f.priceType=="gift"){f.spComment="赠品";}}}var e=f.skuPercentLimit;var g=0;if(e&&parseFloat(e)>0){g=parseFloat(e);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(g)||parseFloat(g)<1)){g=parseInt(percentLimit);}f.prodTotal=this._calProdTotal(f.prodPrice,1,g,f.originPrice);
f.originPrice=f.prodPrice;f.unit=f.unit;var d=$.templates("#soItemTmpl1");var a=d.render(f);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_addSoItem:function(e){if(e.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(e.priceType=="special"){e.spComment="特价";}else{if(e.priceType=="gift"){e.spComment="赠品";}}}var d=e.skuPercentLimit;var f=0;if(d&&parseFloat(d)>0){f=parseFloat(d);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(f)||parseFloat(f)<1)){f=parseInt(percentLimit);}e.prodTotal=this._calProdTotal(e.prodPrice,1,f,e.originPrice);
e.originPrice=e.prodPrice;e.unit=e.unit;var c=$.templates("#soItemTmpl");var a=c.render(e);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_calProdTotal:function(e,d,f,a){var c=(parseFloat(e)*parseInt(d)).toFixed(2);
var b=(parseFloat(a)*parseInt(f)/100).toFixed(2);if(autoPercent!=0){if(parseFloat(e)==parseFloat(a)){if(parseFloat(autoPercent)<f&&f!=100){c=(c*parseInt(f)/100).toFixed(2);
b=(b*parseInt(f)/100).toFixed(2);}else{c=(c*parseInt(autoPercent)/100).toFixed(2);b=(b*parseInt(autoPercent)/100).toFixed(2);}}}if(parseFloat(c)<parseFloat(b)){return b;
}return c;},_calSoItemTotal:function(){var d=0;var m=0;var e=0;var n=$("#soItemTbody").find("tr");if(n&&n.length>0){for(var h=0;h<n.length;h++){var j=$(n[h]);
var b=j.find(".prodPrice").val();var c=j.find(".soItemCount").val();var k=j.find(".originPrice").text();var g=j.find(".skuPercentLimit").val();var l=j.find(".priceType").val();
var a=0;if(g&&parseFloat(g)>0){a=parseFloat(g);}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(a)||parseFloat(a)<1)){a=parseInt(percentLimit);
}var f=this._calProdTotal(b,c,a,k);j.find(".prodTotal").text(f);d=parseInt(d)+parseInt(c);m=(parseFloat(m)+parseFloat(f)).toFixed(2);e=(parseFloat(k)*parseInt(c)+parseFloat(e)).toFixed(2);
}}$("#itemCountTotal").text(d);$("#prodPriceTotal").text(m);$("#itemOriginCount").text(e);},_averageTotal:function(a,n,l){var m=this;var f=$("#soItemTbody").find("tr");
var p=[];if(f&&f.length>0){var r=0;var d=0;for(var s=0;s<f.length;s++){var u=$(f[s]);var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var e=u.find(".soItemCount").val();
d+=parseInt(e);var k=u.find(".originPrice").text();var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<b||b<1)){b=parseInt(percentLimit);
}if(t||parseInt(percentLimit)){r+=parseFloat(k)*(b/100).toFixed(2)*parseInt(e);}else{if(!t&&!parseInt(percentLimit)){}else{r+=parseFloat(k)*parseInt(e);
}}p.push(b);}var g=0;for(var q=0;q<p.length;q++){if(p[q]>parseFloat(a)*100){g++;}}if(g==f.length||(g>0&&g<f.length&&n<r)||(n<r)){var h="修改的总金额小于所有商品最低折扣，最低商品金额为 "+r;
l.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");setTimeout(function(){m.destroyPopover(l);},3000);return false;}if(g==0){for(var s=0;s<f.length;
s++){var u=$(f[s]);var k=u.find(".originPrice").text();var o=parseFloat(parseFloat(k)*parseFloat(a)).toFixed(2);u.find(".prodPrice").val(parseFloat(o));
}this._calSoItemTotal();return true;}if((g>0&&g<f.length)){var c=parseFloat((parseFloat(n)-r)/d).toFixed(2);for(var s=0;s<f.length;s++){var u=$(f[s]);var k=u.find(".originPrice").text();
var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&parseInt(percentLimit)<b||b<1){b=parseInt(percentLimit);
}var o=0;if(t||parseInt(percentLimit)){o=parseFloat(parseFloat(k)*b/100+parseFloat(c)).toFixed(2);}else{o=parseFloat(parseFloat(k)+parseFloat(c)).toFixed(2);
}u.find(".prodPrice").val(o);}this._calSoItemTotal();return true;}}},_calSum:function(n,j,l){var k=this;var p=false;if(isOpenTotalLinkSale&&isOpenTotalLinkSale=="y"){p=true;
}var o=false;if(n){o=true;}k._calSoItemTotal();var r=$("#prodPriceTotal").text();var d=$("#itemOriginCount").text();var i=$("[name=shippingAmount]").val();
var e=$("[name=billAmount]").val();var q=$("[name=cashType]").val();var c=$("[name=cashBenefit]").val();if("free"==q){n=0;}if(o&&p){var m=parseFloat(parseFloat(n)-parseFloat(i)-parseFloat(e)).toFixed(2);
var a=parseFloat(m/parseFloat(d));if(!this._averageTotal(a,m,j)){this._calSum();return;}}if(!n&&n!=0){n=(parseFloat(r)+parseFloat(i)+parseFloat(e)).toFixed(2);
}if(c){n=(parseFloat(n)-parseFloat(c)).toFixed(2);}if(percentLimit&&o&&p){var b=$("#itemOriginCount").text();var f=(parseFloat(b)*(parseInt(percentLimit)/100)+parseFloat(i)+parseFloat(e)).toFixed(2);
if(c){f=(parseFloat(f)-parseFloat(c)).toFixed(2);}if(parseFloat(f)>parseFloat(n)){var h="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+f;j.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");n=f;setTimeout(function(){k.destroyPopover(j);},3000);}}if(!l){$("[name=totalAmount]").val(n);
}k._calWaitPayAmount();var g=false;if("cod"==$("select[name=cashType]").val()&&"shipping"==$("input[name=status]").val()){g=true;}k._validateAmount(g);
},_calWaitPayAmount:function(){var c=0;var d=$("[name=totalAmount]").val();var a=$("[name=subAmount]").val();var b=$("select[name=cashType]").val();if("pay_sub"==b||"cod"==b){c=(parseFloat(d)-parseFloat(a)).toFixed(2);
}else{var e=$("input[name=payedAmount]").val();c=(parseFloat(d)-parseFloat(e)).toFixed(2);}$("[name=waitPayAmount]").val(c);},_addSoProfit:function(b){var c=$.templates("#soProfitTmpl");
var a=c.render(b);$("#soProfitTbody").append(a);},_addSoLog:function(b){var c={};c.employeeAid=currentUserAid;c.employeeName=currentUserName;c.srcType="option_sys";
c.type="task";c.result="跟进成功";c.createTime=DateUtils.format(new Date(),DateUtils._CONS_.DEFAULT_DATE_TIME_PATTERN);c.comment=b.content;var d=$.templates("#soLogTmpl");
var a=d.render(c);$("#soLogTbody").prepend(a);},_showBillInfo:function(){$(".billAmountDiv").show();$(".billTitleDiv").show();$(".billContentDiv").show();
},_hideBillInfo:function(){$(".billAmountDiv").hide();$(".billTitleDiv").hide();$(".billContentDiv").hide();},_bindFormValidation:function(){var a=this;
var b={rules:{shippingAmount:{required:true,number:true,min:0},subAmount:{number:true,min:0},billAmount:{number:true,min:0},totalAmount:{required:true,number:true,min:0},},messages:{}};
FormUtils.bindFormValidation(SoEntityBase._CONS_.EDIT_FORM_ID,b);a._validateAmount();},_initSoItemPic:function(){var a=$(".soItemPic");if(a&&a.length>0){for(var c=0;
c<a.length;c++){var d=$(a[c]).attr("urlVal");if(d){var b={url:d,name:"",id:""};var e=ImageUtils.getUrl(b);$(a[c]).attr("src",e);}else{$(a[c]).attr("src",ctx+"/img/jt/nophoto.png");
}}}}};function SoItem(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.otherFunc=null;this.soItemRowid=0;this.isPoint=false;this.csPercent=100;
this.canEditPrice=false;}SoItem._CONS_={GRID:"#soItemGrid",GRID_ID:"soItemGrid",DIV_ID:"soItemDiv",PAGER:"#soItemPager",PAGER_ID:"soItemPager",JSON_ID:"soItemJSON",CS_LEVEL_URL:ctx+"/ec/salesorder/soEntity/getCsLevel.htm",};
SoItem.prototype={init:function(b){var a=this;if(b){a.otherFunc=b.otherFunc;if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;}if(b.csId!=undefined){this._getCsPre(b.csId);
}if(b.canEditPrice!=undefined){this.canEditPrice=b.canEditPrice;}}if(a.isPoint){a._initPointJqgrid(b);}else{a._initJqgrid(b);}if(!a.hadInit){a.hadInit=true;
a._bindEventHander();}},_getCsPre:function(b){var a=this;FormUtils.loadData(SoItem._CONS_.CS_LEVEL_URL+"?csId="+b,function(c){if(c!=null){a.csPercent=parseInt(c);
}});},_bindEventHander:function(){var a=this;$(document).on("click",".prodShow",function(){var c=$(this).attr("value"),b=d=$(this).attr("nameValue"),d;
if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品【"+d+"】",b);});$(document).on("click","#soItemButtonId",function(){a.addSoItem2Grid("soItemGrid");
});$(document).on("click","#soItemSaveButton",function(){a.editSoItem2Grid("soItemGrid");});$(document).on("click",".delSoItem",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){$(SoItem._CONS_.GRID).delRowData(b);}});});$(document).on("change","input[name=countShow]",function(){var h=$(this).parent().parent().attr("id");
var f=$(this).val();if(a.isPoint){var b=a.calMaxExchangeCount(h);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");f=b;$(this).val(f);}}$(SoItem._CONS_.GRID).setCell(h,"count",f);var g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(h,"spDiscout")).toFixed(2);
if($(SoItem._CONS_.GRID).getCell(h,"priceType")=="common"){g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*a.csPercent/100).toFixed(2);var c=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);
$(SoItem._CONS_.GRID).setCell(h,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(h,"spDiscoutShow",c);}$(SoItem._CONS_.GRID).setCell(h,"totalAmount",g);var e=a.footerData();
if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=salesPriceShow]",function(){var i=$(this).parent().parent().attr("id");var g=$(this).val();
var f=$("input[name=countShow]").val();if(a.isPoint){var b=a.calMaxExchangeCount(i);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");var f=b;$("input[name=countShow]").val(f);$(SoItem._CONS_.GRID).setCell(i,"count",f);}}$(SoItem._CONS_.GRID).setCell(i,"salesPrice",g);
var h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(i,"spDiscout")).toFixed(2);if($(SoItem._CONS_.GRID).getCell(i,"priceType")=="common"){h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*a.csPercent/100).toFixed(2);
var c=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);$(SoItem._CONS_.GRID).setCell(i,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(i,"spDiscoutShow",c);
}$(SoItem._CONS_.GRID).setCell(i,"totalAmount",h);var e=a.footerData();if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=spDiscoutShow]",function(){var d=$(this).parent().parent().attr("id");
var e="0";if(!(isNaN($(this).val())||$(this).val()=="")){e=parseFloat($(this).val()).toFixed(2);$(this).val(e);}$(SoItem._CONS_.GRID).setCell(d,"spDiscout",e);
var c=$(SoItem._CONS_.GRID).getCell(d,"salesPrice")*$(SoItem._CONS_.GRID).getCell(d,"count")-e;$(SoItem._CONS_.GRID).setCell(d,"totalAmount",c);var b=a.footerData();
if(a.otherFunc!=null){a.otherFunc(b);}});$(document).on("change","input[name=spCommentShow]",function(){var c=$(this).parent().parent().attr("id");var b=$(this).val();
$(SoItem._CONS_.GRID).setCell(c,"spComment",b);});$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},_initJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].salesPriceShow=d[b].salesPrice;d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append("<table class='table table-bordered table-stripped' id=\""+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","原价(元)","库存数量","数量","价格隐藏","数量隐藏","商品价格类型","折扣(元)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(元)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,i){var h=f;
if(i.prodName){h="<a href='#' class='prodShow' value='"+i.skuId+"' nameValue='"+i.prodName+"'>"+i.skuKey+":"+i.prodName+"</a>";h+=a._creatReturnType(i.afterSaleType)+a._creatReturnStatus(i);
}return h;}},{name:"salesPriceShow",sortable:false,align:"center",classes:"test",width:80,editable:a.canEditPrice,formatter:"number"},{name:"stockCount",sortable:false,align:"center",editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:85,formatter:function(f,g,h){if(h.stockCount<1){return"<span>"+h.stockCount+"</span>";
}return"<span>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"center",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"salesPrice",sortable:false,editable:false,hidedlg:true,hidden:true,width:120},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"priceType",sortable:false,width:120,hidedlg:true,hidden:true},{name:"spDiscoutShow",sortable:false,align:"center",editable:a.isCanEdit,formatter:"number",classes:"test",width:90},{name:"spCommentShow",sortable:false,editable:a.isCanEdit,width:120,classes:"test"},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:120},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"center",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var k="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;'  value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}for(var g=0;g<h.length;g++){var j=$(SoItem._CONS_.GRID).jqGrid("getRowData",h[g]);if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
if(j["priceType"]!="exchange"){$("#"+h[g]+"_spDiscoutShow").attr("readonly",true);$("#"+h[g]+"_spCommentShow").attr("readonly",true);}}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();
$("input[name=countShow]").css("text-align","right");$("input[name=spDiscoutShow]").css("text-align","right");},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:7,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
},footerData:function(){var c=$(SoItem._CONS_.GRID).jqGrid("getCol","totalAmount",true,"sum");var b=$(SoItem._CONS_.GRID).jqGrid("getCol","count",true,"sum");
$(SoItem._CONS_.GRID).jqGrid("footerData","set",{prodPic:"总计:",countShow:b,totalAmount:c});var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;
},getFooterData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;},_creatReturnType:function(a){var b="";if("back"==a||"reject"==a){b="<span style='color:red;'>[退]</sapn>";
}else{if("exchange"==a){b="<span style='color:blue;'>[换]</sapn>";}}return b;},_creatReturnStatus:function(a){var b="";if(a.afterSaleType){if(a.afterSaleStatus=="processing"){b="<span style='color:red;'>[未]</sapn>";
}else{if(a.afterSaleStatus=="complete"){b="<span style='color:green;'>[已]</sapn>";}else{if(a.afterSaleStatus=="stop"){b="<span style='color:blue;'>[终]</sapn>";
}else{if(a.afterSaleStatus=="bad"){b="<span style='color:green;'>[已]</sapn>"+"<span style='color:red;'>[次]</sapn>";}}}}}return b;},getSoItemGridData:function(){var c=$(SoItem._CONS_.GRID);
var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;a++){var e=c.jqGrid("getRowData",d[a]);if(e["count"]==""){continue;
}else{if(parseInt(e["count"])<1){continue;}}f++;b.append("soItemPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soItemPos[").append(f-1).append("].skuId=").append(e["skuId"]).append("&").append("soItemPos[").append(f-1).append("].skuKey=").append(e["skuKey"]).append("&").append("soItemPos[").append(f-1).append("].isMain=").append(e["isMain"]).append("&").append("soItemPos[").append(f-1).append("].mainId=").append(e["mainId"]).append("&").append("soItemPos[").append(f-1).append("].salesPrice=").append(e["salesPrice"]).append("&").append("soItemPos[").append(f-1).append("].count=").append(e["count"]).append("&").append("soItemPos[").append(f-1).append("].discout=").append(e["discout"]).append("&").append("soItemPos[").append(f-1).append("].spDiscout=").append(e["spDiscout"]).append("&").append("soItemPos[").append(f-1).append("].spComment=").append(e["spComment"]).append("&").append("soItemPos[").append(f-1).append("].invoice=").append(e["invoice"]).append("&").append("soItemPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soItemPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(d[a].indexOf("tmpSoItem")==-1){b.append("soItemPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},getRowLength:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
return a.length;},soItemOperFunc:function(b,a){return b;},addSoItem2Grid:function(d){var a=this;var c=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");var f=0;
for(var b=0;b<c.length;b++){var e=$(SoItem._CONS_.GRID).jqGrid("getRowData",c[b]);if(e["skuId"]==d.skuId){DialogUtils.error(msgCode.WARING,"订购列表已有该商品");
return;}}d.soId="";d.count="1";d.discout="0.00";d.invoice="";d.createTime="";d.updateTime="";d.countShow=d.count;d.salesPriceShow=d.salesPrice;d.spDiscout="0.00";
if(d.priceType=="common"){d.spDiscout=(parseFloat(d.salesPrice)*(100-a.csPercent)/100).toFixed(2);}d.spComment=d.priceType=="special"?"特价":d.priceType=="gift"?"赠品":" ";
if(d.priceType=="common"){if(a.csPercent==100){d.spComment="正价商品";}else{d.spComment="正价商品"+parseFloat(a.csPercent/10).toFixed(1)+"折";}}d.spDiscoutShow=d.spDiscout;
d.spCommentShow=d.spComment;d.totalAmount=parseFloat(d.salesPrice)*parseInt(d.count)-parseFloat(d.spDiscout);$(SoItem._CONS_.GRID).jqGrid("addRowData","tmpSoItem"+a.soItemRowid,d,"last");
a.soItemRowid++;},isHadData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");if(a.length>0){return true;}return false;},_initPointJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append('<table id="'+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","兑换积分","库存数量","数量","数量隐藏","折扣(积分)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(积分)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,h){if(h.prodName!=null&&h.prodName!=0){return"<a href='#' class='prodShow' value='"+h.prodId+"' keyValue='"+h.skuKey+"' nameValue='"+h.prodName+"'>"+h.prodName+"</a>";
}return h.prodName;}},{name:"salesPrice",sortable:false,align:"center",classes:"test",width:90},{name:"stockCount",sortable:false,editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:90,formatter:function(f,g,h){if(h.stockCount<1){return"<span class='label label-danger'>"+h.stockCount+"</span>";
}return"<span class='label label-primary'>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"right",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"spDiscoutShow",sortable:false,hidedlg:true,hidden:true},{name:"spCommentShow",sortable:false,hidedlg:true,hidden:true},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:90},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"right",classes:"test",formatter:"integer",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;' value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:j});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");for(var g=0;g<h.length;g++){if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:6,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},calMaxExchangeCount:function(h){var a=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
var e=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=totalAmount]").val();var b=$(SoItem._CONS_.GRID).getCell(h,"totalAmount");var d=$(SoItem._CONS_.GRID).getCell(h,"salesPrice");
var g=e-b;var c=a-g;var f=c/d;return parseInt(f);}};function SoLog(){this.hadInit=false;this.isEdit=false;this.soLogRowid=0;}SoLog._CONS_={GRID:"#soLogGrid",GRID_ID:"soLogGrid",DIV_ID:".soLogDiv",PAGER:"#soLogPager",PAGER_ID:"soLogPager",JSON_ID:"soLogJSON",};
SoLog.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a._initJqgrid(b);},_bindEventHander:function(){var a=this;
},_initJqgrid:function(c){var a=this;var b=[];if(c){if(typeof c.data!=undefined&&c.data!=null&&c.data.length){b=c.data;}}$(SoLog._CONS_.DIV_ID).empty().append('<table id="'+SoLog._CONS_.GRID_ID+'"></table>                         <div id="'+SoLog._CONS_.PAGER_ID+'"></div>                         <input type="hidden"  name="'+SoLog._CONS_.JSON_ID+'"  id="'+SoLog._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoLog._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:b,autowidth:true,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["所属订单 ID","操作者 ID","操作者类型 ","操作者","流水来源","操作类型","操作结果","操作时间","备注","订单前状态","当前状态","支付前状态","当前支付状态"],colModel:[{name:"soId",editable:true,width:120,hidedlg:true,hidden:true},{name:"partyId",editable:true,width:120,hidedlg:true,hidden:true},{name:"partyTypeKey",editable:true,width:120,hidedlg:true,hidden:true},{name:"name",editable:true,width:120,formatter:function(d,e,f){return f.name+":"+f.employeeAid;
}},{name:"srcType",editable:true,width:100,formatter:function(d,f,g){var e=g.srcType;if(g.srcType=="flow_sys"){e="订单状态变动生成";}else{if(g.srcType=="option_sys"){e="其他操作生成";
}else{if(g.srcType=="manual"){e="人工";}}}return e;}},{name:"type",editable:true,width:90,formatter:function(d,f,g){var e=g.type;if(g.type=="add"){e="创建";
}else{if(g.type=="edit"){e="修改";}else{if(g.type=="paid_up"){e="已支付";}else{if(g.type=="submit"){e="提交";}else{if(g.type=="pay"){e="支付确认";}else{if(g.type=="comfirm"){e="审核";
}else{if(g.type=="pack"){e="备货";}else{if(g.type=="deliver"){e="打包";}else{if(g.type=="shipping"){e="发货";}else{if(g.type=="back_deliver"){e="撤销发货";}else{if(g.type=="shipped"){e="订单跟进";
}else{if(g.type=="back_complete"){e="撤销完成";}else{if(g.type=="turndown"){e="驳回";}else{if(g.type=="close"){e="关闭";}else{if(g.type=="back"){e="退回处理";}else{if(g.type=="awaiting_refund"){e="退款申请";
}else{if(g.type=="refund"){e="退款完成";}else{if(g.type=="lock"){e="锁定";}else{if(g.type=="unlock"){e="解锁";}else{if(g.type=="other_oper"){e="其他操作";}else{if(g.type=="remark"){e="人工备注";
}else{if(g.type=="task"){e="跟进";}}}}}}}}}}}}}}}}}}}}}}return e;}},{name:"result",editable:true,width:170},{name:"createTime",editable:true,width:100},{name:"comment",editable:true,width:220},{name:"preStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.preStatus;
if(g.preStatus=="awaiting_pay"){e="等待支付";}else{if(g.preStatus=="awaiting_post"){e="待提交";}else{if(g.preStatus=="paid_up"){e="已支付";}else{if(g.preStatus=="awaiting_comfirm"){e="待审核";
}else{if(g.preStatus=="lock"){e="锁定";}else{if(g.preStatus=="comfirm"){e="已审核";}else{if(g.preStatus=="packing"){e="待备货";}else{if(g.preStatus=="deliver"){e="待发货";
}else{if(g.preStatus=="shipping"){e="已发货";}else{if(g.preStatus=="shipped"){e="已签收";}else{if(g.preStatus=="complete"){e="已签收";}else{if(g.preStatus=="close"){e="订单关闭";
}else{if(g.preStatus=="back"){e="待退回";}else{if(g.preStatus=="awaiting_refund"){e="申请退款";}else{if(g.preStatus=="refund"){e="已退款";}else{if(g.preStatus=="reject"){e="拒收";
}else{if(g.preStatus=="close_repeat"){e="订单结束（需重发）";}else{if(g.preStatus=="close_lost"){e="包裹丢失";}}}}}}}}}}}}}}}}}}return e;}},{name:"curStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.curStatus;
if(g.curStatus=="awaiting_pay"){e="等待支付";}else{if(g.curStatus=="awaiting_post"){e="待提交";}else{if(g.curStatus=="paid_up"){e="已支付";}else{if(g.curStatus=="awaiting_comfirm"){e="待审核";
}else{if(g.curStatus=="lock"){e="锁定";}else{if(g.curStatus=="comfirm"){e="待发货";}else{if(g.curStatus=="packing"){e="待备货";}else{if(g.curStatus=="deliver"){e="待发货";
}else{if(g.curStatus=="shipping"){e="已发货";}else{if(g.curStatus=="shipped"){e="已签收";}else{if(g.curStatus=="complete"){e="已签收";}else{if(g.curStatus=="close"){e="订单作废";
}else{if(g.curStatus=="back"){e="待退回";}else{if(g.curStatus=="awaiting_refund"){e="申请退款";}else{if(g.curStatus=="refund"){e="已退款";}else{if(g.curStatus=="reject"){e="拒收";
}else{if(g.curStatus=="close_repeat"){e="订单结束（需重发）";}else{if(g.curStatus=="close_lost"){e="包裹丢失";}}}}}}}}}}}}}}}}}}return e;}},{name:"prePayStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.prePayStatus;
if(g.prePayStatus=="unpaid"){e="未支付";}else{if(g.prePayStatus=="partial"){e="部分支付";}else{if(g.prePayStatus=="paid_off"){e="已支付";}}}}},{name:"curPayStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.curPayStatus;
if(g.curPayStatus=="unpaid"){e="未支付";}else{if(g.curPayStatus=="partial"){e="部分支付";}else{if(g.curPayStatus=="paid_off"){e="已支付";}}}return e;}}],pager:SoLog._CONS_.PAGER,hidegrid:false,});
},addSoLog2Grid:function(c){var a=this;if(a.validateSoLogGrid()){var b={soId:$("input[name=soLog_soId").val(),partyId:$("input[name=soLog_partyId").val(),partyTypeKey:$("input[name=soLog_partyTypeKey").val(),name:$("input[name=soLog_name").val(),srcType:$("input[name=soLog_srcType").val(),comment:$("input[name=soLog_comment").val(),preStatus:$("input[name=soLog_preStatus").val(),curStatus:$("input[name=soLog_curStatus").val(),prePayStatus:$("input[name=soLog_prePayStatus").val(),curPayStatus:$("input[name=soLog_curPayStatus").val(),createTime:$("input[name=soLog_createTime").val()};
$("#"+c).jqGrid("addRowData","tmp@soLog"+a.soLogRowid,b,"last");a.soLogRowid++;}},};function SoShip(){this.hadInit=false;this.isEdit=false;this.soShipRowid=0;
if(typeof SoShip._initialized=="undefined"){SoShip._initialized=true;SoShip.prototype.init=function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();
a._initJqgrid(b);}};SoShip.prototype._bindEventHander=function(){var a=this;$(document).on("click","#soShipButtonId",function(){a.addSoShip2Grid("soShipGrid");
});$(document).on("click","#soShipSaveButton",function(){a.editSoShip2Grid("soShipGrid");});$(document).on("click","#soShipRestButtonId",function(){});
};SoShip.prototype._initJqgrid=function(d){var b=this;$.jgrid.defaults.styleUI="Bootstrap";$(SoShip.GRID).jqGrid({datatype:"json",url:ctx+"/ec/ec/salesorder/soEntity/soShipListData.htm",height:350,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",viewrecords:true,multiselect:true,rowList:[10,20,30],rownumbers:true,colNames:["所属订单 ID","发货单类型。ship=发货；","收货地址快照 ID","快递公司名称","快递公司编码","快递公司物流单号","API - 物流状态。即第三方快递API的返回状态","API - 返回数据","API - 上次调用时间","API - 签收时间","API - 退回时间","实付物流运费","是否需代收货款","代收货款金额","商品损毁类型。lost=丢失；break=损坏（拒收，需退回）","物流赔偿金额","创建时间","更新时间","操作"],colModel:[{name:"soId",editable:true,width:120},{name:"type",edittype:"select",editoptions:{value:"1:选项 1;2:选项 2;3:选项 3;4:选项 4"},editable:false,width:120,formatter:function(e,f,g){if(g.type=="1"){return"选项 1";
}else{if(g.type=="2"){return"选项 2";}else{if(g.type=="3"){return"选项 3";}else{if(g.type=="4"){return"选项 3";}else{if(g.type==undefined){if(e=="1"){return"选项 1";
}else{if(e=="2"){return"选项 2";}else{if(e=="3"){return"选项 3";}else{if(e=="4"){return"选项 4";}}}}}}}}}return g.type;}},{name:"addrId",editable:true,width:120},{name:"scName",editable:true,width:120},{name:"scCode",editable:true,width:120},{name:"scTrackingNo",editable:true,width:120},{name:"apiStatus",editable:true,width:120},{name:"apiReturnData",editable:true,width:120},{name:"apiRevokeTime",editable:true,width:120},{name:"apiReceiveTime",editable:true,width:120},{name:"apiReturnTime",editable:true,width:120},{name:"actualAmount",editable:true,width:120},{name:"isProxy",edittype:"select",editoptions:{value:"n:否;y:是"},editable:false,width:120,formatter:function(e,f,g){if(g.isProxy=="n"){return"否";
}else{if(g.isProxy=="y"){return"是";}else{if(g.isProxy==undefined){if(e=="n"){return"否";}else{if(e=="y"){return"是";}}}}}return g.isProxy;}},{name:"proxyAmount",editable:true,width:120},{name:"breakType",editable:true,width:120},{name:"breakAmount",editable:true,width:120},{name:"createTime",editable:true,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:true,hidedlg:true,hidden:true,width:120},{name:"button",width:120}],pager:SoShip.PAGER,hidegrid:false,gridComplete:function(){addRowButtons("soShipGrid",true,b.soShipOperFunc);
},ondblClickRow:function(g,j,f,i){var h=$("#soShipGrid").jqGrid("getRowData",g);b.showSoShip(g,h);}});function a(){soShipRowid=addRow("soShipGrid",b.soShipRowid);
}function c(e){DialogUtils.confirm(function(){delRows("soShipGrid",e);});}$(SoShip.GRID).jqGrid("navGrid",SoShip.PAGER,{add:false,del:true,deltitle:"删除",delfunc:c,refresh:false,search:false,edit:false});
$(window).bind("resize",function(){var e=$(".jqGrid_wrapper").width();$(SoShip.GRID).setGridWidth(e);});};SoShip.prototype.soShipGridData2Json=function(){var b=$("#soShipGrid");
var a=new StringBuffer();a.append("[");var f=b.jqGrid("getDataIDs");for(var c=0;c<f.length;c++){var g=b.jqGrid("getRowData",f[c]);if(g["isGridRowEdit"]=="Y"){alert("有参数尚未保存，请选择保存或者取消变更!");
getElementById(f[c]).focus();return false;}a.append("{");a.append("'soId':'").append(g["soId"]).append("',");var d="";if(g["type"]=="选项 1"){d="1";}else{if(g["type"]=="选项 2"){d="2";
}else{if(g["type"]=="选项 3"){d="3";}else{if(g["type"]=="选项 4"){d="4";}}}}a.append("'type':'").append(d).append("',");a.append("'addrId':'").append(g["addrId"]).append("',");
a.append("'scName':'").append(g["scName"]).append("',");a.append("'scCode':'").append(g["scCode"]).append("',");a.append("'scTrackingNo':'").append(g["scTrackingNo"]).append("',");
a.append("'apiStatus':'").append(g["apiStatus"]).append("',");a.append("'apiReturnData':'").append(g["apiReturnData"]).append("',");a.append("'apiRevokeTime':'").append(g["apiRevokeTime"]).append("',");
a.append("'apiReceiveTime':'").append(g["apiReceiveTime"]).append("',");a.append("'apiReturnTime':'").append(g["apiReturnTime"]).append("',");a.append("'actualAmount':'").append(g["actualAmount"]).append("',");
var e="";if(g["isProxy"]=="否"){e="n";}else{if(g["isProxy"]=="是"){e="y";}}a.append("'isProxy':'").append(e).append("',");a.append("'proxyAmount':'").append(g["proxyAmount"]).append("',");
a.append("'breakType':'").append(g["breakType"]).append("',");a.append("'breakAmount':'").append(g["breakAmount"]).append("',");a.append("'createTime':'").append(g["createTime"]).append("',");
a.append("'updateTime':'").append(g["updateTime"]).append("',");if(!f[c].startsWith("tmp@")){a.append("'id':'").append(f[c]).append("'");}a.append("},");
}var h=""+a;if(f.length>0){h=h.substring(0,h.length-1);}h=h+"]";$("#soShipJSON").val(h);return true;};SoShip.prototype.soShipOperFunc=function(b,a){return b;
};SoShip.prototype.showSoShip=function(e,f){var d=document.getElementById("soShipDetailDiv");if(d.style.display=="none"){$("#soShipBut").click();}$("#soShipSaveButton").removeClass("free_shrink_save_button");
$("input[name=soShipEditRowId]").val(e);$("input[name=soShip_soId]").val(f["soId"]);var b="";if(f["type"]=="选项 1"){b="1";}else{if(f["type"]=="选项 2"){b="2";
}else{if(f["type"]=="选项 3"){b="3";}else{if(f["type"]=="选项 4"){b="4";}}}}var g=document.getElementById("soShip_type").options;for(var a=0;a<g.length;a++){if(g[a].value==b){g[a].selected=true;
break;}}$("input[name=soShip_addrId]").val(f["addrId"]);$("input[name=soShip_scName]").val(f["scName"]);$("input[name=soShip_scCode]").val(f["scCode"]);
$("input[name=soShip_scTrackingNo]").val(f["scTrackingNo"]);$("input[name=soShip_apiStatus]").val(f["apiStatus"]);$("input[name=soShip_apiReturnData]").val(f["apiReturnData"]);
$("input[name=soShip_apiRevokeTime]").val(f["apiRevokeTime"]);$("input[name=soShip_apiReceiveTime]").val(f["apiReceiveTime"]);$("input[name=soShip_apiReturnTime]").val(f["apiReturnTime"]);
$("input[name=soShip_actualAmount]").val(f["actualAmount"]);var c="";if(f["isProxy"]=="否"){c="n";}else{if(f["isProxy"]=="是"){c="y";}}var h=document.getElementById("soShip_isProxy").options;
for(var a=0;a<h.length;a++){if(h[a].value==c){h[a].selected=true;break;}}$("input[name=soShip_proxyAmount]").val(f["proxyAmount"]);$("input[name=soShip_breakType]").val(f["breakType"]);
$("input[name=soShip_breakAmount]").val(f["breakAmount"]);$("input[name=soShip_createTime]").val(f["createTime"]);$("input[name=soShip_updateTime]").val(f["updateTime"]);
};SoShip.prototype.addSoShip2Grid=function(c){var a=this;if(a.validateSoShipGrid()){var b={soId:$("input[name=soShip_soId").val(),type:JTOtherUtils.getcheckValue("soShip_type"),addrId:$("input[name=soShip_addrId").val(),scName:$("input[name=soShip_scName").val(),scCode:$("input[name=soShip_scCode").val(),scTrackingNo:$("input[name=soShip_scTrackingNo").val(),apiStatus:$("input[name=soShip_apiStatus").val(),apiReturnData:$("input[name=soShip_apiReturnData").val(),apiRevokeTime:$("input[name=soShip_apiRevokeTime").val(),apiReceiveTime:$("input[name=soShip_apiReceiveTime").val(),apiReturnTime:$("input[name=soShip_apiReturnTime").val(),actualAmount:$("input[name=soShip_actualAmount").val(),isProxy:JTOtherUtils.getcheckValue("soShip_isProxy"),proxyAmount:$("input[name=soShip_proxyAmount").val(),breakType:$("input[name=soShip_breakType").val(),breakAmount:$("input[name=soShip_breakAmount").val(),createTime:$("input[name=soShip_createTime").val(),updateTime:$("input[name=soShip_updateTime").val()};
$("#"+c).jqGrid("addRowData","tmp@soShip"+a.soShipRowid,b,"last");a.soShipRowid++;}};SoShip.prototype.editSoShip2Grid=function(c){var a=this;if(a.validateSoShipGrid()){var b={soId:$("input[name=soShip_soId").val(),type:JTOtherUtils.getcheckValue("soShip_type"),addrId:$("input[name=soShip_addrId").val(),scName:$("input[name=soShip_scName").val(),scCode:$("input[name=soShip_scCode").val(),scTrackingNo:$("input[name=soShip_scTrackingNo").val(),apiStatus:$("input[name=soShip_apiStatus").val(),apiReturnData:$("input[name=soShip_apiReturnData").val(),apiRevokeTime:$("input[name=soShip_apiRevokeTime").val(),apiReceiveTime:$("input[name=soShip_apiReceiveTime").val(),apiReturnTime:$("input[name=soShip_apiReturnTime").val(),actualAmount:$("input[name=soShip_actualAmount").val(),isProxy:JTOtherUtils.getcheckValue("soShip_isProxy"),proxyAmount:$("input[name=soShip_proxyAmount").val(),breakType:$("input[name=soShip_breakType").val(),breakAmount:$("input[name=soShip_breakAmount").val(),createTime:$("input[name=soShip_createTime").val(),updateTime:$("input[name=soShip_updateTime").val()};
$("#"+c).jqGrid("setRowData",$("#soShipEditRowId").val(),b);}};SoShip.prototype.addSoShipValidate=function(){};SoShip.prototype.removeSoShipValidate=function(){};
SoShip.prototype.validateSoShipGrid=function(b,a){var c=$("#soShipForm").validate();return true;};SoShip.prototype.reloadJqgrid=function(g){var c=this;
var f={};if(g&&jQuery.type(g)=="string"){g=decodeURIComponent(g,true);var b=g.split("&");if(b.length){for(var d=0;d<b.length;d++){var e=b[d].split("=");
if(e.length==2&&e[1]){f[e[0]]=e[1];}}}}else{f=g;}var a=$(SoShip.GRID).jqGrid("getGridParam","postData");$.extend(a,f);$(SoShip.GRID).jqGrid("setGridParam",{search:true}).trigger("reloadGrid",[{page:1}]);
};}}SoShip.GRID="#soShipGrid";SoShip.PAGER="#soShipPager";function SoProfit(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.soProfitRowid=1;
this.orderCreateId=null;this.data=null;}SoProfit._CONS_={SAVE_PROFIT_URL:ctx+"/ec/salesorder/soEntity/saveProfit.htm",GRID:"#soProfitGrid",GRID_ID:"soProfitGrid",DIV_ID:".soProfitDiv",PAGER:"#soProfitPager",PAGER_ID:"soProfitPager",JSON_ID:"soProfitJSON",};
SoProfit.prototype={init:function(b){var a=this;if(b){if(b.orderCreateId!=undefined){a.orderCreateId=b.orderCreateId;}if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;
}}if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a._initJqgrid(b,true);},_bindEventHander:function(){var a=this;$(document).on("change","input[name=percentShow]",function(){var c=$(this).parent().parent().attr("id");
var b=$(this).val();$(this).val((parseFloat(b)).toFixed(2));a._changePercent(c,b);});$(document).on("click",".delSoProfit",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){$(SoProfit._CONS_.GRID).delRowData(b);
a.changePercent();}});});$(document).on("click",".soProfitEdit",function(){$(".soProfitEdit").hide();$(".soProfitSave").show();$(".soProfitCanel").show();
$(".selectEmpBtnDetail").show();a.changeEdit(true);});$(document).on("click",".soProfitCanel",function(){$(".soProfitEdit").show();$(".soProfitSave").hide();
$(".soProfitCanel").hide();$(".selectEmpBtnDetail").hide();a.changeEdit(false);a._initJqgrid({data:a.data,orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},false);
});$(document).on("click",".soProfitSave",function(){var b=a.save();});$(".form_wrapper").off("click","#selectEmpBtnDetail");$(".form_wrapper").on("click","#selectEmpBtnDetail",function(){var b=0;
if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,mode:0,callBack:function(f){if(f!=null){if(f.length>0){for(var e=0;
e<f.length;e++){if(!a.isHadEmp(f[e].id)){a.addSoProfit2Grid({soId:$("input[name=id]").val(),partyId:f[e].id,employeeName:f[e].name,aid:f[e].aid});}}}}}};
var c=new EmployeesSelect();c.init(d);});},_hideBtn:function(){this.changeEdit(false);$(".soProfitEdit").show();$(".soProfitSave").hide();$(".soProfitCanel").hide();
$(".selectEmpBtnDetail").hide();},_getInitPersent:function(a){if(a!=this.orderCreateId){return 0;}else{var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
if(d.length<=0){return 100;}else{var b=0;for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}return 100-b;}}},_changePercent:function(d,h){var j=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");if(isNaN(h)||h==""){return;}var b=(parseFloat(h)).toFixed(2);
var f=null;var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d);for(var g=0;g<j.length;g++){if(j[g]!=d){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",j[g]);
if(e["partyId"]!=this.orderCreateId){b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));}else{f=j[g];}}}var a=$(SoProfit._CONS_.GRID).jqGrid("getRowData",f);
$(SoProfit._CONS_.GRID).setCell(f,"percentShow",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(f,"percent",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(d,"percent",(parseFloat(h)).toFixed(2));
},checkPercent:function(h,e){var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(e);var b=null;var g=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h);
for(var c=0;c<d.length;c++){if(d[c]!=h){var f=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(f["partyId"]!=this.orderCreateId){a=a+parseFloat(f["percent"]);
}else{b=d[c];}}}if(a>100){return false;}return true;},validPercent:function(){var c=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(0);for(var b=0;
b<c.length;b++){var d=$("#"+c[b]+"_percentShow").val();a=a+parseFloat(d);}if(a>100||a<99.99){return false;}return true;},changePercent:function(){var b=null;
var a=0;var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(e["partyId"]!=this.orderCreateId){a=parseFloat(a)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}else{b=d[c];}}console.log("totalPercent:"+a);$(SoProfit._CONS_.GRID).setCell(b,"percentShow",(100-a).toFixed(2));$(SoProfit._CONS_.GRID).setCell(b,"percent",(100-a).toFixed(2));
},_initJqgrid:function(f,a){var b=this;var e=[];if(a==true){if(f){if(typeof f.data!=undefined&&f.data!=null&&f.data.length){e=f.data;}}if(e!=null&&e.length>0){for(var c=0;
c<e.length;c++){e[c].percent=(parseFloat(e[c].percent)/100).toFixed(2);e[c].percentShow=e[c].percent;}}b.data=e;}else{e=b.data;}var d=$("#profitTitleDiv").width();
$(SoProfit._CONS_.DIV_ID).empty().append('<table id="'+SoProfit._CONS_.GRID_ID+'"></table>            <div id="'+SoProfit._CONS_.PAGER_ID+'"></div>            <input type="hidden"  name="'+SoProfit._CONS_.JSON_ID+'"  id="'+SoProfit._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoProfit._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:e,caption:"绩效分成列表",autowidth:false,width:d,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["订单ID","员工ID","订单编号","工号","员工","比例(%)","比例","创建时间","更新时间","操作"],colModel:[{name:"soId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"partyId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"soNo",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"aid",sortable:false,editable:false,width:120,hidden:true},{name:"employeeName",sortable:false,editable:false,width:120,formatter:function(g,h,i){return i.aid+":"+g;
}},{name:"percentShow",sortable:false,editable:true,width:110},{name:"percent",sortable:false,editable:false,hidedlg:true,hidden:true,width:80},{name:"createTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"button",width:100,hidedlg:!b.isCanEdit,hidden:!b.isCanEdit}],gridComplete:function(){var h=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h[g]);if(j["partyId"]!=f.orderCreateId&&b.isCanEdit==true){var k="<i class='fa fa-remove delSoProfit'style='color:red;cursor:pointer;' title='删除'  value='"+h[g]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});$(SoProfit._CONS_.GRID).editRow(h[g]);}}},});$(window).bind("resize",function(){if(f.widthElement){$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);
}});},getSoProfitGridData:function(){var c=$(SoProfit._CONS_.GRID);var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;
a++){var e=c.jqGrid("getRowData",d[a]);if(e["percent"]==""){continue;}else{if(parseFloat(e["percent"])<0.01){continue;}}f++;b.append("soProfitPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soProfitPos[").append(f-1).append("].partyId=").append(e["partyId"]).append("&").append("soProfitPos[").append(f-1).append("].percent=").append(parseInt(parseFloat(e["percent"])*100)).append("&").append("soProfitPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soProfitPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(!d[a].indexOf("tmpSoProfit")==0){b.append("soProfitPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},addSoProfit2Grid:function(b){var a=this;
b.percent=a._getInitPersent(b.partyId);b.percentShow=b.percent;$(SoProfit._CONS_.GRID).jqGrid("addRowData","tmpSoProfit"+a.soProfitRowid,b,"last");a.soProfitRowid++;
},isHadEmp:function(d){var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);
if(c["partyId"]==d){DialogUtils.error(msgCode.INFO,"已存在该员工!");return true;}}return false;},changeEdit:function(d){if(d==true){this.isCanEdit=true;$(SoProfit._CONS_.GRID).jqGrid("showCol","button");
var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);if(c["partyId"]!=this.orderCreateId){var e="<i class='fa fa-remove delSoProfit' style='color:red;cursor:pointer;' title='删除'  value='"+b[a]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",b[a],{button:e});$(SoProfit._CONS_.GRID).editRow(b[a]);}}}else{this.isCanEdit=false;$(SoProfit._CONS_.GRID).jqGrid("hideCol","button");
}$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);},save:function(){var a=this;if(!a.validPercent()){DialogUtils.error(msgCode.ERROR,"业绩分成必须等于100");
return false;}FormUtils.submit(SoProfit._CONS_.SAVE_PROFIT_URL,a.getSoProfitGridData(),function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"修改成功");
a._hideBtn();a._initJqgrid({data:$.parseJSON(b.msg),orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},true);}else{DialogUtils.error(msgCode.ERROR,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};function CsPhonePanel(){this.hadInit=false;this.csName="";this.soStatus="";}CsPhonePanel._CONS_={FIND_PHONES_URL:ctx+"/crm/cs/csEntity/findPhonesByCsId.htm",FIND_CS_BY_PHONE:ctx+"/crm/cs/csEntity/getByPhone.htm",EDIT_CS_NAME:ctx+"/crm/cs/csEntity/editCsName.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",};
CsPhonePanel.prototype={init:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindEventHandler();}this.soStatus=a;this._initForm();this._fillData(b);
},_bindEventHandler:function(){var a=this;var b=$("#csPhonePanel");b.on("click",".callPhone",function(){var c=b.find("[name=phoneSelect]").find("option:selected").attr("attr-phone");
if(c.startsWith("020")){c=c.substring(3);}window.top.jtCtiService.dialout("9"+c);});b.on("click",".callPhoneAddZero",function(){var c=b.find("[name=phoneSelect]").find("option:selected").attr("attr-phone");
var d=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;if(c.startsWith("020")){c=c.substring(3);}if(d.test(c)){window.top.jtCtiService.dialout("90"+c);
}else{window.top.jtCtiService.dialout("9"+c);}});b.on("click",".sendMessage",function(){var d=b.find("[name=csId]").val();var g=b.find("[name=phoneSelect]").val();
var f=b.find("[name=phoneSelect]").find("option:selected").text();var e=new SendMessage();var c={csId:d,number:g,maskNum:f};e.openSendMessageView(c);});
b.on("change","[name=phoneSelect]",function(){var c=$(this).find("option:selected").attr("attr-type");b.find("[name=phoneType]").val(c);});b.on("click","[name=csName]",function(){a.csName=$(this).val();
$(this).removeClass("validate_input_error");});b.on("blur","[name=csName]",function(){if(ResUtils.canShow("soEntity.button.editCsName")){if($(this).val()){if(a.csName!=$(this).val()){a._editCsName();
}}else{$(this).addClass("validate_input_error");DialogUtils.error("提示","请填写客户名称");}}});b.on("click",".csCode",function(){var c=b.find("[name=csId]").val();
JTTabUtils.addOrRefreshTab(CsPhonePanel._CONS_.DETAIL_CS_PAGE_URL+"?csId="+c,"客户明细");});b.on("click",".changeEmployee",function(){a._changeEmployee();});
$(document).on("click","#servicePhoneBtn",function(d){var c=$(this).attr("masknum");if(c&&c!=""){if(c.startsWith("020")){c=c.substring(3);}window.top.jtCtiService.dialout("9"+c);
}else{DialogUtils.error(msgCode.ERROR,"没有此快递公司的客服电话");return;}});},_changeEmployee:function(){var a=this;var d=$("#csPhonePanel");var b=0;if(ResUtils.canShow("employeeSelector.button.cs")){b:1;
}var e={isShowAllGroup:b,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,callBack:function(g){if(g!=null){if(g.length>0){var i=d.find("input[name=employeeAid]").val();
d.find("input[name=employeeId]").val(g[0].id);d.find("input[name=employeeAid]").val(g[0].aid);d.find("input[name=csBelong]").val(g[0].aid+"："+g[0].name);
var f=[];f.push({employeeId:g[0].id,csEntityIds:d.find("input[name=csId]").val()});var h={soId:$("input[name=id]").val(),comment:"签收转工号，从工号"+i+"转到工号"+g[0].aid};
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(f),csType:"csEntity",soInfo:JSON.stringify(h)},function(j){if(j.success){DialogUtils.success("提示",j.msg);
}else{DialogUtils.error("失败",j.msg);}});}}}};var c=new EmployeesSelect();c.init(e);},maskPhoneNum:function(a){if(a){return PhoneEncryptUtils.encryptPhone(a);
}return"";},_loadPhones:function(b,c){var a=this;FormUtils.loadData(CsPhonePanel._CONS_.FIND_PHONES_URL+"?csId="+b,function(d){if(d&&d.length>0){if(c&&typeof c==="function"){c(d);
}}});},_editCsName:function(){var a=$("#csPhonePanel");$.ajax({type:"GET",url:CsPhonePanel._CONS_.EDIT_CS_NAME+"?csId="+a.find("[name=csId]").val()+"&csName="+a.find("[name=csName]").val(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(b){if(b.success){DialogUtils.success("成功","修改客户名字成功");
}}});},_descryptPhoneNum:function(a,d,c){var b={number:a,callback:c,};DecryptHelper.decrypt(b);},_fillData:function(c){var a=this;if(c){var b=$("#csPhonePanel");
b.find("[name=csId]").val(c.id);b.find("[name=csName]").val(c.name);if(!ResUtils.canShow("soEntity.button.editCsName")){b.find("[name=csName]").attr("readonly",true);
}b.find(".csCode").text(c.code);b.find("[name=csBelong]").val(c.employeeAid+"："+c.employeeName);b.find("[name=employeeId]").val(c.employeeId);b.find("[name=employeeAid]").val(c.employeeAid);
a._loadPhones(c.id,function(f){var g=new StringBuffer();var d=false;for(var e=0;e<f.length;e++){if("停用"!=f[e].type){g.append("<option value='"+f[e].number+"' attr-type='"+f[e].type+"' attr-phone = '"+f[e].phone+"'>"+f[e].maskPhone+"</option>");
}if(!d){b.find("[name=phoneType]").val(f[0].type);d=true;}}b.find("[name=phoneSelect]").append(g.toString());b.find("#callPhoneDiv").show();});$("input[name=pointUsable]").val(c.pointUsable);
}},_initForm:function(){var a=$("#csPhonePanel");a.find("[name=csId]").val("");a.find("[name=csName]").val("");a.find("[name=csBelong]").val("");a.find("[name=phoneSelect]").val("");
a.find("#callPhoneDiv").hide();if(this.soStatus&&"complete"==this.soStatus&&ResUtils.canShow("soEntity.button.completeChangeEmp")){a.find(".changeEmployee").show();
}}};var CsEntityUtils={init:function(){this._initBirthdaySelect();this._initChannelSelect();this._initCateOptSelect();this._bindEventHanlder();},_bindEventHanlder:function(){var a=this;
$(".closeBtn").on("click",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));});$("#birthYear").on("change",function(){var c=(new Date()).getFullYear();
var b=parseInt(c)-parseInt($(this).val());$("#age").val(b);});$("#age").on("blur",function(){var c=$(this).val();if(c){var b=parseInt((new Date()).getFullYear())-parseInt(c);
$("#birthYear").val(b);}else{$("#birthYear").val("");}});},_initBirthdaySelect:function(){var a=new Date();var e="1920";var d=a.getFullYear();var g=new StringBuffer();
for(var b=d;b>=e;b--){g.append("<option value='"+b+"'>");g.append(b);g.append("</option>");}$("#birthYear").append(g.toString());var c=new StringBuffer();
for(var b=1;b<=12;b++){if(b<10){b="0"+b;}c.append("<option value='"+b+"'>");c.append(b);c.append("</option>");}$("#birthMonth").append(c.toString());var f=new StringBuffer();
for(var b=1;b<=31;b++){if(b<10){b="0"+b;}f.append("<option value='"+b+"'>");f.append(b);f.append("</option>");}$("#birthDay").append(f.toString());},_initChannelSelect:function(d){var a=this;
var b="mediaChannel-findActived";var e=window.sessionStorage.getItem(b);if(e){var c=JSON.parse(e);a._buildChannelSelect(c,d);}else{FormUtils.loadData(ctx+"/ec/media/mediaChannel/findActived.htm",function(f){window.sessionStorage.setItem(b,JSON.stringify(f));
a._buildChannelSelect(f,d);});}},_buildChannelSelect:function(c,b){if(c&&c.length>0){if(!b&&isDefaultLast&&"y"==isDefaultLast){var d=window.localStorage.getItem("CREATE_CS_SRC_"+currentUserId);
b=d;}var e=new StringBuffer();e.append("<option value=''>请选择</option>");for(var a=0;a<c.length;a++){e.append("<option value='"+c[a].id+"'>"+c[a].name+"</option>");
}$("#srcs").empty().append(e.toString());if(b){$("#srcs").val(b);}this.isInitChannelSelect=true;}},_initInterestsSelect:function(b){var a=this;CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interests",fn:function(c){var g=new StringBuffer();
for(var e=0;e<c.length;e++){var f=c[e].value;var d=c[e].name;g.append("<option value='"+f+"'>"+d+"</option>");}$("#interests").empty().append(g.toString());
a.isInitInterests=true;}}]);},maskPhoneNum:function(a){var b=new StringBuffer();if(a){return PhoneEncryptUtils.encryptPhone(a);}return b.toString();},refreshListTab:function(){if(type=="self"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/list.htm");
}else{if(type=="search"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/searchList.htm");}else{if(type=="mysub"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/subList.htm");
}}}},_initCateOptSelect:function(){CateUtils.getOptions([{typeKey:"system",pKey:"CsBizTypes",container:"bizType"},{typeKey:"system",pKey:"CsEntryType",container:"entry"},{typeKey:"system",pKey:"vocationType",container:"vocation"},{typeKey:"system",pKey:"income",container:"income"},{typeKey:"system",pKey:"maritalStatus",container:"maritalStatus"},{typeKey:"system",pKey:"winePurpose",container:"winePurpose"},{typeKey:"system",pKey:"taste",container:"taste"}]);
this._initInterestsSelect(null);},getSearchParams:function(h){var k=this;var d=$("#csEntitySearchForm").serialize()+h.getRfmtParam();var e=$("select[name=freeHourOption]").val();
var c=$("select[name=freeMinuteOption]").val();if(e){if(!c){$("select[name=freeMinuteOption]").val("00");}}if(c){if(!e){$("select[name=freeHourOption]").val("00");
}}var j=$("#interestSearch option:selected").length;if(j!=0){d=k._bulidInterests(d,j);}var b=$("#belongEmployeeSearch option:selected").length;if(b!=0){d=k._bulidEmps(d,b);
}var a=$("#searchProd option:selected").length;if(a!=0){d=k._bulidProds(d,a);}var g=$("#csTagSearch option:selected").length;if(g!=0){d=k._bulidCsTag(d,g);
}var i=$("#eavSearch option:selected").length;if(i!=0){d=k._bulidEav(d,i);}var f=$("#srcSearch option:selected").length;if(f){d=k._bulidSrcs(d,f);}return d;
},_bulidInterests:function(c,b){var a=this;var d=new StringBuffer();$("#interestSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;
}else{d.append(",");}});c=c+"&interests="+d.toString();return c;},_bulidEmps:function(c,b){var a=this;var d=new StringBuffer();$("#belongEmployeeSearch option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&belongEmployee="+d.toString();return c;},_bulidProds:function(c,b){var a=this;var d=new StringBuffer();
$("#searchProd option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");}});c=c+"&productName="+d.toString();
return c;},_bulidCsTag:function(c,b){var a=this;var d=new StringBuffer();$("#csTagSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;
}else{d.append(",");}});c=c+"&csTagSearch="+d.toString();return c;},_bulidEav:function(c,b){var a=this;var d=new StringBuffer();$("#eavSearch option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&eavSearch="+d.toString();return c;},_bulidSrcs:function(c,b){var a=this;var d=new StringBuffer();
$("#srcSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");}});c=c+"&srcSearch="+d.toString();
return c;},getSearchParamToObj:function(f){var e={};f=decodeURIComponent(f,true);var a=f.split("&");if(a.length){for(var b=0;b<a.length;b++){var d=a[b].split("=");
if(d.length==2){if(e.hasOwnProperty(d[0])){if(jQuery.type(e[d[0]])=="string"){var c=[];c.push(e[d[0]]);d[1]=d[1].replaceAll("\\+"," ");c.push(d[1]);e[d[0]]=c;
}else{if(jQuery.type(e[d[0]])=="array"){d[1]=d[1].replaceAll("\\+"," ");e[d[0]].push(d[1]);}}}else{d[1]=d[1].replaceAll("\\+"," ");e[d[0]]=d[1];}}else{if(d.length>2){e[d[0]]=a[b].substring(a[b].indexOf("=")+1).replaceAll("\\+"," ");
}}}}return e;}};function SoEntityExport(){this.hadInit=false;this.params="";}SoEntityExport._CONS_={EXPORT_ASYNCHRO:ctx+"/ec/salesorder/soEntity/exportAsynchronous.htm",EXPORT_PACK_URL:ctx+"/ec/salesorder/soEntity/exportPack.htm",EXPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportSoEntityModule.htm",EXPORT_PRODUCT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportSoProduct.htm",EXPORT_EMPPROD_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEmpProduct.htm",EXPORT_EMPSOPROD_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEmpSoProduct.htm",EXPORT_EDIANBAO_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEDianBao.htm",EXPORT_YANWEN_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportYwSoShip.htm",ISRECPHONE:false};
SoEntityExport.prototype={init:function(a){this.params=a;if(!this.params.selectIds){this.params.selectIds="";}this.openExportLayer();if(!this.hadInit){this._bindEventHander();
}this.hadInit=true;ConfigUtils.findByKey("soEntity.isReceivePhone",function(b){if(b.success){SoEntityExport._CONS_.ISRECPHONE=true;}});},_bindEventHander:function(){$("#selectAll").on("change",function(){var c=$(this)[0].checked;
var b=$("#columnContainer").find(".columnCheckBox");for(var a=0;a<b.length;a++){b[a].checked=c;}});},openExportLayer:function(){var a=this;a.layerIndex=layer.open({type:1,title:"订单导出",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["导出","取消"],area:["70%","70%"],content:$(".soEntityExportPane"),success:function(b,c){a._initData();
},yes:function(d,f){var i=$("input[name='startCount'").val();var c=$("input[name='endCount'").val();var b=parseInt($("input[name='maxCount'").val());if(b<1){DialogUtils.error(msgCode.FAIL_MSG,"导出数量不能小于1");
return false;}if(c==""||c==null||i==""||i==null){DialogUtils.error(msgCode.FAIL_MSG,"导出数量不能小于1");return false;}c=parseInt(c);i=parseInt(i);if(i>c||c>b||i>b||c<0||i<0){DialogUtils.error(msgCode.FAIL_MSG,"请填写正确的订单数量。最大值不能大于"+b);
return false;}if(c-i>100000){DialogUtils.error(msgCode.FAIL_MSG,"一次导出订单不能超过100000条，请分批导出！");return false;}var j=a._exportParams(i,c);var e=$("input[name='exportType']:checked").val();
if(!j&&!e=="soAndProd"){DialogUtils.error(msgCode.FAIL_MSG,"请选择要导出的字段");return false;}DialogUtils.success(msgCode.SUCCESS,"正在导出....");layer.close(a.layerIndex);
var k=$("input[name='fileType']:checked").val();if(e=="soAndProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_PRODUCT_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(e=="csAndProd"||e=="empAndProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EMPPROD_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(e=="csAndSoProd"||e=="empAndSoProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EMPSOPROD_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="edianbaoExcel"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EDIANBAO_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="yanwenShipExcel"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_YANWEN_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="module"){window.location.href=SoEntityExport._CONS_.EXPORT_EXCEL_URL+"?"+a.params.params+j+"&selectIds="+a.params.selectIds;return;
}else{var h=SoEntityExport._CONS_.EXPORT_ASYNCHRO;var g=a.params.requestQueryParams?("?"+a.params.requestQueryParams):"";h=h+g;FormUtils.submit(h,a.params.params+j+"&selectIds="+a.params.selectIds,function(l){if(!l.success){DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);}}}}}}window.top.showTimming(c-i);},cancel:function(){}});},_initData:function(){$("input[name='exportType']")[0].checked=true;
$("input[name='fileType']")[0].checked=true;this._initColoms();this._initCount();},_initColoms:function(){var a=[];var b=LocalStorageUtils.get("SO_EXPORT_COLUMNS_"+currentUserId);
if(b){a=b.split(",");}excelUtil.findExportColByModule("soEntity",true,function(d){var e=new StringBuffer();if(d&&d.length>0){for(var c=0;c<d.length;c++){if(d[c].devCode=="tranPhone"||d[c].devCode=="recPhone"){if(!SoEntityExport._CONS_.ISRECPHONE){continue;
}}e.append("<div class='checkbox checkbox-success checkbox-inline'>");if($.inArray(d[c].devCode,a)!=-1){e.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
}else{e.append("<input type='checkbox' class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
}e.append("</div>");}}$("#columnContainer").empty().append(e.toString());});},_initCount:function(){var b=this.params;var a=b.toatolCount;if(b.selectIds&&b.selectIds.length>0){a=b.selectIds.length;
}$("input[name='startCount'").val(1);$("input[name='endCount'").val(a);$("input[name='maxCount'").val(a);},_exportParams:function(d,g){var c="";var e=$("#columnContainer").find(".columnCheckBox");
var f=[];$(e).each(function(){if($(this).is(":checked")){f.push($(this).val());}});if(f.length<=0){return false;}var b=$("input[name='exportType']:checked").val();
var a=$("input[name='fileType']:checked").val();c="&columns="+f+"&startCount="+d+"&pageSize="+(g-d+1)+"&exportType="+b+"&fileType="+a;LocalStorageUtils.set("SO_EXPORT_COLUMNS_"+currentUserId,f.toString());
return c;},exportPack:function(a){var b=$(a).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要导出备货信息的订单");return null;
}FormUtils.submit(SoEntityExport._CONS_.EXPORT_PACK_URL,"soId="+b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"成功");window.location=ctx+c.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D";
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};var excelUtil={toGenExcel:function(a,b,c){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/toGenExcel.htm?module="+a+"&moduleText="+c,b);
},importExcel:function(a){if(a.isCreateSub){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl+"&isCreateSub="+a.isCreateSub,a.tabTitle);
}else{JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl,a.tabTitle);}},findExportColByModule:function(c,b,d){var a=ctx+"/gl/mc/moduleColumn/findByModule.htm?module="+c;
if(b){a=ctx+"/gl/mc/moduleColumn/findGrantCol.htm?module="+c;}FormUtils.loadData(a,function(e){if(d){d(e);}});}};$(function(){var a=new CsLimit();a.init();
});function CsLimit(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.csId="";}CsLimit._CONS_={DELETE_URL:ctx+"/crm/limit/csLimit/delete.htm",SAVE_ADD_URL:ctx+"/crm/limit/csLimit/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/limit/csLimit/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/limit/csLimit/listData.htm",FIND_CSLIMIT_URL:ctx+"/crm/limit/csLimit/findCslimits.htm",MODIFY_URL:ctx+"/crm/limit/csLimit/modifyStatus.htm",MODIFY_RETURN_URL:ctx+"/crm/limit/csLimit/modifyReturnStatus.htm",FIND_CSLIMIT_STATUS_URL:ctx+"/crm/limit/csLimit/findByStatus.htm",EDIT_FORM_ID:"csLimitForm",ADD_FORM_ID:"csLimitAddForm",GRID:"#csLimitGrid",PAGER:"#csLimitPager"};
CsLimit.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this._initJqgrid();
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("csLimit.button.detail")){$(".csLimitDetail").hide();}if(!ResUtils.canShow("csLimit.button.add")){$(".csLimitAdd").hide();
}if(!ResUtils.canShow("csLimit.button.edit")){$(".csLimitEdit").hide();}if(!ResUtils.canShow("csLimit.button.delete")){$(".csLimitDel").hide();}},clear:function(c){var a=this;
function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(CsLimit._CONS_.ADD_FORM_ID);
FormUtils.enableForm(CsLimit._CONS_.ADD_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
},_edit:function(a){JTTabUtils.addOrRefreshTab(ctx+"/crm/limit/csLimit/edited.htm?id="+a,"授信审批");},_detail:function(a){this._showFormWrapper();this._loadData(a);
$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(CsLimit._CONS_.EDIT_FORM_ID);},_modify:function(d,a){var b=this;var c=$("input[name=csId]").val();
if(a=="awaiting_limit"){var e="是否确认风控接受？";}else{if(a=="reject"){var e="是否确认风控拒绝？";}else{if(a=="close"){var e="是否确认作废？";}}}DialogUtils.confirmWithOptions({title:e,text:"",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(CsLimit._CONS_.MODIFY_URL,"csLimitId="+d+"&status="+a,function(f){if(f.success){DialogUtils.success(msgCode.INFO,"修改成功");
if(a=="close"){b.initTable({csId:c});}else{b.reloadJqgrid();}}else{DialogUtils.error(msgCode.ERROR,f.msg);}});}});},_modifyReturnStatus:function(c,a){var b=this;
FormUtils.submit(CsLimit._CONS_.MODIFY_RETURN_URL,"csLimitId="+c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,"已回访");b.initTable({csId:csId});
}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},_saveAdd:function(){var a=this;if($("#csLimitAddForm").valid()){FormUtils.submitByFormId(CsLimit._CONS_.SAVE_ADD_URL,CsLimit._CONS_.ADD_FORM_ID,function(b){if(b.success){if(b.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
a.initTable({csId:csId});}else{if(b.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}FormUtils.clear(CsLimit._CONS_.ADD_FORM_ID);
layer.close(a.layerIndex);}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(c){var a=this;
var b=$("input[name=csId]").val();DialogUtils.confirm(function(){FormUtils.del(CsLimit._CONS_.DELETE_URL,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.initTable({csId:b});}else{DialogUtils.error(msgCode.ERROR,d.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$("#"+CsLimit._CONS_.ADD_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+CsLimit._CONS_.ADD_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+CsLimit._CONS_.ADD_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#csLimitForm").on("click",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#csLimitSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".csLimitSearch").trigger("click");}});$(document).on("click",".csLimitAdd",function(){a.layerIndex=layer.open({type:1,title:"授信审批",shadeClose:false,btn:["保存","关闭"],area:["50%","40%"],content:$(".csLimitEditDiv"),scrollbar:false,yes:function(c,b){a._saveAdd();
}});});$("body").on("click",".csLimitEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(CsLimit._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}a._edit(b);});$("body").on("click",".csLimitDel",function(){var b=$(this).attr("idVal");if(!b){b=$(CsLimit._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".csLimitDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(CsLimit._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$("body").on("click",".csLimitAccept",function(){var b="awaiting_limit";
a.isEdit=true;var c=$(this).attr("idVal");if(!c){c=$(CsLimit._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要修改的记录");
return;}}a._modify(c,b);});$("body").on("click",".csLimitReject",function(){var b="reject";a.isEdit=true;var c=$(this).attr("idVal");if(!c){c=$(CsLimit._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要修改的记录");return;}}a._modify(c,b);});$("body").on("click",".csLimitClose",function(){var b="close";
var c=$(this).attr("idVal");a._modify(c,b);});$(document).on("click",".csLimitReturn",function(){var b=$(this).attr("idVal");a._modifyReturnStatus(b);});
},_bindFormValidation:function(){var a={rules:{expectLimit:{required:true}},messages:{}};FormUtils.bindFormValidation(CsLimit._CONS_.ADD_FORM_ID,a);},reloadJqgrid:function(){var a={};
a.Q__S__EQ__status_="post";JTJqgridUtils.reloadJqgrid(CsLimit._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("csLimit.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"csLimitDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("csLimit.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"csLimitEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("csLimit.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"csLimitDetail",iconClasses:"fa fa-list"});
}return a;},initTable:function(c){var a=this;$("#csLimitForm").find("input[name=csId]").val(c.csId);$("#csLimitAddForm").find("input[name=csId]").val(c.csId);
var d=new StringBuffer();d.append("<div>");d.append("<span class='limitSpan'></span>");d.append("<span class='expectLimitSpan'></span>");d.append("<button type='button' class='btn btn-sm btn-outline btn-primary csLimitAdd'>申请新额度</button>");
d.append("</div>");d.append("<table class='table table-striped table-bordered' id='csLimitTable'>");d.append("<thead><tr>");d.append("<th>申请时间</th>");d.append("<th>申请额度</th>");
d.append("<th>通过额度</th>");d.append("<th>审批状态</th>");d.append("<th>审批时间</th>");d.append("<th>回访状态</th>");d.append("<th>操作</th>");d.append("</tr></thead>");
d.append("</table>");$("#csLimitTagDiv").empty().append(d.toString());var b=CsLimit._CONS_.FIND_CSLIMIT_URL;b=b+"?csId="+c.csId;$("#csLimitTable").DataTable({ajax:{url:b},columns:[{data:"createTime",width:"10%"},{data:"expectLimit",width:"10%"},{data:"limit",width:"10%"},{data:"status",render:function(h,e,g){var f=g.status;
if(f=="awaiting_confirm"){f="待确认条款";}else{if(f=="close"){f="作废";}else{if(f=="accept"){f="已接受条款";}else{if(f=="post"){f="已提交材料";}else{if(f=="reject"){f="风控拒绝";
}else{if(f=="awaiting_limit"){f="待接受额度";}else{if(f=="reject_limit"){f="放弃额度";}else{if(f=="accept_limit"){f="接受额度";}else{if(f=="expire"){f="过期";}}}}}}}}}return f;
},width:"10%"},{data:"auditTime",width:"10%"},{data:"returnStatus",width:"10%",render:function(f,g,e){if("none"==e.returnStatus){return"未回访";}else{if("done"==e.returnStatus){return"已回访";
}else{return"";}}},},{data:"operate",width:"10%",render:function(g,e,f){if("awaiting_confirm"==f.status){return"<a href='#' class='csLimitEdit' idVal='"+f.id+"'>查看</a>&nbsp&nbsp<a href='#' class='csLimitClose' idVal='"+f.id+"'>作废</a>&nbsp&nbsp<a href='#' class='csLimitDel' idVal='"+f.id+"'>删除</a>";
}else{if(("close"==f.status||"reject"==f.status||"reject_limit"==f.status||"accept_limit"==f.status)&&f.returnStatus=="none"){return"<a href='#' class='csLimitEdit' idVal='"+f.id+"'>查看</a>&nbsp&nbsp<a href='#' class='csLimitReturn' idVal='"+f.id+"'>回访</a>";
}else{return"<a href='#' class='csLimitEdit' idVal='"+f.id+"'>查看</a>";}}},},],rowId:"id",lengthMenu:[[20,100],[20,100]],paging:true,bFilter:false,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"desc"]]});
$(".limitSpan").text("当前额度：0");$(".expectLimitSpan").text("　　客户期望额度：0　　");FormUtils.loadData(CsLimit._CONS_.FIND_CSLIMIT_STATUS_URL+"?status=accept_limit",function(e){if(e!=null&&e!=""){$(".limitSpan").text("当前额度："+e.limit);
$(".expectLimitSpan").text("　　客户期望额度："+e.expectLimit+"　　");}});},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}a.Q__S__EQ__status_="post";
$(CsLimit._CONS_.GRID).JTJqgrid({url:CsLimit._CONS_.LIST_DATA_URL,pager:CsLimit._CONS_.PAGER,postData:a,colNames:["申请时间","申请额度","通过额度","审批状态","审批时间","回访状态","操作",],colModel:[{name:"createTime",index:"create_time_",width:120},{name:"expectLimit",index:"expect_limit_",width:120},{name:"limit",index:"limit_",width:120},{name:"status",index:"status_",width:120,formatter:function(b,d,e){var c=e.status;
if(e.status=="awaiting_confirm"){c="待确认条款";}else{if(e.status=="close"){c="作废";}else{if(e.status=="accept"){c="已接受条款";}else{if(e.status=="post"){c="已递交材料";
}else{if(e.status=="reject"){c="风控拒绝";}else{if(e.status=="awaiting_limit"){c="待接受额度";}else{if(e.status=="reject_limit"){c="放弃额度";}else{if(e.status=="accept_limit"){c="接受额度";
}else{if(e.status=="expire"){c="过期";}}}}}}}}}return c;}},{name:"auditTime",index:"audit_time_",width:120},{name:"returnStatus",index:"return_status_",width:120,formatter:function(b,d,e){var c=e.returnStatus;
if(e.returnStatus=="none"){c="未回访";}else{if(e.returnStatus=="done"){c="已回访";}}return c;}},{name:"",width:120},]});}};function WeiXinChatForm(b){this.csInfo={};
this.goToTop=false;this.audio=null;var a=new Date();this.oneToOne=false;a.setDate(a.getDate()-7);this.record={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59"};
this.history={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59",contentSearchParam:"",isSign:"",contentType:"",createTime:""};
this.audioEndTime=null;this.lastChatTime="";this.textAreaPostion=0;this.files=[];this.weixinTextarea=new WeixinTextarea();}WeiXinChatForm._CONS_={LIST_RECODE_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm",RECODE_SEND_URL:ctx+"/crm/cs/weiXinRecord/saveAdd.htm",SET_SIGN_URL:ctx+"/crm/cs/weiXinRecord/setSign.htm",LIST_BEFORE_AFTER_URL:ctx+"/crm/cs/weiXinRecord/findBeforeAndAfter.htm",SAVE_LABEL_URL:ctx+"/gl/cs/weiXinFriends/saveLabel.htm",ADD_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/addFriend.htm",BACK_MSG_URL:ctx+"/crm/cs/weiXinRecord/backMsg.htm",FIND_FACE_IMAGES_URL:ctx+"/crm/cs/weiXinChat/findMyImage.htm",COLLECTION_IMG_URL:ctx+"/crm/cs/weiXinChat/collectionImage.htm",DELETE_COLLECTION_URL:ctx+"/crm/cs/weiXinChat/deleteCollection.htm",READ_AUDIO_URL:ctx+"/crm/cs/weiXinRecord/readAudio.htm",FIND_COM_LAN_URL:ctx+"/crm/cs/weixinCommonLan/findByUserId.htm",RESEND_MSG_URL:ctx+"/crm/cs/weiXinRecord/reSendMsg.htm",STATUS_NOTIFY_URL:ctx+"/gl/cs/weiXinFriends/statusNotify.htm",CLEAR_UNREAD_URL:ctx+"/gl/cs/weiXinFriends/clearUnread.htm",UPLOAD_PARAMS:{"acceptTypes":".*","mimeTypes":".*","fileSingleSizeLimit":10*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
WeiXinChatForm.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantedBtn();this._initWxlabel();this._bindWebuploader();
this._initFaceImages();this._initCommonLan();this.weixinTextarea.init({container:"#chat-textarea"});var a=new Clipboard(".jt-copy-content");}},_hideNotGrantedBtn:function(){if(!ResUtils.canShow("weiXinChat.button.placeOrder")){$("#jt-cs-placeOrder").remove();
}if(!ResUtils.canShow("weiXinChat.button.addFollow")){$("#jt-cs-addFollow").remove();}if(!ResUtils.canShow("weiXinChat.button.rebind")){$("#jt-rebind-cs").remove();
}if(!ResUtils.canShow("weiXinChat.button.changeRemark")){$(".jt-wx-change-remark").remove();}if(!ResUtils.canShow("weiXinChat.button.bindCs")){$("#jt-bind-cs").remove();
}if(!ResUtils.canShow("weiXinChat.button.addCs")){$("#jt-add-cs").remove();}if(!ResUtils.canShow("weiXinChat.button.addWeiXin")){$("#jt-add-wxCode").remove();
}},_bindWebuploader:function(){var b=this;b.files=[];function c(g,f){if(f.flag){var h={path:f.localPath,name:f.fileName,size:g.size};b.files.push(h);b._beforeSendFile();
}}function a(f,g){alert("上传"+f.name+"失败，原因是"+g);}function d(){}var e=new JTWebUploader({config:WeiXinChatForm._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：.xls格式文件，单个文件最大为1MB",success:c,error:a,finish:d,auto:true});
e.init();},_beforeSendFile:function(){var a=this;var b=a.files[a.files.length-1];var c=ctx+b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='width:55px;height:66px;' type-value='1' src='"+c+"' class='jt-lager-img'>";
}else{d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='7'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";}$("#chat-textarea").append(d);
a._bindWebuploader();},initChat:function(a){this.lastChatTime="";if(this.csInfo.hasInline){$("#chat-textarea").attr("contenteditable",true);$(".jt-weixin-sendMsgBtn").attr("disabled",false);
$(".web_wechat_face").removeClass("disabled");$(".web_wechat_image").removeClass("disabled");$(".web_wechat_pic").removeClass("disabled");}else{$("#chat-textarea").attr("contenteditable",false);
$(".jt-weixin-sendMsgBtn").attr("disabled",true);$(".web_wechat_face").addClass("disabled");$(".web_wechat_image").addClass("disabled");$(".web_wechat_pic").addClass("disabled");
}$(".jt-wx-label").removeClass("jt-wx-label-selected");if(this.csInfo.userName&&(this.csInfo.userName.indexOf("applyFriends")!=-1)){$("#myMenu").hide();
$(".jt-wx-label-div").hide();$(".m-text").hide();if(!a){$(".m-message").show();$(".m-detail").hide();this.loadRecord(true);}else{$(".m-message").hide();
$(".m-detail").show();}}else{$(".jt-wx-label-div").show();if(!a){$("#send-msg-div").show();$("#send-msg-btn-div").hide();$(".m-message").show();$(".m-detail").hide();
this.loadRecord(true);}else{$(".m-message").hide();$(".m-detail").show();$("#send-msg-div").hide();$("#send-msg-btn-div").show();}}this._selectWxLabel();
this._hideFaceDiv();this._hideImageDiv();this._hideComLanDiv();$("#chat-textarea").empty().focus();this._dealStyle();},_showFaceDiv:function(){$("#jt-wx-face-div").show();
$("#jt-wx-face-div").css({top:"-272px",left:"20px"});$(".web_wechat_face").addClass("on");},_hideFaceDiv:function(){$("#jt-wx-face-div").hide();$(".web_wechat_face").removeClass("on");
},_showImageDiv:function(){$("#jt-wx-image-div").show();$("#jt-wx-image-div").css({top:"-272px",left:"20px"});$(".web_wechat_image").addClass("on");},_hideImageDiv:function(){$("#jt-wx-image-div").hide();
$(".web_wechat_image").removeClass("on");},_showComLanDiv:function(){$("#jt-wx-common-lan-div").show();$("#jt-wx-common-lan-div").css({top:"-272px",left:"20px"});
$(".web_wechat_common_lan").addClass("on");},_hideComLanDiv:function(){$("#jt-wx-common-lan-div").hide();$(".web_wechat_common_lan").removeClass("on");
},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";FormUtils.loadData(b,function(c){if(c.length>0){var f=new StringBuffer();
for(var e=0;e<c.length;e++){f.append("<button class='btn btn-sm btn-info btn-outline jt-wx-label' >"+c[e].value+"</button>");}$(".jt-wx-label-div").css({height:"34px"});
$(".jt-wx-label-div").empty().append(f.toString());if($(".batch-send-label-div").length>0){var d=new StringBuffer();for(var e=0;e<c.length;e++){d.append("<label class='btn btn-sm btn-info btn-outline batch-send-label' >"+c[e].value+"</label>");
}$(".batch-send-label-div").empty().append(d.toString());}a._dealStyle();}});},_setSearchDate:function(){var a=new Date();a.setDate(a.getDate()-7);this.history.startDate=DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00";
this.history.endDate=DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59";this.history.page=1;this.history.status=false;this.history.contentSearchParam="";
this.history.isSign="";this.history.contentType="";$("input[name='startDate']").val(this.history.startDate);$("input[name='endDate']").val(this.history.endDate);
$("input[name='contentType']")[0].checked=true;$("input[name='contentSearchParam']").val("");},_dealStyle:function(){var a=$(".chat-history").height()-$(".history-search-button-div").outerHeight()-$(".history-search-param-div").outerHeight()-20;
$(".history-message-box").height(a);var b=$(".main-hide").height()-$("#chat-person-div").height()-$("#send-msg-div").height()-20;$(".m-message").height(b);
},_bindEventHander:function(){var a=this;$(window).on("resize",function(){a._dealStyle();});window.onmessage=function(c){var b=JSON.parse(c.data);if(b&&b.messageType=="msg"){$("#jt-reciver-msg").val(c.data);
$("#jt-weixin-reciverBtn").trigger("click");$("#jt-weixin-reciverBtn2").trigger("click");}else{if(b&&b.messageType=="reload"){$("#jt-weixin-reloadWx").val(b.empWx);
$("#jt-weixin-reloadBtn").trigger("click");}}};$(document).on("keydown","#chat-textarea",function(b){var c=$(this).val();if(b.keyCode==13){if(!b.ctrlKey){a.send();
}}});$("body").on("click","#chat-textarea",function(){a._hideFaceDiv();a._hideImageDiv();a._hideComLanDiv();});$(document).on("click",".jt-weixin-sendMsgBtn",function(){a.send();
});$(".m-message").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.record.status&&a.record.page<a.record.total){a.record.status=false;a.record.page=a.record.page+1;
a.loadRecord();}});$(".history-message-box").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.history.status&&a.history.page<a.history.total){a.history.status=false;
a.history.page=a.history.page+1;a._loatRecordHistory();}});$(document).on("click","#jt-weixin-reciverBtn",function(){var c=$("#jt-reciver-msg").val();var d=JSON.parse(c);
var f=a._getId(d.userName);var e=$("#jt-chat-"+f);if(e&&e.length>0){if($("#"+d.id).length>0&&d.type=="out"){if(d.status!=2){$("#"+d.id).find(".web_wechat_message_fail").remove();
}else{if($("#"+d.id).find(".web_wechat_message_fail").length<=0){$("#"+d.id).find(".text").prepend("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+d.id+"' create-time='"+d.createTime+"'></i>");
}}}else{$(".m-message").find("ul").append(a._getChartLi(d));a._gotoBottom();}if(a.oneToOne&&d.type=="in"){a._removeNotRead();var b=parseInt($("#wxMsgCount",parent.document).text());
b-=1;$("#wxMsgCount",parent.document).empty().append(b);if(b==0){$("#wxMsgCount",parent.document).removeClass("blink");}}}if(d.contentType==2||d.contentType=="2"){a._setDuration();
}});$(document).on("click",".weixinAudio",function(c){var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();$(".audio_area").removeClass("playing");
clearTimeout(a.audioEndTime);}a.audio=d.find(".media")[0];d.find(".audio_area").addClass("playing");var b=a.audio.duration;a.audio.currentTime=0;a.audio.play();
var f=$(this).attr("id-value");var e=$(this).attr("createtime");if($(this).find(".web_wechat_noread").length>0){a._readAudio(f,e);}a.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");
var k=$(".weixinAudio");var j=new Date(e);for(var h=0;h<k.length;h++){var g=new Date($(k[h]).attr("createtime"));if(j.getTime()<g.getTime()&&$(k[h]).find(".web_wechat_noread").length>0){$(k[h]).trigger("click");
break;}}},b*1000);});$(document).on("mouseenter",".jt-lager-img",function(){var b=$(this).attr("src");var c=$(this).attr("big-src");$(this).attr("src",c);
$(this).attr("big-src",b);});$(document).on("mouseout",".jt-lager-img",function(){var b=$(this).attr("src");var c=$(this).attr("big-src");$(this).attr("src",c);
$(this).attr("big-src",b);});$(document).on("click",".jt-weixin-history",function(){if($(".chat-history").is(":hidden")){var c=$("#chat").width();$(".chat-history").show();
$(".jt-weixin-history").addClass("on");if(window.innerWidth<=1440){$("#jt-employee-wx").hide();$(".chat-history").css({"width":"300px"});$(".main-hide").css({"width":"300px"});
$(".main-show").css({"width":"300px"});$(".sidebar-left").css({"margin-left":c>960?((c-960)/2+"px"):"0px"});}else{$(".chat-history").css({"width":"400px"});
$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});$(".sidebar-left").css({"margin-left":((c-1440)/2+"px")});}if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"65%"});
$(".chat-history").css({width:"35%"});}a._setSearchDate();a._loatRecordHistory(true);}else{$("#jt-employee-wx").show();var c=$("#chat").width();if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"560px"});$(".main-show").css({"width":"560px"});$(".sidebar-left").css({"margin-left":c>920?((c-920)/2+"px"):"0px"});}else{$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});$(".sidebar-left").css({"margin-left":((c-1040)/2+"px")});}$(".chat-history").hide();
$(".jt-weixin-history").removeClass("on");if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"100%"});}}var b=$(".chat-history").height()-$(".history-search-button-div").outerHeight()-$(".history-search-param-div").outerHeight()-20;
$(".history-message-box").height(b);});$(document).on("click",".jt-close-history",function(){$("#jt-employee-wx").show();var b=$("#chat").width();if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"560px"});$(".main-show").css({"width":"560px"});$(".sidebar-left").css({"margin-left":b>920?((b-920)/2+"px"):"0px"});}else{$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});$(".sidebar-left").css({"margin-left":((b-1040)/2+"px")});}$(".chat-history").hide();
$(".jt-weixin-history").removeClass("on");if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"100%"});}a._setSearchDate();});$(document).on("click",".search-history-btn",function(){a.history.page=1;
a.history.status=false;a.history.startDate=$("input[name='startDate']").val();a.history.endDate=$("input[name='endDate']").val();a.history.contentSearchParam=$("input[name='contentSearchParam']").val();
a.history.contentType=$("input[name='contentType']:checked").val();a._loatRecordHistory(true);});$(document).on("click",".jt-lager-img",function(c){c.stopPropagation();
var b=$(this).attr("src");var d="大图";$.fancybox.open([{href:b,title:d}]);});$(document).on("click",".show-before-and-after",function(){var c=$(this).attr("createTime");
var b=$(this).attr("id-value");a.history.createTime=c;a._loadBeforeAndAfter(b);});$(document).on("click",".prePage",function(){var b=$("input[name='startDate']").val();
var c=$("input[name='endDate']").val();$("input[name='startDate']").val(DateUtils.getBeforeDate(7,b)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getBeforeDate(7,c)+" 23:59:59");
$(".search-history-btn").trigger("click");$(this).blur();});$(document).on("click",".nextPage",function(){var b=$("input[name='startDate']").val();var c=$("input[name='endDate']").val();
$("input[name='startDate']").val(DateUtils.getAfterDate(7,b)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getAfterDate(7,c)+" 23:59:59");$(".search-history-btn").trigger("click");
$(this).blur();});$(".jt-wx-label-div").on("mouseenter",function(){$(this).css({height:"auto"});a._dealStyle();}).on("mouseleave",function(){$(this).css({height:"34px"});
a._dealStyle();a._saveWxLabel();});$(document).on("click",".jt-wx-label",function(){if($(this).hasClass("jt-wx-label-selected")){$(this).removeClass("jt-wx-label-selected");
}else{if($(".jt-wx-label-selected").length>=3){DialogUtils.error(msgCode.ERROR,"最多选择3个标签");}else{$(this).addClass("jt-wx-label-selected");}}$(this).blur();
});$(document).on("click",".add-new-friend",function(){var c=$(this).parents("li");var f=c.attr("id");var b=c.find(".new-nick-name");var d=b.attr("user-name");
var e=b.attr("verify-ticket");a._addNewWxFriend(f,d,e);});$("#wxHistorySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".search-history-btn").trigger("click");
}});$("body").on("click",function(){$("#my-image-button-div").hide();$("#image-button-div").hide();});$(".web_wechat_face").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideFaceDiv();}else{a._hideImageDiv();a._hideComLanDiv();a._showFaceDiv();}});$(".web_wechat_image").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideImageDiv();}else{a._hideFaceDiv();a._hideComLanDiv();a._showImageDiv();}});$(".web_wechat_common_lan").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideComLanDiv();}else{a._hideFaceDiv();a._hideImageDiv();a._showComLanDiv();}});$(document).on("click",".face",function(){if($(this).hasClass("conten-face")){return;
}var c=$(this).html();var b=$(this).attr("class");$("#chat-textarea").append(c);a._hideFaceDiv();});$(document).on("click",".jt-com-lan-p",function(){var b=$(this).text();
$("#chat-textarea").append(b);a._hideComLanDiv();});$(".web_wechat_pic").on("click",function(){if($(this).hasClass("disabled")){return false;}$("#filePicker").find(".webuploader-element-invisible").click();
});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");var c=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;
});$("body").on("contextmenu",".self",function(c){if($(this).hasClass("remove")){return false;}var g=$(this).find(".wx-set-star").attr("value");var f=$(this).find(".wx-set-star").attr("createtime");
$("#back-msg-id").val(g);$("#back-msg-createtime").val(f);$(".jt-copy-content").attr("data-clipboard-text",a._removeHtml($(this).find(".text").html()));
var b=c.pageX;var d=c.pageY;$("#msg-button-div").css({"top":d,"left":b});$("#msg-button-div").show();$("#image-button-div").hide();return false;});$("body").on("contextmenu",".main",function(c){var b=$(c.target);
if((b.hasClass("self")||b.parents("div").hasClass("self"))&&!(b.hasClass("remove")||b.parents("div").hasClass("remove"))){return;}else{$("#msg-button-div").hide();
}});$("body").on("contextmenu",".msg-image",function(d){var b=d.pageX;var h=d.pageY;var c=$(this).attr("src-value");$("#collection-img-url").val(c);$("#image-button-div").css({"top":h,"left":b});
$("#image-button-div").show();$("#msg-button-div").hide();if($(this).parents(".self").length>0){$("#image-button-div").find(".backmsg").show();var g=$(this).parents(".self").find(".wx-set-star").attr("value");
var f=$(this).parents(".self").find(".wx-set-star").attr("createtime");$("#back-msg-id").val(g);$("#back-msg-createtime").val(f);}else{$("#image-button-div").find(".backmsg").hide();
}return false;});$("body").on("contextmenu",".my-face-image",function(c){var b=c.pageX;var f=c.pageY;var d=$(this).attr("id");$("#collection-img-id").val(d);
$("#my-image-button-div").css({"top":f,"left":b});$("#my-image-button-div").show();return false;});$("body").on("click",".face-image",function(){var b=$(this).attr("src-value");
a._hideImageDiv();a._sendImg(b);});$("body").on("click",".m-message",function(){$("#msg-button-div").hide();});$("body").on("click",".backmsg",function(){$("#msg-button-div").hide();
a._backMsg();});$("body").on("click",".collection-img",function(){$("#image-button-div").hide();a._collectionImg();});$("body").on("click",".collection-img-delete",function(){$("#my-image-button-div").hide();
a._collectionImgDelete();});$(".jt-wx-btn-div").on("mouseenter",function(){$("#jt-wx-caht-more-info").slideDown(400);});$("#jt-wx-caht-more-info").on("mouseleave",function(){$(this).slideUp(400);
});$("#jt-edit-con-lan").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weixinCommonLan/list.htm","我的常用语");});$(document).on("click",".web_wechat_message_fail",function(){var d=$(this).attr("id-val");
var c=$(this).attr("create-time");var b={userName:a.csInfo.userName,id:d,createTime:c};a._reSend(b);});$(document).on("click",".jt-copy-content",function(b){$("#msg-button-div").hide();
});},_removeHtml:function(a){a=a.replace(/<\/?[^>]*>/g,"");return a;},_removeNotRead:function(){FormUtils.submit(WeiXinChatForm._CONS_.CLEAR_UNREAD_URL,{friendCode:this.csInfo.csCode},function(a){},function(){},true);
if(!this.csInfo.hasInline){return false;}FormUtils.submit(WeiXinChatForm._CONS_.STATUS_NOTIFY_URL,{userName:this.csInfo.userName,empWx:this.csInfo.employeeWeiXin},function(a){},function(){},true);
},_readAudio:function(b,a){FormUtils.submit(WeiXinChatForm._CONS_.READ_AUDIO_URL,{id:b,createTime:a},function(c){if(c.success){$("#"+b).find(".web_wechat_noread").remove();
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_collectionImg:function(){var a=$("#collection-img-url").val();FormUtils.submit(WeiXinChatForm._CONS_.COLLECTION_IMG_URL,{path:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"收藏成功");
var c=JSON.parse(b.msg);$("#myCollecotionImagediv").prepend("<img id='"+c.id+"' class='my-face-image face-image' src-value='"+c.path+"' src='"+ctx+c.path+"'></img>");
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_collectionImgDelete:function(){var a=$("#collection-img-id").val();
FormUtils.submit(WeiXinChatForm._CONS_.DELETE_COLLECTION_URL,{id:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"删除成功");$("#"+a).remove();
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_backMsg:function(){var b=$("#back-msg-id").val();
var a=$("#back-msg-createtime").val();FormUtils.submit(WeiXinChatForm._CONS_.BACK_MSG_URL,{id:b,userName:this.csInfo.userName,createTime:a},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"撤回成功");
$("#"+b).find(".main").addClass("remove");$("#"+b).find(".main").append("<span class='msg-revoke'>撤</span>");}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_addNewWxFriend:function(c,a,b){FormUtils.submit(WeiXinChatForm._CONS_.ADD_FRIEND_URL,{id:c,userName:a,verifyTicket:b},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,"添加成功");
$("#"+c).find(".add-new-friend").remove();}else{DialogUtils.error(msgCode.ERROR,"系统添加好友达到上限。请先用手机通过好友申请");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_saveWxLabel:function(){var f=$(".jt-wx-label-selected");var a="";for(var e=0;e<f.length;e++){if(e==f.length-1){a+=$(f[e]).text();}else{a+=$(f[e]).text()+",";
}}var h=a.split(",");var b=this.csInfo.wxLabel.split(",");if(h.length<=0&&b.length<=0){return;}var k=false;for(var e=0;e<h.length;e++){var d=false;for(var c=0;
c<b.length;c++){if(h[e]==b[c]){d=true;break;}}if(!d){k=true;break;}}var g=this;g.csInfo.wxLabel=a;if(k||h.length!=b.length){FormUtils.submit(WeiXinChatForm._CONS_.SAVE_LABEL_URL,{userName:g.csInfo.userName,label:a},function(i){if(i.success){DialogUtils.success(msgCode.SUCCESS,"打标签成功");
$("#"+g._getId(g.csInfo.userName)).attr("wx-label",a);$("#"+g._getId(g.csInfo.userName)+"-recent").attr("wx-label",a);}else{DialogUtils.error(msgCode.ERROR,i.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_selectWxLabel:function(){var a=this.csInfo.wxLabel;if(!(a==null||a=="")){var b=$(".jt-wx-label");
$.each(b,function(){if(a.indexOf($(this).text())!=-1){$(this).addClass("jt-wx-label-selected");}});}if(!this.csInfo.hasInline){$(".jt-wx-label").attr("disabled",true);
}else{$(".jt-wx-label").attr("disabled",false);}},_canSearch:function(){var b=true;if(this.history.startDate==null||this.history.startDate==""){DialogUtils.error(msgCode.ERROR,"起始时间不能为空！");
b=false;}else{if(this.history.endDate==null||this.history.endDate==""){var a=DateUtils.getDateDiff(this.history.startDate,DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"结束时间为空时起始时间距现在不能超过7天");b=false;}}else{var a=DateUtils.getDateDiff(this.history.startDate,this.history.endDate,"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"起始时间与结束时间不能超过7天");b=false;}}}return b;},_loadBeforeAndAfter:function(d){var b=this;if(!b._canSearch()){return false;
}var a=$(".history-message-box").find(".inner-div");a.empty();var c=WeiXinChatForm._CONS_.LIST_BEFORE_AFTER_URL+"?hasGrant="+ResUtils.canShow("weiXinChat.button.viewPhone")+"&Q__S__EQ__employee_wei_xin_="+b.csInfo.employeeWeiXin+"&nickNameHashCode="+b.csInfo.nickNameHashCode+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&createTime="+this.history.createTime;
FormUtils.loadData(c,function(f){if(f&&f.length){var g=new StringBuffer();for(var e=f.length-1;e>=0;e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;
}else{f[e].headImgUrl=f[e].employeeHeadPic;}g.append(b._getHistoryLi(f[e]));}a.prepend(g.toString());$("#history-"+d).css({"background-color":"rgba(239, 199, 87, 0.35)","border":"1px solid #f8ac59"});
location.href="#history-"+d;}b.history.status=true;b._setDuration();});},_loatRecordHistory:function(d){var b=this;if(!b._canSearch()){return false;}var a=$(".history-message-box").find(".inner-div");
if(d){a.empty();}var c=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?hasGrant="+ResUtils.canShow("weiXinChat.button.viewPhone")+"&Q__S__EQ__employee_wei_xin_="+b.csInfo.employeeWeiXin+"&nickNameHashCode="+b.csInfo.nickNameHashCode+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_&"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&Q__S__EQ__is_sign_="+this.history.isSign+"&Q__S__LK__content_="+encodeURIComponent(this.history.contentSearchParam)+"&Q__S__IN__content_type_="+this.history.contentType;
FormUtils.loadData(c,function(h){var f=h.rows;b.history.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=a.height();for(var e=f.length-1;e>=0;
e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;}else{f[e].headImgUrl=(f[e].employeeHeadPic==""?ctx+"/img/jt/logos/t9.png":f[e].employeeHeadPic);
}j.append(b._getHistoryLi(f[e],true));}a.prepend(j.toString());if(d){$(".history-message-box").scrollTop($(".history-message-box")[0].scrollHeight);}else{g=a.height()-g;
$(".history-message-box").scrollTop(g);}}b.history.status=true;b._setDuration();});},loadRecord:function(d){var a=this;var c=$(".m-message").find("ul");
if(d){c.empty();}var b=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?hasGrant="+ResUtils.canShow("weiXinChat.button.viewPhone")+"&nickNameHashCode="+a.csInfo.nickNameHashCode+"&Q__S__EQ__employee_wei_xin_="+a.csInfo.employeeWeiXin+"&page="+this.record.page+"&rows="+this.record.rows+"&sord=desc&sidx=create_time_";
FormUtils.loadData(b,function(h){var f=h.rows;a.record.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=$(".m-message").find("ul").height();
for(var e=f.length-1;e>=0;e--){j.append(a._getChartLi(f[e]));}c.prepend(j.toString());if(d){a._gotoBottom();}else{g=$(".m-message").find("ul").height()-g;
$(".m-message").scrollTop(g);}}a.record.status=true;a._setDuration();if(a.record.total>a.record.page){$(".jt-more-record-div").show();}else{$(".jt-more-record-div").hide();
}},function(){},true);},_setDuration:function(){setTimeout(function(){var b=$(".not_duration");for(var a=0;a<b.length;a++){var c=$(b[a]).find(".media")[0];
var d=parseInt(c.duration);$(b[a]).removeClass("not_duration").find(".audio_length").empty().append(d+"''");$(b[a]).find(".audio_area").css({width:(70+2*d)+"px"});
}},300);},send:function(){var a=this;var c=a.weixinTextarea.getValue();$("#chat-textarea").empty();for(var b=0;b<c.length;b++){var d={content:encodeURIComponent(c[b].content),contentType:c[b].contentType,employeeId:currentUserId,userName:a.csInfo.userName,};
if(c[b].fileName){d.fileName=c[b].fileName;}if(c[b].fileSize){d.fileSize=c[b].fileSize;}a._sendFinal(d);}},_sendImg:function(c){var a=this;var b=new Date();
var d={content:c,contentType:4,employeeId:currentUserId,userName:a.csInfo.userName,};a._sendFinal(d);},_sendFinal:function(b){var a=this;FormUtils.submit(WeiXinChatForm._CONS_.RECODE_SEND_URL,b,function(c){if(c.success){}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_reSend:function(b){var a=this;FormUtils.submit(WeiXinChatForm._CONS_.RESEND_MSG_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCESS,c.msg);
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_gotoBottom:function(){$(".m-message").scrollTop($(".m-message")[0].scrollHeight);
},_getContent:function(b){if(b.lastReplyType==1||b.lastReplyType==4||b.lastReplyType=="1"||b.lastReplyType=="4"){return"[图片]";}else{if(b.lastReplyType==2||b.lastReplyType=="2"){return"[语音]";
}else{if(b.contentType==7){return"[文件]";}else{if(b.lastReplyType==5||b.lastReplyType=="5"){var a=b.lastReplyContent.split(";");var c=a[0]+"想要加你为朋友";if(c.length>10){return c.substring(0,9)+"...";
}else{return c;}}else{if(b.lastReplyContent&&b.lastReplyContent.length>10){return b.lastReplyContent.substring(0,9)+"...";}else{return b.lastReplyContent;
}}}}}},_getChartLi:function(b){var c=false;if(this.lastChatTime==""){this.lastChatTime=b.createTime;c=true;}else{var d=DateUtils.getDateDiff(this.lastChatTime,b.createTime,"minute");
if(Math.abs(d)>=3){this.lastChatTime=b.createTime;c=true;}}var a=DateUtils.getDateDiff(b.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");
var e=new StringBuffer();e.append("<li id='"+b.id+"' >");if(c){if(Math.abs(a)<24){e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"HH:mm:ss")+"</span></p>");
}else{e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"yyyy-MM-dd HH:mm:ss")+"</span></p>");}}e.append("<div class='main "+(b.type=="out"?"self":"")+(b.status&&b.status==1?" remove'":"")+"'>");
e.append("<span type='checkbox' style='display:none;' value='"+b.id+"' createTime='"+b.createTime+"' class='glyphicon glyphicon-star wx-set-star "+(b.type=="out"?"wx-set-star-right ":"wx-set-star-left ")+(b.isSign=="y"?" wx-set-star-checked":"")+"'></span>");
if(b.type=="out"&&b.status==2){e.append("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+b.id+"' create-time='"+b.createTime+"'></i>");
}e.append("<img class='avatar' width='30' height='30' src='"+this._getHeadImgUrl(b)+"'>").append("<div class='text "+(b.contentType==5||b.contentType=="5"?" text-add":"")+"'>"+this._getMsgType(b)+"</div>"+WeiXinUtil.getIsRevoke(b)).append("</div></li>");
return e.toString();},_getHistoryLi:function(b,a){if($("#history-"+b.id).length>0){return"";}var c=new StringBuffer();c.append("<div id='history-"+b.id+"' >");
if(b.type=="out"){c.append("<p style='color:#1ab394'>"+(b.employeeAid+":"+b.employeeName)+"  "+b.createTime);}else{c.append("<p style='color:#0035ff'>"+(b.nickName)+"  "+b.createTime);
}c.append("</p>").append("<p class='history-text'>"+(this._isSearch(a)?("<a class='show-before-and-after' id-value='"+b.id+"' createTime='"+b.createTime+"'>"+this._getMsgType(b,a)+"</a>"):this._getMsgType(b))).append(WeiXinUtil.getIsRevoke(b)).append("</p>").append("</div>");
return c.toString();},_isSearch:function(a){if(a&&!(this.history.isSign==""&&this.history.contentSearchParam=="")){return true;}else{return false;}},_getMsgType:function(c,a){if(c.contentType==0||c.contentType=="0"){return WeiXinUtil.replaceFace(c.content);
}else{if(c.contentType==1||c.contentType=="1"){var b=c.content.split(";");if(b.length>1){return"<img style='width:120px;height:120px;' src-value='"+c.content+"' class='jt-lager-img' src='"+ctx+b[0]+"' big-src='"+ctx+b[1]+"'>";
}else{return"<img style='width:120px;height:120px;' src-value='"+c.content+"' class='jt-lager-img' src='"+ctx+c.content+"' big-src='"+ctx+c.content+"'>";
}}else{if(c.contentType==2||c.contentType=="2"){return WeiXinUtil.getAudioSpan(c);}else{if(c.contentType==4||c.contentType=="4"){return"<img style='width:80px;height:80px;' src-value='"+c.content+"' class='msg-image'  src='"+ctx+c.content+"' big-src='"+ctx+c.content+"'>";
}else{if(c.contentType==5||c.contentType=="5"){return WeiXinUtil.getNewFriendMsg(c);}else{if(c.contentType==7||c.contentType=="7"){return WeiXinUtil.getFileMsg(c);
}else{if(a&&this.history.contentSearchParam!=""){return c.content.replaceAll(this.history.contentSearchParam,"<span style='background-color:yellow;'>"+this.history.contentSearchParam+"</span>");
}else{return c.content;}}}}}}}},_getHeadImgUrl:function(b){var a="";if(b.type=="in"){a=b.headPic!=null&&b.headPic!=""?b.headPic:this.csInfo.headImgUrl;
}else{a=b.employeeHeadPic?b.employeeHeadPic:currentUserProfile;if(a==""){a="/img/jt/logos/t9.png";}}if(a&&a.indexOf("http://wx.qlogo.cn")==-1&&a.indexOf(ctx)==-1){a=ctx+a;
}return a;},_getId:function(a){var b=a.substring(1,a.length);if(b.indexOf("@")==0){b="qun-"+b.substring(1,b.length);}return b;},_initFaceImages:function(){var a=WeiXinChatForm._CONS_.FIND_FACE_IMAGES_URL;
FormUtils.loadData(a,function(f){var d=f.myCollectImages;var c=f.systemImages;var g=new StringBuffer();for(var b=0;b<d.length;b++){g.append("<img class='my-face-image face-image' id='"+d[b].id+"' src-value='"+d[b].path+"' src='"+ctx+d[b].path+"'></img>");
}$("#myCollecotionImagediv").empty().append(g.toString());var e=new StringBuffer();for(var b=0;b<c.length;b++){e.append("<img class='face-image' src-value='"+c[b].path+"'  src='"+ctx+c[b].path+"'></img>");
}$("#systemImagediv").empty().append(e.toString());});},_initCommonLan:function(){var a=WeiXinChatForm._CONS_.FIND_COM_LAN_URL;FormUtils.loadData(a,function(b){var d=new StringBuffer();
for(var c=0;c<b.length;c++){d.append("<p class='jt-com-lan-p'>"+b[c].content+"</p>");}$("#myComLandiv").empty().append(d.toString());});}};var weixinFaces={"[微笑]":'<a title="微笑" type="qq" class="face qqface conten-face qqface0 ">[微笑]</a>',"[撇嘴]":'<a title="撇嘴" type="qq" class="face qqface conten-face qqface1">[撇嘴]</a>',"[色]":'<a title="色" type="qq" class="face qqface conten-face qqface2">[色]</a>',"[发呆]":'<a title="发呆" type="qq" class="face qqface conten-face qqface3">[发呆]</a>',"[得意]":'<a title="得意" type="qq" class="face qqface conten-face qqface4">[得意]</a>',"[流泪]":'<a title="流泪" type="qq" class="face qqface conten-face qqface5">[流泪]</a>',"[害羞]":'<a title="害羞" type="qq" class="face qqface conten-face qqface6">[害羞]</a>',"[闭嘴]":'<a title="闭嘴" type="qq" class="face qqface conten-face qqface7">[闭嘴]</a>',"[睡]":'<a title="睡" type="qq" class="face qqface conten-face qqface8">[睡]</a>',"[大哭]":'<a title="大哭" type="qq" class="face qqface conten-face qqface9">[大哭]</a>',"[尴尬]":'<a title="尴尬" type="qq" class="face qqface conten-face qqface10">[尴尬]</a>',"[发怒]":'<a title="发怒" type="qq" class="face qqface conten-face qqface11">[发怒]</a>',"[调皮]":'<a title="调皮" type="qq" class="face qqface conten-face qqface12">[调皮]</a>',"[呲牙]":'<a title="呲牙" type="qq" class="face qqface conten-face qqface13">[呲牙]</a>',"[惊讶]":'<a title="惊讶" type="qq" class="face qqface conten-face qqface14">[惊讶]</a>',"[难过]":'<a title="难过" type="qq" class="face qqface conten-face qqface15">[难过]</a>',"[酷]":'<a title="酷" type="qq" class="face qqface conten-face qqface16">[酷]</a>',"[冷汗]":'<a title="冷汗" type="qq" class="face qqface conten-face qqface17">[冷汗]</a>',"[抓狂]":'<a title="抓狂" type="qq" class="face qqface conten-face qqface18">[抓狂]</a>',"[吐]":'<a title="吐" type="qq" class="face qqface conten-face qqface19">[吐]</a>',"[偷笑]":'<a title="偷笑" type="qq" class="face qqface conten-face qqface20">[偷笑]</a>',"[愉快]":'<a title="愉快" type="qq" class="face qqface conten-face qqface21">[愉快]</a>',"[白眼]":'<a title="白眼" type="qq" class="face qqface conten-face qqface22">[白眼]</a>',"[傲慢]":'<a title="傲慢" type="qq" class="face qqface conten-face qqface23">[傲慢]</a>',"[饥饿]":'<a title="饥饿" type="qq" class="face qqface conten-face qqface24">[饥饿]</a>',"[困]":'<a title="困" type="qq" class="face qqface conten-face qqface25">[困]</a>',"[惊恐]":'<a title="惊恐" type="qq" class="face qqface conten-face qqface26">[惊恐]</a>',"[流汗]":'<a title="流汗" type="qq" class="face qqface conten-face qqface27">[流汗]</a>',"[憨笑]":'<a title="憨笑" type="qq" class="face qqface conten-face qqface28">[憨笑]</a>',"[悠闲]":'<a title="悠闲" type="qq" class="face qqface conten-face qqface29">[悠闲]</a>',"[奋斗]":'<a title="奋斗" type="qq" class="face qqface conten-face qqface30">[奋斗]</a>',"[咒骂]":'<a title="咒骂" type="qq" class="face qqface conten-face qqface31">[咒骂]</a>',"[疑问]":'<a title="疑问" type="qq" class="face qqface conten-face qqface32">[疑问]</a>',"[嘘]":'<a title="嘘" type="qq" class="face qqface conten-face qqface33">[嘘]</a>',"[晕]":'<a title="晕" type="qq" class="face qqface conten-face qqface34">[晕]</a>',"[疯了]":'<a title="疯了" type="qq" class="face qqface conten-face qqface35">[疯了]</a>',"[衰]":'<a title="衰" type="qq" class="face qqface conten-face qqface36">[衰]</a>',"[骷髅]":'<a title="骷髅" type="qq" class="face qqface conten-face qqface37">[骷髅]</a>',"[敲打]":'<a title="敲打" type="qq" class="face qqface conten-face qqface38">[敲打]</a>',"[再见]":'<a title="再见" type="qq" class="face qqface conten-face qqface39">[再见]</a>',"[擦汗]":'<a title="擦汗" type="qq" class="face qqface conten-face qqface40">[擦汗]</a>',"[抠鼻]":'<a title="抠鼻" type="qq" class="face qqface conten-face qqface41">[抠鼻]</a>',"[鼓掌]":'<a title="鼓掌" type="qq" class="face qqface conten-face qqface42">[鼓掌]</a>',"[糗大了]":'<a title="糗大了" type="qq" class="face qqface conten-face qqface43">[糗大了]</a>',"[坏笑]":'<a title="坏笑" type="qq" class="face qqface conten-face qqface44">[坏笑]</a>',"[左哼哼]":'<a title="左哼哼" type="qq" class="face qqface conten-face qqface45">[左哼哼]</a>',"[右哼哼]":'<a title="右哼哼" type="qq" class="face qqface conten-face qqface46">[右哼哼]</a>',"[哈欠]":'<a title="哈欠" type="qq" class="face qqface conten-face qqface47">[哈欠]</a>',"[鄙视]":'<a title="鄙视" type="qq" class="face qqface conten-face qqface48">[鄙视]</a>',"[委屈]":'<a title="委屈" type="qq" class="face qqface conten-face qqface49">[委屈]</a>',"[快哭了]":'<a title="快哭了" type="qq" class="face qqface conten-face qqface50">[快哭了]</a>',"[阴险]":'<a title="阴险" type="qq" class="face qqface conten-face qqface51">[阴险]</a>',"[亲亲]":'<a title="亲亲" type="qq" class="face qqface conten-face qqface52">[亲亲]</a>',"[吓]":'<a title="吓" type="qq" class="face qqface conten-face qqface53">[吓]</a>',"[可怜]":'<a title="可怜" type="qq" class="face qqface conten-face qqface54">[可怜]</a>',"[菜刀]":'<a title="菜刀" type="qq" class="face qqface conten-face qqface55">[菜刀]</a>',"[西瓜]":'<a title="西瓜" type="qq" class="face qqface conten-face qqface56">[西瓜]</a>',"[啤酒]":'<a title="啤酒" type="qq" class="face qqface conten-face qqface57">[啤酒]</a>',"[篮球]":'<a title="篮球" type="qq" class="face qqface conten-face qqface58">[篮球]</a>',"[乒乓]":'<a title="乒乓" type="qq" class="face qqface conten-face qqface59">[乒乓]</a>',"[咖啡]":'<a title="咖啡" type="qq" class="face qqface conten-face qqface60">[咖啡]</a>',"[饭]":'<a title="饭" type="qq" class="face qqface conten-face qqface61">[饭]</a>',"[猪头]":'<a title="猪头" type="qq" class="face qqface conten-face qqface62">[猪头]</a>',"[玫瑰]":'<a title="玫瑰" type="qq" class="face qqface conten-face qqface63">[玫瑰]</a>',"[凋谢]":'<a title="凋谢" type="qq" class="face qqface conten-face qqface64">[凋谢]</a>',"[嘴唇]":'<a title="嘴唇" type="qq" class="face qqface conten-face qqface65">[嘴唇]</a>',"[爱心]":'<a title="爱心" type="qq" class="face qqface conten-face qqface66">[爱心]</a>',"[心碎]":'<a title="心碎" type="qq" class="face qqface conten-face qqface67">[心碎]</a>',"[蛋糕]":'<a title="蛋糕" type="qq" class="face qqface conten-face qqface68">[蛋糕]</a>',"[闪电]":'<a title="闪电" type="qq" class="face qqface conten-face qqface69">[闪电]</a>',"[炸弹]":'<a title="炸弹" type="qq" class="face qqface conten-face qqface70">[炸弹]</a>',"[刀]":'<a title="刀" type="qq" class="face qqface conten-face qqface71">[刀]</a>',"[足球]":'<a title="足球" type="qq" class="face qqface conten-face qqface72">[足球]</a>',"[瓢虫]":'<a title="瓢虫" type="qq" class="face qqface conten-face qqface73">[瓢虫]</a>',"[便便]":'<a title="便便" type="qq" class="face qqface conten-face qqface74">[便便]</a>',"[月亮]":'<a title="月亮" type="qq" class="face qqface conten-face qqface75">[月亮]</a>',"[太阳]":'<a title="太阳" type="qq" class="face qqface conten-face qqface76">[太阳]</a>',"[礼物]":'<a title="礼物" type="qq" class="face qqface conten-face qqface77">[礼物]</a>',"[拥抱]":'<a title="拥抱" type="qq" class="face qqface conten-face qqface78">[拥抱]</a>',"[强]":'<a title="强" type="qq" class="face qqface conten-face qqface79">[强]</a>',"[弱]":'<a title="弱" type="qq" class="face qqface conten-face qqface80">[弱]</a>',"[握手]":'<a title="握手" type="qq" class="face qqface conten-face qqface81">[握手]</a>',"[胜利]":'<a title="胜利" type="qq" class="face qqface conten-face qqface82">[胜利]</a>',"[抱拳]":'<a title="抱拳" type="qq" class="face qqface conten-face qqface83">[抱拳]</a>',"[勾引]":'<a title="勾引" type="qq" class="face qqface conten-face qqface84">[勾引]</a>',"[拳头]":'<a title="拳头" type="qq" class="face qqface conten-face qqface85">[拳头]</a>',"[差劲]":'<a title="差劲" type="qq" class="face qqface conten-face qqface86">[差劲]</a>',"[爱你]":'<a title="爱你" type="qq" class="face qqface conten-face qqface87">[爱你]</a>',"[NO]":'<a title="NO" type="qq" class="face qqface conten-face qqface88">[NO]</a>',"[OK]":'<a title="OK" type="qq" class="face qqface conten-face qqface89">[OK]</a>',"[爱情]":'<a title="爱情" type="qq" class="face qqface conten-face qqface90">[爱情]</a>',"[飞吻]":'<a title="飞吻" type="qq" class="face qqface conten-face qqface91">[飞吻]</a>',"[跳跳]":'<a title="跳跳" type="qq" class="face qqface conten-face qqface92">[跳跳]</a>',"[发抖]":'<a title="发抖" type="qq" class="face qqface conten-face qqface93">[发抖]</a>',"[怄火]":'<a title="怄火" type="qq" class="face qqface conten-face qqface94">[怄火]</a>',"[转圈]":'<a title="转圈" type="qq" class="face qqface conten-face qqface95">[转圈]</a>',"[磕头]":'<a title="磕头" type="qq" class="face qqface conten-face qqface96">[磕头]</a>',"[回头]":'<a title="回头" type="qq" class="face qqface conten-face qqface97">[回头]</a>',"[跳绳]":'<a title="跳绳" type="qq" class="face qqface conten-face qqface98">[跳绳]</a>',"[投降]":'<a title="投降" type="qq" class="face qqface conten-face qqface99">[投降]</a>',"[激动]":'<a title="激动" type="qq" class="face qqface conten-face qqface100">[激动]</a>',"[乱舞]":'<a title="乱舞" type="qq" class="face qqface conten-face qqface101">[乱舞]</a>',"[献吻]":'<a title="献吻" type="qq" class="face qqface conten-face qqface102">[献吻]</a>',"[左太极]":'<a title="左太极" type="qq" class="face qqface conten-face qqface103">[左太极]</a>',"[右太极]":'<a title="右太极" type="qq" class="face qqface conten-face qqface104">[右太极]</a>',"[嘿哈]":'<a title="嘿哈" type="qq" class="emoji  conten-face emoji8">[嘿哈]</a>',"[捂脸]":'<a title="捂脸" type="qq" class="emoji  conten-face emoji9">[捂脸]</a>',"[奸笑]":'<a title="奸笑" type="qq" class="emoji  conten-face emoji10">[奸笑]</a>',"[机智]":'<a title="机智" type="qq" class="emoji  conten-face emoji11">[机智]</a>',"[皱眉]":'<a title="皱眉" type="qq" class="emoji  conten-face emoji12">[皱眉]</a>',"[耶]":'<a title="耶" type="qq" class="emoji  conten-face emoji13">[耶]</a>',"[鸡]":'<a title="鸡" type="qq" class="emoji  conten-face emoji20">[鸡]</a>',};
var WeiXinUtil={replaceFace:function(a){if(typeof a=="object"){a=JSON.stringify(a);}a=a.replace(/\[[A-Z\u4E00-\u9FA5]*\]/g,function(c,b){if(weixinFaces.hasOwnProperty(c)){return weixinFaces[c];
}return c;});return this._markRed(a);},_markRed:function(b){var a=/([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,3}){1,2})/g;b=b.replace(a,function(d,c){return"<span style='color:red;'>"+d+"</span>";
});return b;},getIsRevoke:function(a){if(a.status&&a.status==1){return"<span class='msg-revoke'>撤</span>";}else{if(a.status&&a.status==5){return"<span class='msg-revoke'>撤回中...</span>";
}else{return"";}}},getFileMsg:function(c){var a=[];if(c.content.indexOf("_;_")!=-1){a=c.content.split("_;_");}else{if(c.content.indexOf(";")!=-1){a=c.content.split(";");
}else{if(c.content.indexOf("/UploadedFile/bucket/")!=-1){a=c.content.split(";");}else{return c.content;}}}var e=new StringBuffer();var d=(a.length>=2?a[1]:"未知文件");
var b=(a.length>=3?a[2]:0);e.append("<div class='attach'>").append("<div class='attach_bd'>").append("<div class='cover'>").append("<img class='no' src='"+ImageUtils.getFileCoverUrl(a[0])+"' class='icon-unknown ng-scope'></img>").append("</div>").append("<div class='cont'>").append("<p class='title'>"+d+"</p>").append("<div class='opr'>").append("<span >"+this._getFileSize(b)+"</span>").append("<a class='download-file' name-value='"+d+"' url-value='"+a[0]+"'><img class='no' src='"+ctx+"/img/jt/wx/images/download.png' /></a>").append("</div>").append("</div>").append("</div>").append("</div>");
return e.toString();},_getFileSize:function(a){if(a==0){return"";}else{if(a<1024){return a+"B";}else{if(a<1024*1024){return(a/1024).toFixed(2)+"KB";}else{if(a<1024*1024*1024){return(a/(1024*1024)).toFixed(2)+"MB";
}else{return"";}}}}},getAudioSpan:function(d,b,c){var a=d.content.split(";");var f=new StringBuffer();var e=ctx+"/crm/components/upload/download.htm?dname=123.mp3&durl="+ctx+a[0];
f.append("<div  class='jt-audio-box jt-audio-element'><div class='jt-audio' id-value='"+d.id+"' createtime='"+d.createTime+"'><i class='jt-audio-element' style='background: transparent url(").append(ctx).append("/img/jt/wx/images/yuyin.png) no-repeat 0 0;background-size: 74px 25px;background-position: -4px center;' src-value='").append(e).append("'></i>");
if(a.length<=1&&d.type=="in"){f.append('<div idVal="'+d.id+'" class="web_wechat_noread" style=""></div>');}f.append("<span class='jt-audio-element' style='float:right;margin-right:9px;'>点击播放</span>");
f.append("<audio style='display:none;'></audio>");f.append("</div></div>");if(b){if(d.voiceTranslateResult){f.append('<div class="translateToWord" createTime="'+d.createTime+'"  idVal="'+d.id+'" title="'+d.voiceTranslateResult+'" style="line-height:34px;cursor: copy;padding-left:20px;" >！</div>');
}else{f.append('<div class="translateToWord" createTime="'+d.createTime+'" idVal="'+d.id+'" title="点击？翻译" style="" >？</div>');}}else{if(c&&d.voiceTranslateResult){f.append('<div class="translateToWord" createTime="'+d.createTime+'"  idVal="'+d.id+'" title="'+d.voiceTranslateResult+'" style="line-height:34px;cursor: copy;padding-left:20px;" >！</div>');
}}return f.toString();},getNameCard:function(a){if(a.type=="in"){return"向你推荐了"+a.content.nickname;}else{return"你推荐了"+a.content.nickname;}},getTransfer:function(d){var b=d.content.money;
var c="";var a="";if(d.content.paysubtype=="1"){if(d.type=="in"){c="转账给你";a="wx-transfer-take";}else{c="转账给对方";}}else{c="已收钱";}var e=new StringBuffer();
e.append("<div class='"+a+"' data-json_msg='"+JSON.stringify(d.content)+"'>").append("<div class='wx-transfer-1'>").append("<p>"+c+"</p>").append("<p>￥"+b+"</p>").append("</div>").append("<div class='wx-transfer-2'>").append("微信转账").append("</div>").append("</div>");
return e.toString();},getVideoMsg:function(a){var b=new StringBuffer();if(a.content&&(a.content.indexOf(".mp4")>0||a.content.indexOf(".MP4")>0)){b.append("<img class='jt-video'src='"+ctx+"/img/jt/wx/images/video.jpg' src-data='"+ctx+a.content+"'>").append("</img>");
}else{b.append(a.content);}return b.toString();},getNewFriendMsg:function(b){var a=b.content.split(";");var c=new StringBuffer();c.append("<p class='new-friend'>朋友验证请求 "+((a[4]==1)?"<span class='pull-right glyphicon glyphicon-plus add-new-friend ' title='添加好友'></span>":"")+"</p>").append("<img class='avatar' style='height:40px;width:40px;'  src-val='/t9-ecm/img/jt/wx/images/head_default.jpg' src='/t9-ecm/img/jt/wx/images/head_default.jpg'>").append("<p style='display: inline-block;line-height:1.6;'>"+this._getNewInfo(a)+"</p>");
return c.toString();},getNewFriendMsg2:function(b){var a=b.content.split(";");return a[1];},_getNewInfo:function(a){var b=new StringBuffer();if(a.length<5){return"";
}b.append("<span class='new-nick-name' user-name='"+a[2]+"' verify-ticket='"+a[3]+"' is-add='"+a[4]+"''>"+a[0]+"</span>").append("<br>").append(a[0]+":"+a[1]);
return b.toString();},showPlayVideotLayer:function(b){var a=this;layer.open({type:1,title:"视频",maxmin:false,move:false,scrollbar:false,shadeClose:false,area:["600px","530px"],content:$(".jt-wx-play-video"),success:function(c,d){var e=ctx+"/crm/components/upload/download.htm?dname=123.mp4&durl="+b;
$("#jt-wx-video").attr("src",e);$("#download-mp4").attr("url-value",b);},yes:function(d,c){layer.close(d);},});},changeTypeToCN:function(a){if(a.lastReplyType==1||a.lastReplyType==4||a.lastReplyType=="1"||a.lastReplyType=="4"){return"[图片]";
}else{if(a.lastReplyType==2||a.lastReplyType=="2"){return"[语音]";}else{if(a.lastReplyType==7||a.lastReplyType=="7"){return"[文件]";}else{if(a.lastReplyType==8){return"[视频]";
}else{if(a.lastReplyType==5||a.lastReplyType=="5"){if(typeof a.lastReplyContent=="object"){return a.lastReplyContent.content;}else{return JSON.parse(a.lastReplyContent).content;
}}else{if(a.lastReplyType==10||a.lastReplyType=="10"){if(typeof a.lastReplyContent=="object"){return"推荐了"+a.lastReplyContent.nickname;}else{return"推荐了"+JSON.parse(a.lastReplyContent).nickname;
}}else{if(a.lastReplyType==12||a.lastReplyType=="12"){return"[转账]";}else{return WeiXinUtil.replaceFace(a.lastReplyContent);}}}}}}}},};$(function(){var a=new UploadImageUtil();
a.init();});function UploadImageUtil(){this.userId=currentUserId;this.contentId="uploader";this.images=[];}UploadImageUtil._CONS_={SAVE_ADD_URL:ctx+"/gl/image/image/saveAdd.htm",UPLOAD_PARAMS:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":"image/*","fileSingleSizeLimit":1*1024*1024*6,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
UploadImageUtil.prototype={init:function(b,a){if(b){this.contentId=b;}$("#"+this.contentId).hide();if(!a){this._bindEventHandler();}},_bindEventHandler:function(){var a=this;
$(".uploadImage").on("click",function(){a._bindWebuploader();});$("#imageContainer").on("mouseenter",".file-box",function(){if(a._status!="selecting"){$(this).addClass("animated "+"pulse");
}});$("#imageContainer").on("mouseleave",".file-box",function(){if(a._status!="selecting"){var b=$(this);window.setTimeout(function(){b.removeClass("animated "+"pulse");
},2000);}});if(a.contentId=="uploader"){$("#imageContainer").on("click",".showPhotoAlbum",function(){var b=new stringBuffer();b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1669/23976340262_a5ca3859f6_b.jpg" title="Twilight Memories (doraartem)">');
b.append('<img src="http://farm2.staticflickr.com/1669/23976340262_a5ca3859f6_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1459/23610702803_83655c7c56_b.jpg" title="Electrical Power Lines and Pylons disappear over t.. (pautliubomir)">');
b.append('<img src="http://farm2.staticflickr.com/1459/23610702803_83655c7c56_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1617/24108587812_6c9825d0da_b.jpg" title="Morning Godafoss (Brads5)">');
b.append('	<img src="http://farm2.staticflickr.com/1617/24108587812_6c9825d0da_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm4.staticflickr.com/3691/10185053775_701272da37_b.jpg" title="Vertical - Special Edition! (cedarsphoto)">');
b.append('<img src="http://farm4.staticflickr.com/3691/10185053775_701272da37_m.jpg" alt="" />');b.append("</a>");$("#imageContainer").append(b.toString());
$(".fancybox").fancybox({openEffect:"none",closeEffect:"none"});});}},_bindWebuploader:function(b,g){var c=this;if(!g){g=c.contentId;}if(b){$("#imageContainer").empty().append(ImageUtils.createImageDivStr(b,null,true,null,true));
}var d=0;function e(j,i){if(i.flag){var k={height:i.height,width:i.width,path:i.localPath,name:i.fileName,byteCount:i.byteCount,isWater:i.water,isZoom:i.zoom,saveType:"relative",cateId:c.albumId,sort:d++};
c.images=[];c.images.push(k);}}function a(i,j){alert("上传"+i.name+"失败，原因是"+j);}function f(){$("#imageContainer").append(ImageUtils.createImageDivStr(c.images,null,true,null,true));
$("#"+g).hide();}var h=new JTWebUploader({config:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":".jpg,.jpeg,.png,.bmp,.gif","fileSingleSizeLimit":100*1024*1024*6,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"},container:"uploader",caption:"支持所有格式的文件上传！单个文件不得超过100M，一次最多上传10个文件！",success:e,error:a,finish:f,auto:true});
h.init();setTimeout(function(){$("#filePicker").find(".webuploader-element-invisible").trigger("click");},1);},_buildImageJson:function(){var a=[];$("#imageContainer").find(".file-box").each(function(){var c=$(this).find(".file a").attr("nameVal");
c=c.replace(/[\-\_\,\!\|\~\`\(\)\#\$\%\^\&\*\{\}\:\;\"\L\<\>\?\[\]\@]/g,"");var b=$(this).find(".file a").attr("urlVal");var d={name:c,path:b};a.push(d);
});return a;},getOptions:function(b){var c=this;var a=window.sessionStorage.getItem("loacalCashPicture");if(a&&a!=null&&a!=""){c._apendData(b,JSON.parse(a));
}else{FormUtils.loadData(ctx+"/gl/image/image/listImageByKey.htm?key=cashPicture&typeKey=system",function(d){window.sessionStorage.setItem("loacalCashPicture",JSON.stringify(d));
c._apendData(b,d);});}},_apendData:function(a,c){var d;if(a){d=$("#"+a);if(d.length==0){d=$("select."+a);if(d.length==0){d=$("select[name='"+a+"']");if(d.length==0){return false;
}}}}var e=new StringBuffer();if(c&&c.length>0){e.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){e.append("<option value='"+c[b].path+"'>"+c[b].name+"</option>");
}d.empty().append(e.toString());}}};function JTWebUploader(a){this.config=a.config;this.container=a.container;this.finish=a.finish;this.success=a.success;
this.error=a.error;this.caption=a.caption;if(!this.container){throw new Error("container参数不能为空");}if(!this.success){throw new Error("上传成功的回调函数不能为空");}this.fileCount=0;
this.fileSize=0;this.percentages={};this.state="pedding";this.uploader=null;this.isImage=true;this.auto=a.auto?a.auto:false;}JTWebUploader._CONS_={UPLOADER_URL:ctx+"/crm/components/upload/ajax.htm?categoryDir=temp",THUMBNAIL_WIDTH:(window.devicePixelRatio||1)*110,THUMBNAIL_HEIGHT:(window.devicePixelRatio||1)*110,};
JTWebUploader.prototype={_createDefaultHtml:function(){return"<div class='queueList'>"+"<div id='dndArea' class='placeholder'>"+"<div id='filePicker' class='filePicker'></div>"+"<p>"+this.caption+"</p>"+"</div>"+"<ul class='filelist'></ul>"+"</div>"+"<div class='statusBar' style='display:none;'>"+"<span class='text'></span>"+"<span class='percentage'></span>"+"<div class='info'></div>"+"<div class='btns'>"+"<div class='uploadBtn'>开始上传</div>"+"</div>"+"</div>";
},init:function(){if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.");
}$(document.body).off("paste");$("#"+this.container).empty().html(this._createDefaultHtml());this.uploader=WebUploader.create({pick:{id:".filePicker",label:"点击选择文件"},dnd:"#"+this.container+" .queueList",paste:document.body,accept:{title:"选择文件",extensions:this.config.acceptTypes,mimeTypes:this.config.mimeTypes||""},swf:ctx+"/js/plugins/webuploader/Uploader.swf",disableGlobalDnd:false,chunked:true,server:this.config.uploadUrl?this.config.uploadUrl:JTWebUploader._CONS_.UPLOADER_URL,fileNumLimit:this.config.fileNumLimit,fileSingleSizeLimit:this.config.fileSingleSizeLimit,auto:this.auto});
this._bindWebUploaderHandler();this._bindEventHandler();},_bindEventHandler:function(){var a=this;$("#"+this.container).on("click",".retry",function(){a.uploader.retry();
});$("#"+this.container).on("click",".ignore",function(){if(a.finish){a.finish();}});$("#"+this.container).find(".uploadBtn").on("click",function(){if($(this).hasClass("disabled")){return false;
}if(a.state==="ready"){a.uploader.upload();}else{if(a.state==="paused"){a.uploader.upload();}else{if(a.state==="uploading"){a.uploader.stop();}}}});},_bindWebUploaderHandler:function(){var a=this;
this.uploader.onUploadProgress=function(d,b){var e=$("#"+d.id),c=e.find(".progress span");c.css("width",b*100+"%");a.percentages[d.id][1]=b;a.updateTotalProgress();
};this.uploader.onFileQueued=function(b){a.fileCount++;a.fileSize+=b.size;if(a.fileCount===1){$("#"+this.container).find(".placeholder").addClass("element-invisible");
$(".statusBar").show();}a.addFile(b);a.setState("ready");a.updateTotalProgress();};this.uploader.onFileDequeued=function(b){a.fileCount--;a.fileSize-=b.size;
if(!a.fileCount){a.setState("pedding");}a.removeFile(b);a.updateTotalProgress();};this.uploader.onUploadSuccess=function(c,b){a.success(c,b);};this.uploader.onUploadError=function(b,c){if(a.error){a.error(b,c);
}};this.uploader.on("all",function(b){switch(b){case"uploadFinished":a.setState("confirm");break;case"startUpload":a.setState("uploading");break;case"stopUpload":a.setState("paused");
break;}});this.uploader.onError=function(b){if(b=="Q_EXCEED_NUM_LIMIT"){DialogUtils.error(msgCode.ERROR,"超出上传文件数量");}else{if(b=="Q_EXCEED_SIZE_LIMIT"){DialogUtils.error(msgCode.ERROR,"超出上传文件总大小");
}else{if(b=="Q_TYPE_DENIED"){DialogUtils.error(msgCode.ERROR,"不支持该文件格式");}else{if(b=="F_EXCEED_SIZE"){DialogUtils.error(msgCode.ERROR,"单个文件大小不能超过："+a.config.fileSingleSizeLimit/(1024*1024)+"mb");
}}}}};},_showError:function(c,b){var d="";switch(c){case"exceed_size":d="文件大小超出";break;case"interrupt":d="上传暂停";break;default:d="上传失败，请重试";}var a="<p class='error'>"+d+"</p>";
$("#"+b.id).append(a);},addFile:function(e){var c=this;var f=$('<li id="'+e.id+'">'+'<p class="title">'+e.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+'<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span>'+"</div>"+"</li>");
var b=f.find("p.progress span");var a=f.find("p.imgWrap");var d=$('<p class="error"></p>');if(e.getStatus()==="invalid"){this._showError(e.statusText,e);
}else{a.text("预览中");c.uploader.makeThumb(e,function(h,i){if(h){var g=$('<img style="width:50%" src="'+ImageUtils.getFileCoverUrl(e.name)+'">');a.empty().append(g);
c.isImage=false;}else{var g=$('<img src="'+i+'">');a.empty().append(g);}},JTWebUploader._CONS_.THUMBNAIL_WIDTH,JTWebUploader._CONS_.THUMBNAIL_HEIGHT);c.percentages[e.id]=[e.size,0];
e.rotation=0;}e.on("statuschange",function(h,g){if(g==="progress"){b.hide().width(0);}else{if(g==="queued"){f.off("mouseenter mouseleave");f.find(".file-panel").remove();
}}if(h==="error"||h==="invalid"){c._showError(e.statusText,this);c.percentages[e.id][1]=1;}else{if(h==="interrupt"){c._showError("interrupt",this);}else{if(h==="queued"){c.percentages[e.id][1]=0;
}else{if(h==="progress"){d.remove();b.css("display","block");}else{if(h==="complete"){f.append('<span class="success"></span>');}}}}}f.removeClass("state-"+g).addClass("state-"+h);
});f.on("mouseenter",function(){f.find(".file-panel").stop().animate({height:30});});f.on("mouseleave",function(){f.find(".file-panel").stop().animate({height:0});
});f.on("click","span",function(){var g=$(this).index();var h=null;switch(g){case 0:c.uploader.removeFile(e);return;case 1:e.rotation+=90;break;case 2:e.rotation-=90;
break;}var i=(function(){var j=document.createElement("p").style,k="transition" in j||"WebkitTransition" in j||"MozTransition" in j||"msTransition" in j||"OTransition" in j;
j=null;return k;})();if(i){h="rotate("+e.rotation+"deg)";a.css({"-webkit-transform":h,"-mos-transform":h,"-o-transform":h,"transform":h});}else{a.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((e.rotation/90)%4+4)%4)+")");
}});f.appendTo($(".filelist"));},removeFile:function(a){var b=$("#"+a.id);delete this.percentages[a.id];this.updateTotalProgress();b.off().find(".file-panel").off().end().remove();
},updateTotalProgress:function(){var a=0;var d=0;var b=$("#"+this.container).find(".progress").children();var c=null;$.each(this.percentages,function(f,e){d+=e[0];
a+=e[0]*e[1];});c=d?a/d:0;b.eq(0).text(Math.round(c*100)+"%");b.eq(1).css("width",Math.round(c*100)+"%");this.updateStatus();},updateStatus:function(){var d="",b,c,a;
if(this.isImage){c="张";a="图片";}else{c="个";a="文件";}if(this.state==="ready"){d="选中"+this.fileCount+c+a+"，共"+WebUploader.formatSize(this.fileSize)+"。";}else{if(this.state==="confirm"){b=this.uploader.getStats();
if(b.uploadFailNum){d="已成功上传"+b.successNum+c+a+"至XX，"+b.uploadFailNum+c+a+'上传失败，<a class="retry" href="#">重新上传</a>失败'+c+'或<a class="ignore" href="#">忽略</a>';
}}else{b=this.uploader.getStats();d="共"+this.fileCount+c+a+"（"+WebUploader.formatSize(this.fileSize)+"），已上传"+b.successNum+c;if(b.uploadFailNum){d+="，失败"+b.uploadFailNum+c;
}}}$("#"+this.container).find(".statusBar .info").html(d);},setState:function(b){if(b===this.state){return;}$("#"+this.container).find(".uploadBtn").removeClass("state-"+this.state);
$("#"+this.container).find(".uploadBtn").addClass("state-"+b);this.state=b;switch(this.state){case"pedding":$("#"+this.container).find(".placeholder").removeClass("element-invisible");
$(".filelist").parent().removeClass("filled");$(".filelist").hide();$(".statusBar").addClass("element-invisible");this.uploader.refresh();break;case"ready":$("#"+this.container).find(".placeholder").addClass("element-invisible");
$(".filelist").parent().addClass("filled");$(".filelist").show();$(".statusBar").removeClass("element-invisible");this.uploader.refresh();break;case"uploading":$("#"+this.container).find(".progress").show();
$("#"+this.container).find(".uploadBtn").text("暂停上传");break;case"paused":$("#"+this.container).find(".progress").show();$("#"+this.container).find(".uploadBtn").text("继续上传");
break;case"confirm":$("#"+this.container).find(".progress").hide();$("#"+this.container).find(".uploadBtn").text("开始上传").addClass("disabled");var a=this.uploader.getStats();
if(a.successNum&&!a.uploadFailNum){this.setState("finish");return;}break;case"finish":var a=this.uploader.getStats();$("#"+this.container).find(".uploadBtn").text("开始上传").addClass("disabled");
if(a.successNum){if(this.finish){this.finish();}}else{this.state="done";}break;}this.updateStatus();}};$(function(){var a=new CsEntityEdit();a.init(csId);
});function CsEntityEdit(){this.csFollow=new CsFollow();this.financeMeeting=new CsFinanceMeeting();this.financeContract=new CsFinanceContract();this.financeTurnover=new CsFinanceTurnover();
this.csCashHi=new CsCashHi();this.statisticInfo=new StatisticInfo();this.csContract=new CsContract();this.csAccount=new CsAccount();this.csLevelChange=new CsLevelChange();
this.csCallRecord=new CsCallRecord();this.csMailHistory=new CsMailHistory();this.csPhone=new CsPhone();this.csEav=new CsEav();this.oppoList=new OppoEntityList();
this.csComplainAdd=new CsComplainAdd();this.csAddr=new CsAddr();this.sendMessage=new SendMessage();this.csEmployee=new CsEmployee(this);this.csOrder=new CsOrder();
this.pointLog=new PointLog();this.csLimit=new CsLimit();this.weiXinChatForm=new WeiXinChatForm();this.csRfmtModel=new CsRfmtModel();this.formFrontConfig=new FormConfig({"formId":"csEntityForm","endLess":["姓名","客户编号","归属工号","备注"],modular:"csEntity"});
this.isDetail=false;this.addPhone=true;this.changeAddr=true;this.changeName=true;this.changeSrcs=true;this.changeInterests=true;this.eavInit=false;this.complainInit=false;
this.levelChangeInit=false;this.emailInit=false;this.csOrderInit=false;this.callRecordInit=false;this.smsRecordInit=false;this.csLimitInit=false;this.financeMeetingInit=false;
this.financeTurnoverInit=false;this.financeContractInit=false;this.csCashHiInit=false;this.isEdit=false;if(!isNewPage){this.recommendInit=false;this.pointLogInit=false;
}this.canViewPhone=false;this.data="";}CsEntityEdit._CONS_={EDIT_URL:ctx+"/crm/cs/csEntity/edit.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csEntity/saveEdit.htm",CUSTOMER_EAV_KEY:"customer",ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",POINT_ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place/pointOrder.htm",ORDER_AFTER_LIST_URL:ctx+"/ec/salesorder/soEntity/saleafter/list.htm",EDIT_INFO_URL:ctx+"/crm/cs/csEntity/addr/partyAddrListData.htm",DEL_ADDR_URL:ctx+"/crm/cs/csEntity/deleteAddr.htm",COMBINE_CS_URL:ctx+"/crm/cs/csEntity/combineCs.htm",SEND_MAIL:ctx+"/gl/mail/mailQueue/sendMail.htm",DESCRYPT_WEIXIN:ctx+"/crm/cs/csEntity/decryptWeixin.htm",DESCRYPT_EMAIL:ctx+"/crm/cs/csEntity/decryptEmail.htm",GET_BY_CSCODE_URL:ctx+"/gl/cs/weiXinFriends/getByCsCode.htm",GET_BY_ANDROID_CSCODE_URL:ctx+"/crm/android/getByFriendCode.htm",FORM_ID:"#csEntityForm",LOAD_RECOMMEND:ctx+"/crm/cs/csEntity/loadRecommend.htm",LOAD_THREEDAYS_ORDER:ctx+"/ec/salesorder/soEntity/loadThreeDaysOrder.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByEmployee.htm",ADD_BY_PHONE_URL:ctx+"/crm/android/addByPhone.htm",FIND_THREE_DAYS_ORDER_URL:ctx+"/ec/salesorder/soEntity/findByCsIdAndTime.htm",NEED_RETURN_VISIT:ctx+"/crm/cs/csEntity/needReturnVisit.htm",FINISH_VISIT:ctx+"/crm/cs/csEntity/finishVisit.htm",};
CsEntityEdit.prototype={init:function(b){var a=this;this._bindFormValidation();this._bindEventHander();CsEntityUtils.init();this.loadData(b);this.csEmployee.init();
callRecordOperate.init();this.sendMessage.init();this.csEav.init();this.csAddr.init();this.csPhone.init();this._initSystemTag(b);this._prodSearch();CateUtils.getOptions({typeKey:"system",pKey:"degree",container:"degree"});
if(isUseRfmt&&isUseRfmt=="true"){this.csRfmtModel.init();this.csRfmtModel.getCsRfmtModel(csId);}},_initSystemTag:function(a){params={module:systemTagUtil._CONS_.CS_MODULE,type:systemTagUtil._CONS_.CS_TYPE,entityId:a,container:"systemTagSelect",selectType:"multiple"};
systemTagUtil.init(params);},_prodSearch:function(h){$("#searchProd").bsSuggest("destroy");var i=this;var b="entity";var g="n";var c="n";var f="prodEntity-csEntity";
var d=window.sessionStorage.getItem(f);if(d){var e=JSON.parse(d);i._prodSearchSuggest(e);}else{var a=ctx+"/ec/product/prodEntity/search.htm?prodType="+b+"&hasStock="+g+"&storeId="+"&limitProdCate="+c+"&keyword=";
FormUtils.loadData(a,function(j){window.sessionStorage.setItem(f,JSON.stringify(j));i._prodSearchSuggest(j);});}},_prodSearchSuggest:function(c){var a=this;
a.searchProds=c.value;var b=$("#searchProd").width()+"px";$("#searchProd").bsSuggest({effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,data:c,getDataMethod:"data",processData:function(d){return d;
},listStyle:{"padding-top":0,"max-height":"500px","max-width":b,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(f,d){a.searchProds=d.value;
}).on("onSetSelectValue",function(g,d){for(var f=0;f<a.searchProds.length;f++){if(a.searchProds[f].skuId==d.id){a.currentProd=a.searchProds[f];break;}}$("#searchProd").val(a.currentProd.prodName);
}).on("onUnsetSelectValue",function(d){a.currentProd={};});},_hideNotGrantedBtn:function(b,a){if(!ResUtils.canShow("csEntity.questionnaire.button")){$(".questionNaire").hide();
}if("isReturnVisit"==type||"hasVisit"==type){$(".noVisit").hide();$(".addAddr").hide();$(".jt-form-group").find("input").attr("disabled","disabled");$(".jt-form-group").find("select").attr("disabled","disabled");
$(".radio").attr("disabled","disabled");$(".chooseRecommend").attr("disabled","disabled");$(".viewEmail").attr("disabled","disabled");$(".force-align-btn").hide();
$(".viewWeixin").attr("disabled","disabled");$(".showEmployeeWeixin").hide();$(".jt-form-group").find("textarea[name=desc]").attr("disabled","disabled");
}if(!ResUtils.canShow("csEntity.button.returnVisit")){$(".isReturnVisit").hide();}if("isReturnVisit"==type&&ResUtils.canShow("csEntity.button.finishVisit")){$(".finishVisit").show();
}if("self"==type||(b&&"self"==b)){if(!ResUtils.canShow("csEntity.button.increateYouZanPoint")){$(".increateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.giveCash")){$(".giveCashBtn").remove();
}if(!ResUtils.canShow("csEntity.button.viewWeixin")){$(".viewWeixin").remove();$(".maskWeixin").attr("readonly",true);}if(!ResUtils.canShow("csEntity.button.combine")){$(".combineCs").hide();
}if(!ResUtils.canShow("csEntity.button.createSubCsEntity")){$(".createSubCsEntity").hide();}if(!ResUtils.canShow("csEntity.button.saveEdit")){$(".saveBtn").hide();
}if(!ResUtils.canShow("csEntity.button.soAdd")){$(".placeOrder").hide();}if(!ResUtils.canShow("csEntity.button.soPointAdd")){$(".placePointOrder").parents("li").hide();
}if(!ResUtils.canShow("csEntity.button.changeEmployeeForEdit")){$(".changRelEmployee").hide();}if(!ResUtils.canShow("csEntity.button.sendMail")){$(".sendEmail").hide();
}if(!ResUtils.canShow("csEntity.button.batchCall")){$(".csEntityBatchCall").hide();}if(!ResUtils.canShow("csEntity.button.saleAfter")){$(".soAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.addPhone")){this.addPhone=false;}if(!ResUtils.canShow("csEntity.button.changeAddr")){this.changeAddr=false;}if(!ResUtils.canShow("csEntity.button.changeName")){this.changeName=false;
}if(!ResUtils.canShow("csEntity.button.changeSrcs")){$("select[name=srcs]").attr("disabled",true);}if(!ResUtils.canShow("csEntity.button.viewEmail")){$(".viewEmail").hide();
}if(!ResUtils.canShow("csEntity.button.changeInterests")){$("select[name=interests]").attr("disabled",true);}if(!ResUtils.canShow("csEntity.button.changeEmployeeWeixin")){$("select[name=employeeWeixin]").attr("disabled",true);
$("input[name=passTime]").attr("disabled",true);}if(!ResUtils.canShow("csEntity.button.csDesc")){$("textarea[name=desc]").attr("disabled",true);}else{$("textarea[name=desc]").attr("disabled",false);
}}else{if("mysub"==type||(b&&"mysub"==b)){if(!ResUtils.canShow("csEntity.button.increateYouZanPointSub")){$(".increateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.giveCashSub")){$(".giveCashBtn").remove();
}if(!ResUtils.canShow("csEntity.button.viewWeixinSub")){$(".viewWeixin").remove();}if(!ResUtils.canShow("csEntity.button.saveEditSub")){$(".saveBtn").hide();
}if(!ResUtils.canShow("csEntity.button.combineSub")){$(".combineCs").hide();}if(!ResUtils.canShow("csEntity.button.createSubCsEntitySub")){$(".createSubCsEntity").hide();
}if(!ResUtils.canShow("csEntity.button.soAddSub")){$(".placeOrder").hide();}if(!ResUtils.canShow("csEntity.button.soPointAddSub")){$(".placePointOrder").parents("li").hide();
}if(!ResUtils.canShow("csEntity.button.changeEmployeeForEditSub")){$(".changRelEmployee").hide();}if(!ResUtils.canShow("csEntity.button.sendMailSub")){$(".sendEmail").hide();
}if(!ResUtils.canShow("csEntity.button.viewEmailSub")){$(".viewEmail").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSub")){$(".soAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.addPhoneSub")){this.addPhone=false;}if(!ResUtils.canShow("csEntity.button.changeAddrSub")){this.changeAddr=false;
}if(!ResUtils.canShow("csEntity.button.changeNameSub")){this.changeName=false;}if(!ResUtils.canShow("csEntity.button.changeSrcsSub")){$("select[name=srcs]").attr("disabled",true);
}if(!ResUtils.canShow("csEntity.button.changeInterestsSub")){$("select[name=interests]").attr("disabled",true);}if(!ResUtils.canShow("csEntity.button.changeEmployeeWeixinSub")){$("select[name=employeeWeixin]").attr("disabled",true);
$("input[name=passTime]").attr("disabled",true);}if(!ResUtils.canShow("csEntity.button.viewFollowSub")){$(".followRecordLi").remove();$("#followRecordTab").remove();
}if(!ResUtils.canShow("csEntity.button.viewOrderSub")){$(".csOrderLi").remove();$("#orderTab").remove();}if(!ResUtils.canShow("csEntity.button.viewCallRecordSub")){$(".csllRecordLi").remove();
$("#callRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewSmsRecordSub")){$(".smsRecordLi").remove();$("#messageRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.addWxByPhoneSub")){$(".addWeixinFriend").hide();
}if(!ResUtils.canShow("csEntity.button.batchCallSub")){$(".csEntityBatchCall").hide();}$(".downDiv").find("li:eq(0)").addClass("active");$(".downDiv").find(".tab-pane").first().addClass("active").addClass("in").show();
$(".downDiv").find("li:eq(0)").trigger("click");if(!ResUtils.canShow("csEntity.button.csDescSub")){$("textarea[name=desc]").attr("disabled",true);}else{$("textarea[name=desc]").attr("disabled",false);
}}else{if("task"==type){$(".placePointOrder").parents("li").hide();$(".changRelEmployee").hide();$(".sendEmail").hide();$(".viewWeixin").remove();this.addPhone=false;
if(!ResUtils.canShow("csEntity.button.saveEdit")&&!ResUtils.canShow("csEntity.button.saveEditSub")){$(".saveBtn").hide();}if(!ResUtils.canShow("csEntity.button.placeOrderTask")){$(".placeOrder").hide();
}else{$(".placeOrder").show();}if(!ResUtils.canShow("csEntity.button.combineTask")){$(".combineCs").hide();$(".moreBtn").hide();}if(!ResUtils.canShow("csEntity.button.createSubCsEntityTask")){$(".createSubCsEntity").hide();
}if(!ResUtils.canShow("csEntity.button.changeAddrTask")){this.changeAddr=false;}if(!ResUtils.canShow("csEntity.button.viewFollowTask")){$(".followRecordLi").remove();
$("#followRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewOrderTask")){$(".csOrderLi").remove();$("#orderTab").remove();}if(!ResUtils.canShow("csEntity.button.viewCallRecordTask")){$(".csllRecordLi").remove();
$("#callRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewSmsRecordTask")){$(".smsRecordLi").remove();$("#messageRecordTab").remove();}$(".downDiv").find("li:eq(0)").addClass("active");
$(".downDiv").find(".tab-pane").first().addClass("active").addClass("in").show();$(".downDiv").find("li:eq(0)").trigger("click");}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.saveEdit")&&!ResUtils.canShow("csEntity.button.saveEditSub")){$(".saveBtn").hide();
}$(".placePointOrder").parents("li").hide();$(".changRelEmployee").hide();$(".sendEmail").hide();$(".soAfterList").hide();$(".viewWeixin").remove();$(".viewEmail").remove();
this.addPhone=false;if(!ResUtils.canShow("csEntity.button.placeOrderCallRecord")){$(".placeOrder").hide();}else{$(".placeOrder").show();}if(!ResUtils.canShow("csEntity.button.combineCallRecord")){$(".combineCs").hide();
$(".moreBtn").hide();}if(!ResUtils.canShow("csEntity.button.createSubCsEntityRecord")){$(".createSubCsEntity").hide();}if(!ResUtils.canShow("csEntity.button.changeAddrCallRecord")){this.changeAddr=false;
}if(!ResUtils.canShow("csEntity.button.viewFollowCallRecord")){$(".followRecordLi").remove();$("#followRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewOrderCallRecord")){$(".csOrderLi").remove();
$("#orderTab").remove();}if(!ResUtils.canShow("csEntity.button.viewCallRecordCallRecord")){$(".csllRecordLi").remove();$("#callRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewSmsRecordCallRecord")){$(".smsRecordLi").remove();
$("#messageRecordTab").remove();}$(".downDiv").find("li:eq(0)").addClass("active");$(".downDiv").find(".tab-pane").first().addClass("active").addClass("in").show();
$(".downDiv").find("li:eq(0)").trigger("click");}else{$(".placePointOrder").parents("li").hide();$(".changRelEmployee").hide();$(".sendEmail").hide();$(".viewWeixin").remove();
$(".viewEmail").remove();this.addPhone=false;if(!ResUtils.canShow("csEntity.button.saveEdit")&&!ResUtils.canShow("csEntity.button.saveEditSub")){$(".saveBtn").hide();
}if(!ResUtils.canShow("csEntity.button.placeOrderSearch")){$(".placeOrder").hide();}else{$(".placeOrder").show();}if(!ResUtils.canShow("csEntity.button.combineSearch")){$(".combineCs").hide();
$(".moreBtn").hide();}if(!ResUtils.canShow("csEntity.button.createSubCsEntitySearch")){$(".createSubCsEntity").hide();}if(!ResUtils.canShow("csEntity.button.changeAddrSearch")){this.changeAddr=false;
}if(!ResUtils.canShow("csEntity.button.viewFollowSearch")){$(".followRecordLi").remove();$("#followRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewOrderSearch")){$(".csOrderLi").remove();
$("#orderTab").remove();}if(!ResUtils.canShow("csEntity.button.viewCallRecordSearch")){$(".csllRecordLi").remove();$("#callRecordTab").remove();}if(!ResUtils.canShow("csEntity.button.viewSmsRecordSearch")){$(".smsRecordLi").remove();
$("#messageRecordTab").remove();}this.canViewPhone=false;$(".downDiv").find("li:eq(0)").addClass("active");$(".downDiv").find(".tab-pane").first().addClass("active").addClass("in").show();
$(".downDiv").find("li:eq(0)").trigger("click");if(a.isDelete=="1"){$(".saveBtn").hide();$(".placeOrder").hide();}}}}}if(ResUtils.canShow("csEntity.button.csListShowSrc")){$(".csDetailSrcDiv").show();
}if("y"==a.isSub){$(".createSubCsEntity").hide();}},_bindEventHander:function(){var a=this;$(document).on("click",".add-cs-tags",function(){$(this).closest(".jt-params-tag").find(".plusBtn").trigger("click");
});$(document).on("click",".questionNaire",function(){var c=$("#csEntityForm").find("input[name=id]").val();var b=$("#csEntityForm").find("input[name=name]").val();
JTTabUtils.addOrRefreshTab(ctx+"/cs/questionnaire/questionnaireResult/toCsQustionnaire.htm?csId="+c,"问卷["+b+"]");});$("body").on("click",".toLinkMainCs",function(){var b=$(this).attr("mainCsId");
var c=$(this).attr("mainCsCode");if(!c){DialogUtils.error(msgCode.ERROR,"客户不存在,可能已被删除,请通过查询进入");return;}var d="客户["+c+"]";JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type=search&csId="+b,d);
});$("body").on("click",".soTab",function(){var h=$(this).attr("attr-count");if(h==1){var g=$(this).attr("attr-id");var i=$("#csEntityForm").find("[name=name]").val();
var f=$(this).attr("value");var e=$(this).attr("attr-placerId");var b=$(this).attr("attr-status");var d=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";
if("awaiting_post"==b&&e==currentUserId){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.PLACE_PAGE_URL+"?soId="+g,"订单["+f+"]提交");}else{if("awaiting_comfirm"==b&&ResUtils.canShow("soEntityComfirm.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)&&ResUtils.canShow("soEntity.button.comfirm")){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.COMFIRM_PAGE_URL+"?soId="+g,"订单["+f+"审核");
}else{if("shipping"==b&&ResUtils.canShow("soEntity.url")&&a.permissionType&&("self"==a.permissionType||"mysub"==a.permissionType)){JTTabUtils.addOrRefreshTab(CsOrder._CONS_.FOLLOW_PAGE+"?soId="+g+"&soNo="+f,"订单["+f+"]跟进");
}else{JTTabUtils.addOrRefreshTab(CsOrder._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+f+"&canShowScTrankNo="+d,i+"的订单明细");}}}}else{var c=$(this).attr("attr-csId");
if(c){layer.open({type:1,title:"3天内订单列表",btn:"关闭",maxmin:false,shadeClose:true,area:["60%","40%"],content:'<div class="col-sm-12 jqGrid_wrapper"><table id="threeDayOrderTab" class="table"></table></div>',success:function(j,k){a._loadOrderList(c);
}});}}});$("body").on("click",".mySoTab",function(){var c=$(this).attr("value");var d=$(this).attr("csNameVal");var b=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";
if(c&&c!=""){JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/detail.htm?soNo="+c+"&canShowScTrankNo="+b,d+"的订单明细");}});$(document).on("click",".increateYouZanPoint",function(c){var b=$("#csEntityForm").find("[name=id]").val();
FormUtils.loadData(ctx+"/crm/cs/csEntity/increateYouzanPoint.htm?ids="+b,function(d){});});$(document).on("click",".giveCashBtn",function(c){var d=$("#csEntityForm").find("[name=id]").val();
$("#giveCashModalContainer").modal("show");$(".cashPicture").hide();CashSettingUtils.getOptions({container:"cashSearch",caption:"请选择"});var b=new UploadImageUtil();
b.getOptions("cashPictureSearch");});$(document).on("change",".cashSearch",function(c){var b=$(".cashSearch").val();if(b){FormUtils.loadData(ctx+"/gl/cash/cashSetting/edit.htm?id="+b,function(d){$("input[name=cashMoney]").val(d.money);
$(".cashInfo").text("面值：￥"+d.money+"    剩余可赠送数量："+d.giveCount);if(d.cashHiPos&&d.cashHiPos.length>0){$("input[name=cashCode]").val(d.cashHiPos[0].code);
$("input[name=cashHiId]").val(d.cashHiPos[0].id);}});}else{$(".cashInfo").text("");$("input[name=cashMoney]").val("");$("input[name=cashCode]").val("");
$("input[name=cashHiId]").val("");}});$(document).on("change",".cashPictureSearch",function(b){if($(this).val()){$(".cashPicture").show();$(".cashPicture").attr("src",ctx+$(this).val());
}else{$(".cashPicture").hide();$(".cashPicture").attr("src","");}});$(document).on("click","#cashBindCs",function(f){var c=$("input[name=id]").val();var d=$("input[name=cashHiId]").val();
var b=$(".cashPictureSearch").val();if(d&&b){FormUtils.submit(ctx+"/gl/cash/cashHi/bindCs.htm","csId="+c+"&cashHiId="+d,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);
}else{DialogUtils.error(msgCode.ERROR,e.msg);}});FormUtils.loadData(ctx+"/gl/image/image/imageAddWord.htm?path="+b+"&cashCode="+$("input[name=cashCode]").val()+"&cashMoney="+$("input[name=cashMoney]").val(),function(e){$(".cashPicture").attr("src",ctx+e.msg);
});}else{DialogUtils.error(msgCode.ERROR,"没有可选择的现金券或者底图");}});$(document).on("click",".jt-lager-img",function(c){var b=[];$(this).parent().parent().find("img").each(function(d,f){b.push({title:"大图",href:$(this).attr("src")});
});$.fancybox(b);});$(".fastLoginBtn").on("click",function(){var b=ctx+"/crm/cs/csEntity/fastLoginBtn.htm";FormUtils.submit(b,function(c){if(c.success){JTTabUtils.addOrRefreshTab(c.msg,"傲融系统");
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});});$("#seniorSearch").on("click",function(){if($(this).text().indexOf("展开更多")!=-1){$("#seniorSearchDiv").slideDown("fast",function(){});
$(this).empty().append('收起更多<span class="fa fa-sort-up"></span>');$(".hideSearchParam").stop().slideDown();$(".mutipleSelectEavAttr").chosen("destroy").chosen();
}else{$(this).empty().append('展开更多<span class="fa fa-sort-down"></span>');$("#seniorSearchDiv").slideUp("fast");$(".hideSearchParam").stop().slideUp();
}});$(document).on("click",".saveBtn",function(){a._saveEdit(function(){});});$(document).on("click",".viewWeixin",function(){var b=$("input[name='weixin']").val();
var c=$("#id").val();a._descryptWeixin(b,"viewWeixin",c,function(d){$("input[name='maskWeixin'").val(d);});});$(document).on("click",".viewEmail",function(){var b=$("input[name='email']").val();
var c=$("#id").val();a._descryptEmail(b,"viewEmail",c,function(d){$("input[name='maskEmail'").val(d);});});$(document).on("click",".maskEmail",function(){if($(".maskEmail").val().indexOf("*")>0){$(this).val("");
}});$(document).on("focus",".maskWeixin",function(){if($(".maskWeixin").val().indexOf("*")>0&&!$(this).attr("readonly")==true){$(this).val("");}});$(document).on("click",".preCs",function(){var b=$("#preId").val();
if(b==""||b=="null"){DialogUtils.error("提示","点击过快！！！！");return false;}if(a.isEdit){a._saveEdit(function(){if(b){window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+b;
}});}else{window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+b;}});$(document).on("click",".nextCs",function(){var b=$("#nextId").val();
if(b==""||b=="null"){DialogUtils.error("提示","点击过快！！！！");return false;}if(a.isEdit){a._saveEdit(function(){if(b){window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+b;
}});}else{window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+b;}});$(document).on("click",".placeOrder",function(){var b=$(this);
ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placeGeneralOrderMethod(b,a);return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placeGeneralOrderMethod(b,a);
return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var f=DateUtils.timeRangeJudge(c,d);if(!f){a._placeGeneralOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});
});$(document).on("click",".sendEmail",function(){JTTabUtils.addOrRefreshTab(CsEntityEdit._CONS_.SEND_MAIL+"?customerId="+$("#csEntityForm").find("[name=id]").val(),"发送邮件");
});$(document).on("click",".placePointOrder",function(){var b=$(this);ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placePointsOrderMethod(b,a);
return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placePointsOrderMethod(b,a);return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var f=DateUtils.timeRangeJudge(c,d);
if(!f){a._placePointsOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});});$("body").on("click",".weixinChatBtn",function(){if(weixinUseType=="android"){a._initANdroidchat();
}else{a._initWebchat();}});$("[name=maskEmail]").on("change",function(){var b=$(this).val();$("[name=email]").val(b);});$("[name=maskWeixin]").on("change",function(){var b=$(this).val();
$("[name=weixin]").val(b);});$(document).on("click",".createSubCsEntity",function(){var e=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();var b=$(CsEntityEdit._CONS_.FORM_ID).find("[name=isSub]").val();
var d={csId:e,};var c=new CreateForSub();c.init(d);});$(document).on("click",".combineCs",function(){$("#radio1").trigger("click");$("#chooseCsValue").val(1);
$("#customer2Id").val("");$("#customer2Info").val("");a.layerIndex=layer.open({type:1,title:"合并客户资料",shadeClose:false,btn:["提交合并","关闭"],area:["650px","500px"],scrollbar:false,content:$(".combineCsDiv"),yes:function(d,b){var c="";
var e="";var f=$("#chooseCsValue").val();if("1"==f){c=$("[name=id]").val();e=$("#customer2Id").val();}else{c=$("#customer2Id").val();e=$("[name=id]").val();
}if(c&&e){a.combineCs(c,e);}else{DialogUtils.error("失败","请先选择客户2的资料再进行合并");}}});});$(document).on("click","[name=chooseCs]",function(){$("#chooseCsValue").val($(this).val());
});$("ul.dropdown-menu").on("click","li",function(){$(this).parents(".dropdown").children("a").eq(0).empty().append($(this).text()+'<b class="caret"></b>');
});$(document).on("click",".chooseCsForCombine",function(){var c={selectedMulti:false,callBack:function(d){if(d!=null){$("#customer2Id").val(d[0].id);$("#customer2Info").val(d[0].code+"("+d[0].name+")");
}},type:"search"};var b=new CustomerSelect();b.init(c);});$(document).on("click",".soAfterList",function(){var b=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();
var c=$(CsEntityEdit._CONS_.FORM_ID).find("[name=name]").val();JTTabUtils.addOrRefreshTab(CsEntityEdit._CONS_.ORDER_AFTER_LIST_URL+"?csId="+b,"客户["+c+"]退换货订单");
});$(document).on("click",".tabLi",function(){var b=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();var e=$(CsEntityEdit._CONS_.FORM_ID).find("[name=employeeId]").val();
var d=$(CsEntityEdit._CONS_.FORM_ID).find("[id=permissionType]").val();var c=$(this).attr("attr-id");if("statistic"==c){a._fillOtherStatisticalInfo();a.statisticInfo.init(b);
$("#csInfoRfmtLi").trigger("click");}else{if("complain"==c&&!a.complainInit){a.complainInit=true;a._fillComplain(b,e,d);}else{if("levelChange"==c&&!a.levelChange){a.levelChange=true;
a._fillLevelChange(b);if(isNewPage){a._fillPointLogTab(b);}}else{if("email"==c&&!a.emailInit){a.emailInit=true;a._fillMailHistoryTab(b);}else{if("csOrder"==c&&!a.csOrderInit){a.csOrderInit=true;
a._fillOrderInfo(b,e,d);}else{if("callRecord"==c&&!a.callRecordInit){a.callRecordInit=true;a._initCallRecord(b,e,d);}else{if("smsRecord"==c&&!a.smsRecordInit){a.smsRecordInit=true;
a._fillSmsRecordTab(b);}else{if("csMeeting"==c&&!a.financeMeetingInit){a.financeMeetingInit=true;a._fillFinanceMeeting(b);}else{if("csContract"==c&&!a.financeContractInit){a.financeContractInit=true;
a._fillFinanceContract(b);}else{if("csTurnover"==c&&!a.financeTurnoverInit){a.financeTurnoverInit=true;a._fillFinanceTurnover(b);}else{if("csCashHi"==c&&!a.csCashHiInit){a.csCashHiInit=true;
a._csCashHi(b);}else{if("limit"==c&&!a.csLimitInit){a.csLimitInit=true;a._fillCsLimitTab(b);}else{if("csInfoOrderLi"==c){a.statisticInfo.init();}}}}}}}}}}}}}if(!isNewPage){if("point"==c&&!a.pointLogInit){a.pointLogInit=true;
a._fillPointLogTab(b);}}});$(document).on("click",".bindWx",function(){a.layerIndex=layer.open({type:1,title:"绑定微信",shadeClose:false,btn:["绑定","关闭"],area:["600px","450px"],scrollbar:false,content:$(".bindWxPanel"),success:function(b,d){var c=ctx+"/gl/cs/weiXinFriends/findByNickName.htm";
FormUtils.loadData(c+"?nickName="+$(CsEntityEdit._CONS_.FORM_ID+" input[name='name']").val(),function(e){var g=new StringBuffer();for(var f=0;f<e.length;
f++){g.append("<tr>").append("<td>").append("<input type='checkbox' class='bindWxCheckbox' user-name='"+e[f].userName+"'>").append("</td>").append("<td>").append(e[f].nickName).append("</td>").append("<td>").append(e[f].employeeNickName).append("</td>").append("<td>").append(e[f].lastReplyContent).append("</tr>");
}$("#wait-bind-friends").empty().append(g.toString());});},yes:function(d,c){var b=$(".bindWxCheckbox:checked");if(b.length>0){var e=$(b[0]).attr("user-name");
var f=$(CsEntityEdit._CONS_.FORM_ID+" input[name='csCode']").val();a._bindWx(e,f,d);}else{DialogUtils.error(msgCode.ERROR,"请选择微信好友");}}});});$(document).on("click",".bindWxCheckbox",function(){if(this.checked){var b=$(".bindWxCheckbox");
for(var c=0;c<b.length;c++){b[c].checked=false;}this.checked=true;}});$(document).on("click",".claimCsSea",function(){DialogUtils.confirmWithOptions({title:"确认要领取的客户吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._claimCsSea($("#id").val());
}});});$(document).on("click",".csEntityRecycle",function(){DialogUtils.confirmWithOptions({title:"确认要回收选中的客户资料吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchRecycle($("#id").val());
}});});$(document).on("click",".csReturnsByIds",function(){DialogUtils.confirmWithOptions({title:"确认要归还的客户吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._csReturnsByIds($("#id").val());
}});});$(document).on("click",".csSeaChangeGroup",function(){$("input[name=selectedIds]").val($("#id").val());$("#changeGroupModalContainer").modal("show");
});$("body").on("click","#csSeaChangeGroupSave",function(){var b=$("input[name=selectedIds]").val();var c=$("input[name=groupId]").val();a._csSeaChangeGroup(b,c);
});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='groupId']").val(),container:"groupName",nolimit:true,positionType:"dept_manager,cs_search",fn:function(c){$("input[name=groupId]").val(c);
}};GroupUtils.selectGroupTreeBox(b);});$("body").on("change","input",function(){var b=$(this).parents(".editFlag").attr("id");if(b){a.isEdit=true;}});$("body").on("change","select",function(){var c=$(this).attr("id");
if(c&&"systemTagSelect"==c){return;}var b=$(this).parents(".editFlag").attr("id");if(b){a.isEdit=true;}});$("body").on("change","textarea",function(){var b=$(this).parents(".editFlag").attr("id");
if(b){a.isEdit=true;}});$("body").on("click",".deletePhone",function(){var b=$(this).parents(".editFlag").attr("id");if(b){a.isEdit=true;}});$(".moreBtn").hover(function(b){if(!$(this).is(".currentDrop")){$(this).addClass("currentDrop").addClass("delayer").next().stop().slideDown("fast");
}},function(b){setTimeout(function(){if($(".currentDrop").length>0&&$(".delayer").length>0){$(".delayer").removeClass("delayer");}},1);});$(document).on("mouseover",function(b){if($(".currentDrop").length>0&&$(".delayer").length==0&&!$(b.target).is(".moreBtn,dropdown-menu,.dropdown-menu *")){$(".currentDrop").removeClass("currentDrop").next().stop().slideUp("fast");
}});$("body").on("click",".addWeixinFriend",function(){var b=$(this).attr("attr-num");a.layerIndex=layer.open({type:1,title:"添加微信好友",shadeClose:false,btn:["确定","关闭"],area:["500px","400px"],scrollbar:false,content:$(".showAddWeixinFriendPane"),success:function(c,e){var d=CsEntityEdit._CONS_.FIND_EMPLOYEE_WEIXIN+"?status=2&employeeId="+currentUserId;
FormUtils.loadData(d,function(f){var h=new StringBuffer();h.append("<option value=''>请选择</option>");if(f){for(var g=0;g<f.length;g++){h.append("<option nickname='"+f[g].nickName+"' value='"+f[g].userName+"'>"+f[g].alias+"("+f[g].nickName+")</option>");
}}$("#addEmployeeAlias").empty().append(h.toString());$("#addRemark").val("["+$("#csEntityForm input[name='csCode']").val()+"]_"+$("#csEntityForm input[name='name']").val());
});},yes:function(d,c){a._addWeixinFriend(b,d);}});});if(isNewPage){$(document).on("click",".csTagDown",function(){$(this).next().animate({top:["0px","swing"]},250);
$(this).animate({top:["25px","swing"]},250);if($(".tabView").attr("disabled")){$("#tagContainer").slideUp();$("#tagTableContainer").slideDown();}else{$("#tagContainer").slideDown();
$("#tagTableContainer").slideUp();}});$(document).on("click",".shrinkView",function(){$("#tagTableContainer").stop().slideUp("fast");$("#tagContainer").stop().slideDown("fast");
$(this).css("color","#337ab7");$(".tabView").css("color","#c2c2c2");$(".tabView").attr("disabled",false);$(".shrinkView").attr("disabled",true);$(".mutipleSelectEavAttr").chosen("destroy").chosen();
});$(document).on("click",".tabView",function(){$("#tagContainer").stop().slideUp("fast");$("#tagTableContainer").stop().slideDown("fast");$(this).css("color","#337ab7");
$(".shrinkView").css("color","#c2c2c2");$(".tabView").attr("disabled",true);$(".shrinkView").attr("disabled",false);if(!a.eavInit){a.eavInit=true;a._fillEavTag($("input[name=id]").val());
}});$("#addEmployeeAlias").on("change",function(){var b=$($("#addEmployeeAlias option:selected")[0]).attr("nickname");$("#addSendWords").val("您好！我是"+b);
});$(document).on("click",".copyCsBtn",function(){$("#csCodeText").select();document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});$(".showEmployeeWeixin").on("click",function(){a.layerIndex=layer.open({type:1,title:"员工微信",shadeClose:false,btn:["确定","关闭"],area:["500px","300px"],scrollbar:false,content:$(".showEmployeeWeixinPanel"),success:function(b,d){var c=ctx+"/gl/ou/employeeWeiXin/getByWeiXin.htm?weixin="+$(CsEntityEdit._CONS_.FORM_ID+" input[name='employeeWeixin']").val();
if(weixinUseType=="android"){c=ctx+"/gl/ou/employeeWeiXin/getByFriendCode.htm?friendCode="+$(CsEntityEdit._CONS_.FORM_ID+" input[name='csCode']").val();
}FormUtils.loadData(c,function(e){var f=new StringBuffer();if(e!=null&&e!=""&&e.id){f.append("<tr>").append("<td>").append(e.employeeAid+":"+e.employeeName).append("</td>").append("<td>");
if(weixinUseType=="android"){f.append(e.alias);}else{f.append(e.weixin);}f.append("</td>").append("<td>").append(e.nickName).append("</td>").append("<td>").append(e.nickNameRemark).append("</td>").append("<td>").append(e.status=="0"?"离线":"在线").append("</td>").append("</tr>");
}$("#employee-weixin-list").empty().append(f.toString());});},yes:function(c,b){layer.close(c);}});});}},_claimCsSea:function(c){var a=this;var b=ctx+"/crm/cs/csEntitySea/claimCsSea.htm";
FormUtils.submit(b,{"ids":c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"客户领取成功");window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+csId;
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_batchRecycle:function(c){var a=this;var b=ctx+"/crm/cs/csEntity/batchRecycle.htm";FormUtils.submit(b,{"ids":c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"客户资料回收成功");
window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+csId;}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_csReturnsByIds:function(c){var a=this;
var b=ctx+"/crm/cs/csEntitySea/csReturnByIds.htm";FormUtils.submit(b,{"ids":c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+csId;
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_csSeaChangeGroup:function(d,c){var a=this;var b=ctx+"/crm/cs/csEntitySea/csSeaChangeGroup.htm";FormUtils.submit(b,{"ids":d,"groupId":c},function(e){if(e.success){DialogUtils.success(msgCode.INFO,"客户转移成功");
$("#changeGroupModalContainer").modal("hide");window.location.href=ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+csId;}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}});},_bindWx:function(c,d,b){var a=ctx+"/gl/cs/weiXinFriends/bindWx.htm";FormUtils.loadData(a+"?userName="+c+"&friendCode="+d,function(e){if(e.success){DialogUtils.success(msgCode.SUCESS,e.msg);
layer.close(b);$(".bindWx").hide();}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_descryptWeixin:function(a,d,b,c){$.ajax({type:"GET",url:CsEntityEdit._CONS_.DESCRYPT_WEIXIN+"?encryNum="+a+"&type="+d+"&id="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.success&&c&&typeof c=="function"){c(e.msg);
}}});},_descryptEmail:function(a,d,b,c){$.ajax({type:"GET",url:CsEntityEdit._CONS_.DESCRYPT_EMAIL+"?encryNum="+a+"&type="+d+"&id="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.success&&c&&typeof c=="function"){c(e.msg);
}}});},loadData:function(b){var a=this;FormUtils.loadData(CsEntityEdit._CONS_.EDIT_URL+"?id="+b+"&type="+type,function(c){a.data=c;a._fillBaseInfo(c);a._hideNotGrantedBtn(c.permissionType,c);
if(c.permissionType&&("self"==c.permissionType||"mysub"==c.permissionType)){}else{a.isDetail=true;a._disableForDetail();}a._fillStatisticalInfo(c);a._fillPhoneInfo(c);
a._fillCommunication(c);a._fillFollowRecordTab(c,{partyId:c.employeeId,partyAid:c.employeeAid,partyName:c.employeeName});a._fillAddrInfo(c);a._fillOtherInfo(c);
a._initTabName(c);a._loadThreeDaysOrder(c);a._initWxchat(c);a._finleCsEntittyFinance(c);if(isNewPage){a._fillEavInfo(b);$(".hideSearchParam").hide();if(!a.eavInit){a.eavInit=true;
a._fillEavTag($("input[name=id]").val());}}});},_finleCsEntittyFinance:function(b){var a=b.csEntityFinancePo;if(a!=""&&a!=null){$("#csEntityForm select[name='csEntityFinancePo.marry']").val(a.marry);
$("#csEntityForm input[name='csEntityFinancePo.investmentExperience']").val(a.investmentExperience);$("#csEntityForm input[name='csEntityFinancePo.investmentPreference']").val(a.investmentPreference);
$("#csEntityForm input[name='csEntityFinancePo.investmentRate']").val(a.investmentRate);$("#csEntityForm select[name='csEntityFinancePo.finalCallState']").val(a.finalCallState);
$("#csEntityForm select[name='csEntityFinancePo.hasInvestmentExperience']").val(a.hasInvestmentExperience);$("#csEntityForm input[name='csEntityFinancePo.expectedRate']").val(a.expectedRate);
$("#csEntityForm textarea[name='csEntityFinancePo.communicationContent']").val(a.communicationContent);$("#csEntityForm input[name='csEntityFinancePo.meetingTime']").val(a.meetingTime);
}},_loadThreeDaysOrder:function(e){var b=this;var c=e.lastFollowTime;var a=e.follow;var d=e.soTotal;$.ajax({type:"GET",url:CsEntityEdit._CONS_.LOAD_THREEDAYS_ORDER+"?csId="+e.id,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){b._fillTip(f,c,a,d);
}});},_fillOtherStatisticalInfo:function(){var a=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();this.statisticInfo.fillOtherInfo(a);},_fillStatisticalInfo:function(a){this.statisticInfo.fillInfo(a);
},_fillBaseInfo:function(e){var c=this;$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val(e.id);$(CsEntityEdit._CONS_.FORM_ID).find("[name=csCode]").val(e.code);
if(e.gender=="男"){$("#genderMan").val("男");$("#genderMan").attr("checked",true);$("#genderWomen").attr("checked",false);}else{if(e.gender=="女"){$("#genderWomen").val("女");
$("#genderMan").attr("checked",false);$("#genderWomen").attr("checked",true);}}$(CsEntityEdit._CONS_.FORM_ID).find("[name=controlNo]").val(e.controlNo);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=canPlaceSo]").val(e.canPlaceSo);$(CsEntityEdit._CONS_.FORM_ID).find("[name=isOrderSo]").val(e.isOrderSo);$(CsEntityEdit._CONS_.FORM_ID).find("[name=income]").val(e.income);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=isTurnover]").val(e.isTurnover);$(CsEntityEdit._CONS_.FORM_ID).find("[name=isMeeting]").val(e.isMeeting);$(CsEntityEdit._CONS_.FORM_ID).find("[name=isIntention]").val(e.isIntention);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=passTime]").val(e.passTime);$(CsEntityEdit._CONS_.FORM_ID).find("[name=degree]").val(e.degree);$(CsEntityEdit._CONS_.FORM_ID).find("[name='name']").val(e.name);
$(CsEntityEdit._CONS_.FORM_ID).find("#searchProd").val(e.productName);$(CsEntityEdit._CONS_.FORM_ID).find("[name='nickName']").val(e.nickName);$(CsEntityEdit._CONS_.FORM_ID).find("[name='isSub']").val(e.isSub);
$(CsEntityEdit._CONS_.FORM_ID).find("[name='mainCsId']").val(e.mainCsId);if(!c.changeName){$(CsEntityEdit._CONS_.FORM_ID).find("[name='name']").attr("readonly",true);
}ConfigUtils.findByKey("csEntity.limit.wineIndustry",function(f){if(f.msg=="y"){$("#csEntityForm .heightWeightDiv").hide();$("#csEntityForm .wineIndustry").show();
$(CsEntityEdit._CONS_.FORM_ID).find("[name=purpose]").val(e.purpose);$(CsEntityEdit._CONS_.FORM_ID).find("[name=taste]").val(e.taste);}else{if(versionType=="finance"){$("#csEntityForm .heightWeightDiv").hide();
}else{$("#csEntityForm .heightWeightDiv").show();}$("#csEntityForm .wineIndustry").hide();$(CsEntityEdit._CONS_.FORM_ID).find("[name=weight]").val(e.weight);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=height]").val(e.height);}});$(CsEntityEdit._CONS_.FORM_ID).find("[name='ipLocations']").val(e.ipLocations);$(CsEntityEdit._CONS_.FORM_ID).find("[name=weixin]").val(e.weixin);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=maskWeixin]").val(e.maskWeixin);if(e.birthday){var a=e.birthday.split("-");$("#birthYear").val(a[0]);$("#birthMonth").val(a[1]);
$("#birthDay").val(a[2]);if(a[0]){var b=(new Date()).getFullYear()-a[0];$("#age").val(b);}}$(CsEntityEdit._CONS_.FORM_ID).find("[name=maritalStatus]").val(e.maritalStatus);
$(CsEntityEdit._CONS_.FORM_ID).find("[name=vocation]").val(e.vocation);$(CsEntityEdit._CONS_.FORM_ID).find("[name=email]").val(e.email);$(CsEntityEdit._CONS_.FORM_ID).find("[name=maskEmail]").val(e.maskEmail);
if(e.maskEmail==null||e.maskEmail==""){$(".sendEmail").hide();}if(ResUtils.canShow("csEntity.button.viewDesc")){$(CsEntityEdit._CONS_.FORM_ID).find("[name='desc']").val(e.desc);
}else{$(CsEntityEdit._CONS_.FORM_ID).find("[name='desc']").val(MaskPhoneNum.maskDesc(e.desc));var d=(e.desc).match(/1\d{10}/g);$("#descPhone").val(d);}$("input[name=employeeId]").val(e.employeeId);
$("input[name=employeeShow]").val(e.employeeAid+"："+e.employeeName);$("input[name=createByInfo]").val(e.createByEmployeeAid+"："+e.createByEmployeeName);
$("input[id=permissionType]").val(e.permissionType);if(e.preId){$("#csEntityForm").find("[name=preId]").val(e.preId);}else{$(".preCs").hide();}if(e.nextId){$("#csEntityForm").find("[name=nextId]").val(e.nextId);
}else{$(".nextCs").hide();}if(e.isDelete!="0"&&ResUtils.canShow("csEntityRecycle.button.recycle")){$(".csEntityRecycle").show();}if(e.isSea!="n"&&e.permissionType=="mysub"&&ResUtils.canShow("csEntitySea.button.claimCsSea")){$(".claimCsSea").show();
}if(e.isSea!="n"&&e.permissionType=="mysub"&&ResUtils.canShow("csEntitySea.button.csSeaChangeGroup")){$(".csSeaChangeGroup").show();}if(e.isSea!="n"&&e.permissionType=="self"&&ResUtils.canShow("csEntitySea.button.csReturnsByIds")){$(".csReturnsByIds").show();
}if(e.isSea=="y"){$(".changRelEmployee").hide();}ConfigUtils.findByKey("csEntity.limit.wineIndustry",function(f){if(f.success){$(".aboutJD").show();$(".canPlaceSoDiv").hide();
$(".noDiv").hide();$("input[name=jdPoint]").val(e.jdPoint);}});setTimeout(function(){c.formFrontConfig.init();},1);},_fillCommunication:function(b){var a=this;
CsEntityUtils.channelSelectTimer=setInterval(function(){if(CsEntityUtils.isInitChannelSelect){if(b.srcs){$("#srcs").val(b.srcs.split(",")).trigger("chosen:updated");
}else{$("#srcs").val("").trigger("chosen:updated");}if(!a.changeSrcs){$("#srcs").attr("disabled",true);}clearInterval(CsEntityUtils.channelSelectTimer);
CsEntityUtils.channelSelectTimer=null;}},250);CsEntityUtils.employeeWxTimer=setInterval(function(){if(CsEntityUtils.isInitEmployeeWx){$("#employeeWeixin").selectpicker();
$("#employeeWeixin").selectpicker("refresh");if(b.employeeWeixin){$("#employeeWeixin").selectpicker("val",b.employeeWeixin);}else{$("#employeeWeixin").selectpicker("val",[]);
}clearInterval(CsEntityUtils.employeeWxTimer);CsEntityUtils.employeeWxTimer=null;}},250);CsEntityUtils.interestsTimer=setInterval(function(){if(CsEntityUtils.isInitInterests){$("#interests").selectpicker();
$("#interests").selectpicker("refresh");if(b.interests){var c=b.interests.split(",");$("#interests").selectpicker("val",c);}else{$("#interests").selectpicker("val",[]);
}clearInterval(CsEntityUtils.interestsTimer);CsEntityUtils.interestsTimer=null;}},250);$(CsEntityEdit._CONS_.FORM_ID).find("select[name=bizType]").val(b.bizType);
$(CsEntityEdit._CONS_.FORM_ID).find("select[name=follow]").val(b.follow).attr("disabled",true);$(CsEntityEdit._CONS_.FORM_ID).find("select[name=entry]").val(b.entry);
},_fillFollowRecordTab:function(b,a){var c={csId:b.id,employeeId:b.employeeId,entityId:"",csCode:b.code,needTable:true,followType:"cs",csType:type,permissionType:b.permissionType,contentExt:"",fn:function(){if(b.isDelete=="1"){$(".addFollow").hide();
}}};this.csFollow.init(c,a);this.csFollow._initEmployeeSuggest();},_csCashHi:function(b){var a={csId:b,csType:type,permissionType:type};this.csCashHi.init(a);
},_fillFinanceMeeting:function(b){var a={csId:b,csType:type,permissionType:type};this.financeMeeting.init(a);},_fillFinanceContract:function(b){var a={csId:b,csType:type,permissionType:type};
this.financeContract.init(a);},_fillFinanceTurnover:function(b){var a={csId:b,csType:type,permissionType:type};this.financeTurnover.init(a);},_initCallRecord:function(b,d,c){var a={csId:b,employeeId:d,csType:type,permissionType:c};
this.csCallRecord.init(a);},_reloadFollow:function(){var a={id:$("#csEntityForm").find("[name=id]").val(),code:$("#statisticInfoDiv").find("[name=csCode]").val()};
this._fillFollowRecordTab(a);},_fillContractTab:function(a){},_fillOppoTab:function(a){var b=new StringBuffer();b.append("Q__S__EQ__co_id_="+a.id);b.append("&rows=999999");
b.append("&page=1");this.oppoList.reloadEntityList(b.toString(),a.id);},_fillAccountTab:function(a){this.csAccount.init({csId:a.id});},_fillComplain:function(a,c,b){var d={csId:a,employeeId:c,isDetail:this.isDetail,csType:type,permissionType:b};
this.csComplainAdd.init(d);},_fillLevelChange:function(a){this.csLevelChange.init({csId:a});},_fillSmsRecordTab:function(a){this.sendMessage.initTable({csId:a});
},_fillMailHistoryTab:function(a){this.csMailHistory.initTable({csId:a});},_fillPointLogTab:function(a){this.pointLog.init({csId:a});},_fillCsLimitTab:function(a){this.csLimit.initTable({csId:a});
},maskEmail:function(a){var c=new StringBuffer();if(a){var b=a.indexOf("@");if(b>2){c.append(a.substring(0,b-2)).append("**").append(a.substring(b));}else{if(b>=1){c.append(a.substring(0,b-1)).append("*").append(a.substring(b));
}}}return c.toString();},_fillOtherInfo:function(a){$("#customer1Info").val(a.code+"("+a.name+")");},combineCs:function(a,b){commomloading=layer.load();
$.ajax({type:"POST",url:CsEntityEdit._CONS_.COMBINE_CS_URL+"?csId="+a+"&combinedCsId="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){layer.close(commomloading);
if(c.success){DialogUtils.success("提示","合并成功");CsEntityUtils.refreshListTab();JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+a,"客户["+$("#csEntityForm").find('input[name="name"]').val()+"]");
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},error:function(){layer.close(commomloading);}});},_saveEdit:function(j){var l=this;var c=$(".maskEmail").val();
if(c.indexOf("*@")<0){if(c.indexOf("@")>0){$("input[name=email]").val(c);}else{if(!(c==null||c.trim()=="")){DialogUtils.error("失败","邮箱格式不正确");return;}}}if(!ResUtils.canShow("csEntity.button.viewDesc")){var b=$("#descPhone").val();
var h=$("[name='desc']").val();var a=b.split(",");var e=h.match(/[\~*_]{11}/g);if(e&&e.length>0){for(var f=0;f<a.length;f++){h=h.replace(e[f],a[f]);}}$("[name='desc']").val(h);
}var k=CsEntityEdit._CONS_.SAVE_EDIT_URL;var g=$("#csEntityForm [name=id]").val();var d=$("#csEntityForm [name=isSub]").val();l._validPhone(function(i){ButtonUtils.disableBtn("saveBtn");
var m=new StringBuffer();FormUtils.enableForm("#csEntityForm");m.append($("#csEntityForm").serialize());m.append("&").append(l.csEav.getEavInfoParams());
if(l.eavInit){m.append("&").append(l.csEav.getEavTagParams());}m.append("&csPhoneJSON=").append(l.csPhone.csPhoneData2Json());m.append("&birthday=").append($("#birthYear").val()).append("-").append($("#birthMonth").val()).append("-").append($("#birthDay").val());
FormUtils.submit(k,m.toString(),function(n){ButtonUtils.enableBtn("saveBtn");l._hideNotGrantedBtn(l.data.permissionType,l.data);if(n.success){DialogUtils.success("提示",n.msg);
l.isEdit=false;if(j&&typeof j==="function"){j();}if(l.csAddr.csType=="self"){if(ResUtils.canShow("csEntity.button.isRefreshTal")){JTTabUtils.refreshTable(ctx+"/crm/cs/csEntity/list.htm","我的客户","parentCMD");
}}else{if(l.csAddr.csType=="mysub"){if(ResUtils.canShow("csEntity.button.isRefreshTalSub")){JTTabUtils.refreshTable(ctx+"/crm/cs/csEntity/subList.htm","下属客户","parentCMD");
}}}}else{DialogUtils.error("失败",n.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error("错误","后台异常，请稍后重试");});},g,d);},_validPhone:function(k,g,l){var c=new StringBuffer();
c.append($("select[name=freeBeginHour]").val()).append($("select[name=freeBeginMinute]").val()).toString();var f=new StringBuffer();f.append($("select[name=freeEndHour]").val()).append($("select[name=freeEndMinute]").val()).toString();
if(parseInt(c)>parseInt(f)){DialogUtils.error("提示","结束时间不可早于开始时间");return;}var e=$(".newPhone");var b=[];if(e&&e.length>0){for(var d=0;d<e.length;d++){if($(e[d]).val()){b.push($(e[d]).val());
var j=$(e[d]).parent().next().find("select").val();var a=$.trim(b[d]);if(!this.csPhone._checkIsPhone(a,j)){if(j=="座机"){if(!this.csPhone._checkIsTel(a,j)){var h="座机号格式错误";
DialogUtils.error("提示",h);return;}}else{DialogUtils.error("提示","非手机类型请选座机");return;}}}}if(b.length>0&&"y"!=l){this.csPhone.vaildPhondIsUsed(b,function(){k();
return;});}else{k();}}else{k();}},_fillPhoneInfo:function(c){var b=this;var a={csId:c.id,fn:function(){if(b.isDetail||!b.addPhone){$(".addCsPhone").hide();
}if("self"==type||(c.permissionType&&"self"==c.permissionType)){if(!ResUtils.canShow("csEntity.button.deletePhone")){$(".deletePhone").hide();}if(!ResUtils.canShow("csEntity.button.callPhoneBtn")){$(".makePhone").hide();
}if(!ResUtils.canShow("csEntity.button.callPhoneAddZeroBtn")){$(".makePhoneAddZero").hide();}if(!ResUtils.canShow("csEntity.button.sendMsgBtn")){$(".sendMessage").hide();
}if(!ResUtils.canShow("csEntity.button.viewPhoneBtn")){$(".viewPhone").hide();}if(!ResUtils.canShow("csEntity.button.addWxByPhone")){$(".addWeixinFriend").hide();
}if(!ResUtils.canShow("csEntity.portray.button")){$("#csEntityPortray").hide();$("#showMoreRfmt").hide();}else{$("#showMoreRfmt").show();}}else{if("mysub"==type||(c.permissionType&&"mysub"==c.permissionType)){if(!ResUtils.canShow("csEntity.button.deletePhoneSub")){$(".deletePhone").hide();
}if(!ResUtils.canShow("csEntity.button.callPhoneBtnSub")){$(".makePhone").hide();}if(!ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSub")){$(".makePhoneAddZero").hide();
}if(!ResUtils.canShow("csEntity.button.sendMsgBtnSub")){$(".sendMessage").hide();}if(!ResUtils.canShow("csEntity.button.viewPhoneBtnSub")){$(".viewPhone").hide();
}if(!ResUtils.canShow("csEntity.button.addWxByPhoneSub")){$(".addWeixinFriend").hide();}if(!ResUtils.canShow("csEntity.portray.buttonSub")){$("#csEntityPortray").hide();
$("#showMoreRfmt").hide();}else{$("#showMoreRfmt").show();}}else{if("task"==type){if(!ResUtils.canShow("csEntity.button.deletePhoneTask")){$(".deletePhone").hide();
}if(!ResUtils.canShow("csEntity.button.callPhoneBtnTask")){$(".makePhone").hide();}if(!ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnTask")){$(".makePhoneAddZero").hide();
}if(!ResUtils.canShow("csEntity.button.sendMsgBtnTask")){$(".sendMessage").hide();}if(!ResUtils.canShow("csEntity.button.viewPhoneBtnTask")){$(".viewPhone").hide();
}if(!ResUtils.canShow("csEntity.portray.buttonTask")){$("#csEntityPortray").hide();$("#showMoreRfmt").hide();}else{$("#showMoreRfmt").show();}$(".addWeixinFriend").remove();
}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.deletePhoneCallRecord")){$(".deletePhone").hide();}if(!ResUtils.canShow("csEntity.button.callPhoneBtnCallRecord")){$(".makePhone").hide();
}if(!ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnCallRecord")){$(".makePhoneAddZero").hide();}if(!ResUtils.canShow("csEntity.button.sendMsgBtnCallRecord")){$(".sendMessage").hide();
}if(!ResUtils.canShow("csEntity.button.viewPhoneBtnCallRecord")){$(".viewPhone").hide();}if(!ResUtils.canShow("csEntity.portray.buttonCallRecord")){$("#csEntityPortray").hide();
$("#showMoreRfmt").hide();}else{$("#showMoreRfmt").show();}$(".addWeixinFriend").remove();}else{if(!ResUtils.canShow("csEntity.button.deletePhoneSearch")){$(".deletePhone").hide();
}if(!ResUtils.canShow("csEntity.button.callPhoneBtnSearch")){$(".makePhone").hide();}if(!ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSearch")){$(".makePhoneAddZero").hide();
}if(!ResUtils.canShow("csEntity.button.sendMsgBtnSearch")){$(".sendMessage").hide();}if(!ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")){$(".viewPhone").hide();
}if(!ResUtils.canShow("csEntity.portray.buttonSearch")){$("#csEntityPortray").hide();$("#showMoreRfmt").hide();}else{$("#showMoreRfmt").show();}$(".addWeixinFriend").remove();
}}}}if(c.isDelete=="1"){$(".deletePhone").hide();$(".makePhone").hide();$(".makePhoneAddZero").hide();$(".sendMessage").hide();}}};this.csPhone.loadData(a);
},_fillEavInfo:function(a){var b={csId:a,isDetail:this.isDetail};this.csEav.loadDataEavCommon(b);},_fillEavTag:function(a){var b={csId:a,isDetail:this.isDetail};
this.csEav.loadDataEavTag(b);},_fillAddrInfo:function(c){var a=this;var b={csId:c.id,csType:type,employeeId:c.employeeId,permissionType:c.permissionType,fn:function(){if(!a.changeAddr){$(".addAddr").hide();
$(".edit-addr").hide();$(".addrListDiv").find("button").hide();}else{$("#shopAddrOptForm").find("button").show();$("#shopAddrOptForm").find("input").attr("disabled",false);
$("#shopAddrOptForm").find("select").attr("disabled",false);$("#shopAddrOptForm").find("textarea").attr("disabled",false);}if(c.isDelete=="1"){$(".addAddr").hide();
$(".edit-addr").hide();$(".showMapWeather").hide();$(".remove-addr").hide();}}};this.csAddr.loadData(b);},_fillOrderInfo:function(a,c,b){var d={csId:a,employeeId:c,csType:type,permissionType:b,showThirdSoNo:showThirdSoNo};
this.csOrder.init(d);},_fillTip:function(d,c,a,g){var h=new StringBuffer();var b="&nbsp;&nbsp;&nbsp;";if(c&&0==DateUtils.getDateDiff(c,DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),"day")){h.append("<span style='color:green;'>今天已跟进</span>").append(b);
}else{h.append("<span style='color:red;'>今天未跟进</span>").append(b);}var f="";if(c){f=c.substring(0,c.length-3);f=f.substring(5,f.length);}h.append("最新跟进：").append("<span title='"+c+"'>"+f+"</span>").append(b);
if(d&&d.length>0){h.append("<span style='color:green;'>3天内订单：</span>");for(var e=0;e<d.length;e++){if(e==1){h.append("...");break;}h.append("<a href='#'' class='soTab' attr-count='"+d.length+"' attr-id='"+(d)[e].id+"' attr-csId='"+(d)[e].csId+"' "+"attr-status='"+(d)[e].status+"' attr-placerId='"+(d)[e].placerId+"' "+"value='"+(d)[e].soNo+"'>"+(d)[e].soNo+"</a>");
}}else{h.append("<span style='color:red;'>3天内无订单</span>").append(b);}h.append(b);h.append("跟进标签：");if(a){h.append("<span style='color:red;'>"+a+"</span>").append(b);
}else{h.append("<span style='color:red;'>无</span>").append(b);}if(!g){g=0;}h.append(b).append("消费总额：<span style='color:red;'>").append(parseFloat(g).toFixed(2)).append("</span>&nbsp;元");
$("#orderTip").empty().append(h.toString());},_bindFormValidation:function(){var a={rules:{maskEmail:{email:true}},messages:{}};FormUtils.bindFormValidation("csEntityForm",a);
},_initTabName:function(a){if(!csPhone){JTTabUtils.renameForActiveTab("客户["+a.name+"]");}else{JTTabUtils.renameForActiveTab("客户来电：["+a.name+"]");}},_disableForDetail:function(){$("body").find("button").hide();
$("#interests").next().find(".dropdown-toggle").show();$("#employeeWeixin").next().find(".dropdown-toggle").show();$("body").find("input").attr("disabled",true);
$("body").find("select").attr("disabled",true);$("body").find("textarea").attr("disabled",true);$("a.placePointOrder").hide();$("a.soAfterList").hide();
$("a.createSubCsEntity").hide();$("a.combineCs").show();$(".closeBtn").show();$(".moreBtn").show();$("#csFollowForm").find("input").attr("disabled",false);
$("#csFollowForm").find("select").attr("disabled",false);$("#csFollowForm").find("textarea").attr("disabled",false);$("select[name=suffix]").attr("disabled",false);
$("#csFollowForm").find(".selectEmployee").show();$(".chooseCsForCombine").show();$("#customer2Id").attr("disabled",false);$("input[name=chooseCs]").attr("disabled",false);
$("#sendMessageModalLabel").find("#smsTpl").attr("disabled",false);$("#sendMessageModalLabel").find("[name=sendContent]").attr("disabled",false);},_initWxchat:function(a){console.log(weixinUseType);
if(weixinUseType=="android"){this._initANdroidchatBtn(a);}else{this._initWebchatBtn(a);}},_initWebchat:function(){var b=this;var a=$("[name='csCode']").val();
var e=$("[name='csName']").val();var d=$("[name='id']").val();var c=CsEntityEdit._CONS_.GET_BY_CSCODE_URL;FormUtils.loadData(c+"?csCode="+a,function(g){if(g&&g.userName){var f={csCode:a,csName:e,employeeWeiXin:g.employeeWeixin,csId:d,userName:g.userName,headImgUrl:g.headImgUrl,hasInline:g.status==1?true:false,wxLabel:g.label,nickNameHashCode:g.nickNameHashCode};
$(".jt-chat-div-for-change").attr("id","jt-chat-"+g.userName.substring(1,g.userName.length));b.layerIndex=layer.open({type:1,title:"聊天，员工微信--"+g.employeeNickName+":"+g.employeeWeixin,shade:false,area:["722px","488px"],scrollbar:false,content:$(".weiXinChatPane"),success:function(h,i){$(".jt-wx-btn-div").hide();
$(".main-show").hide();$(".main-hide").show();$(".main-hide").addClass("one-to-one").css({width:"100%"});b.weiXinChatForm.csInfo=f;b.weiXinChatForm.record.page=1;
b.weiXinChatForm.initChat(false);},yes:function(i,h){}});}else{DialogUtils.error("错误","客户未关联或者系统关注微信未登录");}});},_initWebchatBtn:function(c){var a=$("[name='csCode']").val();
var b=CsEntityEdit._CONS_.GET_BY_CSCODE_URL;if(c.relatedWeixin=="n"){return;}FormUtils.loadData(b+"?csCode="+a,function(d){if(d&&d.userName&&c.permissionType&&("self"==c.permissionType||"mysub"==c.permissionType)){if(d.status==1){$(".weixinChatBtn").addClass("jt-fm-green");
}else{$(".weixinChatBtn").removeClass("jt-fm-green");}$(".weixinChatBtn").show();}else{$(".weixinChatBtn").hide();if(c.relatedWeixin=="y"&&ResUtils.canShow("csEntity.button.bindWx")){$(".bindWx").show();
}else{$(".bindWx").hide();}}self._weixinChatBtn($(".weixinChatBtn"));});},_weixinChatBtn:function(d){var b=this;var c=$(d).parent(".jt-pb-layer");if(c.length>0){var a=0;
c.children("button").each(function(f,g){if($(this).is(":visible")){a++;}});if(a==0){c.parent().removeClass("jt-params-bar").removeClass("jt-params-2bar").removeClass("jt-params-3bar");
}else{if(a==1){c.parent().removeClass("jt-params-2bar").removeClass("jt-params-3bar");}else{if(a>1){c.parent().addClass("jt-params-"+a+"bar");}}}}},_initANdroidchat:function(){var b=this;
var a=$("[name='csCode']").val();var e=$("[name='csName']").val();var d=$("[name='id']").val();var c=CsEntityEdit._CONS_.GET_BY_ANDROID_CSCODE_URL;FormUtils.loadData(c+"?csCode="+a,function(g){if(g&&g.userName){var f={csCode:a,csName:e,csId:d,userName:g.userName,headImgUrl:g.userAvatarSmall,hasInline:g.status==2?true:false,wxLabel:g.label,employeeAlias:g.employeeAlias,nickName:g.conRemark,alias:g.alias,};
$(".jt-chat-div-for-change").attr("id","jt-chat-"+g.userName);b.layerIndex=layer.open({type:1,title:"我与<span style='color: #750d18;''> "+g.employeeNickName+"("+g.employeeWeixin+")"+" </span>的聊天窗口",shade:false,area:["722px","488px"],scrollbar:false,content:$(".weiXinChatPane"),success:function(h,i){$(".jt-wx-btn-div").hide();
$(".main-show").hide();$(".main-hide").show();$(".main-hide").addClass("one-to-one").css({width:"100%"});b.weiXinChatForm.csInfo=f;b.weiXinChatForm.record.page=1;
b.weiXinChatForm.initChat(false);$(".m-message").height($(".main-hide").height()-$("#send-msg-div").height()-40);},yes:function(i,h){}});}else{DialogUtils.error("错误","客户未关联或者系统关注微信未登录");
}});},_initANdroidchatBtn:function(d){var b=this;var a=$("[name='csCode']").val();var c=CsEntityEdit._CONS_.GET_BY_ANDROID_CSCODE_URL;if(d.relatedWeixin=="n"){return;
}FormUtils.loadData(c+"?csCode="+a,function(e){if(e&&e.userName&&d.permissionType&&("self"==d.permissionType||"mysub"==d.permissionType)){if(e.status==2){$(".weixinChatBtn").addClass("jt-fm-green");
}else{$(".weixinChatBtn").removeClass("jt-fm-green");}$(".weixinChatBtn").show();b._weixinChatBtn($(".weixinChatBtn"));b.weiXinChatForm.init();}else{$(".weixinChatBtn").hide();
b._weixinChatBtn($(".weixinChatBtn"));}});},_addWeixinFriend:function(a,d){var e=$("#addEmployeeAlias").val();if(!e||e==""||e==null){DialogUtils.error("错误","请选择员工微信员工微信");
return;}if(!a||a==""||a==null){DialogUtils.error("错误","手机号不能为空");return;}var f=$("#addRemark").val();var b=$("#addSendWords").val();var c=CsEntityEdit._CONS_.ADD_BY_PHONE_URL;
FormUtils.submit(c,{employeeAlias:e,phone:a,remark:f,sendWords:b},function(g){if(g.success){layer.close(d);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");
});},_loadOrderList:function(b){var a=CsEntityEdit._CONS_.FIND_THREE_DAYS_ORDER_URL+"?csId="+b;FormUtils.loadData(a,function(e){if(e&&e.length>0){var f=new StringBuffer();
f.append("<tr class='active'><th>订单编号</th><th>订单金额</th><th>状态</th><th>下单工号</th><th>创建时间</th></tr>");for(var d=0;d<e.length;d++){var c=null;if(e[d].status=="awaiting_pay"){c="等待支付";
}else{if(e[d].status=="awaiting_post"){c="待提交";}else{if(e[d].status=="awaiting_comfirm"){c="待审核";}else{if(e[d].status=="comfirm"){c="待发货";}else{if(e[d].status=="shipping"){c="已发货";
}else{if(e[d].status=="complete"){c="已签收";}else{if(e[d].status=="close"){c="订单作废";}else{if(e[d].status=="close_reject"){c="拒收";}else{if(e[d].status=="close_lost"){c="包裹丢失";
}}}}}}}}}f.append("<tr><td width='130'>"+"<a href='#' class='mySoTab' csNameVal='"+e[d].csName+"'  value='"+e[d].soNo+"'>"+e[d].soNo+"</a></td>"+"<td width='130'>"+parseFloat(e[d].totalAmount).toFixed(2)+"</td>"+"<td width='130'>"+c+"</td>"+"<td width='130'>"+e[d].aid+"</td>");
if(e[d].status=="awaiting_post"){$("#threeDayOrderTab tr").find("th").eq(4).text("下单时间");f.append("<td width='130'>"+e[d].placeTime+"</td></tr>");}else{f.append("<td width='200'>"+e[d].createTime+"</td></tr>");
}}$("#threeDayOrderTab").empty().append(f.toString());}});},_placeGeneralOrderMethod:function(e,a){var c=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();
var d=$("input[name='name']").val();var b=CsEntityEdit._CONS_.ORDER_PLACE_URL+"?isAdd=true&csId="+$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val()+"&isPoint=false"+"&type="+type;
if(outNum){b=b+"&outNum="+outNum;}JTTabUtils.addOrRefreshTab(b,"客户["+d+"]下订单");},_placePointsOrderMethod:function(d,a){var b=$(CsEntityEdit._CONS_.FORM_ID).find("[name=id]").val();
var c=$("input[name='name']").val();if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(CsEntityEdit._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=true&csId="+b+"&type="+type,"客户["+c+"]下积分订单");
}};