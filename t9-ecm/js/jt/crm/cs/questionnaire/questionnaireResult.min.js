$(function(){var a=new QuestionnaireResult();a.init();});function QuestionnaireResult(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;
this.itemPos=null;}QuestionnaireResult._CONS_={EDIT_URL:ctx+"/cs/questionnaire/questionnaireResult/edit.htm",DETAIL_URL:ctx+"/cs/questionnaire/questionnaireResult/detail.htm",DELETE_URL:ctx+"/cs/questionnaire/questionnaireResult/delete.htm",SAVE_ADD_URL:ctx+"/cs/questionnaire/questionnaireResult/saveAdd.htm",SAVE_EDIT_URL:ctx+"/cs/questionnaire/questionnaireResult/saveEdit.htm",LIST_DATA_URL:ctx+"/cs/questionnaire/questionnaire/listData.htm",QUE_ITEM_URL:ctx+"/cs/questionnaire/questionnaireItem/listData.htm",EXPORT_ALL_URL:ctx+"/cs/questionnaire/questionnaireResult/exportAll.htm",EXPORT_QUE_URL:ctx+"/cs/questionnaire/questionnaireResult/export.htm",EDIT_FORM_ID:"questionnaireResultForm",GRID:"#questionnaireResultGrid",PAGER:"#questionnaireResultPager"};
QuestionnaireResult.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadQuestionnaireItem();}},_loadQuestionnaireItem:function(){var a=this;
var b=QuestionnaireResult._CONS_.LIST_DATA_URL+"?status=actived";FormUtils.loadData(b,function(e){if(e&&e.rows&&e.rows.length>0){var d=e.rows;var f=new StringBuffer();
for(var c=0;c<d.length;c++){f.append("<li class='qureLi' data-id='"+d[c].id+"' data-name='"+d[c].name+"'>"+d[c].name+"<i class='fa fa-pencil'></i></li>");
}$("#questionnaireList").empty().append(f.toString());}else{DialogUtils.warning("提示","目前不存在问卷！");}});},_buildItemList:function(c){var g=new StringBuffer();
for(var d=0;d<c.length;d++){var n=false;var e="";var f="";if(c[d].isRequired=="y"){f="isRequiredUl";n=true;e="&nbsp;<span class='tipRequired' style='color:red;display:none;'>必答</span>";
}g.append("<div class='questionDiv "+f+"' style='margin-top:10px;border-bottom: 1px solid #EFEFEF;'>");g.append("<div class='questionTitle "+(n?"isMustQa":"")+"' id='"+c[d].id+"'>");
g.append(c[d].order+"&nbsp;、"+c[d].question);g.append("<font color='#999' style='font-size: 0.9em;'>");if("single"==c[d].type){g.append("&nbsp;【单选题】"+e);
}else{if("multi"==c[d].type){g.append("&nbsp;【多选题】"+e);}else{if("bool"==c[d].type){g.append("&nbsp;【是非题】"+e);}else{if("common"==c[d].type){g.append("&nbsp;【问答题】"+e);
}}}}g.append("</font>");g.append("</div>");g.append("<div class='questionRadioDiv'>");if("single"==c[d].type){var m=c[d].options.split("|");var h=c[d].replyOpts;
g.append("<ul class='queOption singleUl'>");for(var a=0;a<m.length;a++){g.append("<li class='radioLi'>").append('<div class="radio radio-success radio-inline">').append("<input class='single' type='radio' name='single"+c[d].id+"' isChecked='"+(m[a]==h?"y":"n")+"' value='"+m[a]+"'"+(m[a]==h?"checked":"")+">").append('<label for="single'+c[d].id+'">'+m[a]+"</label>").append("</div>").append("</li>");
}g.append("</ul>");}else{if("multi"==c[d].type){var m=c[d].options.split("|");var h=c[d].replyOpts.split("|");g.append("<ul class='queOption multiUl'>");
for(var b=0;b<m.length;b++){var l=$.inArray(m[b],h);g.append("<li class='multiLi'><input "+(l=="-1"?"":"checked")+" isChecked='"+(l=="-1"?"n":"y")+"' class='multi jt-middle-check'  type='checkbox' name='multi' value='"+m[b]+"'>"+m[b]+"</li>");
}g.append("</ul>");}else{if("bool"==c[d].type){var h=c[d].replyOpts;g.append("<ul class='queOption boolUl'>");g.append("<li class='radioLi'>").append('<div class="radio radio-success radio-inline">').append("<input class='bool' type='radio' name='bool"+c[d].id+"' isChecked='"+(h=="是"?"y":"n")+"' value='是'"+(h=="是"?"checked":"")+">").append('<label for="single'+c[d].id+'">是</label>').append("</div>").append("</li>").append("<li class='radioLi'>").append('<div class="radio radio-success radio-inline">').append("<input style='margin-left:20%;margin-right: 5px;' type='radio' isChecked='"+(h=="是"?"y":"n")+"' name='bool"+c[d].id+"' value='否'"+(h=="否"?"checked":"")+">").append('<label for="single'+c[d].id+'">否</label>').append("</div>").append("</li>");
g.append("</ul>");}else{if("common"==c[d].type){var h=c[d].replyOpts;g.append("<textarea class='form-control commonText queOption' rows='5'>"+h+"</textarea>");
}}}}g.append("</div>");g.append("</div>");}g.append("<div class='bottomTip'>");g.append("<div class='questionBottomTip' style='font-size:1.2em;margin:0 auto;margin-top:30px;color:#5e5e5e;'>感谢您对本次调研的关注和支持，您的意见和建议将是我们工作开展的重要目标！</div>");
g.append("</div>");return g.toString();},_bulidItemPos:function(e){var b=this;var a=[];for(var c=0;c<e.length;c++){var d={};d.qnId=e[c].qnId;d.csId=csId;
d.questionId=e[c].id;d.question=e[c].question;d.type=e[c].type;a.push(d);}b.itemPos=a;},_loadQueItem:function(f,d){var b=this;var c=QuestionnaireResult._CONS_.QUE_ITEM_URL+"?qnId="+f+"&csId="+csId;
var a=false;var e="";d="<span style='color: #5A83E5;'>"+d+"</span>";FormUtils.loadData(c,function(h){if(h&&h.length>0){var j=new StringBuffer();b._bulidItemPos(h);
for(var g=0;g<h.length;g++){if(h[g].replyOpts){a=true;e="<br/><span id='hasReplyed'>您已经完成了该问卷，您还可以选择</span><span id='againReply'>重答</span>";break;}}j.append("<div class='box'>");
j.append("<div class='headTitle item' style='text-align:center;'>");j.append("<h1 id='QuestionnaireName' >"+d+e+"</h1></div>");j.append("<div class='explainDiv item'>");
j.append("<div style='display:none;'><img src='"+ctx+"/img/jt/logos/t9-wihte.png' style='height: 35px;margin: 5px 15px;'></div>");j.append("<div class='col-sm-12' style='font-size:1.2em;padding-bottom:10px;color:#5e5e5e;'>尊敬的客户：<br>&emsp;&emsp;您好，感谢您对我们工作的支持！为便于为您提供更好的产品和服务，我们特设计此调查问卷。该问卷以不记名方式，希望得到您最真实、最宝贵的建议。所有调研结论及成果不用做其他商业用途，再次感谢您对我们工作的支持！</div>");
j.append("</div>");j.append("<div class='itemsList item'><fieldset class='fieldset'>");j.append(b._buildItemList(h));j.append("</fieldset></div>");j.append("<div class='submitDiv' style='padding-bottom:40px;margin-top:40px;text-align: center;'>");
j.append("<button type='button' style='font-size: 20px;padding:5px 30px;"+(a?"display:none;":"")+"' class='jt-btn submitButton'>提交</button>");j.append("<button type='button' style='font-size: 14px;"+(a?"":"display:none;")+"' class='jt-btn' id='exportQue'>导出该问卷</button>");
j.append("</div>");j.append("</div>");$("#questionItemDiv").empty().append(j.toString());if(a){$(".questionRadioDiv").find("input,textarea").attr("disabled","disabled");
$(".submitButton").attr("disabled","disabled");}else{}}else{$("#questionItemDiv").empty();DialogUtils.error(msgCode.ERROR,"该问卷不存在问题");$("#exportQue").hide();
}});},_bindEventHander:function(){var a=this;$(document).on("click",".qureLi",function(){var c=$(this).attr("data-id");var b=$(this).attr("data-name");
$("#isRequiredInput").val("n");$(".qureLi").removeClass("active");$(this).addClass("active");if(c){a._loadQueItem(c,b);$(".qare-content-layer").stop().animate({"scrollTop":0},"fast");
}else{$("#questionItemDiv").empty();}});$(document).on("click",".prevBtn",function(){});$("#"+QuestionnaireResult._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+QuestionnaireResult._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+QuestionnaireResult._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(document).on("click",".submitButton",function(){var d=a._bindFormValidation();var e=$("#isRequiredInput").val();if(d){var f=a._buildData();if(f&&f.length>0){var c=0;
for(var b=0;b<f.length;b++){if(f[b].options){c++;}}if(c>0){a._saveResult(f,e);}else{DialogUtils.error("提示","您未答任何题，不能提交。");}}}});$(document).on("change","input:radio[class=single],input:radio[class=bool]",function(){$(this).closest(".questionDiv").find(".tipRequired").hide();
});$(document).on("click",".radioLi",function(){var b=$(this).find("input");if(b.is(":disabled")){return false;}if(b.prop("isChecked")=="y"){b.prop("isChecked","n");
b.prop("checked",false);}else{b.prop("isChecked","y");$(this).siblings().find("input").prop("isChecked","n");$(this).siblings().find("input").prop("checked",false);
b.prop("checked",true);}});$(document).on("click",".multiLi",function(){var b=$(this).find("input");if(b.is(":disabled")){return false;}if(b.prop("isChecked")=="y"){b.prop("isChecked","n");
b.prop("checked",false);}else{b.prop("isChecked","y");b.prop("checked",true);}});$(document).on("change","textarea",function(){var b=$(this).val();if(b){$(this).closest(".questionDiv").find(".tipRequired").hide();
}else{$(this).closest(".questionDiv").find(".tipRequired").show();}});$(document).on("change","input:checkbox[class=multi]",function(){var b=$(this).closest(".multiUl").find("input[type='checkbox']:checked").length;
if(b>0){$(this).closest(".questionDiv").find(".tipRequired").hide();}else{$(this).closest(".questionDiv").find(".tipRequired").show();}});$(document).on("click","#exportCsQueAll",function(){$(this).attr("disabled","disabled");
FormUtils.submit(QuestionnaireResult._CONS_.EXPORT_ALL_URL,{"csId":csId},function(b){$("#exportCsQueAll").removeAttr("disabled");if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){$("#exportCsQueAll").removeAttr("disabled");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click","#exportQue",function(){$(this).attr("disabled","disabled");var b=$(".qureLi.active").attr("data-id");FormUtils.submit(QuestionnaireResult._CONS_.EXPORT_QUE_URL,{"csId":csId,"id":b},function(c){$("#exportQue").removeAttr("disabled");
if(c.success){DialogUtils.success(msgCode.INFO,c.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){$("#exportQue").removeAttr("disabled");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click","#againReply",function(){$("#isRequiredInput").val("y");DialogUtils.confirmWithOptions({title:"确认要重新回答此问卷吗？",text:"重新回答后之前的问卷问答会被覆盖，请谨慎操作！",confirmButtonText:"确认",yesFunc:function(){$(".questionRadioDiv").find("input,textarea").removeAttr("disabled");
$("#againReply").hide();$("#hasReplyed").hide();$(".submitButton").removeAttr("disabled").show();}});});},_saveResult:function(d,c){var a=this;var b=QuestionnaireResult._CONS_.SAVE_ADD_URL+"?isRequired="+c;
ButtonUtils.disableBtn("submitButton");$.ajax({type:"post",url:b,dataTpye:"json",contentType:"application/json",data:JSON.stringify(d),success:function(e){if(e){$(".fieldset").find("input,select,textarea").attr("disabled","disabled");
DialogUtils.success("提示","感谢您的参与!");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}}});},_buildData:function(){var c=this;var a=c.itemPos;var b=$(".questionDiv");
for(var d=0;d<a.length;d++){var e=a[d];b.each(function(){var g=$(this).find(".questionTitle").attr("id");if(e.questionId==g){var h=$(this).find(".queOption");
var i="";if(h.is(".singleUl")){i=h.find("input:radio:checked").val();}else{if(h.is(".multiUl")){var f=$(this).find("input:checkbox:checked");var j=f.length;
f.each(function(k){if(k==j-1){i=i+$(this).val();}else{i=i+$(this).val()+"|";}});}else{if(h.is(".boolUl")){i=h.find("input:radio:checked").val();}else{if(h.is(".commonText ")){i=h.val();
}}}}e.options=i;return;}});}return a;},_bindFormValidation:function(){var a=$(".questionDiv.isRequiredUl");var b=0;if(a.length>0){a.each(function(){var d=$(this).find(".questionRadioDiv");
if(d.find(".singleUl").length>0){var c=d.find(".singleUl");var e=c.find('input:radio[class="single"]:checked').val();if(e==null){$(this).find(".tipRequired").show();
b++;}else{$(this).find(".tipRequired").hide();}}else{if(d.find(".multiUl").length>0){var e=d.find(".multiUl").find("input[type='checkbox']:checked").length;
if(e>0){$(this).find(".tipRequired").hide();}else{$(this).find(".tipRequired").show();b++;}}else{if(d.find(".boolUl").length>0){var c=d.find(".boolUl");
var e=c.find('input:radio[class="bool"]:checked').val();if(e==null){$(this).find(".tipRequired").show();b++;}else{$(this).find(".tipRequired").hide();}}else{if(d.find(".commonText").length>0){var e=d.find(".commonText").val();
if(e){$(this).find(".tipRequired").hide();}else{$(this).find(".tipRequired").show();b++;}}}}}});}if(b>0){DialogUtils.error("提示","存在必填项，请填答。");return false;
}return true;},};