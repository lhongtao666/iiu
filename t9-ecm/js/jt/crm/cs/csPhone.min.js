function CsPhone(){this.hadInit=false;}CsPhone._CONS_={FIND_PHONES_URL:ctx+"/crm/cs/csEntity/findPhonesByCsId.htm",FIND_CS_BY_PHONE:ctx+"/crm/cs/csEntity/getByPhone.htm",GET_PHONE_AREA:ctx+"/crm/cs/csPhoneArea/getArea.htm",VALID_PHONE:ctx+"/crm/cs/csEntity/validPhoneIsUsed.htm",DELETE_PHONE:ctx+"/crm/cs/csEntity/deletePhone.htm",};
CsPhone.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindEventHandler();}},_bindEventHandler:function(){var a=this;$(".showInvalidPhone").on("click",function(){$(this).hide();
$(".hideInvalidPhone").show();$("#invalidPhoneNumDiv").show();});$(".hideInvalidPhone").on("click",function(){$(this).hide();$(".showInvalidPhone").show();
$("#invalidPhoneNumDiv").hide();});$(document).on("click",".addCsPhone",function(){$("#phoneNumDiv").append(a.genNewTemplate());});$("#phoneNumDiv").on("click",".removePhone",function(){$(this).parents(".form-group").remove();
});$("#phoneNumDiv").on("click",".makePhone",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;}$(".makePhone").addClass("BtnFlag");
$(".makePhoneAddZero").addClass("BtnFlag");}var f=$(this).attr("attr-num");var d=new Date().getTime()+"";var c="";var g=JTEncoder.encode(f);var e=JTEncoder.encode(f+c+d);
var b=CryptoUtils.encrypt(g+e,f,d);var h={number:f,encoder1:g,encoder2:e,checkCode:b,randomCode:d,};if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");
$(".makePhoneAddZero").removeClass("BtnFlag");},5000);}});$("#phoneNumDiv").on("click",".makePhoneAddZero",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;
}$(".makePhone").addClass("BtnFlag");$(".makePhoneAddZero").addClass("BtnFlag");}var b=$(this).attr("attr-num");var c=/^(((1[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{9})$/;
FormUtils.loadData(CsPhone._CONS_.CALL_PHONE_URL+"?number="+b,function(e){var d=e.msg.toString();if(d.startsWith("020")){b=d.substring(3);}else{b=d;}if(c.test(b)){window.top.jtCtiService.dialout("90"+b);
}else{window.top.jtCtiService.dialout("9"+b);}});if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");$(".makePhoneAddZero").removeClass("BtnFlag");
},5000);}});$("#phoneNumDiv").on("click",".sendMessage",function(){var f=this;var c=$("#csEntityForm").find("[name=id]").val();var d=new SendMessage();
var e=$(f).attr("attr-num");if(!e){e=$(f).parent().parent().parent().parent().find(".newPhone").val();var b={csId:c,number:e,maskNum:e,fn:function(g){d.initTable({csId:g});
}};d.openSendMessageView(b);}else{var b={csId:c,number:e,maskNum:$(f).attr("attr-maskNum"),fn:function(g){d.initTable({csId:g});}};d.openSendMessageView(b);
}});$("#phoneNumDiv").on("click",".viewPhone",function(){var c=this;var b=$(this).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DECRYPT_NUMBER_URL+"?number="+b,function(e){var d=e.msg;
$(c).parent().parent().parent().find(".oldPhone").val(d);});});$(document).on("blur",".newPhone",function(){var e=this;var c=$(e).val();var d=$(e).parent().next().find("select").val();
$(e).parents(".form-group").eq(0).find("p").text("").hide();$(e).parents(".form-group").eq(0).find(".tip").text("").hide();if(c){if(a._checkIsPhone(c,d)){a._getPhoneArea(c,function(f){$(e).parents(".form-group").eq(0).find(".tip").css("color","green").text(f.province+f.city).show();
});a.findCsByPhone(c,function(g){if(g&&g.success){var h=JSON.parse(g.msg);var f="号码重复，客户["+h.code+"]已拥有该号码";$(e).parents(".form-group").eq(0).find("p").text(f).show();
}});}else{if(d=="座机"){if(!a._checkIsTel(c)){var b="座机号格式错误";$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text(b).show();}}else{$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text("非手机类型请选座机").show();
}}}});$(document).on("change",".phoneType",function(){$(this).attr("attr-hasChange","true");var b=$(this).parent().prev().find(".newPhone");if(b){b.trigger("blur");
}});$("#phoneNumDiv").on("click",".deletePhone",function(){var b=this;DialogUtils.confirmWithOptions({title:"是否要删除选中的联系电话",text:"点击确认将删除，并无法恢复",confirmButtonText:"确认",yesFunc:function(){var c=$("#csEntityForm").find("[name=id]").val();
var d=$(b).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DELETE_PHONE+"?number="+d+"&csId="+c,function(e){if(e.success){DialogUtils.success("成功","删除号码成功");
$(b).parents(".form-group").remove();}else{DialogUtils.error("失败","删除号码失败");}});}});});},_getTypeSelectStr:function(a,c){var b=this;var d=new StringBuffer();
d.append("<select class='form-control phoneType' "+(a?" disabled='disabled'":"''")+">");if(c&&"首选"==c){d.append("<option value='首选' selected>首选</option>");
}else{d.append("<option value='首选'>首选</option>");}if(c&&"停用"==c){d.append("<option value='停用' selected>停用</option>");}else{d.append("<option value='停用'>停用</option>");
}if(c&&"本人"==c){d.append("<option value='本人' selected>本人</option>");}else{d.append("<option value='本人'>本人</option>");}if(c&&"老公"==c){d.append("<option value='老公' selected>老公</option>");
}else{d.append("<option value='老公'>老公</option>");}if(c&&"老婆"==c){d.append("<option value='老婆' selected>老婆</option>");}else{d.append("<option value='老婆'>老婆</option>");
}if(c&&"家人"==c){d.append("<option value='家人' selected>家人</option>");}else{d.append("<option value='家人'>家人</option>");}if(c&&"他人"==c){d.append("<option value='他人' selected>他人</option>");
}else{d.append("<option value='他人'>他人</option>");}if(c&&"朋友"==c){d.append("<option value='朋友' selected>朋友</option>");}else{d.append("<option value='朋友'>朋友</option>");
}if(c&&"座机"==c){d.append("<option value='座机' selected>座机</option>");}else{d.append("<option value='座机'>座机</option>");}d.append("</select>");return d.toString();
},_getCsPhoneButtonStr:function(c){var e=new StringBuffer();if("actived"==c.status){var d=ctx+"/img/jt/phone.png'";var a=ctx+"/img/jt/phoneAddZero.png";
var b=ctx+"/img/jt/message.png";e.append("<div class='col-sm-4' style='display: inline;'>");if(ResUtils.canShow("csEntity.button.deletePhone")||ResUtils.canShow("csEntity.button.deletePhoneSub")||ResUtils.canShow("csEntity.button.deletePhoneSearch")||ResUtils.canShow("csEntity.button.deletePhoneTask")){e.append("<span style='line-height:30px;''><i class='fa fa-remove deletePhone' title='删除号码'' style='color: red; cursor: pointer;'' attr-num='"+c.number+"' ></i></span>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneBtn")||ResUtils.canShow("csEntity.button.callPhoneBtnSub")||ResUtils.canShow("csEntity.button.callPhoneBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='本地号码' src='"+d+"' class='makePhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneAddZeroBtn")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSub")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='外地号码加0' src='"+a+"' class='makePhoneAddZero' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.sendMsgBtn")||ResUtils.canShow("csEntity.button.sendMsgBtnSub")||ResUtils.canShow("csEntity.button.sendMsgBtnSearch")||ResUtils.canShow("csEntity.button.sendMsgBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='短信' src='"+b+"' class='sendMessage' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if((ResUtils.canShow("soDeliver.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtnSub")||ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")||ResUtils.canShow("csEntity.button.viewPhoneBtnTask"))&&c.number){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='查看联系电话明文' src='"+ctx+"/img/jt/view.png' class='viewPhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>");
}e.append("</div>");}else{e.append("<span class='col-sm-3' style='color:red;line-height:30px;'>无效号码</span>");}return e.toString();},initTemplate:function(b){var a=this;
var c=new StringBuffer();c.append("<div class='form-group'>");c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control oldPhone' attr-id='"+b.id+"' validateType='default' value='"+b.maskPhone+"' readonly>");
c.append("<input type='hidden' value='"+b.number+"' readonly>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr("actived"!=b.status,b.type));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genInTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control' validateType='default' value='"+a.maskPhoneNum(b.phone)+"' readonly>");
c.append("<input type='hidden' readonly class='newPhone' value='"+b.phone+"'>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-1' style='color:red;line-height:30px;'>通话</span>");c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genNewTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control newPhone' validateType='default' value=''>");
c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));c.append("</div>");if(!b){c.append("<span class='col-sm-1' style='line-height:30px;'><i class='fa fa-remove removePhone' title='删除号码' style='color: red; cursor: pointer;'></i></span>");
}c.append("<span class='col-sm-3 tip' style='line-height:30px;'></span>");if(b){c.append("<div class='col-sm-1'>");c.append("<button type='button' class='btn btn-sm btn-outline btn-primary addCsPhone'>添加</button>");
c.append("</div>");}c.append("</div>");c.append("</div>");c.append("<p class='ceshi' style='color:red;display:none;'></p>");return c.toString();},csPhoneData2Json:function(){var f=$(".newPhone");
var h=$(".oldPhone");var c=[];if(f&&f.length>0){for(var d=0;d<f.length;d++){if($(f[d]).val()){var e=$(f[d]).parent().next().find("select").val();var g=$.trim($(f[d]).val());
var b=$(f[d]).parent().next().next().find("input").val();if(e=="座机"&&g.indexOf("&")>-1){g=g.substr(0,g.indexOf("&"));}var a={id:"",pk:"",phone:g,type:e,linkman:b};
c.push(a);}}}if(h&&h.length>0){for(var d=0;d<h.length;d++){var e=$(h[d]).parent().next().find("select").val();var g=$(h[d]).next().val();var b=$(f[d]).parent().next().next().find("input").val();
if("true"==$(h[d]).parent().next().find("select").attr("attr-hasChange")){var a={id:$(h[d]).attr("attr-id"),pk:$(h[d]).attr("attr-id"),phone:"",number:g,type:e,linkman:b};
c.push(a);}}}return JSON.stringify(c);},bindFormValidation:function(){var a={rules:{"phone":{required:true,mobile:true,maxlength:["20"],}}};FormUtils.bindFormValidation("csPhoneAdd",a);
},maskPhoneNum:function(a){if(a){return PhoneEncryptUtils.encryptPhone(a);}return"";},loadData:function(b){var a=this;FormUtils.loadData(CsPhone._CONS_.FIND_PHONES_URL+"?csId="+b.csId,function(f){var e=new StringBuffer();
var d=new StringBuffer();if(f&&f.length>0){for(var c=0;c<f.length;c++){if("actived"==f[c].status){e.append(a.initTemplate(f[c])+"");$("#csFollowForm").find("input[name='csFollowPhone']").val(f[c].number);
}else{d.append(a.initTemplate(f[c],false)+"");}}}$("#phoneNumDiv").empty().append(e.toString());$("#phoneNumDiv").append(a.genNewTemplate(true));$("#invalidPhoneNumDiv").empty().append(d.toString());
if(d.toString().length>0){$(".showInvalidPhone").show();}else{$(".showInvalidPhone").hide();}if(b.fn&&typeof b.fn=="function"){b.fn();}},function(){},true);
},_checkIsPhone:function(a,c){if(c&&("微信"==c)){return true;}if(c&&("座机"==c)){return false;}var b=/^(1+\d{10})$/;if(b.test(a)){return true;}return false;
},_checkIsTel:function(a,c){if(c!="座机"&&c!=undefined){return false;}if(a.length<=6){return false;}else{if(a.startsWith("0")){return true;}else{if(isCheckQuhao&&isCheckQuhao=="y"){var b=/(^[0-9]*)$/;
if(b.test(a)){return true;}return false;}else{return true;}}}},_descryptPhoneNum:function(a,c,b){$.ajax({type:"GET",url:CsPhone._CONS_.DESCRYPT_PHONE_NUM+"?number="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success&&b&&typeof b=="function"){b(d.msg);
}}});},findCsByPhone:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.FIND_CS_BY_PHONE+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(b&&typeof b=="function"){b(c);
}}});},_getPhoneArea:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.GET_PHONE_AREA+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success){if(b&&typeof b=="function"){var c=JSON.parse(d.msg);
b(c);}}}});},vaildPhondIsUsed:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.VALID_PHONE+"?phones="+a.toString(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c.success){b();
}else{DialogUtils.error("错误","新增的手机号码重复");}}});},};