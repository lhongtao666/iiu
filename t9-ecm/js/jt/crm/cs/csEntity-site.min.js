CsAssign.assign=function(){};function CsAssign(c,a,b,d,e){this.csEntityIds=c;this.limitCount=d;this.assignType=a;this.clearParam=b;this.maxLength=null;
this.employeeList=[];this.selectedEmployee=[];this.selectedEmployeeMap={};this.extensionOption=e;}CsAssign.prototype={init:function(){$("#selected-emp-container").empty();
$("#selected-emp-count").empty().append(0);$("#csCountContainer").empty();$("#csAssignResultContainer").empty();$("#select-by-group").val("");$("input[name=assignOgn]").val("");
$("input[name=assignOgnId]").val("");$("#select-employee").val("");$("#employee-select-all").prop("checked",false);this.selectedEmployee=[];this.selectedEmployeeMap={};
if((this.csEntityIds&&this.csEntityIds.length&&this.csEntityIds[0]=="")&&this.assignType!="clear"){return;}var a=this;if(this.assignType=="clear"){if(this.assignType=="clear"){FormUtils.loadData(ctx+"/crm/cs/csEntity/assign.htm?assignType=clear&"+a.clearParam,function(b){a.csEntityIds=b;
$("#csCountContainer").append(+a.csEntityIds.length);a.maxLength=a.csEntityIds.length;});}}else{$("#csCountContainer").append(this.csEntityIds.length);
a.maxLength=this.csEntityIds.length;}this._bindEventHanlder();this._initEmployee();this._openAssignLayer();this._bindFormValidation();},_dealSyle:function(){var a=$("#assignContainer").find(".modal-body").height()-$("#assiginPartyContainer").outerHeight()-$("#assiginEmployeeContainer").outerHeight()-28-34-31-31;
$("#csAssignResultDiv").height(a);},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation("tableForm",a);},_openAssignLayer:function(){self=this;
$("#assignModalLabel").html(self.limitCount>0?"分配客户资源&emsp;<span>系统限制单次最多分配 [&nbsp;<font>"+self.limitCount+"</font>&nbsp;] 个客户</span>":"分配客户资源");$("#assignContainer").modal("show");
},_saveAssign:function(){var c=$("#assignContainer"),d=$("#csAssignResultContainer",c).attr("csTypeVal"),e=this;var b=e.csEntityIds.slice(0);if($("#csAssignResultContainer tr",c).length){var a=[];
$("#csAssignResultContainer tr",c).each(function(){var h=parseInt($(this).find(".csEntityCount").val());var g=b.splice(0,h);a.push({employeeId:$(this).attr("employeeIdVal"),csEntityIds:g.join(","),});
});var f={resultJson:JSON.stringify(a)};if(this.assignType=="clear"||this.assignType=="csPhone"){f.csType="csPhone";}else{f.csType="csEntity";}ButtonUtils.disableBtn("saveAssign");
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",f,function(g){ButtonUtils.enableBtn("saveAssign");if(g.success){layer.close(e.layerIndex);if($(".csEntitySearch").length){$(".csEntitySearch").trigger("click");
}if($(".insideLineSheetRecordSearch")){if(e.extensionOption&&e.extensionOption.successFn){e.extensionOption.successFn(g);}else{jQuery(".insideLineSheetRecordSearch").trigger("click");
}}if(e.extensionOption&&e.extensionOption.successFn){}else{$("#assignContainer").modal("hide");}}else{if(e.extensionOption&&e.extensionOption.errorFn){var h=$("#assignContainer");
e.extensionOption.errorFn(g,h);}else{DialogUtils.error(msgCode.ERROR,g.msg,c);}}$(".layui-layer-btn0").show();},function(g){ButtonUtils.enableBtn("saveAssign");
DialogUtils.error(msgCode.ERROR,g?g:"操作失败",c);});}else{DialogUtils.error(msgCode.ERROR,"请生产分配方案",c);$(".layui-layer-btn0").show();}},_initEmployee:function(){var a=this;
var b=ctx+"/crm/ou/employee/search.htm?keyword=";FormUtils.loadData(b,function(c){a.employeeList=c.value;a._createEmployeeTable();});},_createEmployeeTable:function(){var c=this.employeeList;
var b=$("input[name='employee-online']")[0].checked;var d=new StringBuffer();for(var a=0;a<c.length;a++){d.append('<tr id="employee-table-'+c[a].id+'" '+(b&&c[a].isOnline!="y"?'style="display:none;"':"")+" >").append('<td width="8%"><input type="checkbox"').append(' data-id="'+c[a].id+'"').append(' data-groupId="'+c[a].groupId+'"').append(' data-name="'+c[a].name+'"').append(' data-aid="'+c[a].aid+'"').append(' data-orgName="'+c[a].orgName+'"').append(' data-isOnline="'+(c[a].isOnline?c[a].isOnline:"n")+'"').append(' data-newCs="'+c[a].newCs+'"').append(' data-csCount="'+c[a].csCount+'"></input></td>').append('<td width="25%">'+c[a].name+":"+c[a].aid+"</td>").append('<td width="25%">'+c[a].orgName+"</td>").append('<td width="20%" class="blue">'+c[a].newCs+"</td>").append('<td width="20%">'+(c[a].isOnline&&c[a].isOnline=="y"?'<span class="red">在线</span>':"离线")+"</td>").append("</tr>");
}$("#select-employee-table").empty().append(d.toString());},_addSelectedEmployee:function(c){var d=new StringBuffer();for(var b=0;b<c.length;b++){var a=c[b];
if(!this.selectedEmployeeMap.hasOwnProperty(a.id)){d.append('<div class="emp emp-items" id="emp-'+a.id+'"').append(">").append("<span>"+a.aid+":"+a.name+'（新进<span class="blue">'+a.newCs+"</span>）</span>").append('<div class="emp-remove deleteEmployeeBtn">').append('<i class="fa fa-remove"></i>').append("</div>").append("</div>");
this.selectedEmployee.push(a);this.selectedEmployeeMap[a.id]=a.id;$("#employee-table-"+a.id).find("input[type='checkbox']").prop("checked",true);}}$("#selected-emp-container").append(d.toString());
$("#selected-emp-count").empty().append(this.selectedEmployee.length);this._dealSyle();},_selectEmployeeByGroupIds:function(){var c=$("input[name=assignOgnId]").val();
if(c==""){DialogUtils.error(msgCode.ERROR,"请选择部门",$("#assignContainer"));return;}var a=this;var d=$("input[name='group-online']")[0].checked;var b=ctx+"/crm/ou/employee/searchBygroup.htm?groupIds="+c+"&isOnline="+(d?"y":"n");
FormUtils.loadData(b,function(e){a._addSelectedEmployee(e.value);});},_createEmployeeLi:function(a){var b=new StringBuffer();b.append("<li idVal='").append(a.id).append("' nameVal='").append(a.name).append("' csCountVal='").append(a.csCount).append("' orgNameVal='").append(a.orgName).append("' aidVal='").append(a.aid).append("' ><a href='javascript: void(0);'>").append(a.name).append("&nbsp;&nbsp;&nbsp;&nbsp;<button class='btn btn-danger btn-xs deleteEmployeeBtn' type='button'><i class='fa fa-remove'></i></button></a></li>");
return b.toString();},_assign:function(){var f=0;var g=this.selectedEmployee;for(var d=0;d<g.length;d++){g[d].csEntityIds=[];}var h=new StringBuffer();
var e=0;var d=0;var b=this;for(var d=0;d<Math.ceil(this.csEntityIds.length/parseFloat(g.length));d++){if(e>=this.csEntityIds.length){break;}for(var c=0;
c<g.length;c++){if(e>=this.csEntityIds.length){break;}g[c].csEntityIds.push(this.csEntityIds[e]);g[c].newCsCount=g[c].newCsCount+1;e++;}}for(var d=0;d<g.length;
d++){if(g[d].csEntityIds.length==0){break;}h.append("<tr employeeIdVal='"+g[d].id+"' >");h.append('<td style="width: 16%">');h.append(g[d].name);h.append(":");
h.append(g[d].aid);h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].orgName);h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].csCount||0);
h.append("</td>");h.append('<td style="width: 20%">');var a=(b.maxLength-(g[d].csMax||0))?b.maxLength:g[d].csMax;h.append("<input required='true' min='1' max='"+a+"' digits='true' name='name"+b._generateCode()+"'  type='text'  valueVal='"+g[d].csEntityIds.length+"' value='"+g[d].csEntityIds.length+"' class='form-control csEntityCount'  validateType='default'>");
h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].isOnline&&g[d].isOnline=="y"?'<span class="red">在线</span>':"离线");h.append("</td>");
h.append('<td style="width: 16%">');h.append("<button disabled='disabled' class='btn btn-sm btn-outline btn-primary plusBtn' type='button'><i class='fa fa-plus'></i></button>");
h.append("&nbsp;&nbsp;<button class='btn btn-sm btn-outline btn-danger minusBtn' type='button'><i class='fa fa-minus'></i></button>");h.append("&nbsp;&nbsp;<button class='btn btn-sm btn-outline btn-danger deleteEmployeeTrBtn' type='class'><i class='fa fa-remove'></i></button>");
h.append("</td>");h.append("</tr>");}$("#csAssignResultContainer").empty().append(h.toString());$("#remindCsEntityContainer").empty().append(b.csEntityIds.length);
},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());
},_caculateRestCount:function(){var b=this;var a=$("#assignContainer");$("#tableForm",a).valid();var c=0;$("input.csEntityCount",a).each(function(){c=c+(parseInt($(this).val())||0);
});var d=b.maxLength-c;$("#remindCsEntityContainer").empty().append((b.csEntityIds.length-d)+"");if(!d){$(".plusBtn").attr("disabled",true);$(".minusBtn").attr("disabled",false);
}else{if(d>=b.maxLength){$(".plusBtn").attr("disabled",false);$(".minusBtn").attr("disabled",true);}else{$(".plusBtn").attr("disabled",false);$(".minusBtn").attr("disabled",false);
}}},_fiterEmployee:function(f){var e=$("input[name='employee-online']")[0].checked;var d=[];var b=$("input[name=assignOgn]").val();if(b!=null&&b!=""){d=b.split(",");
}for(var c=0;c<this.employeeList.length;c++){var a=this.employeeList[c];if(!this.selectedEmployeeMap.hasOwnProperty(a.id)){if((a.name.indexOf(f)!=-1||a.aid.indexOf(f)!=-1)&&self._fiterByGroupKey(d,a)){if(e&&a.isOnline!="y"){$("#employee-table-"+a.id).hide();
}else{$("#employee-table-"+a.id).show();}}else{$("#employee-table-"+a.id).hide();}}}},_fiterByGroupKey:function(e,c){if(e.length<=0){return true;}var a=false;
for(var d=0;d<e.length;d++){var b=e[d];if(c.groupKey.substring(0,b.length)==b){a=true;break;}}return a;},_bindEventHanlder:function(){var a=this;$("#saveAssign").off("click").on("click",function(){var c=ctx+"/crm/cs/csEntity/assign.htm";
var b=$("#assignContainer");if(!$("#tableForm",b).valid()){return;}var d=0;$("input.csEntityCount",b).each(function(){d=d+parseInt($(this).val());});if(a.maxLength&&a.maxLength&&a.maxLength<d){DialogUtils.error(msgCode.ERROR,"需要分配客户数超过可分配数目",b);
return;}a._saveAssign();});$("#assignContainer").off("shown.bs.modal").on("shown.bs.modal",function(){a._dealSyle();});$("#select-by-group").off("click").on("click",function(){var b={isMultiple:1,selectedGroupId:$("input[name=assignOgnId]").val(),container:"select-by-group",nolimit:true,isEqWidth:true,isAutoHeight:true,positionType:"dept_manager",fn:function(c,d){$("input[name=assignOgn]").val(d);
$("input[name=assignOgnId]").val(c);a.groupIds=c;var e=$("#select-employee").val();a._fiterEmployee(e);}};GroupUtils.selectGroupTreeBox(b);});$("#group-select-submit").off("click").on("click",function(){a._selectEmployeeByGroupIds();
});$("input[name='employee-online']").off("change").on("change",function(){var b=$("#select-employee").val();a._fiterEmployee(b);});$("body").on("click",function(b){if($(b.target).attr("id")=="select-employee"){return;
}if($(b.target).parents("#select-employee-container").length<=0){$("#select-employee-container").hide();}});$("#select-employee").off("keyup").on("keyup",function(){var b=$(this).val();
a._fiterEmployee(b);});$("#select-employee").off("focus").on("focus",function(){$("#select-employee-container").show();});$("#employee-select-all").off("click").on("click",function(d){var c=$(this)[0].checked;
if(c){$("#select-employee-table").find("tr:visible").find("input[type='checkbox']").prop("checked",c);var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");
var f=[];$.each(b,function(){var m=$(this).attr("data-id");var h=$(this).attr("data-name");var j=$(this).attr("data-aid");var k=$(this).attr("data-newCs");
var g=$(this).attr("data-csCount");var l=$(this).attr("data-isOnline");var i=$(this).attr("data-orgName");var e={id:m,name:h,aid:j,newCs:k,csCount:g,isOnline:l,orgName:i};
f.push(e);});a._addSelectedEmployee(f);}else{var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");$("#select-employee-table").find("tr:visible").find("input[type='checkbox']").prop("checked",c);
$.each(b,function(){var g=$(this).attr("data-id");$("#emp-"+g).remove();delete a.selectedEmployeeMap[g];for(var e=0;e<a.selectedEmployee.length;e++){if(a.selectedEmployee[e].id==g){a.selectedEmployee.splice(e,1);
break;}}});$("#selected-emp-count").empty().append(a.selectedEmployee.length);a._caculateRestCount();a._dealSyle();}});$("body").off("click","#select-employee-table tr").on("click","#select-employee-table tr",function(k){if(k.target.tagName=="INPUT"||k.target.tagName=="input"){}else{var p=$(this).find("input[type='checkbox']")[0].checked;
$(this).find("input[type='checkbox']").prop("checked",!p);}var f=$(this).find("input[type='checkbox']");var p=f[0].checked;var d=f.attr("data-id");var c=f.attr("data-name");
var g=f.attr("data-aid");var l=f.attr("data-newCs");var h=f.attr("data-csCount");var b=f.attr("data-isOnline");var n=f.attr("data-orgName");var o={id:d,name:c,aid:g,newCs:l,csCount:h,isOnline:b,orgName:n};
var m=[];m.push(o);if(p){a._addSelectedEmployee(m);}else{$("#emp-"+d).remove();delete a.selectedEmployeeMap[d];for(var j=0;j<a.selectedEmployee.length;
j++){if(a.selectedEmployee[j].id==d){a.selectedEmployee.splice(j,1);break;}}$("#selected-emp-count").empty().append(a.selectedEmployee.length);a._caculateRestCount();
a._dealSyle();}});$("#employee-select-submit").off("click").on("click",function(){var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");
var c=[];$.each(b,function(){var k=$(this).attr("data-id");var f=$(this).attr("data-name");var h=$(this).attr("data-aid");var i=$(this).attr("data-newCs");
var e=$(this).attr("data-csCount");var j=$(this).attr("data-isOnline");var g=$(this).attr("data-orgName");var d={id:k,name:f,aid:h,newCs:i,csCount:e,isOnline:j,orgName:g};
c.push(d);});$("#select-employee-table").find("input[type='checkbox']").prop("checked",false);$("#employee-select-all").prop("checked",false);a._addSelectedEmployee(c);
});$("#assignBtn").off("click");$("#assignBtn").on("click",function(){if($("#selected-emp-container .emp").length){a._assign();}else{DialogUtils.error(msgCode.ERROR,"请选择员工",$("#assignContainer"));
}});$("#csAssignResultContainer").off("blur",".csEntityCount").on("blur",".csEntityCount",function(){a._caculateRestCount();});$("#csAssignResultContainer").off("click",".deleteEmployeeTrBtn").on("click",".deleteEmployeeTrBtn",function(){$(this).parents("tr").remove();
a._caculateRestCount();});$("body").off("click","#selectEmployeeBtn").on("click","#selectEmployeeBtn",function(){var b=new EmployeesSelect();var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;
}b.init({isShowAllGroup:c,grantType:"/cs/",isOnlySelfGroup:1,isMultiple:1,mode:1,type:"positionContext",callBack:function(d){a._addSelectedEmployee(d);
}});});$("#selected-emp-container").off("click",".deleteEmployeeBtn").on("click",".deleteEmployeeBtn",function(){var c=$(this).parents(".emp").attr("id").replace("emp-","");
$(this).parents(".emp").remove();delete a.selectedEmployeeMap[c];for(var b=0;b<a.selectedEmployee.length;b++){if(a.selectedEmployee[b].id==c){$("#select-employee").trigger("keyup");
a.selectedEmployee.splice(b,1);break;}}$("#employee-table-"+c).find("input[type='checkbox']").prop("checked",false);$("#selected-emp-count").empty().append(a.selectedEmployee.length);
a._caculateRestCount();a._dealSyle();});$("#reset-emp-Btn").off("click").on("click",function(){$("#selected-emp-container").empty();a.selectedEmployee=[];
a.selectedEmployeeMap={};$("#selected-emp-count").empty().append(0);$("#select-employee").trigger("keyup");$("#select-employee-container").find("input[type='checkbox']").prop("checked",false);
a._dealSyle();});$("body").off("click","#csAssignResultContainer .plusBtn").on("click","#csAssignResultContainer .plusBtn",function(){var c=$(this).parents("tr").find("input");
var b=parseInt(c.val())+1;c.val(b);a._caculateRestCount();});$("body").off("click","#csAssignResultContainer .minusBtn").on("click","#csAssignResultContainer .minusBtn",function(){var c=$(this).parents("tr").find("input");
var b=c.val();b=b-1;c.val(b);a._caculateRestCount();});}};function EmployeesSelect(){}EmployeesSelect.prototype={init:function(b){var c=ctx+"/crm/ou/employee/selectEmployee.htm";
var e=new StringBuffer();for(var a in b){if(a!="callBack"){e.append("&"+a+"="+b[a]);}else{window.myCallBack=b.callBack;}}e.append("&treeNodeType=group");
var d=e.toString();parent.layer.open({type:2,title:b.title?b.title:"选择员工",maxmin:false,shadeClose:true,btn:["确定","取消"],area:["85%","83%"],scrollbar:false,content:c+"?1=1"+d,success:function(f,g){f.myCallBack=b.callBack;
},end:function(){window.parent.myCallBack=null;},yes:function(j,g){var f=parent.layer.getChildFrame("body",j);var l=[];if(b&&b.isMultiple==1){var l=$("#employeeGrid",f).jqGrid("getGridParam","selarrrow");
}else{var n=$("#employeeGrid",f).jqGrid("getGridParam","selrow");if(n){l.push(n);}}if(l.length<0){DialogUtils.error(msgCode.ERROR,"请选择员工",f);return;}var m=[];
for(var k=0;k<l.length;k++){var h=$("#employeeGrid",f).jqGrid("getRowData",l[k]);h.id=l[k];m.push(h);}if(b.callBack){b.callBack(m);}parent.layer.close(j);
}});},initSelectComponent:function(a){function b(c){var d=null;if(c.container){if((typeof c.container)=="string"){d=$("#"+c.container);if(d.length==0){d=$("."+c.container);
if(d.length==0){d=$("[name='"+c.container+"']");if(d.length==0){d=null;throw Error(c.container+"容器不存在");}}}}else{if(c.container.length){d=c.container;}}}return d;
}FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+a.groupId+"",function(g){if(a.fn){a.fn(g);return;}var c=b(a);c.empty();if(a.buildSelector){var d='<select class="form-control '+a.buildSelector.className+'" name="'+a.buildSelector.name+'" ></select>';
var f=$(d);c.append(f);c=f;}var h=new StringBuffer();h.append("<option value=''>请选择</option>");if(g&&g.length){for(var e=0;e<g.length;e++){if(a.selectedIds&&a.selectedIds.indexOf(g[e].id)>-1){h.append("<option selected='selected' value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");
}else{h.append("<option value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");}}}c.append(h.toString());if("chosen"==a.containerType){c.chosen("destroy");
c.chosen();}else{c.select2();}},null,true);},};function CsEav(){this.eavCommon=null;this.eavTag=null;this.csEavTag=null;}CsEav.prototype={init:function(){var b={bizType:"common",entityType:"jt_cs_entity",eavSetKey:"customer",containerId:"eavCommonContainer"};
this.eavCommon=new Eav(b);var a={bizType:"tag",entityType:"cs",eavSetKey:"cs_tag",isShowTag:true,containerId:"tagContainer"};this.eavTag=new Eav(a);this._bindEventHander();
},_bindEventHander:function(){var a=this;if(!isNewPage){$(document).on("click",".tabView",function(){$("#tagTableContainer").hide();$("#tagContainer").slideDown();
$(".tabView").attr("disabled",true);$(".shrinkView").attr("disabled",false);$(".csTagDown").animate({top:["0px","swing"]},250);$(".csTagUp").animate({top:["-25px","swing"]},250);
});$(document).on("click",".shrinkView",function(){$("#tagContainer").hide();$("#tagTableContainer").slideDown();$(".tabView").attr("disabled",false);$(".shrinkView").attr("disabled",true);
$(".csTagDown").animate({top:["0","swing"]},250);$(".csTagUp").animate({top:["-25px","swing"]},250);});}$(document).on("click",".csTagUp",function(){$(this).animate({top:["-25px","swing"]},250);
$(this).prev().animate({top:["0px","swing"]},250);$("#tagContainer").slideUp();$("#tagTableContainer").slideUp();});$(document).off("click",".csTagAddFollow").on("click",".csTagAddFollow",function(){layer.close(a.layerIndex);
var b=$(this);a.layerIndex=layer.open({type:1,title:"跟进记录",shade:false,btn:["保存","关闭"],area:["650px","400px"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,success:function(c,d){$("#csFollowForm").find("[name=type]").val("档案情况跟进");
var e="【"+b.attr("attrVal")+"】档案属性："+b.attr("optVal")+"。提醒内容：";if(b.attr("contentval")){e="【"+b.attr("attrVal")+"】档案属性："+b.attr("optVal")+"。档案记录："+b.attr("contentval")+"。提醒内容：";
}$("#csFollowForm").find("[name=content]").val(e);$("#csFollowForm").find('input[name="hasTask"][value="n"]').trigger("click");},yes:function(d,c){$("#csFollowForm").find(".saveAddFollow").trigger("click");
layer.close(a.layerIndex);}});});$(document).on("click",".uploadImage",function(){$("#recordUploader").show();var b=new UploadImageUtil();b._bindWebuploader();
});},loadDataEavCommon:function(b){var a=this;a.eavCommon.setEavSetKey(CsEntityEdit._CONS_.CUSTOMER_EAV_KEY);a.eavCommon.setEntityId(b.csId);a.eavCommon.renderEavForm(function(){var c=$("#eavCommonContainer");
var d=c.find(".form-group");$.each(d,function(g,e){var f=$(this).children("div");});if(b.isDetail){c.find("input").attr("disabled",true);c.find("button").hide();
c.find("select").attr("disabled",true);}});},loadDataEavTag:function(c,b){var a=this;a.eavTag.setEntityId(c.csId);a.eavTag.renderEavForm(function(e){var f=$("#tagContainer");
f.find("form legend").remove();if(c.isDetail){f.find("input").attr("disabled",true);f.find("button").hide();f.find("select").attr("disabled",true);}var d=$("#tagTableContainer");
a.eavTag.createCsEavTable(e,d);if(b){b();}});},getEavInfoParams:function(){return this.eavCommon.getEavParams();},getEavTagParams:function(){return this.eavTag.getEavParams();
},};var GroupUtils={loadGroupOptions:function(a){a.url=ctx+"/gl/ou/group/listData.htm";if(!a.positionType){a.url=a.url+"?type=dept_manager";}a.key="id";
a.keyName="name";a.caption="请选择部门";return OptionsBaseUtils.getOptions(a);},selectGroupTreeBox:function(a){var b={selectedIds:jQuery.isArray(a.selectedGroupId)?a.selectedGroupId.toString():a.selectedGroupId,container:a.container,treeId:"menuContentForGroup"+a.container.split(" ")[0],isMultiple:a.isMultiple,otherParam:{selectedGroupId:a.selectedGroupId},url:ctx+"/gl/ou/group/listData.htm",fn:a.fn,isSale:a.isSale,positionType:a.positionType,hideSale:a.hideSale?a.hideSale:false,isSmsConfigHtml:a.isSmsConfigHtml,isReDisabled:a.isReDisabled?a.isReDisabled:false};
if(a.isEqWidth){b.isEqWidth=true;}if(a.isAutoHeight){b.isAutoHeight=true;}if(!b.positionType){b.url=b.url+"?type=dept_manager";}else{b.url=b.url+"?type="+b.positionType;
}if(a.isSale){b.url=b.url+"?type="+b.positionType+"&isSale=y";}if(a.agentId){b.url=b.url+"&agentId="+a.agentId;}b.dataFilter=function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"&&!b.hideSale){d.name=d.name+"【销】";d.font={"color":"red"};}}}if(a.dataFilter){return a.dataFilter(f,c,g);}else{return g;
}};CateUtils.selectTreeBox(b);},selectGroup:function(c){var e=c.selectedGroupId?c.selectedGroupId:"";var d=c.hasOwnProperty("isMultiple")&&c.isMultiple;
var a=this;var b=ctx+"/gl/ou/group/listData.htm";if(!c.positionType){b+="?type=dept_manager";}if(jQuery.isArray(e)){e=e.toString();}layer.open({type:1,title:"选择部门",shadeClose:false,btn:["确定","关闭"],area:["70%","70%"],scrollbar:false,maxmin:false,content:'<ul id="organizationSelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(f,i){var g=this;
var j={async:{enable:true,url:b,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:{selectedGroupId:e},dataFilter:function(n,k,o){if(o&&o.length){for(var m=0;
m<o.length;m++){var l=o[m];if(l.isSale=="y"){l.name=l.name+"【销】";l.font={"color":"red"};}}}return o;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},check:{enable:true,chkStyle:d?"checkbox":"radio",chkboxType:{"Y":"s","N":"s"},radioType:"all"},callback:{onClick:function h(l,o,n){var m=n.getCheckStatus().checked;
var k=$.fn.zTree.getZTreeObj("organizationSelTree");k.checkNode(n,!m,false);},onAsyncSuccess:function(m,o,n,p){var l=$.fn.zTree.getZTreeObj("organizationSelTree");
if(!n){var k=l.getNodes()[0];l.expandNode(k,true,false,true);}}}};$.fn.zTree.init($("#organizationSelTree"),j);},yes:function(j,g){var h=$.fn.zTree.getZTreeObj("organizationSelTree");
var f=h.getCheckedNodes(true);var l=[];for(var k=0;k<f.length;k++){var m={id:f[k].id,name:f[k].name};l.push(m);}if(c.fn){c.fn(l);}layer.close(j);}});}};
function AddressService(a){this.container=a;this.isHideCountry=false;}AddressService._CONS_={CATE_TYPE_KEY:"AddressCateType",ROOT_KEY:"AddressCateType-root"};
AddressService.prototype={init:function(b,a){if(!b||!b.isNotRequired){$("#"+this.container).empty().append("<div class='col-sm-12'><label class='control-label col-sm-2'>所在地<span style='color:red;'>*</span></label><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.isSelect&&b.isSelect=="y"){$("#"+this.container).empty().append("<div class='col-sm-12'><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.rowFit&&b.rowFit=="y"){$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-11 container' style='padding-left:0px !important;'></div>");
}else{$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-6 container'></div></div>");}}}this.params=b;
this._bindEventHandler();if(b.isHideCountry){self.isHideCountry=b.isHideCountry;this._loadProvinces("ChinaCityCateType-root");}else{this._loadCountrys();
}if(a&&typeof(a)=="function"){a();}},getAddress:function(){var e=$("#"+this.container).find('select[name="country_"]').val();var a=$("#"+this.container).find('select[name="province_"]').val();
var d=$("#"+this.container).find('select[name="city_"]').val();var c=$("#"+this.container).find('select[name="area_"]').val();var b=$("#"+this.container).find("select[name='town_']").val();
return{country:e,countryName:$("#"+this.container).find('select[name="country_"]').find('option[value="'+e+'"]').text(),province:a,provinceName:$("#"+this.container).find('select[name="province_"]').find('option[value="'+a+'"]').text(),city:d,cityName:$("#"+this.container).find('select[name="city_"]').find('option[value="'+d+'"]').text(),area:c,areaName:$("#"+this.container).find('select[name="area_"]').find('option[value="'+c+'"]').text(),town:b,townName:b?$("#"+this.container).find("select[name='town_']").find("option[value='"+b+"']").text():"",};
},isValid:function(b){var a=true;$("#"+this.container).find("select").each(function(){var c=$(this).attr("name");var e=$(this).val();if(!e&&c!="town_"){a=false;
var d="";switch(c){case"country_":d="请选择国家";break;case"province_":d="请选择省份";break;case"city_":d="请选择城市";break;case"area_":d="请选择区县";break;}DialogUtils.error(msgCode.ERROR,d,b);
return false;}});return a;},_loadCountrys:function(){this._loadCates(AddressService._CONS_.ROOT_KEY,"country_");},_loadProvinces:function(a){this._loadCates(a,"province_");
},_loadCitys:function(a){this._loadCates(a,"city_");},_loadAreas:function(a){this._loadCates(a,"area_");},_loadTowns:function(a){this._loadCates(a,"town_");
},_loadCates:function(c,d){var a=this;var b=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm";b+="?cateType="+AddressService._CONS_.CATE_TYPE_KEY+"&parentKey="+c;
FormUtils.loadData(b,function(h){if(h.success){if(h.msg!=null&&h.msg!=""){var j=new StringBuffer();var g=JSON.parse(h.msg);if(g&&g.length>0){j.append("<div class='col-sm-2' style='padding-left:0px !important;'>");
j.append("<select class='form-control' name='"+d+"'>");j.append("<option value=''>请选择</option>");for(var e=0;e<g.length;e++){var f="";if(a.params){switch(d){case"country_":if(g[e].value==a.params.country){f="selected='selected'";
}break;case"province_":if(g[e].value==a.params.province){f="selected='selected'";}break;case"city_":if(g[e].value==a.params.city){f="selected='selected'";
}break;case"area_":if(g[e].value==a.params.area){f="selected='selected'";}break;case"town_":if(g[e].value==a.params.town){f="selected='selected'";}break;
}}j.append("<option "+f+" idValue='"+g[e].id+"' value='"+g[e].value+"'>"+g[e].name+"</option>");}j.append("</select>");j.append("</div>");$("#"+a.container).find(".container").append(j.toString());
if(a.params&&a.params.disabled){$("#"+a.container).find(".container").find("select").attr("disabled","disabled");}if(a.params){switch(d){case"country_":if(a.params.country&&!a.isHideCountry){a._loadProvinces(a.params.country);
}break;case"province_":if(a.params.province){a._loadCitys(a.params.province);}break;case"city_":if(a.params.city){a._loadAreas(a.params.city);}break;case"area_":if(a.params.area){a._loadTowns(a.params.area);
}break;}}}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHandler:function(){var a=this;$("#"+this.container).off("change",'select[name="country_"]');
$("#"+this.container).off("change",'select[name="province_"]');$("#"+this.container).off("change",'select[name="city_"]');$("#"+this.container).off("change","select[name='area_']");
$("#"+this.container).find("select[name='area_']").off("change");$("#"+this.container).on("change",'select[name="country_"]',function(){a.params=null;var b=$(this).val();
if(b){$(this).parent().nextAll().remove();a._loadProvinces(b);}else{$("#"+a.container).find("select[name=province_]").empty().append("<option value=''>请选择</option>");
$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="province_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadCitys(b);}else{$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="city_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadAreas(b);}else{$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");}$.log("change");});$("#"+this.container).on("change","select[name='area_']",function(){a.params=null;
var b=$(this).val();if(b){$(this).parent().nextAll().remove();a._loadTowns(b);}else{$("#"+a.container).find("select[name='town_']").empty().append("<option value=''>请选择</option>");
}$.log("change");});}};var excelUtil={toGenExcel:function(a,b,c){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/toGenExcel.htm?module="+a+"&moduleText="+c,b);
},importExcel:function(a){if(a.isCreateSub){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl+"&isCreateSub="+a.isCreateSub,a.tabTitle);
}else{JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl,a.tabTitle);}},findExportColByModule:function(c,b,d){var a=ctx+"/gl/mc/moduleColumn/findByModule.htm?module="+c;
if(b){a=ctx+"/gl/mc/moduleColumn/findGrantCol.htm?module="+c;}FormUtils.loadData(a,function(e){if(d){d(e);}});}};function CsEmployee(a){this.caller=a;this.gridId="#csEntityGrid";
this.formId="#csEntitySearchForm";this.isSea="n";}CsEmployee._CONS_={SHOW_MORE:ctx+"/crm/cs/csEntity/showMoreTarget.htm",};CsEmployee.prototype={init:function(a,c,b){if(a){this.gridId=a;
}if(c){this.formId=c;}if(b){this.isSea=b;}this._bindEventHandler();},_bindEventHandler:function(){var a=this;$(document).on("click",".changRelEmployee",function(){a._changeEmployee($("#csEntityForm").find("[name=id]").val());
});$(document).on("click",".changRelEmployeeForAdd",function(){a._changeEmployee($("#csEntityForm").find("[name=id]").val());});$("body").on("click",".csEntityEmployee",function(){var c=$(this).attr("idVal");
if(c){var b=new CsAssign([c],"csEntity");b.init();}else{c=$(a.gridId).jqGrid("getGridParam","selarrrow");ConfigUtils.findByKey("csEntity.assignCsMaxVal",function(e){if(e.msg!=0&&e.msg<c.length){DialogUtils.error(msgCode.ERROR,"单次最多分配"+e.msg+"个客户");
return false;}else{if(c&&c.length){var d=new CsAssign(c,"csEntity");d.init();}else{DialogUtils.confirmWithOptions({title:"使用查询结果[不支持一键查询]进行分配,确定吗?",text:"",confirmButtonText:"确定",yesFunc:function(){var g=CsEntityUtils.getSearchParams(a.caller.rfmtSearch);
g=CsEntityUtils.getSearchParamToObj(g);g.type=type||a.caller.type;if(e.msg!=0){g.limitCount=e.msg;}if(a.isSea=="y"){g["is_sea_"]="y";}var f=$(a.caller.grid).jqGrid("getGridParam","records");
FormUtils.submit(ctx+"/crm/cs/csEntity/listCsIds.htm",g,function(i){var h=new CsAssign(i,"csEntity",null,e.msg);h.init();});},noFunc:function(){DialogUtils.error(msgCode.ERROR,"请选择要分配的客户");
},});}}});}});},_getSearchParam:function(){var f=$(this.formId).serialize();var e={};f=decodeURIComponent(f,true);var a=f.split("&");if(a.length){for(var b=0;
b<a.length;b++){var d=a[b].split("=");if(d.length==2){if(e.hasOwnProperty(d[0])){if(jQuery.type(e[d[0]])=="string"){var c=[];c.push(e[d[0]]);d[1]=d[1].replaceAll("\\+"," ");
c.push(d[1]);e[d[0]]=c;}else{if(jQuery.type(e[d[0]])=="array"){d[1]=d[1].replaceAll("\\+"," ");e[d[0]].push(d[1]);}}}else{d[1]=d[1].replaceAll("\\+"," ");
e[d[0]]=d[1];}}else{if(d.length>2){e[d[0]]=a[b].substring(a[b].indexOf("=")+1).replaceAll("\\+"," ");}}}}return e;},_changeEmployee:function(d,a){var b=0;
if(ResUtils.canShow("employeeSelector.button.cs")){b:1;}var e={isShowAllGroup:b,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,isOnlySelfGroup:1,type:"positionContext",callBack:function(g){if(g!=null){if(g.length>0){$("input[name=employeeId]").val(g[0].id);
$("input[name=employeeShow]").val(g[0].aid+"："+g[0].name);if(!a){var f=[];f.push({employeeId:g[0].id,csEntityIds:d});FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(f),csType:"csEntity"},function(h){if(h.success){DialogUtils.success("提示",h.msg);
}else{DialogUtils.error("失败",h.msg);}});}}}}};var c=new EmployeesSelect();c.init(e);},};var GroupUtils={loadGroupOptions:function(a){a.url=ctx+"/gl/ou/group/listData.htm";
if(!a.positionType){a.url=a.url+"?type=dept_manager";}a.key="id";a.keyName="name";a.caption="请选择部门";return OptionsBaseUtils.getOptions(a);},selectGroupTreeBox:function(a){var b={selectedIds:jQuery.isArray(a.selectedGroupId)?a.selectedGroupId.toString():a.selectedGroupId,container:a.container,treeId:"menuContentForGroup"+a.container.split(" ")[0],isMultiple:a.isMultiple,otherParam:{selectedGroupId:a.selectedGroupId},url:ctx+"/gl/ou/group/listData.htm",fn:a.fn,isSale:a.isSale,positionType:a.positionType,hideSale:a.hideSale?a.hideSale:false,isSmsConfigHtml:a.isSmsConfigHtml,isReDisabled:a.isReDisabled?a.isReDisabled:false};
if(a.isEqWidth){b.isEqWidth=true;}if(a.isAutoHeight){b.isAutoHeight=true;}if(!b.positionType){b.url=b.url+"?type=dept_manager";}else{b.url=b.url+"?type="+b.positionType;
}if(a.isSale){b.url=b.url+"?type="+b.positionType+"&isSale=y";}if(a.agentId){b.url=b.url+"&agentId="+a.agentId;}b.dataFilter=function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"&&!b.hideSale){d.name=d.name+"【销】";d.font={"color":"red"};}}}if(a.dataFilter){return a.dataFilter(f,c,g);}else{return g;
}};CateUtils.selectTreeBox(b);},selectGroup:function(c){var e=c.selectedGroupId?c.selectedGroupId:"";var d=c.hasOwnProperty("isMultiple")&&c.isMultiple;
var a=this;var b=ctx+"/gl/ou/group/listData.htm";if(!c.positionType){b+="?type=dept_manager";}if(jQuery.isArray(e)){e=e.toString();}layer.open({type:1,title:"选择部门",shadeClose:false,btn:["确定","关闭"],area:["70%","70%"],scrollbar:false,maxmin:false,content:'<ul id="organizationSelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(f,i){var g=this;
var j={async:{enable:true,url:b,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:{selectedGroupId:e},dataFilter:function(n,k,o){if(o&&o.length){for(var m=0;
m<o.length;m++){var l=o[m];if(l.isSale=="y"){l.name=l.name+"【销】";l.font={"color":"red"};}}}return o;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},check:{enable:true,chkStyle:d?"checkbox":"radio",chkboxType:{"Y":"s","N":"s"},radioType:"all"},callback:{onClick:function h(l,o,n){var m=n.getCheckStatus().checked;
var k=$.fn.zTree.getZTreeObj("organizationSelTree");k.checkNode(n,!m,false);},onAsyncSuccess:function(m,o,n,p){var l=$.fn.zTree.getZTreeObj("organizationSelTree");
if(!n){var k=l.getNodes()[0];l.expandNode(k,true,false,true);}}}};$.fn.zTree.init($("#organizationSelTree"),j);},yes:function(j,g){var h=$.fn.zTree.getZTreeObj("organizationSelTree");
var f=h.getCheckedNodes(true);var l=[];for(var k=0;k<f.length;k++){var m={id:f[k].id,name:f[k].name};l.push(m);}if(c.fn){c.fn(l);}layer.close(j);}});}};
var CsEntityUtils={init:function(){this._initBirthdaySelect();this._initChannelSelect();this._initCateOptSelect();this._bindEventHanlder();},_bindEventHanlder:function(){var a=this;
$(".closeBtn").on("click",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));});$("#birthYear").on("change",function(){var c=(new Date()).getFullYear();
var b=parseInt(c)-parseInt($(this).val());$("#age").val(b);});$("#age").on("blur",function(){var c=$(this).val();if(c){var b=parseInt((new Date()).getFullYear())-parseInt(c);
$("#birthYear").val(b);}else{$("#birthYear").val("");}});},_initBirthdaySelect:function(){var a=new Date();var e="1920";var d=a.getFullYear();var g=new StringBuffer();
for(var b=d;b>=e;b--){g.append("<option value='"+b+"'>");g.append(b);g.append("</option>");}$("#birthYear").append(g.toString());var c=new StringBuffer();
for(var b=1;b<=12;b++){if(b<10){b="0"+b;}c.append("<option value='"+b+"'>");c.append(b);c.append("</option>");}$("#birthMonth").append(c.toString());var f=new StringBuffer();
for(var b=1;b<=31;b++){if(b<10){b="0"+b;}f.append("<option value='"+b+"'>");f.append(b);f.append("</option>");}$("#birthDay").append(f.toString());},_initChannelSelect:function(d){var a=this;
var b="mediaChannel-findActived";var e=window.sessionStorage.getItem(b);if(e){var c=JSON.parse(e);a._buildChannelSelect(c,d);}else{FormUtils.loadData(ctx+"/ec/media/mediaChannel/findActived.htm",function(f){window.sessionStorage.setItem(b,JSON.stringify(f));
a._buildChannelSelect(f,d);});}},_buildChannelSelect:function(c,b){if(c&&c.length>0){if(!b&&isDefaultLast&&"y"==isDefaultLast){var d=window.localStorage.getItem("CREATE_CS_SRC_"+currentUserId);
b=d;}var e=new StringBuffer();e.append("<option value=''>请选择</option>");for(var a=0;a<c.length;a++){e.append("<option value='"+c[a].id+"'>"+c[a].name+"</option>");
}$("#srcs").empty().append(e.toString());if(b){$("#srcs").val(b);}this.isInitChannelSelect=true;}},_initInterestsSelect:function(b){var a=this;CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interests",fn:function(c){var g=new StringBuffer();
for(var e=0;e<c.length;e++){var f=c[e].value;var d=c[e].name;g.append("<option value='"+f+"'>"+d+"</option>");}$("#interests").empty().append(g.toString());
a.isInitInterests=true;}}]);},maskPhoneNum:function(a){var b=new StringBuffer();if(a){return PhoneEncryptUtils.encryptPhone(a);}return b.toString();},refreshListTab:function(){if(type=="self"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/list.htm");
}else{if(type=="search"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/searchList.htm");}else{if(type=="mysub"){JTTabUtils.refreshTab(ctx+"/crm/cs/csEntity/subList.htm");
}}}},_initCateOptSelect:function(){CateUtils.getOptions([{typeKey:"system",pKey:"CsBizTypes",container:"bizType"},{typeKey:"system",pKey:"CsEntryType",container:"entry"},{typeKey:"system",pKey:"vocationType",container:"vocation"},{typeKey:"system",pKey:"income",container:"income"},{typeKey:"system",pKey:"maritalStatus",container:"maritalStatus"},{typeKey:"system",pKey:"winePurpose",container:"winePurpose"},{typeKey:"system",pKey:"taste",container:"taste"}]);
this._initInterestsSelect(null);},getSearchParams:function(h){var k=this;var d=$("#csEntitySearchForm").serialize()+h.getRfmtParam();var e=$("select[name=freeHourOption]").val();
var c=$("select[name=freeMinuteOption]").val();if(e){if(!c){$("select[name=freeMinuteOption]").val("00");}}if(c){if(!e){$("select[name=freeHourOption]").val("00");
}}var j=$("#interestSearch option:selected").length;if(j!=0){d=k._bulidInterests(d,j);}var b=$("#belongEmployeeSearch option:selected").length;if(b!=0){d=k._bulidEmps(d,b);
}var a=$("#searchProd option:selected").length;if(a!=0){d=k._bulidProds(d,a);}var g=$("#csTagSearch option:selected").length;if(g!=0){d=k._bulidCsTag(d,g);
}var i=$("#eavSearch option:selected").length;if(i!=0){d=k._bulidEav(d,i);}var f=$("#srcSearch option:selected").length;if(f){d=k._bulidSrcs(d,f);}return d;
},_bulidInterests:function(c,b){var a=this;var d=new StringBuffer();$("#interestSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;
}else{d.append(",");}});c=c+"&interests="+d.toString();return c;},_bulidEmps:function(c,b){var a=this;var d=new StringBuffer();$("#belongEmployeeSearch option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&belongEmployee="+d.toString();return c;},_bulidProds:function(c,b){var a=this;var d=new StringBuffer();
$("#searchProd option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");}});c=c+"&productName="+d.toString();
return c;},_bulidCsTag:function(c,b){var a=this;var d=new StringBuffer();$("#csTagSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;
}else{d.append(",");}});c=c+"&csTagSearch="+d.toString();return c;},_bulidEav:function(c,b){var a=this;var d=new StringBuffer();$("#eavSearch option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&eavSearch="+d.toString();return c;},_bulidSrcs:function(c,b){var a=this;var d=new StringBuffer();
$("#srcSearch option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");}});c=c+"&srcSearch="+d.toString();
return c;},getSearchParamToObj:function(f){var e={};f=decodeURIComponent(f,true);var a=f.split("&");if(a.length){for(var b=0;b<a.length;b++){var d=a[b].split("=");
if(d.length==2){if(e.hasOwnProperty(d[0])){if(jQuery.type(e[d[0]])=="string"){var c=[];c.push(e[d[0]]);d[1]=d[1].replaceAll("\\+"," ");c.push(d[1]);e[d[0]]=c;
}else{if(jQuery.type(e[d[0]])=="array"){d[1]=d[1].replaceAll("\\+"," ");e[d[0]].push(d[1]);}}}else{d[1]=d[1].replaceAll("\\+"," ");e[d[0]]=d[1];}}else{if(d.length>2){e[d[0]]=a[b].substring(a[b].indexOf("=")+1).replaceAll("\\+"," ");
}}}}return e;}};var ChannelUtils={getOptions:function(b){var a=this;var c=window.sessionStorage.getItem("loacalChannel");if(c&&c!=null&&c!=""){a._apendData(b,JSON.parse(c));
}else{FormUtils.loadData(ctx+"/ec/media/mediaChannel/findActived.htm",function(d){window.sessionStorage.setItem("loacalChannel",JSON.stringify(d));a._apendData(b,d);
var e=a.getContainer(b);if(e&&e.is(".selectpicker")){e.selectpicker("refresh");}});}},_apendData:function(a,c){var d=this.getContainer(a);if(!d){return false;
}var e=new StringBuffer();if(a.type=="noChannelId"){e.append("<option value='' style='color:red;'>").append("无渠道").append("</option>");}if(a.caption){e.append("<option value=''>").append(a.caption).append("</option>");
}if(a.emptyOptions){e.append("<option value='"+a.emptyOptions+"' style='color:red;'>").append("无渠道").append("</option>");}if(c&&c.length>0){for(var b=0;
b<c.length;b++){e.append("<option value='"+c[b].id+"'>"+c[b].name+"</option>");}d.empty().append(e.toString());}},getContainer:function(a){var b=false;
if(a.container){b=$("#"+a.container);if(b.length==0){b=$("select."+a.container);if(b.length==0){b=$("select[name='"+a.container+"']");if(b.length==0){return false;
}}}}return b;}};function SendMessage(){this.hadInit=false;}SendMessage._CONS_={LIST_DATA_URL:ctx+"/gl/sms/smsRecord/findByCsId.htm",SEND_MSG_URL:ctx+"/gl/sms/smsRecord/sendMsg.htm",SEND_ALI_TEMPLATE_URL:ctx+"/gl/sms/smsRecord/sendAliTemplateMsg.htm",RE_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/resend.htm",JUDGE_IS_PHONE_URL:ctx+"/crm/cs/csEntity/judgeIsPhone.htm",BATCH_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/batchSendMsg.htm",DIV:"#smsRecordGridDiv",GRID:"#smsRecordGrid",PAGER:"#smsRecordPager",GRID_ID:"smsRecordGrid",PAGER_ID:"smsRecordPager"};
SendMessage.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}this._initSelectPlatformType();},_initSelectPlatformType:function(){if("y"==isOpenSelectPlatform){$("body").find(".smsSelectPlatformDiv").show();
}else{$("body").find(".smsSelectPlatformDiv").remove();}},_bindEventHander:function(){var a=this;$("body").on("click",".resendMsg",function(){a.reSendMsg($(this).attr("attr-id"));
});$("body").on("click",".deleteMsgBtn",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/sms/smsRecord/delete.htm",{ids:b},function(){a.initTable(a.initParam);
});});});},initTable:function(e){var a=this;a.initParam=e;$("#sendMessageForm").find("[name=sendContent]").attr("disabled",false);var d="";if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){d="<th>操作</th>";
}$("#smsRecordDiv").empty().append("<table class='table table-bordered table-stripped' id='smsRecordTable'>            <thead>                <tr>                    <th></th>                    <th>手机号码</th>                    <th>短信内容</th>                    <th>收发</th>                    <th>平台</th>                    <th>结果</th>                    <th>发送人</th>                    <th>时间</th>"+d+"</tr>            </thead>        </table>");
var b=SendMessage._CONS_.LIST_DATA_URL+"?csId="+e.csId;var c=[{data:"lineNum"},{data:"mobile"},{data:"content"},{data:"type",render:function(f){if(f=="send"){return"<span class='text-success'>发送</span>";
}else{return"<span class='text-primary'>收到</span>";}}},{data:"platform",render:function(g){var f="短信猫";if(g){if(g.startsWith("gst")){f="高斯通";}else{if(g.startsWith("lsm")){f="螺丝帽";
}else{if(g.startsWith("ali")){f="阿里";}}}}return f;}},{data:"result",render:function(f,h,g){if(f=="SUCCESS"){return"<span class='text-success'>成功</span>";
}else{if(f=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";}else{if(f=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";
}else{if(f.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}else{if(f.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}}}}}}},{data:"employeeAid",render:function(h,g,f){if(f.type=="send"){return h;}else{return"无";}}},{data:"createTime"}];if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){c.push({data:"createTime",width:"10%",render:function(h,g,f){return"<button class='btn btn-sm btn-danger btn-outline deleteMsgBtn' idVal='"+f.id+"' type='button'>删除</button>";
}});}$("#smsRecordTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"asc"]]});
},openSendMessageView:function(c){var a=this;a.initForm();$("#sendMessageModalLabel").text("TO："+c.maskNum);var b=$("#sendMessageForm");b.find("[name=csId]").val(c.csId);
b.find("[name=sendPhoneNum]").val(c.number);b.find("[name=replyId]").val(c.replyId);$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){var d=b.find("[name=sendContent]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var e=new CateOptService();e.isHasSensitiveWord(d,function(j){if(j.isCanSendMsg!=null&&!j.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+j.msg,$("#sendMessageContainer"));
}else{var g=b.find("[name=csId]").val();var h=b.find("[name=sendPhoneNum]").val();var f=b.find("[name=replyId]").val();var i=b.find("[name=selectPlatformType]").val();
var k={csId:g,phone:h,sendContent:encodeURIComponent(d),selectPlatformType:i,replyId:f};$("#sendStatus").text("发送中...");FormUtils.submit(SendMessage._CONS_.SEND_MSG_URL,k,function(l){if(l.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,l.msg);$("#sendMessageContainer").modal("hide");}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});}});});},openBatchSendMessageView:function(c){var a=this;a._initSelectPlatformType();$("#sendMessageModalLabel").html("批量发短信&emsp;<span>批量给<font style='color:red;'>【"+c.csIds.length+"个】</font>个客户发短信<span>");
var b=$("#sendMessageForm");b.find("[name=sendContent]").val("");$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){DialogUtils.confirmWithOptions({title:"确定批量发短信？",text:"",confirmButtonText:"确定",yesFunc:function(){var f=c.csIds;
var d=b.find("[name=sendContent]").val();var e=b.find("[name=selectPlatformType]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var g=new CateOptService();g.isHasSensitiveWord(d,function(h){if(h.isCanSendMsg!=null&&!h.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+h.msg,$("#sendMessageContainer"));
}else{var i={"sendContent":encodeURIComponent(d),"csIds":f,selectPlatformType:e};FormUtils.submit(SendMessage._CONS_.BATCH_SEND_MSG_URL,i,function(j){if(j.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,j.msg);}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,j.msg);}},null);}});}});});},openAilTemplateMessageView:function(b){var a=this;
$("#aliTemplateModalCsIds").val(b.csIds);a.getAliTemplateSms();$("#aliTemplateModal").modal("show");$("#aliTemplateModal").removeAttr("tabindex");},initForm:function(){var a=$("#sendMessageModalLabel");
a.find("[name=csId]").val("");a.find("[name=sendPhoneNum]").val("");a.find("[name=sendContent]").val("");a.find(".tabli").removeClass("active").eq(0).addClass("active");
a.find(".tab-pane").removeClass("active").removeClass("in").eq(0).addClass("active").addClass("in");this._initSelectPlatformType();},reSendMsg:function(d){var a=this;
var b=SendMessage._CONS_.RE_SEND_MSG_URL;var c={"ids":d};DialogUtils.success(msgCode.SUCCESS,"发送中...");FormUtils.submit(b,c,function(e){if(e.success){a.initTable(a.initParam);
DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},null,true);},getTplOptions:function(c){var a=this;if(!c.type||!c.cateId){return;
}var b=window.sessionStorage.getItem("t9-ecm-loacaltpl"+c.type+c.cateId);if(b&&b!=null&&b!=""){a._apendData(c,JSON.parse(b));}else{FormUtils.loadData(ctx+"/gl/tpl/glTpl/findTplByTypeAndCateId.htm?type="+c.type+"&cateId="+c.cateId,function(d){window.sessionStorage.setItem("t9-ecm-loacaltpl"+c.type+c.cateId,JSON.stringify(d));
a._apendData(c,d);});}},getAliTemplateSms:function(){FormUtils.loadData(ctx+"/gl/tpl/glTpl/findAliTemplateSms.htm",function(a){var c=new StringBuffer();
if(a.length>0){var c=new StringBuffer();c.append('<option value="">请选择</option>');for(var b=0;b<a.length;b++){c.append("<option value='"+a[b].type+"' content='"+a[b].content+"'>"+a[b].templateName+"</option>");
}$(".aliTemplateModalSelect").empty().append(c.toString()).select2();}});},_apendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);
if(f.length==0){f=$("select[name='"+c.container+"']");if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");
}if(a&&a.length>0){var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].tplContent;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("'>").append(b).append("</option>");}else{g.append("<option value='").append(e).append("'>").append(b).append("</option>");
}}f.empty().append(g.toString());}f.off("change").on("change",function(){var h=c.fn;if(h&&typeof h==="function"){h(f.val());}});}};function CateOptService(){}CateOptService._CONS_={};
CateOptService.prototype={isHasSensitiveWord:function(b,a){var c={};$.ajax({type:"GET",url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=smsSensitiveWord",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){b=b.replace(/\s/g,"");
if(d&&d.length>0){for(var e=0;e<d.length;e++){if(b.indexOf(d[e].value)>-1){c.isCanSendMsg=false;c.msg=d[e].value;}}}if(a){a(c);}},error:function(d){if(a){a(c);
}}});}};function CsEntityBatchUpdate(){this.hadInit=false;this.params=null;this.searchParam=null;this.count=null;}CsEntityBatchUpdate._CONS_={CSENTITY_BATCH_UPDATE:ctx+"/crm/cs/csEntity/csBatchUpdate.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",FORM:"#csBatchUpdateForm",};
CsEntityBatchUpdate.prototype={init:function(b){var a=this;if(!this.hadInit){this.hadInit=true;this._bindEventHanlder();if(b.isSea){$(".batchUpdateAidTr").hide();
}this.searchParam=b.searchParam;this.count=b.count;this._csEntityBatchUpdate();}},_csEntityBatchUpdate:function(){var a=this;$("#batchUpdateModalLabel").html("批量修改&emsp;<span>您正在对<font style='color:red;'>【"+a.count+"个】</font>客户进行批量修改操作。<font style='color:red;'>提示：只有勾选才有效</font><span>");
a._loadData();$("#batchUpdateContainer").modal("show");},_bindEventHanlder:function(){var a=this;$("#batchUpdateCancel").off("click").on("click",function(){FormUtils.clear(CsEntityBatchUpdate._CONS_.FORM);
$("#systemTagSelect").chosen("destroy");$(".columnCheckBox").prop("checked",false);});$("#batchUpdateSave").off("click").on("click",function(){if($("input[name=batchUpdateName]").val()&&!$("#checkName").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选客户姓名");
return;}if($("input[name=batchUpdateDesc]").val()&&!$("#checkDesc").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选客户备注");return;}if($("select[name=employeeIdSearch]").val()&&!$("#checkAid").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选归属工号");
return;}if($("#batchUpdateBizType").val()&&!$("#checkBizType").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选客户分类");return;}if($(".batchUpdateSrcVal").val()&&!$("#checkSrc").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选渠道来源");
return;}if($("#batchUpdateInterest").val()&&!$("#checkInterest").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选客户意向");return;}if($("#batchUpdateTag").val()&&!$("#checkTag").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选客户标签");
return;}if($("#batchUpdateEntry").val()&&!$("#checkEntry").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选进线方式");return;}if($("#batchUpdateProd").val()&&!$("#checkProductName").is(":checked")){DialogUtils.error(msgCode.ERROR,"请勾选产品意向");
return;}DialogUtils.confirmWithOptions({title:"确定批量修改当前选择记录？",text:"",confirmButtonText:"确定",yesFunc:function(){a._batchUpdate(a.searchParam,a.count);$("#batchUpdateContainer").modal("hide");
$(".columnCheckBox").prop("checked",false);$("#batchUpdateTag").chosen("destroy");FormUtils.clear("csEntitySearchForm");FormUtils.clear(CsEntityBatchUpdate._CONS_.FORM);
$("#csEntitySearchForm").find(".csEntitySearch").trigger("click");}});});},_batchUpdate:function(f,g){f.count=g;var i=$("input[name=batchUpdateName]").val();
if($("#checkName").is(":checked")&&i){f.nameType=$("#nameType").val();f.newName=i;}var c=$("input[name=batchUpdateDesc]").val();if($("#checkDesc").is(":checked")&&c){f.descType=$("#descType").val();
f.newDesc=c;}var e=$("select[name=employeeIdSearch]").val();if($("#checkAid").is(":checked")&&e){f.newId=e;}var a=$("#batchUpdateBizType").val();if($("#checkBizType").is(":checked")){if(a){f.newBizType=a;
}else{f.newBizType="isNull";}}var j=$(".batchUpdateSrcVal").val();if($("#checkSrc").is(":checked")){if(j){f.newSrcs=j;}else{f.newSrcs="isNull";}}var h=$("#batchUpdateInterest").val();
if($("#checkInterest").is(":checked")){if(h){f.newInterest=h;}else{f.newInterest="isNull";}}var k=$("#batchUpdateTag").val();if($("#checkTag").is(":checked")){if(k){f.newTag=k;
}else{f.newTag="isNull";}}var b=$("#batchUpdateEntry").val();if($("#checkEntry").is(":checked")){if(b){f.newEntry=b;}else{f.newEntry="isNull";}}var d=$("#batchUpdateProd").val();
if($("#checkProductName").is(":checked")){if(d){f.newProd=d;}else{f.newProd="isNull";}}FormUtils.submit(CsEntityBatchUpdate._CONS_.CSENTITY_BATCH_UPDATE,f,function(l){if(l.success){DialogUtils.success(msgCode.INFO,"批量修改成功");
}else{DialogUtils.error(msgCode.ERROR,"批量修改失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_loadData:function(){var a=this;CateUtils.getOptions({typeKey:"system",pKey:"CsBizTypes",container:"batchUpdateBizType"});
CateUtils.getOptions({typeKey:"system",pKey:"CsInterestType",container:"batchUpdateInterest"});CateUtils.getOptions({typeKey:"system",pKey:"CsEntryType",container:"batchUpdateEntry"});
systemTagUtil._buildCsTag(null,{module:systemTagUtil._CONS_.CS_MODULE,type:systemTagUtil._CONS_.CS_TYPE,container:"batchUpdateTag",selectType:"multiple"});
a._buildEmployeeOption();a._channelSearch();a._prodSearch();},_prodSearch:function(h){$("#batchUpdateProd").bsSuggest("destroy");var i=this;var b="entity";
var g="n";var c="n";var f="prodEntity-csEntity";var d=window.sessionStorage.getItem(f);if(d){var e=JSON.parse(d);i._prodSearchSuggest(e);}else{var a=ctx+"/ec/product/prodEntity/search.htm?prodType="+b+"&hasStock="+g+"&storeId="+"&limitProdCate="+c+"&keyword=";
FormUtils.loadData(a,function(j){window.sessionStorage.setItem(f,JSON.stringify(j));i._prodSearchSuggest(j);});}},_prodSearchSuggest:function(c){var a=this;
a.searchProds=c.value;var b=$("#batchUpdateProd").width()+"px";$("#batchUpdateProd").bsSuggest({effectiveFields:["prodName"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,data:c,getDataMethod:"data",processData:function(d){return d;
},listStyle:{"padding-top":0,"max-height":"500px","max-width":b,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(f,d){a.searchProds=d.value;
}).on("onSetSelectValue",function(g,d){for(var f=0;f<a.searchProds.length;f++){if(a.searchProds[f].skuId==d.id){a.currentProd=a.searchProds[f];break;}}$("#batchUpdateProd").val(a.currentProd.prodName);
}).on("onUnsetSelectValue",function(d){a.currentProd={};});},_channelSearch:function(){$("#batchUpdateSrc").bsSuggest("destroy");var a=this;var b=$("#batchUpdateSrc").width()+"px";
$("#batchUpdateSrc").bsSuggest({url:ctx+"/ec/media/mediaChannel/search.htm",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"渠道名称"},showBtn:false,idField:"id",keyField:"name",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(c){a.searchChannels=c.value;
return c;},listStyle:{"padding-top":0,"max-height":"500px","max-width":b,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(d,c){a.searchChannels=c.value;
}).on("onSetSelectValue",function(f,d){for(var c=0;c<a.searchChannels.length;c++){if(a.searchChannels[c].id==d.id){a.currentChannel=a.searchChannels[c];
break;}}$(".batchUpdateSrcVal").val(a.currentChannel.id);$("#batchUpdateSrc").val(a.currentChannel.name);}).on("onUnsetSelectValue",function(c){a.currentChannel={};
});},_buildEmployeeOption:function(){var a=CsEntityBatchUpdate._CONS_.EMPLOYEE_LIST_URL+"?groupId=&type=dept_manager";FormUtils.loadData(a,function(c){$("select[name=employeeIdSearch]").empty();
if(c&&c.length>0){var d=new StringBuffer();d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");
}$("select[name=employeeIdSearch]").append(d.toString()).select2();}},null,true);},};function CsEntityBatchCall(){this.hadInit=false;this.params=null;this.saveFlag=false;
}CsEntityBatchCall._CONS_={CSENTITY_BATCH_CALL:ctx+"/gl/cti/ctiBatcallItem/csEntityBatchCall.htm",FORM:"#csBatchCallForm",};CsEntityBatchCall.prototype={init:function(b){var a=this;
if(!this.hadInit){this.hadInit=true;this._csEntityBatchCall(b.count,b.csIds);}},_csEntityBatchCall:function(b,c){var a=this;layer.open({type:1,title:'您正在对<font style="color:red;">【'+b+"个】</font>客户进行批量外呼操作。",maxmin:false,shadeClose:false,btn:["保存","取消"],area:["30%","50%"],content:$(".csEntityBatchCallPanel"),success:function(d,e){},yes:function(e,d){a._batchCall(c,b);
if(saveFlag){layer.close(e);FormUtils.clear(CsEntityBatchCall._CONS_.FORM);}},cancel:function(e,d){FormUtils.clear(CsEntityBatchCall._CONS_.FORM);}});},_batchCall:function(e,d){var a={};
var c=$("select[name=subaction]").val();var b=$("input[name=subdata]").val();if(!b){$("input[name=subdata]").addClass("validate_input_error");if(c=="1"){DialogUtils.error("提示","操作数据需要填入文件名");
saveFlag=false;return;}else{if(c=="2"){DialogUtils.error("提示","操作数据需要填入队列号");saveFlag=false;return;}else{DialogUtils.error("提示","操作数据需要填入分机号");saveFlag=false;
return;}}saveFlag=false;return;}a.csIds=e;a.subaction=c;a.subdata=b;saveFlag=true;FormUtils.submit(CsEntityBatchCall._CONS_.CSENTITY_BATCH_CALL,a,function(f){if(f.success){DialogUtils.success(msgCode.INFO,"批量外呼成功");
}else{DialogUtils.error(msgCode.ERROR,"批量外呼失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},};$(function(){var a=new RfmtSearch();
a.init();});function RfmtSearch(){this.hadInit=false;this.isEdit=false;this.showTipSetTimeout=null;}RfmtSearch.prototype={init:function(){if(!isUseRfmt=="true"){return;
}if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._dealStyle();this._initRfmtConfig();this._initRfmtRf();this._initRfmtMt();}},selectRfmt:function(){var b=[];
var d=[];if(RScore&&RScore!=""&&RScore!=null){b=RScore.split(",");}if(FScore&&FScore!=""&&FScore!=null){d=FScore.split(",");}if(b.length>0){for(var c=0;
c<b.length;c++){if(d.length>0){for(var a=0;a<d.length;a++){$("#rfmt-rf-container").find(".rfmt-div[data-r='"+b[c]+"'][data-f='"+d[a]+"']").addClass("on");
}}else{$("#rfmt-rf-container").find(".rfmt-div[data-r='"+b[c]+"']").addClass("on");}}}else{for(var a=0;a<d.length;a++){$("#rfmt-rf-container").find(".rfmt-div[data-f='"+d[a]+"']").addClass("on");
}}if(RScore=="0"&&FScore=="0"){$("#rfmt-config-container").val("未消费未成交");}this.selectOutBtn();},selectOutBtn:function(){if($("#rfmt-rf-container").find(".rfmt-div.on").length>0||$("#rfmt-mt-container").find(".rfmt-div.on").length>0||!($("#rfmt-config-container").val()==null||$("#rfmt-config-container").val()=="")){$(".csEntityRfmt").addClass("on");
}else{$(".csEntityRfmt").removeClass("on");}},dealTip:function(){var a=this;if($(".csEntityRfmt").hasClass("on")){$(".csRfmtTip").slideDown("fast");if(a.showTipSetTimeout!=null){clearTimeout(a.showTipSetTimeout);
}a.showTipSetTimeout=setTimeout(function(){$(".csRfmtTip").slideUp("fast");a.showTipSetTimeout=null;},5000);}else{$(".csRfmtTip").slideUp("fast");}},getRfmtParam:function(){var q={};
var a="";var v={};var j="";var s={};var l="";var o={};var n="";var d=$("#rfmt-rf-container").find(".rfmt-div.on");var c=$("#rfmt-mt-container").find(".rfmt-div.on");
for(var u=0;u<d.length;u++){var e=$(d[u]).attr("data-r");if(!q[e]){q[e]=1;a=a+e+",";}var p=$(d[u]).attr("data-f");if(!v[p]){v[p]=1;j=j+p+",";}}for(var u=0;
u<c.length;u++){var k=$(c[u]).attr("data-m");if(!s[k]){s[k]=1;l=l+k+",";}var b=$(c[u]).attr("data-t");if(!o[b]){o[b]=1;n=n+b+",";}}var g=$("#start-rfmt").val();
var w=$("#end-rfmt").val();var h="&RScore="+a.substring(0,a.length-1)+"&FScore="+j.substring(0,j.length-1)+"&MScore="+l.substring(0,l.length-1)+"&TScore="+n.substring(0,n.length-1)+"&startRfmt="+g+"&endRfmt="+w;
return h;},_initRfmtConfig:function(){FormUtils.loadData(ctx+"/crm/rfmt/rfmtConfig/listData.htm?rows=100&page=1",function(b){var c=new StringBuffer();c.append("<option value='' >请选择</option>");
for(var a=0;a<b.rows.length;a++){c.append("<option").append(" value='"+b.rows[a].name+"'").append(">"+b.rows[a].name+"</option>");}$("#rfmt-config-container").empty().append(c.toString());
});},_initRfmtRf:function(){var a=this;FormUtils.loadData(ctx+"/crm/rfmt/rfmtRflevel/listData.htm?rows=100&page=1",function(c){var d=new StringBuffer();
for(var b=1;b<c.rows.length;b++){d.append("<div class='rfmt-div' data-r='"+c.rows[b].RScore+"' data-f='"+c.rows[b].FScore+"' data-type='"+c.rows[b].type+"'>").append("R").append(c.rows[b].RScore).append("F").append(c.rows[b].FScore).append("<br />").append(c.rows[b].rf).append("</div>");
}d.append("<div class='rfmt-div' data-r='"+c.rows[0].RScore+"' data-f='"+c.rows[0].FScore+"' data-type='"+c.rows[0].type+"'>").append("R").append(c.rows[0].RScore).append("F").append(c.rows[0].FScore).append("<br />").append(c.rows[0].rf).append("</div>");
$("#rfmt-rf-container").empty().append(d.toString());a.selectRfmt();});},_initRfmtMt:function(){FormUtils.loadData(ctx+"/crm/rfmt/rfmtMtlevel/listData.htm?rows=100&page=1",function(b){var c=new StringBuffer();
for(var a=1;a<b.rows.length;a++){c.append("<div class='rfmt-div' data-m='"+b.rows[a].MScore+"' data-t='"+b.rows[a].TScore+"' data-type='"+b.rows[a].type+"'>").append("M").append(b.rows[a].MScore).append("T").append(b.rows[a].TScore).append("<br />").append(b.rows[a].mt).append("</div>");
}c.append("<div class='rfmt-div' data-m='"+b.rows[0].MScore+"' data-t='"+b.rows[0].TScore+"' data-type='"+b.rows[0].type+"'>").append("M").append(b.rows[0].MScore).append("T").append(b.rows[0].TScore).append("<br />").append(b.rows[0].mt).append("</div>");
$("#rfmt-mt-container").empty().append(c.toString());});},_dealStyle:function(){},_bindEventHander:function(){var a=this;$(".csEntityRfmt").on("click",function(){$("#rfmtSearchForm").slideDown("fast");
});$("#close-rfmt").on("click",function(){$("#rfmtSearchForm").slideUp("fast");});$("#rfmt-config-container").on("change",function(){$("#rfmt-rf-container").find(".rfmt-div").removeClass("on");
$("#rfmt-mt-container").find(".rfmt-div").removeClass("on");var c=$(this).val();var b=[];if(c.length<=4){b[0]=c.substring(0,2);b[1]=c.substring(2,4);}else{b[0]=c.substring(0,3);
b[1]=c.substring(3,c.length);}$("#rfmt-rf-container").find(".rfmt-div[data-type='"+b[1]+"']").addClass("on");$("#rfmt-mt-container").find(".rfmt-div[data-type='"+b[0]+"']").addClass("on");
a.selectOutBtn();});$(document).on("click",".rfmt-div",function(){if($(this).hasClass("on")){$(this).removeClass("on");}else{$(this).addClass("on");}a.selectOutBtn();
});$("#rfmt-search-clear").on("click",function(){$("#rfmt-rf-container").find(".rfmt-div").removeClass("on");$("#rfmt-mt-container").find(".rfmt-div").removeClass("on");
$("#start-rfmt").val("");$("#end-rfmt").val("");$("#rfmt-config-container").val("");a.selectOutBtn();});$("#rfmt-search-btn").on("click",function(){$(".csEntitySearch").trigger("click");
});}};$(function(){var a=new JtGridTip();a.init();});function JtGridTip(){}JtGridTip.prototype={init:function(){this._initContainerDiv();this._bindEventHander();
},_initContainerDiv:function(){if($("#jt-grid-tip-div").length<=0){$("body").append("<div id='jt-grid-tip-div'></div>");}},_bindEventHander:function(){var a=this;
$(document).on("mouseenter",".jt-grid-tip",function(d){var c=$(this).attr("data-value");$("#jt-grid-tip-div").empty().text(c);var b=$(this).offset().left;
var f=$(this).offset().top+5-$("body").height()*0.025;if(f+300>$(document).height()){f=$(document).height()-300;}$("#jt-grid-tip-div").css({"top":f,"left":b});
$("#jt-grid-tip-div").stop().show("fast");});$(document).on("mouseleave",".jt-grid-tip",function(c){var b=$(this).offset().left;var d=$(this).offset().top+5-$("body").height()*0.025;
if(d+300>$(document).height()){d=$(document).height()-300;}$("#jt-grid-tip-div").css({"top":d,"left":b});$("#jt-grid-tip-div").stop().hide("fast");});$("#jt-grid-tip-div").hover(function(b){$("#jt-grid-tip-div").stop(true,true).show();
},function(b){$("#jt-grid-tip-div").stop().hide("fast");});}};$(function(){var a=new CsEntity();a.init();});function CsEntity(){this.isFormDataChange=false;
this.hasInitJqgrid=false;this.titleCates=null;this.csEmployee=new CsEmployee(this);this.rfmtSearch=new RfmtSearch();this.selectedJqgrid=new Array();this.toTop=new Array();
if(window.localStorage.getItem("simpleShowDesc")==null){this.simpleShowDesc=false;}else{this.simpleShowDesc=window.localStorage.getItem("simpleShowDesc");
}this.addressServiceSearch=new AddressService("addrContainerSearch");if(type=="self"){var a=["首次交易状态跟进时间","部门","员工","员工微信"];if(!isWineIndustyPage){a.push("用途");
a.push("口感");}this.formFrontConfig=new FormConfig({"formId":"csEntitySearchForm",title:"我的客户查询配置",isHidden:true,forceParam:a,"endLess":[],modular:"csEntitySearchList"});
}else{if(type=="mysub"){var a=["首次交易状态跟进时间"];if(!isWineIndustyPage){a.push("用途");a.push("口感");}this.formFrontConfig=new FormConfig({"formId":"csEntitySearchForm",title:"下属客户查询配置",isHidden:true,forceParam:a,"endLess":[],modular:"csEntitySearchSubList"});
}}this.sortColumn="";this.sortorder="";}CsEntity._CONS_={LIST_DATA_URL:ctx+"/crm/cs/csEntity/listData.htm",ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",POINT_ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place/pointOrder.htm",ORDER_LIST_URL:ctx+"/ec/salesorder/soEntity/list.htm",ORG_LIST_URL:ctx+"/gl/ou/group/getOrganizations.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",IMPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/importExcel.htm",IMPORT_ORDER_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importOrderExcel.htm",EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/exportExcel.htm",SYNC_EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/syncExportExcel.htm",ORDER_AFTER_LIST_URL:ctx+"/ec/salesorder/soEntity/saleafter/list.htm",BATCH_DELETE_URL:ctx+"/crm/cs/csEntity/batchDeleteLogic.htm",BATCH_TOSEA_URL:ctx+"/crm/cs/csEntity/toSea.htm",BATCH_CHANGE_CAN_PLACE_SO_URL:ctx+"/crm/cs/csEntity/batchPermitOrForbitSo.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByTypeAndEmployee.htm",GEN_SO_EXCEL_URL:ctx+"/crm/cs/csEntity/genSoExcel.htm",NEED_RETURN_VISIT:ctx+"/crm/cs/csEntity/needReturnVisit.htm",BATCH_SETTOP_URL:ctx+"/crm/cs/csEntity/setTop.htm",GRID:"#csEntityGrid",PAGER:"#csEntityPager",};
CsEntity.prototype={init:function(){this._bindEventHander();this._initJqgrid();this.csEmployee.init();this._initSearch();this._buildEmployeeOption("");
this.addressServiceSearch.init({isSelect:"y",isNotRequired:true},function(){});this._locateToGlHelp();this._prodSearch();this._listShipName();this._initEmployeeWeixin();
this.formFrontConfig.init();this._bulidCsTag();$(".selectpicker").selectpicker({language:"zh_CN",dropupAuto:false,size:10});},_bulidCsTag:function(){var a=this;
var b=a._getContainer("csTagSearch");if(!b){return false;}FormUtils.loadData(ctx+"/gl/tag/tag/loadAllTag.htm?type=cs",function(c){var e=c.cateOptList;if(e&&e.length>0){var f=new StringBuffer();
for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].value+"'>"+e[d].name+"</option>");}b.empty().append(f.toString());}if(b&&b.is(".selectpicker")){b.selectpicker("refresh");
}});},_listShipName:function(){FormUtils.loadData(ctx+"/ec/ship/shipCompany/allActiveCompany.htm",function(b){if(b&&b.length>0){var c=new StringBuffer();
c.append("<option value=''>请选择</option>");for(var a=0;a<b.length;a++){c.append("<option value='"+b[a].id+"'>"+b[a].name+"</option>");}$("#firstShipName").empty().append(c.toString()).select2().trigger("change");
}});},_prodSearch:function(i){$(".searchProd").bsSuggest("destroy");var j=this;var b=$(".searchProd").width()+"px";var c="entity";var h="n";var d="n";var g="prodEntity-csEntity";
var e=window.sessionStorage.getItem(g);if(e){var f=JSON.parse(e);j._prodSearchSuggest(f);}else{var a=ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+h+"&storeId="+"&limitProdCate="+d+"&keyword=";
FormUtils.loadData(a,function(k){window.sessionStorage.setItem(g,JSON.stringify(k));j._prodSearchSuggest(k);});}},_prodSearchSuggest:function(a){var b=this;
var e=b._getContainer("searchProd");if(!e){return false;}var d=a.value;if(d&&d.length>0){var f=new StringBuffer();for(var c=0;c<d.length;c++){f.append("<option value='"+d[c].prodName+"'>"+d[c].prodName+"</option>");
}e.empty().append(f.toString());}if(e&&e.is(".selectpicker")){e.selectpicker("refresh");}},_locateToGlHelp:function(){if(type=="self"){var a="glHelp.csEntity.myCs";
}if(type=="mysub"){var a="glHelp.csEntity.subCs";}glHelpUtil.init(a);},_initSearch:function(){CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interestSearch",emptyOption:"noInterests"},{typeKey:"system",pKey:"CsBizTypes",container:"bizTypeSearch",emptyOption:"noBizTypes"},{typeKey:"system",pKey:"CsFollowType",container:"followSearch"},{typeKey:"system",pKey:"CsGenderType",container:"genderSearch"},{typeKey:"system",pKey:"CsEntryType",container:"entrySearch"},{typeKey:"system",pKey:"income",container:"incomeSearch"},{typeKey:"system",pKey:"taste",container:"tasteSearch"},{typeKey:"system",pKey:"winePurpose",container:"purposeeSearch"}]);
this._initInterestsSelect();this._initBizTypeSelect();this._buildLevelOption();this._buildEavSearchCondition();ChannelUtils.getOptions({container:"srcSearch",caption:"全部",emptyOptions:"null"});
if("self"==type){$(".groupSelect").hide();}},_initInterestsSelect:function(){var a=this;a.isInitInterests=true;a.interestsTimer=setInterval(function(){if(a.isInitInterests){$("#interestSearch").selectpicker("refresh");
$("#interestSearch").selectpicker("val",[]);clearInterval(a.interestsTimer);a.interestsTimer=null;}},250);},_initBizTypeSelect:function(){var a=this;a.isInitBizType=true;
a.bizTypeTimer=setInterval(function(){if(a.isInitBizType){$("#bizTypeSearch").selectpicker("refresh");$("#bizTypeSearch").selectpicker("val",[]);clearInterval(a.bizTypeTimer);
a.bizTypeTimer=null;}},250);},_initEmployeeWeixin:function(c,b){var a=this;FormUtils.loadData(CsEntity._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId=&groupId=&type=android",function(e){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].userName+"'>"+e[d].alias+"</option>");}$("#employee-wx-select").empty().append(f.toString());
$("#employee-wx-select").select2();});},_hideNotGrantBtn:function(){if(type=="self"){if(!ResUtils.canShow("csEntity.button.returnVisit")){$(".isReturnVisit").hide();
}if(!ResUtils.canShow("csEntity.button.increateYouZanPoint")){$(".batchIncreateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.permitPlaceSo")){$(".batchPermitPlaceSo").hide();
}if(!ResUtils.canShow("csEntity.button.batchForbitPlaceSo")){$(".batchForbitPlaceSo").hide();}if(!ResUtils.canShow("csEntity.button.add")){$(".csEntityAdd").hide();
}if(!ResUtils.canShow("csEntity.button.addWx")){$(".csEntityWxAdd").hide();}if(!ResUtils.canShow("csEntity.button.edit")){$(".csEntityEdit").hide();}if(!ResUtils.canShow("csEntity.button.assignCs")){$(".csEntityEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.soAdd")){$(".csEntitySoAdd").hide();}if(!ResUtils.canShow("csEntity.button.soPointAdd")){$(".csEntitySoPointAdd").hide();
}if(!ResUtils.canShow("csEntity.button.batchSms")){$(".csEntityBatchSendSms").hide();}if(!ResUtils.canShow("csEntity.button.aliTemplateSms")){$(".aliTemplateSms").hide();
}if(!ResUtils.canShow("csEntity.button.batchUpdate")){$(".csEntityBatchUpdate").hide();}if(!ResUtils.canShow("csEntity.button.batchCreateForSub")){$(".csEntityBatchCreateForSub").hide();
}if(!ResUtils.canShow("csEntity.button.soList")){$(".csEntitySoList").hide();}if(!ResUtils.canShow("csEntity.button.saleAfter")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcel")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importOrderExcel")){$(".importOrderExcel").hide();
}if(!ResUtils.canShow("csEntity.button.importExcel")){$(".importExcel").hide();}if(!ResUtils.canShow("csEntity.button.genExcel")){$(".toGenExcel").hide();
}if(!ResUtils.canShow("csEntity.button.genSoExcel")){$(".genSoExcel").hide();}if(!ResUtils.canShow("csEntity.button.delete")){$(".batchDelete").hide();
}if(!ResUtils.canShow("csEntity.button.toSea")){$(".csEntityToSea").hide();}if(!ResUtils.canShow("csEntity.button.setTop")){$(".csEntitySetTop").hide();
$(".csEntityCancelTop").hide();}if(!ResUtils.canShow("csEntity.limit.wineIndustry")){$(".wineIndustryDiv").hide();$(".wineIndustryDiv").hide();}}else{if(type=="mysub"){if(!ResUtils.canShow("csEntity.button.subReturnVisit")){$(".isReturnVisit").hide();
}if(!ResUtils.canShow("csEntity.button.increateYouZanPointSub")){$(".batchIncreateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.permitPlaceSo")){$(".batchPermitPlaceSo").hide();
}if(!ResUtils.canShow("csEntity.button.batchForbitPlaceSo")){$(".batchForbitPlaceSo").hide();}if(!ResUtils.canShow("csEntity.button.addSub")){$(".csEntityAdd").hide();
}if(!ResUtils.canShow("csEntity.button.wxAddSub")){$(".csEntityWxAdd").hide();}if(!ResUtils.canShow("csEntity.button.editSub")){$(".csEntityEdit").hide();
}if(!ResUtils.canShow("csEntity.button.assignCsSub")){$(".csEntityEmployee").hide();}if(!ResUtils.canShow("csEntity.button.soAddSub")){$(".csEntitySoAdd").hide();
}if(!ResUtils.canShow("csEntity.button.soPointAddSub")){$(".csEntitySoPointAdd").hide();}if(!ResUtils.canShow("csEntity.button.soListSub")){$(".csEntitySoList").hide();
}if(!ResUtils.canShow("csEntity.button.batchSmsSub")){$(".csEntityBatchSendSms").hide();}if(!ResUtils.canShow("csEntity.button.batchUpdateSub")){$(".csEntityBatchUpdate").hide();
}if(!ResUtils.canShow("csEntity.button.batchCreateForSubSub")){$(".csEntityBatchCreateForSub").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSub")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcelSub")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importExcelSub")){$(".importExcel").hide();
}if(!ResUtils.canShow("csEntity.button.importOrderExcelSub")){$(".importOrderExcel").hide();}if(!ResUtils.canShow("csEntity.button.genExcelSub")){$(".toGenExcel").hide();
}if(!ResUtils.canShow("csEntity.button.genSoExcelSub")){$(".genSoExcel").hide();}if(!ResUtils.canShow("csEntity.button.deleteSub")){$(".batchDelete").hide();
}if(!ResUtils.canShow("csEntity.button.toSeaSub")){$(".csEntityToSea").hide();}if(!ResUtils.canShow("csEntity.button.setTopSub")){$(".csEntitySetTop").hide();
$(".csEntityCancelTop").hide();}if(!ResUtils.canShow("csEntity.limit.wineIndustry")){$(".wineIndustryDiv").hide();$(".wineIndustryDiv").hide();}}else{if(type=="search"){$(".csEntitySoAdd").hide();
$(".csEntitySoPointAdd").hide();if(!ResUtils.canShow("csEntity.button.addSearch")){$(".csEntityAdd").hide();}if(!ResUtils.canShow("csEntity.button.wxAddSearch")){$(".csEntityWxAdd").hide();
}if(!ResUtils.canShow("csEntity.button.editSearch")){$(".csEntityEdit").hide();}if(!ResUtils.canShow("csEntity.button.assignCsSearch")){$(".csEntityEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.soListSearch")){$(".csEntitySoList").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSearch")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcelSearch")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importExcelSearch")){$(".importExcel").hide();
}}}}},_bindEventHander:function(){var a=this;$(".list_wrapper").on("click",".csEntitySearch",function(){a.rfmtSearch.dealTip();var b=CsEntityUtils.getSearchParams(a.rfmtSearch);
a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$("body").on("click",".csEntitySetTop",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户置顶吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchSetTop(b,"y");}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");
}});$("body").on("click",".csEntityCancelTop",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户取消置顶吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchSetTop(b,"n");
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");}});$("body").on("click",".batchIncreateYouZanPoint",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要同步的客户");return;}FormUtils.loadData(ctx+"/crm/cs/csEntity/increateYouzanPoint.htm?ids="+b,function(c){});
});$(".inPhone").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum=13533435687&inNum=18300123456","客户信息");});$("#belongOgnName").on("click",function(){var b={isMultiple:1,selectedGroupId:$("input[name='belongOgn']").val(),container:"belongOgnName",nolimit:true,positionType:type=="search"?"all":"dept_manager,cs_search",fn:function(c){$("input[name=belongOgn]").val(c);
a._buildEmployeeOption(c);}};GroupUtils.selectGroupTreeBox(b);});$("body").on("click",".csEntityAdd",function(){a._add(0,"新增客户");});$("body").on("click",".csEntityWxAdd",function(){a._add(1,"新增微信客户");
});$("body").on("click",".csEntityEdit",function(){ConfigUtils.findByKey("csEntity.removeHeight",function(c){if(c.success){$("#csEntityForm .heightWeightDiv").hide();
}});var b=$(this).attr("idVal");if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要更新的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时编辑多条记录");
return;}b=a.selectedJqgrid[0];}a._edit(b);});$("body").on("click",".csEntityEditTmp",function(){var b=$(this).attr("attr-id");a._edit(b);});$("body").on("click",".csEntitySoAdd",function(){var b=$(this);
ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placeGeneralOrderMethod(b,a);return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placeGeneralOrderMethod(b,a);
return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var f=DateUtils.timeRangeJudge(c,d);if(!f){a._placeGeneralOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});
});$("body").on("click",".csEntitySoPointAdd",function(){var b=$(this);ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placePointsOrderMethod(b,a);
return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placePointsOrderMethod(b,a);return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var f=DateUtils.timeRangeJudge(c,d);
if(!f){a._placePointsOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});});$("body").on("click",".csEntitySoList",function(){var b=$(this).attr("idVal");
if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要查看客户的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多条记录");
return;}b=a.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",b);var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);
}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+d+"]订单");});$("body").on("click",".csEntitySoListTmp",function(){var b=$("#csEntityForm").find("[name=id]").val();
var c=$("#csEntityForm").find("[name=name]").val();if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+c+"]订单");
});$(document).on("click",".csEntityBatchUpdate",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b&&b.length>0){a._csEntityBatchUpdate(b);
}else{a._csEntityBatchUpdate(b);}});$(document).on("click",".isReturnVisit",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){a._csNeedReturnVisit(b);}else{DialogUtils.error("提示","请选择需要回访的客户！");}});$(document).on("click",".csEntityBatchCreateForSub",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){var d={csIds:b.join(","),};d.callbackFn=function(){DialogUtils.success("成功","操作成功");$(CsEntity._CONS_.GRID).jqGrid("resetSelection");
};var c=new CreateForSub();c.init(d);}else{DialogUtils.error(msgCode.ERROR,"请选择要创建从客户的条目");}});$(document).on("click",".csEntityBatchCall",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){a._csEntityBatchCall(b);}});$("body").on("click",".csEntitySoAfterList",function(){var b=$(this).attr("idVal");if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要退换货的客户");
return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多个客户");return;}b=a.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",b);
var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_AFTER_LIST_URL+"?csId="+b,"客户["+d+"]退换货订单");
});$("#csEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".csEntitySearch").eq(0).trigger("click");}});$("button.clearCsEntitySearchFormBtn").on("click",function(){FormUtils.clear("csEntitySearchForm");
if(a._getContainer("searchProd")){a._getContainer("searchProd").selectpicker("refresh");}if(a._getContainer("srcSearch")){a._getContainer("srcSearch").selectpicker("refresh");
}if(a._getContainer("interestSearch")){a._getContainer("interestSearch").selectpicker("refresh");}if(a._getContainer("bizTypeSearch")){a._getContainer("bizTypeSearch").selectpicker("refresh");
}if(a._getContainer("csTagSearch")){a._getContainer("csTagSearch").selectpicker("refresh");}if(a._getContainer("eavSearch")){a._getContainer("eavSearch").selectpicker("refresh");
}});$(document).on("click",".newSearch",function(){var b="turnNew=y";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".notFollowSearch",function(){var b=DateUtils.getBeforeDate(7);
var c="hightFollowTime="+b+"&includeNotFollow=true";a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$(document).on("click",".birthdaySearch",function(){var b="csCare=birthday";
a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".buyWeekSearch",function(){var b="csCare=buyWeek";a.selectedJqgrid=new Array();
a.reloadJqgrid(b);});$(document).on("click",".buyMonthSearch",function(){var b="csCare=buyMonth";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".toDayRegisterPlace",function(){var b=new Date();
var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";c+="&toDayRegisterPlace=toDayRegisterPlace";a.selectedJqgrid=new Array();
a.reloadJqgrid(c);});$(document).on("click",".toDayRegister",function(){var b=new Date();var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";
a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$("#seniorSearch").on("click",function(){if($(this).text().indexOf("展开")!=-1){$("#seniorSearchDiv").slideDown("fast",function(){});
$(this).empty().append('收起<span class="fa fa-sort-up"></span>');}else{$(this).empty().append('展开<span class="fa fa-sort-down"></span>');$("#seniorSearchDiv").slideUp("fast");
}a.rfmtSearch.dealTip();});$("#seniorSearch2").on("click",function(){$("#seniorSearch").empty().append('展开<span class="fa fa-sort-down"></span>');$("#seniorSearchDiv").slideUp("fast");
a.rfmtSearch.dealTip();});$(document).on("change",".numberInput",function(){if($(this).val()>=0){}else{$(this).val(0);}});$("body").on("click",".toGenExcel",function(){excelUtil.toGenExcel("csEntity","生成客户excel模板","客户模板");
});$("body").on("click",".genSoExcel",function(){window.location.href=CsEntity._CONS_.GEN_SO_EXCEL_URL;});$("body").on("click",".importExcel",function(){var b={"importUrl":CsEntity._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入客户excel数据"};
if(ResUtils.canShow("csEntity.sub.batchCreate")){b.isCreateSub="isCreateSub";}excelUtil.importExcel(b);});$("body").on("click",".importOrderExcel",function(){var b={"importUrl":CsEntity._CONS_.IMPORT_ORDER_EXCEL_URL,"tabTitle":"导入订单excel数据"};
excelUtil.importExcel(b);});$(document).on("change"," .csDesc",function(){var b=$(this)[0].checked;if(b){a.simpleShowDesc=true;window.localStorage.setItem("simpleShowDesc",true);
$(this).closest(".ui-jqgrid").find(".tooltip-desc").show();$(this).closest(".ui-jqgrid").find(".desc-detail").hide();}else{a.simpleShowDesc=false;window.localStorage.setItem("simpleShowDesc",false);
$(this).closest(".ui-jqgrid").find(".tooltip-desc").hide();$(this).closest(".ui-jqgrid").find(".desc-detail").show();}});$("body").on("click",".toExportExcel",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
a._toExportExcel(b);});$("body").on("click",".exportExcel",function(){$(".exportExcel").attr("disabled",true);a._exportExcel();});$("body").on("click","#allCheck",function(){var b=true;
if(!$(this).is(":checked")){b=false;}$("#columnContainer").find(".columnCheckBox").each(function(){$(this).prop("checked",b);});});$("body").on("click",".prevBtn",function(){a._toList();
});$("body").on("click",".batchPermitPlaceSo",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认允许选中的客户下单吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchPermitSo(b);
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");}});$("body").on("click",".batchForbitPlaceSo",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认禁止选中的客户下单吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchForbitSo(b);}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");
}});$("body").on("click",".batchDelete",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认要删除选中的客户资料吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchDelete(b);
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");}});$("body").on("click",".csEntityToSea",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户资料移入公海吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchToSea(b);}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");
}});$("body").on("click",".csEntityBatchSendSms",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b&&b.length>0){var d=new SendMessage();
var c={csIds:b};d.openBatchSendMessageView(c);}else{DialogUtils.error(msgCode.ERROR,"请选择要发短信的客户");}});$("body").on("click",".aliTemplateSms",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){var d=new SendMessage();var c={csIds:b};d.openAilTemplateMessageView(c);}else{DialogUtils.error(msgCode.ERROR,"请选择要发短信的客户");}});$("body").on("click",".aliTemplateModalSend",function(){var c=$("#aliTemplateModalCsIds").val();
var b=$(".aliTemplateModalSelect").val();FormUtils.submit(SendMessage._CONS_.SEND_ALI_TEMPLATE_URL,{"csIds":c,"type":b},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
}else{DialogUtils.error(msgCode.ERROR,d.msg);}$("#aliTemplateModal").modal("hide");},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});});$("body").on("change",".aliTemplateModalSelect",function(){var b=$(".aliTemplateModalSelect").find("option:selected").attr("content");
$(".aliTemplateModalContent").empty().append(b);});},_csNeedReturnVisit:function(a){DialogUtils.confirmWithOptions({title:"确定当前选中客户需要回访？",text:"",confirmButtonText:"确定",yesFunc:function(){FormUtils.submit(CsEntity._CONS_.NEED_RETURN_VISIT,{csId:a},function(b){if(b){DialogUtils.success(msgCode.INFO,"操作成功");
}else{DialogUtils.error(msgCode.ERROR,"操作失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});$("#csEntitySearchForm").find(".csEntitySearch").trigger("click");
}});},_csEntityBatchUpdate:function(c){var a=this;var e=CsEntityUtils.getSearchParams(a.rfmtSearch);e=CsEntityUtils.getSearchParamToObj(e);e.type=type;
var d=0;if(c&&c.length>0){d=c.length;e.ids=c;}else{d=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","records");}var b=new CsEntityBatchUpdate();b.init({count:d,searchParam:e});
},_csEntityBatchCall:function(c){var a=this;var e={};var d=0;if(c&&c.length>0){d=c.length;}e.count=d;e.csIds=c;var b=new CsEntityBatchCall();b.init(e);
},reloadJqgrid:function(a){window.localStorage.setItem("csentity_need_clear_selectedJqgrid","true");JTJqgridUtils.reloadJqgrid(CsEntity._CONS_.GRID,a);
},_initJqgrid:function(h){var a=this;var c=CsEntity._CONS_.LIST_DATA_URL+"?1=1&Q__S__EQ__entity.is_sea_=n";if("newMonth"==filterType){var b=DateUtils.getCurrentMonthFirst();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("turnNew"==filterType){$("#turnNewSearch").val("y");
c=c+"&turnNew=y";}else{if("turnNew_org"==filterType){$("#turnNewSearch").val("y");c=c+"&turnNew=y";type="mysub";}else{if("allCs_today"==filterType){var b=new Date();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("allCs_month"==filterType){var b=DateUtils.getCurrentMonthFirst();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("allCs_repeatBuy"==filterType){var b=DateUtils.getCurrentMonthFirst();
c=c+"&soPlaceTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("byPhone"==filterType){c=c+"&phoneNums="+phoneNums;}}}}}}}c=c+"&type="+type+"&currentPositionId="+currentPositionId;
if(turnNew){c+="&turnNew="+turnNew;}if(csCare){c+="&csCare="+csCare;}if(belongEmployee){c+="&belongEmployee="+belongEmployee;}if(Q__D__EQ__create_time_){c+="&Q__D__BW__entity.create_time_="+Q__D__EQ__create_time_;
}if(csType&&csType=="newCs"){c+="&Q__N__EQ__entity.so_complete_=1";}else{if(csType&&csType=="oldCs"){c+="&Q__N__GT__entity.so_complete_=1";}}var f=false;
if("self"==type){f=true;}var e=false;if("finance"==versionType){e=true;}var d=$(window).width();var g=true;ConfigUtils.findByKey("csEntity.limit.wineIndustry",function(j){if(j.success){g=false;
$(".wineIndustryDiv").show();}var i=true;if(ResUtils.canShow("csEntity.button.csListShowSrc")){i=false;}ConfigUtils.findByKey("csEntity.hiddenConsumeField",function(l){var k=false;
if(l.success){k=true;}if(isSelectCsEntity){c+="&isSelectCsEntity="+isSelectCsEntity;}ConfigUtils.findByKey("csEntity.createTimeToMonth",function(n){var m={RScore:RScore,FScore:FScore};
if(n.success&&"mysub"==type){$("input[name=lowRegisterTime]").val(DateUtils.getBeforeMonth(1)+" 00:00:00");m={RScore:RScore,FScore:FScore,lowRegisterTime:DateUtils.getBeforeMonth(1)+" 00:00:00"};
}ConfigUtils.findByKey("csEntity.isOpenTop",function(q){var p=false;if(q.success){p=true;}var o=[{modelName:"code",name:"code",index:"entity.code_",width:100,isBase:"true",formatter:function(r,s,u){if(u.isTop=="y"){a.toTop.push(u.id);
}if(u.footData){$(".ui-jqgrid-title").css({"width":"100%"});var t="<div style='float:left'>"+u.code+"</div>"+"<div style='float:right;position:relative;'>"+"</div>";
$(CsEntity._CONS_.GRID).jqGrid("setCaption",t);return u.code;}else{var v=new StringBuffer();v.append('<div class="nameClass">');if(u.turnNew=="y"){v.append("<span style='color:red'>新</span>");
}if(u.isSub=="y"){v.append("<span style='color:red;white-space:pre'> 从</span>");}v.append(u.code);v.append("</div>");return v.toString();}}},{modelName:"_name",name:"_name",index:"entity._name_",width:100,formatter:function(r,s,t){return"<a class='csEntityEditTmp' attr-id='"+t.id+"'>"+t.name+"</a>";
}},{modelName:"name",name:"name",index:"entity.name_",hidden:true},{modelName:"oper",name:"oper",index:"entity.oper_",width:80,isBase:"true",formatter:function(r,s,t){if(t.footData){return t.code;
}else{var u=new StringBuffer();u.append("<button title='下订单' class='btn btn-sm btn-primary csEntitySoAdd' attr-name='"+t.name+"' idVal='"+t.id+"'>订</button>&nbsp;");
u.append("<button title='转员工' class='btn btn-sm btn-primary csEntityEmployee' idVal='"+t.id+"'>转</button>&nbsp;");return u.toString();}}},{name:"pureCode",hidden:true,formatter:function(r,s,t){return t.code;
}},{modelName:"isOrderSo",name:"isOrderSo",width:50,index:"entity.is_order_so_",formatter:function(r,s,u){var t=u.isOrderSo;if(t=="y"){return"是";}else{return"<font style='color:red;'>否</font>";
}}},{modelName:"gender",name:"gender",index:"entity.gender_",width:35,isBase:"true"},{modelName:"care",name:"care",index:"care",isBase:"true",width:50,sortable:false,formatter:function(r,z,s){var u=new StringBuffer();
var x=new Date();var v=DateUtils.format(x,"yyyy-MM-dd")+" 00:00:00";var w="";if(s.birthday.length<9||s.birthday.length==5){w=x.getFullYear()+s.birthday+" 00:00:00";
}else{w=x.getFullYear()+"-"+s.birthday.substring(5,s.birthday.length)+" 00:00:00";}var t=DateUtils.getDateDiff(v,w,"day");if(t<=7&&t>=0){var y=ctx+"/img/jt/cake2.png";
if(t==0){u.append("<div title='今天生日' style='background-image:url(/t9-ecm/img/jt/cake2.png);width:20px; height:20px;margin:0 auto;'></div>");}else{u.append("<div title='"+w.substring(5,10)+"生日, 还差"+t+"天' style='background-image:url(/t9-ecm/img/jt/cake2.png);width:20px; height:20px;margin:0 auto;'></div>");
}}if(s.lastCompleteTime){if(DateUtils.getDateDiff(s.lastCompleteTime,v,"day")>7&&DateUtils.getDateDiff(s.lastCompleteTime,v,"day")<28){u.append("<div title='购买满7天' style='background-image:url(/t9-ecm/img/jt/7.png);width:20px; height:20px;margin:0 auto;'></div>");
}if(DateUtils.getDateDiff(s.lastCompleteTime,v,"day")>=28){u.append("<div title='购买满28天' style='background-image:url(/t9-ecm/img/jt/28.png);width:20px; height:20px;margin:0 auto;'></div>");
}}return u.toString();}},{modelName:"bizType",name:"bizType",index:"entity.biz_type_",width:70,sortable:true,isBase:"true",},{modelName:versionType&&versionType=="finance"?"isTurnover":"hasDeal",name:versionType&&versionType=="finance"?"isTurnover":"hasDeal",index:versionType&&versionType=="finance"?"entity.is_turnover_":"entity.so_total_",width:35,sortable:true,isBase:"true",formatter:function(r,s,u){var t="<div  style='background-image:url(/t9-ecm/img/jt/queren.png);width:20px; height:20px;margin:0 auto;'></div>";
if(versionType&&versionType=="finance"){if(r&&r=="y"){return t;}else{return"";}}else{if(u.soTotal&&u.soTotal>0){return t;}else{return"";}}}},{modelName:"soComplete",name:"soComplete",index:"entity.so_complete_",width:35,isBase:"true"},{modelName:"soTotal",name:"soTotal",index:"entity.so_total_",width:70,hidden:k,isBase:"true",formatter:function(r,s,t){return t.soTotal;
}},{modelName:"jdPoint",name:"jdPoint",index:"entity.jd_point_",hidden:g,width:60,sortable:true},{modelName:"youzanPoint",name:"youzanPoint",index:"entity.youzan_point_",hidden:g,width:60,sortable:true},{modelName:"interests",name:"interests",index:"entity.interests_",width:80,sortable:true},{modelName:"productName",name:"productName",index:"entity.product_name_",width:80,sortable:true,isBase:"true"},{modelName:"srcNames",name:"srcNames",index:"entity.srcs_",width:80,sortable:true,hidden:i,isBase:"true"},{modelName:"relatedWeixin",name:"relatedWeixin",index:"entity.related_weixin_",width:80,sortable:true,formatter:function(r,s,u){var t="<div  style='background-image:url(/t9-ecm/img/jt/queren.png);width:20px; height:20px;margin:0 auto;'></div>";
if(r=="y"){return t;}else{return"";}}},{modelName:"prName",name:"prName",index:"entity.pr_name_",width:120,sortable:true,formatter:function(r,t,u){var v=new StringBuffer();
if(u.prName){v.append(u.prName);}if(u.ciName){v.append(",").append(u.ciName);}var s=v.toString();if(s){s=s.replace("省","");s=s.replace("市","");s=s.replace("自治区","");
s=s.replace("自治州","");}return s;}},{modelName:"lastFollowTime",name:"lastFollowTime",index:"entity.last_follow_time_",width:82,isBase:"true",formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"follow",name:"follow",index:"entity.follow_",width:70,isBase:"true"},{modelName:"lastFollowContent",name:"lastFollowContent",index:"entity.last_follow_content_",sortable:false,width:100,formatter:function(r){var s="";
if(r!=""&&r!=null){s='<span  style="color:#1ab394;'+(a.simpleShowDesc=="true"?"":"display:none")+'" class="tooltip-desc jt-grid-tip fa fa-bell"   data-value="'+r+'"></span>';
s+='<span style="'+(a.simpleShowDesc=="true"?"display:none":"")+'" class="desc-detail">'+r+"</span>";}return s;}},{modelName:"desc",name:"desc",index:"entity.desc_",width:100,isBase:"true",formatter:function(s){var r="";
if(s!=""&&s!=null){r='<span  style="color:#1ab394;'+(a.simpleShowDesc=="true"?"":"display:none")+'" class="tooltip-desc jt-grid-tip fa fa-bell" data-toggle="tooltip"  data-value="'+s+'"></span>';
r+='<span style="'+(a.simpleShowDesc=="true"?"display:none":"")+'" class="desc-detail">'+s+"</span>";}return r;}},{modelName:"turnTime",name:"turnTime",index:"entity.turn_time_",width:82,formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"lastCompleteTime",name:"lastCompleteTime",index:"entity.last_complete_time_",width:82,formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"employeeName",name:"employeeName",index:"entity.employee_id_",width:100,hidden:f,formatter:function(r,s,t){if(t.employeeAid){return t.employeeAid+":"+t.employeeName;
}return t.employeeAid;}},{modelName:"groupName",name:"groupName",index:"entity.group_Id_",width:70,hidden:f},{modelName:"createTime",name:"createTime",index:"entity.create_time_",width:82,isBase:"true",formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"phone",name:"phone",index:"entity.phone",hidden:true,width:60},{modelName:"subPhone",name:"subPhone",index:"entity.subPhone",hidden:true,width:60}];
$(CsEntity._CONS_.GRID).JTJqgrid({url:c,pager:CsEntity._CONS_.PAGER,postData:m,width:"100%",autowidth:true,colNames:["客户编号","姓名","客户姓名（隐藏）","操作","客户编号(隐藏)","约单","性别","关怀","分类","成交","N次","消费(元)","京享值","有赞积分","意向","产品意向","渠道","微信","地区","最新跟进","跟进标签","跟进内容","备注","转单时间","最新签收","工号","部门","注册时间","手机号","从属客户手机号码"],colModel:o,sortname:p?"entity.is_top_ desc,entity.turn_time_":"",sortorder:p?"DESC":"",footerrow:true,userDataOnFooter:true,simplify:{key:"wdkh",entry:[{sName:"精简显示",sClass:"csDesc",sCheck:a.simpleShowDesc=="true"}],must:["客户编号","姓名"],base:["操作","性别","关怀","分类","成交","N次","消费(元)","产品意向","渠道","最新跟进","跟进标签","备注"],other:["约单","京享值","有赞积分","意向","微信","地区","跟进内容","转单时间","最新签收"]},loadComplete:function(){if("true"==window.localStorage.getItem("csentity_need_clear_selectedJqgrid")){a.selectedJqgrid=new Array();
window.localStorage.removeItem("csentity_need_clear_selectedJqgrid");}for(var s=0;s<a.selectedJqgrid.length;s++){$(CsEntity._CONS_.GRID).jqGrid("setSelection",a.selectedJqgrid[s]);
}if("search"==type){$("a.csEntitySoAdd").hide();}if($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records")<1000){$("#endExportNum").val($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records"));
}else{$("#endExportNum").val(1000);}if(a.toTop.length>0){for(var s=0;s<a.toTop.length;s++){$("#"+a.toTop[s]).addClass("jt-grid-totop");}a.toTop=[];}a._hideNotGrantBtn();
var r=$(CsEntity._CONS_.GRID).getGridParam("width");$(CsEntity._CONS_.GRID).setGridWidth(r);$(window).resize();},gridComplete:function(){var r=$(CsEntity._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
r.find('td[aria-describedby*="rn"],td[aria-describedby*="cb"],td[aria-describedby*="care"],td[aria-describedby*="srcNames"],td[aria-describedby*="relatedWeixin"],td[aria-describedby*="name"],td[aria-describedby*="gender"],td[aria-describedby*="bizType"],td[aria-describedby*="winePurpose"],td[aria-describedby*="taste"],td[aria-describedby*="hasDeal"],td[aria-describedby*="soRepeatBuy"],td[aria-describedby*="soTotal"],td[aria-describedby*="interests"],td[aria-describedby*="productName"],td[aria-describedby*="follow"],td[aria-describedby*="turnTime"],td[aria-describedby*="lastCompleteTime"],td[aria-describedby*="employeeName"],td[aria-describedby*="levelName"],td[aria-describedby*="lastFollowTime"],td[aria-describedby*="canPlaceSo"],td[aria-describedby*="soComplete"],td[aria-describedby*="jdPoint"],td[aria-describedby*="prName"],td[aria-describedby*="desc"],td[aria-describedby*="groupName"],td[aria-describedby*="createTime"]').hide();
r.find('td[aria-describedby*="csEntityGrid_code"]').show();r.hide();},onSelectAll:function(t,r){if(t&&t.length>0){for(var s=0;s<t.length;s++){if(r){if(a.selectedJqgrid.indexOf(t[s])==-1){a.selectedJqgrid.push(t[s]);
}}else{a.selectedJqgrid.remove(t[s]);}}}},onSelectRow:function(s,r){if(r){if(a.selectedJqgrid.indexOf(s)==-1){a.selectedJqgrid.push(s);}}else{a.selectedJqgrid.remove(s);
}},ondblClickRow:function(r){if(r){}},onSortCol:function(s,t,r){a.sortColumn=s;a.sortorder=r;}});});});});});},_add:function(a,b){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/add.htm?type="+type+"&csType="+a,b);
},_edit:function(c,a){var b="客户["+$(CsEntity._CONS_.GRID).jqGrid("getRowData",c).name+"]";if("self"==type){if(ResUtils.canShow("csEntity.button.edit")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+c,b);
}}else{if("mysub"==type){if(ResUtils.canShow("csEntity.button.editSub")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+c,b);
}}}},_toExportExcel:function(b){var a=this;$(".list_wrapper").hide();$(".form_wrapper").hide();$(".excel_wrapper").show();$(".prevBtn").show();$(".exportExcel").attr("disabled",false);
$("input[name=selectIds]").val("");if(b&&b.length>0){$("input[name=selectIds]").val(b);$("#endExportNum").val(b.length);}var c=[];var d=LocalStorageUtils.get("CS_EXPORT_COLUMNS_"+currentUserId);
if(d){c=d.split(",");}excelUtil.findExportColByModule("csEntity",true,function(f){var g=new StringBuffer();if(f&&f.length>0){for(var e=0;e<f.length;e++){g.append("<div class='checkbox checkbox-success checkbox-inline'>");
if($.inArray(f[e].devCode,c)!=-1){g.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}else{g.append("<input type='checkbox' class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}g.append("</div>");}}$("#columnContainer").empty().append(g.toString());});},_toList:function(){$(".list_wrapper").show();$(".form_wrapper").hide();$(".excel_wrapper").hide();
},_exportExcel:function(){var b=this;var d=$("#columnContainer").find(".columnCheckBox");var e=[];$(d).each(function(){if($(this).is(":checked")){e.push($(this).val());
}});var a=$("#beginExportNum").val();var c=$("#endExportNum").val();if(!a){DialogUtils.error(msgCode.ERROR,"请填写正确的开始记录");return;}if(!c){DialogUtils.error(msgCode.ERROR,"请填写正确的结束记录");
return;}if(parseInt(a)>parseInt(c)){DialogUtils.error(msgCode.ERROR,"开始记录不能大于结束记录");return;}if(parseInt(a)-parseInt($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records"))>0){DialogUtils.error(msgCode.ERROR,"开始记录不能大于记录总条数");
return;}if(!c){c=a;}DialogUtils.confirmWithOptions({title:"是否确认导出客户资料",text:"若已经导出过，请勿重复导出",confirmButtonText:"确认",yesFunc:function(){b.rfmtSearch.dealTip();
LocalStorageUtils.set("CS_EXPORT_COLUMNS_"+currentUserId,e.toString());var f=$("input[name=selectIds]").val();var g=CsEntityUtils.getSearchParams(b.rfmtSearch);
if(f&&f.length>0){g+="&Q__S__IN__entity.id_="+f;}window.top.showTimming(parseInt(c)-parseInt(a));g=g+"&columns="+e.toString()+"&beginExportNum="+a+"&endExportNum="+c+"&type="+type+"&excelType="+$('input:radio[name="excelType"]:checked').val()+"&sidx="+b.sortColumn+"&sord="+b.sortorder;
FormUtils.submit(CsEntity._CONS_.EXPORT_EXCEL_URL,g,function(h){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},noFunc:function(){$(".exportExcel").attr("disabled",false);
}});},_buildLevelOption:function(){FormUtils.loadData(ctx+"/crm/point/levelDef/findActived.htm",function(b){if(b&&b.length>0){var c=new StringBuffer();
for(var a=0;a<b.length;a++){c.append("<option value='"+b[a].level+"'>"+b[a].name+"</option>");}$("#levelSearch").append(c.toString());}});},_buildEavSearchCondition:function(){var a=this;
var b=a._getContainer("eavSearch");if(!b){return false;}FormUtils.loadData(ctx+"/crm/cs/csEntity/getEavSetPo.htm",function(f){if(f&&f.eavAttrPos&&f.eavAttrPos.length>0){var e=f.eavAttrPos;
var g=new StringBuffer();for(var d=0;d<e.length;d++){g.append("<optgroup label='"+e[d].name+"'>");if(e[d].eavAttrOptPos&&e[d].eavAttrOptPos.length>0){for(var c=0;
c<e[d].eavAttrOptPos.length;c++){g.append("<option value='"+e[d].eavAttrOptPos[c].value+"'>"+e[d].eavAttrOptPos[c].label+"</option>");}}g.append("</optgroup>");
}b.empty().append(g.toString());}if(b&&b.is(".selectpicker")){b.selectpicker("refresh");}});},_buildEmployeeOption:function(c){var a=this;var b=CsEntity._CONS_.EMPLOYEE_LIST_URL+"?groupId="+c+"&type=dept_manager&notContainUserId=y";
FormUtils.loadData(b,function(e){var f=a._getContainer("belongEmployeeSearch");if(!f){return false;}if(e&&e.length>0){var g=new StringBuffer();for(var d=0;
d<e.length;d++){g.append("<option value='"+e[d].id+"'>"+e[d].aid+":"+e[d].name+"</option>");}f.empty().append(g.toString());}if(f&&f.is(".selectpicker")){f.selectpicker("refresh");
}},null,true);},_getContainer:function(b){var a=this;var c=false;if(b){c=$("#"+b);if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");
if(c.length==0){return false;}}}}return c;},_batchPermitSo:function(b){var a=CsEntity._CONS_.BATCH_CHANGE_CAN_PLACE_SO_URL;FormUtils.submit(a,{"ids":b,canPlaceSo:"y"},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"更改成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},_batchForbitSo:function(b){var a=CsEntity._CONS_.BATCH_CHANGE_CAN_PLACE_SO_URL;
FormUtils.submit(a,{"ids":b,canPlaceSo:"n"},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"更改成功");$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}});},_batchDelete:function(b){var a=CsEntity._CONS_.BATCH_DELETE_URL;FormUtils.submit(a,{"ids":b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"客户资料删除成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},_batchToSea:function(b){var a=CsEntity._CONS_.BATCH_TOSEA_URL;
FormUtils.submit(a,{"ids":b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"客户资料转移成功");$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}});},_batchSetTop:function(c,b){var a=CsEntity._CONS_.BATCH_SETTOP_URL;FormUtils.submit(a,{"ids":c,isTop:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_placeGeneralOrderMethod:function(f,b){var a=f.attr("idVal");
if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");
return;}a=b.selectedJqgrid[0];}var d=$(CsEntity._CONS_.GRID).jqGrid("getRowData",a);var c=d["canPlaceSo"];if(c=="否"){DialogUtils.error("提示","该客户已被禁止下单");
return;}var e=f.attr("attr-name");JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=false&csId="+a+"&type="+type,"["+e+"]下订单");
},_placePointsOrderMethod:function(e,b){var a=e.attr("idVal");if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");
return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");return;}a=b.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",a);
var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=true&csId="+a+"&type="+type,"客户["+d+"]下积分订单");
},};function parentCMD(){$(".csEntitySearch").trigger("click");}var glHelpUtil={init:function(a){this._createGlHelpTag();this._bindEventHandler(a);},_createGlHelpTag:function(){var a=new StringBuffer();
a.append("<a style='margin-left:10px' title='帮助'><img src='/t9-ecm/img/jt/help.png'></a>");$("#glHelpContainer").empty().append(a.toString());},_bindEventHandler:function(a){$(document).on("click","#glHelpContainer",function(){FormUtils.loadData(ctx+"/gl/km/glHelp/findGlHelpData.htm"+"?cateKey="+a,function(b){JTTabUtils.addOrRefreshTab(b.url,"<"+b.name+"> "+"帮助文档");
});});},};