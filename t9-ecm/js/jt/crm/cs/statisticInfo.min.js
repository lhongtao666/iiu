function StatisticInfo(){this.hadInit=false;this.data=null;this.csId="";}StatisticInfo._CONS_={DYNAMIC_URL:ctx+"/crm/cs/csEntity/findDynamicByCsId.htm",SAVE_HEAD_IMG_URL:ctx+"/crm/cs/csEntity/saveHeadImg.htm",};
StatisticInfo.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._dealStyle();this._fillDynamicData(a);this.csId=a;
if(type=="self"){$(".addHeadImg").show();}}},_dealStyle:function(){var a=this;$("#statisticInfoDiv").height($("body").height()-100);$("#cs-dynamic-info").width($("body").width()-420);
if(a.data){a._initLine(a.data);}},_bindEventHander:function(){var a=this;$("#csInfoOrderLi").on("click",function(){if(a.watchTab){return false;}a.watchTab=setInterval(function(){a.counterTab+=250;
if($("#csInfoOrderTab").is(":visible")||a.counterTab>=5000){a._initLine(a.data);clearInterval(a.watchTab);delete a.watchTab;delete a.counterTab;}},250);
});$(window).on("resize",function(){a._dealStyle();});$(document).on("click",".soTab",function(){var c=$(this).attr("value");var d=$("#csEntityForm").find("input[name='name']").val();
var b=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";if(c&&c!=""){JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/detail.htm?soNo="+c+"&canShowScTrankNo="+b,d+"的订单明细");
}});$(".addHeadImg").on("click",function(){ImageUtils.selectImage(0,function(b){if(b.length>=1){a._saveHeadImg(b[0].url);}});});},_saveHeadImg:function(b){var a=StatisticInfo._CONS_.SAVE_HEAD_IMG_URL;
var c={id:this.csId,profile:b};FormUtils.submit(a,c,function(d){if(d.success){$(".cs-head-img").attr("src",ctx+b);DialogUtils.success("提示","修改成功");}else{DialogUtils.error("失败","修改失败");
}});},_fillDynamicData:function(c){var a=this;var b=StatisticInfo._CONS_.DYNAMIC_URL+"?csId="+c;FormUtils.loadData(b,function(d){a._setDynamicData(d);a._setOrderData(d);
a._setFollowData(d);a._setCallData(d);});},_setDynamicData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;a++){if(b[a].type=="订单日志"&&!(b[a].content=="订单已签收"||b[a].content=="订单审核通过"||b[a].content.indexOf("订单拒收")!=-1||b[a].content.indexOf("订单包裹丢失")!=-1)){continue;
}if(b[a].type=="订单跟进"){continue;}if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");
}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">');
if(b[a].type=="客户跟进"||b[a].type=="档案情况跟进"){e.append("<b>"+b[a].type+"</b>：").append("<span style='color:red;'>"+b[a].content+"</span>");}else{e.append(b[a].contentExt!=""?b[a].contentExt:b[a].content);
}e.append("</div></div>");}$("#cs-dynamic-date-line").empty().append(e.toString());},_getDateName:function(a){if(DateUtils.getDateDiff(a,DateUtils.format(new Date(),"yyyy-MM-dd"),"day")<1){return"今天";
}else{if(DateUtils.getDateDiff(a,DateUtils.format(new Date(),"yyyy-MM-dd"),"day")<2){return"昨天";}else{return a.replaceAll("-",".");}}},_getIcon:function(a){if(a.type=="客户注册"){return ctx+"/img/jt/cs/timeRegister.png";
}else{if(a.type=="订单日志"){if(a.content=="订单已签收"){return ctx+"/img/jt/cs/complete.png";}else{if(a.content=="订单审核通过"){return ctx+"/img/jt/cs/confirm.png";
}else{if(a.content.indexOf("订单拒收")!=-1){return ctx+"/img/jt/cs/reject.png";}else{if(a.content.indexOf("订单包裹丢失")!=-1){return ctx+"/img/jt/cs/lost.png";}}}}}else{if(a.type.indexOf("通话记录")!=-1){return ctx+"/img/jt/cs/callTime.png";
}else{if(a.type=="档案情况跟进"){return ctx+"/img/jt/cs/eav.png";}else{if(a.type=="转工号"){return ctx+"/img/jt/cs/turn.png";}else{return ctx+"/img/jt/cs/follow.png";
}}}}}},_setOrderData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;a++){if(b[a].type=="订单日志"&&(b[a].content=="订单已签收"||b[a].content=="订单审核通过"||b[a].content.indexOf("订单拒收")!=-1)||b[a].content.indexOf("订单包裹丢失")!=-1){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);
}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">').append(b[a].contentExt!=""?b[a].contentExt:b[a].content).append("</div></div>");
}}$("#cs-order-date-line").empty().append(e.toString());},_setFollowData:function(b){var d=null,c=null;var e=new StringBuffer();for(var a=0;a<b.length;
a++){if(!(b[a].type=="订单日志"||b[a].type=="订单跟进"||b[a].type.indexOf("订单跟进")!=-1||b[a].type.indexOf("通话记录")!=-1)){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);
}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">');
if(b[a].type=="客户跟进"||b[a].type=="档案情况跟进"){e.append("<b>"+b[a].type+"</b>：").append("<span style='color:red;'>"+b[a].content+"</span>");}else{e.append(b[a].contentExt!=""?b[a].contentExt:b[a].content);
}e.append("</div></div>");}}$("#cs-follow-date-line").empty().append(e.toString());},_setCallData:function(b){var d=null,c=null;var e=new StringBuffer();
for(var a=0;a<b.length;a++){if(b[a].type.indexOf("通话记录")!=-1){if(d==null||d!=b[a].createTime.substring(0,10)){d=b[a].createTime.substring(0,10);}if(d!=c){e.append('<div class="timeline-item timeline-main">').append('<div class="timeline-date">'+this._getDateName(d)+"</div></div>");
}c=d;e.append('<div class="timeline-item timeline-item-right">').append('<div class="timeline-item-info">'+b[a].createTime.substring(11,16)+"</div>").append('<div class="timeline-item-icon">').append('<img src="'+this._getIcon(b[a])+'" class="cs-st-img">').append("</div>").append('<div class="timeline-item-content">').append(b[a].contentExt!=""?b[a].contentExt:b[a].content).append("</div></div>");
}}$("#cs-call-date-line").empty().append(e.toString());},_initLine:function(h){var d={};for(var f=h.length-1;f>=0;f--){var g=h[f];if(g.status=="complete"){var e=g.completeTime.substring(0,10);
if(!d.hasOwnProperty(e)){d[e]=g.totalAmount;}else{d[e]=d[e]+g.totalAmount;}}}var c=[];for(var e in d){var b={content:NumberFormat.format(d[e],2),name:e};
c.push(b);}var a=new Report();a.data=c;a.grid={left:66,right:50,bottom:50,top:50};a.textStyle={fontSize:14,fontWeight:"500",color:"#009688"};a.setLegend(false,null,"name");
a.setBarSeriesStyle(true,"top","{c}");a.initSeries([{type:"line",colName:"content",legendName:"数据"}],"name");a._initChart("csOrderLine","订单成交趋势图");},_fillSoCount:function(g){var h=0,b=0,f=0,d=0,a=0;
for(var c=0;c<g.length;c++){var e=g[c];if(e.soType=="soSupplementary"){continue;}if(e.status=="awaiting_comfirm"){h+=1;}else{if(e.status=="complete"){b+=1;
}else{if(e.status=="close_reject"){f+=1;}else{if(e.status=="close_lost"){d+=1;}else{if(e.status=="awaiting_pay"||e.status=="comfirm"||e.status=="shipping"){a+=1;
}}}}}}$(".cs-st-value-confirm").empty().append(h);$(".cs-st-value-doing").empty().append(a);$(".cs-st-value-complete").empty().append(b);$(".cs-st-value-reject").empty().append(f);
$(".cs-st-value-lost").empty().append(d);},_fillSoInfo:function(j){var b=0,c=0,n=0;var a=0,f=0,m=0;var k=0,h=0,l=0,e=0;for(var g=0;g<j.length;g++){var d=j[g];
if(d.soType=="soSupplementary"){continue;}if(d.status!="awaiting_post"&&d.status!="awaiting_comfirm"&&d.status!="close"){b+=1;a+=d.totalAmount;}if(d.status=="complete"){c+=1;
f+=d.totalAmount;if(DateUtils.getDateDiff(d.createTime,new Date(),"day")<=30){n+=1;m+=d.totalAmount;}e+=d.totalAmount;if(k==0){k=d.totalAmount;}if(h==0){h=d.totalAmount;
}if(k>d.totalAmount){k=d.totalAmount;}if(h<d.totalAmount){h=d.totalAmount;}}}l=(c==0?0:e/c);$("#confirm-order").empty().append(b);$("#confirm-money").empty().append("￥"+(((a+"").indexOf(".")==-1)?a:a.toFixed(2)));
$("#complete-order").empty().append(c);$("#complete-money").empty().append("￥"+(((f+"").indexOf(".")==-1)?f:f.toFixed(2)));$("#last30-order").empty().append(n);
$("#last30-money").empty().append("￥"+(((m+"").indexOf(".")==-1)?m:m.toFixed(2)));$("#max-amount").empty().append("￥"+(((h+"").indexOf(".")==-1)?h:h.toFixed(2)));
$("#min-amount").empty().append("￥"+(((k+"").indexOf(".")==-1)?k:k.toFixed(2)));$("#average-amount").empty().append("￥"+(((l+"").indexOf(".")==-1)?l:l.toFixed(2)));
},fillOtherInfo:function(c){var a=this;var b=ctx+"/ec/salesorder/soEntity/findSoByCsId.htm?csId="+c;FormUtils.loadData(b,function(d){a._fillSoCount(d);
a._fillSoInfo(d);a.data=d;});},fillInfo:function(g){$(".cs-st-value-money").empty().append("￥ "+g.soTotal);$(".cs-st-value-rebuy").empty().append(g.soRepeatBuy);
$(".cs-st-value-pointLv").empty().append(g.levelName);$(".cs-st-value-pointUseAble").empty().append(g.pointUsable);$(".cs-st-value-pointTotal").empty().append(g.pointTotal);
$(".cs-st-value-timeRegister").empty().append(g.createTime);$(".cs-st-value-timeComplete").empty().append(g.lastCompleteTime);$(".cs-st-value-timeFollow").empty().append(g.lastFollowTime);
$(".cs-st-value-timeLvUp").empty().append(g.upgTime);$(".cs-head-name").empty().append(g.code+"&nbsp;:&nbsp;"+g.name);var b=(g.profile==""||g.profile==null)?(ctx+"/img/jt/wx/images/head_default.jpg"):(ImageUtils.getTrueUrl(g.profile));
$(".cs-head-img").attr("src",b).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,74));});var c=parseInt(DateUtils.getDateDiff(g.createTime,new Date(),"day")/365)+1;
var h=new StringBuffer();h.append('<span class="cs-head-lv-name">会龄</span>');if(c<4){for(var d=0;d<c;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');
}}else{if(c<16){var j=parseInt(c/4);var e=c%4;for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');}for(var d=0;
d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');}}else{if(c<64){var f=parseInt(c/16);var j=parseInt((c%16)/4);var e=c%4;
for(var d=0;d<f;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv3.png" class="cs-head-lv-img">');}for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');
}for(var d=0;d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');}}else{if(c<256){var a=parseInt(c/64);var f=parseInt((c%64)/16);
var j=parseInt((c%16)/4);var e=c%4;for(var d=0;d<a;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv4.png" class="cs-head-lv-img">');}for(var d=0;d<f;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv3.png" class="cs-head-lv-img">');
}for(var d=0;d<j;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv2.png" class="cs-head-lv-img">');}for(var d=0;d<e;d++){h.append('<img src="'+ctx+'/img/jt/cs/cslv1.png" class="cs-head-lv-img">');
}}}}}$(".cs-head-lv").empty().append(h.toString());$(".cs-head-lv").attr("title",c+"年");}};function imgStyle(b,c,a){if(b>c){return"height:100% !important;left:-"+(a*(1-(c/b)))/2+"px;width:auto !important;";
}else{if(b==c){return null;}else{if(b<c){return"top:-"+(a*(1-(b/c)))/2+"px;";}}}}