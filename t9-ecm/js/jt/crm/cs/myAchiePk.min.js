$(function(){new MyAchiePk().init();});function MyAchiePk(a){this.my={left:100,right:100,isReady:false};this.op={isReady:false};this.teamRed={isReady:false,total:0,pageSize:5,current:1};
this.teamBlue={isReady:false,total:0,pageSize:5,current:1};this.pkLevel=["完胜","胜利","险胜","打平","平手","失败"];this.myFhAchieve=0;this.mySdAchieve=0;this.opFhAchieve=0;
this.opSdAchieve=0;this.myTeamFhAchieve=0;this.myTeamSdAchieve=0;this.opTeamFhAchieve=0;this.opTeamSdAchieve=0;}MyAchiePk._CONS_={RED_MEMBER_URL:ctx+"/ec/rp/reportProfit/myTeamProfitPK.htm",BLUE_MEMBER_URL:ctx+"/ec/rp/reportProfit/opTeamProfitPK.htm",EMP_PKPROFIT_URL:ctx+"/ec/rp/reportProfit/myProfitPK.htm",};
MyAchiePk.prototype={init:function(){var c=this;var b=new Date();var a=b.currentDate()+"";$('input[name="endTime"]').val(a);var d=DateUtils.getBeforeDate(7,a);
$('input[name="startTime"]').val(d);c.loadNormalData();c.loadRedTeamList();c.loadBlueTeamList();c.bindEvent();c._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.tools.employee.rppk";
glHelpUtil.init(a);},loadBar:function(d,i){var h=this;if(d&&d.length==0){return false;}if(!i){i={left:100,right:100};}var b=i.left+"%",f=i.right+"%",e=i.left,c=i.right;
$(d).find(".progress-left-bar").css({width:b});$(d).find(".progress-right-bar").css({width:f});var a=$(d).find(".pk-result-left").find(".pk-result-score"),g=$(d).find(".pk-result-right").find(".pk-result-score");
h.dataUp(a,e,100);h.dataUp(g,c,100);h.getPkLevel(d,e,c);$(d).find(".pk-li").addClass("pk-result-active");setTimeout(function(){$(d).find(".pk-result-title").addClass("pk-result-title-active");
},1000);},reset:function(d){var b=this;$(d).find(".progress-left-bar").css({width:"100%"});$(d).find(".progress-right-bar").css({width:"100%"});$(d).find(".pk-result-title").removeClass("pk-result-title-active");
var a=$(d).find(".pk-result-left").find(".pk-result-score"),c=$(d).find(".pk-result-right").find(".pk-result-score");b.dataUp(a,100,parseInt(a.text()));
b.dataUp(c,100,parseInt(c.text()));$(d).find(".pk-li").removeClass("pk-result-active");},dataUp:function(d,a,c){var b=this;$(d).data("countToOptions",{from:c,to:a,speed:50});
$(d).each(count);},getPkLevel:function(f,g,b){var c=this;var a=$(f).find(".pk-result-left").find(".pk-result-title"),e=$(f).find(".pk-result-right").find(".pk-result-title");
if(g==b){$(f).find(".pk-result-title").empty().text(c.pkLevel[3]);}else{var d=Math.abs(b-g);if(d>70){if(b<g){a.empty().text(c.pkLevel[0]);e.empty().text(c.pkLevel[5]);
}else{a.empty().text(c.pkLevel[5]);e.empty().text(c.pkLevel[0]);}}else{if(d<10){if(b<g){a.empty().text(c.pkLevel[2]);e.empty().text(c.pkLevel[5]);}else{a.empty().text(c.pkLevel[5]);
e.empty().text(c.pkLevel[2]);}}else{if(b<g){a.empty().text(c.pkLevel[1]);e.empty().text(c.pkLevel[5]);}else{a.empty().text(c.pkLevel[5]);e.empty().text(c.pkLevel[1]);
}}}}},doPager:function(c,b){var a=this;var e="",d="teamRed";if($(c).parent().is(".pk-pager-left")){e=MyAchiePk._CONS_.RED_MEMBER_URL+"?startTime="+$("input[name=startTime]").val()+"&endTime="+$("input[name=endTime]").val();
}else{if($(c).parent().is(".pk-pager-right")){e=MyAchiePk._CONS_.BLUE_MEMBER_URL+"?startTime="+$("input[name=startTime]").val()+"&endTime="+$("input[name=endTime]").val();
d="teamBlue";}}if(b=="prev"){if(a[d].current<2){return false;}a[d].current=a[d].current-1;e+="?pageSize="+a[d].pageSize+"&pageNo="+a[d].current;}else{if(b=="refresh"){e+="?pageSize="+a[d].pageSize+"&pageNo="+a[d].current;
}else{if(b=="next"){if(a[d].total<a[d].pageSize*a[d].current){return false;}a[d].current=a[d].current+1;e+="?pageSize="+a[d].pageSize+"&pageNo="+a[d].current;
}}}if(d=="teamRed"){a.loadRedTeamList(e);}else{if(d=="teamBlue"){a.loadBlueTeamList(e);}}},loadPager:function(c,b){var a=this;if(c=="red"){a.teamRed.total=b.total;
a.teamRed.current=b.pageNo;$(".pk-detail-tleft").find(".pk-detail-icon").children("span").empty().text(b.total);}else{if(c=="blue"){a.teamBlue.total=b.total;
a.teamBlue.current=b.pageNo;$(".pk-detail-tright").find(".pk-detail-icon").children("span").empty().text(b.total);}}},loadNormalData:function(e){var b=this;
var d=$("input[name=startTime]").val();var a=$("input[name=endTime]").val();var c=MyAchiePk._CONS_.EMP_PKPROFIT_URL+"?startTime="+d+"&endTime="+a;FormUtils.loadData(c,function(g){if(g&&g.length>0){for(var f=0;
f<g.length;f++){if(g[f].profitType=="my"){b.setUnitData(g[f],"my");b.myFhAchieve=g[f].fhAchieve;b.mySdAchieve=g[f].sdAchieve;b.my.isReady=true;}else{if(g[f].profitType=="op"){b.setUnitData(g[f],"op");
b.opFhAchieve=g[f].fhAchieve;b.opSdAchieve=g[f].sdAchieve;b.op.isReady=true;}}}if(b.my.isReady&&b.op.isReady){setTimeout(function(){$("#personalPk").trigger("click");
},1000);}}});},setUnitData:function(c,g,b){var a=this;if(b){var f="待定？？？";if(c.aid){f=c.aid;}$("#"+g+"-nickname").empty().text(f);}else{var e="?";var d="待定";
var f=(c.aid).split(":");if($.trim(f[0])){e=$.trim(f[0]);}if($.trim(f[1])){d=$.trim(f[1]);}$("#"+g+"-number").empty().text(e);$("#"+g+"-nickname").empty().text(d);
}$("#"+g+"-fa-achieve").empty().text(c.fhAchieve.toFixed(2));$("#"+g+"-sd-achieve").empty().text(c.sdAchieve.toFixed(2));$("#"+g+"-profile").attr("src",ctx+c.profile);
$("#"+g+"-profile").load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,66));});},teamLi:function(d,c){var a=this;
var b=a.teamRed.pageSize*(a.teamRed.current-1)+c;var e=new StringBuffer();e.append('<div class="pk-detail-li">').append('<div class="pk-detail-num"><div>'+b+"</div></div>").append('<div class="pk-detail-profile">').append('<div class="pk-detail-img"><img class="dimg" src="'+ctx+d.profile+'" onerror="tgImgError(this);"/></div>').append('<div class="pk-detail-user">'+d.aid+":"+d.name+"</div>").append("</div>").append('<div class="pk-detail-msg">').append("<p>发货业绩&emsp;<span><em>￥</em>&nbsp;"+d.fhAchieve+"</span></p>").append("<p>审单业绩&emsp;<span><em>￥</em>&nbsp;"+d.sdAchieve+"</span></p>").append("</div>").append("</div>");
return e.toString();},redTeamList:function(c){var b=this;if(!c){return false;}var a="";if(c.length==0){a="<div class='pk-detail-empty unselect'>该团队内暂时没有成员...</div>";
}else{$.each(c,function(d,f){a+=b.teamLi(this,d+1);});}$(".pk-detail-left").empty().append(a);$(".pk-detail-left").find(".dimg").each(function(d,f){$(this).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,50));
});});},loadRedTeamList:function(e){var c=this;var d=$("input[name=startTime]").val();var b=$("input[name=endTime]").val();var a=MyAchiePk._CONS_.RED_MEMBER_URL+"?pageSize="+c.teamRed.pageSize+"&pageNo="+c.teamRed.current+"&startTime="+d+"&endTime="+b;
if(e){a=e;}FormUtils.loadData(a,function(h){if(h){if(h.rows){var f="";for(var g=0;g<h.rows.length;g++){f=h.rows[g];}c.setUnitData(f,"myteam",true);c.redTeamList(f.empList);
c.myTeamSdAchieve=f.sdAchieve;c.myTeamFhAchieve=f.fhAchieve;if(f.aid){c.teamRed.isReady=true;if(c.teamBlue.isReady&&!$(".team-pk-layer").find(".pk-li").is(".pk-result-active")){setTimeout(function(){$("#teamPk").trigger("click");
},1000);}}}c.loadPager("red",{total:h.records,pageNo:h.page});}},null,false);},blueTeamList:function(c){var b=this;if(!c){return false;}var a="";if(c.length==0){a="<div class='pk-detail-empty unselect'>该团队内暂时没有成员...</div>";
}else{$.each(c,function(d,f){a+=b.teamLi(this,d+1);});}$(".pk-detail-right").empty().append(a);$(".pk-detail-right").find(".dimg").each(function(d,f){$(this).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,50));
});});},loadBlueTeamList:function(a){var d=this;var e=$("input[name=startTime]").val();var c=$("input[name=endTime]").val();var b=MyAchiePk._CONS_.BLUE_MEMBER_URL+"?pageSize="+d.teamBlue.pageSize+"&pageNo="+d.teamBlue.current+"&startTime="+e+"&endTime="+c;
if(a){b=a;}FormUtils.loadData(b,function(h){if(h){if(h.rows){var f="";for(var g=0;g<h.rows.length;g++){f=h.rows[g];}d.setUnitData(f,"opteam",true);d.blueTeamList(f.empList);
d.opTeamSdAchieve=f.sdAchieve;d.opTeamFhAchieve=f.fhAchieve;if(f.aid){d.teamBlue.isReady=true;if(d.teamRed.isReady&&!$(".team-pk-layer").find(".pk-li").is(".pk-result-active")){setTimeout(function(){$("#teamPk").trigger("click");
},1000);}}}d.loadPager("blue",{total:h.records,pageNo:h.page});}},null,false);},bindEvent:function(){var a=this;$(document).on("click","#searchBtn",function(){a.loadNormalData();
a.loadRedTeamList();a.loadBlueTeamList();});$(document).on("click",".pk-vs > img",function(g){var h=$(this).attr("id");var f=$('input[name="achieve"]:checked').attr("id");
if(h=="teamPk"){f=$('input[name="teamAchieve"]:checked').attr("id");}if($(this).closest(".pk-li").is(".pk-result-active")){a.reset($(this).closest(".pk-boxer"));
}else{var b=100;var d=100;if(h=="teamPk"){if(!a.teamBlue.isReady||!a.teamRed.isReady){DialogUtils.warning("缺少目标","请确保VS双方已经就绪！");return false;}if(f=="teamFhAchieve"){var c=a.myTeamFhAchieve+a.opTeamFhAchieve;
if(c!=0){b=Math.round((a.myTeamFhAchieve/c)*100);d=100-b;}}else{if(f=="teamSdAchieve"){var c=a.myTeamSdAchieve+a.opTeamSdAchieve;if(c!=0){b=Math.round((a.myTeamSdAchieve/c)*100);
d=100-b;}}}}else{if(!a.my.isReady||!a.op.isReady){DialogUtils.warning("缺少目标","请确保PK双方已经就绪！");return false;}if(f=="fhAchieve"){var c=a.myFhAchieve+a.opFhAchieve;
if(c!=0){b=Math.round((a.myFhAchieve/c)*100);d=100-b;}}else{if(f=="sdAchieve"){var c=a.mySdAchieve+a.opSdAchieve;if(c!=0){b=Math.round((a.mySdAchieve/c)*100);
d=100-b;}}}}a.loadBar($(this).closest(".pk-boxer"),{left:b,right:d});}});$(".pk-vs > img").hover(function(){if(!$(this).closest(".pk-li").is(".pk-result-active")){$(this).closest(".pk-li").addClass("pk-result-hover");
}},function(){$(this).closest(".pk-li").removeClass("pk-result-hover");});$(document).on("click",".pk-pager-prev",function(b){a.doPager(this,"prev");});
$(document).on("click",".pk-pager-refresh",function(b){a.doPager(this,"refresh");});$(document).on("click",".pk-pager-next",function(b){a.doPager(this,"next");
});$(document).on("click","#fhAchieve,#sdAchieve",function(b){$("#personalPk").trigger("click").trigger("click");});$(document).on("click","#teamFhAchieve,#teamSdAchieve",function(b){$("#teamPk").trigger("click").trigger("click");
});}};function getRandom(b,a){var d=Math.random()*(a-b);var c=Math.round(d+b);c=Math.max(Math.min(c,a),b);return c;}function imgStyle(b,c,a){if(b>c){return"height:100% !important;left:-"+(a*(1-(c/b)))/2+"px;width:auto !important;";
}else{if(b==c){return null;}else{if(b<c){return"top:-"+(a*(1-(b/c)))/2+"px;";}}}}$.fn.countTo=function(a){a=a||{};return $(this).each(function(){var c=$.extend({},$.fn.countTo.defaults,{from:$(this).data("from"),to:$(this).data("to"),speed:$(this).data("speed"),refreshInterval:$(this).data("refresh-interval"),decimals:$(this).data("decimals")},a);
console.log(c);var h=Math.ceil(c.speed/c.refreshInterval),i=(c.to-c.from)/h;var j=this,f=$(this),e=0,g=c.from,d=f.data("countTo")||{};f.data("countTo",d);
if(d.interval){clearInterval(d.interval);}d.interval=setInterval(k,c.refreshInterval);b(g);function k(){g+=i;e++;b(g);if(typeof(c.onUpdate)=="function"){c.onUpdate.call(j,g);
}if(e>=h){f.removeData("countTo");clearInterval(d.interval);g=c.to;if(typeof(c.onComplete)=="function"){c.onComplete.call(j,g);}}}function b(m){var l=c.formatter.call(j,m,c);
f.html(l);}});};$.fn.countTo.defaults={from:0,to:0,speed:1,refreshInterval:0.5,decimals:0,formatter:formatter,onUpdate:null,onComplete:null};function formatter(b,a){return b.toFixed(a.decimals);
}function count(a){var b=$(this);a=$.extend({},a||{},b.data("countToOptions")||{});console.log(a);b.countTo(a);}function tgImgError(a){$(a).attr("src",ctx+"/img/jt/defaulTouXiang.png");
}