function WebWeiXinNewRecord(){this.hadInit=false;this.lastValue="";this.nodeList="";this.hadInitJqgrid=false;this.params="";this.seniorSearch=new SeniorSearch();
this.csFollow=new CsFollow();this.msgTagDatas=[];this.partyId="";this.partyType="";this.initEmployeeWeixin=false;}WebWeiXinNewRecord._CONS_={EDIT_URL:ctx+"/crm/cs/weiXinRecord/edit.htm",DETAIL_URL:ctx+"/crm/cs/weiXinRecord/detail.htm",DELETE_URL:ctx+"/crm/cs/weiXinRecord/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/weiXinRecord/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/weiXinRecord/saveEdit.htm",LIST_GROUP_DATA_URL:ctx+"/crm/cs/weiXinRecord/listGroupData.htm?needAid=y&needGroupKey=y",LIST_ANDROID_GROUP_DATA_URL:ctx+"/crm/cs/weiXinRecord/listAndroidGroupData.htm?needAid=y&needGroupKey=y",BATCH_SIGN_URL:ctx+"/crm/cs/weiXinRecord/batchSign.htm",UPDATE_MSG_TARGET_URL:ctx+"/crm/cs/weiXinRecord/updateMsgTarget.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByTypeAndEmployee.htm",GET_CS_DATA_URL:ctx+"/crm/cs/csEntity/getCsByCode.htm",EDIT_FORM_ID:"weiXinRecordForm",GRID:"#weiXinRecordGrid",PAGER:"#weiXinRecordPager"};
WebWeiXinNewRecord.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=new Date();a=new Date(a.getTime()-1*24*3600*1000);$(".startDate").val(a.currentDate()+" 00:00:00");
this._bindEventHander();this._initWxlabel();this._initlabel();this._hideNotGrantBtn();this.initOrganizationTree();this._dealStyle();this._initEmployeeWeixin("","");
}},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=wxMsgTag";FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();
e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");}$("#wx-msg-target").empty().append(e.toString());
a.msgTagDatas=c;}});},_initlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();
e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");}$("#wx-label").empty().append(e.toString());
}});},_dealStyle:function(){var a=$("body").height();$("#organizationTree").css({"max-height":a-40+"px"});},initOrganizationTree:function(c){var a=this;
var b={async:{enable:true,url:ctx+"/gl/ou/group/findVisiableEmployeeTreeForWx.htm",contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],dataFilter:function(e,d,f){return f;
},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{onClick:function(d,f,e){if(!a.hadInitJqgrid){a.hadInitJqgrid=true;var g={startDate:$(".startDate").val()};
if(e.type=="group"){g.belongOgn=e.id;a.partyId=e.id;a.partyType="group";a._initEmployeeWeixin("",e.id);}else{g.employeeId=e.id;a._initEmployeeWeixin(e.id,"");
a.partyId=e.id;a.partyType="employee";}a._initJqgrid(g);}else{var g=$("#weiXinRecordSearchForm").closest("form").serialize();if(e.type=="group"){g+="&belongOgn="+e.id;
a.partyId=e.id;a.partyType="group";a._initEmployeeWeixin("",e.id);}else{g+="&employeeId="+e.id;a.partyId=e.id;a.partyType="employee";a._initEmployeeWeixin(e.id,"");
}a.reloadJqgrid(g);}a.seniorSearch.initCrumbs(e,"organizationTree");},onAsyncSuccess:function(g,i,h,j){var f=$.fn.zTree.getZTreeObj("organizationTree");
if(h==null){var f=$.fn.zTree.getZTreeObj("organizationTree");var d=f.getNodes();if(d&&d.length){var e=d[0];f.expandNode(e,true,false,false);f.selectNode(e);
f.setting.callback.onClick(null,e.id,e);}}}},view:{selectedMulti:false,fontCss:function(e,d){return(!!d.highlight)?{color:"#A60000","font-weight":"bold"}:{color:"#333","font-weight":"normal"};
}}};$.fn.zTree.init($("#organizationTree"),b);},_initEmployeeWeixin:function(c,b){var a=this;FormUtils.loadData(WebWeiXinNewRecord._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId="+c+"&groupId="+b+"&type="+weixinType,function(e){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){if(weixinType=="android"){f.append("<option value='"+e[d].alias+"'>"+e[d].alias+"</option>");
}else{f.append("<option value='"+e[d].weixin+"'>"+e[d].weixin+"</option>");}}if(!a.initEmployeeWeixin){a.initEmployeeWeixin=true;$("#employee-wx-select2").empty().append(f.toString());
$("#employee-wx-select2").select2();}$("#employee-wx-select").empty().append(f.toString());$("#employee-wx-select").select2();});},_hideNotGrantBtn:function(){},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(".weiXinRecordSearch").on("click",function(){$(".weiXinRecordSearch").attr("disabled","disabled");var c=$("#weiXinRecordSearchForm input[name='startDate']").val();
var d=$("#weiXinRecordSearchForm input[name='endDate']").val();if(c==""){DialogUtils.error(msgCode.ERROR,"发送时间间隔不能大于7天");$(".weiXinRecordSearch").attr("disabled",false);
return false;}else{if(d==""){d=new Date();}var b=DateUtils.getDateDiff(c,d,"day");if(b>=7){DialogUtils.error(msgCode.ERROR,"发送时间间隔不能大于7天");$(".weiXinRecordSearch").attr("disabled",false);
return false;}}var e=$(this).closest("form").serialize();if(a.partyType=="group"){e+="&belongOgn="+a.partyId;}else{e+="&employeeId="+a.partyId;}a.reloadJqgrid(e);
});$("#weiXinRecordSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".weiXinRecordSearch").trigger("click");}});$(document).on("click",".csTab",function(){var b=$(this).attr("idval");
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detailByCode.htm"+"?csCode="+b,"客户明细");});$("#organizationTreeSearch").on("keyup",function(b){if(b.keyCode==13){a._searchNode(b);
a._callNumber();}});$("#clickUp").on("click",function(){a._clickUp();});$("#clickDown").on("click",function(){a._clickDown();});$(document).on("click",".employee-ex-li",function(){var b=$(this).attr("employee-weixin");
a.reloadJqgrid(a.params+"&Q__S__EQ__employee_wei_xin_="+b);});$(document).on("change",".select-target",function(){var f=$(this).attr("id-val");var e=$(this).attr("create-time");
var c=$(this).val();var d=[];d.push(f);var b=[];b.push(e);a._updateMsgTarget(d,b,c);});$(document).on("click",".show-detail",function(){var e=$(this).attr("data-code");
var d=$(this).attr("data-employee-weixin");var c=$(this).attr("data-friendcode");var b=$("#weiXinRecordSearchForm input[name='startDate']").val();var f=$("#weiXinRecordSearchForm input[name='endDate']").val();
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weiXinRecord/detailList.htm"+"?friendcode="+c+"&startDate="+b+"&endDate="+f+"&code="+e+"&employeeWeixin="+d+"&partyId="+a.partyId+"&partyType="+a.partyType,"消息明细");
});$(document).on("click",".show-android-detail",function(){var e=$(this).attr("data-username");var d=$(this).attr("data-employee-alias");var b=$("#weiXinRecordSearchForm input[name='startDate']").val();
var f=$("#weiXinRecordSearchForm input[name='endDate']").val();var c=$(this).attr("data-friendcode");JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weiXinRecord/detailList.htm"+"?friendcode="+c+"&startDate="+b+"&endDate="+f+"&userName="+e+"&employeeAlias="+d+"&partyId="+a.partyId+"&partyType="+a.partyType,"消息明细");
});$(document).on("click",".add-follow",function(){var b=$(this).val();a._loadCsData(b);});$(document).on("click",".weiXinRecordSearchToday",function(){var b=new Date();
$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordSearch").trigger("click");});$(document).on("click",".weiXinRecordSearchSeven",function(){var b=new Date();
b=new Date(b.getTime()-6*24*3600*1000);$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordSearch").trigger("click");});},_loadCsData:function(b){var a=this;
var c=WebWeiXinNewRecord._CONS_.GET_CS_DATA_URL;FormUtils.submit(c,{"csCode":b},function(d){if(d){a._fillFollowRecordTab({partyId:currentUserId,partyAid:currentUserAid,partyName:currentUserName},d.id,b);
$("#addFollowBtn").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,msg.msg);}});},_fillFollowRecordTab:function(b,c,a){var d={csId:c,employeeId:currentUserId,entityId:"",csCode:a,needTable:false,followType:"cs",csType:"self",permissionType:"self"};
this.csFollow.init(d,b);this.csFollow._initEmployeeSuggest();},_searchNode:function(d){var a=$.fn.zTree.getZTreeObj("organizationTree");var c=$.trim($("#organizationTreeSearch").val());
var b="name";if(this.lastValue===c){return;}this.lastValue=c;this._updateNodes(false,this.nodeList);if(c!=""){this.nodeList=a.getNodesByParamFuzzy(b,c);
this._updateNodes(true,this.nodeList);}else{this.nodeList=[];}},_updateNodes:function(b,d){var c=$.fn.zTree.getZTreeObj("organizationTree");if(d){for(var e=0,a=d.length;
e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);}c.updateNode(d[e]);}}},_clickUp:function(){var a=$.fn.zTree.getZTreeObj("organizationTree");
if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");return;}else{if(this.clickCount==1){DialogUtils.error(msgCode.FAIL_MSG,"您已位于第一条记录上！");
return;}else{this.clickCount--;a.selectNode(this.nodeList[this.clickCount-1],false);}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
},_clickDown:function clickDown(){var a=$.fn.zTree.getZTreeObj("organizationTree");if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");
return;}else{if(this.nodeList.length==this.clickCount){DialogUtils.error(msgCode.FAIL_MSG,"您已位于最后一条记录上！");return;}else{a.selectNode(this.nodeList[this.clickCount],false);
this.clickCount++;}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";},_callNumber:function(){var a=$.fn.zTree.getZTreeObj("organizationTree");
if(this.nodeList.length){a.selectNode(this.nodeList[0],false);this.clickCount=1;document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
}else{if(this.nodeList.length==0){document.getElementById("number").innerHTML="[0/0]";a.cancelSelectedNode();}}if($.trim($("#organizationTreeSearch").val())==""){document.getElementById("number").innerHTML="";
a.cancelSelectedNode();}},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WebWeiXinNewRecord._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];return a;
},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}if(weixinType=="android"){$(WebWeiXinNewRecord._CONS_.GRID).JTJqgrid({url:WebWeiXinNewRecord._CONS_.LIST_ANDROID_GROUP_DATA_URL,pager:WebWeiXinNewRecord._CONS_.PAGER,postData:b,width:"100%",autowidth:true,colNames:["ID","好友昵称","员工工号","员工微信","消息条数","操作"],colModel:[{name:"id",index:"id_",hidden:true},{name:"nickName",index:"nick_name_",width:120,formatter:function(c,d,e){if(e.friendCode){if(e.friendCode.length>10){return c;
}else{return c+":<a class='csTab' style='font-weight:bold;' idVal='"+e.friendCode+"'>"+e.friendCode+"</a>";}}else{return c;}}},{name:"employeeAid",index:"employee_id_",width:80,formatter:function(c,d,e){return c+":"+e.employeeName;
}},{name:"employeeWeiXin",index:"employee_wei_xin_",width:100},{name:"count",index:"count_",width:100,sortable:false},{name:"oprate",width:100,sortable:false,formatter:function(c,d,e){if(ResUtils.canShow("androidRecord.button.detail")){return"<button type='button' data-friendcode='"+e.friendCode+"' data-username='"+e.userName+"' data-employee-alias='"+e.employeeAlias+"' class='jt-btn-safe show-android-detail' >明细</button>"+a._getFollowBtn(e);
}else{return"";}}}],loadComplete:function(){setTimeout(function(){var d=$(".not_duration");for(var c=0;c<d.length;c++){var e=$(d[c]).find(".media")[0];
var f=parseInt(e.duration);$(d[c]).removeClass("not_duration").find(".audio_length").empty().append(f+"''");$(d[c]).find(".audio_area").css({width:(70+3*f)+"px"});
}},1000);$(".weiXinRecordSearch").attr("disabled",false);}});}else{$(WebWeiXinNewRecord._CONS_.GRID).JTJqgrid({url:WebWeiXinNewRecord._CONS_.LIST_GROUP_DATA_URL,pager:WebWeiXinNewRecord._CONS_.PAGER,postData:b,width:"100%",autowidth:true,colNames:["ID","好友昵称","员工工号","员工微信","消息条数","操作"],colModel:[{name:"id",index:"id_",hidden:true},{name:"nickName",index:"nick_name_",width:120,formatter:function(c,d,e){if(e.friendCode){if(e.friendCode.length>10){return c;
}else{return c+":<a class='csTab' style='font-weight:bold;' idVal='"+e.friendCode+"'>"+e.friendCode+"</a>";}}else{return c;}}},{name:"employeeAid",index:"employee_id_",width:80,formatter:function(c,d,e){return c+":"+e.employeeName;
}},{name:"employeeWeiXin",index:"employee_wei_xin_",width:100},{name:"count",index:"count_",width:100,sortable:false},{name:"oprate",width:100,sortable:false,formatter:function(c,d,e){if(ResUtils.canShow("weiXinRecord.button.detail")){return"<button type='button' data-friendcode='"+e.friendCode+"' data-code='"+e.nickNameHashCode+"' data-employee-weixin='"+e.employeeWeiXin+"' class='jt-btn-safe show-detail'>明细</button>"+a._getFollowBtn(e);
}else{return"";}}}],loadComplete:function(){setTimeout(function(){var d=$(".not_duration");for(var c=0;c<d.length;c++){var e=$(d[c]).find(".media")[0];
var f=parseInt(e.duration);$(d[c]).removeClass("not_duration").find(".audio_length").empty().append(f+"''");$(d[c]).find(".audio_area").css({width:(70+3*f)+"px"});
}},1000);$(".weiXinRecordSearch").attr("disabled",false);},});}},_getFollowBtn:function(b){var a=false;if(type="android"&&ResUtils.canShow("androidRecord.button.addFollow")){a=true;
}else{if(ResUtils.canShow("weiXinRecord.button.addFollow")){a=true;}}if(b.friendCode&&b.friendCode.length>=5&&b.friendCode.length<=10&&a){return"<button type='button' value='"+b.friendCode+"' class='jt-btn-opt add-follow'>添加跟进</button>";
}else{return"";}}};