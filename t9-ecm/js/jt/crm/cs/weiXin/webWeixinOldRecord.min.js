function WebWeiXinOldRecord(){this.hadInit=false;this.seniorSearch=new SeniorSearch();}WebWeiXinOldRecord._CONS_={EDIT_URL:ctx+"/crm/cs/weiXinRecord/edit.htm",DETAIL_URL:ctx+"/crm/cs/weiXinRecord/detail.htm",DELETE_URL:ctx+"/crm/cs/weiXinRecord/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/weiXinRecord/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/weiXinRecord/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm?Q__S__EQ__weixin_type_=web&needAid=y&needGroupKey=y&hasGrant="+ResUtils.canShow("weiXinRecord.button.viewPhone"),LIST_ANDROID_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm?Q__S__EQ__weixin_type_=android&needAid=y&needGroupKey=y&hasGrant="+ResUtils.canShow("androidRecord.button.viewPhone"),BATCH_SIGN_URL:ctx+"/crm/cs/weiXinRecord/batchSign.htm",DETAIL_URL:ctx+"/crm/cs/weiXinRecord/delete.htm",GRID:"#webWeiXinOldRecordGrid",PAGER:"#webWeiXinOldRecordPager"};
WebWeiXinOldRecord.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=new Date();a=new Date(a.getTime()-1*24*3600*1000);$(".startDate").val(a.currentDate()+" 00:00:00");
this._bindEventHander();this._hideNotGrantBtn();this._initEmployeeSelect("");CateUtils.getOptions([{typeKey:"system",pKey:"sensitiveWord",container:"sensitiveValue"}]);
this._initWxlabel();this.seniorSearch.init();}$(window).trigger("resize");},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=wxMsgTag";
FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");
}$("#wx-msg-target").empty().append(e.toString());a.msgTagDatas=c;a._initJqgrid({startDate:$(".startDate").val()});}});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("weiXinRecord.button.delete")){$(".weixinRecordDel").remove();
}if(!ResUtils.canShow("androidRecord.button.setSign")){$(".setSign").hide();}if(!ResUtils.canShow("androidRecord.button.cancelSign")){$(".cancelSign").hide();
}},_initEmployeeWeixin:function(c,b){var a=this;FormUtils.loadData(WebWeiXinNewRecord._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId="+c+"&groupId="+b+"&type="+weixinType,function(e){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){if(weixinType=="android"){f.append("<option value='"+e[d].alias+"'>"+e[d].alias+"</option>");
}else{f.append("<option value='"+e[d].weixin+"'>"+e[d].weixin+"</option>");}}$("#employee-wx-select2").empty().append(f.toString());$("#employee-wx-select2").select2();
});},_bindEventHander:function(){var a=this;$(document).on("click",".translateToWord",function(e){console.log("===click translate");e.preventDefault();
e.stopPropagation();var d=$(this);var g=d.attr("title");if(g!="点击？翻译"){return;}if($(this).attr("hasClick")){DialogUtils.warn(msgCode.WARN_MSG,"请勿重复点击翻译!");
return;}$(this).attr("hasClick",true);var b="xunfei";var c=$(this).attr("idVal");var h=$(this).attr("createTime");var f={voiceId:c,platform:b,createTime:h};
FormUtils.submit(ctx+"/crm/android/voiceTranslate2Word.htm",f,function(i){if(i.success){DialogUtils.success(msgCode.INFO,i.msg);if(i.msg!="已提交到后台任务"){d.attr("title",i.msg);
d.text("！");d.css("cursor","copy");}}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}},null,false);});$(document).on("click",".prevBtn",function(){a.clear(false);
});$(".webWeiXinOldRecordSearch").on("click",function(){$(".webWeiXinOldRecordSearch").attr("disabled","disabled");var b=$("#webWeiXinOldRecordSearchForm").closest("form").serialize();
a.reloadJqgrid(b);});$("#webWeiXinOldRecordSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".webWeiXinOldRecordSearch").trigger("click");}});
$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
a._initEmployeeSelect(c);a._initEmployeeWeixin("",c);}};GroupUtils.selectGroupTreeBox(b);});$(document).on("change","#employeeId",function(){var b=$(this).val();
a._initEmployeeWeixin(b,"");});$(document).on("click",".csTab",function(){var b=$(this).attr("idval");JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detailByCode.htm"+"?csCode="+b,"客户明细");
});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");var c=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;
});$("body").on("click",".weixinRecordDel",function(){var c=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}var b=[];for(var d=0;d<c.length;d++){var e={};e.id=c[d];e.createTime=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getRowData",c[d])["createTime"];
b.push(e);}a._delete(b);});$(document).on("click",".setSign",function(){var b=[];var e=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(e&&e.length>0){for(var c=0;c<e.length;c++){var d=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getRowData",e[c]);if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"y");
}});$(document).on("click",".wx-set-star",function(){var d=$(this).attr("value");var c=$(this).attr("createTime");var b="n";if($(this).hasClass("wx-set-star-checked")){b="n";
$(this).removeClass("wx-set-star-checked");}else{b="y";$(this).addClass("wx-set-star-checked");}a._batchSign(d,c,b);});$(document).on("click",".cancelSign",function(){var b=[];
var e=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(e&&e.length>0){for(var c=0;c<e.length;c++){var d=$(WebWeiXinOldRecord._CONS_.GRID).jqGrid("getRowData",e[c]);
if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"n");}});$(document).on("change",".select-target",function(){var f=$(this).attr("id-val");var e=$(this).attr("create-time");
var c=$(this).val();var d=[];d.push(f);var b=[];b.push(e);a._updateMsgTarget(d,b,c);});},_updateMsgTarget:function(d,a,c){var b=ctx+"/crm/cs/weiXinRecord/updateMsgTarget.htm";
FormUtils.submit(b,{"idArr":d,"createTimeArr":a,"msgTarget":c},function(e){if(e.success){DialogUtils.success(msgCode.INFO,"修改标签成功");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}});},_batchSign:function(d,a,b){var c=ctx+"/crm/cs/weiXinRecord/batchSign.htm";FormUtils.submit(c,{"idArr":d,"createTimeArr":a,"isSign":b},function(e){if(e.success){if("y"==b){DialogUtils.success(msgCode.INFO,"设置为已读成功");
}else{DialogUtils.success(msgCode.INFO,"设置为未读成功");}$(".webWeiXinOldRecordSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});
},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(WebWeiXinOldRecord._CONS_.DELETE_URL,JSON.stringify(b),function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$(".webWeiXinOldRecordSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WebWeiXinOldRecord._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];return a;},_initEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#employeeId").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");
}$("#employeeId").append(d.toString()).select2();}},null,true);},_initJqgrid:function(d){var b=this;if(d==null||typeof d==undefined){d={};}var c=WebWeiXinOldRecord._CONS_.LIST_DATA_URL;
if(weixinType=="android"){c=WebWeiXinOldRecord._CONS_.LIST_ANDROID_DATA_URL;}var a=ResUtils.canShow("androidRecord.button.translateVoice");$(WebWeiXinOldRecord._CONS_.GRID).JTJqgrid({url:c,pager:WebWeiXinOldRecord._CONS_.PAGER,postData:d,colNames:["ID","好友昵称","员工微信号","员工工号","内容","类型","已读","创建时间","好友标签","消息标签"],colModel:[{name:"id",index:"id_",hidden:true},{name:"nickName",index:"nick_name_",width:120,formatter:function(e,f,g){if(g.friendCode){if(g.friendCode.length>10){return e;
}else{return e+":<a class='csTab' style='font-weight:bold;' idVal='"+g.friendCode+"'>"+g.friendCode+"</a>";}}else{return e;}}},{name:"employeeWeiXin",index:"employee_wei_xin_",width:120},{name:"employeeAid",index:"employee_id_",width:80,formatter:function(e,f,g){return e+":"+g.employeeName;
}},{name:"content",index:"content_",width:400,formatter:function(f,g,j){var i="";var k=j.contentType;if(0==k){i=WeiXinUtil.replaceFace(f);}else{if(1==k||4==k){var h=f.split(";");
if(h.length>1){i="<img style='display: inline; height:35px;' src-value='"+h[1]+"' src='"+ImageUtils.getTrueUrl(h[1])+"'>";}else{i="<img style='display: inline; height:35px;' src-value='"+j.content+"'  src='"+ImageUtils.getTrueUrl(j.content)+"'>";
}}else{if(2==k){if(j.content&&j.content.indexOf("UploadedFile")!=-1){var e="<div class='text text-spacial' >"+WeiXinUtil.getAudioSpan(j,a)+"</div>";i=e;
}else{i=j.content;}}else{if(k==5||k=="5"){i=j.content.nickname+"请求加好友";}else{if(k==7||k=="7"){i=WeiXinUtil.getFileMsg(j);}else{if(k==8){i=WeiXinUtil.getVideoMsg(j);
}else{if(k==10){i=WeiXinUtil.getNameCard(j);}else{if(j.contentType==12){return WeiXinUtil.getTransfer(j);}else{i=f;}}}}}}}}return i+WeiXinUtil.getIsRevoke(j);
}},{name:"type",index:"type_",width:50,formatter:function(e){if(e=="in"){return"<span style='color:red'>收</span>";}else{return"发";}}},{name:"isSign",index:"is_sign_",width:50,formatter:function(e,f,g){if(e=="y"){return"<a  value='"+g.id+"' createTime='"+g.createTime+"' class=' wx-set-star wx-set-star-checked'>是</a>";
}else{return"<a  value='"+g.id+"' createTime='"+g.createTime+"' class=' wx-set-star'>否</a>";}}},{name:"createTime",index:"create_time_",width:100},{name:"label",index:"label_",width:100},{name:"msgTarget",index:"msg_target_",width:100,sortable:false,formatter:function(e,f,j){var k=new StringBuffer();
k.append("<select class='select-target' id-val='"+j.id+"' create-time='"+j.createTime+"'>");k.append("<option value=''>请选择</button>");var h=b.msgTagDatas;
for(var g=0;g<h.length;g++){k.append("<option value='"+h[g].value+"' "+(e==h[g].value?"selected":"")+" >"+h[g].value+"</button>");}k.append("</select>");
return k.toString();}},],loadComplete:function(){setTimeout(function(){var f=$(".not_duration");for(var e=0;e<f.length;e++){var g=$(f[e]).find(".media")[0];
var h=parseInt(g.duration);$(f[e]).removeClass("not_duration").find(".audio_length").empty().append(h+"''");$(f[e]).find(".audio_area").css({width:(70+3*h)+"px"});
}},1000);$(".webWeiXinOldRecordSearch").attr("disabled",false);$(window).trigger("resize");}});}};