$(function(){var a=new BatchEntryWxCode();a.init();});function BatchEntryWxCode(){this.hadInit=false;this.employeeWeixin="";this.userName="";}BatchEntryWxCode._CONS_={LIST_DATA_URL:ctx+"/gl/cs/weiXinFriends/findByEmployeeWx.htm",SAVE_WXCODE_URL:ctx+"/ec/salesorder/soEntity/saveGrid.htm",UPDATE_INFO_URL:ctx+"/gl/cs/weiXinFriends/updateInfo.htm",ADD_WEIXIN_URL:ctx+"/gl/cs/weiXinFriends/addWeiXin.htm",ADD_REPEAT_URL:ctx+"/gl/cs/weiXinFriends/addRepeatFuns.htm",MERGE_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/mergeFriend.htm",GRID:"#entryWxCodeGrid",PAGER:"#entryWxCodePager"};
BatchEntryWxCode.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this._bindEventHander();var a=$(".activeWxCode").attr("wxCode");var b={"employeeWeixin":a};
this.employeeWeixin=a;this._initJqgrid(b);this._hideNotGrantBtn();}},_hideNotGrantBtn:function(){},_bindEventHander:function(){var a=this;$(document).on("blur",".wxCodeInput",function(){var b=$(this).val();
if(!b){return;}var c=$(this).attr("org-value");var d=$(this).attr("userName");a._saveWxCode(d,b,this);});$(document).on("click",".list-group-item",function(){$(".list-group-item").removeClass("active");
$(this).addClass("active");var b=$(this).attr("wxCode");var c={"employeeWeixin":b};a.employeeWeixin=b;a.reloadJqgrid(c);});$(document).on("click",".when-has-not-wx",function(){$(this).parents("tr").find(".wxCodeInput").val("[好友无微信号]");
$(this).parents("tr").find(".wxCodeInput").trigger("blur");});$(document).on("click",".mergeFriendsBtn",function(){var d=$(this).attr("data-nickname");
var c=$(this).attr("data-remark");var b=$(this).attr("data-username");a.userName=b;a._showMergeLayer(d,c);});$(".selectFriend").on("click",function(){var b=new WeiXinFriendsSelect();
var c={isMultiple:0,status:0,employeeWeixin:a.employeeWeixin,callBack:function(d){if(d!=null){if(d.length>0){$("input[name='mergedNickName']").val(d[0].nickName);
$("input[name='mergedRemark']").val(d[0].remark);$("input[name='mergedUserName']").val(d[0].userName);}}}};b.init(c);});},_showMergeLayer:function(c,b){var a=this;
layer.open({type:1,title:"合并好友",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","500px"],content:$(".jt-wx-merge-pane"),success:function(d,e){$("input[name='mergeingNickName']").val(c);
$("input[name='mergeingRemark']").val(b);$("input[name='mergedNickName']").val("");$("input[name='mergedRemark']").val("");$("input[name='mergedUserName']").val("");
},yes:function(e,d){a._merge(e);},cancel:function(){}});},_merge:function(b){var a=this;var c={mergeingUserName:this.userName,mergedUserName:$("input[name='mergedUserName']").val(),};
FormUtils.submit(BatchEntryWxCode._CONS_.MERGE_FRIEND_URL,c,function(e){if(e.success){var d={"employeeWeixin":a.employeeWeixin};DialogUtils.success(msgCode.INFO,e.msg);
layer.close(b);a.reloadJqgrid(d);}else{DialogUtils.error(msgCode.INFO,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_saveWxCode:function(e,a,c){var b=this;
var d={userName:e,weiXin:a};FormUtils.submit(BatchEntryWxCode._CONS_.ADD_WEIXIN_URL,d,function(f){if(f.success){DialogUtils.success(msgCode.INFO,f.msg);
$(c).attr("org-value",d.value);var g=$(c).parents("tr").nextAll("tr")[0];$(c).parents("tr").find(".jt-is-repeat").remove();$(g).find(".wxCodeInput").focus();
}else{DialogUtils.confirmWithOptions({title:f.msg+"。确定保存吗？",text:"",confirmButtonText:"确定",yesFunc:function(){b._addRepeatFuns(e,a,f.msg,c);}});}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_addRepeatFuns:function(f,g,e,c){var b=this;var a=BatchEntryWxCode._CONS_.ADD_REPEAT_URL;var d={userName:f,weiXin:g,repeatComment:e};FormUtils.submit(a,d,function(i){if(i.success){DialogUtils.success("提示",i.msg);
$(c).val($(c).attr("org-value"));var h={repeatComment:e,isRepeat:1};if($(c).parents("tr").find(".jt-is-repeat").length<=0){$(c).parents("tr").find("td[aria-describedby='entryWxCodeGrid_nickName']").append(b._getRepeat(h));
}}else{DialogUtils.error("错误",i.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(BatchEntryWxCode._CONS_.GRID,a);
},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}$(BatchEntryWxCode._CONS_.GRID).JTJqgrid({url:BatchEntryWxCode._CONS_.LIST_DATA_URL+"?sord=asc&sidx=wx.remark_py_",pager:BatchEntryWxCode._CONS_.PAGER,postData:b,colNames:["userName","friendCode","昵称","备注","状态","微信号","操作"],colModel:[{name:"userName",index:"user_name_",width:80,hidden:true},{name:"friendCode",index:"friend_code_",width:80,hidden:true},{name:"nickName",index:"nick_name_",width:80,formatter:function(c,d,e){if(e.isRepeat==1){return c+a._getRepeat(e);
}else{return c;}}},{name:"remark",index:"remark_",width:80},{name:"status",index:"status_",width:40,formatter:function(c,d,e){if(c==1){return"在线";}else{if(c==2){return"被合并";
}else{return"离线";}}}},{name:"wxCode",index:"wx_code_",width:120,formatter:function(c,d,f){var e="";if(f.userName.indexOf("@@")!=-1){e="<input type='text' style='width:70%;' disabled='true' value='群' />";
}else{if(f.userName.indexOf("applyFriends")!=-1){e="<input type='text' style='width:70%;' disabled='true' value='好友推荐' />";}else{e="<input type='text' class='wxCodeInput' org-value='"+c+"' userName='"+f.userName+"' friendCode='"+f.friendCode+"' style='width:70%;' value='"+c+"' />";
e=e+"<a class='when-has-not-wx'>无微信号</a>";}}return e;}},{name:"oprate",width:40,formatter:function(c,d,e){if(ResUtils.canShow("weiXinChat.button.mergeFriend")&&e.status==1){return"<button class='btn btn-sm btn-outline btn-primary mergeFriendsBtn' data-nickname='"+e.nickName+"' data-remark='"+e.remark+"' data-username='"+e.userName+"'>合并</button>";
}else{return"";}}},]});},_getRepeat:function(a){if(a.isRepeat==1){return"<span class='jt-is-repeat' title='"+a.repeatComment+"' >[重]</span>";}else{return"";
}},};