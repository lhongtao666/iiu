$(function(){var a=new WeiXinRecord();a.init();});function WeiXinRecord(){this.hadInit=false;this.lastValue="";this.nodeList="";this.hadInitJqgrid=false;
this.params="";this.seniorSearch=new SeniorSearch();this.csFollow=new CsFollow();this.msgTagDatas=[];this.partyId="";this.partyType="";}WeiXinRecord._CONS_={EDIT_URL:ctx+"/crm/cs/weiXinRecord/edit.htm",DETAIL_URL:ctx+"/crm/cs/weiXinRecord/detail.htm",DELETE_URL:ctx+"/crm/cs/weiXinRecord/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/weiXinRecord/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/weiXinRecord/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm?needAid=y&needGroupKey=y",LIST_GROUP_DATA_URL:ctx+"/crm/cs/weiXinRecord/listGroupData.htm?needAid=y&needGroupKey=y",BATCH_SIGN_URL:ctx+"/crm/cs/weiXinRecord/batchSign.htm",UPDATE_MSG_TARGET_URL:ctx+"/crm/cs/weiXinRecord/updateMsgTarget.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByEmployee.htm",GET_CS_DATA_URL:ctx+"/crm/cs/csEntity/getCsByCode.htm",EDIT_FORM_ID:"weiXinRecordForm",GRID:"#weiXinRecordGrid",PAGER:"#weiXinRecordPager"};
WeiXinRecord.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=new Date();a=new Date(a.getTime()-1*24*3600*1000);$(".startDate").val(a.currentDate()+" 00:00:00");
this._bindEventHander();this._initWxlabel();this._hideNotGrantBtn();this._initEmployeeSelect("");this.initOrganizationTree();this._dealStyle();this.seniorSearch.init();
}},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=wxMsgTag";FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();
e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");}$("#wx-msg-target").empty().append(e.toString());
a.msgTagDatas=c;}});},_dealStyle:function(){var a=$("body").height();$("#organizationTree").css({"max-height":a-40+"px"});},initOrganizationTree:function(c){var a=this;
var b={async:{enable:true,url:ctx+"/gl/ou/group/findVisiableEmployeeTreeForWx.htm",contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],dataFilter:function(e,d,f){return f;
},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{onClick:function(d,f,e){a._removeOtherWx();if(!a.hadInitJqgrid){a.hadInitJqgrid=true;
var g={startDate:$(".startDate").val()};if(e.type=="group"){g.belongOgn=e.id;a.partyId=e.id;a.partyType="group";}else{g.employeeId=e.id;a._initEmployeeWeixin(e.id);
a.partyId=e.id;a.partyType="employee";}a._initJqgrid(g);}else{var g=$("#weiXinRecordSearchForm").closest("form").serialize();if(e.type=="group"){g+="&belongOgn="+e.id;
a.partyId=e.id;a.partyType="group";}else{g+="&employeeId="+e.id;a.partyId=e.id;a.partyType="employee";a._initEmployeeWeixin(e.id);}a.reloadJqgrid(g);}a.seniorSearch.initCrumbs(e,"organizationTree");
},onAsyncSuccess:function(g,i,h,j){var f=$.fn.zTree.getZTreeObj("organizationTree");if(h==null){var f=$.fn.zTree.getZTreeObj("organizationTree");var d=f.getNodes();
if(d&&d.length){var e=d[0];f.expandNode(e,true,false,false);f.selectNode(e);f.setting.callback.onClick(null,e.id,e);}}}},view:{selectedMulti:false,fontCss:function(e,d){return(!!d.highlight)?{color:"#A60000","font-weight":"bold"}:{color:"#333","font-weight":"normal"};
}}};$.fn.zTree.init($("#organizationTree"),b);},_removeOtherWx:function(){$(".employee-wx").remove();},_initEmployeeWeixin:function(a){FormUtils.loadData(WeiXinRecord._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId="+a,function(c){var d=new StringBuffer();
for(var b=0;b<c.length;b++){d.append('<li class="employee-wx employee-ex-li tabli" employee-weixin="'+c[b].weixin+'">').append('<a href="#tabRecordList" data-toggle="tab">').append(c[b].nickName).append("</a></li>");
}$(".jt-wx-nav-tab").append(d.toString());});},_hideNotGrantBtn:function(){if(!ResUtils.canShow("weiXinRecord.button.setSign")){$(".setSign").hide();}if(!ResUtils.canShow("weiXinRecord.button.cancelSign")){$(".cancelSign").hide();
}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();
},_detail:function(a){this._showFormWrapper();this._loadData(a);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(WeiXinRecord._CONS_.EDIT_FORM_ID);
},_loadData:function(b){var a=this;FormUtils.loadData(WeiXinRecord._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=code]").val(c.code);
$("input[name=remark]").val(c.remark);$("input[name=headPic]").val(c.headPic);$("input[name=nickName]").val(c.nickName);$("input[name=employeeId]").val(c.employeeId);
$("input[name=employeeWeiXin]").val(c.employeeWeiXin);$("input[name=employeeHeadPic]").val(c.employeeHeadPic);$("input[name=employeeNickName]").val(c.employeeNickName);
$("input[name=content]").val(c.content);$("input[name=type]").val(c.type);$("input[name=createTime]").val(c.createTime);});},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(WeiXinRecord._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(".weiXinRecordSearch").on("click",function(){$(".weiXinRecordSearch").attr("disabled","disabled");var c=$("input[name='startDate']").val();var d=$("input[name='endDate']").val();
if(c==""){DialogUtils.error(msgCode.ERROR,"发送时间间隔不能大于7天");$(".weiXinRecordSearch").attr("disabled",false);return false;}else{if(d==""){d=new Date();}var b=DateUtils.getDateDiff(c,d,"day");
if(b>=7){DialogUtils.error(msgCode.ERROR,"发送时间间隔不能大于7天");$(".weiXinRecordSearch").attr("disabled",false);return false;}}var e=$(this).closest("form").serialize();
if(a.partyType=="group"){e+="&belongOgn="+a.partyId;}else{e+="&employeeId="+a.partyId;}a.reloadJqgrid(e);});$("#weiXinRecordSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".weiXinRecordSearch").trigger("click");
}});$("body").on("click",".weiXinRecordDel",function(){var b=$(this).attr("idVal");if(!b){b=$(WeiXinRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".weiXinRecordDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(WeiXinRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(document).on("click",".weixinAudio",function(c){var d=$(this);
if(a.audio&&a.audio!=null){a.audio.pause();$(".audio_area").removeClass("playing");clearTimeout(a.audioEndTime);}a.audio=d.find(".media")[0];d.find(".audio_area").addClass("playing");
var b=a.audio.duration;a.audio.currentTime=0;a.audio.play();a.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");},b*1000);});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",nolimit:true,positionType:"dept_manager",fn:function(c){$("input[name=belongOgn]").val(c);
a._initEmployeeSelect(c);}};GroupUtils.selectGroupTreeBox(b);});$(document).on("click",".csTab",function(){var b=$(this).attr("idval");JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detailByCode.htm"+"?csCode="+b,"客户明细");
});$(document).on("click",".setSign",function(){var b=[];var e=$(WeiXinRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(e&&e.length>0){for(var c=0;
c<e.length;c++){var d=$(WeiXinRecord._CONS_.GRID).jqGrid("getRowData",e[c]);if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"y");}});$(document).on("click",".wx-set-star",function(){var d=$(this).attr("value");
var c=$(this).attr("createTime");var b="n";if($(this).hasClass("wx-set-star-checked")){b="n";$(this).removeClass("wx-set-star-checked");}else{b="y";$(this).addClass("wx-set-star-checked");
}a._batchSign(d,c,b);});$(document).on("click",".cancelSign",function(){var b=[];var e=$(WeiXinRecord._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(e&&e.length>0){for(var c=0;
c<e.length;c++){var d=$(WeiXinRecord._CONS_.GRID).jqGrid("getRowData",e[c]);if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"n");}});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");
var c=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;});$("#organizationTreeSearch").on("keyup",function(b){if(b.keyCode==13){a._searchNode(b);
a._callNumber();}});$("#clickUp").on("click",function(){a._clickUp();});$("#clickDown").on("click",function(){a._clickDown();});$(document).on("click",".employee-ex-li",function(){var b=$(this).attr("employee-weixin");
a.reloadJqgrid(a.params+"&Q__S__EQ__employee_wei_xin_="+b);});$(document).on("change",".select-target",function(){var f=$(this).attr("id-val");var e=$(this).attr("create-time");
var c=$(this).val();var d=[];d.push(f);var b=[];b.push(e);a._updateMsgTarget(d,b,c);});$(document).on("click",".show-detail",function(){var c=$(this).attr("data-code");
var d=$(this).attr("data-friendcode");var b=$(this).attr("data-employee-weixin");JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weiXinRecord/detailList.htm"+"?friendCode="+d+"&code="+c+"&employeeWeixin="+b+"&partyId="+a.partyId+"&partyType="+a.partyType,"消息明细");
});$(document).on("click",".add-follow",function(){var b=$(this).val();a._loadCsData(b);});$(document).on("click",".weiXinRecordSearchToday",function(){var b=new Date();
$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordSearch").trigger("click");});$(document).on("click",".weiXinRecordSearchSeven",function(){var b=new Date();
b=new Date(b.getTime()-6*24*3600*1000);$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordSearch").trigger("click");});},_loadCsData:function(b){var a=this;
var c=WeiXinRecord._CONS_.GET_CS_DATA_URL;FormUtils.submit(c,{"csCode":b},function(d){if(d){a._fillFollowRecordTab({partyId:currentUserId,partyAid:currentUserAid,partyName:currentUserName},d.id,b);
$("#addFollowBtn").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,msg.msg);}});},_fillFollowRecordTab:function(b,c,a){var d={csId:c,employeeId:currentUserId,entityId:"",csCode:a,needTable:false,followType:"cs",csType:"self",permissionType:"self"};
this.csFollow.init(d,b);this.csFollow._initEmployeeSuggest();},_searchNode:function(d){var a=$.fn.zTree.getZTreeObj("organizationTree");var c=$.trim($("#organizationTreeSearch").val());
var b="name";if(this.lastValue===c){return;}this.lastValue=c;this._updateNodes(false,this.nodeList);if(c!=""){this.nodeList=a.getNodesByParamFuzzy(b,c);
this._updateNodes(true,this.nodeList);}else{this.nodeList=[];}},_updateNodes:function(b,d){var c=$.fn.zTree.getZTreeObj("organizationTree");if(d){for(var e=0,a=d.length;
e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);}c.updateNode(d[e]);}}},_clickUp:function(){var a=$.fn.zTree.getZTreeObj("organizationTree");
if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");return;}else{if(this.clickCount==1){DialogUtils.error(msgCode.FAIL_MSG,"您已位于第一条记录上！");
return;}else{this.clickCount--;a.selectNode(this.nodeList[this.clickCount-1],false);}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
},_clickDown:function clickDown(){var a=$.fn.zTree.getZTreeObj("organizationTree");if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");
return;}else{if(this.nodeList.length==this.clickCount){DialogUtils.error(msgCode.FAIL_MSG,"您已位于最后一条记录上！");return;}else{a.selectNode(this.nodeList[this.clickCount],false);
this.clickCount++;}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";},_callNumber:function(){var a=$.fn.zTree.getZTreeObj("organizationTree");
if(this.nodeList.length){a.selectNode(this.nodeList[0],false);this.clickCount=1;document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
}else{if(this.nodeList.length==0){document.getElementById("number").innerHTML="[0/0]";a.cancelSelectedNode();}}if($.trim($("#organizationTreeSearch").val())==""){document.getElementById("number").innerHTML="";
a.cancelSelectedNode();}},_batchSign:function(d,a,b){var c=WeiXinRecord._CONS_.BATCH_SIGN_URL;FormUtils.submit(c,{"idArr":d,"createTimeArr":a,"isSign":b},function(e){if(e.success){if("y"==b){DialogUtils.success(msgCode.INFO,"设置为已读成功");
}else{DialogUtils.success(msgCode.INFO,"设置为未读成功");}$(".weiXinRecordSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});},_updateMsgTarget:function(d,a,c){var b=WeiXinRecord._CONS_.UPDATE_MSG_TARGET_URL;
FormUtils.submit(b,{"idArr":d,"createTimeArr":a,"msgTarget":c},function(e){if(e.success){DialogUtils.success(msgCode.INFO,"修改标签成功");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WeiXinRecord._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("weiXinRecord.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"weiXinRecordDel",iconClasses:"fa fa-remove"});
}if(ResUtils.canShow("weiXinRecord.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"weiXinRecordDetail",iconClasses:"fa fa-list"});}return a;
},_initEmployeeSelect:function(a){FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm?groupId="+a+"&type=dept_manager",function(c){$("#employeeId").empty();
var d=new StringBuffer();d.append("<option value=''>请选择</option>");if(c&&c.length){for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");
}$("#employeeId").append(d.toString()).select2();}},null,true);},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}$(WeiXinRecord._CONS_.GRID).JTJqgrid({url:WeiXinRecord._CONS_.LIST_GROUP_DATA_URL,pager:WeiXinRecord._CONS_.PAGER,postData:b,colNames:["ID","好友昵称","员工工号","消息条数","操作"],colModel:[{name:"id",index:"id_",hidden:true},{name:"nickName",index:"nick_name_",width:120,formatter:function(c,d,e){if(e.friendCode){if(e.friendCode.length>10){return c;
}else{return c+":<a class='csTab' style='font-weight:bold;' idVal='"+e.friendCode+"'>"+e.friendCode+"</a>";}}else{return c;}}},{name:"employeeAid",index:"employee_id_",width:80,formatter:function(c,d,e){return c+":"+e.employeeName;
}},{name:"count",index:"count_",width:100,sortable:false},{name:"oprate",width:100,sortable:false,formatter:function(c,d,e){if(ResUtils.canShow("weiXinRecord.button.detail")){return"<button type='button' data-friendcode='"+e.friendCode+"' data-code='"+e.nickNameHashCode+"' data-employee-weixin='"+e.employeeWeiXin+"' class='btn btn-sm btn-primary show-detail' style='margin-left:10px' >明细</button>"+a._getFollowBtn(e);
}else{return"";}}}],loadComplete:function(){setTimeout(function(){var d=$(".not_duration");for(var c=0;c<d.length;c++){var e=$(d[c]).find(".media")[0];
var f=parseInt(e.duration);$(d[c]).removeClass("not_duration").find(".audio_length").empty().append(f+"''");$(d[c]).find(".audio_area").css({width:(70+3*f)+"px"});
}},1000);$(".weiXinRecordSearch").attr("disabled",false);}});},_getFollowBtn:function(a){if(a.friendCode&&a.friendCode.length<=10&&ResUtils.canShow("weiXinRecord.button.addFollow")){return"<button type='button' value='"+a.friendCode+"' class='btn btn-sm btn-primary add-follow' style='margin-left:10px'>添加跟进</button>";
}else{return"";}}};