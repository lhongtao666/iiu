$(function(){var a=new WeiXinChat();a.init();});function WeiXinChat(){this.hadInit=false;this.searchParam="";this.fansInTime="";this.csInfo={};this.weiXinRelated={page:1,total:0,rows:30,status:true,sord:"asc",sidx:"wx.remark_py_",notRead:0,isLoad:false,employeeWeiXin:""};
this.weiXinNotRelated={page:1,total:0,rows:30,status:true,sord:"asc",sidx:"wx.remark_py_",notRead:0,isLoad:false,employeeWeiXin:""};this.weiXinChatForm=new WeiXinChatForm();
this.csFollow=new CsFollow();this.dblTimer=null;this.csPhone=new CsPhone();this.isBind=true;this.employeeWeiXin="";this.lastEmployeeWeiXin="";this.selectAllOnline=1;
this.inputWxlayer="";this.employeeNotRead={};this.draftMsgs={};}WeiXinChat._CONS_={LIST_GET_BY_USERNAME:ctx+"/gl/cs/weiXinFriends/getByUserName.htm",LIST_DATA_URL:ctx+"/gl/cs/weiXinFriends/listData.htm",LIST_RECENT_DATA_URL:ctx+"/gl/cs/weiXinFriends/listRecentData.htm",STATUS_NOTIFY_URL:ctx+"/gl/cs/weiXinFriends/statusNotify.htm",CLEAR_UNREAD_URL:ctx+"/gl/cs/weiXinFriends/clearUnread.htm",BIND_CS_URL:ctx+"/gl/cs/weiXinFriends/bindCs.htm",RE_BIND_CS_URL:ctx+"/gl/cs/weiXinFriends/rebindCs.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/toEdit.htm",ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",UPDATE_INFO_URL:ctx+"/gl/cs/weiXinFriends/updateInfo.htm",LIST_BATCH_ADD_URL:ctx+"/crm/cs/csEntity/batchAddWxCs.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByEmployee.htm",GET_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/getByWeiXin.htm",ADD_WEIXIN_URL:ctx+"/gl/cs/weiXinFriends/addWeiXin.htm",ADD_REPEAT_URL:ctx+"/gl/cs/weiXinFriends/addRepeatFuns.htm",CHANGE_REMARK_URL:ctx+"/gl/cs/weiXinFriends/changeRemark.htm",COUNT_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/countWxFriends.htm",BATCH_SEND_URL:ctx+"/crm/cs/weiXinRecord/batchSend.htm",RELOAD_HEADPIC_URL:ctx+"/gl/cs/weiXinFriends/reloadHeadPic.htm",ADD_PHONE_URL:ctx+"/crm/cs/csEntity/addPhone.htm",};
WeiXinChat.prototype={init:function(a){if(!this.hadInit){this._hideNotGrantedBtn();this.hadInit=true;this._initEmployeeWeiXin();this.weiXinChatForm.goToTop=true;
this.weiXinChatForm.init();this._bindEventHander();CsEntityUtils.init();this._initAddr();this._dealStyle();}},_hideNotGrantedBtn:function(){if(!ResUtils.canShow("weiXinChat.button.viewWx")){$("#jt-entry-wxcode-batch").hide();
}},_initEmployeeWeiXin:function(b){var a=this;a.employeeWeiXin="";FormUtils.loadData(WeiXinChat._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId="+currentUserId+"&status=1",function(f){var g=new StringBuffer();
var c=false;for(var e=0;e<f.length;e++){var d=(f[e].headImg==null||f.headImg=="")?("/img/jt/wx/images/head_default.jpg"):f[e].headImg;g.append("<div id="+f[e].weixin+">");
g.append("<img class='jt-employee-wx-img "+(e==0?"on":"")+"' weixin ='"+f[e].weixin+"' title='"+f[e].nickName+"' alt='"+f[e].nickName+"' src='"+ctx+d+"'>");
g.append("</div>");if(e==0){a.employeeWeiXin=f[e].weixin;a.lastEmployeeWeiXin=f[e].weixin;c=true;}}g.append("<div id='jt-all-employee-wx'><img class='jt-employee-wx-img "+(c?"":"on")+"' weixin ='' title='已关联'  src='"+(currentUserProfile?(ctx+currentUserProfile):(ctx+"/img/jt/logos/t9-green.png"))+"'></div>");
a._loadRecentData(true);a.weiXinRelated.page=1;a._loadRelatedData(true);a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);$(".my-wexin-list").empty().append(g.toString());
g=new StringBuffer();for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].weixin+"'>"+f[e].nickName+"</option>");}g.append("<option value=''>已关联</option>");
$("#employeeWeiXins").empty().append(g.toString());g=new StringBuffer();for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].weixin+"'>"+f[e].nickName+"</option>");
}$("#batch-send-employeeWeiXins").empty().append(g.toString());a._dealStyle();});},_getEmployeeWx:function(b){var a=this;FormUtils.loadData(WeiXinChat._CONS_.GET_EMPLOYEE_WEIXIN+"?weixin="+b,function(c){if(c){$("#jt-employee-wx").empty().append(b);
$("#jt-employee-wx-nickname").empty().append(c.nickName);a.weiXinChatForm.csInfo.employeeHeadPic=c.headImg;a.csInfo.employeeHeadPic=c.headImg;}},function(){},true);
},_getEmployeeWxStatus:function(a){if(a.status=="1"||a.status==1){return"<small style='color:green;'>【在】</small>";}else{if(a.status=="n"){return"<small style='color:red;'>【封】</small>";
}else{return"<small style='color:#aaa;'>【离】</small>";}}},_initAddr:function(c,a,b){this.addressService=new AddressService("addressContainer");this.addressService.init({country:c,province:a?a:"",city:b?b:"",area:"",isNotRequired:true});
},_initPhone:function(){if(csPhone){$("#csEntityFormForAdd").find('input[name="phoneNum"]').val(csPhone);$("#csEntityFormForAdd").find("#maskPhoneNum").val(CsEntityUtils.maskPhoneNum(csPhone)).attr("readonly",true);
this._getChannel(function(a){CsEntityUtils._initChannelSelect(a.channel);CsEntityUtils._initInterestsSelect(a.interest);});$(".makePhoneDiv").show();}},_getChannel:function(b){var a=this;
FormUtils.loadData(ctx+"/ec/media/mediaChannel/findByPhone.htm?outPhone="+outNum+"&inPhone="+inNum,function(c){var d={};if(c&&c.length>0&&c[0].id){d.channel=c[0].id;
d.interest=c[0].interst;}if(b&&typeof b==="function"){b(d);}});},_fillFollowRecordTab:function(a){var b={csId:this.csInfo.csId,employeeId:currentUserId,entityId:"",csCode:this.csInfo.csCode,needTable:false,followType:"cs",csType:"self",permissionType:"self"};
this.csFollow.init(b,a);this.csFollow._initEmployeeSuggest();},_hideChat:function(){$(".main-show").show();$(".main-hide").hide();$(".jt-close-history").trigger("click");
},_loadRelatedData:function(f){var b=this;var a=window.localStorage.getItem("isWxLoadComplete");var e={};if(a&&a!=""){e=JSON.parse(a);}var d=$("#tabRelated").find(".m-list").find("ul");
if(b.employeeWeiXin&&b.employeeWeiXin!=""){if(e&&e[b.employeeWeiXin]=="n"){d.empty().append("<li style='text-align:center'>加载中...</li>");return;}}var c=WeiXinChat._CONS_.LIST_DATA_URL+"?isRelated=y&page="+this.weiXinRelated.page+"&rows="+this.weiXinRelated.rows+"&sord="+this.weiXinRelated.sord+"&sidx="+this.weiXinRelated.sidx+"&employeeWeixin="+b.employeeWeiXin+"&Q__N__EQ__wx.status_="+b.selectAllOnline+"&searchParam="+this.searchParam+"&fansInTime="+this.fansInTime;
if(f){d.empty();b._hideChat();}b.weiXinRelated.status=false;FormUtils.loadData(c,function(h){var j=h.rows;b.weiXinRelated.total=h.total;$("#related-total").empty().append(h.records);
if(j&&j.length){var k=new StringBuffer();for(var g=0;g<j.length;g++){if($("#"+j[g].userName.substring(1,j[g].userName.length)).length>0){continue;}k.append(b._getRelatedLi(j[g]));
}d.append(k.toString());}b.weiXinRelated.status=true;b._addNotReadToTab();},function(){},true);},_loadNotRelatedData:function(f){var b=this;var a=window.localStorage.getItem("isWxLoadComplete");
var e={};if(a&&a!=""){e=JSON.parse(a);}var d=$("#tabNotRelate").find(".m-list").find("ul");if(b.employeeWeiXin&&b.employeeWeiXin!=""){if(e&&e[b.employeeWeiXin]=="n"){d.empty().append("<li style='text-align:center'>加载中...</li>");
return;}}var c=WeiXinChat._CONS_.LIST_DATA_URL+"?Q__N__EQ__wx.status_="+b.selectAllOnline+"&page="+this.weiXinNotRelated.page+"&rows="+this.weiXinNotRelated.rows+"&sord="+this.weiXinNotRelated.sord+"&sidx="+this.weiXinNotRelated.sidx+"&employeeWeixin="+b.employeeWeiXin+"&searchParam="+this.searchParam+"&fansInTime="+this.fansInTime;
if(f){d.empty();b._hideChat();}b.weiXinNotRelated.status=false;FormUtils.loadData(c,function(h){var j=h.rows;b.weiXinNotRelated.total=h.total;$("#not-related-total").empty().append(h.records);
if(j&&j.length){var k=new StringBuffer();for(var g=0;g<j.length;g++){k.append(b._getNotRelateLi(j[g]));}d.append(k.toString());}b.weiXinNotRelated.status=true;
b._addNotReadToTab();},function(){},true);},_loadRecentData:function(d){var a=this;var c=WeiXinChat._CONS_.LIST_RECENT_DATA_URL+"?Q__N__EQ__wx.status_="+a.selectAllOnline+"&page=1&rows=50&sord=desc&sidx=ext.last_reply_time_&employeeWeixin="+a.employeeWeiXin+"&searchParam="+this.searchParam+"&fansInTime="+this.fansInTime;
var b=$("#tabRecent").find(".m-list").find("ul");if(d){b.empty();a._hideChat();a.weiXinRelated.notRead=0;a.employeeNotRead={};}FormUtils.loadData(c,function(f){$("#recent-total").empty().append(f.length);
if(f&&f.length){var g=new StringBuffer();for(var e=0;e<f.length;e++){g.append(a._getRecentLi(f[e]));}b.append(g.toString());}a._addNotReadToTab();a._addEmpWxUnreadMsg();
},function(){},true);},_getNotReadData:function(b){var a=b.unreadCount;if(a>0){if(this.employeeNotRead[b.employeeWeixin]){this.employeeNotRead[b.employeeWeixin]=this.employeeNotRead[b.employeeWeixin]+a;
}else{this.employeeNotRead[b.employeeWeixin]=a;}this._addNotReadCount(true,a);return"<span class='badge badge-danger pull-right msg-not-read'>"+a+"</span>";
}else{return"";}},_addNotReadToTab:function(){if(this.weiXinRelated.notRead>0){$("#recent-not-read").empty().append(this.weiXinRelated.notRead).show();
}else{$("#recent-not-read").hide();}},_addNotReadCount:function(b,a){if(b){this.weiXinRelated.notRead+=a;}else{this.weiXinNotRelated.notRead+=a;}},_addWxNotRead:function(a,b){if(this.employeeNotRead[a]){this.employeeNotRead[a]=this.employeeNotRead[a]+b;
}else{this.employeeNotRead[a]=b;}$("#"+a).find(".msg-not-read").remove();if(this.employeeNotRead[a]>0){$("#"+a).append("<span class='badge badge-danger pull-right msg-not-read'>"+this.employeeNotRead[a]+"</span>");
}},_addEmpWxUnreadMsg:function(){var a=$(".my-wexin-list").find("div");for(var b=0;b<a.length;b++){var c=$(a[b]).attr("id");if(this.employeeWeiXin==c){this._addWxNotRead(c,0);
}}},_removeNotRead:function(c,b,a){this._addNotReadCount(c,-b);this._addNotReadToTab();this._addWxNotRead(a,-b);FormUtils.submit(WeiXinChat._CONS_.CLEAR_UNREAD_URL,{userName:this.csInfo.userName},function(d){},function(){},true);
if(!this.csInfo.hasInline){return false;}FormUtils.submit(WeiXinChat._CONS_.STATUS_NOTIFY_URL,{userName:this.csInfo.userName,empWx:this.csInfo.employeeWeiXin},function(d){},function(){},true);
},_dealStyle:function(){var a=$(".sidebar").outerHeight()-$(".m-card").outerHeight()-$(".weiXin-nav-tabs").outerHeight()-60;$("#tabRelated").find(".m-list").height(a);
$("#tabRecent").find(".m-list").height(a);if(ResUtils.canShow("weiXinChat.button.viewWx")){$("#tabNotRelate").find(".m-list").height(a-34);}else{$("#tabNotRelate").find(".m-list").height(a);
}$(".my-wexin-list").height($(".sidebar").outerHeight()+2);var b=$("#chat").width();if($(".chat-history").is(":hidden")){if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"560px"});$(".main-show").css({"width":"560px"});$(".sidebar-left").css({"margin-left":b>920?((b-920)/2+"px"):"0px"});}else{$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});$(".sidebar-left").css({"margin-left":((b-1040)/2+"px")});}}else{if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"300px"});$(".main-show").css({"width":"300px"});$(".sidebar").css({"margin-left":b>960?((b-960)/2+"px"):"0px"});}else{$(".chat-history").css({"width":"400px"});
$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});$(".sidebar-left").css({"margin-left":((b-1440)/2+"px")});}}$(".sidebar-left").show();
$(".sidebar").show();},_showChat:function(a){$(".main-show").hide();$(".main-hide").show();this.weiXinChatForm.record.page=1;this.weiXinChatForm.record.status=false;
this.weiXinChatForm.csInfo=this.csInfo;this.weiXinChatForm.goToTop=true;this.weiXinChatForm.lastChatTime="";this.weiXinChatForm.initChat(a);},_getDraftMsg:function(){var a=this.csInfo.userName;
var b=this.draftMsgs[a];if(b&&b!=""){$("#chat-textarea").html(b.msg);}var c=this._getId(a)+"-recent";$("#"+c).find(".last-content").show();$("#"+c).find(".draft-content").hide();
},_setDraftMsg:function(){var c={};var d=$("#chat-textarea").html();var b=this.csInfo.userName;if(d&&d!=""){c.typeMsg=this._getDraftTypeMsg(d);c.msg=d;
this.draftMsgs[b]=c;var e=this._getId(b)+"-recent";$("#"+e).find(".last-content").hide();$("#"+e).find(".draft-content").css({"display":"block"});var a=c.typeMsg.length>7?(c.typeMsg.substring(0,6)+"..."):c.typeMsg;
$("#"+e).find(".draft-content").empty().append('<span style="color:red;">[草稿]</span>'+a);}else{c.typeMsg="";c.msg="";this.draftMsgs[b]=c;}},_getDraftTypeMsg:function(a){if(a&&a.trim!=""){if(a.indexOf('type-value="7"')!=-1){return"[文件]";
}else{if(a.indexOf('type-value="1"')!=-1){return"[图片]";}else{return a.replaceAll("&nbsp;"," ");}}}else{return"";}},_bindEventHander:function(){var a=this;
$(window).on("resize",function(){a._dealStyle();});$(document).on("click",".weiXin-nav-tabs .tabli",function(){if($(this).attr("id")=="recentTabLi"){if(a.lastEmployeeWeiXin!=a.employeeWeiXin){a.lastEmployeeWeiXin=a.employeeWeiXin;
a._loadRecentData(true);}}else{if($(this).attr("id")=="relatedTabLi"){if(a.weiXinRelated.employeeWeiXin!=a.employeeWeiXin||!a.weiXinRelated.isLoad){a.weiXinRelated.isLoad=true;
a.weiXinRelated.employeeWeiXin=a.employeeWeiXin;a.weiXinRelated.page=1;a._loadRelatedData(true);}}else{if($(this).attr("id")=="notRelateTabLi"){if(a.weiXinNotRelated.employeeWeiXin!=a.employeeWeiXin||!a.weiXinNotRelated.isLoad){a.weiXinNotRelated.isLoad=true;
a.weiXinNotRelated.employeeWeiXin=a.employeeWeiXin;a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);}}}}});$(document).on("click",".m-list li",function(t){a._setDraftMsg();
var j=this;var w=$(t.target);if(w.attr("name")=="select"){return;}var q=false;if($(j).parents(".contacts-list").length>0){q=true;var k=$(j).attr("user-name");
var p=a._getId(k)+"-recent";var m=$("#"+p);var n=m.length<=0;m.remove();$(".weiXin-nav-tabs").find(".tabli").removeClass("active");$(".weiXin-nav-tabs").find(".tab-pane").removeClass("active");
$("#recentTabLi").addClass("active");$("#tabRecent").addClass("active");a._loadByUserName(k,null,function(){$("#"+p).trigger("click");},n);return;}var i=$(j).attr("code-value");
var h=$(j).attr("name-value");var c=$(j).attr("employee-weixin");var y=$(j).attr("relate-flag")==1?true:false;var b=y?$(j).attr("cs-id"):"";var k=$(j).attr("user-name");
var v=$(j).attr("nick-name");var s=$(j).attr("remark");var u=$(j).attr("wx-code");var g=$(j).attr("wx-label");var l=$(j).find("img").attr("src-val");var d=$(j).attr("nick-name-hashcode");
var x=$(j).attr("canPlaceSo");$(".m-list li").removeClass("active");$(j).addClass("active");var f=$(j).find(".has-not-in-weixin").length>0;var r=!($(j).find(".has-not-inline-weixin").length>0);
a.csInfo={csCode:i,csName:h,employeeWeiXin:c,csId:b,userName:k,headImgUrl:l,nickName:v,hasInline:r,wxCode:u,wxLabel:g,remark:s,nickNameHashCode:d};a._loadData(k);
var o=$(j).find(".msg-not-read");if(o.length>0){a._removeNotRead(true,parseInt(o.html()),c);o.remove();}$(".jt-close-history").trigger("click");$(".jt-chat-div-for-change").attr("id","jt-chat-"+a._getId(k));
a._getEmployeeWx(c);$("#myMenu").show();$("#myMenu").find(".all").show();if(y){$("#chat-person").empty().append("<a id='jt-chat-cs' cs-id='"+b+"'>"+i+":"+h+"</a>");
$("#myMenu").find(".unrelate").hide();if(x=="n"){$("#myMenu").find("#jt-cs-placeOrder").hide();}}else{$("#chat-person").empty().append(h);$("#myMenu").find(".related").hide();
}if(k.indexOf("@@")!=-1){$("#myMenu").find(".all").hide();}a._updateWeiXinInfo(k,f);if(f&&"y"==forceInputWx){$(".main-show").show();$(".main-hide").hide();
return false;}a._showChat(q);a._getDraftMsg();});$(document).on("dblclick",".m-list li",function(d){var c=$(this).hasClass("related");if(!c){return;}var b=$(this).attr("cs-id");
JTTabUtils.addOrRefreshTab(WeiXinChat._CONS_.DETAIL_CS_PAGE_URL+"?csId="+b,"客户");});$("#selectAll").on("click",function(){var c=$(this)[0].checked;var b=$("[name=select]");
for(var d=0;d<b.length;d++){b[d].checked=c;}});$(document).on("click","#jt-chat-cs",function(){var b=$(this).attr("cs-id");JTTabUtils.addOrRefreshTab(WeiXinChat._CONS_.DETAIL_CS_PAGE_URL+"?type=self&csId="+b,"客户");
});$(document).on("click","#jt-weixin-reciverBtn2",function(){var c=$("#jt-reciver-msg").val();var e=JSON.parse(c);var b=a._getId(e.userName);var i=b+"-recent";
var f=$("#"+i);if(f&&f.length>0){f.remove();$("#tabRecent .m-list ul").prepend(f);e.lastReplyType=e.contentType;e.lastReplyContent=e.content;$("#"+i).find(".last-content").empty().append(a._getContent(e));
$("#"+b).find(".last-content").empty().append(a._getContent(e));if(e.status==2){$("#"+i).find(".name-span").addClass("jt-is-abnormal");$("#"+b).find(".name-span").addClass("jt-is-abnormal");
}else{$("#"+i).find(".name-span").removeClass("jt-is-abnormal");$("#"+b).find(".name-span").removeClass("jt-is-abnormal");}if(!f.hasClass("active")&&e.type=="in"){var h=$("#"+i).find(".msg-not-read");
if(h.length>0){var g=parseInt(h.text());h.empty().append(g+1);}else{$("#"+i).find(".avatar").after("<span class='badge badge-danger pull-right msg-not-read'>1</span>");
}a._addNotReadCount(true,1);a._addNotReadToTab();a._addWxNotRead(e.employeeWeiXin,1);}else{if(e.type=="in"){a._addNotReadCount(true,1);a._addWxNotRead(e.employeeWeiXin,1);
a._removeNotRead(true,1,e.employeeWeiXin);}}}else{a._loadByUserName(e.userName,e.type,function(){if(e.type=="in"){a._addNotReadToTab();a._addWxNotRead(e.employeeWeiXin,0);
}},true);}if(e.contentType=="6"||e.contentType==6){var d=parseInt($("#not-related-total").text())+1;$("#not-related-total").empty().append(d);}});$(document).on("click","#jt-weixin-reloadBtn",function(){var b=$("#jt-weixin-reloadWx").val();
if(b&&b!=null&&b!=""){if(b==a.employeeWeiXin){a._loadRecentData(true);a.weiXinRelated.page=1;a._loadRelatedData(true);a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);
}}else{a._initEmployeeWeiXin(true);}});$(document).on("click",".sidebar .tabli",function(){$(".m-list li").removeClass("active");$(".main-show").show();
$(".main-hide").hide();$(".jt-close-history").trigger("click");});$(document).on("keyup",".jt-search",function(b){if((b.keyCode==13)){a._search();}});$(document).on("change",".jt-search",function(){var b=$(".jt-search").val();
a.searchParam=b;});$(document).on("click","#jt-weixin-search",function(){a._search();});$("#tabRelated .m-list").scroll(function(){var b=$(this)[0].scrollHeight-$(this).height()-$(this).scrollTop();
if(b<10&&a.weiXinRelated.status&&a.weiXinRelated.page<a.weiXinRelated.total){a.weiXinRelated.status=false;a.weiXinRelated.page=a.weiXinRelated.page+1;a._loadRelatedData();
}});$("#tabNotRelate .m-list").scroll(function(){var b=$(this)[0].scrollHeight-$(this).height()-$(this).scrollTop();if(b<10&&a.weiXinNotRelated.status&&a.weiXinNotRelated.page<a.weiXinNotRelated.total){a.weiXinNotRelated.status=false;
a.weiXinNotRelated.page=a.weiXinNotRelated.page+1;a._loadNotRelatedData();}});$(document).on("click","#jt-bind-cs",function(){a.isBind=true;a._showBindLayer();
});$(document).on("click","#jt-rebind-cs",function(){a.isBind=false;a._showBindLayer();});$(document).on("click","#jt-add-cs",function(){FormUtils.clear("csEntityFormForAdd");
a._showAddLayer(false);});$(document).on("click","#jt-add-cs-place",function(){FormUtils.clear("csEntityFormForAdd");a._showAddLayer(true);});$("#jt-add-cs-batch").on("click",function(){var b=$("input[name='select']:checked");
var e=[];for(var c=0;c<b.length;c++){var d=$(b[c]).attr("user-name");e.push(d);}if(e.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要添加客户的微信");return;}DialogUtils.confirmWithOptions({title:"您确认要新增"+e.length+"个客户吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._batchAdd(e);
}});});$(document).on("click","#jt-select-cs",function(){var c={selectedMulti:false,callBack:function(d){if(d!=null){$("#bindCsForm input[name='friendCode']").val(d[0].code);
}},type:"search"};var b=new CustomerSelect();b.init(c);});$(document).on("click","#jt-cs-placeOrder",function(){JTTabUtils.addOrRefreshTab(WeiXinChat._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=false&csId="+a.csInfo.csId+"&type=self","["+a.csInfo.csName+"]下订单");
});$(document).on("click","#jt-cs-detail",function(){JTTabUtils.addOrRefreshTab(WeiXinChat._CONS_.DETAIL_CS_PAGE_URL+"?csId="+a.csInfo.csId,"客户");});$(document).on("click","#jt-cs-addFollow",function(){a._fillFollowRecordTab({partyId:currentUserId,partyAid:currentUserAid,partyName:currentUserName});
$("#addFollowBtn").trigger("click");});$(document).on("blur","#maskPhoneNum",function(){var b=$(this).val();var c=$("select[name=phoneType]").val();$("[name=phoneNum]").val(b);
$("#phoneTip").hide();if(b){if(a.csPhone._checkIsPhone(b,c)){a.csPhone.findCsByPhone(b,function(e){if(e&&e.success){var f=JSON.parse(e.msg);var d="号码重复，客户["+f.code+"："+f.name+"]已拥有该号码！";
$("#phoneTip").css("color","red").text(d).show();}else{a.csPhone._getPhoneArea(b,function(g){a._initAddr("ChinaCityCateType-root",g.provinceCateKey,g.cityCateKey);
});}});}else{$("#phoneTip").css("color","red").text("非手机类型请选座机").show();}}});$(document).on("change","[name=phoneType]",function(){$("#maskPhoneNum").trigger("blur");
});$(document).on("change","select[name=province_],select[name=city_],select[name=area_],select[name=town_]",function(){var b="-"+$("select[name=province_] option:selected").text();
if($("select[name=city_]").val()){b+="-"+$("select[name=city_] option:selected").text();}if($("select[name=area_]").val()){b+="-"+$("select[name=area_] option:selected").text();
}if($("select[name=town_]").val()){b+="-"+$("select[name=town_] option:selected").text();}$(".addrDetaileDescribe").text(b);});$("body").on("click",".remove-search-param",function(){$(".jt-search").val("");
a.searchParam="";a._reloadData();});$("#employeeWeiXins").on("change",function(){var b=$(this).val();a.lastEmployeeWeiXin=a.employeeWeiXin;a.weiXinRelated.employeeWeiXin=a.employeeWeiXin;
a.weiXinNotRelated.employeeWeiXin=a.employeeWeiXin;a.employeeWeiXin=b;a._reloadData();$(".jt-employee-wx-img").removeClass("on");if(b==""||b==null){$("#jt-all-employee-wx").find(".jt-employee-wx-img").addClass("on");
}$("#"+b).find(".jt-employee-wx-img").addClass("on");});$("#fans-in-time").on("change",function(){var b=$(this).val();if(b&&b=="today"){a.fansInTime=DateUtils.format(new Date(),"yyyy-MM-dd")+" 00:00:00";
}else{a.fansInTime="";}a._reloadData();});$("body").on("click",".when-has-not-wx",function(){$("input[name='inputWeiXin']").val("[好友无微信号]");});$("body").on("click",".orderByPinyin",function(){$("input[name='orderByPinyin']").trigger("click");
});$("body").on("click",".selectOnLine",function(){$("input[name='selectOnLine']").trigger("click");});$("input[name='selectOnLine']").on("change",function(){var b=$(this)[0].checked;
if(b){a.selectAllOnline=1;}else{a.selectAllOnline="";}a.weiXinRelated.page=1;a.weiXinNotRelated.page=1;a._loadRelatedData(true);a._loadNotRelatedData(true);
});$("input[name='orderByPinyin']").on("change",function(){var b=$(this)[0].checked;if(b){a.weiXinRelated.sord="asc";a.weiXinRelated.sidx="wx.remark_py_";
a.weiXinNotRelated.sord="asc";a.weiXinNotRelated.sidx="wx.remark_py_";}else{a.weiXinRelated.sord="desc";a.weiXinRelated.sidx="ext.last_reply_time_";a.weiXinNotRelated.sord="";
a.weiXinNotRelated.sidx="";}a.weiXinRelated.page=1;a.weiXinNotRelated.page=1;a._loadRelatedData(true);a._loadNotRelatedData(true);});$(document).on("click","#jt-entry-wxcode-batch",function(){var b=$("#employeeWeiXins").val();
JTTabUtils.addOrRefreshTab(ctx+"/gl/cs/weiXinFriends/batchEntryWxCode.htm?type=self&wxCode="+b,"管理微信号");});$(document).on("click","#jt-add-wxCode",function(){var b=a.csInfo.userName;
var c=a._getId(b);a._showInputWxLayer(c);});$(document).on("click","#jt-reload-headPic",function(){var b=a.csInfo.userName;a._reloadHeadPic(b);});$("#jt-wx-change-remark").on("click",function(){a._showChangeRemarkLayer();
});$(document).on("click",".jt-employee-wx-img",function(){$(".jt-employee-wx-img").removeClass("on");$(this).addClass("on");var b=$(this).attr("weixin");
$("#employeeWeiXins").val(b);a.lastEmployeeWeiXin=a.employeeWeiXin;a.weiXinRelated.employeeWeiXin=a.employeeWeiXin;a.weiXinNotRelated.employeeWeiXin=a.employeeWeiXin;
a.employeeWeiXin=b;a._reloadData();});$("#show-more-button").on("click",function(){if($(".jt-more-button").is(":hidden")){$(".jt-more-button").show();a._dealStyle();
}else{$(".jt-more-button").hide();a._dealStyle();}});$(".jt-goto-send-msg").on("click",function(){var d=a._getId(a.csInfo.userName)+"-recent";var c=$("#"+d);
var b=c.length<=0;c.remove();$(".weiXin-nav-tabs").find(".tabli").removeClass("active");$(".weiXin-nav-tabs").find(".tab-pane").removeClass("active");$("#recentTabLi").addClass("active");
$("#tabRecent").addClass("active");a._loadByUserName(a.csInfo.userName,null,function(){$("#"+d).trigger("click");},b);});$("#jt-weixin-barch-send").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/gl/cs/weiXinFriends/batchSendWxMsg.htm","群发消息");
});$(document).on("keydown","#batch-chat-textarea",function(b){var c=$(this).val();if(b.keyCode==13){if(b.ctrlKey){$(this).val(c+"\r\n");}else{if((c.length<2||c.length>1024)||c.trim().length<1){DialogUtils.error(msgCode.ERROR,"消息长度必须在2-1024范围");
}else{a.sendBatch();}b.cancelBubble=true;b.preventDefault();b.stopPropagation();return false;}}});$(document).on("click",".jt-weixin-batch-sendMsgBtn",function(){var b=$("#batch-chat-textarea").val();
if((b.length<2||b.length>1024)||b.trim().length<1){DialogUtils.error(msgCode.ERROR,"消息长度必须在2-1024范围");return false;}a.sendBatch();});$(document).on("click",".batch-send-label",function(){if($(this).hasClass("batch-send-label-selected")){$(this).removeClass("batch-send-label-selected");
}else{$(this).addClass("batch-send-label-selected");}a._findWxFriendNum();});$("#batch-send-employeeWeiXins").on("change",function(){a._findWxFriendNum();
});$(document).on("contextmenu",".wx-phone",function(){if($(this).parents("small").hasClass("last-content")){return;}var c=$(this).attr("mask-phone");var b=$(this).text();
a._addPhone(c,b);return false;});},_addPhone:function(c,a){var b=this;if(b.csInfo.csId==""||b.csInfo.csId==null){DialogUtils.error(msgCode.ERROR,"请先新增或者绑定客户");
return;}layer.open({type:1,title:"新增号码",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["650px","450px"],content:$(".jt-wx-add-phone"),success:function(d,e){$("#addPhoneForm input[name='friendCode']").val(b.csInfo.csCode);
$("#addPhoneForm input[name='csName']").val(b.csInfo.csName);$("#addPhoneForm input[name='phone']").val(a);},yes:function(f,d){var e=WeiXinChat._CONS_.ADD_PHONE_URL;
FormUtils.submit(e,{maskPhone:c,phoneType:$("#addPhoneForm select[name=phoneType]").val(),csId:b.csInfo.csId},function(g){if(g.success){DialogUtils.success(msgCode.SUCCESS,"添加号码成功");
layer.close(f);}else{DialogUtils.error(msgCode.ERROR,g.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},cancel:function(){}});
},_reloadData:function(){var a=this;if($("#recentTabLi").hasClass("active")){a._loadRecentData(true);}else{if($("#relatedTabLi").hasClass("active")){a.weiXinRelated.page=1;
a._loadRelatedData(true);}else{if($("#notRelateTabLi").hasClass("active")){a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);}}}},_findWxFriendNum:function(){var a=WeiXinChat._CONS_.COUNT_FRIEND_URL;
var c=this._getLabels();var b={employeeWeixin:$("#batch-send-employeeWeiXins").val(),labels:c};FormUtils.submit(a,b,function(d){if(d.success){$(".batch-send-person-num").empty().append("已选中【"+d.msg+"】位好友");
$("#selected-firends").val(d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},sendBatch:function(){var a=this;var b={content:encodeURIComponent($("#batch-chat-textarea").val()),contentType:0,labels:a._getLabels(),employeeWeixin:$("#batch-send-employeeWeiXins").val()};
FormUtils.submit(WeiXinChat._CONS_.BATCH_SEND_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"消息发送中...");}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_getLabels:function(){var b=$(".batch-send-label-selected");var c="";for(var a=0;
a<b.length;a++){if(a==0){c=$(b[a]).text();}else{c+=","+$(b[a]).text();}}return c;},_updateWeiXinInfo:function(c,a){var b=this;if(!b.csInfo.hasInline){return false;
}FormUtils.submit(WeiXinChat._CONS_.UPDATE_INFO_URL,{userName:c},function(f){if(f.success){var e=null;if(f.msg!=null){e=JSON.parse(f.msg);}if(e!=null){if(e.headImgUrl.indexOf("http://wx.qlogo.cn")==-1){e.headImgUrl=ctx+e.headImgUrl;
}var d=e.headImgUrl;var g=b._getId(e.userName);$("#"+g+"-recent").find("img").attr("src-val",d).attr("src",d);$("#"+g).find("img").attr("src-val",d).attr("src",d);
if(b.csInfo.userName==e.userName){b.weiXinChatForm.csInfo=b.csInfo;}if(a&&"y"==forceInputWx){b._showInputWxLayer(g);}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);},_search:function(){var a=this;var b=$(".jt-search").val();a.searchParam=b;if($("#tabRelated").hasClass("active")){a.weiXinRelated.page=1;a._loadRelatedData(true);
}else{if($("#tabNotRelate").hasClass("active")){a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);}else{a._loadRecentData(true);}}},_loadData:function(c){var a=this;
var b=WeiXinChat._CONS_.LIST_GET_BY_USERNAME;FormUtils.loadData(b+"?userName="+c,function(d){if(d){$("#jt-wx-bindtime").empty().append(d.bindTime);$("#jt-wx-passtime").empty().append(d.paseTime);
}},function(){},true);},_loadByUserName:function(e,d,c,f){var a=this;var b=WeiXinChat._CONS_.LIST_GET_BY_USERNAME;FormUtils.loadData(b+"?userName="+e,function(h){if(h){$("#tabRecent .m-list ul").prepend(a._getRecentLi(h));
}if(c&&typeof c=="function"){c();}if(f){var g=parseInt($("#recent-total").text())+1;$("#recent-total").empty().append(g);}},function(){},true);},_showBindLayer:function(){var a=this;
if(!a._isInline()){return false;}layer.open({type:1,title:a.csInfo.remark+"--绑定客户"+(a.isBind?"":"<span style='color:red;'>注意：不选客户则解绑</span>"),maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["650px","450px"],content:$(".jt-wx-bind-cs"),success:function(b,c){if(a.isBind){$(".bind-with-weixin").show();
}else{$(".bind-with-weixin").hide();}$("#bindCsForm input[name='nickName']").val(a.isBind?a.csInfo.remark:a.csInfo.name);$("#bindCsForm input[name='userName']").val(a.csInfo.userName);
$("#bindCsForm input[name='weixin']").val(a.csInfo.wxCode);$("#bindCsForm input[name='friendCode']").val("");},yes:function(d,b){var e=$("#bindCsForm input[name='userName']").val();
var f=$("#bindCsForm input[name='friendCode']").val();var c=$("#bindCsForm input[name='weixin']").val();a._bindCs(e,f,c,d);},cancel:function(){}});},_showAddLayer:function(b){var c=this;
if(!c._isInline()){return false;}var a="确定";if(b){a="确定并下单";}layer.open({type:1,title:c.csInfo.remark+'--新增客户<span style="display:none; " id="phoneTip"></span>',maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:[a,"取消"],area:["650px","480px"],content:$(".jt-wx-add-cs"),success:function(d,f){var e=WeiXinChat._CONS_.LIST_GET_BY_USERNAME;
FormUtils.loadData(e+"?userName="+c.csInfo.userName,function(g){if(g){$("#csEntityFormForAdd input[name='name']").val(g.remark);$("#csEntityFormForAdd input[name='friendCode']").val(g.csCode);
$("#csEntityFormForAdd input[name='userName']").val(g.userName);$("#csEntityFormForAdd input[name='employeeId']").val(currentUserId);$("#csEntityFormForAdd input[name='weixin']").val(g.wxCode);
if(g.sex==1){$("#genderMan").attr("checked",true);$("#genderWomen").attr("checked",false);}else{if(g.sex==2){$("#genderMan").attr("checked",false);$("#genderWomen").attr("checked",true);
}else{$("#genderMan").attr("checked",false);$("#genderWomen").attr("checked",false);}}}});},yes:function(e,d){c._saveAdd(e,b);},cancel:function(e,d){}});
},_showInputWxLayer:function(b){var a=this;if(a.inputWxlayer!=""){layer.close(a.inputWxlayer);a.inputWxlayer="";}layer.open({type:1,title:a.csInfo.remark+"--输入微信号",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["400px","300px"],content:$(".jt-wx-input-pane"),success:function(c,d){a.inputWxlayer=d;
$("input[name='inputWeiXin']").val(a.csInfo.wxCode);},yes:function(d,c){a._addWeiXin(b);},cancel:function(){a.inputWxlayer="";}});},_showChangeRemarkLayer:function(){var a=this;
if(a.inputWxlayer!=""){layer.close(a.inputWxlayer);a.inputWxlayer="";}layer.open({type:1,title:a.csInfo.remark+"--修改备注",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["400px","300px"],content:$(".jt-wx-remark-pane"),success:function(b,c){$("input[name='inputRemark']").val(a.csInfo.remark);
},yes:function(c,b){a._changeRemark(c);},cancel:function(){}});},_showBatchSendLayer:function(){var a=this;layer.open({type:1,title:"群发",maxmin:false,move:false,scrollbar:false,shadeClose:false,area:["650px","450px"],content:$(".jt-wx-batch-send"),success:function(b,c){$("#batch-chat-textarea").focus();
a._findWxFriendNum();},yes:function(c,b){},cancel:function(){}});},_changeRemark:function(c){var b=this;var a=WeiXinChat._CONS_.CHANGE_REMARK_URL;var d=$("input[name='inputRemark']").val();
if(!d||d==""||d==null){DialogUtils.error("提示","请输入备注");return;}FormUtils.submit(a,{empWx:b.csInfo.employeeWeiXin,remark:d,userName:b.csInfo.userName},function(e){if(e.success){DialogUtils.success("提示","修改备注成功");
layer.close(c);var f=b._getId(b.csInfo.userName);$("#"+f).find(".name-span").empty().append(b.csInfo.relateFlag==1?elf._getRegularName(e.msg):b._getRegularNickName(e.msg));
$("#"+f).attr("remark",e.msg).attr("name-value",e.msg);$("#"+f+"-recent").find(".name-span").empty().append(b._getRegularNickName(e.msg));$("#"+f+"-recent").attr("remark",e.msg).attr("name-value",e.msg);
$("#chat-person").empty().append(e.msg);b.csInfo.remark=d;}else{DialogUtils.error("失败",e.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},_addWeiXin:function(d){var b=this;
var a=WeiXinChat._CONS_.ADD_WEIXIN_URL;var c=$("input[name='inputWeiXin']").val();if(!c||c==""||c==null){DialogUtils.error("提示","请输入微信号");return;}FormUtils.submit(a,{userName:b.csInfo.userName,weiXin:c},function(f){layer.close(b.inputWxlayer);
b.inputWxlayer="";if(f.success){DialogUtils.success("提示","输入成功");var e={wxCode:c};if($("#"+d).find(".has-in-weixin").length<=0){$("#"+d).find(".name-span").after('<span class="has-in-weixin" title="'+b._getWeiXinForTitle(e)+'">[微]</span>');
}if($("#"+d+"-recent").find(".has-in-weixin").length<=0){$("#"+d+"-recent").find(".name-span").after('<span class="has-in-weixin" title="'+b._getWeiXinForTitle(e)+'">[微]</span>');
}if($("#"+d).find(".jt-is-repeat").length>0){$("#"+d).find(".jt-is-repeat").remove();}if($("#"+d+"-recent").find(".jt-is-repeat").length>0){$("#"+d+"-recent").find(".jt-is-repeat").remove();
}$("#"+d).attr("wx-code",c);$("#"+d+"-recent").attr("wx-code",c);b.csInfo.hasInline=true;b.csInfo.wxCode=c;}else{DialogUtils.confirmWithOptions({title:f.msg+"。确定保存吗？",text:"",confirmButtonText:"确定",yesFunc:function(){b._addRepeatFuns(d,c,f.msg);
}});}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},_addRepeatFuns:function(e,d,c){var b=this;var a=WeiXinChat._CONS_.ADD_REPEAT_URL;FormUtils.submit(a,{userName:b.csInfo.userName,weiXin:d,repeatComment:encodeURIComponent(c)},function(g){if(g.success){var f={wxCode:d};
DialogUtils.success("提示",g.msg);if($("#"+e).find(".has-in-weixin").length<=0){$("#"+e).find(".name-span").after('<span class="has-in-weixin" title="'+b._getWeiXinForTitle(f)+'">[微]</span>');
}if($("#"+e+"-recent").find(".has-in-weixin").length<=0){$("#"+e+"-recent").find(".name-span").after('<span class="has-in-weixin" title="'+b._getWeiXinForTitle(f)+'">[微]</span>');
}if($("#"+e).find(".jt-is-repeat").length<=0){$("#"+e).find(".has-in-weixin").after("<span class='jt-is-repeat' title='"+c+"' >[重]</span>");}if($("#"+e+"-recent").find(".jt-is-repeat").length<=0){$("#"+e+"-recent").find(".has-in-weixin").after("<span class='jt-is-repeat' title='"+c+"' >[重]</span>");
}$("#"+e).attr("wx-code",d);$("#"+e+"-recent").attr("wx-code",d);b.csInfo.hasInline=true;b.csInfo.wxCode=d;}else{DialogUtils.error("错误",g.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");
});},_saveAdd:function(d,b){var c=this;var a=ctx+"/crm/cs/csEntity/saveAdd.htm";var e=$("#csEntityFormForAdd").serialize();FormUtils.submit(a,e,function(h){if(h.success){DialogUtils.success("提示","新增成功");
layer.close(d);c.searchParam="";c.weiXinNotRelated.page=1;c._loadNotRelatedData(true);c.weiXinRelated.page=1;c._loadRelatedData(true);c._loadRecentData(true);
if(b){var g=h.msg;if(g){var f=$("#chat-person").text();JTTabUtils.addOrRefreshTab(WeiXinChat._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=false&csId="+g+"&type=self","["+f+"]下订单");
}}}else{DialogUtils.error("失败",h.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},_bindCs:function(e,f,b,d){var a=this;var c=a.isBind?WeiXinChat._CONS_.BIND_CS_URL:WeiXinChat._CONS_.RE_BIND_CS_URL;
FormUtils.submit(c,{userName:e,friendCode:f,weixin:b},function(g){if(g.success){DialogUtils.success(msgCode.SUCCESS,g.msg);layer.close(d);a.searchParam="";
a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);a.weiXinRelated.page=1;a._loadRelatedData(true);a._loadRecentData(true);}else{DialogUtils.error(msgCode.ERROR,g.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_batchAdd:function(b){var a=this;FormUtils.submit(WeiXinChat._CONS_.LIST_BATCH_ADD_URL,{userNames:b},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);
a.searchParam="";a.weiXinNotRelated.page=1;a._loadNotRelatedData(true);a.weiXinRelated.page=1;a._loadRelatedData(true);}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_reloadHeadPic:function(b){var a=this;FormUtils.submit(WeiXinChat._CONS_.RELOAD_HEADPIC_URL,{userName:b},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"刷新成功");
var d=a._getId(b);$("#"+d).find(".avatar").attr("src",ctx+c.msg);$("#"+d+"-recent").find(".avatar").attr("src",ctx+c.msg);}else{DialogUtils.error(msgCode.ERROR,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_getRelatedLi:function(a,d){if(a.userName==""||a.userName==null){return"";}var c=this._getId(a.userName);
if($("#"+c).length>0&&$("#"+c).hasClass("related")){return"";}a.headImgUrl=(a.headImgUrl&&a.headImgUrl!=null?a.headImgUrl:"/img/jt/wx/images/head_default.jpg");
if(a.headImgUrl.indexOf("http://wx.qlogo.cn")==-1){a.headImgUrl=ctx+a.headImgUrl;}var b=new StringBuffer();b.append("<li class='related' id='"+c+"'").append(" cs-id='"+a.csId+"'").append(" code-value='"+a.csCode+"'").append(" name-value='"+a.name+"'").append(" user-name='"+a.userName+"'").append(" nick-name='"+a.nickName+"'").append(" nick-name-hashcode='"+a.nickNameHashCode+"'").append(" remark='"+a.remark+"'").append(" wx-label='"+a.label+"'").append(" wx-code ='"+a.wxCode+"'").append(" relate-flag ='"+a.relateFlag+"'").append(" canPlaceSo ='"+a.canPlaceSo+"'").append(" employee-weixin='"+a.employeeWeixin+"'>").append("<div class='jt-head-pic-div'>").append("<img class='avatar  "+(a.status=="0"?"gray":"")+"' src-val='"+a.headImgUrl+"' src='"+a.headImgUrl+"'>");
b.append("</div>");b.append("<p class='name'>"+a.csCode+":"+"<span class='name-span "+this._getIsAbnormal(a.isAbnormal)+"'>"+this._getRegularName(a.remark)+"</span>"+this._getRepeat(a)+this._getStatus(a)+this._getSex(a)+"<br><small  class='last-content'>"+this._getContent(a)+"</small></p>");
b.append("</li>");return b.toString();},_getRecentLi:function(a,d){if(a.userName==""||a.userName==null){return"";}var c=this._getId(a.userName)+"-recent";
if($("#"+c).length>0){return"";}a.headImgUrl=(a.headImgUrl&&a.headImgUrl!=null?a.headImgUrl:"/img/jt/wx/images/head_default.jpg");if(a.headImgUrl.indexOf("http://wx.qlogo.cn")==-1){a.headImgUrl=ctx+a.headImgUrl;
}var b=new StringBuffer();b.append("<li class='recent' id='"+c+"' ").append(" cs-id='"+a.csId+"'").append(" code-value='"+a.csCode+"'").append(" user-name='"+a.userName+"'").append(" name-value='"+a.remark+"'").append(" nick-name='"+a.nickName+"'").append(" nick-name-hashcode='"+a.nickNameHashCode+"'").append(" remark='"+a.remark+"'").append(" wx-code='"+a.wxCode+"'").append(" wx-label='"+a.label+"'").append(" relate-flag ='"+a.relateFlag+"'").append(" canPlaceSo ='"+a.canPlaceSo+"'").append(" employee-weixin='"+a.employeeWeixin+"'>").append("<div class='jt-head-pic-div'>").append("<img class='avatar "+(a.status=="0"?"gray":"")+"' src-val='"+a.headImgUrl+"' src='"+a.headImgUrl+"'>");
if(d){b.append("<span class='badge badge-danger pull-right msg-not-read'>1</span>");}else{b.append(this._getNotReadData(a));}b.append("</div>");b.append("<p class='name'> <span class='name-span "+this._getIsAbnormal(a.isAbnormal)+"'>"+this._getRegularNickName(a.remark)+"</span>"+this._getRemart(a)+this._getRepeat(a)+this._getStatus(a)+this._getSex(a)+"<br><small class='last-content'>"+this._getContent(a)+"</small><small class='draft-content'></small><small>"+this._getIsRelated(a)+"</small></p>");
b.append("</li>");return b.toString();},_getNotRelateLi:function(a,d){if(a.userName==""||a.userName==null){return"";}var c=this._getId(a.userName);if($("#"+c).length>0&&$("#"+c).hasClass("not-related")){return"";
}a.headImgUrl=(a.headImgUrl&&a.headImgUrl!=null?a.headImgUrl:"/img/jt/wx/images/head_default.jpg");if(a.headImgUrl.indexOf("http://wx.qlogo.cn")==-1){a.headImgUrl=ctx+a.headImgUrl;
}var b=new StringBuffer();b.append("<li class='not-related' id='"+c+"' ").append(" code-value='"+a.csCode+"'").append(" user-name='"+a.userName+"'").append(" name-value='"+a.remark+"'").append(" nick-name='"+a.nickName+"'").append(" nick-name-hashcode='"+a.nickNameHashCode+"'").append(" remark='"+a.remark+"'").append(" wx-code='"+a.wxCode+"'").append(" wx-label='"+a.label+"'").append(" relate-flag ='"+a.relateFlag+"'").append(" employee-weixin='"+a.employeeWeixin+"'>");
if(a.userName.indexOf("@@")==-1){b.append("<input user-name='"+a.userName+"'type='checkbox' name='select' style='float:left;'>");}b.append("<div class='jt-head-pic-div'>").append("<img class='avatar "+(a.status=="0"?"gray":"")+"' src-val='"+a.headImgUrl+"' src='"+a.headImgUrl+"'>");
b.append("</div>");b.append("<p class='name'> <span class='name-span "+this._getIsAbnormal(a.isAbnormal)+"'>"+this._getRegularNickName(a.remark)+"</span>"+this._getRemart(a)+this._getRepeat(a)+this._getStatus(a)+this._getSex(a)+"<br><small class='last-content'>"+this._getContent(a)+"</small><small>"+this._getQun(a)+"</small></p>");
b.append("</li>");return b.toString();},_getSex:function(a){if(a.userName.indexOf("@@")!=-1){return"";}if(!a.sex){return"";}if(a.sex==1){return"<i class='web_wechat_men' title='男'></i>";
}else{if(a.sex==2){return"<i class='web_wechat_women' title='女'></i>";}else{return"";}}},_getRepeat:function(a){if(a.isRepeat==1){return"<span class='jt-is-repeat' title='"+a.repeatComment+"' >[重]</span>";
}else{return"";}},_getContent:function(b){if(b.lastReplyType==1||b.lastReplyType==4||b.lastReplyType=="1"||b.lastReplyType=="4"){return"[图片]";}else{if(b.lastReplyType==2||b.lastReplyType=="2"){return"[语音]";
}else{if(b.lastReplyType==7||b.lastReplyType=="7"){return"[文件]";}else{if(b.lastReplyType==5||b.lastReplyType=="5"){var a=b.lastReplyContent.split(";");
var c=a[0]+"想要加你为朋友";return c;}else{return WeiXinUtil.replaceFace(b.lastReplyContent);}}}}},_getQun:function(a){if(a.userName.indexOf("@@")!=-1){return"<label class='label-qun'>群</label>";
}else{return"";}},_getIsRelated:function(a){if(a.userName.indexOf("@@")!=-1){return"<label class='label-qun'>群</label>";}else{if(a.relateFlag==0){return"<label class='label-not-related'>未关联</label>";
}else{return"";}}},_getIsAbnormal:function(a){if(a==1){return"jt-is-abnormal";}else{return"";}},_getPassOrBindTime:function(a){var b="";if(a.relateFlag==0){b=a.passTime;
}else{b=a.bindTime;}if(b==null||b==""){return"";}else{return DateUtils.format(new Date(b),"MM-dd").replaceAll("-","");}},_getRegularName:function(a){if(a&&a.length>10){return a.substring(0,9)+"...";
}else{return a;}},_getRegularNickName:function(a){if(a&&a.length>10){return a.substring(0,10)+"...";}else{return a;}},_getRemart:function(a){if(a.hasWeiXin&&a.hasWeiXin=="y"){return"<span class='has-in-weixin' title='"+this._getWeiXinForTitle(a)+"' >[微]</span>";
}else{return"";}},_getStatus:function(a){if(a.status&&a.status=="1"){return" ";}else{return"<span class='has-not-inline-weixin' >[离]</span>";}},_getWeiXinForTitle:function(a){if(ResUtils.canShow("weiXinChat.button.viewWx")){return a.wxCode?("微信号："+a.wxCode):"";
}else{return"";}},_getId:function(a){var b=a.substring(1,a.length);if(b.indexOf("@")==0){b="qun-"+b.substring(1,b.length);}return b;},_isInline:function(){if(!this.csInfo.hasInline){DialogUtils.error("错误","离线状态不可操作");
return false;}else{return true;}}};