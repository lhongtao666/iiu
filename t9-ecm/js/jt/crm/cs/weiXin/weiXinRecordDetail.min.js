$(function(){var a=new WeiXinRecordDetail();a.init();});function WeiXinRecordDetail(){this.hadInit=false;this.lastValue="";this.nodeList="";this.hadInitJqgrid=false;
this.params="";this.msgTagDatas=[];this.seniorSearch=new SeniorSearch();this.csFollow=new CsFollow();}WeiXinRecordDetail._CONS_={LIST_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm?needAid=y&needGroupKey=y&hasGrant="+ResUtils.canShow("androidRecord.button.viewPhone"),EXPORT_DATA_URL:ctx+"/crm/cs/weiXinRecord/exportData.htm?needAid=y&needGroupKey=y",BATCH_SIGN_URL:ctx+"/crm/cs/weiXinRecord/batchSign.htm",UPDATE_MSG_TARGET_URL:ctx+"/crm/cs/weiXinRecord/updateMsgTarget.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByEmployee.htm",GET_CS_DATA_URL:ctx+"/crm/cs/csEntity/getCsByCode.htm",GRID:"#weiXinRecordDetailGrid",PAGER:"#weiXinRecordDetailPager"};
WeiXinRecordDetail.prototype={init:function(c){if(!this.hadInit){this.hadInit=true;var b=new Date();b=new Date(b.getTime()-1*24*3600*1000);this._bindEventHander();
this._initWxlabel();this._initlabel();this._hideNotGrantBtn();CateUtils.getOptions([{typeKey:"system",pKey:"sensitiveWord",container:"sensitiveValue"}]);
var a={startDate:$(".startDate").val()};this._initJqgrid(a);this.seniorSearch.init();}},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=wxMsgTag";
FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");
}$("#wx-msg-target").empty().append(e.toString());a.msgTagDatas=c;}});},_initlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";
FormUtils.loadData(b,function(c){if(c.length>0){var e=new StringBuffer();e.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");
}$("#wx-label").empty().append(e.toString());}});},_hideNotGrantBtn:function(){if(userName==null||userName==""||typeof userName==undefined){if(!ResUtils.canShow("weiXinRecord.button.setSign")){$(".setSign").hide();
}if(!ResUtils.canShow("weiXinRecord.button.cancelSign")){$(".cancelSign").hide();}if(friendCode&&friendCode.length>=5&&friendCode.length<=10&&ResUtils.canShow("weiXinRecord.button.addFollow")){$(".add-follow").show();
}if(!ResUtils.canShow("weixinRecord.button.export")){$("#exportBtn").hide();}}else{if(!ResUtils.canShow("androidRecord.button.setSign")){$(".setSign").hide();
}if(!ResUtils.canShow("androidRecord.button.cancelSign")){$(".cancelSign").hide();}if(friendCode&&friendCode.length>=5&&friendCode.length<=10&&ResUtils.canShow("androidRecord.button.addFollow")){$(".add-follow").show();
}if(!ResUtils.canShow("androidRecord.button.export")){$("#exportBtn").hide();}}},_bindEventHander:function(){var a=this;$(document).on("click",".jt-video",function(b){b.stopPropagation();
b.preventDefault();var c=$(this).attr("src-data");WeiXinUtil.showPlayVideotLayer(c);return false;});$(".weiXinRecordDetailSearch").on("click",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#weiXinRecordDetailSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".weiXinRecordDetailSearch").trigger("click");}});
$(document).on("click",".weixinAudio",function(c){var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();$(".audio_area").removeClass("playing");clearTimeout(a.audioEndTime);
}a.audio=d.find(".media")[0];d.find(".audio_area").addClass("playing");var b=a.audio.duration;a.audio.currentTime=0;a.audio.play();a.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");
},b*1000);});$(document).on("click",".jt-audio",function(){var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();$(".jt-audio").find("i").css({"background-position":"-4px center"});
clearInterval(a.audioEndTime);clearInterval(a.timer_);}var e=d.find("i").attr("src-value");if(!d.find("audio").attr("src")){d.find("audio").attr("src",e);
d.find("audio")[0].load();}if(!d.find("span").is(".is-ready")){d.find("span").addClass("is-ready").empty().append("加载中...");}var c=-4,b=0;a.audioEndTime=setInterval(function(){if(d.find("audio")[0].readyState){a.audio=d.find("audio")[0];
d.find("span").empty().append(d.find("audio")[0].duration.toFixed(1)+"''");d.find("audio")[0].play();clearInterval(a.audioEndTime);a.timer_=setInterval(function(){c-=18;
d.find("i").css({"background-position":c+"px center"});if(c==-58){c=14;}if(d.find("audio")[0].ended){clearInterval(a.timer_);d.find("i").css({"background-position":"-4px center"});
a.audio=null;}},500);}if(b/(1000*60)>=5){clearInterval(timer);a.playing=null;}b+=500;},500);});$(document).on("click",".csTab",function(){var b=$(this).attr("idval");
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detailByCode.htm"+"?csCode="+b,"客户明细");});$(document).on("click",".setSign",function(){var b=[];var e=$(WeiXinRecordDetail._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(e&&e.length>0){for(var c=0;c<e.length;c++){var d=$(WeiXinRecordDetail._CONS_.GRID).jqGrid("getRowData",e[c]);if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"y");
}});$(document).on("click",".wx-set-star",function(){var d=$(this).attr("value");var c=$(this).attr("createTime");var b="n";if($(this).hasClass("wx-set-star-checked")){b="n";
$(this).removeClass("wx-set-star-checked");}else{b="y";$(this).addClass("wx-set-star-checked");}a._batchSign(d,c,b);});$(document).on("click",".cancelSign",function(){var b=[];
var e=$(WeiXinRecordDetail._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(e&&e.length>0){for(var c=0;c<e.length;c++){var d=$(WeiXinRecordDetail._CONS_.GRID).jqGrid("getRowData",e[c]);
if(d){var f=d["createTime"];b.push(f);}}a._batchSign(e,b,"n");}});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");var c=$(this).attr("url-value");
window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;});$(document).on("change",".select-target",function(){var f=$(this).attr("id-val");
var e=$(this).attr("create-time");var c=$(this).val();var d=[];d.push(f);var b=[];b.push(e);a._updateMsgTarget(d,b,c);});$(document).on("click",".add-follow",function(){var b=friendCode;
a._loadCsData(b);});$(document).on("click","#exportBtn",function(){var d=$("#weiXinRecordSearchForm").serialize();var b="";if(partyType=="group"){b="&belongOgn="+partyId;
}else{b="&employeeId="+partyId;}var c="";if(userName==null||userName==""||typeof userName==undefined){c=WeiXinRecordDetail._CONS_.EXPORT_DATA_URL+"&hasGrant="+ResUtils.canShow("weiXinRecord.button.viewPhone")+"&Q__S__EQ__employee_wei_xin_="+employeeWeixin+"&nickNameHashCode="+code+b+"&"+d;
}else{c=WeiXinRecordDetail._CONS_.EXPORT_DATA_URL+"&hasGrant="+ResUtils.canShow("androidRecord.button.viewPhone")+"&Q__S__EQ__employee_alias_="+employeeAlias+"&userName="+userName+b+"&"+d;
}DialogUtils.confirmWithOptions({title:"是否确认导出微信聊天记录",text:"",confirmButtonText:"确认",yesFunc:function(){window.location.href=c;}});});$(document).on("click",".weiXinRecordSearchToday",function(){var b=new Date();
$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordDetailSearch").trigger("click");});$(document).on("click",".weiXinRecordSearchSeven",function(){var b=new Date();
b=new Date(b.getTime()-6*24*3600*1000);$(".startDate").val(b.currentDate()+" 00:00:00");$(".weiXinRecordDetailSearch").trigger("click");});},_loadCsData:function(b){var a=this;
var c=WeiXinRecordDetail._CONS_.GET_CS_DATA_URL;FormUtils.submit(c,{"csCode":b},function(d){if(d){a._fillFollowRecordTab({partyId:currentUserId,partyAid:currentUserAid,partyName:currentUserName},d.id,b);
$("#addFollowBtn").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,msg.msg);}});},_fillFollowRecordTab:function(b,c,a){var d={csId:c,employeeId:currentUserId,entityId:"",csCode:a,needTable:false,followType:"cs",csType:"self",permissionType:"self"};
this.csFollow.init(d,b);this.csFollow._initEmployeeSuggest();},_batchSign:function(d,a,b){var c=WeiXinRecordDetail._CONS_.BATCH_SIGN_URL;FormUtils.submit(c,{"idArr":d,"createTimeArr":a,"isSign":b},function(e){if(e.success){if("y"==b){DialogUtils.success(msgCode.INFO,"设置为已读成功");
}else{DialogUtils.success(msgCode.INFO,"设置为未读成功");}$(".weiXinRecordDetailSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});
},_updateMsgTarget:function(d,a,c){var b=WeiXinRecordDetail._CONS_.UPDATE_MSG_TARGET_URL;FormUtils.submit(b,{"idArr":d,"createTimeArr":a,"msgTarget":c},function(e){if(e.success){DialogUtils.success(msgCode.INFO,"修改标签成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WeiXinRecordDetail._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
return a;},_initJqgrid:function(d){var b=this;if(d==null||typeof d==undefined){d={};}var a="";if(partyType=="group"){a="&belongOgn="+partyId;}else{a="&employeeId="+partyId;
}d.startDate=startDate;d.endDate=endDate;$(".startDate").val(startDate);$(".endDate").val(endDate);var c="";if(userName==null||userName==""||typeof userName==undefined){c=WeiXinRecordDetail._CONS_.LIST_DATA_URL+"&hasGrant="+ResUtils.canShow("weiXinRecord.button.viewPhone")+"&Q__S__EQ__employee_wei_xin_="+employeeWeixin+"&nickNameHashCode="+code+a;
}else{c=WeiXinRecordDetail._CONS_.LIST_DATA_URL+"&hasGrant="+ResUtils.canShow("androidRecord.button.viewPhone")+"&Q__S__EQ__employee_alias_="+employeeAlias+"&userName="+userName+a;
}$(WeiXinRecordDetail._CONS_.GRID).JTJqgrid({url:c,pager:WeiXinRecordDetail._CONS_.PAGER,postData:d,colNames:["ID","好友昵称","收发","员工工号","内容","敏感","已读","时间","消息标签","好友标签"],colModel:[{name:"id",index:"id_",hidden:true},{name:"nickName",index:"nick_name_",width:120,formatter:function(e,f,g){if(g.friendCode){if(g.friendCode.length>10){return e;
}else{return e+":<a class='csTab' style='font-weight:bold;' idVal='"+g.friendCode+"'>"+g.friendCode+"</a>";}}else{return e;}}},{name:"type",index:"type_",width:50,formatter:function(e){if(e=="in"){return"<span style='color:red'>收</span>";
}else{return"发";}}},{name:"employeeAid",index:"employee_id_",width:80,formatter:function(e,f,g){return e+":"+g.employeeName;}},{name:"content",index:"content_",width:300,formatter:function(e,f,i){var j=i.contentType;
var h="";if(0==j){h=WeiXinUtil.replaceFace(e);}else{if(1==j||4==j){var g=e.split(";");h="<img style='display: inline; height:35px;'' src='"+(g.length>1?ImageUtils.getTrueUrl(g[1]):ImageUtils.getTrueUrl(g[0]))+"'>";
}else{if(2==j){if(i.content&&i.content.indexOf("UploadedFile")!=-1){h=WeiXinUtil.getAudioSpan(i);}else{h=i.content;}}else{if(j==5||j=="5"){h=e.nickname+"请求加好友";
}else{if(j==7||j=="7"){h=WeiXinUtil.getFileMsg(i);}else{if(j==8){h=WeiXinUtil.getVideoMsg(i);}else{if(j==10){h=WeiXinUtil.getNameCard(i);}else{h=e;}}}}}}}return h+WeiXinUtil.getIsRevoke(i);
}},{name:"isSensitive",index:"is_sensitive_",width:50,formatter:function(e){if(e=="y"){return"<span style='color:red'>是</span>";}else{return"否";}}},{name:"isSign",index:"is_sign_",width:50,formatter:function(e,f,g){if(e=="y"){return"<a  value='"+g.id+"' createTime='"+g.createTime+"' class=' wx-set-star wx-set-star-checked'>是</a>";
}else{return"<a  value='"+g.id+"' createTime='"+g.createTime+"' class=' wx-set-star'>否</a>";}}},{name:"createTime",index:"create_time_",width:100},{name:"msgTarget",index:"msg_target_",width:100,sortable:false,formatter:function(e,f,j){var k=new StringBuffer();
k.append("<select class='select-target' id-val='"+j.id+"' create-time='"+j.createTime+"'>");k.append("<option value=''>请选择</button>");var h=b.msgTagDatas;
for(var g=0;g<h.length;g++){k.append("<option value='"+h[g].value+"' "+(e==h[g].value?"selected":"")+" >"+h[g].value+"</button>");}k.append("</select>");
return k.toString();}},{name:"label",index:"label_",width:100}],loadComplete:function(){setTimeout(function(){var f=$(".not_duration");for(var e=0;e<f.length;
e++){var g=$(f[e]).find(".media")[0];var h=parseInt(g.duration);$(f[e]).removeClass("not_duration").find(".audio_length").empty().append(h+"''");$(f[e]).find(".audio_area").css({width:(70+3*h)+"px"});
}},1000);}});}};