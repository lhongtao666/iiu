$(function(){var a=new CsFollowList();a.init();});function CsFollowList(){this.hadInit=false;this.isEdit=false;}CsFollowList._CONS_={EDIT_URL:ctx+"/crm/cs/CsFollow/edit.htm",LIST_DATA_URL:ctx+"/crm/cs/csFollow/listData.htm",GRID:"#csFollowGrid",PAGER:"#csFollowPager",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",LIST_PP_DATA_URL:ctx+"/crm/cs/csEntity/findByNameOrCode.htm",EXPORT_URL:ctx+"/crm/cs/csFollow/export.htm",IMPORT_EXCEL_URL:ctx+"/crm/cs/csFollow/importCsEntityFollow.htm",EXPORT_CSFOLLOW_TEMPLATE:ctx+"/crm/cs/csFollow/exportCsEntityFollowTemplate.htm",};
CsFollowList.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._hideNotGrantBtn();this._bindEventHander();this._initSearchForm();this._initJqgrid(a);
ChannelUtils.getOptions({container:"srcSearch",caption:"全部",emptyOptions:"null"});}this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.csEntity.followCs";
glHelpUtil.init(a);},clear:function(c){var a=this;b();function b(){$(".CsFollowListEdit").find("[name=CsFollowListId]").val("");$("#followType option:first").prop("selected","selected");
$("#satisfy option:first").prop("selected","selected");$(".CsFollowListEdit").find("[name=content]").val("");$("#taskTimeDiv").hide();$("#followEmployeeDiv").hide();
$("input[name=taskTime]").val("").removeClass("validate_input_error");$("input[name=partyShow]").val("").removeClass("validate_input_error");$("input[name=partyId]").val("");
$("input[name=partyName]").val("");}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("CsFollow.button.export")){$(".csFollowExport").hide();}if(!ResUtils.canShow("csFollow.button.importCsEntityFollow")){$(".importCsEntityFollow").hide();
}if(!ResUtils.canShow("csFollow.button.exportCsEntityFollowTemplate")){$(".exportCsEntityFollowTemplate").hide();}},_bindEventHander:function(){var a=this;
$("body").on("click",".deleteCsFollow",function(){var b={csId:$(this).attr("csIdVal"),id:$(this).attr("idVal")};DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/cs/csFollow/delete.htm",b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);
$(".csFollowSearch").trigger("click");}});});});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("#groupId").val(),container:"groupName",positionType:"dept_manager",fn:function(c){$("#groupId").val(c);
a._getEmployeeOption(c,function(f){var e=new StringBuffer();e.append('<select name="Q__S__EQ__create_by_" class="form-control" style="width:100%" >');e.append(f);
e.append("</select>");$("#createBySearch").empty().append($(e.toString())).find("select").select2();var d=new StringBuffer();d.append('<select name="Q__S__EQ__party_id_" class="form-control" style="width:100%" >');
d.append(f);d.append("</select>");$("#followSearch").empty().append($(d.toString())).find("select").select2();});}};GroupUtils.selectGroupTreeBox(b);});
$(document).on("click",".detailFollow",function(){a._disabledInput();a.toDetail($(this).attr("attr-id"));});$(document).on("click",".csFollowSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$(document).on("click",".csFollowExport",function(){var c=$(this).closest("form").serialize();c+="&Q__D__BW__create_time_="+$("#beginCreateTime").val().replaceAll("\\+"," ");
c+="&Q__D__BW__create_time_="+$("#endCreateTime").val().replaceAll("\\+"," ");var b=CsFollowList._CONS_.EXPORT_URL+"?"+c;DialogUtils.success(msgCode.SUCCESS,"正在导出....");
FormUtils.loadData(b,function(d){},function(){},true);});$(document).on("click",".importCsEntityFollow",function(){var b={"importUrl":CsFollowList._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入客户跟进excel数据"};
excelUtil.importExcel(b);});$(document).on("click",".exportCsEntityFollowTemplate",function(){window.location.href=CsFollowList._CONS_.EXPORT_CSFOLLOW_TEMPLATE;
});$(document).on("click",".csTab",function(){var c=$(this).attr("attr-name");var b=$(this).attr("attr-id");if(c.length>5){c="*"+c.substring(c.length-4,c.length);
}JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detail.htm"+"?csId="+b,"客户["+c+"]");});$(document).on("change",".suffix",function(){if($(this).val()=="active"){var b=new Date();
$("#endCreateTime").val(b.currentDate()+" 23:59:59");var c=DateUtils.getCurrentYearPrevDay(1,1);$("#beginCreateTime").val(c+" 00:00:00");}else{if($(this).val()=="yolds"){var c=DateUtils.getCurrentYearPrevDay(2,1);
var d=DateUtils.getCurrentYearPrevDay(1,0);$("#beginCreateTime").val(c+" 00:00:00");$("#endCreateTime").val(d+" 23:59:59");}}});$(document).on("change","#beginCreateTime",function(){var c=DateUtils.getCurrentYearPrevDay(1,0);
var d=DateUtils.getDateDiff($("#endCreateTime").val()+" 00:00:00",$(this).val()+" 00:00:00","day");var b=DateUtils.getDateDiff(c+" 00:00:00",$(this).val()+" 00:00:00","day");
if($(".suffix").val()=="active"){if(b<1){$(this).val(DateUtils.getCurrentYearPrevDay(1,2));DialogUtils.erroe(msgCode.ERROR,"开始时间要在一年内");return;}}else{if(b>=1){$(this).val(DateUtils.getCurrentYearPrevDay(1,0));
}}});$(document).on("change","#endCreateTime",function(){var d=DateUtils.getDateDiff($("#beginCreateTime").val()+" 00:00:00",$(this).val()+" 00:00:00","day");
var c=DateUtils.getCurrentYearPrevDay(1,0);var b=DateUtils.getDateDiff(c+" 00:00:00",$(this).val()+" 00:00:00","day");if($(".suffix").val()=="active"){if(b<1){$(this).val(DateUtils.getCurrentYearPrevDay(1,2));
}}else{if(b>=1){$(this).val(c);}}});},reloadJqgrid:function(a){a+="&Q__D__BW__create_time_="+$("#beginCreateTime").val().replaceAll("\\+"," ");a+="&Q__D__BW__create_time_="+$("#endCreateTime").val().replaceAll("\\+"," ");
JTJqgridUtils.reloadJqgrid(CsFollowList._CONS_.GRID,a);},_initJqgrid:function(){var d={Q__D__BW__create_time_:$("#beginCreateTime").val().replaceAll("\\+"," ")};
var a=this;var c=["客户","渠道来源","跟进标签","内容","安排人","跟进人","创建时间","跟进时间","状态"];var b=[{name:"csCode",index:"cs_code_",width:120,formatter:function(e,g,h){var f=h.csCode+":"+h.csName;
if($(window).width()<1024){f=h.csCode+"<br>"+h.csName;}return"<a href='#' class='csTab' attr-name='"+h.csName+"' attr-id='"+h.csId+"'>"+f+"</a>";}},{name:"srcs",index:"srcs",width:120},{name:"type",index:"type_",width:100},{name:"content",index:"content_",width:300,},{name:"createBy",index:"create_by_",width:120,formatter:function(e,f,g){if($(window).width()<1024){return g.createAid+"<br>"+g.createName;
}else{return g.createAid+":"+g.createName;}}},{name:"partyId",index:"party_id_",width:120,formatter:function(e,f,g){if($(window).width()<1024){return g.employeeAid+"<br>"+g.partyName;
}else{return g.employeeAid+":"+g.partyName;}}},{name:"createTime",index:"create_time_",width:100,formatter:function(e){return DateUtils.miniTime(e);}},{name:"taskTime",index:"task_time_",width:100,formatter:function(e){return DateUtils.miniTime(e);
}},{name:"status",index:"status_",width:80,formatter:function(f,g,h){var e=h.status;if("done"==e){return"完成";}else{if("new"==e||"awaiting"==e){return"<p style='color:red;'>未完成</p>";
}else{if("expired"==e){return"<p style='color:red;'>过期</p>";}else{return"";}}}}}];if(ResUtils.canShow("csFollow.button.delete")){c.push("操作");b.push({name:"id",index:"id_",sortable:false,width:80,formatter:function(e,f,g){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+g.csId+"' idVal='"+e+"'style='color: red; cursor: pointer;'></i>";
}});}$(CsFollowList._CONS_.GRID).JTJqgrid({url:CsFollowList._CONS_.LIST_DATA_URL,pager:CsFollowList._CONS_.PAGER,postData:d,multiselect:false,colNames:c,colModel:b});
},_initSearchForm:function(){this._initDate();CateUtils.getOptions({typeKey:"system",pKey:"CsFollowType",container:"typeSearch"});this._getEmployeeOption("",function(c){var b=new StringBuffer();
b.append('<select name="Q__S__EQ__create_by_" class="form-control" style="width:100%" >');b.append(c);b.append("</select>");$("#createBySearch").empty().append($(b.toString())).find("select").select2();
var a=new StringBuffer();a.append('<select name="Q__S__EQ__party_id_" class="form-control" style="width:100%" >');a.append(c);a.append("</select>");$("#followSearch").empty().append($(a.toString())).find("select").select2();
});},_getEmployeeOption:function(b,c){var a=CsFollowList._CONS_.EMPLOYEE_LIST_URL+"?groupId="+b+"&type=dept_manager";FormUtils.loadData(a,function(e){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");if(e&&e.length>0){for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].id+"'>"+e[d].aid+":"+e[d].name+"</option>");
}}c(f.toString());},null,true);},_initDate:function(){var a=new Date();$("#beginCreateTime").val(a.currentDate()+" 00:00:00");$("#endCreateTime").val(a.currentDate()+" 23:59:59");
},};