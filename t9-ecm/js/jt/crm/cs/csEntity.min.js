$(function(){var a=new CsEntity();a.init();});function CsEntity(){this.isFormDataChange=false;this.hasInitJqgrid=false;this.titleCates=null;this.csEmployee=new CsEmployee(this);
this.rfmtSearch=new RfmtSearch();this.selectedJqgrid=new Array();this.toTop=new Array();if(window.localStorage.getItem("simpleShowDesc")==null){this.simpleShowDesc=false;
}else{this.simpleShowDesc=window.localStorage.getItem("simpleShowDesc");}this.addressServiceSearch=new AddressService("addrContainerSearch");if(type=="self"){var a=["首次交易状态跟进时间","部门","员工","员工微信"];
if(!isWineIndustyPage){a.push("用途");a.push("口感");}this.formFrontConfig=new FormConfig({"formId":"csEntitySearchForm",title:"我的客户查询配置",isHidden:true,forceParam:a,"endLess":[],modular:"csEntitySearchList"});
}else{if(type=="mysub"){var a=["首次交易状态跟进时间"];if(!isWineIndustyPage){a.push("用途");a.push("口感");}this.formFrontConfig=new FormConfig({"formId":"csEntitySearchForm",title:"下属客户查询配置",isHidden:true,forceParam:a,"endLess":[],modular:"csEntitySearchSubList"});
}}this.sortColumn="";this.sortorder="";}CsEntity._CONS_={LIST_DATA_URL:ctx+"/crm/cs/csEntity/listData.htm",ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",POINT_ORDER_PLACE_URL:ctx+"/ec/salesorder/soEntity/place/pointOrder.htm",ORDER_LIST_URL:ctx+"/ec/salesorder/soEntity/list.htm",ORG_LIST_URL:ctx+"/gl/ou/group/getOrganizations.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",IMPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/importExcel.htm",IMPORT_ORDER_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importOrderExcel.htm",EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/exportExcel.htm",SYNC_EXPORT_EXCEL_URL:ctx+"/crm/cs/csEntity/syncExportExcel.htm",ORDER_AFTER_LIST_URL:ctx+"/ec/salesorder/soEntity/saleafter/list.htm",BATCH_DELETE_URL:ctx+"/crm/cs/csEntity/batchDeleteLogic.htm",BATCH_TOSEA_URL:ctx+"/crm/cs/csEntity/toSea.htm",BATCH_CHANGE_CAN_PLACE_SO_URL:ctx+"/crm/cs/csEntity/batchPermitOrForbitSo.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findByTypeAndEmployee.htm",GEN_SO_EXCEL_URL:ctx+"/crm/cs/csEntity/genSoExcel.htm",NEED_RETURN_VISIT:ctx+"/crm/cs/csEntity/needReturnVisit.htm",BATCH_SETTOP_URL:ctx+"/crm/cs/csEntity/setTop.htm",GRID:"#csEntityGrid",PAGER:"#csEntityPager",};
CsEntity.prototype={init:function(){this._bindEventHander();this._initJqgrid();this.csEmployee.init();this._initSearch();this._buildEmployeeOption("");
this.addressServiceSearch.init({isSelect:"y",isNotRequired:true},function(){});this._locateToGlHelp();this._prodSearch();this._listShipName();this._initEmployeeWeixin();
this.formFrontConfig.init();this._bulidCsTag();$(".selectpicker").selectpicker({language:"zh_CN",dropupAuto:false,size:10});},_bulidCsTag:function(){var a=this;
var b=a._getContainer("csTagSearch");if(!b){return false;}FormUtils.loadData(ctx+"/gl/tag/tag/loadAllTag.htm?type=cs",function(c){var e=c.cateOptList;if(e&&e.length>0){var f=new StringBuffer();
for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].value+"'>"+e[d].name+"</option>");}b.empty().append(f.toString());}if(b&&b.is(".selectpicker")){b.selectpicker("refresh");
}});},_listShipName:function(){FormUtils.loadData(ctx+"/ec/ship/shipCompany/allActiveCompany.htm",function(b){if(b&&b.length>0){var c=new StringBuffer();
c.append("<option value=''>请选择</option>");for(var a=0;a<b.length;a++){c.append("<option value='"+b[a].id+"'>"+b[a].name+"</option>");}$("#firstShipName").empty().append(c.toString()).select2().trigger("change");
}});},_prodSearch:function(i){$(".searchProd").bsSuggest("destroy");var j=this;var b=$(".searchProd").width()+"px";var c="entity";var h="n";var d="n";var g="prodEntity-csEntity";
var e=window.sessionStorage.getItem(g);if(e){var f=JSON.parse(e);j._prodSearchSuggest(f);}else{var a=ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+h+"&storeId="+"&limitProdCate="+d+"&keyword=";
FormUtils.loadData(a,function(k){window.sessionStorage.setItem(g,JSON.stringify(k));j._prodSearchSuggest(k);});}},_prodSearchSuggest:function(a){var b=this;
var e=b._getContainer("searchProd");if(!e){return false;}var d=a.value;if(d&&d.length>0){var f=new StringBuffer();for(var c=0;c<d.length;c++){f.append("<option value='"+d[c].prodName+"'>"+d[c].prodName+"</option>");
}e.empty().append(f.toString());}if(e&&e.is(".selectpicker")){e.selectpicker("refresh");}},_locateToGlHelp:function(){if(type=="self"){var a="glHelp.csEntity.myCs";
}if(type=="mysub"){var a="glHelp.csEntity.subCs";}glHelpUtil.init(a);},_initSearch:function(){CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interestSearch",emptyOption:"noInterests"},{typeKey:"system",pKey:"CsBizTypes",container:"bizTypeSearch",emptyOption:"noBizTypes"},{typeKey:"system",pKey:"CsFollowType",container:"followSearch"},{typeKey:"system",pKey:"CsGenderType",container:"genderSearch"},{typeKey:"system",pKey:"CsEntryType",container:"entrySearch"},{typeKey:"system",pKey:"income",container:"incomeSearch"},{typeKey:"system",pKey:"taste",container:"tasteSearch"},{typeKey:"system",pKey:"winePurpose",container:"purposeeSearch"}]);
this._initInterestsSelect();this._initBizTypeSelect();this._buildLevelOption();this._buildEavSearchCondition();ChannelUtils.getOptions({container:"srcSearch",caption:"全部",emptyOptions:"null"});
if("self"==type){$(".groupSelect").hide();}},_initInterestsSelect:function(){var a=this;a.isInitInterests=true;a.interestsTimer=setInterval(function(){if(a.isInitInterests){$("#interestSearch").selectpicker("refresh");
$("#interestSearch").selectpicker("val",[]);clearInterval(a.interestsTimer);a.interestsTimer=null;}},250);},_initBizTypeSelect:function(){var a=this;a.isInitBizType=true;
a.bizTypeTimer=setInterval(function(){if(a.isInitBizType){$("#bizTypeSearch").selectpicker("refresh");$("#bizTypeSearch").selectpicker("val",[]);clearInterval(a.bizTypeTimer);
a.bizTypeTimer=null;}},250);},_initEmployeeWeixin:function(c,b){var a=this;FormUtils.loadData(CsEntity._CONS_.FIND_EMPLOYEE_WEIXIN+"?employeeId=&groupId=&type=android",function(e){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].userName+"'>"+e[d].alias+"</option>");}$("#employee-wx-select").empty().append(f.toString());
$("#employee-wx-select").select2();});},_hideNotGrantBtn:function(){if(type=="self"){if(!ResUtils.canShow("csEntity.button.returnVisit")){$(".isReturnVisit").hide();
}if(!ResUtils.canShow("csEntity.button.increateYouZanPoint")){$(".batchIncreateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.permitPlaceSo")){$(".batchPermitPlaceSo").hide();
}if(!ResUtils.canShow("csEntity.button.batchForbitPlaceSo")){$(".batchForbitPlaceSo").hide();}if(!ResUtils.canShow("csEntity.button.add")){$(".csEntityAdd").hide();
}if(!ResUtils.canShow("csEntity.button.addWx")){$(".csEntityWxAdd").hide();}if(!ResUtils.canShow("csEntity.button.edit")){$(".csEntityEdit").hide();}if(!ResUtils.canShow("csEntity.button.assignCs")){$(".csEntityEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.soAdd")){$(".csEntitySoAdd").hide();}if(!ResUtils.canShow("csEntity.button.soPointAdd")){$(".csEntitySoPointAdd").hide();
}if(!ResUtils.canShow("csEntity.button.batchSms")){$(".csEntityBatchSendSms").hide();}if(!ResUtils.canShow("csEntity.button.aliTemplateSms")){$(".aliTemplateSms").hide();
}if(!ResUtils.canShow("csEntity.button.batchUpdate")){$(".csEntityBatchUpdate").hide();}if(!ResUtils.canShow("csEntity.button.batchCreateForSub")){$(".csEntityBatchCreateForSub").hide();
}if(!ResUtils.canShow("csEntity.button.soList")){$(".csEntitySoList").hide();}if(!ResUtils.canShow("csEntity.button.saleAfter")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcel")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importOrderExcel")){$(".importOrderExcel").hide();
}if(!ResUtils.canShow("csEntity.button.importExcel")){$(".importExcel").hide();}if(!ResUtils.canShow("csEntity.button.genExcel")){$(".toGenExcel").hide();
}if(!ResUtils.canShow("csEntity.button.genSoExcel")){$(".genSoExcel").hide();}if(!ResUtils.canShow("csEntity.button.delete")){$(".batchDelete").hide();
}if(!ResUtils.canShow("csEntity.button.toSea")){$(".csEntityToSea").hide();}if(!ResUtils.canShow("csEntity.button.setTop")){$(".csEntitySetTop").hide();
$(".csEntityCancelTop").hide();}if(!ResUtils.canShow("csEntity.limit.wineIndustry")){$(".wineIndustryDiv").hide();$(".wineIndustryDiv").hide();}}else{if(type=="mysub"){if(!ResUtils.canShow("csEntity.button.subReturnVisit")){$(".isReturnVisit").hide();
}if(!ResUtils.canShow("csEntity.button.increateYouZanPointSub")){$(".batchIncreateYouZanPoint").remove();}if(!ResUtils.canShow("csEntity.button.permitPlaceSo")){$(".batchPermitPlaceSo").hide();
}if(!ResUtils.canShow("csEntity.button.batchForbitPlaceSo")){$(".batchForbitPlaceSo").hide();}if(!ResUtils.canShow("csEntity.button.addSub")){$(".csEntityAdd").hide();
}if(!ResUtils.canShow("csEntity.button.wxAddSub")){$(".csEntityWxAdd").hide();}if(!ResUtils.canShow("csEntity.button.editSub")){$(".csEntityEdit").hide();
}if(!ResUtils.canShow("csEntity.button.assignCsSub")){$(".csEntityEmployee").hide();}if(!ResUtils.canShow("csEntity.button.soAddSub")){$(".csEntitySoAdd").hide();
}if(!ResUtils.canShow("csEntity.button.soPointAddSub")){$(".csEntitySoPointAdd").hide();}if(!ResUtils.canShow("csEntity.button.soListSub")){$(".csEntitySoList").hide();
}if(!ResUtils.canShow("csEntity.button.batchSmsSub")){$(".csEntityBatchSendSms").hide();}if(!ResUtils.canShow("csEntity.button.batchUpdateSub")){$(".csEntityBatchUpdate").hide();
}if(!ResUtils.canShow("csEntity.button.batchCreateForSubSub")){$(".csEntityBatchCreateForSub").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSub")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcelSub")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importExcelSub")){$(".importExcel").hide();
}if(!ResUtils.canShow("csEntity.button.importOrderExcelSub")){$(".importOrderExcel").hide();}if(!ResUtils.canShow("csEntity.button.genExcelSub")){$(".toGenExcel").hide();
}if(!ResUtils.canShow("csEntity.button.genSoExcelSub")){$(".genSoExcel").hide();}if(!ResUtils.canShow("csEntity.button.deleteSub")){$(".batchDelete").hide();
}if(!ResUtils.canShow("csEntity.button.toSeaSub")){$(".csEntityToSea").hide();}if(!ResUtils.canShow("csEntity.button.setTopSub")){$(".csEntitySetTop").hide();
$(".csEntityCancelTop").hide();}if(!ResUtils.canShow("csEntity.limit.wineIndustry")){$(".wineIndustryDiv").hide();$(".wineIndustryDiv").hide();}}else{if(type=="search"){$(".csEntitySoAdd").hide();
$(".csEntitySoPointAdd").hide();if(!ResUtils.canShow("csEntity.button.addSearch")){$(".csEntityAdd").hide();}if(!ResUtils.canShow("csEntity.button.wxAddSearch")){$(".csEntityWxAdd").hide();
}if(!ResUtils.canShow("csEntity.button.editSearch")){$(".csEntityEdit").hide();}if(!ResUtils.canShow("csEntity.button.assignCsSearch")){$(".csEntityEmployee").hide();
}if(!ResUtils.canShow("csEntity.button.soListSearch")){$(".csEntitySoList").hide();}if(!ResUtils.canShow("csEntity.button.saleAfterSearch")){$(".csEntitySoAfterList").hide();
}if(!ResUtils.canShow("csEntity.button.exportExcelSearch")){$(".toExportExcel").hide();}if(!ResUtils.canShow("csEntity.button.importExcelSearch")){$(".importExcel").hide();
}}}}},_bindEventHander:function(){var a=this;$(".list_wrapper").on("click",".csEntitySearch",function(){a.rfmtSearch.dealTip();var b=CsEntityUtils.getSearchParams(a.rfmtSearch);
a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$("body").on("click",".csEntitySetTop",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户置顶吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchSetTop(b,"y");}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");
}});$("body").on("click",".csEntityCancelTop",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户取消置顶吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchSetTop(b,"n");
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");}});$("body").on("click",".batchIncreateYouZanPoint",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要同步的客户");return;}FormUtils.loadData(ctx+"/crm/cs/csEntity/increateYouzanPoint.htm?ids="+b,function(c){});
});$(".inPhone").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum=13533435687&inNum=18300123456","客户信息");});$("#belongOgnName").on("click",function(){var b={isMultiple:1,selectedGroupId:$("input[name='belongOgn']").val(),container:"belongOgnName",nolimit:true,positionType:type=="search"?"all":"dept_manager,cs_search",fn:function(c){$("input[name=belongOgn]").val(c);
a._buildEmployeeOption(c);}};GroupUtils.selectGroupTreeBox(b);});$("body").on("click",".csEntityAdd",function(){a._add(0,"新增客户");});$("body").on("click",".csEntityWxAdd",function(){a._add(1,"新增微信客户");
});$("body").on("click",".csEntityEdit",function(){ConfigUtils.findByKey("csEntity.removeHeight",function(c){if(c.success){$("#csEntityForm .heightWeightDiv").hide();
}});var b=$(this).attr("idVal");if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要更新的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时编辑多条记录");
return;}b=a.selectedJqgrid[0];}a._edit(b);});$("body").on("click",".csEntityEditTmp",function(){var b=$(this).attr("attr-id");a._edit(b);});$("body").on("click",".csEntitySoAdd",function(){var b=$(this);
ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placeGeneralOrderMethod(b,a);return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placeGeneralOrderMethod(b,a);
return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var f=DateUtils.timeRangeJudge(c,d);if(!f){a._placeGeneralOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});
});$("body").on("click",".csEntitySoPointAdd",function(){var b=$(this);ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(h){if(h.msg==null){a._placePointsOrderMethod(b,a);
return;}else{if(h.msg!=null&&h.msg.trim()==""){a._placePointsOrderMethod(b,a);return;}var g=h.msg;var e=g.split("-");if(e.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return;}var c=e[0].trim();var d=e[1].trim();if(c.length!=5||d.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");return;}var f=DateUtils.timeRangeJudge(c,d);
if(!f){a._placePointsOrderMethod(b,a);return;}else{DialogUtils.error("提示","该时段("+h.msg+")禁止下单！");return;}}});});$("body").on("click",".csEntitySoList",function(){var b=$(this).attr("idVal");
if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要查看客户的记录");return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多条记录");
return;}b=a.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",b);var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);
}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+d+"]订单");});$("body").on("click",".csEntitySoListTmp",function(){var b=$("#csEntityForm").find("[name=id]").val();
var c=$("#csEntityForm").find("[name=name]").val();if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_LIST_URL+"?csId="+b,"客户["+c+"]订单");
});$(document).on("click",".csEntityBatchUpdate",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b&&b.length>0){a._csEntityBatchUpdate(b);
}else{a._csEntityBatchUpdate(b);}});$(document).on("click",".isReturnVisit",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){a._csNeedReturnVisit(b);}else{DialogUtils.error("提示","请选择需要回访的客户！");}});$(document).on("click",".csEntityBatchCreateForSub",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){var d={csIds:b.join(","),};d.callbackFn=function(){DialogUtils.success("成功","操作成功");$(CsEntity._CONS_.GRID).jqGrid("resetSelection");
};var c=new CreateForSub();c.init(d);}else{DialogUtils.error(msgCode.ERROR,"请选择要创建从客户的条目");}});$(document).on("click",".csEntityBatchCall",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){a._csEntityBatchCall(b);}});$("body").on("click",".csEntitySoAfterList",function(){var b=$(this).attr("idVal");if(!b){if(!a.selectedJqgrid||a.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要退换货的客户");
return;}if(a.selectedJqgrid.length>1){DialogUtils.error("错误","不能同时选择多个客户");return;}b=a.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",b);
var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_AFTER_LIST_URL+"?csId="+b,"客户["+d+"]退换货订单");
});$("#csEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".csEntitySearch").eq(0).trigger("click");}});$("button.clearCsEntitySearchFormBtn").on("click",function(){FormUtils.clear("csEntitySearchForm");
if(a._getContainer("searchProd")){a._getContainer("searchProd").selectpicker("refresh");}if(a._getContainer("srcSearch")){a._getContainer("srcSearch").selectpicker("refresh");
}if(a._getContainer("interestSearch")){a._getContainer("interestSearch").selectpicker("refresh");}if(a._getContainer("bizTypeSearch")){a._getContainer("bizTypeSearch").selectpicker("refresh");
}if(a._getContainer("csTagSearch")){a._getContainer("csTagSearch").selectpicker("refresh");}if(a._getContainer("eavSearch")){a._getContainer("eavSearch").selectpicker("refresh");
}});$(document).on("click",".newSearch",function(){var b="turnNew=y";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".notFollowSearch",function(){var b=DateUtils.getBeforeDate(7);
var c="hightFollowTime="+b+"&includeNotFollow=true";a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$(document).on("click",".birthdaySearch",function(){var b="csCare=birthday";
a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".buyWeekSearch",function(){var b="csCare=buyWeek";a.selectedJqgrid=new Array();
a.reloadJqgrid(b);});$(document).on("click",".buyMonthSearch",function(){var b="csCare=buyMonth";a.selectedJqgrid=new Array();a.reloadJqgrid(b);});$(document).on("click",".toDayRegisterPlace",function(){var b=new Date();
var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";c+="&toDayRegisterPlace=toDayRegisterPlace";a.selectedJqgrid=new Array();
a.reloadJqgrid(c);});$(document).on("click",".toDayRegister",function(){var b=new Date();var c="lowRegisterTime="+b.currentDate()+" 00:00:00";c+="&hightRegisterTime="+b.currentDate()+" 23:59:59";
a.selectedJqgrid=new Array();a.reloadJqgrid(c);});$("#seniorSearch").on("click",function(){if($(this).text().indexOf("展开")!=-1){$("#seniorSearchDiv").slideDown("fast",function(){});
$(this).empty().append('收起<span class="fa fa-sort-up"></span>');}else{$(this).empty().append('展开<span class="fa fa-sort-down"></span>');$("#seniorSearchDiv").slideUp("fast");
}a.rfmtSearch.dealTip();});$("#seniorSearch2").on("click",function(){$("#seniorSearch").empty().append('展开<span class="fa fa-sort-down"></span>');$("#seniorSearchDiv").slideUp("fast");
a.rfmtSearch.dealTip();});$(document).on("change",".numberInput",function(){if($(this).val()>=0){}else{$(this).val(0);}});$("body").on("click",".toGenExcel",function(){excelUtil.toGenExcel("csEntity","生成客户excel模板","客户模板");
});$("body").on("click",".genSoExcel",function(){window.location.href=CsEntity._CONS_.GEN_SO_EXCEL_URL;});$("body").on("click",".importExcel",function(){var b={"importUrl":CsEntity._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入客户excel数据"};
if(ResUtils.canShow("csEntity.sub.batchCreate")){b.isCreateSub="isCreateSub";}excelUtil.importExcel(b);});$("body").on("click",".importOrderExcel",function(){var b={"importUrl":CsEntity._CONS_.IMPORT_ORDER_EXCEL_URL,"tabTitle":"导入订单excel数据"};
excelUtil.importExcel(b);});$(document).on("change"," .csDesc",function(){var b=$(this)[0].checked;if(b){a.simpleShowDesc=true;window.localStorage.setItem("simpleShowDesc",true);
$(this).closest(".ui-jqgrid").find(".tooltip-desc").show();$(this).closest(".ui-jqgrid").find(".desc-detail").hide();}else{a.simpleShowDesc=false;window.localStorage.setItem("simpleShowDesc",false);
$(this).closest(".ui-jqgrid").find(".tooltip-desc").hide();$(this).closest(".ui-jqgrid").find(".desc-detail").show();}});$("body").on("click",".toExportExcel",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
a._toExportExcel(b);});$("body").on("click",".exportExcel",function(){$(".exportExcel").attr("disabled",true);a._exportExcel();});$("body").on("click","#allCheck",function(){var b=true;
if(!$(this).is(":checked")){b=false;}$("#columnContainer").find(".columnCheckBox").each(function(){$(this).prop("checked",b);});});$("body").on("click",".prevBtn",function(){a._toList();
});$("body").on("click",".batchPermitPlaceSo",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认允许选中的客户下单吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchPermitSo(b);
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");}});$("body").on("click",".batchForbitPlaceSo",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认禁止选中的客户下单吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchForbitSo(b);}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");
}});$("body").on("click",".batchDelete",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b){DialogUtils.confirmWithOptions({title:"确认要删除选中的客户资料吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchDelete(b);
}});}else{DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");}});$("body").on("click",".csEntityToSea",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b){DialogUtils.confirmWithOptions({title:"确认要将选中的客户资料移入公海吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._batchToSea(b);}});}else{DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");
}});$("body").on("click",".csEntityBatchSendSms",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b&&b.length>0){var d=new SendMessage();
var c={csIds:b};d.openBatchSendMessageView(c);}else{DialogUtils.error(msgCode.ERROR,"请选择要发短信的客户");}});$("body").on("click",".aliTemplateSms",function(){var b=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>0){var d=new SendMessage();var c={csIds:b};d.openAilTemplateMessageView(c);}else{DialogUtils.error(msgCode.ERROR,"请选择要发短信的客户");}});$("body").on("click",".aliTemplateModalSend",function(){var c=$("#aliTemplateModalCsIds").val();
var b=$(".aliTemplateModalSelect").val();FormUtils.submit(SendMessage._CONS_.SEND_ALI_TEMPLATE_URL,{"csIds":c,"type":b},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
}else{DialogUtils.error(msgCode.ERROR,d.msg);}$("#aliTemplateModal").modal("hide");},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});});$("body").on("change",".aliTemplateModalSelect",function(){var b=$(".aliTemplateModalSelect").find("option:selected").attr("content");
$(".aliTemplateModalContent").empty().append(b);});},_csNeedReturnVisit:function(a){DialogUtils.confirmWithOptions({title:"确定当前选中客户需要回访？",text:"",confirmButtonText:"确定",yesFunc:function(){FormUtils.submit(CsEntity._CONS_.NEED_RETURN_VISIT,{csId:a},function(b){if(b){DialogUtils.success(msgCode.INFO,"操作成功");
}else{DialogUtils.error(msgCode.ERROR,"操作失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});$("#csEntitySearchForm").find(".csEntitySearch").trigger("click");
}});},_csEntityBatchUpdate:function(c){var a=this;var e=CsEntityUtils.getSearchParams(a.rfmtSearch);e=CsEntityUtils.getSearchParamToObj(e);e.type=type;
var d=0;if(c&&c.length>0){d=c.length;e.ids=c;}else{d=$(CsEntity._CONS_.GRID).jqGrid("getGridParam","records");}var b=new CsEntityBatchUpdate();b.init({count:d,searchParam:e});
},_csEntityBatchCall:function(c){var a=this;var e={};var d=0;if(c&&c.length>0){d=c.length;}e.count=d;e.csIds=c;var b=new CsEntityBatchCall();b.init(e);
},reloadJqgrid:function(a){window.localStorage.setItem("csentity_need_clear_selectedJqgrid","true");JTJqgridUtils.reloadJqgrid(CsEntity._CONS_.GRID,a);
},_initJqgrid:function(h){var a=this;var c=CsEntity._CONS_.LIST_DATA_URL+"?1=1&Q__S__EQ__entity.is_sea_=n";if("newMonth"==filterType){var b=DateUtils.getCurrentMonthFirst();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("turnNew"==filterType){$("#turnNewSearch").val("y");
c=c+"&turnNew=y";}else{if("turnNew_org"==filterType){$("#turnNewSearch").val("y");c=c+"&turnNew=y";type="mysub";}else{if("allCs_today"==filterType){var b=new Date();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("allCs_month"==filterType){var b=DateUtils.getCurrentMonthFirst();
$("[name=lowRegisterTime]").val(DateUtils.format(b,"yyyy-MM-dd")).attr("disabled",true);c=c+"&lowRegisterTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("allCs_repeatBuy"==filterType){var b=DateUtils.getCurrentMonthFirst();
c=c+"&soPlaceTime="+DateUtils.format(b,"yyyy-MM-dd");}else{if("byPhone"==filterType){c=c+"&phoneNums="+phoneNums;}}}}}}}c=c+"&type="+type+"&currentPositionId="+currentPositionId;
if(turnNew){c+="&turnNew="+turnNew;}if(csCare){c+="&csCare="+csCare;}if(belongEmployee){c+="&belongEmployee="+belongEmployee;}if(Q__D__EQ__create_time_){c+="&Q__D__BW__entity.create_time_="+Q__D__EQ__create_time_;
}if(csType&&csType=="newCs"){c+="&Q__N__EQ__entity.so_complete_=1";}else{if(csType&&csType=="oldCs"){c+="&Q__N__GT__entity.so_complete_=1";}}var f=false;
if("self"==type){f=true;}var e=false;if("finance"==versionType){e=true;}var d=$(window).width();var g=true;ConfigUtils.findByKey("csEntity.limit.wineIndustry",function(j){if(j.success){g=false;
$(".wineIndustryDiv").show();}var i=true;if(ResUtils.canShow("csEntity.button.csListShowSrc")){i=false;}ConfigUtils.findByKey("csEntity.hiddenConsumeField",function(l){var k=false;
if(l.success){k=true;}if(isSelectCsEntity){c+="&isSelectCsEntity="+isSelectCsEntity;}ConfigUtils.findByKey("csEntity.createTimeToMonth",function(n){var m={RScore:RScore,FScore:FScore};
if(n.success&&"mysub"==type){$("input[name=lowRegisterTime]").val(DateUtils.getBeforeMonth(1)+" 00:00:00");m={RScore:RScore,FScore:FScore,lowRegisterTime:DateUtils.getBeforeMonth(1)+" 00:00:00"};
}ConfigUtils.findByKey("csEntity.isOpenTop",function(q){var p=false;if(q.success){p=true;}var o=[{modelName:"code",name:"code",index:"entity.code_",width:100,isBase:"true",formatter:function(r,s,u){if(u.isTop=="y"){a.toTop.push(u.id);
}if(u.footData){$(".ui-jqgrid-title").css({"width":"100%"});var t="<div style='float:left'>"+u.code+"</div>"+"<div style='float:right;position:relative;'>"+"</div>";
$(CsEntity._CONS_.GRID).jqGrid("setCaption",t);return u.code;}else{var v=new StringBuffer();v.append('<div class="nameClass">');if(u.turnNew=="y"){v.append("<span style='color:red'>新</span>");
}if(u.isSub=="y"){v.append("<span style='color:red;white-space:pre'> 从</span>");}v.append(u.code);v.append("</div>");return v.toString();}}},{modelName:"_name",name:"_name",index:"entity._name_",width:100,formatter:function(r,s,t){return"<a class='csEntityEditTmp' attr-id='"+t.id+"'>"+t.name+"</a>";
}},{modelName:"name",name:"name",index:"entity.name_",hidden:true},{modelName:"oper",name:"oper",index:"entity.oper_",width:80,isBase:"true",formatter:function(r,s,t){if(t.footData){return t.code;
}else{var u=new StringBuffer();u.append("<button title='下订单' class='btn btn-sm btn-primary csEntitySoAdd' attr-name='"+t.name+"' idVal='"+t.id+"'>订</button>&nbsp;");
u.append("<button title='转员工' class='btn btn-sm btn-primary csEntityEmployee' idVal='"+t.id+"'>转</button>&nbsp;");return u.toString();}}},{name:"pureCode",hidden:true,formatter:function(r,s,t){return t.code;
}},{modelName:"isOrderSo",name:"isOrderSo",width:50,index:"entity.is_order_so_",formatter:function(r,s,u){var t=u.isOrderSo;if(t=="y"){return"是";}else{return"<font style='color:red;'>否</font>";
}}},{modelName:"gender",name:"gender",index:"entity.gender_",width:35,isBase:"true"},{modelName:"care",name:"care",index:"care",isBase:"true",width:50,sortable:false,formatter:function(r,z,s){var u=new StringBuffer();
var x=new Date();var v=DateUtils.format(x,"yyyy-MM-dd")+" 00:00:00";var w="";if(s.birthday.length<9||s.birthday.length==5){w=x.getFullYear()+s.birthday+" 00:00:00";
}else{w=x.getFullYear()+"-"+s.birthday.substring(5,s.birthday.length)+" 00:00:00";}var t=DateUtils.getDateDiff(v,w,"day");if(t<=7&&t>=0){var y=ctx+"/img/jt/cake2.png";
if(t==0){u.append("<div title='今天生日' style='background-image:url(/t9-ecm/img/jt/cake2.png);width:20px; height:20px;margin:0 auto;'></div>");}else{u.append("<div title='"+w.substring(5,10)+"生日, 还差"+t+"天' style='background-image:url(/t9-ecm/img/jt/cake2.png);width:20px; height:20px;margin:0 auto;'></div>");
}}if(s.lastCompleteTime){if(DateUtils.getDateDiff(s.lastCompleteTime,v,"day")>7&&DateUtils.getDateDiff(s.lastCompleteTime,v,"day")<28){u.append("<div title='购买满7天' style='background-image:url(/t9-ecm/img/jt/7.png);width:20px; height:20px;margin:0 auto;'></div>");
}if(DateUtils.getDateDiff(s.lastCompleteTime,v,"day")>=28){u.append("<div title='购买满28天' style='background-image:url(/t9-ecm/img/jt/28.png);width:20px; height:20px;margin:0 auto;'></div>");
}}return u.toString();}},{modelName:"bizType",name:"bizType",index:"entity.biz_type_",width:70,sortable:true,isBase:"true",},{modelName:versionType&&versionType=="finance"?"isTurnover":"hasDeal",name:versionType&&versionType=="finance"?"isTurnover":"hasDeal",index:versionType&&versionType=="finance"?"entity.is_turnover_":"entity.so_total_",width:35,sortable:true,isBase:"true",formatter:function(r,s,u){var t="<div  style='background-image:url(/t9-ecm/img/jt/queren.png);width:20px; height:20px;margin:0 auto;'></div>";
if(versionType&&versionType=="finance"){if(r&&r=="y"){return t;}else{return"";}}else{if(u.soTotal&&u.soTotal>0){return t;}else{return"";}}}},{modelName:"soComplete",name:"soComplete",index:"entity.so_complete_",width:35,isBase:"true"},{modelName:"soTotal",name:"soTotal",index:"entity.so_total_",width:70,hidden:k,isBase:"true",formatter:function(r,s,t){return t.soTotal;
}},{modelName:"jdPoint",name:"jdPoint",index:"entity.jd_point_",hidden:g,width:60,sortable:true},{modelName:"youzanPoint",name:"youzanPoint",index:"entity.youzan_point_",hidden:g,width:60,sortable:true},{modelName:"interests",name:"interests",index:"entity.interests_",width:80,sortable:true},{modelName:"productName",name:"productName",index:"entity.product_name_",width:80,sortable:true,isBase:"true"},{modelName:"srcNames",name:"srcNames",index:"entity.srcs_",width:80,sortable:true,hidden:i,isBase:"true"},{modelName:"relatedWeixin",name:"relatedWeixin",index:"entity.related_weixin_",width:80,sortable:true,formatter:function(r,s,u){var t="<div  style='background-image:url(/t9-ecm/img/jt/queren.png);width:20px; height:20px;margin:0 auto;'></div>";
if(r=="y"){return t;}else{return"";}}},{modelName:"prName",name:"prName",index:"entity.pr_name_",width:120,sortable:true,formatter:function(r,t,u){var v=new StringBuffer();
if(u.prName){v.append(u.prName);}if(u.ciName){v.append(",").append(u.ciName);}var s=v.toString();if(s){s=s.replace("省","");s=s.replace("市","");s=s.replace("自治区","");
s=s.replace("自治州","");}return s;}},{modelName:"lastFollowTime",name:"lastFollowTime",index:"entity.last_follow_time_",width:82,isBase:"true",formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"follow",name:"follow",index:"entity.follow_",width:70,isBase:"true"},{modelName:"lastFollowContent",name:"lastFollowContent",index:"entity.last_follow_content_",sortable:false,width:100,formatter:function(r){var s="";
if(r!=""&&r!=null){s='<span  style="color:#1ab394;'+(a.simpleShowDesc=="true"?"":"display:none")+'" class="tooltip-desc jt-grid-tip fa fa-bell"   data-value="'+r+'"></span>';
s+='<span style="'+(a.simpleShowDesc=="true"?"display:none":"")+'" class="desc-detail">'+r+"</span>";}return s;}},{modelName:"desc",name:"desc",index:"entity.desc_",width:100,isBase:"true",formatter:function(s){var r="";
if(s!=""&&s!=null){r='<span  style="color:#1ab394;'+(a.simpleShowDesc=="true"?"":"display:none")+'" class="tooltip-desc jt-grid-tip fa fa-bell" data-toggle="tooltip"  data-value="'+s+'"></span>';
r+='<span style="'+(a.simpleShowDesc=="true"?"display:none":"")+'" class="desc-detail">'+s+"</span>";}return r;}},{modelName:"turnTime",name:"turnTime",index:"entity.turn_time_",width:82,formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"lastCompleteTime",name:"lastCompleteTime",index:"entity.last_complete_time_",width:82,formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"employeeName",name:"employeeName",index:"entity.employee_id_",width:100,hidden:f,formatter:function(r,s,t){if(t.employeeAid){return t.employeeAid+":"+t.employeeName;
}return t.employeeAid;}},{modelName:"groupName",name:"groupName",index:"entity.group_Id_",width:70,hidden:f},{modelName:"createTime",name:"createTime",index:"entity.create_time_",width:82,isBase:"true",formatter:function(r){var s=new StringBuffer();
if(r&&0==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("今天 ").append(DateUtils.mini3Time(r));}else{if(r&&1==DateUtils.getDateDiff(r,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","day")){s.append("昨天 ").append(DateUtils.mini3Time(r));
}else{s.append(DateUtils.mini2Time(r));}}return s.toString();}},{modelName:"phone",name:"phone",index:"entity.phone",hidden:true,width:60},{modelName:"subPhone",name:"subPhone",index:"entity.subPhone",hidden:true,width:60}];
$(CsEntity._CONS_.GRID).JTJqgrid({url:c,pager:CsEntity._CONS_.PAGER,postData:m,width:"100%",autowidth:true,colNames:["客户编号","姓名","客户姓名（隐藏）","操作","客户编号(隐藏)","约单","性别","关怀","分类","成交","N次","消费(元)","京享值","有赞积分","意向","产品意向","渠道","微信","地区","最新跟进","跟进标签","跟进内容","备注","转单时间","最新签收","工号","部门","注册时间","手机号","从属客户手机号码"],colModel:o,sortname:p?"entity.is_top_ desc,entity.turn_time_":"",sortorder:p?"DESC":"",footerrow:true,userDataOnFooter:true,simplify:{key:"wdkh",entry:[{sName:"精简显示",sClass:"csDesc",sCheck:a.simpleShowDesc=="true"}],must:["客户编号","姓名"],base:["操作","性别","关怀","分类","成交","N次","消费(元)","产品意向","渠道","最新跟进","跟进标签","备注"],other:["约单","京享值","有赞积分","意向","微信","地区","跟进内容","转单时间","最新签收"]},loadComplete:function(){if("true"==window.localStorage.getItem("csentity_need_clear_selectedJqgrid")){a.selectedJqgrid=new Array();
window.localStorage.removeItem("csentity_need_clear_selectedJqgrid");}for(var s=0;s<a.selectedJqgrid.length;s++){$(CsEntity._CONS_.GRID).jqGrid("setSelection",a.selectedJqgrid[s]);
}if("search"==type){$("a.csEntitySoAdd").hide();}if($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records")<1000){$("#endExportNum").val($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records"));
}else{$("#endExportNum").val(1000);}if(a.toTop.length>0){for(var s=0;s<a.toTop.length;s++){$("#"+a.toTop[s]).addClass("jt-grid-totop");}a.toTop=[];}a._hideNotGrantBtn();
var r=$(CsEntity._CONS_.GRID).getGridParam("width");$(CsEntity._CONS_.GRID).setGridWidth(r);$(window).resize();},gridComplete:function(){var r=$(CsEntity._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
r.find('td[aria-describedby*="rn"],td[aria-describedby*="cb"],td[aria-describedby*="care"],td[aria-describedby*="srcNames"],td[aria-describedby*="relatedWeixin"],td[aria-describedby*="name"],td[aria-describedby*="gender"],td[aria-describedby*="bizType"],td[aria-describedby*="winePurpose"],td[aria-describedby*="taste"],td[aria-describedby*="hasDeal"],td[aria-describedby*="soRepeatBuy"],td[aria-describedby*="soTotal"],td[aria-describedby*="interests"],td[aria-describedby*="productName"],td[aria-describedby*="follow"],td[aria-describedby*="turnTime"],td[aria-describedby*="lastCompleteTime"],td[aria-describedby*="employeeName"],td[aria-describedby*="levelName"],td[aria-describedby*="lastFollowTime"],td[aria-describedby*="canPlaceSo"],td[aria-describedby*="soComplete"],td[aria-describedby*="jdPoint"],td[aria-describedby*="prName"],td[aria-describedby*="desc"],td[aria-describedby*="groupName"],td[aria-describedby*="createTime"]').hide();
r.find('td[aria-describedby*="csEntityGrid_code"]').show();r.hide();},onSelectAll:function(t,r){if(t&&t.length>0){for(var s=0;s<t.length;s++){if(r){if(a.selectedJqgrid.indexOf(t[s])==-1){a.selectedJqgrid.push(t[s]);
}}else{a.selectedJqgrid.remove(t[s]);}}}},onSelectRow:function(s,r){if(r){if(a.selectedJqgrid.indexOf(s)==-1){a.selectedJqgrid.push(s);}}else{a.selectedJqgrid.remove(s);
}},ondblClickRow:function(r){if(r){}},onSortCol:function(s,t,r){a.sortColumn=s;a.sortorder=r;}});});});});});},_add:function(a,b){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/add.htm?type="+type+"&csType="+a,b);
},_edit:function(c,a){var b="客户["+$(CsEntity._CONS_.GRID).jqGrid("getRowData",c).name+"]";if("self"==type){if(ResUtils.canShow("csEntity.button.edit")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+c,b);
}}else{if("mysub"==type){if(ResUtils.canShow("csEntity.button.editSub")){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/toEdit.htm?type="+type+"&csId="+c,b);
}}}},_toExportExcel:function(b){var a=this;$(".list_wrapper").hide();$(".form_wrapper").hide();$(".excel_wrapper").show();$(".prevBtn").show();$(".exportExcel").attr("disabled",false);
$("input[name=selectIds]").val("");if(b&&b.length>0){$("input[name=selectIds]").val(b);$("#endExportNum").val(b.length);}var c=[];var d=LocalStorageUtils.get("CS_EXPORT_COLUMNS_"+currentUserId);
if(d){c=d.split(",");}excelUtil.findExportColByModule("csEntity",true,function(f){var g=new StringBuffer();if(f&&f.length>0){for(var e=0;e<f.length;e++){g.append("<div class='checkbox checkbox-success checkbox-inline'>");
if($.inArray(f[e].devCode,c)!=-1){g.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}else{g.append("<input type='checkbox' class='columnCheckBox' name='exportColumn' id="+f[e].id+" value='"+f[e].devCode+"'><label for='"+f[e].id+"'>"+f[e].name+"</label>");
}g.append("</div>");}}$("#columnContainer").empty().append(g.toString());});},_toList:function(){$(".list_wrapper").show();$(".form_wrapper").hide();$(".excel_wrapper").hide();
},_exportExcel:function(){var b=this;var d=$("#columnContainer").find(".columnCheckBox");var e=[];$(d).each(function(){if($(this).is(":checked")){e.push($(this).val());
}});var a=$("#beginExportNum").val();var c=$("#endExportNum").val();if(!a){DialogUtils.error(msgCode.ERROR,"请填写正确的开始记录");return;}if(!c){DialogUtils.error(msgCode.ERROR,"请填写正确的结束记录");
return;}if(parseInt(a)>parseInt(c)){DialogUtils.error(msgCode.ERROR,"开始记录不能大于结束记录");return;}if(parseInt(a)-parseInt($(CsEntity._CONS_.GRID).jqGrid("getGridParam","records"))>0){DialogUtils.error(msgCode.ERROR,"开始记录不能大于记录总条数");
return;}if(!c){c=a;}DialogUtils.confirmWithOptions({title:"是否确认导出客户资料",text:"若已经导出过，请勿重复导出",confirmButtonText:"确认",yesFunc:function(){b.rfmtSearch.dealTip();
LocalStorageUtils.set("CS_EXPORT_COLUMNS_"+currentUserId,e.toString());var f=$("input[name=selectIds]").val();var g=CsEntityUtils.getSearchParams(b.rfmtSearch);
if(f&&f.length>0){g+="&Q__S__IN__entity.id_="+f;}window.top.showTimming(parseInt(c)-parseInt(a));g=g+"&columns="+e.toString()+"&beginExportNum="+a+"&endExportNum="+c+"&type="+type+"&excelType="+$('input:radio[name="excelType"]:checked').val()+"&sidx="+b.sortColumn+"&sord="+b.sortorder;
FormUtils.submit(CsEntity._CONS_.EXPORT_EXCEL_URL,g,function(h){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},noFunc:function(){$(".exportExcel").attr("disabled",false);
}});},_buildLevelOption:function(){FormUtils.loadData(ctx+"/crm/point/levelDef/findActived.htm",function(b){if(b&&b.length>0){var c=new StringBuffer();
for(var a=0;a<b.length;a++){c.append("<option value='"+b[a].level+"'>"+b[a].name+"</option>");}$("#levelSearch").append(c.toString());}});},_buildEavSearchCondition:function(){var a=this;
var b=a._getContainer("eavSearch");if(!b){return false;}FormUtils.loadData(ctx+"/crm/cs/csEntity/getEavSetPo.htm",function(f){if(f&&f.eavAttrPos&&f.eavAttrPos.length>0){var e=f.eavAttrPos;
var g=new StringBuffer();for(var d=0;d<e.length;d++){g.append("<optgroup label='"+e[d].name+"'>");if(e[d].eavAttrOptPos&&e[d].eavAttrOptPos.length>0){for(var c=0;
c<e[d].eavAttrOptPos.length;c++){g.append("<option value='"+e[d].eavAttrOptPos[c].value+"'>"+e[d].eavAttrOptPos[c].label+"</option>");}}g.append("</optgroup>");
}b.empty().append(g.toString());}if(b&&b.is(".selectpicker")){b.selectpicker("refresh");}});},_buildEmployeeOption:function(c){var a=this;var b=CsEntity._CONS_.EMPLOYEE_LIST_URL+"?groupId="+c+"&type=dept_manager&notContainUserId=y";
FormUtils.loadData(b,function(e){var f=a._getContainer("belongEmployeeSearch");if(!f){return false;}if(e&&e.length>0){var g=new StringBuffer();for(var d=0;
d<e.length;d++){g.append("<option value='"+e[d].id+"'>"+e[d].aid+":"+e[d].name+"</option>");}f.empty().append(g.toString());}if(f&&f.is(".selectpicker")){f.selectpicker("refresh");
}},null,true);},_getContainer:function(b){var a=this;var c=false;if(b){c=$("#"+b);if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");
if(c.length==0){return false;}}}}return c;},_batchPermitSo:function(b){var a=CsEntity._CONS_.BATCH_CHANGE_CAN_PLACE_SO_URL;FormUtils.submit(a,{"ids":b,canPlaceSo:"y"},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"更改成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},_batchForbitSo:function(b){var a=CsEntity._CONS_.BATCH_CHANGE_CAN_PLACE_SO_URL;
FormUtils.submit(a,{"ids":b,canPlaceSo:"n"},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"更改成功");$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}});},_batchDelete:function(b){var a=CsEntity._CONS_.BATCH_DELETE_URL;FormUtils.submit(a,{"ids":b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"客户资料删除成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},_batchToSea:function(b){var a=CsEntity._CONS_.BATCH_TOSEA_URL;
FormUtils.submit(a,{"ids":b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"客户资料转移成功");$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}});},_batchSetTop:function(c,b){var a=CsEntity._CONS_.BATCH_SETTOP_URL;FormUtils.submit(a,{"ids":c,isTop:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");
$(".csEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_placeGeneralOrderMethod:function(f,b){var a=f.attr("idVal");
if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");
return;}a=b.selectedJqgrid[0];}var d=$(CsEntity._CONS_.GRID).jqGrid("getRowData",a);var c=d["canPlaceSo"];if(c=="否"){DialogUtils.error("提示","该客户已被禁止下单");
return;}var e=f.attr("attr-name");JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=false&csId="+a+"&type="+type,"["+e+"]下订单");
},_placePointsOrderMethod:function(e,b){var a=e.attr("idVal");if(!a){if(!b.selectedJqgrid||b.selectedJqgrid.length==0){DialogUtils.error("错误","请选择要下订单的客户");
return;}if(b.selectedJqgrid.length>1){DialogUtils.error("错误","只能选择单个客户下单");return;}a=b.selectedJqgrid[0];}var c=$(CsEntity._CONS_.GRID).jqGrid("getRowData",a);
var d=c["name"];if(d.length>4){d="*"+d.substring(d.length-3,d.length);}JTTabUtils.addOrRefreshTab(CsEntity._CONS_.ORDER_PLACE_URL+"?isAdd=true&isPoint=true&csId="+a+"&type="+type,"客户["+d+"]下积分订单");
},};function parentCMD(){$(".csEntitySearch").trigger("click");}