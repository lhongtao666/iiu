function CsComplainAdd(){this.hadInit=false;}CsComplainAdd._CONS_={EDIT_URL:ctx+"/crm/cs/csComplain/edit.htm",SAVE_ADD_URL:ctx+"/crm/cs/csComplain/saveAdd.htm",FIND_ALL_EMPLOYEE:ctx+"/crm/ou/employee/listEmployees.htm",FIND_ORDER:ctx+"/ec/salesorder/soEntity/findOrderByCsId.htm",FIND_ORDER_ITEM:ctx+"/ec/salesorder/soEntity/findSoItem.htm",FIND_BY_CSID:ctx+"/crm/cs/csComplain/findByCsId.htm",};
CsComplainAdd.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initInputAndOption(a);
this.findAllEmployees();}this.findOrders(a.csId);this._initTable(a.csId);},clear:function(){$("#csComplainAddForm").find("[name=complainId]").val("");$("#csComplainAddForm").find("[name=soId]").val("");
$("#csComplainAddForm").find("[name=skuIds]").empty();$("#csComplainAddForm").find("[name=followId]").val("");$("#csComplainAddForm").find("[name=type]").val("");
$("#csComplainAddForm").find("[name=desc]").val("");$("#csComplainAddForm").find("[name=dealResult]").val("");$("[name=status]").val("");},_save:function(){var c=this;
if($("#csComplainAddForm").valid()){var a=CsComplainAdd._CONS_.SAVE_ADD_URL;var e=$("#csComplainAddForm").serialize()+"&csId="+$("input[name='id']").val();
var b=$("#csComplainType option:selected").attr("firstCateId");var d=$("#csComplainType option:selected").val();if(b){e=e+"&firstType="+b;}if(d==b){e=e+"&isFirstType=true";
}else{e=e+"&isFirstType=false";}FormUtils.submit(a,e,function(f){if(f.success){DialogUtils.success("提示","投诉提交成功");c._initTable($("input[name='id']").val());
c.clear();layer.close(c.layerIndex);}else{DialogUtils.error("失败","投诉提交失败，请稍后重试");}});}},_bindEventHander:function(){var a=this;$("[name=soId]").on("change",function(){$("#skuIdsDiv").empty().append("<select multiple data-placeholder='请选择' class='chosen-select form-control' name='skuIds' ></select>");
if($(this).val()){a.findSoItem($(this).val());}else{$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();}});$(document).on("click",".addComplain",function(){a._add();
});$(document).on("click",".viewComplain",function(){a._detail($(this).attr("attr-id"));});},_bindFormValidation:function(){var a={rules:{"type":{required:true,},"soId":{required:true,}}};
FormUtils.bindFormValidation("csComplainAddForm",a);},findAllEmployees:function(){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ALL_EMPLOYEE+"?type=all",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("select[name=complainId]").empty().append(d.toString());
$("select[name=followId]").empty().append(d.toString());}}});},findOrders:function(b){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ORDER+"?csId="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){var e=new StringBuffer();
e.append("<option value=''>请选择</option>");if(d&&d.length>0){for(var c=0;c<d.length;c++){if("green"!=d[c].cashType){e.append("<option value='"+d[c].id+"'>"+d[c].createTime+"（"+d[c].soNo+"）</option>");
}}}$("[name=soId]").empty().append(e.toString());}});},findSoItem:function(b){var a=this;$.ajax({type:"GET",url:CsComplainAdd._CONS_.FIND_ORDER_ITEM+"?soId="+b,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d&&d.length>0){var e=new StringBuffer();
for(var c=0;c<d.length;c++){e.append("<option value='"+d[c].skuId+"'>"+d[c].prodName+"（"+d[c].skuKey+"）</option>");}$("[name=skuIds]").empty().append(e.toString());
}$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();}});},_initTable:function(c){var a=this;$("#csComplainDiv").empty().append("<table class='table table-striped table-bordered' id='csComplainTable'><thead><tr><th>类型</th><th>订单</th><th>产品</th><th>投诉工号</th><th>跟进工号</th><th>投诉时间</th><th>状态</th><th>操作</th></tr></thead></table>");
var b=CsComplainAdd._CONS_.FIND_BY_CSID+"?csId="+c;$("#csComplainTable").DataTable({ajax:{url:b},columns:[{data:"type",render:function(f,e,d){if(f){return d.typeName;
}else{return d.firstTypeName;}},width:"15%"},{data:"soNo",width:"10%"},{data:"skuNames",width:"20%"},{data:"complainAid",width:"12%"},{data:"followAid",width:"12%"},{data:"createTime",width:"12%",render:function(f,e,d){if(d.createTime){return DateUtils.miniTime(d.createTime);
}else{return"";}}},{data:"status",render:function(g,f,e){var d=e.status;if(d=="new"){d="新增";}else{if(d=="follow"){d="跟进中";}else{if(d=="complete"){d="完成";
}}}return d;},width:"10%"},{data:"id",render:function(f,e,d){return"<input type='button' value='查看' attr-id='"+d.id+"' class='btn btn-sm btn-outline btn-primary viewComplain' style='margin: 0px 0px 0px 15px;' />";
},width:"10%"},],rowId:"id",lengthMenu:[[5,10],[5,10]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[5,"desc"]]});
},_add:function(){var a=this;$("#csComplainAddForm").find(".editInfoDiv").hide();a.ableButton();a.openEditView("add");},_detail:function(b){var a=this;
$("#csComplainAddForm").find(".editInfoDiv").show();a.disableButton();a.loadData(b);a.openEditView("detail");},openEditView:function(b){var a=this;a.clear();
a.layerIndex=layer.open({type:1,title:"客户投诉",shadeClose:false,btn:["保存","关闭"],area:["50%","60%"],content:$(".csComplainEdit"),scrollbar:false,success:function(c,d){if("detail"==b){$(".layui-layer-btn0").hide();
}else{$(".layui-layer-btn0").show();$("[name=desc]").attr("disabled",false);}$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();
$("select[name=complainId]").select2();$("select[name=followId]").select2();},yes:function(d,c){a._save();},cancel:function(){a.clear();}});},ableButton:function(){$("#csComplainAddForm").find("select").attr("disabled",false);
$("#csComplainAddForm").find("textarea").attr("readonly",false);},disableButton:function(){$("#csComplainAddForm").find("select").attr("disabled",true);
$("#csComplainAddForm").find("textarea").attr("readonly",true);},loadData:function(b){var a=this;FormUtils.loadData(CsComplainAdd._CONS_.EDIT_URL+"?id="+b,function(c){a._fillForm(c);
});},_fillForm:function(b){var a=this;$("#csComplainAddForm").find("[name=complainId]").val(b.complainId);$("#csComplainAddForm").find("[name=soId]").val(b.soId);
$("#csComplainAddForm").find("[name=followId]").val(b.followId);if(b.type!=""){$("#csComplainAddForm").find("[name=type]").val(b.type);}else{$("#csComplainAddForm").find("[name=type]").find("[firstcateid="+b.firstType+"]")[0].selected="selected";
}$("#csComplainAddForm").find("[name=desc]").val(b.desc);$("#csComplainAddForm").find("[name=dealResult]").val(b.dealResult);$("[name=status]").val(b.status);
a.fillOrders(b.soEntityPos,b.soId,b.skuIds);$("select[name=complainId]").select2();$("select[name=followId]").select2();},fillOrders:function(e,d,b){var a=this;
var f=new StringBuffer();f.append("<option value=''>请选择</option>");if(e&&e.length>0){for(var c=0;c<e.length;c++){if(e[c].id==d){f.append("<option value='"+e[c].id+"' selected>"+e[c].soNo+"</option>");
a.fillSkuIds(e[c].soItemPos,b);}else{f.append("<option value='"+e[c].id+"'>"+e[c].soNo+"</option>");}}}$("[name=soId]").empty().append(f.toString());},fillSkuIds:function(d,b){var a=this;
if(d&&d.length>0){var e=new StringBuffer();for(var c=0;c<d.length;c++){if(b.indexOf(d[c].skuId)!=-1){e.append("<option value='"+d[c].skuId+"' selected>"+d[c].prodName+"</option>");
}else{e.append("<option value='"+d[c].skuId+"'>"+d[c].prodName+"</option>");}}$("#skuIdsDiv").empty().append("<select multiple data-placeholder='请选择' class='chosen-select form-control' name='skuIds' ></select>");
$("[name=skuIds]").empty().append(e.toString());$("[name=skuIds]").attr("disabled",true);$("select[name=skuIds]").chosen("destroy");$("select[name=skuIds]").chosen();
}},_initInputAndOption:function(a){CateUtils.getOptions({typeKey:"system",pKey:"ComplainDealResult",container:"dealResult"});ComplainTypeOption.getTypeOption(function(b){$("#csComplainType").append(b);
});$(".addComplain").show();if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(!ResUtils.canShow("csEntity.button.addComplainBtn")){$(".addComplain").hide();
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(!ResUtils.canShow("csEntity.button.addComplainBtnSub")){$(".addComplain").hide();
}}else{if("task"==a.csType){if(!ResUtils.canShow("csEntity.button.addComplainBtnTask")){$(".addComplain").hide();}}else{if("callRecord"==a.csType){if(!ResUtils.canShow("csEntity.button.addComplainBtnCallRecord")){$(".addComplain").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addComplainBtnSearch")){$(".addComplain").hide();}}}}}}}};