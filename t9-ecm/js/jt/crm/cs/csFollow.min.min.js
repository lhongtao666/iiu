function CsFollow(){this.hadInit=false;this.needTable=true;this.fn=null;this.employeeId="";this.csType="";this.permissionType="";this.partyInfo=null;this.followType="";
this.contentExt="";this.isWeixin=false;}CsFollow._CONS_={EDIT_URL:ctx+"/crm/cs/csFollow/edit.htm",DELETE_URL:ctx+"/crm/cs/csFollow/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/csFollow/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csFollow/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/csFollow/findByCsId.htm",EDIT_FORM_ID:"csFollowForm"};
CsFollow.prototype={init:function(c,d){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindFormValidation();}if(c){this.needTable=c.needTable;
this.fn=c.fn;this.employeeId=c.employeeId;this.csType=c.csType;this.permissionType=c.permissionType;this.followType=c.followType;this.contentExt=c.contentExt;
this._initInputAndOption(c);if(c.isWeixin){this.isWeixin=c.isWeixin;}if(c.shipQry){this.entityId=c.entityId;this.soNo=c.soNo;this.csPhone=c.csPhone;this._addFollowBtn();
}}if(this.needTable){this._initTable();}this.partyInfo=d;},clear:function(f){var e=this;d();function d(){var c=$("#csFollowForm");c.find('input[name="hasTask"]').val(["n"]).trigger("change");
c.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");var b=document.querySelector(".js-switch");
var a=new Switchery(b,{className:"switchery switchery-small"});c.find("[name=csFollowId]").val("");c.find("#followType option:first").prop("selected","selected");
c.find("#satisfy option:first").prop("selected","selected");c.find("[name=content]").val("");c.find("#taskTimeDiv").hide();c.find("#followEmployeeDiv").hide();
c.find("input[name=taskTime]").val("").removeClass("validate_input_error");c.find("input[name=partyShow]").val("").removeClass("validate_input_error");
c.find("input[name=partyId]").val("");c.find("input[name=employeeAid]").val("");}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_save:function(){var k=this;var o=$("#csFollowForm");var r=o.find("[name=csFollowId]").val();var l=r?CsFollow._CONS_.SAVE_EDIT_URL:CsFollow._CONS_.SAVE_ADD_URL;
var m=new StringBuffer();var j=o.find("[name=type]").val();if(!$("#csFollowForm").valid()){return;}if("so"==this.followType){type="订单跟进";}var n=o.find("[name=content]").val();
n=n.replace("&","");o.find("[name=content]").val(n);var p="";if(this.contentExt){p=j+"："+this.contentExt+n;}else{p=j+"："+n;}var q={id:r,type:o.find("[name=type]").val(),content:encodeURI(o.find("[name=content]").val()),smsContent:encodeURI(o.find("[name=smsContent]").val()),contentExt:encodeURI(p),hasTask:o.find('input[name="hasTask"]').val(),satisfy:o.find("[name=satisfy]").val(),csId:o.find("input[name='csId']").val(),csCode:o.find("input[name='csCode']").val(),createAid:currentUserAid,entityId:$("#soEntityForm").find('input[name="id"]').val()||$("#csEntityForm").find('input[name="id"]').val()||this.entityId,seconds:o.find("[name=seconds]").val(),soNo:$("[name=soNo]").val()||this.soNo,isSms:$("[name=isSms]").val(),};
if(o.find("input[name=partyId]").val()&&o.find('input[name="hasTask"]').val()=="y"){q.taskTime=o.find("[name=taskTime]").val();q.partyId=o.find("input[name=partyId]").val();
q.employeeAid=o.find("input[name=employeeAid]").val();q.csPhone=o.find("input[name='csFollowPhone']").val()||$("#soEntityForm").find(".addrMobile").val()||this.csPhone;
q.status="new";}else{q.partyId=currentUserId;q.employeeAid=currentUserAid;q.status="done";}if(q.isSms=="y"){if(q.csPhone==""){DialogUtils.error(msgCode.FAIL_MSG,"该客户无手机号码，不能发送短信!");
return;}}FormUtils.submit(l,q,function(a){if(a.success){if(a.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(a.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}if(k.needTable){k._initTable();}if(k.fn&&(typeof k.fn=="function")){q.content=o.find("[name=content]").val();k.fn(q);}layer.close(k.layerIndex);k.clear();
if(k.isWeixin){$("#reload-follow").trigger("click");}}else{DialogUtils.error(msgCode.FAIL_MSG,a.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindEventHander:function(){var d=this;var c=$("#csFollowForm");$("#followRecordTab").on("click",".deleteCsFollow",function(){var a={csId:$(this).attr("csIdVal"),id:$(this).attr("idVal")};
DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/cs/csFollow/delete.htm",a,function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,b.msg);
d._initTable();}});});});c.on("change","input[name='hasTask']",function(){if($(this).val()=="y"){c.find("#taskTimeDiv").hide();c.find("#followEmployeeDiv").hide();
c.find("#smsContentDiv").hide();c.find("input[name=partyShow]").removeClass("validate_input_error");c.find("input[name=taskTime]").removeClass("validate_input_error");
$(this).val("n");$("#isSmsDivContainer").hide();$("input[name='isSms']").val("n");c.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");
var g=document.querySelector(".js-switch2");var a=new Switchery(g,{className:"switchery switchery-small"});layer.style(d.layerIndex,{height:"250px"});}else{c.find("#taskTimeDiv").show();
c.find("#followEmployeeDiv").show();var h=$(".followCount").height();layer.style(d.layerIndex,{height:"310px"});$(this).val("y");if(d.partyInfo){c.find("input[name=partyId]").val(d.partyInfo.partyId);
c.find("input[name=employeeAid]").val(d.partyInfo.partyAid);c.find("input[name=partyShow]").val(d.partyInfo.partyAid+":"+d.partyInfo.partyName);}else{c.find("input[name=partyId]").val(currentUserId);
c.find("input[name=employeeAid]").val(currentUserAid);c.find("input[name=partyShow]").val(currentUserAid+":"+currentUserName);}var b=new Date();now=b.current();
c.find("input[name=taskTime]").val(now.substr(0,16));$("#isSmsDivContainer").show();}});c.on("change","input[name='isSms']",function(){if($(this).val()=="y"){$(this).val("n");
c.find("#smsContentDiv").hide();layer.style(d.layerIndex,{height:"310px"});}else{$(this).val("y");c.find("#smsContentDiv").show();var a=$(".followCount").height();
layer.style(d.layerIndex,{height:"400px"});}});c.on("click",".selectEmployee",function(){$("input[name=partyShow]").removeClass("validate_input_error");
var f=0;if(ResUtils.canShow("employeeSelector.button.cs")){f:1;}var a={isShowAllGroup:f,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(e){if(e!=null||e.length>0){c.find("input[name=partyShow]").val(e[0].aid+"："+e[0].name);
c.find("input[name=partyId]").val(e[0].id);c.find("input[name=employeeAid]").val(e[0].aid);}}};var b=new EmployeesSelect();b.init(a);});$(document).on("click","#followTaskTime",function(){c.find("input[name=taskTime]").removeClass("validate_input_error");
});$(document).on("click",".appendFollow",function(){$(this).hide();$("#csFollowFormDiv").show();});$('select[name="suffix"]').on("change",function(){d._initTable();
});$(document).on("click",".saveAddFollow",function(){if(d.valid()){d._save();}});$(document).on("click","#addFollowBtn",function(){d._addFollowBtn();});
},_addFollowBtn:function(){var d=this;var c="form-config-layer";ButtonUtils.disableBtn("addFollowBtn");layer.close(d.layerIndex);d.layerIndex=layer.open({type:1,skin:"followCount",title:"跟进记录",shade:false,btn:["保存","取消"],area:["650px","auto"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,skin:c,success:function(b,a){ButtonUtils.enableBtn("addFollowBtn");
},yes:function(a,b){if(d.valid()){d._save();}},btn2:function(){d.clear();}});},_initTable:function(){var f=this;if(!f._hasPermission()){return;}var e=CsFollow._CONS_.LIST_DATA_URL+"?csId="+csId+"&suffix="+$("select[name='suffix']").val();
var g="";if(f.csType){if("self"==f.csType||(f.permissionType&&"self"==f.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){g="<th width='7%'>操作</th>";
}}else{if("mysub"==f.csType||(f.permissionType&&"mysub"==f.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){g="<th width='7%'>操作</th>";
}}else{if("task"==f.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){g="<th width='7%'>操作</th>";}}else{if("callRecord"==f.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){g="<th width='7%'>操作</th>";
}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){g="<th width='7%'>操作</th>";}}}}}}$("#csFollowDiv").empty().append("<table class='table table-striped table-bordered' id='csFollowTable'>            <thead>                <tr>                    <th width='3%'></th>                    <th width='15%'>主题</th>                    <th width='35%'>待办内容</th>                    <th width='10%'>安排人</th>                    <th width='10%' >跟进人</th>                    <th width='10%'>记录时间</th>                    <th width='10%'>跟进时间</th>                    "+g+"                </tr>            </thead>        </table>");
var h=[{data:"lineNum",width:"3%"},{data:"type",},{data:"content",render:function(a,b,c){if(ResUtils.canShow("csEntity.button.viewFollowPhone")){return c.content;
}else{return MaskPhoneNum.maskDesc(c.content);}}},{data:"createName",render:function(a,b,c){if(c.createName.indexOf("null")>-1){return"[已删除]";}else{return c.createName;
}}},{data:"partyName",render:function(a,b,c){if(c.partyName.indexOf("null")>-1){return"[已删除]";}else{return c.partyName;}}},{data:"createTime",render:function(a,b,c){if(c.createTime){return DateUtils.miniTime(c.createTime);
}else{return"";}}},{data:"taskTime",render:function(a,b,c){if(c.taskTime){return DateUtils.miniTime(c.taskTime);}else{return"";}}},];if(f.csType){if("self"==f.csType||(f.permissionType&&"self"==f.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){h.push({data:"id",width:"7%",render:function(a,b,c){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+c.csId+"' idVal='"+a+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("mysub"==f.csType||(f.permissionType&&"mysub"==f.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){h.push({data:"id",width:"7%",render:function(a,b,c){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+c.csId+"' idVal='"+a+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("task"==f.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){h.push({data:"id",width:"7%",render:function(a,b,c){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+c.csId+"' idVal='"+a+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("callRecord"==f.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){h.push({data:"id",width:"7%",render:function(a,b,c){return"<button class='btn btn-danger btn-sm btn-outline deleteCsFollow' csIdVal='"+c.csId+"' idVal='"+a+"' type='button' title='删除'><i class='fa fa-remove'></i></button>";
}});}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){h.push({data:"id",width:"7%",render:function(a,b,c){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+c.csId+"' idVal='"+a+"'style='color: red; cursor: pointer;'></i>";
}});}}}}}}$("#csFollowTable").DataTable({ajax:{url:e},searching:false,columns:h,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:true,ordering:true,order:[[5,"desc"]]});
},valid:function(){var e=true;var d=$("#csFollowForm");if(!d.valid()){e=false;}var f=d.find("[name = hasTask]:checkbox").val();if(f=="y"){if(!d.find("input[name=partyShow]").val()){d.find("input[name=partyShow]").addClass("validate_input_error");
e=false;}if(!d.find("input[name=taskTime]").val()){d.find("input[name=taskTime]").addClass("validate_input_error");e=false;}}return e;},_enableInput:function(){var f=$("#csFollowForm");
f.find("#followType").attr("disabled",false);f.find("#followContent").attr("readonly",false);f.find("[name=hasTask]").attr("disabled",false);f.find("#followTaskTime").attr("disabled",false);
f.find("#satisfy").attr("disabled",false);f.find("#seconds").attr("disabled",false);f.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
f.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var i=document.querySelector(".js-switch");var h=new Switchery(i,{className:"switchery switchery-small"});
var g=document.querySelector(".js-switch2");var j=new Switchery(g,{className:"switchery switchery-small"});f.find(".selectEmployee").show();$(".appendFollow").show();
$("#csFollowFormDiv").hide();},_initInputAndOption:function(i){var g=$("#csFollowForm");g.find("input[name=csId]").val(i.csId);g.find("input[name=csCode]").val(i.csCode);
g.find("input[name=contentExt]").val(i.contentExt);g.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
g.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var k=document.querySelector(".js-switch");var j=new Switchery(k,{className:"switchery switchery-small"});
var h=document.querySelector(".js-switch2");var l=new Switchery(h,{className:"switchery switchery-small"});if("so"==this.followType){g.find("#followType").empty().append("<option value='订单跟进'>订单跟进</option>");
if(ResUtils.canShow("soEntity.button.addFollowBtn")){$(".addFollow").show();}else{$(".addFollow").hide();}}else{CateUtils.getOptions({typeKey:"system",pKey:"CsFollowType",container:"followType",fn:function(b){var a=new StringBuffer();
if(b&&b.length>0){for(var c=0;c<b.length;c++){a.append("<option value='"+b[c].value+"'>"+b[c].name+"</option>");}}g.find("#followType").append(a.toString());
}});if(this.csType){$(".addFollow").show();if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtn")){$(".addFollow").hide();
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtnSub")){$(".addFollow").hide();
}}else{if("task"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnTask")){$(".addFollow").hide();}}else{if("callRecord"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnCallRecord")){$(".addFollow").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addFollowBtnSearch")){$(".addFollow").hide();}}}}}if(i.fn&&typeof i.fn=="function"){i.fn();}}}},_bindFormValidation:function(){var b={rules:{"content":{required:true,maxlength:1023},"seconds":{required:true,min:0},}};
FormUtils.bindFormValidation("csFollowForm",b);},_initFollowEmp:function(){var b=$("#csFollowForm");b.find("[name=content]").attr("disabled",false);b.find("input[name=partyShow]").val(currentUserAid+"："+currentUserName);
b.find("input[name=partyId]").val(currentUserId);b.find("input[name=employeeAid]").val(currentUserAid);},_prodSearch:function(d){$("#partyShow").bsSuggest("destroy");
if(d==null||d==""){return;}var c=this;$("#searchProd").bsSuggest({url:ctx+"/crm/ou/employee/selectEmployee.htm",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"姓名"},showBtn:false,idField:"id",keyField:"name",autoSelect:false,getDataMethod:"url",listStyle:{"padding-top":0,"max-height":"500px","max-width":width,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(a,b){c.searchProds=b.value;
}).on("onSetSelectValue",function(a,e){for(var b=0;b<c.searchProds.length;b++){if(c.searchProds[b].skuId==e.id){c.currentProd=c.searchProds[b];break;}}$("#searchProd").val("");
}).on("onUnsetSelectValue",function(a){c.searchProds=[];c.currentProd={};});},_initEmployeeSuggest:function(){var b=this;$("input[name='partyShow']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?grantType=/cs/&keyword=",effectiveFields:["aid"],searchFields:["aid"],effectiveFieldsAlias:{aid:"工号"},showBtn:false,idField:"id",keyField:"aid",getDataMethod:"url",processData:function(a){var f={value:[]};
if(a&&a.value){for(var g=0;g<a.value.length;g++){var h=a.value[g];f.value.push({id:h.id,aid:h.aid+"："+h.name});}}return f;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onSetSelectValue",function(e,a){var f=$("#csFollowForm");
f.find("input[name=partyId]").val(a.id);f.find("input[name=employeeAid]").val(a.aid);});},_hasPermission:function(){var b=true;if("self"==type||(this.permissionType&&"self"==this.permissionType)){}else{if("mysub"==type||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.viewFollowSub")){b=false;
}}else{if("task"==type){if(!ResUtils.canShow("csEntity.button.viewFollowTask")){b=false;}}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.viewFollowCallRecord")){b=false;
}}else{if(!ResUtils.canShow("csEntity.button.viewFollowSearch")){b=false;}}}}}return b;}};