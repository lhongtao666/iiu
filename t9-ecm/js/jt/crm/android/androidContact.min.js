$(function(){var a=new AndroidContact();a.init();});function AndroidContact(){this.hadInit=false;this.employeeWeixin="";this.isRelated=type=="sub"?"":"y";
this.seniorSearch=new SeniorSearch();this.hiddenAlias=false;this.searchParam="";this.hadInitJQgrid=false;}AndroidContact._CONS_={LIST_DATA_URL:ctx+"/crm/android/listData.htm",SET_REPEAT_URL:ctx+"/crm/android/setRepeat.htm",UN_SET_REPEAT_URL:ctx+"/crm/android/unSetRepeat.htm",BATCH_CHANGE_LABEL:ctx+"/crm/android/batchChangeLabel.htm",FIND_EMPLOYEE_WEIXIN:ctx+"/gl/ou/employeeWeiXin/findVisiablePos.htm",GRID:"#androidContactGrid",PAGER:"#androidContactPager"};
AndroidContact.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadEmployeeWeixin();this.seniorSearch.init();
this._initWxlabel();this._dealStyle();this._hideWxTypeBtn();this._hideNotGrantBtn();this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.csEntity.myWeixin";
glHelpUtil.init(a);},_dealStyle:function(){$("#employee-alias-list").height($("body").height()-$(".rows-employee-list").offset().top-9);$(window).on("resize",function(){$("#employee-alias-list").height($("body").height()-$(".rows-employee-list").offset().top-9);
});},_loadEmployeeWeixin:function(){var a=this;FormUtils.loadData(AndroidContact._CONS_.FIND_EMPLOYEE_WEIXIN+"?type="+type+"&searchParam="+a.searchParam,function(c){var d=new StringBuffer();
if(type=="self"&&(a.searchParam==""||a.searchParam==null)){$(".rows-title").find("span").find("font").eq(1).empty().html(c.length+1);d.append("<li title='已关联' class='employee-alias-li' relate-flag='1' employee-alias=''>").append("<div class='employee-alias-img'><img onerror='onImageError();' class='avatar'  src='"+(currentUserProfile?(ctx+currentUserProfile):(ctx+"/img/jt/logos/t9-green.png"))+"'></div>").append("<span class='nickName'>已关联</span>");
d.append("</li>");}else{$(".rows-title").find("span").find("font").eq(1).empty().html(c.length);}for(var b=0;b<c.length;b++){d.append("<li title='"+c[b].nickName+"("+c[b].alias+")' relate-flag='0' class='employee-alias-li' employee-alias='"+c[b].userName+"'>").append("<div class='employee-alias-img'><img onerror='onImageError();' class='avatar'  src='"+ImageUtils.getTrueUrl(c[b].headImg)+"'></div>").append("<span class='nickName'>"+c[b].nickName+"</span>").append("<span class='wxCount'>"+c[b].alias+"</span>");
d.append("</li>");}$("#employee-alias-list").empty().append(d.toString());$("#employee-alias-list").find("li:eq(0)").trigger("click");$(".employee-alias-img").children("img").each(function(f,g){$(this).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,65));
});});});},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";FormUtils.loadData(b,function(c){if(c.length>0){var f=new StringBuffer();
var e=new StringBuffer();f.append("<option value=''>请选择</button>");for(var d=0;d<c.length;d++){f.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");
e.append("<option value='"+c[d].value+"'>"+c[d].value+"</button>");}$("#wx-msg-target").empty().append(f.toString());$("#wx-label").empty().append(f.toString());
a.msgTagDatas=c;$("#wxLabels").empty().append(e.toString());}});},_hideWxTypeBtn:function(){if(!ResUtils.canShow("wxChat.button.sub")&&!ResUtils.canShow("wxChat.button.self")){$("#selfChat").hide();
$("#subChat").hide();return false;}if(!ResUtils.canShow("wxChat.button.self")){$("#selfChat").remove();$("#subChat").css("float","left");$("#subChat").trigger("click");
}if(!ResUtils.canShow("wxChat.button.sub")){$("#subChat").remove();$("#selfChat").css("float","left");$("#selfChat").trigger("click");}if(ResUtils.canShow("androidContact.button.viewWx")){this.hiddenAlias=false;
}else{this.hiddenAlias=true;}},_hideNotGrantBtn:function(){if(type=="self"){if(ResUtils.canShow("androidContact.button.viewWx")){$("#androidContactGrid").jqGrid("showCol","alias");
}else{$("#androidContactGrid").jqGrid("hideCol","alias");}if(ResUtils.canShow("androidContact.button.batchChangeLabel")){$(".batchChangeBtn").show();}else{$(".batchChangeBtn").hide();
}}else{if(ResUtils.canShow("androidContactSub.button.viewWxSub")){$("#androidContactGrid").jqGrid("showCol","alias");}else{$("#androidContactGrid").jqGrid("hideCol","alias");
}if(ResUtils.canShow("androidContactSub.button.batchChangeLabelSub")){$(".batchChangeBtn").show();}else{$(".batchChangeBtn").hide();}}},_bindEventHander:function(){var a=this;
$(".jt-mywx-tab").children("li.tabLi").on("click",function(){$(this).addClass("active");$(this).siblings().removeClass("active");});$("#employeeAliasInput").on("keypress",function(b){if(b.keyCode=="13"){var c=$("#employeeAliasInput").val();
a.searchParam=c;a._loadEmployeeWeixin();}});$("#selfChat").on("click",function(){a.isRelated="y";type="self";a._hideNotGrantBtn();a._loadEmployeeWeixin();
});$("#subChat").on("click",function(){a.isRelated="";type="sub";a._hideNotGrantBtn();a._loadEmployeeWeixin();});$(document).on("click",".employee-alias-li",function(){$(".employee-alias-li").removeClass("on");
$(this).addClass("on");var b=$(this).attr("employee-alias");a.employeeWeixin=b;var d=$(this).attr("relate-flag");a.isRelated=d==1?"y":"";if(a.hadInitJQgrid){var c=$("#androidContactSearchForm").serialize()+"&isRelated="+a.isRelated+"&employeeWeixin="+a.employeeWeixin;
a.reloadJqgrid(c);}else{a._initJqgrid();}});$(".androidContactSearch").on("click",function(){var b=$("#androidContactSearchForm").serialize()+"&isRelated="+a.isRelated+"&employeeWeixin="+a.employeeWeixin;
a.reloadJqgrid(b);});$("#androidContactSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".androidContactSearch").trigger("click");}});$(".setRepeatBtn").on("click",function(){var b=$(AndroidContact._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}DialogUtils.confirmWithOptions({title:"确定将选中的好友标记为重粉？",text:"",confirmButtonText:"确定",yesFunc:function(){a._setRepeat(b);
}});});$(".unSetRepeatBtn").on("click",function(){var b=$(AndroidContact._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}DialogUtils.confirmWithOptions({title:"确定将选中的好友取消重粉标记？",text:"",confirmButtonText:"确定",yesFunc:function(){a._unSetRepeat(b);}});});$(".batchChangeBtn").on("click",function(){var b=$(AndroidContact._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要打标签的记录");return;}a._showWxlabelsPane(b);});$(document).on("click",".csTab",function(){var b=$(this).attr("idval");
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detailByCode.htm"+"?csCode="+b,"客户明细");});$(document).on("click","#clearSearchBtn",function(){$("#androidContactSearchForm").find("input").val("");
$("#androidContactSearchForm").find("select option:first").prop("selected","selected");$("#extIsRepeat").find("option:first").prop("selected","selected");
$("#wx-msg-target").find("option:first").prop("selected","selected");$("#isRepeat option[value='']").removeAttr("selected");$("#isRepeat option[value='']").attr("selected","selected");
$("#wx-label option[value='']").removeAttr("selected");$("#wx-label option[value='']").attr("selected","selected");});},_showWxlabelsPane:function(b){var a=this;
layer.open({type:1,title:"打标签",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["400px","400px"],content:$(".jt-wx-label-pane"),success:function(c,d){$("#wxLabels").chosen("destroy").chosen();
$("#wxLabels").val("");$("#wxLabels").trigger("chosen:updated");},yes:function(d,c){var e=$("#wxLabels").val();layer.close(d);DialogUtils.confirmWithOptions({title:"确定将选中的好友打标签吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._batchChangeLabels(b,e);
}});},cancel:function(){}});},_batchChangeLabels:function(b,c){var a=AndroidContact._CONS_.BATCH_CHANGE_LABEL;FormUtils.submit(a,{"ids":b,labels:c},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
$(".androidContactSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_setRepeat:function(a){var b=AndroidContact._CONS_.SET_REPEAT_URL;
FormUtils.submit(b,{"ids":a},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);$(".androidContactSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}});},_unSetRepeat:function(a){var b=AndroidContact._CONS_.UN_SET_REPEAT_URL;FormUtils.submit(b,{"ids":a},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);
$(".androidContactSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(AndroidContact._CONS_.GRID,a);
},_initJqgrid:function(d){var b=this;if(d==null||typeof d==undefined){d={};}var c=$(document).width();var a=30;if(c<=1280){a=50;}d.employeeWeixin=b.employeeWeixin;
d.isRelated=b.isRelated;b.hadInitJQgrid=true;$(AndroidContact._CONS_.GRID).JTJqgrid({url:AndroidContact._CONS_.LIST_DATA_URL+"?sord=asc&sidx=wx.create_time_&Q__S__EQ__wx.new_type_=friend&hiddenAlias="+this.hiddenAlias+"&needBelong=y",pager:AndroidContact._CONS_.PAGER,postData:d,colNames:["userName","头像","备注","客户编号","归属员工","状态","微信号","员工微信号","员工","类型","重","重粉备注","微信标签","系统标签"],colModel:[{name:"userName",index:"user_name_",width:80,hidden:true},{name:"userAvatarSmall",index:"user_avatar_small_",width:a,formatter:function(e,f,g){return"<img onerror='onImageError();' style='display: inline; height:35px;' src='"+ImageUtils.getTrueUrl(e)+"'></img>";
}},{name:"conRemark",index:"wx.con_remark_",width:80},{name:"friendCode",index:"ext.friend_code_",width:80,formatter:function(e,f,g){return"<a class='csTab' style='font-weight:bold;' idVal='"+e+"'>"+e+"</a>";
}},{name:"belongEmployeeName",index:"ext.friend_code_",sortable:false,width:80,formatter:function(e,f,g){if(e!=""&&e!=null){return g.belongEmployeeAid+":"+e;
}else{return"";}}},{name:"status",index:"employee.status_",width:40,formatter:function(e,f,g){if(e==2){return"在线";}else{return"离线";}}},{name:"alias",index:"wx.alias_",width:80,hidden:this.hiddenAlias},{name:"employeeWeixin",index:"employee.alias_",width:80},{name:"employeeName",index:"employee.employee_id_",width:80},{name:"type",index:"type_",width:30,formatter:function(e){if(e==2){return"群";
}else{return"好友";}}},{name:"isRepeat",index:"ext.is_repeat_",width:20,formatter:function(e,f,g){if(e==1){return"<label style='color:red'>是</label>";}else{return"否";
}}},{name:"repeatComment",index:"repeatComment",sortable:false,width:100,formatter:function(e,f,h){var g="";if(e.length>0){e=e.replaceAll(";","<br/>");
g='<span style="color: rgb(26, 179, 148);" data-html="true" class="fa fa-bell" data-toggle="tooltip" data-placement="right" data-original-title="<p align=\'left\'>'+e+'</p>"></span>';
}return g;}},{name:"wxLabel",index:"wx_label_",width:80},{name:"label",index:"label_",width:80}]});},};function imgStyle(b,c,a){if(b>c){return"height:100% !important;left:-"+(a*(1-(c/b)))/2+"px;width:auto !important;";
}else{if(b==c){return null;}else{if(b<c){return"top:-"+(a*(1-(b/c)))/2+"px;";}}}}