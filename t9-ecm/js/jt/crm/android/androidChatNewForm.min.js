$(function(){});function WeiXinChatForm(b){this.csInfo={};this.goToTop=false;this.audio=null;var a=new Date();this.oneToOne=false;a.setDate(a.getDate()-7);
this.record={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59"};
this.history={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59",contentSearchParam:"",isSign:"",contentType:"",createTime:""};
this.audioEndTime=null;this.lastChatTime="";this.textAreaPostion=0;this.weixinTextarea=new WeixinTextarea();this.solr={page:1,total:0,rows:5};}WeiXinChatForm._CONS_={LIST_RECODE_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm",RECODE_SEND_URL:ctx+"/crm/cs/weiXinRecord/saveAndroid.htm",SET_SIGN_URL:ctx+"/crm/cs/weiXinRecord/setSign.htm",LIST_BEFORE_AFTER_URL:ctx+"/crm/cs/weiXinRecord/findBeforeAndAfter.htm",SAVE_LABEL_URL:ctx+"/crm/android/saveLabel.htm",ADD_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/addFriend.htm",BACK_MSG_URL:ctx+"/crm/cs/weiXinRecord/backAndroidMsg.htm",FIND_FACE_IMAGES_URL:ctx+"/crm/cs/weiXinChat/findMyImage.htm",COLLECTION_IMG_URL:ctx+"/crm/cs/weiXinChat/collectionImage.htm",DELETE_COLLECTION_URL:ctx+"/crm/cs/weiXinChat/deleteCollection.htm",READ_AUDIO_URL:ctx+"/crm/cs/weiXinRecord/readAndroidAudio.htm",FIND_COM_LAN_URL:ctx+"/crm/cs/weixinCommonLan/findByUserId.htm",RESEND_MSG_URL:ctx+"/crm/cs/weiXinRecord/reSendAndroidMsg.htm",STATUS_NOTIFY_URL:ctx+"/gl/cs/weiXinFriends/statusNotify.htm",CLEAR_UNREAD_URL:ctx+"/gl/cs/weiXinFriends/clearUnread.htm",ADD_CONTACT_URL:ctx+"/crm/android/addContact.htm",TAKE_TRANSFER_URL:ctx+"/crm/android/takeTransfer.htm",UPLOAD_PARAMS:{"acceptTypes":".*","mimeTypes":".*","fileSingleSizeLimit":50*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
WeiXinChatForm.prototype={init:function(c){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantedBtn();this._initWxlabel();this._bindWebuploader();
this._initFaceImages();this._initCommonLan();this.weixinTextarea.init({container:"#chat-textarea"});var b=new Clipboard(".jt-copy-content");var a=new Solr({layerId:"weixin-solr-layer",click:".chat-solr",key:function(){return $(".current-solr").prev().text();
},setTop:function(){if(maxIndex){return(++maxIndex);}}});a.init();}},_hideNotGrantedBtn:function(){if(!ResUtils.canShow("android.button.placeOrder")){$("#jt-cs-placeOrder").remove();
}if(!ResUtils.canShow("android.button.addFollow")){$(".jt-cs-addFollow").remove();}if(!ResUtils.canShow("android.button.rebind")){$("#jt-rebind-cs").remove();
}if(!ResUtils.canShow("android.button.changeRemark")){$("#jt-wx-change-remark").remove();}if(!ResUtils.canShow("android.button.bindCs")){$("#jt-bind-cs").remove();
}if(!ResUtils.canShow("android.button.addCs")){$("#jt-add-cs").remove();}if(!ResUtils.canShow("android.button.addCsPlace")){$("#jt-add-cs-place").remove();
}if(!ResUtils.canShow("android.button.addContact")){$("#jt-add-contact").remove();}if(!ResUtils.canShow("android.button.addCsBatch")){$("#jt-add-cs-batch").remove();
}if(!ResUtils.canShow("android.button.batcSend")){$("#jt-weixin-barch-send").remove();}if(!ResUtils.canShow("android.button.refreshContacts")){$("#jt-refresh-contacts").remove();
}},_bindWebuploader:function(){var b=this;function c(g,f){if(f.flag){var h={path:f.localPath,name:f.fileName,size:g.size};b._beforeSendFile(h);}}function a(f,g){alert("上传"+f.name+"失败，原因是"+g);
}function d(){}var e=new JTWebUploader({config:WeiXinChatForm._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：.xls格式文件，单个文件最大为1MB",success:c,error:a,finish:d,auto:true});
e.init();},_beforeSendFile:function(b){var a=this;var c=ctx+b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='width:55px;height:66px;' type-value='1' src='"+c+"' class='jt-lager-img'>";
}else{if(c.indexOf(".mp4")!=-1||c.indexOf(".MP4")!=-1){d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='8'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";
}else{d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='7'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";}}$("#chat-textarea").append(d);
a._bindWebuploader();},initChat:function(a){this.lastChatTime="";$("#chat-textarea").attr("contenteditable",true);$(".jt-weixin-sendMsgBtn").attr("disabled",false);
$(".web_wechat_face").removeClass("disabled");$(".web_wechat_image").removeClass("disabled");$(".web_wechat_pic").removeClass("disabled");$(".jt-wx-label").removeClass("jt-wx-label-selected");
$(".jt-wx-label-div").show();if(!a){$("#send-msg-div").show();$("#send-msg-btn-div").hide();$(".m-message").show();$(".m-detail").hide();this.loadRecord(true);
}else{$(".m-message").hide();$(".m-detail").show();$("#send-msg-div").hide();$("#send-msg-btn-div").show();}this._selectWxLabel();this._hideFaceDiv();this._hideImageDiv();
this._hideComLanDiv();$("#chat-textarea").empty().focus();this._dealStyle();this._setSearchDate();},_showFaceDiv:function(){$("#jt-wx-face-div").show();
$("#jt-wx-face-div").css({top:"-260px",left:"20px"});$(".web_wechat_face").addClass("on");},_hideFaceDiv:function(){$("#jt-wx-face-div").hide();$(".web_wechat_face").removeClass("on");
},_showImageDiv:function(){$("#jt-wx-image-div").show();$("#jt-wx-image-div").css({top:"-272px",left:"20px"});$(".web_wechat_image").addClass("on");},_hideImageDiv:function(){$("#jt-wx-image-div").hide();
$(".web_wechat_image").removeClass("on");},_showComLanDiv:function(){$("#jt-wx-common-lan-div").show();$("#jt-wx-common-lan-div").css({top:"-272px",left:"20px"});
$(".web_wechat_common_lan").addClass("on");},_hideComLanDiv:function(){$("#jt-wx-common-lan-div").hide();$(".web_wechat_common_lan").removeClass("on");
},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";FormUtils.loadData(b,function(c){if(c.length>0){var f=new StringBuffer();
for(var e=0;e<c.length;e++){f.append("<button class='btn btn-sm btn-info btn-outline jt-wx-label' >"+c[e].value+"</button>");}$(".jt-wx-label-div").css({height:"34px"});
$(".jt-wx-label-div").empty().append(f.toString());if($(".batch-send-label-div").length>0){var d=new StringBuffer();for(var e=0;e<c.length;e++){d.append("<label class='btn btn-sm btn-info btn-outline batch-send-label' >"+c[e].value+"</label>");
}$(".batch-send-label-div").empty().append(d.toString());}a._dealStyle();}});},_setSearchDate:function(){var a=new Date();a.setDate(a.getDate()-7);this.history.startDate=DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00";
this.history.endDate=DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59";this.history.page=1;this.history.status=false;this.history.contentSearchParam="";
this.history.isSign="";this.history.contentType="";$("input[name='startDate']").val(this.history.startDate);$("input[name='endDate']").val(this.history.endDate);
$("input[name='contentSearchParam']").val("");},_dealStyle:function(){var a=$(".chat-history").height()-$(".history-search-button-div").outerHeight()-$(".history-search-param-div").outerHeight()-20;
var b=$(".main-hide").height()-$("#chat-person-div").height()-$("#send-msg-div").height()-20;},recordResize:function(){},_showAddContactLayer:function(b){var a=this;
layer.open({type:1,title:"添加好友",type:1,shade:false,btn:["确定","取消"],area:["400px","300px"],content:$(".jt-wx-add-contact-pane"),success:function(c,d){$("#addContactForm").find("input[name='alias']").val("");
if(b){$("#addContactForm").find("input[name='alias']").val(b);}},yes:function(d,c){a._addContact(d);},cancel:function(){}});},_addContact:function(b){var a=WeiXinChatForm._CONS_.ADD_CONTACT_URL;
var c={employeeAlias:$("#employeeWeiXins").val(),alias:$("#addContactForm input[name='alias']").val(),remark:$("#addContactForm input[name='remark']").val(),sendWords:$("#addContactForm input[name='sendWords']").val(),};
FormUtils.submit(a,c,function(d){DialogUtils.success("提示","申请添加好友成功!");layer.close(b);},function(){DialogUtils.error("错误","后台异常，请稍后重试");});},_bindEventHander:function(){var b=this;
window.onmessage=function(d){var c=JSON.parse(d.data);$("#jt-reciver-msg").val(d.data);if(c&&c.messageType=="androidMsg"){$("#jt-weixin-reciverBtn").trigger("click");
$("#jt-weixin-reciverBtn2").trigger("click");}else{if(c&&c.messageType=="newFriends"){$("#jt-weixin-newFriend").trigger("click");}else{if(c&&c.messageType=="applyFriends"){$("#jt-weixin-newFriend").trigger("click");
}else{if(c&&c.messageType=="reloadAndroid"){$("#jt-weixin-reloadWx").val("");$("#jt-weixin-reloadBtn").trigger("click");}else{if(c&&c.messageType=="deleteContact"){$("#jt-weixin-reloadWx").val(c.employeeAlias);
$("#jt-weixin-reloadBtn").trigger("click");}else{if(c&&c.messageType=="revorkMsg"){$("#"+c.id).find(".msg-revoke").empty().append("撤");}}}}}}};$("#jt-add-contact").on("click",function(){b._showAddContactLayer();
});$(document).on("click",".jt-video",function(){var c=$(this).attr("src-data");WeiXinUtil.showPlayVideotLayer(c);});$(document).on("click",".layui-layer-close",function(){var c=$(this).parents(".layui-layer-page").find("#jt-wx-video");
if(c.length>0){$("#jt-wx-video").trigger("pause");}});$(window).on("resize",function(){b._dealStyle();});$(document).on("keydown","#chat-textarea",function(c){var d=$(this).val();
if(c.keyCode==13){if(!c.ctrlKey){b.send();}}});$("body").on("click","#chat-textarea",function(){b._hideFaceDiv();b._hideImageDiv();b._hideComLanDiv();});
$(document).on("click",".jt-weixin-sendMsgBtn",function(){b.send();});$(".m-message").scroll(function(){var c=$(this).scrollTop();if(c<10&&b.record.status&&b.record.page<b.record.total){b.record.status=false;
b.record.page=b.record.page+1;b.loadRecord();}});$(".history-message-box").scroll(function(){var c=$(this).scrollTop();if(c<10&&b.history.status&&b.history.page<b.history.total){b.history.status=false;
b.history.page=b.history.page+1;b._loatRecordHistory();}});$(document).on("click","#jt-weixin-reciverBtn",function(){var d=$("#jt-reciver-msg").val();var e=JSON.parse(d);
if(e.employeeAlias!=b.csInfo.employeeAlias){return;}var g=b._getId(e.userName);var f=$("#jt-chat-"+g);if(f&&f.length>0){if($("#"+e.id).length>0&&e.type=="out"){if(e.status!=2){$("#"+e.id).find(".web_wechat_message_fail").remove();
}else{if($("#"+e.id).find(".web_wechat_message_fail").length<=0){$("#"+e.id).find(".text").prepend("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+e.id+"' create-time='"+e.createTime+"'></i>");
}}}else{$(".m-message").find("ul").append(b._getChartLi(e));b.imgResize();b._gotoBottom();}if(b.oneToOne&&e.type=="in"){b._removeNotRead();var c=parseInt($("#wxMsgCount",parent.document).text());
c-=1;$("#wxMsgCount",parent.document).empty().append(c);if(c==0){$("#wxMsgCount",parent.document).removeClass("blink");}}}if(e.contentType==2||e.contentType=="2"){b._setDuration();
}});$(document).on("click",".jt-audio",function(){var e=$(this);if(b.audio&&b.audio!=null){b.audio.pause();$(".jt-audio").find("i").css({"background-position":"-4px center"});
clearInterval(b.audioEndTime);clearInterval(b.timer_);}var f=e.find("i").attr("src-value");if(!e.find("audio").attr("src")){e.find("audio").attr("src",f);
e.find("audio")[0].load();}var h=$(this).attr("id-value");var g=$(this).attr("createtime");if($(this).find(".web_wechat_noread").length>0){b._readAudio(h,g);
}if(!e.find("span").is(".is-ready")){e.find("span").addClass("is-ready").empty().append("加载中...");}var d=-4,c=0;b.audioEndTime=setInterval(function(){if(e.find("audio")[0].readyState){b.audio=e.find("audio")[0];
e.find("span").empty().append(e.find("audio")[0].duration.toFixed(1)+"''");e.find("audio")[0].play();clearInterval(b.audioEndTime);b.timer_=setInterval(function(){d-=18;
e.find("i").css({"background-position":d+"px center"});if(d==-58){d=14;}if(e.find("audio")[0].ended){clearInterval(b.timer_);e.find("i").css({"background-position":"-4px center"});
b.audio=null;}},500);}if(c/(1000*60)>=5){clearInterval(timer);b.playing=null;}c+=500;},500);});$(document).on("click",".translateToWord",function(f){console.log("===click translate");
f.preventDefault();f.stopPropagation();var e=$(this);var h=e.attr("title");if(h!="点击？翻译"){return;}if($(this).attr("hasClick")){DialogUtils.warn(msgCode.WARN_MSG,"请勿重复点击翻译!");
return;}$(this).attr("hasClick",true);var c="xunfei";var d=$(this).attr("idVal");var i=$(this).attr("createTime");var g={voiceId:d,platform:c,createTime:i};
FormUtils.submit(ctx+"/crm/android/voiceTranslate2Word.htm",g,function(j){if(j.success){DialogUtils.success(msgCode.INFO,j.msg);if(j.msg!="已提交到后台任务"){e.attr("title",j.msg);
e.text("！");e.css("cursor","copy");}}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},null,false);});$(document).on("click",".weixinAudio",function(d){if($(d.target).hasClass("download-file")){return;
}var e=$(this);if(b.audio&&b.audio!=null){b.audio.pause();$(".audio_area").removeClass("playing");clearTimeout(b.audioEndTime);}b.audio=e.find(".media")[0];
e.find(".audio_area").addClass("playing");var c=b.audio.duration;b.audio.currentTime=0;b.audio.play();var g=$(this).attr("id-value");var f=$(this).attr("createtime");
if($(this).find(".web_wechat_noread").length>0){b._readAudio(g,f);}b.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");var l=$(".weixinAudio");
var k=new Date(f);for(var j=0;j<l.length;j++){var h=new Date($(l[j]).attr("createtime"));if(k.getTime()<h.getTime()&&$(l[j]).find(".web_wechat_noread").length>0){$(l[j]).trigger("click");
break;}}},c*1000);});$(document).on("click",".wx-transfer-take",function(){var c=$(this).attr("data-json_msg");b._takeTransfer(c);});$(document).on("mouseenter",".jt-lager-img",function(){var c=$(this).attr("src");
var d=$(this).attr("big-src");$(this).attr("src",d);$(this).attr("big-src",c);});$(document).on("mouseout",".jt-lager-img",function(){var c=$(this).attr("src");
var d=$(this).attr("big-src");$(this).attr("src",d);$(this).attr("big-src",c);});$(document).on("click",".jt-weixin-history",function(){var c=$("body").height();
if(c<600){c=c*0.9;}else{c=600;}b.recordLayer=layer.open({type:1,title:"聊天记录",shade:false,area:["650px",c+"px"],offset:"5%",content:$(".jt-new-weixin-record-pane"),scrollbar:true,success:function(d,e){$("#recordAllTabLi").trigger("click");
$(".record-history-tab li").removeClass("active");$("#recordAllTabLi").addClass("active");},yes:function(e,d){}});});$(document).on("click",".record-history-tab li",function(){var c=$(this).attr("data-contentType");
b.history.contentType=c;$(".search-history-btn").trigger("click");});$(document).on("click",".search-history-btn",function(){b.history.page=1;b.history.status=false;
b.history.startDate=$("input[name='startDate']").val();b.history.endDate=$("input[name='endDate']").val();b.history.contentSearchParam=$("input[name='contentSearchParam']").val();
b._loatRecordHistory(true);});$(document).on("click",".clear-history-btn",function(){$("input[name='contentSearchParam']").val("");});$(document).on("click",".jt-lager-img",function(d){d.stopPropagation();
var c=$(this).attr("src");var e="大图";$.fancybox.open([{href:c,title:e}]);});$(document).on("click",".show-before-and-after",function(){var d=$(this).attr("createTime");
var c=$(this).attr("id-value");b.history.createTime=d;b._loadBeforeAndAfter(c);});$(document).on("click",".prePage",function(){var c=$("input[name='startDate']").val();
var d=$("input[name='endDate']").val();$("input[name='startDate']").val(DateUtils.getBeforeDate(7,c)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getBeforeDate(7,d)+" 23:59:59");
$(".search-history-btn").trigger("click");$(this).blur();});$(document).on("click",".nextPage",function(){var c=$("input[name='startDate']").val();var d=$("input[name='endDate']").val();
$("input[name='startDate']").val(DateUtils.getAfterDate(7,c)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getAfterDate(7,d)+" 23:59:59");$(".search-history-btn").trigger("click");
$(this).blur();});$(".jt-wx-label-div").on("mouseenter",function(){$(this).css({height:"auto"});b._dealStyle();}).on("mouseleave",function(){$(this).css({height:"34px"});
b._dealStyle();b._saveWxLabel();});$(document).on("click",".jt-wx-label",function(){if($(this).hasClass("jt-wx-label-selected")){$(this).removeClass("jt-wx-label-selected");
}else{$(this).addClass("jt-wx-label-selected");}$(this).blur();});$(document).on("click",".add-new-friend",function(){var d=$(this).parents("li");var g=d.attr("id");
var c=d.find(".new-nick-name");var e=c.attr("user-name");var f=c.attr("verify-ticket");b._addNewWxFriend(g,e,f);});$("#wxHistorySearchForm").on("keyup",function(c){if(c.keyCode=="13"){$(".search-history-btn").trigger("click");
}});$("body").on("click",function(c){$("#my-image-button-div").hide();$("#image-button-div").hide();if(!$("#more-button-div").is(":hidden")&&!$(c.target).is(".glyphicon-cog")){$("#more-button-div").hide("fast");
}if(!$("#li-contextmenu").is(":hidden")){$("#li-contextmenu").hide("fast");}});$(".web_wechat_face").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){b._hideFaceDiv();}else{b._hideImageDiv();b._hideComLanDiv();b._showFaceDiv();}});$(".web_wechat_image").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){b._hideImageDiv();}else{b._hideFaceDiv();b._hideComLanDiv();b._showImageDiv();}});$(".web_wechat_common_lan").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){b._hideComLanDiv();}else{b._hideFaceDiv();b._hideImageDiv();b._showComLanDiv();}});$(document).on("click",".face",function(){if($(this).hasClass("conten-face")){return;
}var d=$(this).html();var c=$(this).attr("class");$("#chat-textarea").append(d);b._hideFaceDiv();});$(document).on("click",".jt-com-lan-p",function(){var c=$(this).text();
$("#chat-textarea").append(c);b._hideComLanDiv();});$(".web_wechat_pic").on("click",function(){if($(this).hasClass("disabled")){return false;}$("#filePicker").find(".webuploader-element-invisible").click();
});$("body").on("click",".download-file",function(){var c=$(this).attr("name-value");var d=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+c+"&durl="+d;
});$("body").on("contextmenu",".self",function(d){if($(this).hasClass("remove")){return false;}var h=$(this).find(".wx-set-star").attr("value");var g=$(this).find(".wx-set-star").attr("createtime");
$("#back-msg-id").val(h);$("#back-msg-createtime").val(g);$(".jt-copy-content").attr("data-clipboard-text",b._removeHtml($(this).find(".text").html()));
var c=d.pageX;var f=d.pageY;$("#msg-button-div").css({"top":f,"left":c});$("#msg-button-div").show();$("#image-button-div").hide();return false;});$("body").on("contextmenu",".main",function(d){var c=$(d.target);
if((c.hasClass("self")||c.parents("div").hasClass("self"))&&!(c.hasClass("remove")||c.parents("div").hasClass("remove"))){return;}else{$("#msg-button-div").hide();
}});$("body").on("contextmenu",".msg-image",function(f){var c=f.pageX;var i=f.pageY;var d=$(this).attr("src-value");$("#collection-img-url").val(d);$("#image-button-div").css({"top":i,"left":c});
$("#image-button-div").show();$("#msg-button-div").hide();if($(this).parents(".self").length>0){$("#image-button-div").find(".backmsg").show();var h=$(this).parents(".self").find(".wx-set-star").attr("value");
var g=$(this).parents(".self").find(".wx-set-star").attr("createtime");$("#back-msg-id").val(h);$("#back-msg-createtime").val(g);}else{$("#image-button-div").find(".backmsg").hide();
}return false;});$("body").on("contextmenu",".my-face-image",function(d){var c=d.pageX;var g=d.pageY;var f=$(this).attr("id");$("#collection-img-id").val(f);
$("#my-image-button-div").css({"top":g,"left":c});$("#my-image-button-div").show();return false;});$("body").on("click",".face-image",function(){var c=$(this).attr("src-value");
b._hideImageDiv();b._sendImg(c);});$("body").on("click",".m-message",function(){$("#msg-button-div").hide();});$("body").on("click",".backmsg",function(){$("#msg-button-div").hide();
b._backMsg();});$("body").on("click",".collection-img",function(){$("#image-button-div").hide();b._collectionImg();});$("body").on("click",".collection-img-delete",function(){$("#my-image-button-div").hide();
b._collectionImgDelete();});$("#jt-edit-con-lan").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weixinCommonLan/list.htm","我的常用语");});$(document).on("click",".web_wechat_message_fail",function(){var e=$(this).attr("id-val");
var d=$(this).attr("create-time");var c={employeeAlias:b.csInfo.employeeAlias,userName:b.csInfo.userName,id:e,createTime:d};b._reSend(c);});$(document).on("click",".jt-copy-content",function(c){$("#msg-button-div").hide();
});$(".jt-ziliao-img-weixin").hover(function(d){var c=$(document).width()-$(this).offset().left+2.5;var f=$(this).offset().top+5-$("body").height()*0.025;
$("#more-cs-info-div").css({"top":f,"right":c});$("#more-cs-info-div").stop().show("fast");},function(d){var c=$(document).width()-$(this).offset().left+2.5;
var f=$(this).offset().top+5-$("body").height()*0.025;$("#more-cs-info-div").css({"top":f,"right":c});$("#more-cs-info-div").stop().hide("fast");});$(".weixin-csinfo").on("dblclick",function(c){if(!$(this).is(".flipped")){$(this).addClass("flipped");
}else{$(this).removeClass("flipped");}});$("#more-cs-info-div").hover(function(c){$("#more-cs-info-div").stop(true,true).show();},function(c){$("#more-cs-info-div").stop().hide("fast");
});var a=document.getElementById("chat-textarea");a.ondragover=function(c){c.preventDefault();};a.ondrop=function(e){e.preventDefault();var d=e.dataTransfer.files;
if(d.length>0){for(var c=0;c<d.length;c++){if(d[c].size<=50*1024*1024){b._upload(d[c]);}else{DialogUtils.error(msgCode.ERROR,"只能上传小于50M的文件");}}}};},_upload:function(b){var a=this;
var c=new FormData();c.append("file",b);$.ajax({url:ctx+"/crm/components/upload/ajax.htm",type:"POST",data:c,contentType:false,processData:false,dataType:"json",success:function(d){var e={path:d.localPath,name:d.fileName,size:d.byteCount};
a._beforeSendFile(e);},error:function(){alert("上传失败！");}});},_removeHtml:function(a){a=a.replace(/<\/?[^>]*>/g,"");return a;},_removeNotRead:function(){FormUtils.submit(WeiXinChatForm._CONS_.CLEAR_UNREAD_URL,{friendCode:this.csInfo.csCode},function(a){},function(){},true);
if(!this.csInfo.hasInline){return false;}FormUtils.submit(WeiXinChatForm._CONS_.STATUS_NOTIFY_URL,{userName:this.csInfo.userName,empWx:this.csInfo.employeeAlias},function(a){},function(){},true);
},_readAudio:function(b,a){FormUtils.submit(WeiXinChatForm._CONS_.READ_AUDIO_URL,{id:b,createTime:a,userName:this.csInfo.userName,empWx:this.csInfo.employeeAlias},function(c){if(c.success){$("#"+b).find(".web_wechat_noread").remove();
if($("#history-"+b).length!=0){$("#history-"+b).find(".web_wechat_noread").remove();}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);
},_collectionImg:function(){var a=$("#collection-img-url").val();FormUtils.submit(WeiXinChatForm._CONS_.COLLECTION_IMG_URL,{path:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"收藏成功");
var c=JSON.parse(b.msg);$("#myCollecotionImagediv").prepend("<img id='"+c.id+"' class='my-face-image face-image' src-value='"+c.path+"' src='"+ImageUtils.getTrueUrl(c.path)+"'></img>");
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_collectionImgDelete:function(){var a=$("#collection-img-id").val();
FormUtils.submit(WeiXinChatForm._CONS_.DELETE_COLLECTION_URL,{id:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"删除成功");$("#"+a).remove();
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_backMsg:function(){var a=$("#back-msg-id").val();
FormUtils.submit(WeiXinChatForm._CONS_.BACK_MSG_URL,{id:a,employeeAlias:this.csInfo.employeeAlias,userName:this.csInfo.userName},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"消息撤回中");
$("#"+a).find(".main-li").addClass("remove");$("#"+a).find(".main-li").append("<span class='msg-revoke'>撤回中...</span>");}else{DialogUtils.error(msgCode.ERROR,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_addNewWxFriend:function(c,a,b){FormUtils.submit(WeiXinChatForm._CONS_.ADD_FRIEND_URL,{id:c,userName:a,verifyTicket:b},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,"添加成功");
$("#"+c).find(".add-new-friend").remove();}else{DialogUtils.error(msgCode.ERROR,"系统添加好友达到上限。请先用手机通过好友申请");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_saveWxLabel:function(){var f=$(".jt-wx-label-selected");var a="";for(var e=0;e<f.length;e++){if(e==f.length-1){a+=$(f[e]).text();}else{a+=$(f[e]).text()+",";
}}var h=a.split(",");var b=this.csInfo.wxLabel.split(",");if(h.length<=0&&b.length<=0){return;}var k=false;for(var e=0;e<h.length;e++){var d=false;for(var c=0;
c<b.length;c++){if(h[e]==b[c]){d=true;break;}}if(!d){k=true;break;}}var g=this;g.csInfo.wxLabel=a;if(k||h.length!=b.length){FormUtils.submit(WeiXinChatForm._CONS_.SAVE_LABEL_URL,{userName:g.csInfo.userName,employeeAlias:g.csInfo.employeeAlias,label:a},function(i){if(i.success){DialogUtils.success(msgCode.SUCCESS,"打标签成功");
}else{DialogUtils.error(msgCode.ERROR,i.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_takeTransfer:function(a){FormUtils.submit(WeiXinChatForm._CONS_.TAKE_TRANSFER_URL,{userName:this.csInfo.userName,employeeAlias:this.csInfo.employeeAlias,json_msg:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"收取成功");
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_selectWxLabel:function(){var a=this.csInfo.wxLabel;
if(!(a==null||a=="")){var b=$(".jt-wx-label");$.each(b,function(){if(a.indexOf($(this).text())!=-1){$(this).addClass("jt-wx-label-selected");}});}},_canSearch:function(){var b=true;
if(this.history.startDate==null||this.history.startDate==""){DialogUtils.error(msgCode.ERROR,"起始时间不能为空！");b=false;}else{if(this.history.endDate==null||this.history.endDate==""){var a=DateUtils.getDateDiff(this.history.startDate,DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"结束时间为空时起始时间距现在不能超过7天");b=false;}}else{var a=DateUtils.getDateDiff(this.history.startDate,this.history.endDate,"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"起始时间与结束时间不能超过7天");b=false;}}}return b;},_loadBeforeAndAfter:function(d){var b=this;if(!b._canSearch()){return false;
}var a=$(".history-message-box").find(".inner-div");a.empty();var c=WeiXinChatForm._CONS_.LIST_BEFORE_AFTER_URL+"?hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&Q__S__EQ__employee_alias_="+b.csInfo.employeeAlias+"&userName="+b.csInfo.userName+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&createTime="+this.history.createTime;
FormUtils.loadData(c,function(f){if(f&&f.length){var g=new StringBuffer();for(var e=f.length-1;e>=0;e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;
}else{f[e].headImgUrl=f[e].employeeHeadPic;}g.append(b._getHistoryLi(f[e]));}a.prepend(g.toString());$("#history-"+d).css({"background-color":"rgba(239, 199, 87, 0.35)","border":"1px solid #f8ac59"});
location.href="#history-"+d;}b.history.status=true;b._setDuration();});},_loatRecordHistory:function(d){var b=this;if(!b._canSearch()){return false;}var a=$(".history-message-box").find(".inner-div");
if(d){a.empty();}b.lastHistoryTime="";var c=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&Q__S__EQ__employee_alias_="+b.csInfo.employeeAlias+"&userName="+b.csInfo.userName+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_&"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&Q__S__EQ__is_sign_="+this.history.isSign+"&Q__S__LK__content_="+encodeURIComponent(this.history.contentSearchParam)+"&Q__S__IN__content_type_="+this.history.contentType;
FormUtils.loadData(c,function(h){var f=h.rows;b.history.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=a.height();for(var e=f.length-1;e>=0;
e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;}else{f[e].headImgUrl=(f[e].employeeHeadPic==""?ctx+"/img/jt/logos/t9.png":f[e].employeeHeadPic);
}j.append(b._getHistoryLi(f[e],true));}a.prepend(j.toString());if(d){$(".history-message-box").scrollTop($(".history-message-box")[0].scrollHeight);}else{g=a.height()-g;
$(".history-message-box").scrollTop(g);}}b.history.status=true;b._setDuration();});},loadRecord:function(d){var a=this;var c=$(".m-message").find("ul");
if(d){c.empty();}var b=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?isChat=true&hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&userName="+a.csInfo.userName+"&Q__S__EQ__employee_alias_="+a.csInfo.employeeAlias+"&page="+this.record.page+"&rows="+this.record.rows+"&sord=desc&sidx=create_time_";
FormUtils.loadData(b,function(h){var f=h.rows;a.record.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=$(".m-message").find("ul").height();
for(var e=f.length-1;e>=0;e--){j.append(a._getChartLi(f[e]));}c.prepend(j.toString());a.imgResize();if(d){a._gotoBottom();}else{g=$(".m-message").find("ul").height()-g;
$(".m-message").scrollTop(g);}}a.record.status=true;a._setDuration();if(a.record.total>a.record.page){$(".jt-more-record-div").show();}else{$(".jt-more-record-div").hide();
}},function(){},true);},_setDuration:function(){setTimeout(function(){var b=$(".not_duration");for(var a=0;a<b.length;a++){var c=$(b[a]).find(".media")[0];
var d=parseInt(c.duration);$(b[a]).removeClass("not_duration").find(".audio_length").empty().append(d+"''");$(b[a]).find(".audio_area").css({width:(70+2*d)+"px"});
}},300);},send:function(){var a=this;var c=a.weixinTextarea.getValue();$("#chat-textarea").empty();for(var b=0;b<c.length;b++){var d={content:encodeURIComponent(c[b].content),contentType:c[b].contentType,employeeId:currentUserId,userName:a.csInfo.userName,employeeAlias:a.csInfo.employeeAlias};
if(c[b].fileName){d.fileName=c[b].fileName;}if(c[b].fileSize){d.fileSize=c[b].fileSize;}a._sendFinal(d);}},_sendImg:function(c){var a=this;var b=new Date();
var d={content:c,contentType:4,employeeId:currentUserId,userName:a.csInfo.userName,employeeAlias:a.csInfo.employeeAlias};a._sendFinal(d);},_sendFinal:function(b){var a=this;
FormUtils.submit(WeiXinChatForm._CONS_.RECODE_SEND_URL,b,function(c){if(c.success){}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);},_reSend:function(b){var a=this;FormUtils.submit(WeiXinChatForm._CONS_.RESEND_MSG_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCESS,c.msg);
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_gotoBottom:function(){setTimeout(function(){$(".m-message").scrollTop($(".m-message")[0].scrollHeight);
},50);},_getChartLi:function(b){if(b.contentType==5){return"";}var c=false;if(this.lastChatTime==""){this.lastChatTime=b.createTime;c=true;}else{var d=DateUtils.getDateDiff(this.lastChatTime,b.createTime,"minute");
if(Math.abs(d)>=3){this.lastChatTime=b.createTime;c=true;}}var a=DateUtils.getDateDiff(b.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");
var e=new StringBuffer();e.append("<li id='"+b.id+"' >");if(c){if(Math.abs(a)<24){e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"HH:mm")+"</span></p>");
}else{e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"yyyy-MM-dd HH:mm")+"</span></p>");}}e.append("<div class='main-li "+(b.type=="out"?"self":"")+(b.status&&b.status==1?" remove'":"")+"'>");
e.append("<span type='checkbox' style='display:none;' value='"+b.id+"' createTime='"+b.createTime+"' class='glyphicon glyphicon-star wx-set-star "+(b.type=="out"?"wx-set-star-right ":"wx-set-star-left ")+(b.isSign=="y"?" wx-set-star-checked":"")+"'></span>");
if(b.type=="out"&&b.status==2){e.append("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+b.id+"' create-time='"+b.createTime+"'></i>");
}e.append("<img class='avatar' width='30' height='30' src='"+this._getHeadImgUrl(b)+"'>").append(this._isGroupMessage(b)).append("<div class='text "+(this._getSpacialColor(b))+(b.contentType==0?"weixin-pure-text":"")+"'>"+this._getMsgType(b)+"</div>"+WeiXinUtil.getIsRevoke(b));
if(b.type=="in"&&b.contentType==0){if(ResUtils.canShow("solr.button.weixin.entry")){e.append("<div class='chat-solr'><i class='fa fa-search'></i></div>");
}}e.append("</div></li>");return e.toString();},_getSpacialColor:function(a){if(a.contentType==7||a.contentType==4||a.contentType==1||a.contentType==2||a.contentType==9||a.contentType==8||a.contentType==10||a.contentType==11){return"text-spacial";
}else{return"";}},_getHistoryLi:function(d,a){if($("#history-"+d.id).length>0){return"";}var f=new StringBuffer();var e=false;if(this.lastHistoryTime==""){this.lastHistoryTime=DateUtils.format(new Date(d.createTime),"yyyy-MM-dd");
e=true;}else{var b=DateUtils.format(new Date(d.createTime),"yyyy-MM-dd");if(this.lastHistoryTime!=b){this.lastHistoryTime=b;e=true;}}var c=DateUtils.getDateDiff(d.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");
var f=new StringBuffer();if(e){f.append("<p class='time'><span>"+DateUtils.format(new Date(d.createTime),"yyyy-MM-dd")+"</span></p>");}f.append("<div id='history-"+d.id+"' >");
if(d.type=="out"){f.append("<p style='color:#1ab394'>"+(d.employeeAid+":"+d.employeeName)+"  "+DateUtils.format(new Date(d.createTime),"HH:mm"));}else{f.append("<p style='color:#0035ff'>"+(d.nickName)+"  "+DateUtils.format(new Date(d.createTime),"HH:mm"));
}f.append("</p>").append("<p class='history-text "+(this._getSpacialColor(d))+"'>"+(this._isSearch(a)?("<a class='show-before-and-after' id-value='"+d.id+"' createTime='"+d.createTime+"'>"+this._getMsgType(d,a)+"</a>"):this._getMsgType(d))).append(WeiXinUtil.getIsRevoke(d)).append("</p>").append("</div>");
return f.toString();},_getDateId:function(){},_isSearch:function(a){if(a&&!(this.history.isSign==""&&this.history.contentSearchParam=="")){return true;
}else{return false;}},_getMsgType:function(d,b){if(d.contentType==0||d.contentType=="0"){return WeiXinUtil.replaceFace(d.content);}else{if(d.contentType==1||d.contentType=="1"){var c=d.content.split(";");
if(c.length>1){return"<img style='width:120px;' src-value='"+d.content+"' class='jt-lager-img' src='"+ImageUtils.getTrueUrl(c[0])+"' big-src='"+ImageUtils.getTrueUrl(c[1])+"'>";
}else{return"<img style='width:120px;' src-value='"+d.content+"' class='jt-lager-img' src='"+ImageUtils.getTrueUrl(d.content)+"' big-src='"+ImageUtils.getTrueUrl(d.content)+"'>";
}}else{if(d.contentType==2||d.contentType=="2"){var a=ResUtils.canShow("android.button.translate");if(d.content&&d.content.indexOf("UploadedFile")!=-1){return WeiXinUtil.getAudioSpan(d,a);
}else{return d.content;}}else{if(d.contentType==4||d.contentType=="4"){return"<img style='width:80px;height:80px;' src-value='"+d.content+"' class='msg-image'  src='"+ImageUtils.getTrueUrl(d.content)+"' big-src='"+ImageUtils.getTrueUrl(d.content)+"'>";
}else{if(d.contentType==5||d.contentType=="5"){return WeiXinUtil.getNewFriendMsg2(d);}else{if(d.contentType==7||d.contentType=="7"){return WeiXinUtil.getFileMsg(d);
}else{if(d.contentType==8){return WeiXinUtil.getVideoMsg(d);}else{if(d.contentType==10){return WeiXinUtil.getNameCard(d);}else{if(d.contentType==12){return WeiXinUtil.getTransfer(d);
}else{if(b&&this.history.contentSearchParam!=""){return d.content.replaceAll(this.history.contentSearchParam,"<span style='background-color:yellow;'>"+this.history.contentSearchParam+"</span>");
}else{return d.content;}}}}}}}}}}},imgResize:function(){var a=this;$(".jt-lager-img").each(function(b,c){$(this).load(function(){$(this).attr("style",a.imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,150));
});});$(".msg-image").each(function(b,c){$(this).load(function(){$(this).attr("style",a.imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,120));
});});},imgStyle:function(b,c,a){if(b>c){if(b<=a){return"width:"+b+"px;";}else{return"width:"+a+"px;";}}else{if(b==c){if(b<=a){return"width:"+b+"px;";}else{return"width:"+a+"px;";
}}else{if(b<c){if(c<=a){return"height:"+c+"px;";}else{return"height:"+a+"px;";}}}}},_isGroupMessage:function(a){if(a.userName.indexOf("@chatroom")!=-1&&a.type=="in"){return"<div class='group-name'>"+a.nickName+"</div>";
}else{return"";}},_getHeadImgUrl:function(b){var a="";if(b.type=="in"){a=b.headPic!=null&&b.headPic!=""?b.headPic:this.csInfo.headImgUrl;}else{a=b.employeeHeadPic?b.employeeHeadPic:currentUserProfile;
if(a==""){a="/img/jt/logos/t9.png";}}if(a&&a.indexOf("http://")==-1&&a.indexOf(ctx)==-1){a=ctx+a;}return a;},_getId:function(a){if(a.indexOf("@")!=-1){a=a.replaceAll("@","-qun-");
}return a;},_initFaceImages:function(){var a=WeiXinChatForm._CONS_.FIND_FACE_IMAGES_URL;FormUtils.loadData(a,function(f){var d=f.myCollectImages;var c=f.systemImages;
var g=new StringBuffer();for(var b=0;b<d.length;b++){g.append("<img class='my-face-image face-image' id='"+d[b].id+"' src-value='"+d[b].path+"' src='"+ImageUtils.getTrueUrl(d[b].path)+"'></img>");
}$("#myCollecotionImagediv").empty().append(g.toString());var e=new StringBuffer();for(var b=0;b<c.length;b++){e.append("<img class='face-image' src-value='"+c[b].path+"'  src='"+ImageUtils.getTrueUrl(c[b].path)+"'></img>");
}$("#systemImagediv").empty().append(e.toString());});},_initCommonLan:function(){var a=WeiXinChatForm._CONS_.FIND_COM_LAN_URL;FormUtils.loadData(a,function(b){var d=new StringBuffer();
for(var c=0;c<b.length;c++){d.append("<p class='jt-com-lan-p'>"+b[c].content+"</p>");}$("#myComLandiv").empty().append(d.toString());});}};(function(n,p,u){var w=n([]),s=n.resize=n.extend(n.resize,{}),o,l="setTimeout",m="resize",t=m+"-special-event",v="delay",r="throttleWindow";
s[v]=250;s[r]=true;n.event.special[m]={setup:function(){if(!s[r]&&this[l]){return false;}var a=n(this);w=w.add(a);n.data(this,t,{w:a.width(),h:a.height()});
if(w.length===1){q();}},teardown:function(){if(!s[r]&&this[l]){return false;}var a=n(this);w=w.not(a);a.removeData(t);if(!w.length){clearTimeout(o);}},add:function(b){if(!s[r]&&this[l]){return false;
}var c;function a(d,h,g){var f=n(this),e=n.data(this,t);e.w=h!==u?h:f.width();e.h=g!==u?g:f.height();c.apply(this,arguments);}if(n.isFunction(b)){c=b;return a;
}else{c=b.handler;b.handler=a;}}};function q(){o=p[l](function(){w.each(function(){var d=n(this),a=d.width(),b=d.height(),c=n.data(this,t);if(a!==c.w||b!==c.h){d.trigger(m,[c.w=a,c.h=b]);
}});q();},s[v]);}})(jQuery,this);