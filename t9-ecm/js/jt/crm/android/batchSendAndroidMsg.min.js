$(function(){var a=new BatchSendWxMsg();a.init();});function BatchSendWxMsg(){this.hadInit=false;this.files=[];this.weixinTextarea=new WeixinTextarea();
}BatchSendWxMsg._CONS_={COUNT_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/countWxFriends.htm",BATCH_SEND_URL:ctx+"/crm/cs/weiXinRecord/batchSendAndroid.htm",FIND_FACE_IMAGES_URL:ctx+"/crm/cs/weiXinChat/findMyImage.htm",COLLECTION_IMG_URL:ctx+"/crm/cs/weiXinChat/collectionImage.htm",FIND_COM_LAN_URL:ctx+"/crm/cs/weixinCommonLan/findByUserId.htm",UPLOAD_PARAMS:{"acceptTypes":".*","mimeTypes":".*","fileSingleSizeLimit":10*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
BatchSendWxMsg.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantBtn();this._bindWebuploader();
this._initFaceImages();this._initCommonLan();this.weixinTextarea.init({container:"#batch-chat-textarea"});this._dealStyle();setTimeout(function(){$(".selectFirends").trigger("click");
},500);}},_dealStyle:function(){var a=$(".main-hide").height()-$("#chat-person-div").height()-$("#batch-send-label-div").height()-$(".m-text ").height()-$(".batch-send-person-num").height()-50;
$(".m-message").height(a);},_showFaceDiv:function(){$("#jt-wx-face-div").show();$("#jt-wx-face-div").css({top:"-272px",left:"20px"});$(".web_wechat_face").addClass("on");
},_hideFaceDiv:function(){$("#jt-wx-face-div").hide();$(".web_wechat_face").removeClass("on");},_showImageDiv:function(){$("#jt-wx-image-div").show();$("#jt-wx-image-div").css({top:"-272px",left:"20px"});
$(".web_wechat_image").addClass("on");},_hideImageDiv:function(){$("#jt-wx-image-div").hide();$(".web_wechat_image").removeClass("on");},_showComLanDiv:function(){$("#jt-wx-common-lan-div").show();
$("#jt-wx-common-lan-div").css({top:"-272px",left:"20px"});$(".web_wechat_common_lan").addClass("on");},_hideComLanDiv:function(){$("#jt-wx-common-lan-div").hide();
$(".web_wechat_common_lan").removeClass("on");},_hideNotGrantBtn:function(){},_bindEventHander:function(){var a=this;$(document).on("click",".jt-weixin-batch-sendMsgBtn",function(){a._send();
});$(document).on("keydown","#batch-chat-textarea",function(b){if(b.keyCode==13){if(!b.ctrlKey){a._send();}}});$(".web_wechat_face").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideFaceDiv();}else{a._hideImageDiv();a._hideComLanDiv();a._showFaceDiv();}});$(".web_wechat_image").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideImageDiv();}else{a._hideFaceDiv();a._hideComLanDiv();a._showImageDiv();}});$(".web_wechat_common_lan").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideComLanDiv();}else{a._hideFaceDiv();a._hideImageDiv();a._showComLanDiv();}});$(document).on("click",".face",function(){if($(this).hasClass("conten-face")){return;
}var b=$(this).html();$("#batch-chat-textarea").append(b);a._hideFaceDiv();});$(document).on("click",".jt-com-lan-p",function(){var b=$(this).text();$("#batch-chat-textarea").append(b);
a._hideComLanDiv();});$("body").on("click",".face-image",function(){var b=$(this).attr("src-value");a._hideImageDiv();a._sendImg(b);});$(".web_wechat_pic").on("click",function(){if($(this).hasClass("disabled")){return false;
}$("#filePicker").find(".webuploader-element-invisible").click();});$(".selectFirends").on("click",function(){var b=new WeiXinFriendsSelect();var c={isMultiple:1,type:"android",callBack:function(g){if(g!=null){if(g.length>0){var j=new StringBuffer();
var f=0;for(var d=0;d<g.length;d++){if($("#"+g[d].id).length<=0){j.append("<li id='"+g[d].id+"' data-remark='"+g[d].conRemark+"' data-username='"+g[d].userName+"' data.employeeAlias='"+g[d].employeeAlias+"'> ").append("<a href='javascript: void(0);'>").append(g[d].conRemark).append("&nbsp;&nbsp;").append("<button class='btn btn-danger btn-xs deleteFriendsBtn' type='button'><i class='fa fa-remove'></i></button>").append("</a></li>");
f++;}}var h=$("#selected-firends").val();var e=f+(h?parseInt(h):0);$("#selected-firends").val(e);$(".batch-send-person-num").empty().append("已选中【"+e+"】位好友");
$(".m-message").append(j.toString());}}}};b.init(c);});$(document).on("click",".deleteFriendsBtn",function(){var b=this;DialogUtils.confirmWithOptions({title:"确定删除？",text:"",confirmButtonText:"确定",yesFunc:function(){$(b).parents("li").remove();
var c=$("#selected-firends").val()-1;$("#selected-firends").val(c);$(".batch-send-person-num").empty().append("已选中【"+c+"】位好友");}});});$(document).on("click",".jt-lager-img",function(c){c.stopPropagation();
var b=$(this).attr("src");var d="大图";$.fancybox.open([{href:b,title:d}]);});},_bindWebuploader:function(){var b=this;b.files=[];function c(g,f){if(f.flag){var h={path:f.localPath,name:f.fileName,size:g.size};
b.files.push(h);b._beforeSendFile();}}function a(f,g){alert("上传"+f.name+"失败，原因是"+g);}function d(){}var e=new JTWebUploader({config:BatchSendWxMsg._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：.xls格式文件，单个文件最大为1MB",success:c,error:a,finish:d,auto:true});
e.init();},_beforeSendFile:function(){var a=this;var b=a.files[a.files.length-1];var c=ctx+b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='width:55px;height:66px;' type-value='1' src='"+c+"' class='jt-lager-img'>";
}else{if(c.indexOf(".mp4")!=-1||c.indexOf(".MP4")!=-1){d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='8'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";
}else{d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='7'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";}}$("#batch-chat-textarea").append(d);
a._bindWebuploader();},_send:function(){var a=this;var c=a.weixinTextarea.getValue();for(var b=0;b<c.length;b++){var d={content:encodeURIComponent(c[b].content),contentType:c[b].contentType,};
if(c[b].fileName){d.fileName=c[b].fileName;}if(c[b].fileSize){d.fileSize=c[b].fileSize;}a._sendFinal(d);}},_sendImg:function(b){var a=new Date();var c={content:b,contentType:4};
this._sendFinal(c);},_sendFinal:function(b){var a=this;b.ids=a._getIds();if(b.ids.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要群发的好友");return;}DialogUtils.confirmWithOptions({title:"确定给"+$("#selected-firends").val()+"位好友发送消息吗？",text:"",confirmButtonText:"确定",yesFunc:function(){FormUtils.submit(BatchSendWxMsg._CONS_.BATCH_SEND_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"消息发送中...");
$("#batch-chat-textarea").empty();JTTabUtils.showActiveTab(ctx+"/crm/android/newList.htm");JTTabUtils.closeTab(ctx+"/crm/android/batchSendAndroidMsg.htm");
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);}});},_getIds:function(){var c=$(".tag-list").find("li");
var b=[];for(var a=0;a<c.length;a++){b.push($(c[a]).attr("id"));}return b;},_initFaceImages:function(){var a=BatchSendWxMsg._CONS_.FIND_FACE_IMAGES_URL;
FormUtils.loadData(a,function(f){var d=f.myCollectImages;var c=f.systemImages;var g=new StringBuffer();for(var b=0;b<d.length;b++){g.append("<img class='my-face-image face-image' id='"+d[b].id+"' src-value='"+d[b].path+"' src='"+ImageUtils.getTrueUrl(d[b].path)+"'></img>");
}$("#myCollecotionImagediv").empty().append(g.toString());var e=new StringBuffer();for(var b=0;b<c.length;b++){e.append("<img class='face-image' src-value='"+c[b].path+"'  src='"+ImageUtils.getTrueUrl(c[b].path)+"'></img>");
}$("#systemImagediv").empty().append(e.toString());});},_initCommonLan:function(){var a=BatchSendWxMsg._CONS_.FIND_COM_LAN_URL;FormUtils.loadData(a,function(b){var d=new StringBuffer();
for(var c=0;c<b.length;c++){d.append("<p class='jt-com-lan-p'>"+b[c].content+"</p>");}$("#myComLandiv").empty().append(d.toString());});}};