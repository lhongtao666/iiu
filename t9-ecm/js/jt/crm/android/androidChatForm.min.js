function WeiXinChatForm(b){this.csInfo={};this.goToTop=false;this.audio=null;var a=new Date();this.oneToOne=false;a.setDate(a.getDate()-7);this.record={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59"};
this.history={page:1,total:0,rows:20,status:false,startDate:DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00",endDate:DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59",contentSearchParam:"",isSign:"",contentType:"",createTime:""};
this.audioEndTime=null;this.lastChatTime="";this.textAreaPostion=0;this.files=[];this.weixinTextarea=new WeixinTextarea();}WeiXinChatForm._CONS_={LIST_RECODE_DATA_URL:ctx+"/crm/cs/weiXinRecord/listData.htm",RECODE_SEND_URL:ctx+"/crm/cs/weiXinRecord/saveAndroid.htm",SET_SIGN_URL:ctx+"/crm/cs/weiXinRecord/setSign.htm",LIST_BEFORE_AFTER_URL:ctx+"/crm/cs/weiXinRecord/findBeforeAndAfter.htm",SAVE_LABEL_URL:ctx+"/crm/android/saveLabel.htm",ADD_FRIEND_URL:ctx+"/gl/cs/weiXinFriends/addFriend.htm",BACK_MSG_URL:ctx+"/crm/cs/weiXinRecord/backAndroidMsg.htm",FIND_FACE_IMAGES_URL:ctx+"/crm/cs/weiXinChat/findMyImage.htm",COLLECTION_IMG_URL:ctx+"/crm/cs/weiXinChat/collectionImage.htm",DELETE_COLLECTION_URL:ctx+"/crm/cs/weiXinChat/deleteCollection.htm",READ_AUDIO_URL:ctx+"/crm/cs/weiXinRecord/readAudio.htm",FIND_COM_LAN_URL:ctx+"/crm/cs/weixinCommonLan/findByUserId.htm",RESEND_MSG_URL:ctx+"/crm/cs/weiXinRecord/reSendMsg.htm",STATUS_NOTIFY_URL:ctx+"/gl/cs/weiXinFriends/statusNotify.htm",CLEAR_UNREAD_URL:ctx+"/gl/cs/weiXinFriends/clearUnread.htm",UPLOAD_PARAMS:{"acceptTypes":".*","mimeTypes":".*","fileSingleSizeLimit":10*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm"}};
WeiXinChatForm.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantedBtn();this._initWxlabel();this._bindWebuploader();
this._initFaceImages();this._initCommonLan();this.weixinTextarea.init({container:"#chat-textarea"});var a=new Clipboard(".jt-copy-content");}},_hideNotGrantedBtn:function(){if(!ResUtils.canShow("android.button.placeOrder")){$("#jt-cs-placeOrder").remove();
}if(!ResUtils.canShow("android.button.addFollow")){$("#jt-cs-addFollow").remove();}if(!ResUtils.canShow("android.button.rebind")){$("#jt-rebind-cs").remove();
}if(!ResUtils.canShow("android.button.changeRemark")){$("#jt-wx-change-remark").remove();}if(!ResUtils.canShow("android.button.bindCs")){$("#jt-bind-cs").remove();
}if(!ResUtils.canShow("android.button.addCs")){$("#jt-add-cs").remove();}if(!ResUtils.canShow("android.button.addCsPlace")){$("#jt-add-cs-place").remove();
}if(!ResUtils.canShow("android.button.addContact")){$("#jt-add-contact").remove();}if(!ResUtils.canShow("android.button.addCsBatch")){$("#jt-add-cs-batch").remove();
}if(!ResUtils.canShow("android.button.batcSend")){$("#jt-weixin-barch-send").remove();}},_bindWebuploader:function(){var b=this;b.files=[];function c(g,f){if(f.flag){var h={path:f.localPath,name:f.fileName,size:g.size};
b.files.push(h);b._beforeSendFile();}}function a(f,g){alert("上传"+f.name+"失败，原因是"+g);}function d(){}var e=new JTWebUploader({config:WeiXinChatForm._CONS_.UPLOAD_PARAMS,container:"uploader",caption:"支持上传：.xls格式文件，单个文件最大为1MB",success:c,error:a,finish:d,auto:true});
e.init();},_beforeSendFile:function(){var a=this;var b=a.files[a.files.length-1];var c=ctx+b.path;var d="";if(c.indexOf(".jpg")!=-1||c.indexOf(".gif")!=-1||c.indexOf(".bmp")!=-1||c.indexOf(".jpeg")!=-1||c.indexOf(".png")!=-1){d="<img style='width:55px;height:66px;' type-value='1' src='"+c+"' class='jt-lager-img'>";
}else{d="<img src='"+ImageUtils.getFileCoverUrl(c)+"' type-value='7'  file-path='"+b.path+"' file-name='"+b.name+"' file-size='"+b.size+"'>";}$("#chat-textarea").append(d);
a._bindWebuploader();},initChat:function(a){this.lastChatTime="";$("#chat-textarea").attr("contenteditable",true);$(".jt-weixin-sendMsgBtn").attr("disabled",false);
$(".web_wechat_face").removeClass("disabled");$(".web_wechat_image").removeClass("disabled");$(".web_wechat_pic").removeClass("disabled");$(".jt-wx-label").removeClass("jt-wx-label-selected");
$(".jt-wx-label-div").show();if(!a){$("#send-msg-div").show();$("#send-msg-btn-div").hide();$(".m-message").show();$(".m-detail").hide();this.loadRecord(true);
}else{$(".m-message").hide();$(".m-detail").show();$("#send-msg-div").hide();$("#send-msg-btn-div").show();}this._selectWxLabel();this._hideFaceDiv();this._hideImageDiv();
this._hideComLanDiv();$("#chat-textarea").empty().focus();this._dealStyle();},_showFaceDiv:function(){$("#jt-wx-face-div").show();$("#jt-wx-face-div").css({top:"-272px",left:"20px"});
$(".web_wechat_face").addClass("on");},_hideFaceDiv:function(){$("#jt-wx-face-div").hide();$(".web_wechat_face").removeClass("on");},_showImageDiv:function(){$("#jt-wx-image-div").show();
$("#jt-wx-image-div").css({top:"-272px",left:"20px"});$(".web_wechat_image").addClass("on");},_hideImageDiv:function(){$("#jt-wx-image-div").hide();$(".web_wechat_image").removeClass("on");
},_showComLanDiv:function(){$("#jt-wx-common-lan-div").show();$("#jt-wx-common-lan-div").css({top:"-272px",left:"20px"});$(".web_wechat_common_lan").addClass("on");
},_hideComLanDiv:function(){$("#jt-wx-common-lan-div").hide();$(".web_wechat_common_lan").removeClass("on");},_initWxlabel:function(){var a=this;var b=ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=weixinLabel";
FormUtils.loadData(b,function(c){if(c.length>0){var f=new StringBuffer();for(var e=0;e<c.length;e++){f.append("<button class='btn btn-sm btn-info btn-outline jt-wx-label' >"+c[e].value+"</button>");
}$(".jt-wx-label-div").css({height:"34px"});$(".jt-wx-label-div").empty().append(f.toString());if($(".batch-send-label-div").length>0){var d=new StringBuffer();
for(var e=0;e<c.length;e++){d.append("<label class='btn btn-sm btn-info btn-outline batch-send-label' >"+c[e].value+"</label>");}$(".batch-send-label-div").empty().append(d.toString());
}a._dealStyle();}});},_setSearchDate:function(){var a=new Date();a.setDate(a.getDate()-7);this.history.startDate=DateUtils.format(a,"yyyy-MM-dd")+" 00:00:00";
this.history.endDate=DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59";this.history.page=1;this.history.status=false;this.history.contentSearchParam="";
this.history.isSign="";this.history.contentType="";$("input[name='startDate']").val(this.history.startDate);$("input[name='endDate']").val(this.history.endDate);
$("input[name='contentType']")[0].checked=true;$("input[name='contentSearchParam']").val("");},_dealStyle:function(){var a=$(".chat-history").height()-$(".history-search-button-div").outerHeight()-$(".history-search-param-div").outerHeight()-20;
$(".history-message-box").height(a);var b=$(".main-hide").height()-$("#chat-person-div").height()-$("#send-msg-div").height()-20;$(".m-message").height(b);
},_bindEventHander:function(){var a=this;window.onmessage=function(c){var b=JSON.parse(c.data);$("#jt-reciver-msg").val(c.data);if(b&&b.messageType=="androidMsg"){$("#jt-weixin-reciverBtn").trigger("click");
$("#jt-weixin-reciverBtn2").trigger("click");}else{if(b&&b.messageType=="newFriends"){$("#jt-weixin-newFriend").trigger("click");}else{if(b&&b.messageType=="applyFriends"){$("#jt-weixin-reloadWx").val(b.employeeAlias);
$("#jt-weixin-reloadBtn").trigger("click");}else{if(b&&b.messageType=="reloadAndroid"){$("#jt-weixin-reloadWx").val("");$("#jt-weixin-reloadBtn").trigger("click");
}else{if(b&&b.messageType=="deleteContact"){$("#jt-weixin-reloadWx").val(b.employeeAlias);$("#jt-weixin-reloadBtn").trigger("click");}else{if(b&&b.messageType=="revorkMsg"){$("#"+b.id).find(".msg-revoke").empty().append("撤");
}}}}}}};$(window).on("resize",function(){a._dealStyle();});$(document).on("keydown","#chat-textarea",function(b){var c=$(this).val();if(b.keyCode==13){if(!b.ctrlKey){a.send();
}}});$("body").on("click","#chat-textarea",function(){a._hideFaceDiv();a._hideImageDiv();a._hideComLanDiv();});$(document).on("click",".jt-weixin-sendMsgBtn",function(){a.send();
});$(".m-message").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.record.status&&a.record.page<a.record.total){a.record.status=false;a.record.page=a.record.page+1;
a.loadRecord();}});$(".history-message-box").scroll(function(){var b=$(this).scrollTop();if(b<10&&a.history.status&&a.history.page<a.history.total){a.history.status=false;
a.history.page=a.history.page+1;a._loatRecordHistory();}});$(document).on("click","#jt-weixin-reciverBtn",function(){var c=$("#jt-reciver-msg").val();var d=JSON.parse(c);
if(d.employeeAlias!=a.csInfo.employeeAlias){return;}var f=a._getId(d.userName);var e=$("#jt-chat-"+f);if(e&&e.length>0){if($("#"+d.id).length>0&&d.type=="out"){if(d.status!=2){$("#"+d.id).find(".web_wechat_message_fail").remove();
}else{if($("#"+d.id).find(".web_wechat_message_fail").length<=0){$("#"+d.id).find(".text").prepend("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+d.id+"' create-time='"+d.createTime+"'></i>");
}}}else{$(".m-message").find("ul").append(a._getChartLi(d));a._gotoBottom();}if(a.oneToOne&&d.type=="in"){a._removeNotRead();var b=parseInt($("#wxMsgCount",parent.document).text());
b-=1;$("#wxMsgCount",parent.document).empty().append(b);if(b==0){$("#wxMsgCount",parent.document).removeClass("blink");}}}if(d.contentType==2||d.contentType=="2"){a._setDuration();
}});$(document).on("click",".weixinAudio",function(c){var d=$(this);if(a.audio&&a.audio!=null){a.audio.pause();$(".audio_area").removeClass("playing");
clearTimeout(a.audioEndTime);}a.audio=d.find(".media")[0];d.find(".audio_area").addClass("playing");var b=a.audio.duration;a.audio.currentTime=0;a.audio.play();
var f=$(this).attr("id-value");var e=$(this).attr("createtime");if($(this).find(".web_wechat_noread").length>0){a._readAudio(f,e);}a.audioEndTime=setTimeout(function(){$(".audio_area").removeClass("playing");
var k=$(".weixinAudio");var j=new Date(e);for(var h=0;h<k.length;h++){var g=new Date($(k[h]).attr("createtime"));if(j.getTime()<g.getTime()&&$(k[h]).find(".web_wechat_noread").length>0){$(k[h]).trigger("click");
break;}}},b*1000);});$(document).on("mouseenter",".jt-lager-img",function(){var b=$(this).attr("src");var c=$(this).attr("big-src");$(this).attr("src",c);
$(this).attr("big-src",b);});$(document).on("mouseout",".jt-lager-img",function(){var b=$(this).attr("src");var c=$(this).attr("big-src");$(this).attr("src",c);
$(this).attr("big-src",b);});$(document).on("click",".jt-weixin-history",function(){if($(".chat-history").is(":hidden")){var c=$("#chat").width();$(".chat-history").show();
$(".jt-weixin-history").addClass("on");if(window.innerWidth<=1200){$("#jt-employee-wx").hide();$(".chat-history").css({"width":"270px"});$(".main-hide").css({"width":"300px"});
$(".main-show").css({"width":"300px"});}else{if(window.innerWidth<=1440){$("#jt-employee-wx").hide();$(".chat-history").css({"width":"300px"});$(".main-hide").css({"width":"300px"});
$(".main-show").css({"width":"300px"});}else{$(".chat-history").css({"width":"400px"});$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});
}}if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"65%"});$(".chat-history").css({width:"35%"});}a._setSearchDate();a._loatRecordHistory(true);
}else{$("#jt-employee-wx").show();var c=$("#chat").width();if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});$(".main-hide").css({"width":"560px"});
$(".main-show").css({"width":"560px"});}else{$(".chat-history").css({"width":"300px"});$(".main-hide").css({"width":"680px"});$(".main-show").css({"width":"680px"});
}$(".chat-history").hide();$(".jt-weixin-history").removeClass("on");if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"100%"});}}var b=$(".chat-history").height()-$(".history-search-button-div").outerHeight()-$(".history-search-param-div").outerHeight()-20;
$(".history-message-box").height(b);});$(document).on("click",".jt-close-history",function(){$("#jt-employee-wx").show();var b=$("#chat").width();if(window.innerWidth<=1440){$(".chat-history").css({"width":"300px"});
$(".main-hide").css({"width":"560px"});$(".main-show").css({"width":"560px"});}else{$(".chat-history").css({"width":"300px"});$(".main-hide").css({"width":"680px"});
$(".main-show").css({"width":"680px"});}$(".chat-history").hide();$(".jt-weixin-history").removeClass("on");if($(".main-hide").hasClass("one-to-one")){$(".main-hide").css({width:"100%"});
}a._setSearchDate();});$(document).on("click",".search-history-btn",function(){a.history.page=1;a.history.status=false;a.history.startDate=$("input[name='startDate']").val();
a.history.endDate=$("input[name='endDate']").val();a.history.contentSearchParam=$("input[name='contentSearchParam']").val();a.history.contentType=$("input[name='contentType']:checked").val();
a._loatRecordHistory(true);});$(document).on("click",".jt-lager-img",function(c){c.stopPropagation();var b=$(this).attr("src");var d="大图";$.fancybox.open([{href:b,title:d}]);
});$(document).on("click",".show-before-and-after",function(){var c=$(this).attr("createTime");var b=$(this).attr("id-value");a.history.createTime=c;a._loadBeforeAndAfter(b);
});$(document).on("click",".prePage",function(){var b=$("input[name='startDate']").val();var c=$("input[name='endDate']").val();$("input[name='startDate']").val(DateUtils.getBeforeDate(7,b)+" 00:00:00");
$("input[name='endDate']").val(DateUtils.getBeforeDate(7,c)+" 23:59:59");$(".search-history-btn").trigger("click");$(this).blur();});$(document).on("click",".nextPage",function(){var b=$("input[name='startDate']").val();
var c=$("input[name='endDate']").val();$("input[name='startDate']").val(DateUtils.getAfterDate(7,b)+" 00:00:00");$("input[name='endDate']").val(DateUtils.getAfterDate(7,c)+" 23:59:59");
$(".search-history-btn").trigger("click");$(this).blur();});$(".jt-wx-label-div").on("mouseenter",function(){$(this).css({height:"auto"});a._dealStyle();
}).on("mouseleave",function(){$(this).css({height:"34px"});a._dealStyle();a._saveWxLabel();});$(document).on("click",".jt-wx-label",function(){if($(this).hasClass("jt-wx-label-selected")){$(this).removeClass("jt-wx-label-selected");
}else{if($(".jt-wx-label-selected").length>=3){DialogUtils.error(msgCode.ERROR,"最多选择3个标签");}else{$(this).addClass("jt-wx-label-selected");}}$(this).blur();
});$(document).on("click",".add-new-friend",function(){var c=$(this).parents("li");var f=c.attr("id");var b=c.find(".new-nick-name");var d=b.attr("user-name");
var e=b.attr("verify-ticket");a._addNewWxFriend(f,d,e);});$("#wxHistorySearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".search-history-btn").trigger("click");
}});$("body").on("click",function(){$("#my-image-button-div").hide();$("#image-button-div").hide();});$(".web_wechat_face").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideFaceDiv();}else{a._hideImageDiv();a._hideComLanDiv();a._showFaceDiv();}});$(".web_wechat_image").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideImageDiv();}else{a._hideFaceDiv();a._hideComLanDiv();a._showImageDiv();}});$(".web_wechat_common_lan").on("click",function(){if($(this).hasClass("disabled")){return false;
}if($(this).hasClass("on")){a._hideComLanDiv();}else{a._hideFaceDiv();a._hideImageDiv();a._showComLanDiv();}});$(document).on("click",".face",function(){if($(this).hasClass("conten-face")){return;
}var c=$(this).html();var b=$(this).attr("class");$("#chat-textarea").append(c);a._hideFaceDiv();});$(document).on("click",".jt-com-lan-p",function(){var b=$(this).text();
$("#chat-textarea").append(b);a._hideComLanDiv();});$(".web_wechat_pic").on("click",function(){if($(this).hasClass("disabled")){return false;}$("#filePicker").find(".webuploader-element-invisible").click();
});$("body").on("click",".download-file",function(){var b=$(this).attr("name-value");var c=$(this).attr("url-value");window.location.href=ctx+"/crm/components/upload/download.htm?dname="+b+"&durl="+c;
});$("body").on("contextmenu",".self",function(c){if($(this).hasClass("remove")){return false;}var g=$(this).find(".wx-set-star").attr("value");var f=$(this).find(".wx-set-star").attr("createtime");
$("#back-msg-id").val(g);$("#back-msg-createtime").val(f);$(".jt-copy-content").attr("data-clipboard-text",a._removeHtml($(this).find(".text").html()));
var b=c.pageX;var d=c.pageY;$("#msg-button-div").css({"top":d,"left":b});$("#msg-button-div").show();$("#image-button-div").hide();return false;});$("body").on("contextmenu",".main",function(c){var b=$(c.target);
if((b.hasClass("self")||b.parents("div").hasClass("self"))&&!(b.hasClass("remove")||b.parents("div").hasClass("remove"))){return;}else{$("#msg-button-div").hide();
}});$("body").on("contextmenu",".msg-image",function(d){var b=d.pageX;var h=d.pageY;var c=$(this).attr("src-value");$("#collection-img-url").val(c);$("#image-button-div").css({"top":h,"left":b});
$("#image-button-div").show();$("#msg-button-div").hide();if($(this).parents(".self").length>0){$("#image-button-div").find(".backmsg").show();var g=$(this).parents(".self").find(".wx-set-star").attr("value");
var f=$(this).parents(".self").find(".wx-set-star").attr("createtime");$("#back-msg-id").val(g);$("#back-msg-createtime").val(f);}else{$("#image-button-div").find(".backmsg").hide();
}return false;});$("body").on("contextmenu",".my-face-image",function(c){var b=c.pageX;var f=c.pageY;var d=$(this).attr("id");$("#collection-img-id").val(d);
$("#my-image-button-div").css({"top":f,"left":b});$("#my-image-button-div").show();return false;});$("body").on("click",".face-image",function(){var b=$(this).attr("src-value");
a._hideImageDiv();a._sendImg(b);});$("body").on("click",".m-message",function(){$("#msg-button-div").hide();});$("body").on("click",".backmsg",function(){$("#msg-button-div").hide();
a._backMsg();});$("body").on("click",".collection-img",function(){$("#image-button-div").hide();a._collectionImg();});$("body").on("click",".collection-img-delete",function(){$("#my-image-button-div").hide();
a._collectionImgDelete();});$(".jt-wx-btn-div").on("mouseenter",function(){$("#jt-wx-caht-more-info").slideDown(400);});$("#jt-wx-caht-more-info").on("mouseleave",function(){$(this).slideUp(400);
});$("#jt-edit-con-lan").on("click",function(){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/weixinCommonLan/list.htm","我的常用语");});$(document).on("click",".web_wechat_message_fail",function(){var d=$(this).attr("id-val");
var c=$(this).attr("create-time");var b={userName:a.csInfo.userName,id:d,createTime:c};a._reSend(b);});$(document).on("click",".jt-copy-content",function(b){$("#msg-button-div").hide();
});},_removeHtml:function(a){a=a.replace(/<\/?[^>]*>/g,"");return a;},_removeNotRead:function(){FormUtils.submit(WeiXinChatForm._CONS_.CLEAR_UNREAD_URL,{friendCode:this.csInfo.csCode},function(a){},function(){},true);
if(!this.csInfo.hasInline){return false;}FormUtils.submit(WeiXinChatForm._CONS_.STATUS_NOTIFY_URL,{userName:this.csInfo.userName,empWx:this.csInfo.employeeAlias},function(a){},function(){},true);
},_readAudio:function(b,a){FormUtils.submit(WeiXinChatForm._CONS_.READ_AUDIO_URL,{id:b,createTime:a},function(c){if(c.success){$("#"+b).find(".web_wechat_noread").remove();
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_collectionImg:function(){var a=$("#collection-img-url").val();FormUtils.submit(WeiXinChatForm._CONS_.COLLECTION_IMG_URL,{path:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"收藏成功");
var c=JSON.parse(b.msg);$("#myCollecotionImagediv").prepend("<img id='"+c.id+"' class='my-face-image face-image' src-value='"+c.path+"' src='"+ImageUtils.getTrueUrl(c.path)+"'></img>");
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_collectionImgDelete:function(){var a=$("#collection-img-id").val();
FormUtils.submit(WeiXinChatForm._CONS_.DELETE_COLLECTION_URL,{id:a},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"删除成功");$("#"+a).remove();
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_backMsg:function(){var a=$("#back-msg-id").val();
FormUtils.submit(WeiXinChatForm._CONS_.BACK_MSG_URL,{id:a,employeeAlias:this.csInfo.employeeAlias},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"消息撤回中");
$("#"+a).find(".main").addClass("remove");$("#"+a).find(".main").append("<span class='msg-revoke'>撤回中...</span>");}else{DialogUtils.error(msgCode.ERROR,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_addNewWxFriend:function(c,a,b){FormUtils.submit(WeiXinChatForm._CONS_.ADD_FRIEND_URL,{id:c,userName:a,verifyTicket:b},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,"添加成功");
$("#"+c).find(".add-new-friend").remove();}else{DialogUtils.error(msgCode.ERROR,"系统添加好友达到上限。请先用手机通过好友申请");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_saveWxLabel:function(){var f=$(".jt-wx-label-selected");var a="";for(var e=0;e<f.length;e++){if(e==f.length-1){a+=$(f[e]).text();}else{a+=$(f[e]).text()+",";
}}var h=a.split(",");var b=this.csInfo.wxLabel.split(",");if(h.length<=0&&b.length<=0){return;}var k=false;for(var e=0;e<h.length;e++){var d=false;for(var c=0;
c<b.length;c++){if(h[e]==b[c]){d=true;break;}}if(!d){k=true;break;}}var g=this;g.csInfo.wxLabel=a;if(k||h.length!=b.length){FormUtils.submit(WeiXinChatForm._CONS_.SAVE_LABEL_URL,{userName:g.csInfo.userName,employeeAlias:g.csInfo.employeeAlias,label:a},function(i){if(i.success){DialogUtils.success(msgCode.SUCCESS,"打标签成功");
}else{DialogUtils.error(msgCode.ERROR,i.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_selectWxLabel:function(){var a=this.csInfo.wxLabel;
if(!(a==null||a=="")){var b=$(".jt-wx-label");$.each(b,function(){if(a.indexOf($(this).text())!=-1){$(this).addClass("jt-wx-label-selected");}});}},_canSearch:function(){var b=true;
if(this.history.startDate==null||this.history.startDate==""){DialogUtils.error(msgCode.ERROR,"起始时间不能为空！");b=false;}else{if(this.history.endDate==null||this.history.endDate==""){var a=DateUtils.getDateDiff(this.history.startDate,DateUtils.format(new Date(),"yyyy-MM-dd HH:mm:ss"),"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"结束时间为空时起始时间距现在不能超过7天");b=false;}}else{var a=DateUtils.getDateDiff(this.history.startDate,this.history.endDate,"day");
if(a>7){DialogUtils.error(msgCode.ERROR,"起始时间与结束时间不能超过7天");b=false;}}}return b;},_loadBeforeAndAfter:function(d){var b=this;if(!b._canSearch()){return false;
}var a=$(".history-message-box").find(".inner-div");a.empty();var c=WeiXinChatForm._CONS_.LIST_BEFORE_AFTER_URL+"?hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&Q__S__EQ__employee_alias_="+b.csInfo.employeeAlias+"&userName="+b.csInfo.userName+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&createTime="+this.history.createTime;
FormUtils.loadData(c,function(f){if(f&&f.length){var g=new StringBuffer();for(var e=f.length-1;e>=0;e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;
}else{f[e].headImgUrl=f[e].employeeHeadPic;}g.append(b._getHistoryLi(f[e]));}a.prepend(g.toString());$("#history-"+d).css({"background-color":"rgba(239, 199, 87, 0.35)","border":"1px solid #f8ac59"});
location.href="#history-"+d;}b.history.status=true;b._setDuration();});},_loatRecordHistory:function(d){var b=this;if(!b._canSearch()){return false;}var a=$(".history-message-box").find(".inner-div");
if(d){a.empty();}var c=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&Q__S__EQ__employee_alias_="+b.csInfo.employeeAlias+"&userName="+b.csInfo.userName+"&page="+this.history.page+"&rows="+this.history.rows+"&sord=desc&sidx=create_time_&"+"&startDate="+this.history.startDate+"&endDate="+this.history.endDate+"&Q__S__EQ__is_sign_="+this.history.isSign+"&Q__S__LK__content_="+encodeURIComponent(this.history.contentSearchParam)+"&Q__S__IN__content_type_="+this.history.contentType;
FormUtils.loadData(c,function(h){var f=h.rows;b.history.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=a.height();for(var e=f.length-1;e>=0;
e--){if(f[e].type=="in"){f[e].headImgUrl=b.csInfo.headImgUrl;}else{f[e].headImgUrl=(f[e].employeeHeadPic==""?ctx+"/img/jt/logos/t9.png":f[e].employeeHeadPic);
}j.append(b._getHistoryLi(f[e],true));}a.prepend(j.toString());if(d){$(".history-message-box").scrollTop($(".history-message-box")[0].scrollHeight);}else{g=a.height()-g;
$(".history-message-box").scrollTop(g);}}b.history.status=true;b._setDuration();});},loadRecord:function(d){var a=this;var c=$(".m-message").find("ul");
if(d){c.empty();}var b=WeiXinChatForm._CONS_.LIST_RECODE_DATA_URL+"?hasGrant="+ResUtils.canShow("android.button.viewPhone")+"&userName="+a.csInfo.userName+"&Q__S__EQ__employee_alias_="+a.csInfo.employeeAlias+"&page="+this.record.page+"&rows="+this.record.rows+"&sord=desc&sidx=create_time_";
FormUtils.loadData(b,function(h){var f=h.rows;a.record.total=h.total;if(f&&f.length){var j=new StringBuffer();var g=$(".m-message").find("ul").height();
for(var e=f.length-1;e>=0;e--){j.append(a._getChartLi(f[e]));}c.prepend(j.toString());if(d){a._gotoBottom();}else{g=$(".m-message").find("ul").height()-g;
$(".m-message").scrollTop(g);}}a.record.status=true;a._setDuration();if(a.record.total>a.record.page){$(".jt-more-record-div").show();}else{$(".jt-more-record-div").hide();
}},function(){},true);},_setDuration:function(){setTimeout(function(){var b=$(".not_duration");for(var a=0;a<b.length;a++){var c=$(b[a]).find(".media")[0];
var d=parseInt(c.duration);$(b[a]).removeClass("not_duration").find(".audio_length").empty().append(d+"''");$(b[a]).find(".audio_area").css({width:(70+2*d)+"px"});
}},300);},send:function(){var a=this;var c=a.weixinTextarea.getValue();$("#chat-textarea").empty();for(var b=0;b<c.length;b++){var d={content:encodeURIComponent(c[b].content),contentType:c[b].contentType,employeeId:currentUserId,userName:a.csInfo.userName,employeeAlias:a.csInfo.employeeAlias};
if(c[b].fileName){d.fileName=c[b].fileName;}if(c[b].fileSize){d.fileSize=c[b].fileSize;}a._sendFinal(d);}},_sendImg:function(c){var a=this;var b=new Date();
var d={content:c,contentType:4,employeeId:currentUserId,userName:a.csInfo.userName,employeeAlias:a.csInfo.employeeAlias};a._sendFinal(d);},_sendFinal:function(b){var a=this;
FormUtils.submit(WeiXinChatForm._CONS_.RECODE_SEND_URL,b,function(c){if(c.success){}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);},_reSend:function(b){var a=this;FormUtils.submit(WeiXinChatForm._CONS_.RESEND_MSG_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCESS,c.msg);
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);},_gotoBottom:function(){$(".m-message").scrollTop($(".m-message")[0].scrollHeight);
},_getContent:function(b){if(b.lastReplyType==1||b.lastReplyType==4||b.lastReplyType=="1"||b.lastReplyType=="4"){return"[图片]";}else{if(b.lastReplyType==2||b.lastReplyType=="2"){return"[语音]";
}else{if(b.contentType==7){return"[文件]";}else{if(b.lastReplyType==5||b.lastReplyType=="5"){var a=b.lastReplyContent.split(";");var c=a[0]+"想要加你为朋友";if(c.length>10){return c.substring(0,9)+"...";
}else{return c;}}else{if(b.lastReplyContent&&b.lastReplyContent.length>10){return b.lastReplyContent.substring(0,9)+"...";}else{return b.lastReplyContent;
}}}}}},_getChartLi:function(b){if(b.contentType==5){return"";}var c=false;if(this.lastChatTime==""){this.lastChatTime=b.createTime;c=true;}else{var d=DateUtils.getDateDiff(this.lastChatTime,b.createTime,"minute");
if(Math.abs(d)>=3){this.lastChatTime=b.createTime;c=true;}}var a=DateUtils.getDateDiff(b.createTime,DateUtils.format(new Date(),"yyyy-MM-dd")+" 23:59:59","hour");
var e=new StringBuffer();e.append("<li id='"+b.id+"' >");if(c){if(Math.abs(a)<24){e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"HH:mm:ss")+"</span></p>");
}else{e.append("<p class='time'><span>"+DateUtils.format(new Date(b.createTime),"yyyy-MM-dd HH:mm:ss")+"</span></p>");}}e.append("<div class='main "+(b.type=="out"?"self":"")+(b.status&&b.status==1?" remove'":"")+"'>");
e.append("<span type='checkbox' style='display:none;' value='"+b.id+"' createTime='"+b.createTime+"' class='glyphicon glyphicon-star wx-set-star "+(b.type=="out"?"wx-set-star-right ":"wx-set-star-left ")+(b.isSign=="y"?" wx-set-star-checked":"")+"'></span>");
if(b.type=="out"&&b.status==2){e.append("<i class='ico_fail web_wechat_message_fail'  title='重新发送' id-val='"+b.id+"' create-time='"+b.createTime+"'></i>");
}e.append("<img class='avatar' width='30' height='30' src='"+this._getHeadImgUrl(b)+"'>").append("<div class='text "+(b.contentType==5||b.contentType=="5"?" text-add":"")+"'>"+this._getMsgType(b)+"</div>"+WeiXinUtil.getIsRevoke(b)).append("</div></li>");
return e.toString();},_getHistoryLi:function(b,a){if($("#history-"+b.id).length>0||b.contentType==5){return"";}var c=new StringBuffer();c.append("<div id='history-"+b.id+"' >");
if(b.type=="out"){c.append("<p style='color:#1ab394'>"+(b.employeeAid+":"+b.employeeName)+"  "+b.createTime);}else{c.append("<p style='color:#0035ff'>"+(b.nickName)+"  "+b.createTime);
}c.append("</p>").append("<p class='history-text'>"+(this._isSearch(a)?("<a class='show-before-and-after' id-value='"+b.id+"' createTime='"+b.createTime+"'>"+this._getMsgType(b,a)+"</a>"):this._getMsgType(b))).append(WeiXinUtil.getIsRevoke(b)).append("</p>").append("</div>");
return c.toString();},_isSearch:function(a){if(a&&!(this.history.isSign==""&&this.history.contentSearchParam=="")){return true;}else{return false;}},_getMsgType:function(c,a){if(c.contentType==0||c.contentType=="0"){return this._isGroupMessage(c)+WeiXinUtil.replaceFace(c.content);
}else{if(c.contentType==1||c.contentType=="1"){var b=c.content.split(";");if(b.length>1){return this._isGroupMessage(c)+"<img style='width:120px;height:120px;' src-value='"+c.content+"' class='jt-lager-img' src='"+ImageUtils.getTrueUrl(b[0])+"' big-src='"+ImageUtils.getTrueUrl(b[1])+"'>";
}else{return this._isGroupMessage(c)+"<img style='width:120px;height:120px;' src-value='"+c.content+"' class='jt-lager-img' src='"+ImageUtils.getTrueUrl(c.content)+"' big-src='"+ImageUtils.getTrueUrl(c.content)+"'>";
}}else{if(c.contentType==2||c.contentType=="2"){return this._isGroupMessage(c)+WeiXinUtil.getAudioSpan(c);}else{if(c.contentType==4||c.contentType=="4"){return this._isGroupMessage(c)+"<img style='width:80px;height:80px;' src-value='"+c.content+"' class='msg-image'  src='"+ImageUtils.getTrueUrl(c.content)+"' big-src='"+ImageUtils.getTrueUrl(c.content)+"'>";
}else{if(c.contentType==5||c.contentType=="5"){return this._isGroupMessage(c)+WeiXinUtil.getNewFriendMsg2(c);}else{if(c.contentType==7||c.contentType=="7"){return this._isGroupMessage(c)+WeiXinUtil.getFileMsg(c);
}else{if(c.contentType==8){return this._isGroupMessage(c)+WeiXinUtil.getVideoMsg(c);}else{if(a&&this.history.contentSearchParam!=""){return c.content.replaceAll(this.history.contentSearchParam,"<span style='background-color:yellow;'>"+this.history.contentSearchParam+"</span>");
}else{return c.content;}}}}}}}}},_isGroupMessage:function(a){if(a.userName.indexOf("@chatroom")!=-1&&a.type=="in"){return"<div style='font-weight:600;'>"+a.nickName+":</div>";
}else{return"";}},_getHeadImgUrl:function(b){var a="";if(b.type=="in"){a=b.headPic!=null&&b.headPic!=""?b.headPic:this.csInfo.headImgUrl;}else{a=b.employeeHeadPic?b.employeeHeadPic:currentUserProfile;
if(a==""){a="/img/jt/logos/t9.png";}}if(a&&a.indexOf("http://")==-1&&a.indexOf(ctx)==-1){a=ctx+a;}return a;},_getId:function(a){if(a.indexOf("@")!=-1){a=a.replaceAll("@","-qun-");
}return a;},_initFaceImages:function(){var a=WeiXinChatForm._CONS_.FIND_FACE_IMAGES_URL;FormUtils.loadData(a,function(f){var d=f.myCollectImages;var c=f.systemImages;
var g=new StringBuffer();for(var b=0;b<d.length;b++){g.append("<img class='my-face-image face-image' id='"+d[b].id+"' src-value='"+d[b].path+"' src='"+ImageUtils.getTrueUrl(d[b].path)+"'></img>");
}$("#myCollecotionImagediv").empty().append(g.toString());var e=new StringBuffer();for(var b=0;b<c.length;b++){e.append("<img class='face-image' src-value='"+c[b].path+"'  src='"+ImageUtils.getTrueUrl(c[b].path)+"'></img>");
}$("#systemImagediv").empty().append(e.toString());});},_initCommonLan:function(){var a=WeiXinChatForm._CONS_.FIND_COM_LAN_URL;FormUtils.loadData(a,function(b){var d=new StringBuffer();
for(var c=0;c<b.length;c++){d.append("<p class='jt-com-lan-p'>"+b[c].content+"</p>");}$("#myComLandiv").empty().append(d.toString());});}};