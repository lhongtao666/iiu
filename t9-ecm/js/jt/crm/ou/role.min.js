$(function(){var a=new Role();a.init();});function Role(){this.hadInit=false;this.jtjqgrid=null;this.isEdit=false;this.isFormDataChange=false;this.qaCheck=[];
}Role._CONS_={GRID:"#roleGrid",PAGER:"#rolePager",LIST_DATA_URL:ctx+"/crm/ou/role/listData.htm?sys="+sys,EDIT_URL:ctx+"/crm/ou/role/edit.htm?sys="+sys,DETAIL_URL:ctx+"/crm/ou/role/detail.htm?sys="+sys,SAVE_ADD_URL:ctx+"/crm/ou/role/saveAdd.htm?sys="+sys,SAVE_EDIT_URL:ctx+"/crm/ou/role/saveEdit.htm?sys="+sys,DELETE_URL:ctx+"/crm/ou/role/delete.htm?sys="+sys,OPEN_OR_OFF_URL:ctx+"/crm/ou/role/openOrOff.htm?sys="+sys,ADD_ROLE_GROUP_URL:ctx+"/gl/cate/cateOpt/addRoleGroup.htm?sys="+sys,FIND_ALL_REPORT_RES:ctx+"/crm/report/reportEntity/findAllReportRes.htm?sys="+sys,LIST_ROLE_RES_TREE:ctx+"/gl/auth/res/listRoleResTree.htm?sys="+sys,LIST_EFFECTIVE_ROLE_RES_TREE:ctx+"/gl/auth/res/listEffectiveRoleResTree.htm?sys="+sys,DELETE_CATEOPT_URL:ctx+"/gl/cate/cateOpt/delete.htm?sys="+sys,GET_OPTIONS_URL:ctx+"/gl/cate/cate/getOptions.htm?sys="+sys,GET_QAAUTH_URL:ctx+"/gl/qa/qaAuth/listData.htm?sys="+sys,};
Role.prototype={init:function(){if(!this.hadInit){var a=this;this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._loadRoleGroups();
this._loadRoles();this._setHeight();this._hideNotGrantBtn();this._loadRoleSelect();this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.group_employee.role";
glHelpUtil.init(a);},_loadRoleSelect:function(){var a={container:"copyRoleIdContainer",sys:sys,};RoleUtils.loadAllRole(a);},_loadRoleGroups:function(){var a=this._getRoleGroupPkey();
CateUtils.getOptions({typeKey:"system",pKey:a,container:"cateIdContainer1"});},_getRoleGroupPkey:function(){var a="roleGroup";if(!sys||"ecm"==sys){a="roleGroup";
}else{a=sys+"_roleGroup";}return a;},_hideNotGrantBtn:function(){if(!ResUtils.canShow("role.button.add")){$("#addRoleBtn").hide();}if(!ResUtils.canShow("role.button.saveEdit")){$("#editRoleBtn").hide();
}if(!ResUtils.canShow("role.buton.addGroup")){$("#addGroupBtn").hide();}},_setHeight:function(){var a=$(document).height()-$("#addRoleBtn").parent().parent().outerHeight()-15;
$("#rolesContainer").height(a);a=$(document).height()-15;$("#roleDetailContainer").height(a);},_loadRoles:function(b,d){var a=this;var c=this._getRoleGroupPkey();
FormUtils.loadData(Role._CONS_.GET_OPTIONS_URL+"?typeKey=system&pKey="+c,function(e){if(e&&e.length){var h=[];for(var g=0;g<e.length;g++){var f={id:e[g].id,group:e[g].name,index:g,roles:[]};
h.push(f);}FormUtils.loadData(Role._CONS_.LIST_DATA_URL,function(p){if(p&&p.length){for(var n=0;n<p.length;n++){var m=-1;for(var l=0;l<h.length;l++){if(h[l].group==p[n].cateId){m=l;
break;}}if(m<0){var k={group:p[n].cateId,index:n,roles:[p[n]]};h.push(k);}else{h[m].roles.push(p[n]);}}}var o=$.templates("#roleTmpl");var q=o.render(h);
$("#roleContainer").empty().append(q);if(b){$("#roleContainer").find("ul li").each(function(){if(b.trim()==$(this).text().trim()){$("#roleContainer").find(".panel-collapse.collapse.in").removeClass("in");
$(this).parents(".panel-collapse").addClass("in");$(this).trigger("click");}});}else{if(d){$("#roleContainer").find("h4").each(function(){if(d.trim()==$(this).text().trim()){$("#roleContainer").find(".panel-title.collapsed").removeClass("collapsed");
$(this).parents(".panel-collapse").addClass("collapsed");$(this).trigger("click");}});}else{$("#roleContainer").find("h4").eq(0).trigger("click");$("#roleContainer").find("ul li").eq(0).trigger("click");
}}});}});},_loadReports:function(b){var a=this;FormUtils.loadData(Role._CONS_.FIND_ALL_REPORT_RES+"&roleId="+b+"&isNew=n",function(c){if(c){var k=[];for(var g=0;
g<c.length;g++){var e=-1;for(var d=0;d<k.length;d++){if(k[d].cateName==c[g].cateName){e=d;break;}}if(e<0){var f={cateName:c[g].cateName,index:g,reports:[c[g]]};
k.push(f);}else{k[e].reports.push(c[g]);}}var h=$.templates("#reportTmpl");var l=h.render(k);$("#reportContainer").empty().append(l);$(".report-checkbox").find("input[name='reportIds']").each(function(){if($(this).attr("checked")==undefined){$(this).parent().hide();
}});$(".report-entry").hide();$(".report-checkbox").find("input[name='reportIds']").each(function(){if($(this).attr("checked")=="checked"){$(this).parent().parent().parent().show();
}});}});},_loadNewReports:function(c){var a=this;var b=ctx+"/gl/cate/cate/loadCateTreeData.htm?cateTypeKey=reportAnalysisNew&rootKey=reportAnalysisNew-root";
FormUtils.loadData(b,function(e){if(e&&e.length>0){var d=Role._CONS_.FIND_ALL_REPORT_RES+"&roleId="+c+"&isNew=y";FormUtils.loadData(d,function(k){a._addReportToCateTree(e,k);
var l=JTOtherUtils.listToTree("id","parentId",e);console.log(l);var m=new StringBuffer();var f=l[0];m.append("<tr>");m.append("<td class='first-td' width='15%' rowspan='12'>");
m.append("报表");m.append("</td>");if(!f.children){return;}for(var h=0;h<f.children.length;h++){if(h!=0){m.append("<tr>");}m.append("<td class='secend-td' width='15%' rowspan='2'>");
m.append(f.children[h].name);m.append("</td>");for(var g=0;g<f.children[h].children.length;g++){if(g!=0){m.append("<tr>");}m.append("<td class='third-td' width='15%'>");
m.append(f.children[h].children[g].name);m.append("</td>");m.append("<td class='fourth-td' width='55%'>");if(f.children[h].children[g].reports){m.append(a._createReportButtonCheckbox(f.children[h].children[g].reports));
}m.append("</td>");m.append("</tr>");}}$("#newReportContainer").empty().append(m.toString());$("#newReportContainer").find("input[name='reportIds']").each(function(){if($(this).attr("checked")==undefined){$(this).parent().hide();
}});if($("#newReportContainer").find("input[name='reportIds']:checked").length<=0){$(".first-td").hide();}$("#newReportContainer").find(".fourth-td").each(function(){if($(this).find("input[name='reportIds']:checked").length<=0){$(this).hide();
$(this).parent("tr").find(".secend-td").hide();$(this).parent("tr").find(".third-td").hide();}});});}});},_createReportButtonCheckbox:function(a){var c=new StringBuffer();
for(var b=0;b<a.length;b++){c.append('<div class="checkbox checkbox-success checkbox-inline button" style="padding-right:0px;margin-right:0px;width:25%;">');
c.append('<input disabled="disabled" '+(a[b].checked?"checked='checked'":"")+' name="reportIds" parentIdVal="'+a[b].cateId+'" type="checkbox" id="'+a[b].id+'" value="'+a[b].id+'" >');
c.append('<label checkLable="'+a[b].cateId+'" for="'+a[b].id+'">'+a[b].name+"</label>");c.append("</div>");}return c.toString();},_addReportToCateTree:function(a,d){for(var c=0;
c<a.length;c++){for(var b=0;b<d.length;b++){if(a[c].id==d[b].cateId){if(a[c].reports){a[c].reports.push(d[b]);}else{a[c].reports=[d[b]];}}}}},_loadRoleResTree:function(b){var a=this;
FormUtils.loadData(Role._CONS_.LIST_EFFECTIVE_ROLE_RES_TREE+"&roleId="+b,function(c){$("#roleGrantResContainer").empty();if(c.length){$("#roleGrantResContainer").append(ResUtils.createResTableStr(c));
}});},_bindFormValidation:function(){var b={rules:{name:{required:true},cateId:{required:true},status:{required:true}}};FormUtils.bindFormValidation("roleForm",b);
var c={rules:{name1:{required:true},isDefault1:{required:true},cateId1:{required:true},status1:{required:true}}};FormUtils.bindFormValidation("addRoleForm",c);
var a={rules:{groupName:{required:true}}};FormUtils.bindFormValidation("addGroupForm",a);},_loadData:function(c,b){var a=this;FormUtils.disableForm("roleForm");
FormUtils.loadData(Role._CONS_.EDIT_URL+"?id="+c,function(e){$("input[name='id']").val(e.id);$("input[name='name']").val(e.name);$("#cateIdContainer").val(e.cateId);
$("input[name='createBy']").val(e.createBy);$("input[name='createTime']").val(e.createTime);$("input[name='sort']").val(e.sort);$("input[name='csLimit']").val(e.csLimit);
$("textarea[name='desc']").val(e.desc);$("select[name='status']").val(e.status);$("select[name='isAgent']").val(e.isAgent);DesktopSelect.loadDesktop(e.desktopId,"[name=desktopId]");
$(".tag-list").empty();var d=a._getRoleGroupPkey();CateUtils.getOptions({typeKey:"system",pKey:d,selectedOption:e.cateId,container:"cateIdContainer"});
a._createRoleGrant(e.employeePos);a._createColumnsGrant(e.exportColumns);a._loadReports(c);a._loadNewReports(c);if(b){$("#editRoleBtn").attr("disabled",false);
}});},_delete:function(c,b){var a=this;DialogUtils.confirm(function(){FormUtils.del(Role._CONS_.DELETE_URL,c,function(d){if(d.success){DialogUtils.success("提示",d.msg);
var e=b.parent().parent().parent().parent().prev().find("h4").text();a._loadRoles(null,e);}else{DialogUtils.error("错误",d.msg);}});});},_getRoleCheckedRes:function(){var a=[];
$("#roleGrantResContainer").find(".checkRes").each(function(){if($(this).is(":checked")){a.push($(this).val());}});a.push($("input[name='rootRes']").val());
return a.toString();},_getReports:function(){var a=[];$("#reportContainer").find("input[name='reportIds']").each(function(){if($(this).is(":checked")){a.push($(this).val());
}});$("#newReportContainer").find("input[name='reportIds']").each(function(){if($(this).is(":checked")){a.push($(this).val());}});return a;},_getRoleGrants:function(){var a=[];
$(".tag-list").find("li").each(function(){a.push($(this).attr("idVal"));});return a.toString();},_getExportCols:function(){var a=[];$("#exportColumnsContainer").find(".columnCheckBox").each(function(){if($(this).is(":checked")){a.push($(this).val());
}});return a.toString();},_save:function(){if($("#roleForm").valid()){var c=$("#roleForm").serialize();c+="&resIds="+this._getRoleCheckedRes();c+="&userIds="+this._getRoleGrants();
c+="&exportColumns="+this._getExportCols();c+="&reportIds="+this._getReports();ButtonUtils.disableBtn("saveRoleBtn");ButtonUtils.disableBtn("selectEmployeeBtn");
var b=this;var a=$("input[name='id']").val()?Role._CONS_.SAVE_EDIT_URL:Role._CONS_.SAVE_ADD_URL;FormUtils.submit(a,c,function(d){ButtonUtils.enableBtn("saveRoleBtn");
if(d.success){if(d.msgCode==actionCode.UPDATE){DialogUtils.success("成功","更新成功");$("#cancelRoleBtn").trigger("click");b._loadRoles($("#roleContainer").find(".list-group li.active").text());
}b.isEdit=false;}else{DialogUtils.error("失败",d.msg);}},function(){ButtonUtils.enableBtn("saveRoleBtn");DialogUtils.error("失败","网络连接失败，请稍候重试");});}},_toggleCheckRes:function(e,c){var a=this;
if($("#roleGrantResContainer").find('.checkRes[parentIdVal="'+e+'"]').length){$("#roleGrantResContainer").find('.checkRes[parentIdVal="'+e+'"]').prop("checked",c);
$("#roleGrantResContainer").find('.checkRes[parentIdVal="'+e+'"]').each(function(){e=$(this).val();a._toggleCheckRes(e,c);});}else{if(c){var d=$('.checkRes[value="'+e+'"]').attr("parentIdVal");
while(d){$('.checkRes[value="'+d+'"]').prop("checked",c);d=$('.checkRes[value="'+d+'"]').attr("parentIdVal");}}else{var b=false;var d=$('.checkRes[value="'+e+'"]').attr("parentIdVal");
if($('.checkRes[parentIdVal="'+d+'"]').length==1){return;}while(d){if($('.checkRes[parentIdVal="'+d+'"]').length){if($('.checkRes[parentIdVal="'+d+'"]:checked').length){b=true;
}if(!b){$('.labelOfRes[lableId="'+d+'"]').attr("style","color:red");$('.checkRes[value="'+d+'"]').prop("checked",false);}else{break;}d=$('.checkRes[value="'+d+'"]').attr("parentIdVal");
}}}}},_createRoleGrant:function(c){if(c&&c.length){var b=$.templates("#userTmpl");var a=b.render(c);$(".tag-list").append(a);$(".tag-list").find("li button").hide();
}else{$(".tag-list").empty();}},_bindEventHander:function(){var a=this;$("body").on("click",".copyRoleBtn",function(){});$("body").on("click",".deleteEmployeeBtn",function(){$(this).parents("li").remove();
});$("#selectEmployeeBtn").on("click",function(){var b=new EmployeesSelect();var c=0;if(ResUtils.canShow("employeeSelector.button.role")){c:1;}b.init({isShowAllGroup:c,grantType:"/role/",isMultiple:1,mode:0,sys:sys,isSale:0,callBack:function(d){a._createRoleGrant(d);
}});});$("#roleGrantResContainer").on("click",".checkRes",function(){a._toggleCheckRes($(this).val(),$(this).is(":checked"));});$("#roleContainer").on("click",".deleteRoleBtn",function(c){var b=$(this).parent().attr("idVal");
c.stopPropagation();a._delete(b,$(this));});$("#roleContainer").on("click",".deleteGroupBtn",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(Role._CONS_.DELETE_CATEOPT_URL,{ids:b},function(c){if(c.success){window.sessionStorage.setItem("system-roleGroup","");
a._loadRoles();DialogUtils.success(msgCode.SUCCESS,"删除成功");}});});});$("#roleContainer").on("click","h4",function(){$("#roleContainer").find(".roleDoubleUp").hide();
$("#roleContainer").find(".roleDoubleDown").show();if($(this).attr("aria-expanded")=="true"){$(this).parent().find(".roleDoubleUp").hide();$(this).parent().find(".roleDoubleDown").show();
}else{$(this).parent().find(".roleDoubleUp").show();$(this).parent().find(".roleDoubleDown").hide();}});$("#roleContainer").on("click","li",function(){if(ResUtils.canShow("role.button.delete")){$("#roleContainer").find("ul li i").remove();
if(!$(this).find("i").length){$(this).append("<i style='color: red; font-size: 14px; position: absolute; right: 5px;' class='deleteRoleBtn fa fa-remove'></i>");
}}$(".tag-list").empty();$("#roleContainer").find("ul").find("li").removeClass("active");$("#selectEmployeeBtn").attr("disabled","disabled");$(this).addClass("active");
var b=$(this).attr("idVal");a._loadRoleResTree(b);a._loadData(b);if(ResUtils.canShow("role.button.saveEdit")||ResUtils.canShow("role.button.add")){$("#cancelRoleBtn").hide();
$("#saveRoleBtn").hide();$("#editRoleBtn").show();}$("#roleContainer").find(".roleDoubleUp").hide();$("#roleContainer").find(".roleDoubleDown").show();
if($(this).attr("aria-expanded")=="true"){$(this).parent().find(".roleDoubleUp").hide();$(this).parent().find(".roleDoubleDown").show();}else{$(this).parent().find(".roleDoubleUp").show();
$(this).parent().find(".roleDoubleDown").hide();}});$("#addRoleBtn").on("click",function(){$("#addRoleModalContainer").modal("show");$("#copyRoleIdContainer").val([""]);
});$("#addGroupBtn").on("click",function(){$("#addGroupModalContainer").modal("show");});$("#addRoleModalContainer").on("show.bs.modal",function(){$("#addRoleModalContainer").css("margin-top","10%");
});$("#addGroupModalContainer").on("show.bs.modal",function(){$("#addGroupModalContainer").css("margin-top","10%");});$("#saveModal").on("hidden.bs.modal",function(){FormUtils.clear("addRoleForm");
});$("#editRoleBtn").on("click",function(){$(this).hide();FormUtils.enableForm("roleForm");ButtonUtils.enableBtn("selectEmployeeBtn");$(".deleteEmployeeBtn").show();
$("#saveRoleBtn").show();$("#cancelRoleBtn").show();var b=$(".list-group-item.active").attr("idVal");FormUtils.loadData(Role._CONS_.LIST_ROLE_RES_TREE+"&roleId="+b,function(c){$("#roleGrantResContainer").empty();
if(c.length){$("#roleGrantResContainer").append(ResUtils.createResTableStr(c));$('input[type="checkbox"]').removeAttr("disabled");}});$(".report-entry").show();
$(".report-checkbox").show();$(".column-export-grant").show();$("#newReportContainer").find("td").show();$("#newReportContainer").find(".checkbox").show();
});$("#cancelRoleBtn").on("click",function(){$(this).hide();$("#saveRoleBtn").hide();$("#editRoleBtn").show();ButtonUtils.disableBtn("selectEmployeeBtn");
var b=$(".list-group-item.active").attr("idVal");$("#editRoleBtn").attr("disabled",true);var c=true;a._loadData(b,c);a._loadRoleResTree(b,false);});$("#saveRoleBtn").on("click",function(){a._save();
});$("#saveRoleBtn1").on("click",function(){if($("#addRoleForm").valid()){var b=new StringBuffer();b.append("name="+$("input[name='name1']").val());b.append("&cateId="+$("#cateIdContainer1").val());
b.append("&status="+$("select[name='status1']").val());b.append("&csLimit="+$("input[name='csLimit1']").val());b.append("&desc="+$("textarea[name='desc1']").val());
b.append("&copyRoleId="+$("#copyRoleIdContainer").val());FormUtils.submit(Role._CONS_.SAVE_ADD_URL,b.toString(),function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"添加成功");
var d=JSON.parse(c.msg);a._loadRoles(d.name);$("input[name='name1']").val("");$("#cateIdContainer1").val([""]);$("input[name='desc1']").val("");$("input[name='csLimit1']").val("");
$("#copyRoleIdContainer").val([""]);$("#addRoleModalContainer").modal("hide");}else{DialogUtils.error(msgCode.ERROR,c.msg);}});}});$("#saveGroupBtn").on("click",function(){if($("#addGroupForm").valid()){var b=a._getRoleGroupPkey();
window.sessionStorage.removeItem("system-"+b);FormUtils.submit(Role._CONS_.ADD_ROLE_GROUP_URL,{name:$("input[name='groupName']").val()},function(c){if(c.success){window.sessionStorage.setItem("system-roleGroup","");
DialogUtils.success(msgCode.SUCCESS,"添加成功");a._loadRoles();a._loadRoleGroups();$("input[name='groupName']").val("");$("#addGroupModalContainer").modal("hide");
}});}});$(document).on("click",".exportModule",function(){var c=$(this).val()+"Panel";var b=true;if(!$(this).is(":checked")){b=false;}if(b){$("#"+c).show();
}else{$("#"+c).hide();}$("#"+c).find(".columnCheckBox").each(function(){$(this).prop("checked",b);});});$(document).on("click",'input[type="checkbox"]',function(){var b=$(this).val();
var c=$(this).parent().find("label").attr("style");if(c){$(this).parent().find("label").removeAttr("style");}else{$(this).parent().find("label").attr("style","color:red");
}});$("#permissionRelatedBtn").on("click",function(){var b=new PermissionsRelatedDetail();b.init();});$("#roleComparedBtn").on("click",function(){var b=new RoleComparedDetail();
b.init();});$("#qaResSearch").on("keyup",function(f){var d=$.trim($(this).val());var b=$.fn.zTree.getZTreeObj("qaResContainer");var c="name";a._updateNodes(false,a.nodeList);
if(d){a.nodeList=b.getNodesByParamFuzzy(c,d);a._updateNodes(true,a.nodeList);}else{a.nodeList=[];}});$("body").on("click",".selectRes",function(){var b=$(this).attr("data-id");
layer.open({type:1,title:"关联角色和工号",maxmin:false,area:["50%","50%"],shadeClose:false,btn:"关闭",content:"<div class='col-sm-12' id='loadRoleContainer'></div>",success:function(c,d){a._loadResByEmp(b);
},cancel:function(){$("#loadRoleContainer").empty();}});});$("body").on("click",".empDetail",function(){var c=$(this).attr("idVal");var b=$(this).attr("nameVal");
JTTabUtils.addOrRefreshTab(ctx+"/crm/ou/employee/employeeDetail.htm?id="+c+"&isHide=true","员工【"+b+"】明细");});},_loadResByEmp:function(c){var a=this;var b=ctx+"/gl/auth/res/getDividerByRes.htm?resId="+c;
FormUtils.loadData(b,function(d){if(d&&d.length>0){var h=new StringBuffer();var f=d[0];if(f&&f.length>0){h.append("<div class='panel panel-default report-entry'><div class='panel-heading report-cate'>");
h.append("<font class='panel-title'>"+"已分配的角色"+"</font>");h.append("</div><div class='panel-body report-body'>");for(var e=0;e<f.length;e++){h.append("<div class='checkbox-inline'><label>"+f[e].name+"</label></div>");
}h.append("</div></div>");}var g=d[1];if(g&&g.length>0){h.append("<div class='panel panel-default report-entry'><div class='panel-heading report-cate'>");
h.append("<font class='panel-title'>"+"已分配的员工"+"</font>");h.append("</div><div class='panel-body report-body'>");for(var e=0;e<g.length;e++){h.append("<div class='checkbox-inline'><label><a class='empDetail' style='font-weight:bold;' idVal='"+g[e].id+"' nameVal='"+g[e].name+"'>"+g[e].aid+"</a>:"+g[e].name+"</label></div>");
}h.append("</div></div>");}$("#loadRoleContainer").append(h.toString());}});},_createColumnsGrant:function(a){var b=new StringBuffer();b.append("&nbsp;&nbsp;&nbsp;&nbsp;");
$("#exportModuleContainer").empty();$("#exportColumnsContainer").empty();b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='csEntity' value='csEntity'><label for='csEntity'>客户模块</label>");
b.append("</div>");this._genExportColPanel("客户模块","csEntity",a);b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='soShip' value='soShip'><label for='soShip'>出货订单</label>");
b.append("</div>");this._genExportColPanel("出货订单","soShip",a);b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='soEntity' value='soEntity'><label for='soEntity'>订单导出</label>");
b.append("</div>");this._genExportColPanel("订单导出","soEntity",a);b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='soStockIn' value='soStockIn'><label for='soStockIn'>入仓订单</label>");
b.append("</div>");this._genExportColPanel("入仓订单","soStockIn",a);b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='emp' value='emp'><label for='emp'>员工模块</label>");
b.append("</div>");this._genExportColPanel("员工模块","emp",a);b.append("<div class='checkbox checkbox-success checkbox-inline'>");b.append("<input type='checkbox' disabled='disabled' class='exportModule' name='exportModule' id='media' value='media'><label for='media'>渠道模块</label>");
b.append("</div>");this._genExportColPanel("渠道模块","media",a);$("#exportModuleContainer").append(b.toString());},_genExportColPanel:function(d,e,b){var c=this;
var a=$.templates("#exportColumnPanelTmpl").render({name:d,value:e});$("#exportColumnsContainer").append(a);c._loadExportColumn(e+"Container",e,b);},_loadExportColumn:function(b,d,a){var e=$.templates("#exportColumnTmpl");
var c=this;excelUtil.findExportColByModule(d,false,function(g){if(g&&g.length>0){for(var f=0;f<g.length;f++){if(a&&a.indexOf(g[f].id)!=-1){g[f].checked=true;
$("#exportModuleContainer").find(".exportModule").each(function(){if($(this).val()==d){$(this).prop("checked",true);}});$("#"+d+"Panel").show();}}$("#"+b).empty();
$("#"+b).append(c._createResButtonCheckbox(g).toString());}FormUtils.disableForm("roleForm");});},_createResButtonCheckbox:function(b){var c=new StringBuffer();
c.append('<div class="col-sm-12">');for(var a=0;a<b.length;a++){c.append('<div class="checkbox checkbox-success checkbox-inline col-sm-2 column-export-grant"'+(b[a].checked?"":"style='display:none;'")+" >");
c.append('<input type="checkbox" disabled="disabled" '+(b[a].checked?"checked='checked'":"")+' colname="'+b[a].name+'" class="columnCheckBox" name="exportColumn" id="'+b[a].id+'" value="'+b[a].id+'" >');
c.append('<label for="'+b[a].id+'">'+b[a].name+"</label>");c.append("</div>");}c.append("</div>");return c.toString();},loadQaCateTreeData:function(){var a=this;
var b=ctx+"/gl/cate/cate/loadCateTreeData.htm?cateTypeKey=system&rootKey=qa&type=system";FormUtils.loadData(b,function(c){if(c.length>0){console.log(c);
a.loadQaCateTree(c);}});},loadQaCateTree:function(d){var a=this;var c={check:{enable:true,chkStyle:"checkbox",chkboxType:{"Y":"ps","N":"s"},radioType:"all"},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{beforeCheck:function(f,e){},onCheck:function(e,g,f){console.log(a.getQaCheck());
},onClick:function(e,g,f){}},view:{selectedMulti:false,fontCss:function(f,e){return(!!e.highlight)?{"color":"#A60000","font-weight":"bold","font-size":"15px"}:{"color":"#333","font-weight":"normal","font-size":"15px"};
}}};$.fn.zTree.init($("#qaResContainer"),c,a.getFirstCateNode(d));var b=$.fn.zTree.getZTreeObj("qaResContainer");b.expandAll(true);},_updateNodes:function(b,d){if(d){var c=$.fn.zTree.getZTreeObj("qaResContainer");
for(var e=0,a=d.length;e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);}c.updateNode(d[e]);}}},getQaCheck:function(){var a=$.fn.zTree.getZTreeObj("qaResContainer"),b=[];
$.each(a.transformToArray(a.getNodes()),function(c,d){if(this.checked){b.push(this.id);}});return b;},getFirstCateNode:function(d){var a=this;var e=[];
for(var c=0;c<d.length;c++){if(d[c].key=="qa"){e.push(d[c]);for(var b=0;b<d.length;b++){if(d[b].parentId==d[c].id&&d[b].parentId!=d[b].id){e.push(d[b]);
}}break;}}return e;},_loadQaAuth:function(b){var a=this;FormUtils.loadData(Role._CONS_.GET_QAAUTH_URL+"&roleId="+b,function(g){a.triggerQaAuthCheck(false);
var e=$.fn.zTree.getZTreeObj("qaResContainer");var c=e.transformToArray(e.getNodes());if(g.length>0){for(var f=0;f<g.length;f++){for(var d=0;d<c.length;
d++){if(c[d].id==g[f].qaCateFirstId){e.checkNode(c[d],true,true);break;}}}}else{for(var d=0;d<c.length;d++){e.checkNode(c[d],false,true);}}a.triggerQaAuthCheck(true);
});},triggerQaAuthCheck:function(d){var b=$.fn.zTree.getZTreeObj("qaResContainer");var a=b.transformToArray(b.getNodes());for(var c=0;c<a.length;c++){b.setChkDisabled(a[c],d);
}}};