function TeamPk(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.selectedEmployee=[];this.selectedEmployeeMap={};this.teamPkEmp=new TeamPkEmp();
}TeamPk._CONS_={EDIT_URL:ctx+"/crm/ou/team/teamPk/edit.htm",DETAIL_URL:ctx+"/crm/ou/team/teamPk/detail.htm",DELETE_URL:ctx+"/crm/ou/team/teamPk/delete.htm",SAVE_ADD_URL:ctx+"/crm/ou/team/teamPk/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/ou/team/teamPk/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/ou/team/teamPk/listData.htm",FIND_TEAMINFO_URL:ctx+"/crm/ou/team/teamPk/findTeamInfo.htm",EDIT_FORM_ID:"teamPkForm",GRID:"#teamPkGrid",PAGER:"#teamPkPager"};
TeamPk.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._loadData();this._initEmployee();this._hideNotGrantBtn();
}},_initEmployee:function(){var a=this;var b=ctx+"/crm/ou/employee/search.htm?keyword=";FormUtils.loadData(b,function(c){a.employeeList=c.value;});},_initEmployeeTable:function(d){var a=this;
if(d&&d.length>0){var e=new StringBuffer();for(var c=0;c<d.length;c++){var b=d[c];e.append('<div class="emp" idVal="'+b.empId+'" id="emp-'+b.empId+'"').append(">").append('<i class="fa fa-user" aria-hidden="true" style="color: #f8ac59;"></i>&nbsp;').append("<span>"+b.aid+":"+b.name+"").append('<span class="blue">|</span>').append('<i class="fa fa-remove deleteEmployeeBtn"></i>').append("</div>");
a.selectedEmployeeMap[b.empId]=b.empId;}return e.toString();}else{return"<span class='noData'>该团队内还没有任何成员哦</span>";}},_createEmployeeTable:function(c,a,f,e){var g=this.employeeList;
if(e=="1"){c="";}var h=new StringBuffer();for(var d=0;d<g.length;d++){var b=g[d];if(this.selectedEmployeeMap.hasOwnProperty(b.id)){continue;}if(c==""||c.indexOf(b.groupId)!=-1){h.append('<tr id="employee-table-'+g[d].id+'">').append('<td width="10%"><input type="checkbox"');
if($.inArray(b.id,f)!=-1){h.append(' data-id="'+g[d].id+'" checked ');}else{h.append(' data-id="'+g[d].id+'"');}h.append(' data-groupId="'+g[d].groupId+'"').append(' data-name="'+g[d].name+'"').append(' data-aid="'+g[d].aid+'"').append(' data-orgName="'+g[d].orgName+'"></td>');
h.append('<td width="45%">'+g[d].name+":"+g[d].aid+"</td>").append('<td width="45%">'+g[d].orgName+"</td>").append("</tr>");}}a.find(".select-employee-table").empty().append(h.toString());
},_loadTeam:function(c){var a=this;var b=TeamPk._CONS_.FIND_TEAMINFO_URL;FormUtils.loadData(b+"?id="+c,function(d){if(d){$("#teamPkInfo").empty().append(a.tGLi(d));
}});},_loadData:function(c){var a=this;var b=TeamPk._CONS_.LIST_DATA_URL;FormUtils.loadData(b,function(g){teamDatas=g;if(!c){var h=new StringBuffer();if(g.rows&&g.rows.length>0){h.append("<li class='teamLi'><input  readonly='readonly' style='text-align:center' class='form-control activeLi' value='全部'></li>");
var d=g.rows;for(var e=0;e<d.length;e++){h.append("<li class='teamLi teamLiOne'><input readonly='readonly' idVal='"+d[e].id+"' style='text-align:center' class='form-control' value='"+d[e].name+"'></li>");
}}if(ResUtils.canShow("teamPk.button.add")){h.append("<li class='addTeamLi' style='margin:10px 0;'> ");h.append("<div class='addTeamLi-input'><input id='addTeamInput'></div>");
h.append("<div class='addTeamLi-btn'><button class='btn btn-sm btn-primary' id='addTeamBtn'><i class='fa fa-plus'></i>&nbsp;添加</button></div></li>");}$("#loadTeam").empty().append(h.toString());
}if(g){var d=g.rows;var f=new StringBuffer();$.each(d,function(j,k){f.append(a.tGLi(this));});}$("#teamPkInfo").empty().append(f.toString());});},tGLi:function(b){var a=this;
var c=new StringBuffer();c.append('<div class="team-group-li">').append('<div class="imageDiv" style="display:none;"></div>').append('<div class="team-group-profile">').append("<div>").append('<img class="imgDiv" urlval="'+b.img+'" src="'+ctx+b.img+'" onerror="tgImgError(this);">').append("</div>").append("</div>").append('<div class="team-group-msg">').append('<div class="team-group-name"><i class="fa fa-bookmark" aria-hidden="true"></i>&nbsp;<span class="teamId" createTime="'+b.createTime+'" idVal="'+b.id+'">'+b.name+"</span></div>").append('<div class="team-group-member tg-active"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;团队成员&nbsp;:&nbsp;<span class="selected-emp-count">'+b.teamPkEmpPos.length+"</span>人</div>").append("</div>").append('<div class="team-group-pk"><div><img src="'+ctx+'/img/jt/cs/pk.png"></div><div class="team-group-direct"></div></div>').append('<div class="team-group-target">').append(a._selectPkTeam(b.id,b.pkTeamId)).append('<div class="tg-target-border"></div>').append("</div>").append('<div class="team-group-list">').append('<div class="tg-list-head">').append('<div class="tg-head-title">已选成员</div>').append('<button type="button" class="btn btn-sm  btn-blank add-employee-Btn"><i class="fa fa-plus"></i>&nbsp;添加成员</button>').append('<button type="button" class="btn btn-sm  btn-reset reset-employee-Btn"><i class="fa fa-trash-o"></i>&nbsp;清空</button>').append("</div>").append('<div class="tg-list-body">').append('<div class="samll-scrollbar selected-emp-container">'+a._initEmployeeTable(b.teamPkEmpPos)+"</div>").append("</div>").append("</div>").append('<div class="tg-select">').append('<div class="selectDep">').append('<input readonly="" placeholder="请选择部门" class="form-control select-by-group" id="select-by-group'+b.id+'" title="请选择部门">').append('<input name="assignOgn" type="hidden">').append("</div>").append('<div class="selectEmp">'+a._initEmps()+"</div>").append("</div>").append("</div>");
return c.toString();},_initEmps:function(){var a=this;var b=new StringBuffer();b.append("<input placeholder='请选择员工' readonly class='form-control select-employee'></div>");
b.append("<div class='select-employee-container'>");b.append("<div style='height:7%;width:100%;'>");b.append("<table class='table' style='background-color: #1caf9a;color: #fff;'>");
b.append("<tr><th width='10%'><input type='checkbox' class='employee-select-all'/></th>");b.append("<th width='45%'>员工</th><th width='45%'>部门</th></tr></table></div>");
b.append("<div style='height: 352px;width: 100%;overflow: auto;border-top: 1px solid #ccc; border-bottom: 1px solid #ccc;'>");b.append("<table class='select-employee-table'></table></div>");
return b.toString();},_initEmp:function(){var a=this;var b=new StringBuffer();b.append("<input placeholder='请选择员工' readonly class='form-control select-employee' style='cursor: pointer;float: left;'>");
b.append("<div  class='col-md-12 col-sm-12 select-employee-container' style='width:calc(100% - 4px);display: none;height: 380px;position: absolute;background-color: #fff;z-index: 100;margin: 27px 0px 0px 0px; border: 1px solid #ccc;'>");
b.append("<div style='height:7%;width:100%;'>");b.append("<table class='table' style='background-color:#e6e2e2;'>");b.append("<tr><th width='10%'><input type='checkbox' class='employee-select-all'/></th>");
b.append("<th width='45%'>员工</th><th width='45%'>部门</th></tr></table></div>");b.append("<div style='height: 352px;width: 100%;overflow: auto;border-top: 1px solid #ccc; border-bottom: 1px solid #ccc;'>");
b.append("<table class='select-employee-table'></table></div></div>");return b.toString();},_selectPkTeam:function(e,b){var d=new StringBuffer();var a=teamDatas.rows;
d.append("<select class='selectPkTeam'>");d.append("<option value=''>请选择</option>");for(var c=0;c<a.length;c++){if(e!=a[c].id){if(b==a[c].id){d.append("<option selected='selected' value='"+a[c].id+"'>"+a[c].name+"</option>");
}else{d.append("<option value='"+a[c].id+"'>"+a[c].name+"</option>");}}}d.append("</select>");return d.toString();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("teamPk.button.saveAll")){$(".saveButtonDiv").hide();
}},_save:function(e){var b=this;var a=e?TeamPk._CONS_.SAVE_EDIT_URL:TeamPk._CONS_.SAVE_ADD_URL;var c=$("#addTeamInput").val();if(!c){DialogUtils.error("提示","队名不能为空");
return false;}var d="";d+="&name="+c;FormUtils.submit(a,d,function(f){$(".saveBtn").attr("disabled",false);if(f.success){DialogUtils.success("提示",f.msg);
b._loadData();}else{DialogUtils.error("失败",f.msg);}},function(){$(".saveBtn").attr("disabled",false);DialogUtils.error("错误","后台异常，请稍后重试");});},_showRightMenu:function(a){$("#editTeam-menu").css({top:(a.y-50)+"px",left:(a.x-25)+"px",display:"block"});
if(!ResUtils.canShow("teamPk.button.editName")){$("#teamEditBtn").hide();}if(!ResUtils.canShow("teamPk.button.delete")){$("#teamDelBtn").hide();}},_updateName:function(d,c){var a=this;
var b=ctx+"/crm/ou/team/teamPk/updateName.htm";FormUtils.submit(b,{"id":d,"name":c},function(e){if(e){DialogUtils.success(msgCode.INFO,"修改成功");$("#teamUpdateNameModalContainer").modal("hide");
a._loadData();}else{DialogUtils.error("错误","后台异常！");}});},_saveTeamAll:function(a,b,e){var c=this;var d=ctx+"/crm/ou/team/teamPk/saveTeamAll.htm";ButtonUtils.disableBtn("teamSaveBtn");
FormUtils.submit(d,{type:e,teamPkPos:JSON.stringify(a),teamPkEmpPos:JSON.stringify(b)},function(f){ButtonUtils.enableBtn("teamSaveBtn");if(f.success){DialogUtils.success("提示","保存成功");
}else{DialogUtils.error("错误","后台异常，请稍后重试");}},function(){ButtonUtils.enableBtn("teamSaveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHander:function(){var a=this;
$(document).on("click","#teamSaveBtn",function(){var e=$(".team-group-li");var b=new Array();var c=new Array();var d="all";if(e.length==1){d="one";}e.each(function(){var g={};
var h=$(this);var f=h.find(".emp");var i=h.find(".teamId").attr("idVal");f.each(function(){var j={};j.teamId=i;j.empId=$(this).attr("idval");c.push(j);
});g.img=h.find(".imgDiv").attr("urlval");g.id=i;g.name=h.find(".teamId").text();g.pkTeamId=h.find(".selectPkTeam").val();g.createTime=h.find(".teamId").attr("createTime");
b.push(g);});a._saveTeamAll(b,c,d);});$(document).on("click",".imgDiv",function(){var b=$(this);var c=b.closest(".team-group-profile").prev();ImageUtils.selectImage(0,function(d){var f=ImageUtils.createImageDivStr(d);
c.empty().append(f);var g=ctx+c.find(".file").attr("urlval");var e=c.find(".file").attr("urlval");b.attr("src",g);b.attr("urlval",e);});});$(document).on("click","#teamUpdateNameBtn",function(){var c=$("#teamUpdateName").find("input[name=id]").val();
var b=$("#teamUpdateName").find("input[name=name]").val();if(!b){DialogUtils.error("提示","名称不能为空！");return false;}a._updateName(c,b);});$("div").bind("contextmenu",function(){return false;
});$(document).on("mousedown",".teamLiOne",function(c){if(3==c.which){var d=$(this).find("input").attr("idVal");var b=$(this).find("input").val();$("#teamDelBtn").attr("idVal",d);
$("#teamEditBtn").attr("idVal",d);$("#teamEditBtn").attr("name",b);c.stopPropagation();a._showRightMenu({x:event.pageX,y:event.pageY});}});$(document).on("mouseleave","#editTeam-menu",function(){$("#editTeam-menu").hide();
});$(document).on("click","#teamEditBtn",function(){var c=$(this).attr("idVal");var b=$(this).attr("name");$("#teamUpdateNameModalContainer").modal("show");
$("#teamUpdateName").find("input[name=name]").val(b);$("#teamUpdateName").find("input[name=id]").val(c);});$(document).on("click","#teamDelBtn",function(){var b=$(this).attr("idVal");
DialogUtils.confirm(function(){FormUtils.del(TeamPk._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success("成功","操作成功");a._loadData();}else{DialogUtils.success("失败","后台异常，请稍后重试");
}});});});$(document).on("click",".select-employee",function(){var b=$(this).closest(".team-group-li").find(".select-employee-container");var c=$(this).closest(".team-group-li").find("input[name=assignOgn]").val();
var e=$(this).closest(".team-group-li").find("input[name=assignOgn]").attr("keys");var d=$(this).closest(".team-group-li").find(".selected-emp-container").find(".emp");
var f=new Array();if(d){d.each(function(){f.push($(this).attr("idVal"));});}a._createEmployeeTable(c,b,f,e);if(b.is(":visible")){b.stop().slideUp("fast");
}else{$(".select-employee-container").stop().slideUp("fast");b.stop().slideDown("fast");}});$(document).on("click","#addTeamBtn",function(){a._save();});
$(document).on("click",".teamLi",function(){var b=$(this).find("input").attr("idVal");if(b){a._loadTeam(b);}else{a._loadData(b);}});$(document).on("click",".select-by-group",function(){var b=$(this);
var d=b.attr("id");var c={isMultiple:1,selectedGroupId:$("input[name=assignOgn]").val(),container:d,nolimit:true,positionType:"dept_manager",fn:function(e,f){b.parent().find("input[name=assignOgn]").val(e);
b.parent().find("input[name=assignOgn]").attr("keys",f);}};GroupUtils.selectGroupTreeBox(c);$(".select-employee-container:visible").stop().slideUp("fast");
});$(document).off("click",".select-employee-table tr").on("click",".select-employee-table tr",function(k){var h=$(this).closest(".team-group-li");var j=h.find(".selected-emp-count").text();
var n=$(this);if(k.target.tagName=="INPUT"||k.target.tagName=="input"){}else{var p=$(this).find("input[type='checkbox']")[0].checked;$(this).find("input[type='checkbox']").prop("checked",!p);
}var d=$(this).find("input[type='checkbox']");var p=d[0].checked;var c=d.attr("data-id");var b=d.attr("data-name");var f=d.attr("data-aid");var m=d.attr("data-orgName");
var o={id:c,name:b,aid:f,orgName:m};var l=[];l.push(o);if(p){a._addSelectedEmployee(l,h,j);}else{j--;$("#emp-"+c).remove();delete a.selectedEmployeeMap[c];
for(var g=0;g<a.selectedEmployee.length;g++){if(a.selectedEmployee[g].id==c){a.selectedEmployee.splice(g,1);break;}}if(j<=0){h.find(".selected-emp-container").find(".noData").show();
}h.find(".selected-emp-count").empty().text(j);}});$(document).off("click",".deleteEmployeeBtn").on("click",".deleteEmployeeBtn",function(){var c=$(this).closest(".team-group-li");
var d=c.find(".selected-emp-count").text();var e=$(this).parents(".emp").attr("id").replace("emp-","");$(this).parents(".emp").remove();delete a.selectedEmployeeMap[e];
for(var b=0;b<a.selectedEmployee.length;b++){if(a.selectedEmployee[b].id==e){a.selectedEmployee.splice(b,1);break;}}d--;c.find("#employee-table-"+e).find("input[type='checkbox']").prop("checked",false);
c.find(".selected-emp-count").empty().text(d);if(d==0){if(c.find(".noData").length==0){c.find(".selected-emp-container").append("<span class='noData'>该团队内还没有任何成员哦</span>");
}else{c.find(".noData").show();}}});$(document).on("click",".reset-employee-Btn",function(){var b=$(this).closest(".team-group-li");var c=b.find(".selected-emp-container").find(".emp");
c.each(function(){var d=$(this).attr("id").replace("emp-","");delete a.selectedEmployeeMap[d];});b.find(".selected-emp-container").empty().append('<span class="noData">该团队内还没有任何成员哦</span>');
b.find(".selected-emp-count").empty().text(0);b.find(".select-employee-container").find("input[type='checkbox']").prop("checked",false);});$(document).on("click",".team-group-member",function(){if($(this).is(".tg-active")){a.slideTGLayer($(this).closest(".team-group-li"),false);
$(this).removeClass("tg-active");}else{a.slideTGLayer($(this).closest(".team-group-li"),true);$(this).addClass("tg-active");}});$(document).on("click",".add-employee-Btn",function(){var c=$(this).closest(".team-group-li").find(".team-group-target");
var b="10%";if(a.EmpSelect){layer.close(a.EmpSelect);}a.EmpSelect=layer.open({type:1,title:$(this).closest(".team-group-li").find(".team-group-name").children("span").text()+"&emsp;选择员工面板",area:"500px",offset:b,zIndex:99,shadeClose:true,skin:"tg-select-layer",content:$(this).closest(".team-group-li").find(".tg-select"),success:function(d,e){},cancel:function(f,d){var e=$(d).find(".select-employee-container");
if(e.is(":visible")){e.hide();}$(d).find(".select-by-group").val("");$(d).find(".select-by-group").next().val("");$(d).find(".select-employee").val("");
delete a.EmpSelect;}});});},slideTGLayer:function(c,b){var a=this;if(b){$(c).find(".team-group-direct").stop().show();setTimeout(function(){$(c).find(".team-group-list").stop().slideDown("fast");
},125);}else{$(c).find(".team-group-list").stop().slideUp("fast");setTimeout(function(){$(c).find(".team-group-direct").stop().hide();},200);}},_addSelectedEmployee:function(e,a,d){var f=new StringBuffer();
for(var c=0;c<e.length;c++){var b=e[c];f.append('<div class="emp" idVal="'+b.id+'" id="emp-'+b.id+'"').append(">").append('<i class="fa fa-user" aria-hidden="true" style="color: #ed5565;"></i>&nbsp;').append("<span>"+b.aid+":"+b.name+"").append('<span class="blue">|</span>').append('<i class="fa fa-remove deleteEmployeeBtn"></i>').append("</div>");
d++;this.selectedEmployeeMap[b.id]=b.id;$("#employee-table-"+b.id).find("input[type='checkbox']").prop("checked",true);}if(d>0){a.find(".selected-emp-container").find(".noData").hide();
}a.find(".selected-emp-container").append(f.toString());a.find(".selected-emp-count").empty().text(d);},};function tgImgError(a){$(a).attr("src",ctx+"/img/jt/cs/yk.jpg");
}