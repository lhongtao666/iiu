CsAssign.assign=function(){};function CsAssign(c,a,b,d,e){this.csEntityIds=c;this.limitCount=d;this.assignType=a;this.clearParam=b;this.maxLength=null;
this.employeeList=[];this.selectedEmployee=[];this.selectedEmployeeMap={};this.extensionOption=e;}CsAssign.prototype={init:function(){$("#selected-emp-container").empty();
$("#selected-emp-count").empty().append(0);$("#csCountContainer").empty();$("#csAssignResultContainer").empty();$("#select-by-group").val("");$("input[name=assignOgn]").val("");
$("input[name=assignOgnId]").val("");$("#select-employee").val("");$("#employee-select-all").prop("checked",false);this.selectedEmployee=[];this.selectedEmployeeMap={};
if((this.csEntityIds&&this.csEntityIds.length&&this.csEntityIds[0]=="")&&this.assignType!="clear"){return;}var a=this;if(this.assignType=="clear"){if(this.assignType=="clear"){FormUtils.loadData(ctx+"/crm/cs/csEntity/assign.htm?assignType=clear&"+a.clearParam,function(b){a.csEntityIds=b;
$("#csCountContainer").append(+a.csEntityIds.length);a.maxLength=a.csEntityIds.length;});}}else{$("#csCountContainer").append(this.csEntityIds.length);
a.maxLength=this.csEntityIds.length;}this._bindEventHanlder();this._initEmployee();this._openAssignLayer();this._bindFormValidation();},_dealSyle:function(){var a=$("#assignContainer").find(".modal-body").height()-$("#assiginPartyContainer").outerHeight()-$("#assiginEmployeeContainer").outerHeight()-28-34-31-31;
$("#csAssignResultDiv").height(a);},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation("tableForm",a);},_openAssignLayer:function(){self=this;
$("#assignModalLabel").html(self.limitCount>0?"分配客户资源&emsp;<span>系统限制单次最多分配 [&nbsp;<font>"+self.limitCount+"</font>&nbsp;] 个客户</span>":"分配客户资源");$("#assignContainer").modal("show");
},_saveAssign:function(){var c=$("#assignContainer"),d=$("#csAssignResultContainer",c).attr("csTypeVal"),e=this;var b=e.csEntityIds.slice(0);if($("#csAssignResultContainer tr",c).length){var a=[];
$("#csAssignResultContainer tr",c).each(function(){var h=parseInt($(this).find(".csEntityCount").val());var g=b.splice(0,h);a.push({employeeId:$(this).attr("employeeIdVal"),csEntityIds:g.join(","),});
});var f={resultJson:JSON.stringify(a)};if(this.assignType=="clear"||this.assignType=="csPhone"){f.csType="csPhone";}else{f.csType="csEntity";}ButtonUtils.disableBtn("saveAssign");
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",f,function(g){ButtonUtils.enableBtn("saveAssign");if(g.success){layer.close(e.layerIndex);if($(".csEntitySearch").length){$(".csEntitySearch").trigger("click");
}if($(".insideLineSheetRecordSearch")){if(e.extensionOption&&e.extensionOption.successFn){e.extensionOption.successFn(g);}else{jQuery(".insideLineSheetRecordSearch").trigger("click");
}}if(e.extensionOption&&e.extensionOption.successFn){}else{$("#assignContainer").modal("hide");}}else{if(e.extensionOption&&e.extensionOption.errorFn){var h=$("#assignContainer");
e.extensionOption.errorFn(g,h);}else{DialogUtils.error(msgCode.ERROR,g.msg,c);}}$(".layui-layer-btn0").show();},function(g){ButtonUtils.enableBtn("saveAssign");
DialogUtils.error(msgCode.ERROR,g?g:"操作失败",c);});}else{DialogUtils.error(msgCode.ERROR,"请生产分配方案",c);$(".layui-layer-btn0").show();}},_initEmployee:function(){var a=this;
var b=ctx+"/crm/ou/employee/search.htm?keyword=";FormUtils.loadData(b,function(c){a.employeeList=c.value;a._createEmployeeTable();});},_createEmployeeTable:function(){var c=this.employeeList;
var b=$("input[name='employee-online']")[0].checked;var d=new StringBuffer();for(var a=0;a<c.length;a++){d.append('<tr id="employee-table-'+c[a].id+'" '+(b&&c[a].isOnline!="y"?'style="display:none;"':"")+" >").append('<td width="8%"><input type="checkbox"').append(' data-id="'+c[a].id+'"').append(' data-groupId="'+c[a].groupId+'"').append(' data-name="'+c[a].name+'"').append(' data-aid="'+c[a].aid+'"').append(' data-orgName="'+c[a].orgName+'"').append(' data-isOnline="'+(c[a].isOnline?c[a].isOnline:"n")+'"').append(' data-newCs="'+c[a].newCs+'"').append(' data-csCount="'+c[a].csCount+'"></input></td>').append('<td width="25%">'+c[a].name+":"+c[a].aid+"</td>").append('<td width="25%">'+c[a].orgName+"</td>").append('<td width="20%" class="blue">'+c[a].newCs+"</td>").append('<td width="20%">'+(c[a].isOnline&&c[a].isOnline=="y"?'<span class="red">在线</span>':"离线")+"</td>").append("</tr>");
}$("#select-employee-table").empty().append(d.toString());},_addSelectedEmployee:function(c){var d=new StringBuffer();for(var b=0;b<c.length;b++){var a=c[b];
if(!this.selectedEmployeeMap.hasOwnProperty(a.id)){d.append('<div class="emp emp-items" id="emp-'+a.id+'"').append(">").append("<span>"+a.aid+":"+a.name+'（新进<span class="blue">'+a.newCs+"</span>）</span>").append('<div class="emp-remove deleteEmployeeBtn">').append('<i class="fa fa-remove"></i>').append("</div>").append("</div>");
this.selectedEmployee.push(a);this.selectedEmployeeMap[a.id]=a.id;$("#employee-table-"+a.id).find("input[type='checkbox']").prop("checked",true);}}$("#selected-emp-container").append(d.toString());
$("#selected-emp-count").empty().append(this.selectedEmployee.length);this._dealSyle();},_selectEmployeeByGroupIds:function(){var c=$("input[name=assignOgnId]").val();
if(c==""){DialogUtils.error(msgCode.ERROR,"请选择部门",$("#assignContainer"));return;}var a=this;var d=$("input[name='group-online']")[0].checked;var b=ctx+"/crm/ou/employee/searchBygroup.htm?groupIds="+c+"&isOnline="+(d?"y":"n");
FormUtils.loadData(b,function(e){a._addSelectedEmployee(e.value);});},_createEmployeeLi:function(a){var b=new StringBuffer();b.append("<li idVal='").append(a.id).append("' nameVal='").append(a.name).append("' csCountVal='").append(a.csCount).append("' orgNameVal='").append(a.orgName).append("' aidVal='").append(a.aid).append("' ><a href='javascript: void(0);'>").append(a.name).append("&nbsp;&nbsp;&nbsp;&nbsp;<button class='btn btn-danger btn-xs deleteEmployeeBtn' type='button'><i class='fa fa-remove'></i></button></a></li>");
return b.toString();},_assign:function(){var f=0;var g=this.selectedEmployee;for(var d=0;d<g.length;d++){g[d].csEntityIds=[];}var h=new StringBuffer();
var e=0;var d=0;var b=this;for(var d=0;d<Math.ceil(this.csEntityIds.length/parseFloat(g.length));d++){if(e>=this.csEntityIds.length){break;}for(var c=0;
c<g.length;c++){if(e>=this.csEntityIds.length){break;}g[c].csEntityIds.push(this.csEntityIds[e]);g[c].newCsCount=g[c].newCsCount+1;e++;}}for(var d=0;d<g.length;
d++){if(g[d].csEntityIds.length==0){break;}h.append("<tr employeeIdVal='"+g[d].id+"' >");h.append('<td style="width: 16%">');h.append(g[d].name);h.append(":");
h.append(g[d].aid);h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].orgName);h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].csCount||0);
h.append("</td>");h.append('<td style="width: 20%">');var a=(b.maxLength-(g[d].csMax||0))?b.maxLength:g[d].csMax;h.append("<input required='true' min='1' max='"+a+"' digits='true' name='name"+b._generateCode()+"'  type='text'  valueVal='"+g[d].csEntityIds.length+"' value='"+g[d].csEntityIds.length+"' class='form-control csEntityCount'  validateType='default'>");
h.append("</td>");h.append('<td style="width: 16%">');h.append(g[d].isOnline&&g[d].isOnline=="y"?'<span class="red">在线</span>':"离线");h.append("</td>");
h.append('<td style="width: 16%">');h.append("<button disabled='disabled' class='btn btn-sm btn-outline btn-primary plusBtn' type='button'><i class='fa fa-plus'></i></button>");
h.append("&nbsp;&nbsp;<button class='btn btn-sm btn-outline btn-danger minusBtn' type='button'><i class='fa fa-minus'></i></button>");h.append("&nbsp;&nbsp;<button class='btn btn-sm btn-outline btn-danger deleteEmployeeTrBtn' type='class'><i class='fa fa-remove'></i></button>");
h.append("</td>");h.append("</tr>");}$("#csAssignResultContainer").empty().append(h.toString());$("#remindCsEntityContainer").empty().append(b.csEntityIds.length);
},_generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());
},_caculateRestCount:function(){var b=this;var a=$("#assignContainer");$("#tableForm",a).valid();var c=0;$("input.csEntityCount",a).each(function(){c=c+(parseInt($(this).val())||0);
});var d=b.maxLength-c;$("#remindCsEntityContainer").empty().append((b.csEntityIds.length-d)+"");if(!d){$(".plusBtn").attr("disabled",true);$(".minusBtn").attr("disabled",false);
}else{if(d>=b.maxLength){$(".plusBtn").attr("disabled",false);$(".minusBtn").attr("disabled",true);}else{$(".plusBtn").attr("disabled",false);$(".minusBtn").attr("disabled",false);
}}},_fiterEmployee:function(f){var e=$("input[name='employee-online']")[0].checked;var d=[];var b=$("input[name=assignOgn]").val();if(b!=null&&b!=""){d=b.split(",");
}for(var c=0;c<this.employeeList.length;c++){var a=this.employeeList[c];if(!this.selectedEmployeeMap.hasOwnProperty(a.id)){if((a.name.indexOf(f)!=-1||a.aid.indexOf(f)!=-1)&&self._fiterByGroupKey(d,a)){if(e&&a.isOnline!="y"){$("#employee-table-"+a.id).hide();
}else{$("#employee-table-"+a.id).show();}}else{$("#employee-table-"+a.id).hide();}}}},_fiterByGroupKey:function(e,c){if(e.length<=0){return true;}var a=false;
for(var d=0;d<e.length;d++){var b=e[d];if(c.groupKey.substring(0,b.length)==b){a=true;break;}}return a;},_bindEventHanlder:function(){var a=this;$("#saveAssign").off("click").on("click",function(){var c=ctx+"/crm/cs/csEntity/assign.htm";
var b=$("#assignContainer");if(!$("#tableForm",b).valid()){return;}var d=0;$("input.csEntityCount",b).each(function(){d=d+parseInt($(this).val());});if(a.maxLength&&a.maxLength&&a.maxLength<d){DialogUtils.error(msgCode.ERROR,"需要分配客户数超过可分配数目",b);
return;}a._saveAssign();});$("#assignContainer").off("shown.bs.modal").on("shown.bs.modal",function(){a._dealSyle();});$("#select-by-group").off("click").on("click",function(){var b={isMultiple:1,selectedGroupId:$("input[name=assignOgnId]").val(),container:"select-by-group",nolimit:true,isEqWidth:true,isAutoHeight:true,positionType:"dept_manager",fn:function(c,d){$("input[name=assignOgn]").val(d);
$("input[name=assignOgnId]").val(c);a.groupIds=c;var e=$("#select-employee").val();a._fiterEmployee(e);}};GroupUtils.selectGroupTreeBox(b);});$("#group-select-submit").off("click").on("click",function(){a._selectEmployeeByGroupIds();
});$("input[name='employee-online']").off("change").on("change",function(){var b=$("#select-employee").val();a._fiterEmployee(b);});$("body").on("click",function(b){if($(b.target).attr("id")=="select-employee"){return;
}if($(b.target).parents("#select-employee-container").length<=0){$("#select-employee-container").hide();}});$("#select-employee").off("keyup").on("keyup",function(){var b=$(this).val();
a._fiterEmployee(b);});$("#select-employee").off("focus").on("focus",function(){$("#select-employee-container").show();});$("#employee-select-all").off("click").on("click",function(d){var c=$(this)[0].checked;
if(c){$("#select-employee-table").find("tr:visible").find("input[type='checkbox']").prop("checked",c);var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");
var f=[];$.each(b,function(){var m=$(this).attr("data-id");var h=$(this).attr("data-name");var j=$(this).attr("data-aid");var k=$(this).attr("data-newCs");
var g=$(this).attr("data-csCount");var l=$(this).attr("data-isOnline");var i=$(this).attr("data-orgName");var e={id:m,name:h,aid:j,newCs:k,csCount:g,isOnline:l,orgName:i};
f.push(e);});a._addSelectedEmployee(f);}else{var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");$("#select-employee-table").find("tr:visible").find("input[type='checkbox']").prop("checked",c);
$.each(b,function(){var g=$(this).attr("data-id");$("#emp-"+g).remove();delete a.selectedEmployeeMap[g];for(var e=0;e<a.selectedEmployee.length;e++){if(a.selectedEmployee[e].id==g){a.selectedEmployee.splice(e,1);
break;}}});$("#selected-emp-count").empty().append(a.selectedEmployee.length);a._caculateRestCount();a._dealSyle();}});$("body").off("click","#select-employee-table tr").on("click","#select-employee-table tr",function(k){if(k.target.tagName=="INPUT"||k.target.tagName=="input"){}else{var p=$(this).find("input[type='checkbox']")[0].checked;
$(this).find("input[type='checkbox']").prop("checked",!p);}var f=$(this).find("input[type='checkbox']");var p=f[0].checked;var d=f.attr("data-id");var c=f.attr("data-name");
var g=f.attr("data-aid");var l=f.attr("data-newCs");var h=f.attr("data-csCount");var b=f.attr("data-isOnline");var n=f.attr("data-orgName");var o={id:d,name:c,aid:g,newCs:l,csCount:h,isOnline:b,orgName:n};
var m=[];m.push(o);if(p){a._addSelectedEmployee(m);}else{$("#emp-"+d).remove();delete a.selectedEmployeeMap[d];for(var j=0;j<a.selectedEmployee.length;
j++){if(a.selectedEmployee[j].id==d){a.selectedEmployee.splice(j,1);break;}}$("#selected-emp-count").empty().append(a.selectedEmployee.length);a._caculateRestCount();
a._dealSyle();}});$("#employee-select-submit").off("click").on("click",function(){var b=$("#select-employee-table").find("tr:visible").find("input[type='checkbox']:checked");
var c=[];$.each(b,function(){var k=$(this).attr("data-id");var f=$(this).attr("data-name");var h=$(this).attr("data-aid");var i=$(this).attr("data-newCs");
var e=$(this).attr("data-csCount");var j=$(this).attr("data-isOnline");var g=$(this).attr("data-orgName");var d={id:k,name:f,aid:h,newCs:i,csCount:e,isOnline:j,orgName:g};
c.push(d);});$("#select-employee-table").find("input[type='checkbox']").prop("checked",false);$("#employee-select-all").prop("checked",false);a._addSelectedEmployee(c);
});$("#assignBtn").off("click");$("#assignBtn").on("click",function(){if($("#selected-emp-container .emp").length){a._assign();}else{DialogUtils.error(msgCode.ERROR,"请选择员工",$("#assignContainer"));
}});$("#csAssignResultContainer").off("blur",".csEntityCount").on("blur",".csEntityCount",function(){a._caculateRestCount();});$("#csAssignResultContainer").off("click",".deleteEmployeeTrBtn").on("click",".deleteEmployeeTrBtn",function(){$(this).parents("tr").remove();
a._caculateRestCount();});$("body").off("click","#selectEmployeeBtn").on("click","#selectEmployeeBtn",function(){var b=new EmployeesSelect();var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;
}b.init({isShowAllGroup:c,grantType:"/cs/",isOnlySelfGroup:1,isMultiple:1,mode:1,type:"positionContext",callBack:function(d){a._addSelectedEmployee(d);
}});});$("#selected-emp-container").off("click",".deleteEmployeeBtn").on("click",".deleteEmployeeBtn",function(){var c=$(this).parents(".emp").attr("id").replace("emp-","");
$(this).parents(".emp").remove();delete a.selectedEmployeeMap[c];for(var b=0;b<a.selectedEmployee.length;b++){if(a.selectedEmployee[b].id==c){$("#select-employee").trigger("keyup");
a.selectedEmployee.splice(b,1);break;}}$("#employee-table-"+c).find("input[type='checkbox']").prop("checked",false);$("#selected-emp-count").empty().append(a.selectedEmployee.length);
a._caculateRestCount();a._dealSyle();});$("#reset-emp-Btn").off("click").on("click",function(){$("#selected-emp-container").empty();a.selectedEmployee=[];
a.selectedEmployeeMap={};$("#selected-emp-count").empty().append(0);$("#select-employee").trigger("keyup");$("#select-employee-container").find("input[type='checkbox']").prop("checked",false);
a._dealSyle();});$("body").off("click","#csAssignResultContainer .plusBtn").on("click","#csAssignResultContainer .plusBtn",function(){var c=$(this).parents("tr").find("input");
var b=parseInt(c.val())+1;c.val(b);a._caculateRestCount();});$("body").off("click","#csAssignResultContainer .minusBtn").on("click","#csAssignResultContainer .minusBtn",function(){var c=$(this).parents("tr").find("input");
var b=c.val();b=b-1;c.val(b);a._caculateRestCount();});}};