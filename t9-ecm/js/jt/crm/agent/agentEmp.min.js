$(function(){var a=new AgentEmp();a.init();});function AgentEmp(){this.hadInit=false;this.isEdit=false;this.isInitGrid=false;this.isFormDataChange=false;
this.addressService=new AddressService("addrContainer");}AgentEmp._CONS_={EDIT_URL:ctx+"/crm/agent/agentSku/edit.htm",DETAIL_URL:ctx+"/crm/agent/agentSku/detail.htm",DELETE_URL:ctx+"/crm/agent/agentSku/delete.htm",SAVE_ADD_URL:ctx+"/crm/agent/agentSku/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/agent/agentSku/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/ou/employee/listData.htm?searchInterest=no&searchPerformance=no",LIST_AGENT_EMPLOYEE_TREE:ctx+"/gl/ou/group/findAgentEmployeeTree.htm",DELETE_PROD_CATE_URL:ctx+"/ec/product/prodEntity/deleteByCateId.htm",SAVE_AGENT_COST:ctx+"/crm/agent/agentSku/saveAgentCost.htm",DELETE_AGENT_SKU:ctx+"/crm/agent/agentSku/delete.htm",LIST_ROLE_DATA_URL:ctx+"/crm/ou/role/listRoleByAgent.htm",EMP_EDIT_URL:ctx+"/crm/ou/employee/edit.htm",EMP_DETAIL_URL:ctx+"/crm/ou/employee/detail.htm",RESET_PASS_URL:ctx+"/crm/ou/user/resetPass.htm",PARTY_FORM_ID:"#partyForm",DETAIL_FOMR_ID:"#detailForm",COMMON_EAV_PARAM:{eavSetKey:"employee",containerId:"eavCommonContainer"},EDIT_FORM_ID:"agentSkuForm",GRID:"#agentEmpGrid",PAGER:"#agentEmpPager",DE_IMG:'<img style=\'width:100px; height:100px;\' alt="默认图片"  src="'+ctx+'/img/jt/nophoto.png" />',};
AgentEmp.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this._initOrganizationTree();
this.commonEav=new Eav(AgentEmp._CONS_.COMMON_EAV_PARAM);this.addressService.init({rowFit:"y",isNotRequired:true});$(".storeIdGroup").hide();}},_initOrganizationTree:function(){var a=this;
var b={edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{autoExpandTrigger:true,isCopy:false,isMove:ResUtils.canShow("group.button.drag")?true:false,prev:true,next:true,inner:true,borderMax:10,borderMin:-5,minMoveSize:5,autoOpenTime:500}},async:{enable:true,url:AgentEmp._CONS_.LIST_AGENT_EMPLOYEE_TREE+"?agentId="+agentId,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],dataFilter:function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"){d.name=d.name+"【销】";d.font={"color":"red"};}}}return g;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{beforeDrag:function(d,c){if(!c[0].parentId){return false;
}else{return true;}},beforeDrop:function(f,e,g,d){var c=e[0];if(!g.parentId&&(d=="prev"||d=="next")){return false;}if(d==="prev"||d==="next"){if((c.parentId.isEmpty()&&g.parentId.isEmpty())||(c.parentId==g.parentId)){a._moveHandler(c.id,g.id,null,d);
}else{if(c.parentId!=null&&g.parentId!=null&&c.parentId!=g.parentId){a._moveHandler(c.id,g.id,g.parentId,d);}else{if(c.parentId!=null&&g.parentId==null){a._moveHandler(c.id,g.id,g.id,g.id,d);
}}}return true;}else{if(d==="inner"){if(c==null||g==null){return false;}else{a._moveHandler(c.id,null,g.id,null);return true;}}}return false;},onClick:function(c,e,d){$(".list_wrapper").show();
$(".form_wrapper").stop().animate({"left":$(".form_wrapper").outerWidth()+15+"px"},"fast");$(".agentEmpTab").show();$(".agentEmpDiv").hide();a.currentClickTreeNode=d;
a.treeNodeId=d.id;a.treeNodeType=d.type;a._selectOrg(d);a.initCrumbs(d,"organizationTree");var f={treeNodeId:d.id,treeNodeType:d.type};a.reloadJqgrid(f);
},onRightClick:function(c,e,d){a.currentRightClickTreeNode=d;if(d.isParent){$("#agentGroupDelBtn").hide();}else{$("#agentGroupDelBtn").show();}$("#orgMenuContainer").css({top:(c.pageY-25)+"px",left:(c.pageX-10)+"px",display:"block"});
},onAsyncSuccess:function(d,k,m,f){var g=$.fn.zTree.getZTreeObj("organizationTree");if(m){var n=m.children;for(var j=0;j<n.length;j++){if(n[j].isParent==true){n[j].icon=ctx+"/js/zTree_v3/css/zTreeStyle/img/jt-diy/jt-16.png";
}else{n[j].icon=ctx+"/js/zTree_v3/css/zTreeStyle/img/jt-diy/jt-30.png";}if(childNodes[j].isSale=="y"){childNodes[j].font={"color":"red"};}g.updateNode(n[j]);
}}else{var c=g.getNodes();for(var j=0;j<c.length;j++){c[j].icon=ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy/jt-orgRoot.png";if(c[j].isSale=="y"){c[j].font={"color":"red"};
}g.updateNode(c[j]);}}if(m==null){var g=$.fn.zTree.getZTreeObj("organizationTree");var l=g.getNodes();if(l&&l.length){var e=l[0];g.expandNode(e,true,false,true);
g.selectNode(e);a.currentClickTreeNode=e;a._selectOrg(e);var h={hadInit:true,hadInitClik:false,treeNodeName:""};a.initCrumbs(e,"organizationTree");}}}},view:{selectedMulti:false,fontCss:function(d,c){return(!!c.highlight)?{color:"#A60000","font-weight":"bold"}:{color:"#333","font-weight":"normal"};
}}};$.fn.zTree.init($("#organizationTree"),b);},initCrumbs:function(c,b,a){this.treeNodeName=b;var e=new StringBuffer();if(a){e.append("<span id='attr-value' id-value='"+a.id+"' class='jt-blue'>"+$(".tabli.active").attr(a.attr)+"</span>");
e.append("&gt;");if(!this.hadInitClik){$("body").on("click",".tabli",function(){var f=$(this).attr(a.attr);var g=$(this).attr("id");$("#attr-value").empty().append(f).attr("id-value",g);
});this.hadInitClik=true;}}e.append(d(c));$("#jt-crumbs").empty().append(e.toString());function d(f){if(f.level==0){return"<span class='jt-blue' id-value='"+f.id+"'>"+f.name+"</span>";
}else{return d(f.getParentNode())+"&gt;"+"<span class='jt-blue' id-value='"+f.id+"'>"+f.name+"</span>";}}},_selectOrg:function(d){var b=this;var g=[];var a=d;
while(a){g.push(a);a=a.getParentNode();}var f=new StringBuffer();for(var c=g.length-1;c>=0;c--){if(c==0){f.append('<li class="active">'+g[c].name+"</li>");
}else{f.append("<li>"+g[c].name+"</li>");}}$(".breadcrumb").empty().append(f.toString());var e={treeNodeId:d.id,treeNodeType:d.type};},_clickUp:function(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");
if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");return;}else{if(this.clickCount==1){DialogUtils.error(msgCode.FAIL_MSG,"您已位于第一条记录上！");
return;}else{this.clickCount--;a.selectNode(this.nodeList[this.clickCount-1],false);}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
},_clickDown:function clickDown(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");
return;}else{if(this.nodeList.length==this.clickCount){DialogUtils.error(msgCode.FAIL_MSG,"您已位于最后一条记录上！");return;}else{a.selectNode(this.nodeList[this.clickCount],false);
this.clickCount++;}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";},_searchNode:function(d){var a=$.fn.zTree.getZTreeObj("organizationTree");
var c=$.trim($("#organizationTreeSearch").val());var b="name";if(this.lastValue===c){return;}this.lastValue=c;this._updateNodes(true,this.nodeList);if(c!=""){this.nodeList=a.getNodesByParamFuzzy(b,c);
this._updateNodes(true,this.nodeList);}else{this.nodeList=[];}},_updateNodes:function(b,d){var c=$.fn.zTree.getZTreeObj("organizationTree");if(d){for(var e=0,a=d.length;
e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);}c.updateNode(d[e]);}}},_callNumber:function(){var a=$.fn.zTree.getZTreeObj("organizationTree");
if(this.nodeList.length){a.selectNode(this.nodeList[0],false);this.clickCount=1;document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
}else{if(this.nodeList.length==0){document.getElementById("number").innerHTML="[0/0]";a.cancelSelectedNode();}}if($.trim($("#organizationTreeSearch").val())==""){document.getElementById("number").innerHTML="";
a.cancelSelectedNode();}},_hideNotGrantBtn:function(){if(agentWeihu=="agentWeihu"){if(!ResUtils.canShow("agentMyEmp.button.add")){$(".addEmpBtn").hide();
}if(!ResUtils.canShow("agentMyEmp.button.reset")){$(".resetPassBtn").hide();}}else{if(!ResUtils.canShow("agentEmp.button.add")){$(".addEmpBtn").hide();
}if(!ResUtils.canShow("agentEmp.button.reset")){$(".resetPassBtn").hide();}}},_clear:function(c){var a=this;function b(){$(AgentEmp._CONS_.PARTY_FORM_ID).validate().resetForm();
a._resetTab();$(".deletedHide").show();$(".addPhoneRow").show();$(".operateCol").show();$(".list_wrapper").show();$(".form_wrapper").stop().animate({"left":$(".form_wrapper").outerWidth()+15+"px"},"fast");
$("#custRelTabLi").show();$("#resTip").text("").hide();$(".saveBtn").show();$("#eavCommonContainer").empty();FormUtils.clear("partyForm");$("input[name=aid]").removeAttr("readonly");
$("#partyForm [name=status]").val(["actived"]).trigger("change");$("[name=name]").attr("required","true");$(".addGroup").hide();$("#batch-create-info").hide();
$(".not-batch-create").show();$("#batch-create-label").empty().hide();$(".dataGroup").show();$("#partyForm").find("input[name=title]").val(["男士"]);$("[name=createTime]").text("");
$("[name=updateTime]").text("");$("[name='lastLoginSys']").text("");$("[name='lastLoginCti']").text("");$("[name=adn]").text("");$("#csCount").text("").attr("disabled",true);
$("#selectOrganization").attr("disabled",false);$("#selectDefaultImageBtn").attr("disabled",false);$("#imageConatiner").empty();$(".addPhonePanel tbody").empty();
$(".addPhonePanel tbody").find("input").attr("disabled",false);$(".deleteRow").show();$(".showWhenNoPhone").hide();a.isEdit=false;a.isFormDataChange=false;
if(c){$(".employeeSearch").trigger("click");}}if(a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_clear:function(c){var a=this;function b(){$(".agentEmpTab").show();
$(".agentEmpDiv").hide();$(".employeePkDiv").show();$(AgentEmp._CONS_.PARTY_FORM_ID).validate().resetForm();$("#eavCommonContainer").empty();FormUtils.clear("partyForm");
$("#imageConatiner").empty();$(".addPhonePanel tbody").empty();a.isEdit=false;a.isFormDataChange=false;}if(a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_bindEventHander:function(){var a=this;$(document).on("click",".employeeSearch",function(){$("#nameSearch").val($("#nameSearch").val().trim());
var c=$(this).closest("form").serialize();c=c;a._reloadJqgrid(c);});$("#employeeSearchForm").on("keypress",function(c){if(c.keyCode=="13"){$(".employeeSearch").trigger("click");
}});$(document).on("click","#groupEmpTabLi",function(){if(a.isInitGrid){var c={agentId:agentId,treeNodeId:a.treeNodeId,treeNodeType:a.treeNodeType};a.reloadJqgrid(c);
}else{a._initJqgrid();}});$(document).on("click",".prevBtn",function(){a._clear(false);});$("#clickUp").on("click",function(){a._clickUp();});$("#clickDown").on("click",function(){a._clickDown();
});$("#organizationTreeSearch").on("keyup",function(c){if(c.keyCode==13){a._searchNode(c);a._callNumber();}});$(document).on("mouseleave","#orgMenuContainer",function(){$(this).hide();
});$("#agentGroupModalContainer").on("hidden.bs.modal",function(){FormUtils.clear("orgGroupForm");});$(document).on("click","#agentGroupDelBtn",function(){DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/ou/group/delete.htm",{ids:a.currentRightClickTreeNode.id},function(e){if(e.success){var c=$.fn.zTree.getZTreeObj("organizationTree");
var d=c.getNodeByTId(a.currentRightClickTreeNode.tId);c.removeChildNodes(d);c.removeNode(d);DialogUtils.success(msgCode.SUCCESS,"删除成功");}else{DialogUtils.error(msgCode.ERROR,e.msg);
}});});});$(document).on("click","#agentGroupUpBtn",function(){$("#orgGroupModalLabel").text("更新部门");$("#agentGroupModalContainer").modal("show");$("#groupMgrDiv").show();
FormUtils.loadData(ctx+"/gl/ou/group/edit.htm?id="+a.currentRightClickTreeNode.id,function(c){$("#orgGroupForm").find("input[name='id']").val(c.id);$("#orgGroupForm").find("input[name='depth']").val(c.depth);
$("#orgGroupForm").find("input[name='path']").val(c.path);$("#orgGroupForm").find("input[name='sort']").val(c.sort);$("#orgGroupForm").find("input[name='createBy']").val(c.createBy);
$("#orgGroupForm").find("input[name='createTime']").val(c.createTIme);$("#orgGroupForm").find("input[name='parentId']").val(c.parentId);$("#orgGroupForm").find("input[name='name']").val(c.name);
$("#orgGroupForm").find("input[name='isAgent']").val(c.isAgent);$("#orgGroupForm").find("[name=saleLine]").val([c.saleLine]);$("#orgGroupForm").find("[name=needFinanceConfirm]").val([c.needFinanceConfirm]);
$("#orgGroupForm").find("[name=createTo]").val([c.createTo]);$("#orgGroupForm").find("[name=createToName]").val([c.createToName]);$("#orgGroupForm").find("[name=transTo]").val([c.transTo]);
$("#orgGroupForm").find("[name=transToName]").val([c.transToName]);$("#orgGroupForm").find("[name=workDays]").val([c.workDays]);$("#orgGroupForm").find("[name=workHours]").val([c.workHours]);
$("#orgGroupForm").find("[name=upperLimit]").val([c.upperLimit]);$("#orgGroupForm").find("[name=smsLimit]").val([c.smsLimit]);$("#orgGroupForm").find("[name=seaLimit]").val([c.seaLimit]);
$("#orgGroupForm").find("[name=noOrderTime]").val([c.noOrderTime]);$("#orgGroupForm").find("[name=groupMgrName]").val(c.groupMgrName);$("#orgGroupForm").find("[name=groupMgr]").val(c.groupMgr);
$("#orgGroupForm").find("[name=storeIds]").val(c.storeIds);if(c.percentLimit){$("#orgGroupForm").find("[name=percentLimit]").val([c.percentLimit]);}else{$("#orgGroupForm").find("[name=percentLimit]").val("");
}if(c.isParentIsSale){$("#isNotSale").attr("disabled","disabled");}else{$("#isNotSale").removeAttr("disabled");}$("#orgGroupForm").find("[name=isSale]").val([c.isSale]);
if(c.isSale==="y"){$("#createToDiv").show();$("#saleRangeDiv").show();$("#saleLineDiv").show();$("#salePercentDiv").show();$(".needFinanceConfirmDiv").show();
$("[name=needFinanceConfirm]").val(["y"]);$("[name=saleLine]").attr("required",true);$("[name=needFinanceConfirm]").attr("required",true);}else{$("#createToDiv").hide();
$("#saleRangeDiv").hide();$("#saleLineDiv").hide();$("#salePercentDiv").hide();$(".needFinanceConfirmDiv").hide();$("[name=transTo]").val("");$("[name=createTo]").val("");
$("[name=createToName]").val("");$("[name=needFinanceConfirm]").val(["y"]);$("[name=saleLine]").removeAttr("required");$("[name=needFinanceConfirm]").removeAttr("required");
}$(".belongAgent").hide();});});$(document).on("click",".saveAgentGroupBtn",function(){var f=new StringBuffer();f.append("<option value='"+agentId+"'>"+agentId+"</option>");
$("#belongAgent").empty().append(f.toString());$("#orgGroupForm").find("input[name=isAgent]").val("y");if($("#orgGroupForm").valid()){ButtonUtils.disableBtn("saveAgentGroupBtn");
$("#orgGroupForm").find("select[name=agentId]").val(agentId);var c=$("#orgGroupForm").find("input[name='id']").val()?ctx+"/gl/ou/group/saveEdit.htm":ctx+"/gl/ou/group/saveAdd.htm";
var e=$("#orgGroupForm").find("[name=isSale]:checked").val();if(e!="y"){$("#orgGroupForm").find("[name=createTo]").val("");$("#orgGroupForm").find("[name=transTo]").val("");
$("#orgGroupForm").find("[name=createToName]").val("");$("#orgGroupForm").find("[name=transToName]").val("");$("#orgGroupForm").find("[name=saleLine]").val([""]);
$("#orgGroupForm").find("[name=percentLimit]").val([""]);$("#orgGroupForm").find("[name=needFinanceConfirm]").val(["y"]);}var d=$("#orgGroupForm").serialize();
FormUtils.submit(c,d,function(l){ButtonUtils.enableBtn("saveAgentGroupBtn");if(l.success){FormUtils.clear("orgGroupForm");$("#agentGroupModalContainer").modal("hide");
var h=$.fn.zTree.getZTreeObj("organizationTree");if(l.msgCode==actionCode.CREATE){DialogUtils.success("提示","添加成功");var g=h.getNodeByTId(a.currentRightClickTreeNode.tId);
g.isParent="true";h.updateNode(g);var i=JSON.parse(l.msg);h.addNodes(g,-1,i);}else{DialogUtils.success("提示","修改成功");var j=h.getNodeByTId(a.currentRightClickTreeNode.tId);
var k=JSON.parse(l.msg);j.name=k.name;j.isSale=k.isSale;h.updateNode(j);}}else{DialogUtils.error("失败",l.msg);}},function(){ButtonUtils.enableBtn("saveAgentGroupBtn");
DialogUtils.error("错误","后台异常，请稍后重试");});}});$(document).on("click","#agentGroupAddBtn",function(){$("input[name='parentId']").val(a.currentRightClickTreeNode.id);
$("#orgGroupModalLabel").text("添加部门");$("#agentGroupModalContainer").modal("show");$(".belongAgent").hide();$("#groupMgrDiv").hide();$("[name=saleLine]").val(["one"]);
if(a.currentRightClickTreeNode.isSale=="y"){$("#orgGroupForm").find("#createToDiv").show();$("#orgGroupForm").find("#saleRangeDiv").show();$("#orgGroupForm").find("#saleLineDiv").show();
$("#orgGroupForm").find("#salePercentDiv").show();$("#orgGroupForm").find(".needFinanceConfirmDiv").show();$("#orgGroupForm").find("[name=saleLine]").val(["one"]);
$("#orgGroupForm").find("[name=needFinanceConfirm]").val(["y"]);$("#orgGroupForm").find("[name=saleLine]").attr("required",true);$("#orgGroupForm").find("[name=needFinanceConfirm]").attr("required",true);
}else{$("#orgGroupForm").find("#createToDiv").hide();$("#orgGroupForm").find("#saleRangeDiv").hide();$("#orgGroupForm").find("#saleLineDiv").hide();$("#orgGroupForm").find("#salePercentDiv").hide();
$("#orgGroupForm").find(".needFinanceConfirmDiv").hide();$("#orgGroupForm").find("[name=transTo]").val("");$("#orgGroupForm").find("[name=createTo]").val("");
$("#orgGroupForm").find("[name=createToName]").val("");$("#orgGroupForm").find("[name=saleLine]").val([""]);$("#orgGroupForm").find("[name=needFinanceConfirm]").val(["y"]);
$("#orgGroupForm").find("[name=saleLine]").removeAttr("required");$("#orgGroupForm").find("[name=needFinanceConfirm]").removeAttr("required");}});$(document).on("click","input[name=isSale]",function(){var c=$(this).val();
if(c=="y"){$("#createToDiv").show();$("#saleRangeDiv").show();$("#saleLineDiv").show();$("#salePercentDiv").show();$(".needFinanceConfirmDiv").show();$("#orgGroupForm").find("[name=saleLine]").val(["one"]);
$("#orgGroupForm").find("[name=needFinanceConfirm]").val(["y"]);$("#orgGroupForm").find("[name=saleLine]").attr("required",true);$("#orgGroupForm").find("[name=needFinanceConfirm]").attr("required",true);
}else{if(c=="n"){$("#createToDiv").hide();$("#saleRangeDiv").hide();$("#saleLineDiv").hide();$("#salePercentDiv").hide();$(".needFinanceConfirmDiv").hide();
$("#orgGroupForm").find("[name=transTo]").val("");$("#orgGroupForm").find("[name=createTo]").val("");$("#orgGroupForm").find("[name=createToName]").val("");
$("#orgGroupForm").find("[name=saleLine]").val([""]);$("#orgGroupForm").find("[name=needFinanceConfirm]").val(["y"]);$("#orgGroupForm").find("[name=saleLine]").removeAttr("required");
$("#orgGroupForm").find("[name=needFinanceConfirm]").removeAttr("required");}}});$(document).on("click",".addEmpBtn",function(){var d=$("#organizationTree").find("li");
if(d.length>0){a.isEdit=false;var c="ecm";$("#groupType").val("add");$(".agentEmpTab").hide();$(".agentEmpDiv").show();$(".employeePkDiv").hide();a._add(c);
}else{DialogUtils.error("提示","该代理商没有部门不能添加员工，请先添加部门！");}});$("body").on("click",".empEdit",function(){var c=a._getSingleSelectedId($(this));$(".agentEmpTab").hide();
$(".agentEmpDiv").show();$(".employeePkDiv").hide();if(c){if(b(c)){a.isEdit=true;a._edit(c);}}});$("#selectDefaultImageBtn").click(function(){ImageUtils.selectImage(0,function(c){var d=ImageUtils.createImageDivStr(c);
$("#imageConatiner").empty().append(d);});});$("#groupName").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$('input[name="groupId"]').val(),agentId:agentId,container:"groupName",hideSale:true,positionType:"isAgent",fn:function(c){$('input[name="groupId"]').val(c);
}});});$("#positionNames").on("click",function(){GroupUtils.selectGroupTreeBox({selectedGroupId:$('input[name="position"]').val(),agentId:agentId,container:"positionNames",hideSale:true,positionType:"isAgent",fn:function(c){$('input[name="position"]').val(c);
}});});$(document).on("click",".saveBtn",function(){if(a.isBatchCreateSwitchery&&a.isBatchCreateSwitchery.isChecked()){a._batchCreate();}else{var c=$("#partyForm").find("[name=id]").val()?ctx+"/crm/ou/employee/saveEdit.htm":ctx+"/crm/ou/employee/saveAdd.htm";
a._saveEmployee(c);}});function b(d){if($.isArray(d)){for(var e=d.length-1;e>=0;e--){var c=d[e];var f=$(AgentEmp._CONS_.GRID).jqGrid("getRowData",c);if("deleted"==f.status){DialogUtils.error(msgCode.ERROR,"已删除员工不能操作");
return false;}}return true;}else{var f=$(AgentEmp._CONS_.GRID).jqGrid("getRowData",d);if("deleted"==f.status){DialogUtils.error(msgCode.ERROR,"已删除员工不能操作");
return false;}else{return true;}}}$(document).on("click",".resetPassBtn",function(){var c=a._getMultiSelectedId($(this));if(c){if(b(c)){a._resetPass(c);
}}});$(document).on("click",".chooseCreateTo",function(){var c=new EmployeesSelect();var d={grantType:"/role/",isMultiple:0,isSale:0,mode:0,type:"agentEmp",agentId:agentId,callBack:function(e){$("#orgGroupForm").find("[name=createToName]").val(e[0].aid+":"+e[0].name);
$("#orgGroupForm").find("[name='createTo']").val(e[0].id);}};c.init(d);});$(document).on("click","#clearTransTo",function(){$("#orgGroupForm").find("[name=transToName]").val("");
$("#orgGroupForm").find("[name='transTo']").val("");});$(document).on("click","#clearCreateTo",function(){$("#orgGroupForm").find("[name=createToName]").val("");
$("#orgGroupForm").find("[name='createTo']").val("");});$(document).on("click",".chooseTransTo",function(){var c=new EmployeesSelect();var d={grantType:"/role/",isMultiple:0,isSale:0,mode:0,type:"agentEmp",agentId:agentId,callBack:function(e){$("#orgGroupForm").find("[name=transToName]").val(e[0].aid+":"+e[0].name);
$("#orgGroupForm").find("[name='transTo']").val(e[0].id);}};c.init(d);});$(document).on("click",".chooseGroupMgr",function(){var c=new EmployeesSelect();
var d={grantType:"/role/",isMultiple:0,isSale:0,mode:0,type:"agentEmp",agentId:agentId,callBack:function(e){$("#orgGroupForm").find("[name=groupMgrName]").val(e[0].aid+":"+e[0].name);
$("#orgGroupForm").find("[name='groupMgr']").val(e[0].id);}};c.init(d);});$(document).on("click","#clearGroupMgr",function(){$("#orgGroupForm").find("[name=groupMgrName]").val("");
$("#orgGroupForm").find("[name='groupMgr']").val("");});$(document).on("click",".empDel",function(){var c=a._getMultiSelectedId($(this));if(($.isArray(c)&&!c.length)||(!$.isArray(c)&&!c)){return;
}if(b(c)){DialogUtils.confirmWithOptions({title:"删除会释放工号,删除的员工无法恢复,确定吗?",text:"",confirmButtonText:"确定",yesFunc:function(){a._deleteEmp(c);}});}});},_getContainer:function(b){var a=this;
var c=false;if(b){c=$("#"+b);if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");if(c.length==0){return false;}}}}return c;},_deleteEmp:function(b){var a=this;
if(b.indexOf("admin")>=0){DialogUtils.error(msgCode.ERROR,"admin用户不能删除,请检查后重试");return;}FormUtils.del(ctx+"/crm/ou/employee/delete.htm",b,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
var c={agentId:agentId,treeNodeId:a.treeNodeId,treeNodeType:a.treeNodeType};a.reloadJqgrid(c);}else{DialogUtils.error(msgCode.error,d.msg);}});},_resetPass:function(b){var a=this;
var c={title:"确定重置密码吗?",text:"重置密码将会把员工密码重置为默认的6位密码",cancelButtonText:"取消",confirmButtonText:"重置",isNeedAutoClose:false,yesFunc:function(){FormUtils.submit(AgentEmp._CONS_.RESET_PASS_URL,{userId:b},function(e){if(e.success){var d={title:e.msg,text:"请使用此重置后的密码进行登录",showCancelButton:false,confirmButtonText:"确定",confirmButtonColor:"#1ab394",yesFunc:function(){},};
DialogUtils.confirmWithOptions(d);}else{DialogUtils.error("失败",e.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});}};DialogUtils.confirmWithOptions(c);
},_getMultiSelectedId:function(b){var a=b.attr("idVal");if(!a){a=$(AgentEmp._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");
return;}}return a;},_edit:function(a){$(".dataGroup").show();$(".addGroup").hide();$(".addAddr").show();$("#selectOrganization").show();$("#selectDefaultImageBtn").show();
$(".edit-addr").show();$(".operation").show();$("#saveEmpTip").hide();$(".list_wrapper").hide();$(".form_wrapper").stop().animate({"left":"15px"},"fast");
$("input[name='adn']").attr("readonly","readonly");this._loadData(a);this.commonEav.setEntityId(a);this.commonEav.renderEavForm();FormUtils.enableForm("partyForm");
},_loadData:function(e,b,d){var a=this;var c="";if(b){c=AgentEmp._CONS_.EMP_DETAIL_URL;}else{c=AgentEmp._CONS_.EMP_EDIT_URL;}FormUtils.loadData(c+"?id="+e,function(k){if(agentWeihu=="agentWeihu"){$("[name=aid]").attr("readonly",true);
}$("[name=sys]").val(k.sys);if(k.sex!=""){$("input[name='sex'][value="+k.sex+"]").attr("checked",true);}$("[id=id]").val(k.id);$("#partyForm").find("input[name=agentId]").val(k.agentId);
$("[id=name]").val(k.name);$("[name=aid]").val(k.aid);$("#partyForm").find("[name=status]").val([k.status]);$("[id=desc]").val(k.desc);$("#csCount").text(k.csCount).attr("disabled",true);
$("#roleSelect").empty();$("[name=groupId]").val(k.groupId);$("[name=groupName]").val(k.orgName);$("[name=position]").val(k.position);$("[name=positionNames]").val(k.positionNames);
$("[name=wxCsToAid]").val(k.wxCsToAid);$("[name='lastLoginSys']").text(k.lastLoginSys?k.lastLoginSys:"无");$("[name='lastLoginCti']").text(k.lastLoginCti?k.lastLoginCti:"无");
$("[name='createTime']").text(k.createTime?k.createTime:"无");$("[name=adn]").text(k.adn?k.adn:"无");$("input[name=activeTime]").val(k.activeTime);var n="";
if(k.profile==""){var l="/img/jt/defaulTouXiang.png";n=[{url:l,name:"",id:""}];}else{n=[{url:k.profile,name:"",id:""}];}var j=ImageUtils.createImageDivStr(n);
$("#imageConatiner").empty().append(j);$("[name='userPo.mobile']").val(k.userPo.mobile);$("[name='userPo.email']").val(k.userPo.email);$("[name='userPo.ipAddr']").val(k.userPo.ipAddr);
if(k.userPo.visitScope=="both"){$(".outSideDiv").show();}else{$(".outSideDiv").hide();}$("[name='userPo.visitScope']").val(k.userPo.visitScope);$("[name='userPo.beginHm']").val(k.userPo.beginHm);
$("[name='userPo.endHm']").val(k.userPo.endHm);$("[name='userPo.outIpAddr']").val(k.userPo.outIpAddr);a._loadRoleData("roleSelect",k.userPo.id,$("[name=sys]").val());
var h=b?true:false;$("[name=addr]").val(k.address);a.addressService.init({country:"ChinaCityCateType-root",province:k.province,city:k.city,area:k.area,town:k.town,rowFit:"y",isNotRequired:true,disabled:h,isHideCountry:true});
if(b){$("img.deleteImage").hide();}var m=new StringBuffer();var f=k.userPo.userRoleList;for(var g=0;g<f.length;g++){m.append(f[g].exportColumns);if(g!=f.length-1){m.append(",");
}}personalGrantExportColumns=m.toString();});},_getSingleSelectedId:function(b){var a=b.attr("idVal");if(!a){a=$(AgentEmp._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(a==null||a.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(a.length>1){DialogUtils.error("错误","不能同时操作多条记录");return;}}return a;},_getAddrsJson:function(){var a=this.addressService.getAddress();
var b="province="+a.province+"&city="+a.city+"&area="+a.area+"&town="+a.town;b+="&address="+$('input[name="addr"]').val();return b;},_saveEmployee:function(b,a){var c=this;
var e=$(AgentEmp._CONS_.PARTY_FORM_ID).valid()&&this.commonEav.isValid()&&$(AgentEmp._CONS_.PARTY_FORM_ID).valid();if(e){}else{return false;}$(".saveBtn").attr("disabled",true);
var d=c._getParams();FormUtils.submit(b,d,function(g){$(".saveBtn").attr("disabled",false);if(g.success){DialogUtils.success("提示",g.msg);c.isFormDataChange=false;
c.isEdit=false;if(a){a();}else{c._clear(true);}var f={agentId:agentId,treeNodeId:c.treeNodeId,treeNodeType:c.treeNodeType};c.reloadJqgrid(f);}else{DialogUtils.error("失败",g.msg);
}},function(){$(".saveBtn").attr("disabled",false);DialogUtils.error("错误","后台异常，请稍后重试");});},_batchCreate:function(){var b=this;var d=$(AgentEmp._CONS_.PARTY_FORM_ID).valid()&&this.commonEav.isValid()&&$(AgentEmp._CONS_.PARTY_FORM_ID).valid();
if(d){}else{return false;}var c=b._getParams();var a=ctx+"/crm/ou/employee/batchCreate.htm";FormUtils.submit(a,c,function(f){$(".saveBtn").attr("disabled",false);
if(f.success){DialogUtils.success(msgCode.SUCCESS,f.msg);b.isFormDataChange=false;b.isEdit=false;b._clear(true);var e={agentId:agentId,treeNodeId:b.treeNodeId,treeNodeType:b.treeNodeType};
b.reloadJqgrid(e);}else{DialogUtils.error("失败",f.msg);}},function(){$(".saveBtn").attr("disabled",false);DialogUtils.error("错误","后台异常，请稍后重试");});},_getParams:function(){var h=this;
var c=($("[name=roleIds]").val()&&$("[name=roleIds]").val().length>0)?$("[name=roleIds]").val().join(","):"";var b="&"+$(AgentEmp._CONS_.PARTY_FORM_ID).serialize();
var f=($("#imageConatiner").find("div.file").length)?("&profile="+$("#imageConatiner").find("div.file").attr("urlVal")):"";if(f.indexOf("?")>-1){f=f.split("?")[0];
}var a="&"+$(AgentEmp._CONS_.DETAIL_FOMR_ID).serialize()+f;var g="&"+this.commonEav.getEavParams();var e=h._getAddrsJson();var i="&userPo.id="+$("[name=id]").val()+"&userPo.account="+$("[name=aid]").val()+"&userPo.roleIds="+c;
var d=b+"&"+e+"&"+i+"&"+g+"&"+a;return d;},_add:function(d){var a=this;$("input[name='aid']").removeAttr("readonly");$("input[name='adn']").removeAttr("readonly");
$("[name=sys]").val(d);$("#partyForm").find("input[name='groupId']").val(a.currentClickTreeNode.id);$("#partyForm").find("#groupName").val(a.currentClickTreeNode.name);
$("#partyForm").find("input[name='agentId']").val(agentId);$("#saveEmpTip").show();$(".dataGroup").hide();$(".addGroup").show();$(".outSideDiv").hide();
$(".is-batch-create-status").empty().append('<input type="checkbox" value="y" name="isBatchCreate" class="js-switch" />');a.isBatchCreateSwitchery=new Switchery(document.querySelector(".is-batch-create-status .js-switch"),{size:"small"});
a.isBatchCreateSwitchery.handleOnchange=function(g){if(g){$("#batch-create-info").show();$(".not-batch-create").hide();var h=new StringBuffer();h.append('<div class="col-sm-6 batch-create" style="float:left;">');
h.append('<div class="input-group">');h.append('<input required="true" digits="true" min="1" max="1000" name="batchCreateCount" placeholder="" validatetype="default" type="text" class="form-control">');
h.append('<span class="input-group-addon">个</span>');h.append("</div>");h.append("</div>");$("#batch-create-info").empty().append(h.toString());var f=new StringBuffer();
f.append('<div class="control-label batch-create" style="text-align:left;">');f.append("<strong>(工号顺序递增)</strong>");f.append("</div>");$("#batch-create-label").empty().show().append(f.toString());
}else{$("#batch-create-info").empty();$(".not-batch-create").show();$("#batch-create-info").hide();$("#batch-create-label").empty().hide();}};$(".list_wrapper").hide();
$(".form_wrapper").stop().animate({"left":"15px"},"fast");$("#roleSelect").empty();$("#partyForm [name=status]").val(["actived"]);$("#partyForm [name=title]").val(["男士"]);
var c="/img/jt/defaulTouXiang.png";var e=[{url:c,name:"",id:""}];var b=ImageUtils.createImageDivStr(e);$("#imageConatiner").empty().append(b);$(".deleteImage ").hide();
this._loadRoleData("roleSelect",null,d);this.commonEav.renderEavForm();},_loadRoleData:function(d,c,b){var a=this;FormUtils.loadData(AgentEmp._CONS_.LIST_ROLE_DATA_URL+"?id="+c+"&sys="+b+"&isAgent=y",function(f){if(f.success){var e=JSON.parse(f.msg);
a._resetRoleChosen(e,[]);}else{DialogUtils.error("错误",f.msg);}});},_resetRoleChosen:function(d,a){var e=new StringBuffer();if(d&&d.length>0){for(var c=0;
c<d.length;c++){if(d[c].selected==true){e.append("<option value='").append(d[c].value).append("' selected='selected'>").append(d[c].name).append("</option>");
}else{e.append("<option value='").append(d[c].value).append("' ");for(var b=0;b<a.length;b++){if(d[c].value==a[b]){e.append("selected='selected' ");break;
}}e.append(">").append(d[c].name).append("</option>");}}}$("#roleSelect").empty().append(e.toString());$("#roleSelect").chosen("destroy");$("#roleSelect").chosen({width:"100%"});
},_bindFormValidation:function(){var b={rules:{},messages:{}};FormUtils.bindFormValidation(AgentEmp._CONS_.EDIT_FORM_ID,b);jQuery.validator.addMethod("isNumber",function(f,e){return this.optional(e)||/^[-\+]?\d+$/.test(f)||/^[-\+]?\d+(\.\d{1}|\.\d{2})?$/.test(f);
},"只能输入两位小数");var d={rules:{name:{required:true},isSale:{required:true},workHours:{isNumber:true,min:0.01},workDays:{isNumber:true,min:0.01},smsLimit:{required:false,digits:true,min:0,},percentLimit:{digits:true,number:true,min:10,max:100}}};
FormUtils.bindFormValidation("orgGroupForm",d);jQuery.validator.addMethod("isDate",function(f,e){return this.optional(e)||/^(20|21|22|23|[0-1]{1}[0-9]{1}):[0-5]{1}[0-9]{1}$/.test(f);
},"格式必须是HH:mm");var c={rules:{"profile":{maxlength:["255"],},"aid":{required:true,isExistsAccount:"id"},"adn":{required:true,},"userPo.mobile":{required:false,mobile:true,isExistsMob:"id",}},messages:{aid:{isExistsAccount:"工号已经存在"}}};
FormUtils.bindFormValidation("partyForm",c);var a={rules:{"userPo.email":{required:false,email:true,},"userPo.beginHm":{isDate:true,},"userPo.endHm":{isDate:true,},},messages:{}};
FormUtils.bindFormValidation("detailForm",a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(AgentEmp._CONS_.GRID,a);},_initJqgrid:function(c){var a=this;
if(c==null||typeof c==undefined){c={};}c.agentId=agentId;a.isInitGrid=true;var b=false;if(!ResUtils.canShow("agentEmp.button.edit")&&!ResUtils.canShow("agentEmp.button.delete")){b=true;
}$(AgentEmp._CONS_.GRID).JTJqgrid({url:AgentEmp._CONS_.LIST_DATA_URL,pager:AgentEmp._CONS_.PAGER,postData:c,colNames:["头像","工号","姓名","分机","所属部门","角色","岗位","已有客户","在线","状态","操作",],colModel:[{name:"profile",index:"profile",width:38,align:"center",formatter:function(d,g,i){var h=AgentEmp._CONS_.DE_IMG;
var f="<img onerror='onImageError()' style='display: inline; height:35px;' ";if(i.profile!=""&&i.profile!=null){var e={url:i.profile,name:"",id:""};f=f+" src='"+ImageUtils.getUrl(e)+"?dm=_mm' ";
}else{f=f+" src='"+ctx+"/img/jt/defaulTouXiang.png' ";}f+=" >";return f;}},{name:"aid",index:"employee.aid_",width:75,align:"center",formatter:function(f,e,g){if(g.footData){$(".ui-jqgrid-title").css({"width":"100%"});
var h=new StringBuffer();h.append(g.aid);return h.toString();}else{if(g.aid!=null&&g.aid!=""){if(g.status=="deleted"){var d=g.aid.split("_");return d[0];
}else{return g.aid;}}}}},{name:"name",width:70,index:"employee.name_",align:"center",sortable:false},{name:"adn",width:55,align:"center",index:"employee.adn_"},{name:"orgName",width:110,align:"center",index:"group_.name_"},{name:"roleNames",width:100,align:"center",sortable:false},{name:"positionNames",width:120,align:"center",sortable:false,formatter:function(h,e,g){if(h){h=h.split(",");
}var d="";if(h&&h.length){for(var f=0;f<h.length;f++){d+=h[f];if(f<h.length-1){d+="<br>";}}}return d;}},{name:"csCount",width:70,align:"center",index:"employee.cs_count_",formatter:function(d,e,f){return f.csCount;
}},{name:"online",index:"user.is_online_",width:56,align:"center",sortable:true,formatter:function(d,e,f){if(f.isOnline=="y"){return"<font style='color:red'>在线 </font>";
}else{return"离线";}}},{name:"statusName",width:56,align:"center",index:"employee.status_",formatter:function(d,e,f){if(f.status=="actived"){return"<span class='text text-primary'>激活</span>";
}else{if(f.status=="locked"){return"<span class='text text-warning'>锁定</span>";}else{if(f.status=="inactive"){return"<span class='text text-warning'>已注销</span>";
}else{if(f.status=="deleted"){return"<span class='text text-danger'>已删除</span>";}else{return"";}}}}}},{name:"caozuo",index:"caozuo",hidden:b,align:"center",width:150,formatter:function(d,e,f){var g=new StringBuffer();
if(ResUtils.canShow("agentEmp.button.edit")){g.append("<button idVal='"+f.id+"' style='min-width:auto;' type='button' class='btn btn-sm jt-btn-normal empEdit'>编辑</button>&ensp;&ensp;");
}if(ResUtils.canShow("agentEmp.button.delete")&&agentWeihu!="agentWeihu"){g.append("<button idVal='"+f.id+"' style='min-width:auto;' type='button' class='btn btn-sm jt-btn-normal empDel'>删除</button>");
}else{if(ResUtils.canShow("agentMyEmp.button.delete")){g.append("<button idVal='"+f.id+"' style='min-width:auto;' type='button' class='btn btn-sm jt-btn-normal empDel'>删除</button>");
}}return g.toString();}}],loadComplete:function(){$(window).resize();},gridComplete:function(){$(window).resize();},});}};