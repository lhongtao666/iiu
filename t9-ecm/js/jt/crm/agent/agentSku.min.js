$(function(){var a=new AgentSku();a.init();});function AgentSku(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.seniorSearch=new SeniorSearch();
this.agentSkuDatas=null;this.selectStoreId="";}AgentSku._CONS_={EDIT_URL:ctx+"/crm/agent/agentSku/edit.htm",DETAIL_URL:ctx+"/crm/agent/agentSku/detail.htm",DELETE_URL:ctx+"/crm/agent/agentSku/delete.htm",SAVE_ADD_URL:ctx+"/crm/agent/agentSku/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/agent/agentSku/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/agent/agentSku/listData.htm",DELETE_PROD_CATE_URL:ctx+"/ec/product/prodEntity/deleteByCateId.htm",SAVE_AGENT_COST:ctx+"/crm/agent/agentSku/saveAgentCost.htm",SAVE_PROD_WEIGHT:ctx+"/crm/agent/agentSku/saveProdWeight.htm",DELETE_AGENT_SKU:ctx+"/crm/agent/agentSku/delete.htm",AGENT_LIST_URL:ctx+"/crm/agent/agentEntity/hasSkuAgentEntity.htm",EDIT_FORM_ID:"agentSkuForm",GRID:"#agentSkuGrid",PAGER:"#agentSkuPager",DE_IMG:'<img style=\'width:100px; height:100px;\' alt="默认图片"  src="'+ctx+'/img/jt/nophoto.png" />',};
AgentSku.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this._loadProdCateTree();this._prodSearch();this._loadAgentEntity();}},_loadAgentEntity:function(){var a=this;var b=AgentSku._CONS_.AGENT_LIST_URL;var c=a._getContainer("agentEntityList");
FormUtils.loadData(b,function(e){if(e&&e.length>0){var f=new StringBuffer();for(var d=0;d<e.length;d++){f.append("<option value='"+e[d].id+"'>"+e[d].name+"</option>");
}c.empty().append(f.toString());}if(c&&c.is(".selectpicker")){c.selectpicker("refresh");}});},_getContainer:function(b){var a=this;var c=false;if(b){c=$("#"+b);
if(c.length==0){c=$("select."+b);if(c.length==0){c=$("select[name='"+b+"']");if(c.length==0){return false;}}}}return c;},_prodSearch:function(a){var b=this;
if(a==undefined){a=$("select[name=storeIds]").val();}$("#searchProd").bsSuggest("destroy");if(a==null||a==""){return;}b.selectStoreId=a;var e=$("#searchProd").width()+"px";
if($("#searchProd").width()<=500){e=($(".itemDiv").width()*5/6)+"px";}var c="entity";var g=$("#hasStock").is(":checked")?"y":"n";var f=$("#prod-price-type").val();
var d="y";$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/listAgentSku.htm?prodType="+c+"&hasStock="+g+"&storeId="+a+"&priceType="+f+"&agentId="+agentId+"&keyword=",effectiveFields:["prodPic","prodName","skuCode","cateName","unit","prodTotal","skuAttr","canSaleQty"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodPic:"图片",prodName:"产品名字",skuCode:"sku编码",cateName:"产品分类",unit:"单位",prodTotal:"价格",skuAttr:"sku属性",canSaleQty:"可售数量"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(h){for(var k=0;
k<h.value.length;k++){var j="<img style='display: inline; height:35px;' ";if(h.value[k].prodPic){j=j+" src='"+ctx+h.value[k].prodPic+"'>";}else{j=j+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";
}h.value[k].prodPic=j;}b.searchProds=h.value;return h;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(i,h){}).on("onSetSelectValue",function(m,h){for(var l=0;
l<b.searchProds.length;l++){if(b.searchProds[l].skuId==h.id){b.currentProd=b.searchProds[l];break;}}var k=[];k.push(h.id);var j=b.selectStoreId;FormUtils.submit(ctx+"/crm/agent/agentSku/saveAdd.htm",{skuIds:k,agentId:agentId,storeId:j},function(i){if(i.success){DialogUtils.success("提示","操作成功");
params={};params.agentId=agentId;b.reloadJqgrid(params);}});$("#searchProd").val("");}).on("onUnsetSelectValue",function(h){b.currentProd={};});},checkIsCanAddSoItem:function(b){if(parseFloat(b.buyLimit)){var a=$("#soItemTbody").find("tr");
if(a&&a.length>0){var e=0;for(var c=0;c<a.length;c++){var d=$(a[c]);if(d.find(".skuId").val()==b.skuId){e+=parseInt(d.find(".soItemCount").val());}}if((e+1)>parseFloat(b.buyLimit)){var f=b.prodName+", 每单数量限制不能大于"+b.buyLimit+"个";
$("#soItemWarm").attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+f+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soItemWarm").popover("show");setTimeout(function(){$("#soItemWarm").popover("destroy");},3000);return false;}}return true;}else{return true;}},_loadProdCateTree:function(){var a=this;
var d=true;var c="n";var b={treeId:"prodEntityCateTree",cateTypeKey:"product_catalog",rootKey:"category",userId:"",limitProdCate:c,dragAble:ResUtils.canShow("prodEntity.button.drag")?true:false,onClick:function(e){a.seniorSearch.initCrumbs(e,"prodEntityCateTree");
a.cateId=e.id;a.cateName=e.name;if(a._hadInitJqgrid){var f={};f.agentId=agentId;f.cateId=a.cateId;a.reloadJqgrid(f);}else{a._hadInitJqgrid=true;a._initJqgrid();
}}};ZtreeUtils.init(b);},_clickUp:function(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");
return;}else{if(this.clickCount==1){DialogUtils.error(msgCode.FAIL_MSG,"您已位于第一条记录上！");return;}else{this.clickCount--;a.selectNode(this.nodeList[this.clickCount-1],false);
}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";},_clickDown:function clickDown(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");
if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");return;}else{if(this.nodeList.length==this.clickCount){DialogUtils.error(msgCode.FAIL_MSG,"您已位于最后一条记录上！");
return;}else{a.selectNode(this.nodeList[this.clickCount],false);this.clickCount++;}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
},_searchNode:function(d){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");var c=$.trim($("#prodEntityCateTreeSearch").val());var b="name";if(this.lastValue===c){return;
}this.lastValue=c;this._updateNodes(true,this.nodeList);if(c!=""){this.nodeList=a.getNodesByParamFuzzy(b,c);this._updateNodes(true,this.nodeList);}else{this.nodeList=[];
}},_updateNodes:function(b,d){var c=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(d){for(var e=0,a=d.length;e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);
}c.updateNode(d[e]);}}},_callNumber:function(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(this.nodeList.length){a.selectNode(this.nodeList[0],false);
this.clickCount=1;document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";}else{if(this.nodeList.length==0){document.getElementById("number").innerHTML="[0/0]";
a.cancelSelectedNode();}}if($.trim($("#prodEntityCateTreeSearch").val())==""){document.getElementById("number").innerHTML="";a.cancelSelectedNode();}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("agentSku.button.detail")){$(".agentSkuDetail").hide();
}if(!ResUtils.canShow("agentSku.button.add")){$(".agentSkuAdd").hide();}if(!ResUtils.canShow("agentSku.button.edit")){$(".agentSkuEdit").hide();}if(!ResUtils.canShow("agentSku.button.delete")){$(".agentSkuDel").hide();
}if(!ResUtils.canShow("agentCost.button.edit")){$("#batchSaveAgentCost").hide();}},_bindEventHander:function(){var a=this;$("#prod-price-type").on("change",function(){a._prodSearch($("select[name=storeIds]").val());
});$(document).on("focus","#searchProd",function(){a._prodSearch($("select[name=storeIds]").val());});$(document).on("click","#skuManagerTabLi",function(){var b={};
b.agentId=agentId;b.cateId=a.cateId;a.reloadJqgrid(b);});$(document).on("click","#enterSku",function(){var b=$("#agentEntityList option:selected").val();
if(b){DialogUtils.confirmWithOptions({title:"确认进行录入操作？",text:"注意：该操作会删除本代理商sku信息，再批量录入选中代理商的sku商品信息，请谨慎操作",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(ctx+"/crm/agent/agentSku/enterSku.htm",{"id":b,"agentId":agentId},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"操作成功");
params={};params.agentId=agentId;a.reloadJqgrid(params);}},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});}});}else{DialogUtils.error("提示","请选择代理商");
}});$("#agentSkuSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".agentSkuSearch").trigger("click");}});$("#clickUp").on("click",function(){a._clickUp();
});$("#clickDown").on("click",function(){a._clickDown();});$("#prodEntityCateTreeSearch").on("keyup",function(b){if(b.keyCode==13){a._searchNode(b);a._callNumber();
}});$("#selectSkuBtn").on("click",function(){if($("select[name=storeIds]").val()==""||$("select[name=storeIds]").val()==null){DialogUtils.error(msgCode.WARING,"请先选择仓库");
return false;}var d="product";var c="y";a.hadClose=false;var b=$("select[name=storeIds]").val();SelectProdService.selectSku({storeId:b,isMultiple:1,type:d,canSale:"y",isSale:"y",userId:currentUserId,agentId:agentId,priceType:$("#prod-price-type").val(),hasStock:$("#hasStock").is(":checked")?"y":"n",limitProdCate:c,fn:function(g){var f=[];
for(var h=0;h<g.length;h++){f.push(g[h].skuId);}var e=$("select[name=storeIds]").val();FormUtils.submit(ctx+"/crm/agent/agentSku/saveAdd.htm",{skuIds:f,agentId:agentId,storeId:e},function(i){if(i.success){DialogUtils.success("提示","操作成功");
params={};params.agentId=agentId;a.reloadJqgrid(params);}});}});});$(document).on("click","#batchSaveAgentCost",function(){var c=$(AgentSku._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c.length==0){DialogUtils.error("提示","请选择要操作的记录");return false;}var b=[];for(var d=0;d<c.length;d++){$(".setAgentCost").each(function(){if($(this).attr("idVal")==c[d]){var e={id:c[d],agentCost:$(this).val()};
b.push(e);}});}if(b.length>0){a._batchSaveAgentCost(b);}else{DialogUtils.error("提示","选择记录没有更新代理价");}});$(document).on("blur",".agentCost",function(){var c=$(this).val();
var b=$(this).attr("price");$(this).addClass("setAgentCost");});$(document).on("click",".saveAgentCost",function(){var e=$(this).attr("idVal");var d=$(this).attr("price");
var c=$(this).parent().prev().find(".agentCost").val();if(!c){DialogUtils.error("提示","代理价不能为空");return false;}var b=AgentSku._CONS_.SAVE_AGENT_COST;DialogUtils.confirmWithOptions({title:"提示",text:"确认录入该代理价？",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(b,{id:e,agentCost:c},function(f){if(f.success){DialogUtils.success("提示","操作成功");
}else{DialogUtils.error("提示","后台异常");}});}});});$(document).on("click",".saveProdWeight",function(){var d=$(this).attr("idVal");var c=$(this).parent().prev().find("#prodWeight").val();
if(!c){DialogUtils.error("提示","重量不能为空");return false;}var b=AgentSku._CONS_.SAVE_PROD_WEIGHT;DialogUtils.confirmWithOptions({title:"提示",text:"确认录入该商品重量吗？",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(b,{id:d,prodWeight:c},function(e){if(e.success){DialogUtils.success("提示","操作成功");
}else{DialogUtils.error("提示","后台异常");}});}});});$(document).on("click",".removeSku",function(){var c=$(this).attr("idVal");var b=AgentSku._CONS_.DELETE_AGENT_SKU;
DialogUtils.confirmWithOptions({title:"提示",text:"确认要移除该商品，请谨慎操作？",confirmButtonText:"确认",yesFunc:function(){FormUtils.submit(b,{id:c},function(d){if(d.success){DialogUtils.success("提示","移除成功");
params={};params.agentId=agentId;a.reloadJqgrid(params);}else{DialogUtils.error("提示","后台异常");}});}});});},_batchSaveAgentCost:function(a){var b=this;var c=ctx+"/crm/agent/agentSku/bacthSaveAgentCost.htm";
FormUtils.submit(c,"jsondata="+JSON.stringify(a),function(d){if(d.success){DialogUtils.success("提示","保存成功");$(".agentCost ").removeClass("setAgentCost");
}else{DialogUtils.error("提示","后台异常");}});},_bindFormValidation:function(){var a={rules:{},messages:{}};FormUtils.bindFormValidation(AgentSku._CONS_.EDIT_FORM_ID,a);
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(AgentSku._CONS_.GRID,a);},_initJqgrid:function(b){if(b==null||typeof b==undefined){b={};}var a=false;
if("agentWeihu"==agentWeihu){a=true;}b.agentId=agentId;$(AgentSku._CONS_.GRID).JTJqgrid({url:AgentSku._CONS_.LIST_DATA_URL,pager:AgentSku._CONS_.PAGER,postData:b,colNames:["图片","名称","款号","产品代码","分类","价格","商品重量(KG)","代理价","操作"],colModel:[{name:"img",index:"img",width:150,align:"center",formatter:function(c,f,h){var g=AgentSku._CONS_.DE_IMG;
var e="<img onerror='onImageError()' style='display: inline; height:35px;' ";if(h.profile!=""&&h.profile!=null){var d={url:h.profile,name:"",id:""};e=e+" src='"+ImageUtils.getUrl(d)+"?dm=_mm' ";
}else{e=e+" src='"+ctx+"/img/jt/defaulTouXiang.png' ";}e+=" >";return e;}},{name:"prodName",index:"prodName",align:"center",width:200},{name:"code",index:"code",align:"center",width:200},{name:"prodCode",index:"prodCode",align:"center",width:200},{name:"cateName",index:"cateName",align:"center",width:200},{name:"price",index:"price",align:"center",width:200},{name:"prodWeight",index:"prod_weight_",align:"center",width:200,formatter:function(c,d,e){if("agentWeihu"==agentWeihu){return e.prodWeight;
}else{var f=new StringBuffer();f.append("<div class='col-sm-7' style='padding:0px;'><input type='text' id='prodWeight' idVal='"+e.id+"' class='form-control' value='"+e.prodWeight+"'></div>");
f.append("<div class='col-sm-2'><button type='button'style='min-width:auto;' idVal='"+e.id+"' class='btn btn-sm jt-btn-normal saveProdWeight'>确定</button></div>");
return f.toString();}}},{name:"agentCost",index:"agent_cost_",align:"center",width:200,formatter:function(c,d,e){if("agentWeihu"==agentWeihu){return e.agentCost;
}else{if(ResUtils.canShow("agentCost.button.edit")){var f=new StringBuffer();f.append("<div class='col-sm-7' style='padding:0px;'><input type='text' idVal='"+e.id+"' class='agentCost form-control' price='"+e.price+"' value='"+e.agentCost+"'></div>");
f.append("<div class='col-sm-2'><button type='button'style='min-width:auto;' idVal='"+e.id+"' price='"+e.price+"' class='btn btn-sm jt-btn-normal saveAgentCost' >确定</button></div>");
return f.toString();}else{return e.agentCost;}}}},{name:"caozuo",index:"caozuo",align:"center",hidden:a,width:200,formatter:function(c,d,e){var f=new StringBuffer();
f.append("<button idVal='"+e.id+"' style='min-width:auto;' type='button' class='btn btn-sm jt-btn-normal removeSku'>移除</button>");return f.toString();}}],loadComplete:function(){$(window).resize();
self.agentSkuDatas=$("#agentSkuGrid").jqGrid("getRowData");},gridComplete:function(){$(window).resize();},});}};