$(function(){var a=new AgentBill();a.init();});function AgentBill(){this.hadInit=false;this.isEdit=false;this.isAgent=false;this.isFormDataChange=false;
this.status="draft";this.thisTab="agentBillTab";}AgentBill._CONS_={SAVE_ADD_URL:ctx+"/crm/agent/agentBill/saveAdd.htm",AGENT_EDIT_URL:ctx+"/crm/agent/agentEntity/edit.htm",BILL_EDIT_URL:ctx+"/crm/agent/agentBill/edit.htm",SAVE_OTHER_URL:ctx+"/crm/agent/agentBill/saveOther.htm",AGENT_BILL_URL:ctx+"/crm/agent/agentBill/getAgentBillLast.htm",GET_EMP_URL:ctx+"/crm/agent/agentBill/getEmp.htm",AGENT_BILL_TIME_URL:ctx+"/crm/agent/agentBill/getByTimeAndStatus.htm",FIND_SO_URL:ctx+"/crm/agent/agentBill/findSo.htm",SAVE_EDIT_URL:ctx+"/crm/agent/agentBill/saveEdit.htm",EXPORT_EXCEL_URL:ctx+"/crm/agent/agentBill/exportExcel.htm",DELETE_OTHER_URL:ctx+"/crm/agent/agentBill/deleteOther.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",UPDATE_COST_URL:ctx+"/crm/agent/agentSo/updateCost.htm",INSET_BILL_URL:ctx+"/crm/agent/agentBill/addAgentBill.htm",UPDATE_STATUS:ctx+"/crm/agent/agentBill/updateStatus.htm",EDIT_FORM_ID:"agentBillForm",GRID:"#agentBillGrid",PAGER:"#agentBillPager"};
AgentBill.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;if(agentId){this._hideNotGrantBtn();this.initSearch();this._bindEventHander();
}else{DialogUtils.error(msgCode.ERROR,"当前员工没有归属代理商");$(".wrapper").hide();}}},initSearch:function(){var b=this;var a=new Date();var e=a.getFullYear();var f=new StringBuffer();
for(var d=2015;d<=e;d++){f.append("<option value='").append(d).append("' >").append(d).append("年</option>");}$("#"+b.thisTab).find("#periodYear").append(f.toString());
$("#"+b.thisTab).find("#periodYear").val(e);$("#"+b.thisTab).find("#periodMonth").val(a.getMonth()+1);FormUtils.loadData(AgentBill._CONS_.AGENT_EDIT_URL+"?id="+agentId,function(g){if(JSON.stringify(g)!="{}"){$("#"+b.thisTab).find("input[name=completeDays]").val(g.comDays);
b.initAgentBill();}});CateUtils.getOptions({typeKey:"system",pKey:"agentBillOtherType",container:"agentBillOtherType"});var c=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm?cateType=AddressCateType&parentKey=ChinaCityCateType-root";
FormUtils.loadData(c,function(l){if(l.success){if(l.msg!=null&&l.msg!=""){var h=new StringBuffer();var g=new StringBuffer();var k=JSON.parse(l.msg);if(k&&k.length>0){h.append("<option value=''>请选择</option>");
for(var j=0;j<k.length;j++){h.append("<option idValue='"+k[j].id+"' value='"+k[j].value+"'>"+k[j].name+"</option>");}$("#freightModalContainer").find("select[name=toPid]").append(h.toString());
g.append("<option value=''>请选择</option>");for(var j=0;j<k.length;j++){g.append("<option idValue='"+k[j].id+"' value='"+k[j].value+"'>"+k[j].name+"</option>");
}$("#freightModalContainer").find("select[name=startPid]").append(g.toString());}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},initAgentBill:function(){var a=this;
FormUtils.loadData(AgentBill._CONS_.AGENT_BILL_URL+"?agentId="+agentId+"&status="+a.status,function(b){a.loadData(b);});},loadData:function(b){var a=this;
if(JSON.stringify(b)!="{}"){a.loadAgentBill(b);}else{a.initDateSearch();}a.initTable();},initTable:function(){var a=this;FormUtils.loadData(AgentBill._CONS_.FIND_SO_URL+"?agentId="+agentId+"&startTime="+$("#"+a.thisTab).find("input[name=startTime]").val()+"&endTime="+$("#"+a.thisTab).find("input[name=endTime]").val(),function(x){if(x&&x.length>0){var d=new StringBuffer();
var v=new StringBuffer();var b=0;var r=0;var m=0;var h=0;var p=0;var u=0;var w=0;var t=0;var s=0;var k=0;var c=0;var g=0;var e=0;var f=0;var j=0;for(var q=0;
q<x.length;q++){var n=parseFloat(x[q].moneySo-x[q].moneyService-x[q].moneyStock-x[q].moneyPackage-x[q].moneyShip-x[q].moneyCost).toFixed(2);d.append("<tr>");
d.append("<td>"+(q+1)+"</td>");d.append("<td><a href='#' class='soTab' soNoVal='"+x[q].soNo+"'>"+x[q].soNo+"</a></td>");if(x[q].isReceived=="y"){d.append("<td>"+SoEntityUtils.formatStatus(x[q])+"(已回款)"+"</td>");
}else{d.append("<td>"+SoEntityUtils.formatStatus(x[q])+"(未回款)"+"</td>");}d.append("<td>"+x[q].scName+"</td>");d.append("<td>"+x[q].startName+"</td>");d.append("<td>"+x[q].toName+"</td>");
d.append("<td>"+x[q].moneySo+"</td>");d.append("<td>"+x[q].skuCount+"</td>");d.append("<td><a href='#' class='moneyServiceTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
d.append(" moneySoVal='"+x[q].moneySo+"'>"+x[q].moneyService+"</a></td>");d.append("<td><a href='#' class='moneyStockTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
d.append(" skuCountVal='"+x[q].skuCount+"'>"+x[q].moneyStock+"</a></td>");d.append("<td><a href='#' class='moneyStockTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
d.append(" skuCountVal='"+x[q].skuCount+"'>"+x[q].moneyPackage+"</a></td>");d.append("<td><a href='#' class='moneyShipTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
d.append(" toPidVal='"+x[q].toPid+"' startPidVal='"+x[q].startPid+"' weightVal='"+x[q].weight+"'>"+x[q].moneyShip+"</a></td>");d.append("<td><a href='#' soIdVal='"+x[q].soId+"' class='moneyCostTd'>"+x[q].moneyCost+"</a></td>");
d.append("<td>"+n+"</td>");d.append("</tr>");b+=x[q].moneySo;r+=x[q].skuCount;m+=x[q].moneyService;h+=x[q].moneyStock;p+=x[q].moneyPackage;u+=x[q].moneyShip;
w+=x[q].moneyCost;t=parseFloat(t)+parseFloat(n);if(x[q].returnSkuCount!=0){j++;v.append("<tr>");v.append("<td>"+j+"</td>");v.append("<td><a href='#' class='soTab' soNoVal='"+x[q].soNo+"'>"+x[q].soNo+"</a></td>");
if(x[q].isReceived=="y"){v.append("<td>"+SoEntityUtils.formatStatus(x[q])+"(已回款)"+"</td>");}else{v.append("<td>"+SoEntityUtils.formatStatus(x[q])+"(未回款)"+"</td>");
}v.append("<td>"+x[q].scName+"</td>");v.append("<td>"+x[q].startName+"</td>");v.append("<td>"+x[q].toName+"</td>");v.append("<td>"+x[q].returnSkuCount+"</td>");
v.append("<td>"+x[q].returnMoneySo+"</td>");v.append("<td><a href='#' class='returnMoneyShipTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
v.append(" toPidVal='"+x[q].toPid+"' startPidVal='"+x[q].startPid+"' weightVal='"+x[q].weight+"'>"+x[q].returnMoneyShip+"</a></td>");v.append("<td><a href='#' class='moneyStockTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
v.append(" skuCountVal='"+x[q].returnSkuCount+"'>"+x[q].returnMoneyStock+"</a></td>");v.append("<td><a href='#' class='moneyStockTd' scNameVal='"+x[q].scName+"' shipIdVal='"+x[q].scCode+"'");
v.append(" skuCountVal='"+x[q].returnSkuCount+"'>"+x[q].returnMoneyPackage+"</a></td>");v.append("<td><input type='number' class='form-control' style='width:50%' name='returnMoneyCostTd' idVal='"+x[q].id+"' value='"+x[q].returnMoneyCost+"'");
if(this.isAgent){v.append("disabled='disabled'");}v.append("></td>");v.append("</tr>");s+=x[q].returnSkuCount;k+=x[q].returnMoneySo;c+=x[q].returnMoneyShip;
g+=x[q].returnMoneyStock;e+=x[q].returnMoneyPackage;f+=x[q].returnMoneyCost;}}$("#"+a.thisTab).find(".completeTbody").empty().append(d.toString());var o=new StringBuffer();
o.append("<tr><td colspan='6'>总计：</td>");o.append("<td style='font-weight:bold;' class='moneySoTotal'>"+b+"</td>");o.append("<td style='font-weight:bold;' class='skuCountTotal'>"+r+"</td>");
o.append("<td style='font-weight:bold;' class='moneyServiceTotal'>"+m+"</td>");o.append("<td style='font-weight:bold;' class='moneyStockTotal'>"+h+"</td>");
o.append("<td style='font-weight:bold;' class='moneyPackageTotal'>"+p+"</td>");o.append("<td style='font-weight:bold;' class='moneyShipTotal'>"+u+"</td>");
o.append("<td style='font-weight:bold;' class='moneyCostTotal'>"+w+"</td>");o.append("<td style='font-weight:bold;' class='completeTotal'>"+t+"</td>");
o.append("</tr>");$("#"+a.thisTab).find(".completeTfoot").empty().append(o.toString());$("#"+a.thisTab).find(".rejectLostTbody").empty().append(v.toString());
var l=new StringBuffer();l.append("<tr><td colspan='6'>总计：</td>");l.append("<td style='font-weight:bold;' class='returnSkuCountTotal'>"+s+"</td>");l.append("<td style='font-weight:bold;' class='returnMoneySoTotal'>"+k+"</td>");
l.append("<td style='font-weight:bold;' class='returnMoneyShipTotal'>"+c+"</td>");l.append("<td style='font-weight:bold;' class='returnMoneyStockTotal'>"+g+"</td>");
l.append("<td style='font-weight:bold;' class='returnMoneyPackageTotal'>"+e+"</td>");l.append("<td style='font-weight:bold;' class='returnMoneyCostTotal'>"+f+"</td>");
l.append("</tr>");$("#"+a.thisTab).find(".rejectLostTfoot").empty().append(l.toString());}else{$("#"+a.thisTab).find(".completeTbody").empty();$("#"+a.thisTab).find(".rejectLostTbody").empty();
$("#"+a.thisTab).find(".completeTfoot").empty().append("<tr><td colspan='6'>总计：</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>");
$("#"+a.thisTab).find(".rejectLostTfoot").empty().append("<tr><td colspan='6'>总计：</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>");
}});},initDateSearch:function(){var c=this;$("#"+c.thisTab).find(".agentBillTable").hide();$("#"+c.thisTab).find(".fluctuateLi").hide();$("#"+c.thisTab).find(".fluctuateTab").hide();
$("#"+c.thisTab).find("input[name=id]").val("");$("#"+c.thisTab).find("input[name=billId]").val("");$("#"+c.thisTab).find("input[name=prevId]").val("");
$("#"+c.thisTab).find("input[name=nextId]").val("");$("#"+c.thisTab).find(".agentBillNext").hide();$("#"+c.thisTab).find(".agentBillPrev").hide();var f=$("#"+c.thisTab).find("input[name=completeDays]").val();
var b=new Date();b.setFullYear($("#"+c.thisTab).find("#periodYear").val());b.setMonth($("#"+c.thisTab).find("#periodMonth").val()-1);b.setDate(f*($("#"+c.thisTab).find("#periodNumber").val()-1)+1);
var d=new Date();d.setFullYear($("#"+c.thisTab).find("#periodYear").val());d.setMonth($("#"+c.thisTab).find("#periodMonth").val()-1);d.setDate(f*$("#"+c.thisTab).find("#periodNumber").val());
var a=DateUtils.format(b,DateUtils._CONS_.DEFAULT_DATE_PATTERN);var e=DateUtils.format(d,DateUtils._CONS_.DEFAULT_DATE_PATTERN);$("#"+c.thisTab).find("input[name=startTime]").val(DateUtils.format(b,DateUtils._CONS_.DEFAULT_DATE_PATTERN+" 00:00:00"));
$("#"+c.thisTab).find("input[name=endTime]").val(DateUtils.format(d,DateUtils._CONS_.DEFAULT_DATE_PATTERN+" 23:59:59"));$("#"+c.thisTab).find(".timePeriod").text(a+"至"+e);
},loadAgentBill:function(d){var j=this;$("#"+j.thisTab).find(".agentBillTable").show();$("#"+j.thisTab).find(".fluctuateLi").show();$("#"+j.thisTab).find(".fluctuateTab").show();
$("input[name=billId]").val(d.id);$("#"+j.thisTab).find("input[name=id]").val(d.id);if(d.prevId){$("#"+j.thisTab).find(".agentBillPrev").show();}else{$("#"+j.thisTab).find(".agentBillPrev").hide();
}if(d.nextId){$("#"+j.thisTab).find(".agentBillNext").show();}else{$("#"+j.thisTab).find(".agentBillNext").hide();}$("#"+j.thisTab).find("input[name=prevId]").val(d.prevId);
$("#"+j.thisTab).find("input[name=nextId]").val(d.nextId);$("#"+j.thisTab).find("#periodYear").val(d.periodYear);$("#"+j.thisTab).find("#periodMonth").val(d.periodMonth);
$("#"+j.thisTab).find("#periodNumber").val(d.periodNumber);$("#"+j.thisTab).find("#status").val(d.status);var b=d.startTime.substring(0,10);var h=d.endTime.substring(0,10);
$("#"+j.thisTab).find("input[name=startTime]").val(d.startTime);$("#"+j.thisTab).find("input[name=endTime]").val(d.endTime);$("#"+j.thisTab).find(".timePeriod").text(b+"至"+h);
$("#"+j.thisTab).find(".moneySo").text(d.moneySo);$("#"+j.thisTab).find(".moneyService").text(d.moneyService);$("#"+j.thisTab).find(".moneyStock").text(d.moneyStock);
$("#"+j.thisTab).find(".moneyPackage").text(d.moneyPackage);$("#"+j.thisTab).find(".moneyShip").text(d.moneyShip);$("#"+j.thisTab).find(".skuCount").text(d.skuCount);
$("#"+j.thisTab).find(".moneyCost").text(d.moneyCost);$("#"+j.thisTab).find(".returnMoneyShip").text(d.returnMoneyShip);$("#"+j.thisTab).find(".returnSkuCount").text(d.returnSkuCount);
$("#"+j.thisTab).find(".returnMoneySo").text(d.returnMoneySo);$("#"+j.thisTab).find(".returnMoneyStock").text(d.returnMoneyStock);$("#"+j.thisTab).find(".returnMoneyPackage").text(d.returnMoneyPackage);
$("#"+j.thisTab).find(".returnMoneyCost").text(d.returnMoneyCost);var f=parseFloat(d.moneySo-d.moneyService-d.moneyStock-d.moneyPackage-d.moneyShip-d.moneyCost).toFixed(2);
if(d.agentBillOtherPos&&d.agentBillOtherPos.length>0){var a=new StringBuffer();var e=0;var g=new StringBuffer();g.append("<table>");g.append("<tbody>");
g.append("<tr>");for(var c=0;c<d.agentBillOtherPos.length;c++){if(d.agentBillOtherPos[c].direct=="1"){f=(parseFloat(f)+parseFloat(d.agentBillOtherPos[c].money)).toFixed(2);
g.append("<td style='padding-right:10px;'>+</td>");}else{f=parseFloat(f-d.agentBillOtherPos[c].money).toFixed(2);g.append("<td style='padding-right:10px;'>-</td>");
}g.append("<td style='padding-right:10px;'>人工费</td>");a.append("<tr>");a.append("<td>"+(c+1)+"</td>");a.append("<td>"+d.agentBillOtherPos[c].type+"</td>");
a.append("<td>"+(d.agentBillOtherPos[c].direct==1?"增加":"减少")+"</td>");a.append("<td>"+d.agentBillOtherPos[c].money+"</td>");a.append("<td>"+d.agentBillOtherPos[c].desc+"</td>");
a.append("<td>"+d.agentBillOtherPos[c].createByName+"</td>");a.append("<td>"+d.agentBillOtherPos[c].createTime+"</td>");a.append("<td><i class='fa fa-remove deleteOtherFee' idVal='"+d.agentBillOtherPos[c].id+"' style='color: red; cursor: pointer;'></i></td>");
a.append("</tr>");e+=d.agentBillOtherPos[c].money;}g.append("</tr>");g.append("<tr>");for(var c=0;c<d.agentBillOtherPos.length;c++){if(d.agentBillOtherPos[c].direct=="1"){g.append("<td style='padding-right:10px;font-weight:bold;'>+</td>");
}else{g.append("<td style='padding-right:10px;font-weight:bold;'>-</td>");}g.append("<td style='font-weight:bold;'>"+d.agentBillOtherPos[c].money+"</td>");
}g.append("</tr>");g.append("</tbody>");g.append("</table>");$("#"+j.thisTab).find(".agentBillOtherTd").empty().append(g.toString());$("#"+j.thisTab).find(".fluctuateTbody").empty().append(a.toString());
$("#"+j.thisTab).find(".fluctuateTfoot").empty().append("<tr><td colspan='3'>总计：</td><td style='font-weight:bold;'>"+e+"</td><td colspan='4'></td></tr>");
}else{$("#"+j.thisTab).find(".agentBillOtherTd").empty();$("#"+j.thisTab).find(".fluctuateTfoot").empty().append("<tr><td colspan='3'>总计：</td><td style='font-weight:bold;'>0</td><td colspan='4'></td></tr>");
}$("#"+j.thisTab).find(".returnedTotalAmount").text(f);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("agentBill.button.add")){$(".agentBillAdd").hide();
$(".agentBillSave").hide();}FormUtils.loadData(AgentBill._CONS_.GET_EMP_URL+"?currentUserId="+currentUserId,function(a){if(JSON.stringify(a)!="{}"&&a.agentId){this.isAgent=true;
$(".agentBillAdd").hide();$(".agentBillSave").hide();$(".agentBillFluctuate").hide();$(".feeSetting").hide();$(".agentBillCreate").hide();$(".agentBillDraft").hide();
$(".agentBillReturn").hide();$("input[name=returnMoneyCostTd]").attr("disabled",true);}});},_bindEventHander:function(){var a=this;$(".tabLi1").off().on("click",function(){if($(this).attr("id")=="agentBillTabLi"){a.status="draft";
a.thisTab="agentBillTab";}else{if($(this).attr("id")=="agentBillCheckTabLi"){a.status="check";a.thisTab="agentBillCheckTab";}else{if($(this).attr("id")=="agentBillReturnTabLi"){a.status="return";
a.thisTab="agentBillReturnTab";}else{if($(this).attr("id")=="agentBillFinishTabLi"){a.status="complete";a.thisTab="agentBillFinishTab";}else{if($(this).attr("id")=="agentBillFeedbackTabLi"){a.status="feedback";
a.thisTab="agentBillFeedbackTab";}}}}}a._hideNotGrantBtn();a.initSearch();});$(".agentBillDraft").on("click","",function(){if($("#"+a.thisTab).find("input[name=id]").val()){var b="id="+$("#"+a.thisTab).find("input[name=id]").val()+"&status=check";
FormUtils.submit(AgentBill._CONS_.UPDATE_STATUS,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);$("#"+a.thisTab).find(".agentBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});$("body").on("click",".agentBillCheck",function(){if($("#"+a.thisTab).find("input[name=id]").val()){var b="id="+$("#"+a.thisTab).find("input[name=id]").val()+"&status=return";
FormUtils.submit(AgentBill._CONS_.UPDATE_STATUS,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"成功修改状态");$("#"+a.thisTab).find(".agentBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});$("body").on("click",".agentBillReturn",function(){if($("#"+a.thisTab).find("input[name=id]").val()){var b="id="+$("#"+a.thisTab).find("input[name=id]").val()+"&status=complete";
FormUtils.submit(AgentBill._CONS_.UPDATE_STATUS,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"成功修改状态");$("#"+a.thisTab).find(".agentBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});$("body").on("click",".agentBillFeedBack",function(){if($("#"+a.thisTab).find("input[name=id]").val()){var b="id="+$("#"+a.thisTab).find("input[name=id]").val()+"&status=feedback";
FormUtils.submit(AgentBill._CONS_.UPDATE_STATUS,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"成功修改状态");$("#"+a.thisTab).find(".agentBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});$("body").on("click",".soTab",function(){var b=$(this).attr("soNoVal");
JTTabUtils.addOrRefreshTab(AgentBill._CONS_.SO_DETAIL_URL+"?soNo="+b,b+"的订单明细");});$("body").on("change","input[name=returnMoneyCostTd]",function(){var b=$(this).attr("idVal");
FormUtils.submit(AgentBill._CONS_.UPDATE_COST_URL,{id:b,returnMoneyCost:$(this).val()},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,"保存成功");
}else{DialogUtils.error(msgCode.ERROR,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});var c=0;$("#"+a.thisTab).find(".rejectLostTbody").find("input[name=returnMoneyCostTd]").each(function(){c+=parseFloat($(this).val());
});$("#"+a.thisTab).find(".returnMoneyCostTotal").text(c);});$("body").on("click",".moneyServiceTd",function(){$("#serviceModalContainer").modal("show");
var d=$(this).attr("scNameVal");var b=$(this).attr("shipIdVal");var c=$(this).attr("moneySoVal");$("#serviceModalContainer").find("input[name=shipName]").val(d);
$("#serviceModalContainer").find("input[name=shipId]").val(b);$("#serviceModalContainer").find("input[name=moneySo]").val(c);FormUtils.loadData(ctx+"/ec/ship/shipFeeService/getService.htm?shipId="+b+"&moneySo="+c,function(e){$("#serviceModalContainer").find("input[name=moneyService]").val(e);
});FormUtils.loadData(ctx+"/ec/ship/shipFeeService/getByShip.htm?shipId="+b,function(e){if(e&&e.length>0){$("#serviceModalContainer").find("textarea[name=desc]").val(e[0].desc);
}});});$("#serviceModalContainer").on("change","input[name=moneySo]",function(){FormUtils.loadData(ctx+"/ec/ship/shipFeeService/getService.htm?shipId="+$("#serviceModalContainer").find("input[name=shipId]").val()+"&moneySo="+$(this).val(),function(b){$("#serviceModalContainer").find("input[name=moneyService]").val(b);
});});$("body").on("click",".moneyStockTd",function(){$("#stockModalContainer").modal("show");var d=$(this).attr("scNameVal");var b=$(this).attr("shipIdVal");
var c=$(this).attr("skuCountVal");$("#stockModalContainer").find("input[name=shipName]").val(d);$("#stockModalContainer").find("input[name=shipId]").val(b);
$("#stockModalContainer").find("input[name=skuCount]").val(c);FormUtils.loadData(ctx+"/ec/ship/shipFeeStock/getStock.htm?shipId="+b+"&skuCount="+c,function(e){$("#stockModalContainer").find("input[name=moneyStock]").val(e.storePrice);
$("#stockModalContainer").find("input[name=moneyPackage]").val(e.packagePrice);});});$("body").find("#stockModalContainer").on("change","input[name=skuCount]",function(){FormUtils.loadData(ctx+"/ec/ship/shipFeeStock/getStock.htm?shipId="+$("#stockModalContainer").find("input[name=shipId]").val()+"&skuCount="+$(this).val(),function(b){$("#stockModalContainer").find("input[name=moneyStock]").val(b.storePrice);
$("#stockModalContainer").find("input[name=moneyPackage]").val(b.packagePrice);});});$("body").on("click",".moneyShipTd,.returnMoneyShipTd",function(){$("#freightModalContainer").modal("show");
var e=$(this).attr("scNameVal");var b=$(this).attr("shipIdVal");var f=$(this).attr("toPidVal");var c=$(this).attr("startPidVal");var d=$(this).attr("weightVal");
$("#freightModalContainer").find("input[name=shipName]").val(e);$("#freightModalContainer").find("input[name=shipId]").val(b);$("#freightModalContainer").find("input[name=weight]").val(d);
$("#freightModalContainer").find("select[name=toPid]").val(f);$("#freightModalContainer").find("select[name=startPid]").val(c);if($(this).attr("class")=="moneyShipTd"){$("#freightModalContainer").find("input[name=type]").val("ship");
}else{$("#freightModalContainer").find("input[name=type]").val("return");}FormUtils.loadData(ctx+"/ec/ship/shipFeeFormula/getFreight.htm?shipId="+b+"&weight="+d+"&toPid="+f+"&startPid="+c+"&type="+$("#freightModalContainer").find("input[name=type]").val(),function(g){if(JSON.stringify(g)!="{}"){$("#freightModalContainer").find("input[name=basePrice]").val(g.basePrice);
$("#freightModalContainer").find("input[name=additionalPrice]").val(g.additionalPrice);$("#freightModalContainer").find("input[name=freight]").val(g.freight);
}else{$("#freightModalContainer").find("input[name=basePrice]").val("");$("#freightModalContainer").find("input[name=additionalPrice]").val("");$("#freightModalContainer").find("input[name=freight]").val("");
}});});$("body").find("#freightModalContainer").on("change","input[name=weight],select[name=toPid],select[name=startPid]",function(){FormUtils.loadData(ctx+"/ec/ship/shipFeeFormula/getFreight.htm?shipId="+$("#freightModalContainer").find("input[name=shipId]").val()+"&weight="+$("#freightModalContainer").find("input[name=weight]").val()+"&toPid="+$("#freightModalContainer").find("select[name=toPid]").val()+"&startPid="+$("#freightModalContainer").find("select[name=startPid]").val()+"&type="+$("#freightModalContainer").find("input[name=type]").val(),function(b){if(JSON.stringify(b)!="{}"){$("#freightModalContainer").find("input[name=basePrice]").val(b.basePrice);
$("#freightModalContainer").find("input[name=additionalPrice]").val(b.additionalPrice);$("#freightModalContainer").find("input[name=freight]").val(b.freight);
}else{$("#freightModalContainer").find("input[name=basePrice]").val("");$("#freightModalContainer").find("input[name=additionalPrice]").val("");$("#freightModalContainer").find("input[name=freight]").val("");
}});});$("body").on("click",".moneyCostTd",function(){$("#costModalContainer").modal("show");var b=$(this).attr("soIdVal");FormUtils.loadData(ctx+"/crm/agent/agentSku/findProd.htm?agentId="+agentId+"&soId="+b,function(e){if(e&&e.length>0){var g=new StringBuffer();
var d=0;for(var c=0;c<e.length;c++){g.append("<tr>");g.append("<td>"+e[c].prodName+"</td>");g.append("<td>"+e[c].agentCost+"</td>");g.append("<td>"+e[c].count+"</td>");
g.append("<td>"+e[c].count*e[c].agentCost+"</td>");g.append("</tr>");d+=e[c].count*e[c].agentCost;}var f=new StringBuffer();f.append("<tr><td colspan='3'>总计：</td>");
f.append("<td>"+d+"</td>");f.append("</tr>");$(".costModalTbody").empty().append(g.toString());$(".costModalTfoot").empty().append(f.toString());}else{$(".costModalTbody").empty();
$(".costModalTfoot").empty().append("<tr><td colspan='3'>总计：</td><td>0</td></tr>");}});});$("body").on("click",".agentBillThis",function(){a.initAgentBill();
});$("body").on("click",".agentBillPrev",function(){FormUtils.loadData(AgentBill._CONS_.BILL_EDIT_URL+"?id="+$("#"+a.thisTab).find("input[name=prevId]").val(),function(b){a.loadData(b);
});});$("body").on("click",".agentBillNext",function(){FormUtils.loadData(AgentBill._CONS_.BILL_EDIT_URL+"?id="+$("#"+a.thisTab).find("input[name=nextId]").val(),function(b){a.loadData(b);
});});$("body").on("click",".deleteOtherFee",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.del(AgentBill._CONS_.DELETE_OTHER_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$("#"+a.thisTab).find(".agentBillSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});});$("body").on("click",".agentBillExport",function(){window.location.href=AgentBill._CONS_.EXPORT_EXCEL_URL+"?agentId="+agentId+"&agentName="+agentName;
});$("body").on("click",".agentBillSearch",function(){FormUtils.loadData(AgentBill._CONS_.AGENT_BILL_TIME_URL+"?agentId="+agentId+"&status="+a.status+"&periodYear="+$("#"+a.thisTab).find("#periodYear").val()+"&periodMonth="+$("#"+a.thisTab).find("#periodMonth").val()+"&periodNumber="+$("#"+a.thisTab).find("#periodNumber").val(),function(b){a.loadData(b);
});});$("body").on("click",".feeSetting",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/ship/shipCompany/feeSetting.htm","物流费用设置");});$("body").on("click",".agentBillAdd",function(){var b="agentId="+agentId+"&periodYear="+$("#"+a.thisTab).find("#periodYear").val()+"&periodMonth="+$("#"+a.thisTab).find("#periodMonth").val()+"&periodNumber="+$("#"+a.thisTab).find("#periodNumber").val()+"&startTime="+$("#"+a.thisTab).find("input[name=startTime]").val()+"&endTime="+$("#"+a.thisTab).find("input[name=endTime]").val()+"&status=draft&moneySo="+$(".moneySoTotal").text()+"&skuCount="+$("#"+a.thisTab).find(".skuCountTotal").text()+"&moneyService="+$("#"+a.thisTab).find(".moneyServiceTotal").text()+"&moneyStock="+$("#"+a.thisTab).find(".moneyStockTotal").text()+"&moneyPackage="+$("#"+a.thisTab).find(".moneyPackageTotal").text()+"&moneyShip="+$("#"+a.thisTab).find(".moneyShipTotal").text()+"&moneyCost="+$("#"+a.thisTab).find(".moneyCostTotal").text()+"&returnSkuCount="+$("#"+a.thisTab).find(".returnSkuCountTotal").text()+"&returnMoneySo="+$("#"+a.thisTab).find(".returnMoneySoTotal").text()+"&returnMoneyShip="+$("#"+a.thisTab).find(".returnMoneyShipTotal").text()+"&returnMoneyStock="+$("#"+a.thisTab).find(".returnMoneyStockTotal").text()+"&returnMoneyPackage="+$("#"+a.thisTab).find(".returnMoneyPackageTotal").text()+"&returnMoneyCost="+$("#"+a.thisTab).find(".returnMoneyCostTotal").text();
FormUtils.submit(AgentBill._CONS_.SAVE_ADD_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"保存成功");a.loadAgentBill(JSON.parse(c.msg));
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){ButtonUtils.enableBtn("agentBillAdd");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
});$("body").on("click",".agentBillSave",function(){if($("#"+a.thisTab).find("input[name=id]").val()){var b="id="+$("#"+a.thisTab).find("input[name=id]").val()+"&agentId="+agentId+"&periodYear="+$("#"+a.thisTab).find("#periodYear").val()+"&periodMonth="+$("#"+a.thisTab).find("#periodMonth").val()+"&periodNumber="+$("#"+a.thisTab).find("#periodNumber").val()+"&startTime="+$("#"+a.thisTab).find("input[name=startTime]").val()+"&endTime="+$("#"+a.thisTab).find("input[name=endTime]").val()+"&status="+a.status+"&moneySo="+$("#"+a.thisTab).find(".moneySoTotal").text()+"&skuCount="+$("#"+a.thisTab).find(".skuCountTotal").text()+"&moneyService="+$("#"+a.thisTab).find(".moneyServiceTotal").text()+"&moneyStock="+$("#"+a.thisTab).find(".moneyStockTotal").text()+"&moneyPackage="+$("#"+a.thisTab).find(".moneyPackageTotal").text()+"&moneyShip="+$("#"+a.thisTab).find(".moneyShipTotal").text()+"&moneyCost="+$("#"+a.thisTab).find(".moneyCostTotal").text()+"&returnSkuCount="+$("#"+a.thisTab).find(".returnSkuCountTotal").text()+"&returnMoneySo="+$("#"+a.thisTab).find(".returnMoneySoTotal").text()+"&returnMoneyShip="+$("#"+a.thisTab).find(".returnMoneyShipTotal").text()+"&returnMoneyStock="+$("#"+a.thisTab).find(".returnMoneyStockTotal").text()+"&returnMoneyPackage="+$("#"+a.thisTab).find(".returnMoneyPackageTotal").text()+"&returnMoneyCost="+$("#"+a.thisTab).find(".returnMoneyCostTotal").text();
FormUtils.submit(AgentBill._CONS_.SAVE_EDIT_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"编辑成功");a.loadAgentBill(JSON.parse(c.msg));
}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){ButtonUtils.enableBtn("agentBillSave");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
}else{DialogUtils.error(msgCode.ERROR,"对账不存在，请添加");}});$(".agentBillFluctuate").on("click",function(){$("#fluctuateModalContainer").modal("show");});$("#fluctuateSave").on("click",function(){if($("#agentBillOtherForm").find("input[name=billId]").val()){var b=$("#agentBillOtherForm").serialize();
FormUtils.submit(AgentBill._CONS_.SAVE_OTHER_URL,b,function(c){ButtonUtils.enableBtn("fluctuateSave");if(c.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
$("#"+a.thisTab).find(".agentBillSearch").trigger("click");$("#fluctuateModalContainer").modal("hide");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){ButtonUtils.enableBtn("fluctuateSave");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}else{DialogUtils.error(msgCode.ERROR,"该代理商没有对账单");
}});$(".agentBillCreate").on("click",function(){var b=$("#"+a.thisTab).find("input[name=startTime]").val();var c=$("#"+a.thisTab).find("input[name=endTime]").val();
var d=$("#"+a.thisTab).find("input[name=agentId]").val();FormUtils.submit(AgentBill._CONS_.INSET_BILL_URL,"agentId="+d+"&beginTime="+b+"&endTime="+c,function(e){if(e.success){$("#"+a.thisTab).find(".agentBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.FAIL_MSG,"没有可同步的数据！！");}},function(){ButtonUtils.enableBtn("agentBillCreate");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});}};