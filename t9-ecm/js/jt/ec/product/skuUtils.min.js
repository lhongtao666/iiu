var SkuUtils={bindEventHandler:function(){var a=this;$("#skuContainer").on("ifChecked","input[type='checkbox']",function(){var b=$(this).attr("name");$("#skuContainer input[type='checkbox']").each(function(){if($(this).attr("name")!=b){$(this).iCheck("uncheck");
}});});$(document).on("click",".prodStockBtn",function(){var b=$(this).attr("skuId");layer.open({type:2,title:"sku库存",maxmin:false,shadeClose:true,area:["80%","80%"],content:ctx+"/ec/product/prodEntity/prodStock.htm?prodEntityId="+$("#id").val()+"&skuId="+$(this).attr("skuId")});
});$(document).on("change","input[name$=code]",function(c){var b=$(this).val();$(this).parents("tr").find("[name$=shortName]").val(b);});$(document).on("change","#skuCode",function(c){var b=$(this).val();
$(this).parents("tr").find("#skuShortName").val(b);});},bindFormValidation:function(){var a={rules:{skuCode:{required:true,maxlength:20},skuPrice:{number:true,required:true},skuStatus:{required:true},skuShortName:{required:true,maxlength:20},skuStartStock:{digits:true,},buyLimit:{digits:true,number:true,min:1,max:99},skuPercentLimit:{digits:true,number:true,min:1,max:99}},messages:{buyLimit:{digits:"请输入正整数",min:"请输入大于1的整数",max:"请输入小于99的整数"},skuPercentLimit:{digits:"请输入正整数",min:"请输入大于1的整数",max:"请输入小于99的整数"}}};
FormUtils.bindFormValidation("normalSkuForm",a);FormUtils.bindFormValidation("skuContainer from",a);},_createSkuTable:function(d,a){var f=new Set();var e=new Set();
$("#eavSkuContainer form input").each(function(){f.add($(this).attr("name"));});$("#eavSkuContainer form label.control-label").each(function(){e.add($(this).text().trim());
});var c=[];for(var b=0;b<f.size();b++){if(!$("input[name='"+f.get(b)+"']:checked").length){DialogUtils.error(msgCode.ERROR,"请勾选要生成sku的选项");return;}var g=[];
$("input[name='"+f.get(b)+"']:checked").each(function(){var h={label:$(this).next().text(),value:$(this).attr("value")};g.push(h);});c.push(g);}SkuUtils.createSkuTable(e,c,d,a);
},createSkuTable:function(x,s,v,t){this.skuCache=[];var c=new StringBuffer();this.skuFormId="_"+new Date().getTime();c.append("<form id='"+this.skuFormId+"'>");
c.append("<table class='table table-striped table-bordered'>");c.append("<tr>");for(var u=0;u<x.size();u++){c.append("<th>");if(x.get(u).charAt(x.get(u).length-1)=="*"){c.append(x.get(u).substring(0,x.get(u).length-1));
}else{c.append(x.get(u));}c.append("</th>");}c.append("<th>");c.append("sku库存型号<span style='color: red;'>*</span>");c.append("</th>");if(type=="point"){c.append("<th>");
c.append("积分数量<span style='color: red;'>*</span>");c.append("</th>");}else{if(type=="product"){c.append("<th>");c.append("价格"+"<span style='color: red;'>*</span>");
c.append("</th>");}}c.append("<th>规格</th>");c.append("<th>");c.append("默认");c.append("</th>");c.append("<th style='min-width:67px;'>状态<span style='color: red;'>*</span></th>");
c.append("<th style='min-width:30px;'>每单限制<label><a style='margin-left:10px' title='该商品每单最多能售卖多少个'><img src='/t9-ecm/img/jt/help.png'></a></label></th>");
c.append("<th style='min-width:30px;'>sku折扣限制<label><a style='margin-left:10px' title='该商品允许的最低折扣，存在部门折扣时以两者中低的为准'><img src='/t9-ecm/img/jt/help.png'></a></label></th>");
c.append("<th>");c.append("报表简称<span style='color: red;'>*</span>");c.append("</th>");c.append("<th>");c.append("初始库存");c.append("</th>");c.append("<th>");
c.append("采购价");c.append("</th>");if($('input[name="id"]').val()){c.append("<th style='min-width:100px;'>");c.append("操作");c.append("</th>");}else{c.append("<th style='min-width:100px;'>");
c.append("操作");c.append("</th>");}c.append("</tr>");switch(s.length){case 1:for(var e=0;e<s[0].length;e++){c.append("<tr>");c.append("<td>");c.append(s[0][e].label);
c.append("</td>");var y=s[0][e].value;var o=y+"___code";var q=y+"___price";var d=y+"___isDefault";var h=y+"___status";var z=y+"___skuId";var k=y+"___shortName";
var B=y+"___startStock";var r=y+"___bizPrice";var g=y+"___startStore";var j=y+"___spec";var l=y+"___buyLimit";var A=y+"___skuPercentLimit";c.append(this._createSkuInfo(o,q,d,h,z,k,B,r,g,j,l,A,t));
c.append("</tr>");var n=[];n.push(s[0][e].value);this.skuCache.push(n);}break;case 2:for(var e=0;e<s[0].length;e++){var f=true;for(var b=0;b<s[1].length;
b++){if(f){c.append("<tr>");c.append("<td rowspan='"+s[1].length+"'>");c.append(s[0][e].label);c.append("</td>");f=false;}else{c.append("<tr>");}c.append("<td>");
c.append(s[1][b].label);c.append("</td>");var y=s[0][e].value+"___"+s[1][b].value;var o=y+"___code";var q=y+"___price";var d=y+"___isDefault";var h=y+"___status";
var z=y+"___skuId";var k=y+"___shortName";var B=y+"___startStock";var r=y+"___bizPrice";var g=y+"___startStore";var l=y+"___buyLimit";var A=y+"___skuPercentLimit";
var j=y+"___spec";c.append(this._createSkuInfo(o,q,d,h,z,k,B,r,g,j,l,A,t));c.append("</tr>");var n=[];n.push(s[0][e].value);n.push(s[1][b].value);this.skuCache.push(n);
}}break;case 3:for(var e=0;e<s[0].length;e++){var f=true;for(var b=0;b<s[1].length;b++){var a=true;for(var w=0;w<s[2].length;w++){var p=true;if(f){c.append("<tr>");
c.append("<td rowspan='"+s[1].length*s[2].length+"'>");c.append(s[0][e].label);c.append("</td>");f=false;}else{c.append("<tr>");}if(a){c.append("<td rowspan='"+s[2].length+"'>");
c.append(s[1][b].label);c.append("</td>");a=false;}c.append("<td>");c.append(s[2][w].label);c.append("</td>");var y=s[0][e].value+"___"+s[1][b].value+"___"+s[2][w].value;
var o=y+"___code";var q=y+"___price";var d=y+"___isDefault";var h=y+"___status";var z=y+"___skuId";var k=y+"___shortName";var B=y+"___startStock";var r=y+"___bizPrice";
var g=y+"___startStore";var j=y+"___spec";var l=y+"___buyLimit";var A=y+"___skuPercentLimit";c.append(this._createSkuInfo(o,q,d,h,z,k,B,r,g,j,l,A,t));c.append("</tr>");
var n=[];n.push(s[0][e].value);n.push(s[1][b].value);n.push(s[2][w].value);this.skuCache.push(n);}}}break;case 4:for(var e=0;e<s[0].length;e++){var f=true;
for(var b=0;b<s[1].length;b++){var a=true;for(var w=0;w<s[2].length;w++){var p=true;for(var m=0;m<s[3].length;m++){if(f){c.append("<tr>");c.append("<td rowspan='"+s[1].length*s[2].length*s[3].length+"'>");
c.append(s[0][e].label);c.append("</td>");f=false;}else{c.append("<tr>");}if(a){c.append("<td rowspan='"+s[2].length*s[3].length+"'>");c.append(s[1][b].label);
c.append("</td>");a=false;}if(p){c.append("<td rowspan='"+s[3].length+"'>");c.append(s[2][w].label);c.append("</td>");p=false;}c.append("<td>");c.append(s[3][m].label);
c.append("</td>");var y=s[0][e].value+"___"+s[1][b].value+"___"+s[2][w].value+"___"+s[3][m].value;var o=y+"___code";var q=y+"___price";var d=y+"___isDefault";
var h=y+"___status";var z=y+"___skuId";var k=y+"___shortName";var B=y+"___startStock";var r=y+"___bizPrice";var g=y+"___startStore";var j=y+"___spec";var l=y+"___buyLimit";
var A=y+"___skuPercentLimit";c.append(this._createSkuInfo(o,q,d,h,z,k,B,r,g,j,l,A,t));c.append("</tr>");var n=[];n.push(s[0][e].value);n.push(s[1][b].value);
n.push(s[2][w].value);n.push(s[3][m].value);this.skuCache.push(n);}}}}break;case 5:break;case 6:break;}c.append("</table>");c.append("</form>");if($("#skuContainer table").length==0){$("#skuContainer").empty().append(c.toString());
$("#skuContainer tr [name=theDefaultSku]").first().attr("checked",true);}else{$("#skuContainer").empty().append(c.toString());$("#skuContainer tr [name=theDefaultSku]").first().attr("checked",true);
if(this.prodSkuPoList&&this.prodSkuPoList.length){this._recoverSkuValue(this.prodSkuPoList);}}this._bindSkuFormValidation();StoreUtils.loadSimpleStores({container:"startStoreSelectorClass",useDefaultOpt:true,});
CateUtils.getOptions({typeKey:"system",pKey:"product_sku_spec",container:"moreSkuSpecSelect",});},_createSkuInfo:function(j,a,i,e,c,k,l,g,m,n,b,f,d){var h=new StringBuffer();
h.append("<td>"+this._createSkuCodeInputStr(j)+"</td>");h.append("<td>"+this._createSkuPriceInputStr(a)+"</td>");h.append("<td>"+this._createSkuSpecInputStr(n)+"</td>");
h.append("<td>"+this._createSkuIsDefaultCheckboxStr(i)+"</td>");h.append("<td>"+this._createSkuStatusSelectStr(e)+"</td>");h.append("<td>"+this._createBuyLimitSelectStr(b)+"</td>");
h.append("<td>"+this._createSkuPercentLimitSelectStr(f)+"</td>");h.append("<td>"+this._createSkuShortNameStr(k)+"</td>");h.append("<td>"+this._createStartStockInputStr(l)+"</td>");
h.append("<td>"+this._createBizPriceInputStr(g)+"</td>");if($('input[name="id"]').val()){if(this._checkSkuValue(d,j)||this._checkSkuValue(this.prodSkuPoList,j)){h.append("<td>"+this._createSkuButtonStr(c)+"</td>");
}else{h.append("<td>"+this._createStartStoreSelectStr(m)+"</td>");}}else{h.append("<td>"+this._createStartStoreSelectStr(m)+"</td>");}return h.toString();
},_createSkuSpecInputStr:function(a){return"<select validateType='default' name='"+a+"' type='text' class='form-control moreSkuSpecSelect'>";},_createStartStoreSelectStr:function(a){return"<select validateType='default' name='"+a+"' type='text' class='form-control startStoreSelectorClass'>";
},_createStartStockInputStr:function(a){return"<input validateType='default' name='"+a+"' type='text' class='form-control'>";},_createBizPriceInputStr:function(a){return"<input validateType='default' name='"+a+"' type='text' class='form-control'>";
},_createSkuCodeInputStr:function(a){return"<input validateType='default' name='"+a+"' type='text' class='form-control'>";},_createSkuPriceInputStr:function(a){return"<input validateType='default' name='"+a+"' type='text' class='form-control'>";
},_createSkuIsDefaultCheckboxStr:function(a,c){var b="";if(c){b=" checked='checked'";}var d=new StringBuffer();d.append("<div class='radio radio-success radio-inline'>");
d.append("<input type='radio' name='theDefaultSku' isDefaultNameVal='"+a+"' aria-label='默认sku'>");d.append("<label></label>");d.append("</div>");return d.toString();
},_createSkuStatusSelectStr:function(a){var b=new StringBuffer();b.append("<select validateType='default' name='"+a+"' class='form-control'>").append("<option value='on_sale'>上架</option>").append("<option value='not_on_sale'>下架</option>").append("<option value='sold_out'>售罄</option>").append("</select>");
return b.toString();},_createBuyLimitSelectStr:function(a){return"<input class='form-control' type='number' name='"+a+"'  max='99' min='1'>";},_createSkuPercentLimitSelectStr:function(a){return"<input class='form-control' type='number' name='"+a+"'  max='99' min='1'>";
},_createSkuShortNameStr:function(a){return"<input validateType='default' name='"+a+"' type='text' class='form-control'>";},_createSkuButtonStr:function(a){var b=new StringBuffer();
b.append("<button name='"+a+"' type='button' class='btn btn-sm btn-outline btn-primary prodStockBtn'>库存</button>&nbsp;&nbsp;");return b.toString();},_bindSkuFormValidation:function(){var p={};
var o={};for(var g=0;g<this.skuCache.length;g++){var h="";var m="";var b="";var l="";var e="";var c="";var k="";var f="";var n="";var a="";for(var d=0;
d<this.skuCache[g].length;d++){if(d==this.skuCache[g].length-1){m=m+this.skuCache[g][d]+"___code";b=b+this.skuCache[g][d]+"___price";e=e+this.skuCache[g][d]+"___status";
k=k+this.skuCache[g][d]+"___shortName";f=f+this.skuCache[g][d]+"___bizPrice";n=n+this.skuCache[g][d]+"___startStock";a=a+this.skuCache[g][d]+"___spec";
}else{m=m+this.skuCache[g][d]+"___";b=b+this.skuCache[g][d]+"___";e=e+this.skuCache[g][d]+"___";k=k+this.skuCache[g][d]+"___";f=f+this.skuCache[g][d]+"___";
n=n+this.skuCache[g][d]+"___";a=a+this.skuCache[g][d]+"___s";}o[m]={required:true};o[b]={required:true,number:true};o[e]={required:true};o[k]={required:true};
o[f]={number:true};o[n]={digits:true};o[a]={};}}p.rules=o;FormUtils.bindFormValidation(this.skuFormId,p);},isValid:function(){if($("select[name='type']").val()==="entity"||$("select[name='type']").val()==="pointNormal"||$("select[name='type']").val()==="finance"||$("select[name='type']").val()==="card"||$("select[name='type']").val()==="service"){return $("#normalSkuForm").valid();
}else{if(!this.skuFormId){DialogUtils.error(msgCode.ERROR,"您还没有添加该商品的sku");return false;}var a=this._hasSetDefaultSku();if(!a){DialogUtils.error(msgCode.ERROR,"请设置默认sku");
return false;}return $("#"+this.skuFormId).valid();}},_hasSetDefaultSku:function(){var a=false;$("input[name='theDefaultSku']").each(function(){if($(this).is(":checked")){a=true;
return false;}});return a;},getSkuJson:function(){if($("select[name='type']").val()=="sku_entity"||$("select[name='type']").val()=="pointSku"){var d=this.skuCache;
var o=[];var u=0;var e=-1;$("#eavSkuContainer form .form-group").each(function(){if($(this).find("input[isMainAttr='y']").length>0){e=$(this).index();return false;
}});for(var q=0;q<d.length;q++){var l={};var m="";var k="";var n="";var b="";var f="";var v="";var c="";var t="";var r="";var a="";var g="";var h="";var s="";
for(var p=0;p<d[q].length;p++){if(p==d[q].length-1){m=m+d[q][p];k=k+d[q][p]+"___code";n=n+d[q][p]+"___price";b=b+d[q][p]+"___isDefault";f=f+d[q][p]+"___status";
v=v+d[q][p]+"___skuId";c=c+d[q][p]+"___shortName";t=t+d[q][p]+"___startStock";r=r+d[q][p]+"___bizPrice";a=a+d[q][p]+"___startStore";g=g+d[q][p]+"___spec";
h=h+d[q][p]+"___buyLimit";s=s+d[q][p]+"___skuPercentLimit";}else{m=m+d[q][p]+",";k=k+d[q][p]+"___";n=n+d[q][p]+"___";b=b+d[q][p]+"___";f=f+d[q][p]+"___";
v=v+d[q][p]+"___";c=c+d[q][p]+"___";t=t+d[q][p]+"___";r=r+d[q][p]+"___";a=a+d[q][p]+"___";g=g+d[q][p]+"___";h=h+d[q][p]+"___";s=s+d[q][p]+"___";}}l.attrJson=m;
var w=m.split(",");l.skuOpValue=w[e];l.path=$("#imageContainer").find("tr[optVal='"+l.skuOpValue+"']").find("td:eq(1)").find(".file").attr("urlVal");l.skuId=$("button[name='"+v+"']").eq(0).attr("skuId");
l.code=$("input[name='"+k+"']").val().trim();l.price=$("input[name='"+n+"']").val().trim();l.isSnapshot="n";l.id=l.skuId;l.isDefault=$("input[isDefaultNameVal='"+b+"']").is(":checked")?"y":"n";
l.status=$("select[name='"+f+"']").val().trim();l.shortName=$("input[name='"+c+"']").val().trim();l.startStock=$("input[name='"+t+"']").val().trim();l.bizPrice=$("input[name='"+r+"']").val().trim();
l.startStore=$("[name='"+a+"']").val();l.spec=$("[name='"+g+"']").val();l.sort=u++;l.buyLimit=$("[name='"+h+"']").val();l.skuPercentLimit=$("[name='"+s+"']").val();
l.createType=$("#skuSelect").val()?"options":"single";o.push(l);}return JSON.stringify(o);}else{if($("select[name='type']").val()=="entity"||$("select[name='type']").val()=="pointNormal"||$("select[name='type']").val()=="service"||$("select[name='type']").val()=="card"||$("select[name='type']").val()=="finance"){var l=[{shortName:$("#skuShortName").val(),code:$("#skuCode").val(),price:$("#skuPrice").val(),createType:"single",isDefault:"y",status:$("#skuStatus").val(),sort:1,isSnapshot:"n",bizPrice:$("[name=bizPrice]").val(),startStock:$("[name=startStock]").val(),skuId:$(".prodStockBtn").attr("skuId"),startStore:$("[name=startStore]").val(),spec:$("[name=spec]").val(),shortName:$("[name=skuShortName]").val(),prodCode:$("[name=prodCode]").val(),barCode:$("[name=barCode]").val(),id:$(".prodStockBtn").attr("skuId"),buyLimit:$("[name=buyLimit]").val(),skuPercentLimit:$("[name=skuPercentLimit]").val()}];
return JSON.stringify(l);}}},setPrice:function(c){if(c=="gift"){var b=$("#multiSkuContainer").find("table tr");$.each(b,function(){$(this).find("td:eq(2) input").val(0).attr("readonly","readonly");
});var a=$("#normalSkuForm").find("table tr");$.each(a,function(){$(this).find("td:eq(1) input").val(0).attr("readonly","readonly");});}else{var b=$("#multiSkuContainer").find("table tr");
$.each(b,function(){$(this).find("td:eq(2) input").removeAttr("readonly");});var a=$("#normalSkuForm").find("table tr");$.each(a,function(){$(this).find("td:eq(1) input").removeAttr("readonly");
});}},emptySkuCode:function(a){if(a){var c=$("#multiSkuContainer").find("table tr");$.each(c,function(){$(this).find("td:eq(1) input").val("");$(this).find("td input[name$=startStock]").attr("readonly",false).trigger("change");
$(this).find("td input[name$=bizPrice]").attr("readonly",false).trigger("change");});var b=$("#normalSkuForm").find("table tr");$.each(b,function(){$(this).find("td:eq(0) input").val("");
$(this).find("td input[name=startStock]").attr("readonly",false).trigger("change");$(this).find("td input[name=bizPrice]").attr("readonly",false).trigger("change");
});$(".prodStockBtn").attr("skuId","");}},_checkSkuValue:function(f,a){if(f&&f.length){for(var h=0;h<f.length;h++){var k=f[h].attrJson.split(",");var n="";
var b="";var m="";var e="";var c="";var l="";var g="";var o="";for(var d=0;d<k.length;d++){if(d===k.length-1){n=n+k[d]+"___code";b=b+k[d]+"___price";m=m+k[d]+"___isDefault";
e=e+k[d]+"___status";c=c+k[d]+"___skuId";l=l+k[d]+"___shortName";o=o+k[d]+"___startStock";g=g+k[d]+"___bizPrice";}else{n=n+k[d]+"___";b=b+k[d]+"___";m=m+k[d]+"___";
e=e+k[d]+"___";c=c+k[d]+"___";l=l+k[d]+"___";o=o+k[d]+"___";g=g+k[d]+"___";}}if(a==n){return true;}}}return false;},_recoverSkuValue:function(f){for(var h=0;
h<f.length;h++){var l=f[h].attrJson.split(",");var o="";var b="";var n="";var e="";var c="";var m="";var g="";var p="";var a="";var k="";var q="";for(var d=0;
d<l.length;d++){if(d===l.length-1){o=o+l[d]+"___code";b=b+l[d]+"___price";n=n+l[d]+"___isDefault";e=e+l[d]+"___status";c=c+l[d]+"___skuId";m=m+l[d]+"___shortName";
p=p+l[d]+"___startStock";g=g+l[d]+"___bizPrice";a=a+l[d]+"___spec";k=k+l[d]+"___buyLimit";q=q+l[d]+"___skuPercentLimit";}else{o=o+l[d]+"___";b=b+l[d]+"___";
n=n+l[d]+"___";e=e+l[d]+"___";c=c+l[d]+"___";m=m+l[d]+"___";p=p+l[d]+"___";g=g+l[d]+"___";a=a+l[d]+"___";k=k+l[d]+"___";q=q+l[d]+"___";}}$("input[name='"+o+"']").val(f[h].code);
$("input[name='"+b+"']").val(f[h].price);$("select[name='"+e+"']").val(f[h].status);$("button[name='"+c+"']").attr("skuId",f[h].skuId);$("input[name='"+m+"']").val(f[h].shortName);
$("input[name='"+g+"']").val(f[h].bizPrice).attr("readonly",true);$("input[name='"+p+"']").val(f[h].startStock).attr("readonly",true);$("select[name='"+a+"']").val(f[h].spec);
if(f[h].buyLimit){$("input[name='"+k+"']").val(f[h].buyLimit);}else{$("input[name='"+k+"']").val("");}if(f[h].skuPercentLimit){$("input[name='"+q+"']").val(f[h].skuPercentLimit);
}else{$("input[name='"+q+"']").val("");}if(f[h].isDefault=="y"){$("input[isDefaultNameVal="+n+"]").prop("checked",true);}}},recoverSkuTable:function(a){if(a&&a.length){this.prodSkuPoList=a;
this._createSkuTable("",a);this._recoverSkuValue(a);}}};