$(function(){var a=new SelectSku();a.initWrapper();});function SelectSku(){this.initJqgrid=false;this.cateId="";this.selectedJqgrid=new Array();this.selectedRowData=new Array();
this.rootKey="";if(type=="product"){this.rootKey="category";}else{if(type=="point"){this.rootKey="prodPoint";}}}SelectSku._CONS_={LIST_DATA_URL:ctx+"/ec/product/prodEntity/listSkuData.htm",GRID:"#prodEntityGrid",PAGER:"#prodEntityPager"};
SelectSku.prototype={initWrapper:function(){this._initProdCateTree();this._bindEventHandler();},_bindEventHandler:function(){var a=this;$(SelectSku._CONS_.GRID).on("click",".skuPreviewBtn",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodEntityId="+$(this).attr("prodEntityIdVal")+"&prodSkuId="+$(this).attr("prodSkuIdVal"),"商品【"+$(this).attr("prodEntityNameVal")+"】");
});$("#skuSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".prodEntitySearch").trigger("click");}});$("#skuSearchForm").on("click",".prodEntitySearch",function(){var b=$(this).closest("form").serialize();
b+="&Q__S__EQ__cate_id_="+a.cateId;b+="&storeId="+storeId;b+="&rootKey="+a.rootKey;b+="&canSale="+canSale;if("y"!=showNotOnSale){b+="&Q__S__EQ__prod.status_=on_sale";
}b+="&Q__S__IN__prod.type_=sku_entity,entity,pointNormal,pointSku,finance,card,service";b+="&limitProdCate="+limitProdCate;b+="&Q__S__EQ__prod.price_type_="+priceType;
b+="&showNotOnSale="+showNotOnSale;a._reloadJqgrid(b);});},_initProdCateTree:function(){var a=this;var b={treeId:"prodEntityCateTree",cateTypeKey:"product_catalog",rootKey:this.rootKey,limitProdCate:limitProdCate,userId:userId,isSale:isSale,contextMenu:{},saveFn:function(c){},onClick:function(c){a.cateId=c.id;
$("input[name='nameSearch']").val("");$("input[name='keySearch']").val("");$("input[name='codeSearch']").val("");if(a.initJqgrid){var d={Q__S__EQ__cate_id_:a.cateId,rootKey:a.rootKey,storeId:storeId,limitProdCate:limitProdCate,hasStock:$("#hasStock")[0].checked?"y":"n",canSale:canSale,"Q__S__EQ__prod.price_type_":priceType,"Q__S__EQ__prod.status_":"on_sale","Q__S__IN__prod.type_":"sku_entity,entity,pointNormal,pointSku,finance,card,service"};
a._reloadJqgrid(d);}else{$("#hasStock").prop("checked",hasStock=="y"?true:false);if(hideCanSale=="y"){$("#hasStock").parents(".col-sm-2").hide();}a._initJqgrid(a.cateId);
}}};ZtreeUtils.init(b);},_reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(SelectSku._CONS_.GRID,a);},_pushData:function(a){var b=$(SelectSku._CONS_.GRID).jqGrid("getRowData",a);
b.skuId=a;b.imgUrl=$(b.path).attr("imgPathVal");b.path=b.imgUrl;b.skuCode=$(b.code).text();b.code=$(b.code).text();b.totalQty=b.canSaleQty;this.selectedRowData.push(b);
},_removeData:function(b){for(var a=0;a<this.selectedRowData.length;a++){var c=this.selectedRowData[a];if(c.skuId==b){this.selectedRowData.splice(a,1);
return;}}},_initJqgrid:function(f){var b=this;if(!f){f="";}this.initJqgrid=true;$.jgrid.defaults.styleUI="Bootstrap";var d="";if(type=="product"){d="销售价";
}else{if(type=="point"){d="积分数";}}var a={Q__S__EQ__cate_id_:f,rootKey:this.rootKey,storeId:storeId,hasStock:hasStock,limitProdCate:limitProdCate,canSale:canSale,agentId:agentId,showNotOnSale:showNotOnSale,filterSeries:filterSeries,"Q__S__EQ__prod.status_":"y"==showNotOnSale?"":"on_sale","Q__S__EQ__prod.price_type_":priceType,"Q__S__IN__prod.type_":"sku_entity,entity,pointNormal,pointSku"};
var e=["图片","prodId","buyLimit","skuId","名称","sku","sku属性",d,"单位","仓位",];var c=[{name:"path",width:80,align:"center",sortable:false,formatter:function(h){if(h){var g={path:h,isZoom:"y"};
h=ImageUtils.getUrl(g,"mm");return"<img imgpathVal='"+g.path+"' src='"+h+"?dm=_mm' style='width:30px; height:30px;'>";}else{return"<img imgUrlVal='/img/jt/nophoto.png' src='"+ctx+"/img/jt/nophoto.png"+"' style='width:30px; height:30px;'>";
}}},{name:"prodId",width:120,sortable:false,hidedlg:true,hidden:true},{name:"buyLimit",width:120,sortable:false,hidedlg:true,hidden:true},{name:"skuId",width:120,sortable:false,hidedlg:true,hidden:true},{name:"prodName",index:"prod.name_",width:180,sortable:false},{name:"code",index:"sku.code_",width:120,sortable:false,formatter:function(h,g,i){return"<a href='javascript:void(0);' class='skuPreviewBtn' prodEntityIdVal='"+i.prodId+"' prodSkuIdVal='"+i.skuId+"' prodEntityNameVal='"+i.prodName+"'>"+h+"</a>";
}},{name:"attrJson",index:"attr_json_",width:120,sortable:false},{name:"price",width:120,sortable:false},{name:"unit",width:80,hidden:false,sortable:false},{name:"position",hidden:canSale=="y"?false:true,width:120,sortable:false},];
if(canSale=="y"){e=e.concat(["总数","可售数量","不良品"]);c=c.concat([{name:"totalQty",width:120,sortable:false},{name:"canSaleQty",width:120,sortable:false},{name:"badQty",width:120,sortable:false}]);
}e.push("备注");c.push({name:"content",width:120,sortable:false});$(SelectSku._CONS_.GRID).jqGrid({url:SelectSku._CONS_.LIST_DATA_URL,pager:SelectSku._CONS_.PAGER,datatype:"json",mtype:"post",width:$("#skuSearchForm").width(),postData:a,shrinkToFix:true,multiselect:isMultiple==1,pagerpos:"center",rowNum:20,rownumbers:true,rowList:[10,20,50,100],viewrecords:true,hidegrid:false,colNames:e,colModel:c,rowNum:20,sortable:true,hidegrid:false,loadComplete:function(){for(var g=0;
g<b.selectedJqgrid.length;g++){$(SelectSku._CONS_.GRID).jqGrid("setSelection",b.selectedJqgrid[g]);}},gridComplete:function(){$(SelectSku._CONS_.GRID).find("img").ImageEnlarge();
var h=$(SelectSku._CONS_.GRID).jqGrid("getGridParam","records");if(h<=0){if($(".norecords").html()==null){$(SelectSku._CONS_.GRID).parent().append('<div class="norecords">没有符合数据！</div>');
$(".norecords").show();}else{$(".norecords").show();}}else{$(".norecords").hide();}$(SelectSku._CONS_.GRID).find("td[colspan='12']").attr("colspan",11);
if(!b._hadSetHeight){b._hadSetHeight=true;var g=$(window).height()-$(".panel-heading").outerHeight()-$(SelectSku._CONS_.PAGER).outerHeight()-$(".ui-jqgrid-hdiv").outerHeight()-25;
$(SelectSku._CONS_.GRID).jqGrid("setGridHeight",g);}},onSelectAll:function(j,g){if(j&&j.length>0){for(var h=0;h<j.length;h++){if(g){if(b.selectedJqgrid.indexOf(j[h])==-1){b.selectedJqgrid.push(j[h]);
b._pushData(j[h]);}}else{b.selectedJqgrid.remove(j[h]);b._removeData(j[h]);}}}$("#selectedRowData").val(JSON.stringify(b.selectedRowData));},onSelectRow:function(h,g){if(g){if(b.selectedJqgrid.indexOf(h)==-1){b.selectedJqgrid.push(h);
b._pushData(h);}}else{b.selectedJqgrid.remove(h);b._removeData(h);}$("#selectedRowData").val(JSON.stringify(b.selectedRowData));}});}};