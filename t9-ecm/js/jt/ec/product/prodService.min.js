$(function(){var a=new ProdService();a.init();});function ProdService(){this.isEdit=false;this.isFormDataChange=false;this.cateId="";this.cateName="";this.eavSku=null;
}ProdService._CONS_={EDIT_FORM_ID:"prodServiceForm",GRID:"#prodServiceGrid",PAGER:"#prodServicePager",EDIT_URL:ctx+"/ec/product/prodEntity/edit.htm",DELETE_URL:ctx+"/ec/product/prodEntity/delete.htm",SAVE_ADD_URL:ctx+"/ec/product/prodEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/product/prodEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/product/prodEntity/listData.htm",UPDATE_STATUS_URL:ctx+"/ec/product/prodEntity/updateStatus.htm",SKU_EAV_PARAM:{bizType:"sku",entityType:"jt_prod_entity",entityTypeSelectId:"skuSelect",containerId:"eavSkuContainer"},};
ProdService.prototype={init:function(){this._loadProdCateTree();this._bindEventHandler();this._hideNotGrantBtn();this._bindFormValidation();this.eavSku=new Eav(ProdService._CONS_.SKU_EAV_PARAM);
},clear:function(c){var a=this;function b(){FormUtils.clear(ProdService._CONS_.EDIT_FORM_ID);FormUtils.enableForm(ProdService._CONS_.EDIT_FORM_ID);a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;a.eavSku.setEntityId("");a.eavSku.clear();$("#normalSkuContainer").show();$("#multiSkuContainer").hide();$("#skuPrice").val("");
$("#skuCode").val("");$("#skuStatus").val("");$(".form_wrapper .saveBtn").show();$("select[name='type']").removeAttr("disabled");$("#skuSelect").empty();
$("#skuSelect").append("<option value=''>默认sku</option>");$("#skuSelect").attr("disabled","disabled");$("#skuContainer").empty();$(".tabs-container li").removeClass("active");
$(".tabs-container li:eq(0)").addClass("active");$(".tabs-container .tab-content .tab-pane").removeClass("active");$(".tabs-container .tab-content .tab-pane:eq(0)").addClass("active");
if(c){$(".prodServiceSearch").trigger("click");}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_loadProdCateTree:function(){var a=this;
var c=true;if(status&&status=="delete"){c=false;}var b={treeId:"prodEntityCateTree",cateTypeKey:"product_catalog",rootKey:"product_service",userId:"",contextMenu:{add:{isShow:true,title:"添加分类",clickFn:function(d){},clazz:"addAlbumBtn"},update:{isShow:true,title:"更新分类",clickFn:function(){},clazz:"updateAlbumBtn"},del:{isShow:c,title:"删除分类",clickFn:function(d){msgCode.DELETE_TITLE="您确定要删除这个节点吗";
DialogUtils.confirm(function(){FormUtils.submit(ProdService._CONS_.DELETE_PROD_CATE_URL,"cateId="+d.id,function(f){if(f.success){var e=$.fn.zTree.getZTreeObj("prodEntityCateTree");
e.removeNode(d);DialogUtils.success(msgCode.SUCCESS,f.msg);}else{DialogUtils.error(msgCode.ERROR,f.msg);}});});},clazz:"deleteAlbumBtn"},},saveFn:function(d){a.cateId=d.id;
a.cateName=d.name;a.reloadJqgrid();},onClick:function(d){a.cateId=d.id;a.cateName=d.name;if(a._hadInitJqgrid){a.reloadJqgrid({Q__S__EQ__cate_id_:a.cateId});
}else{a._hadInitJqgrid=true;a._initJqgrid({Q__S__EQ__cate_id_:a.cateId});}}};ZtreeUtils.init(b);},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_bindEventHandler:function(){var a=this;SkuUtils.bindEventHandler();
$("select[name='type']").on("change",function(){var b=$(this).val();if(b==="sku_entity"){$("#skuSelect").removeAttr("disabled");$("#multiSkuContainer").show();
$("#normalSkuContainer").hide();a.eavSku.getEavSetList();}else{if(b==="entity"){$("#skuSelect").empty();$("#skuSelect").append("<option value=''>默认sku</option>");
$("#skuSelect").attr("disabled","disabled");$("#normalSkuContainer").show();$("#multiSkuContainer").hide();}}});$(document).on("click",".putOnSaleBtn",function(b){b.stopPropagation();
var c=$(this).attr("idVal");a._updateStatus(c);});$(document).on("click",".pullOffShelvesBtn",function(b){b.stopPropagation();var c=$(this).attr("idVal");
a._updateStatus(c);});$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){a._save();});$("#"+ProdService._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+ProdService._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+ProdService._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".prodServiceSearch",function(){var b=$(this).closest("form").serialize();b+="Q__S__EQ__cate_id_="+a.cateId;a.reloadJqgrid(b);
});$("#prodServiceSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();$(".prodServiceSearch").trigger("click");
}});$("body").on("click",".prodServiceAdd",function(){a._add();});$("body").on("click",".prodServiceEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(ProdService._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".prodServiceDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(ProdService._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".prodServiceDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ProdService._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});},_add:function(){this._showFormWrapper();},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_detail:function(a){},_delete:function(b){var a=this;
DialogUtils.confirm(function(){FormUtils.del(ProdService._CONS_.DELETE_URL,b,function(c){if(c.success){a.reloadJqgrid();DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_loadData:function(b){var a=this;FormUtils.loadData(ProdService._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);
$("input[name=name]").val(c.name);$("input[name=shortName]").val(c.shortName);$("input[name=key]").val(c.key);$("textarea[name='summary']").val(c.summary);
$("select[name='type']").val(c.type);$("input[name=status]").val(c.status);$("input[name=createBy]").val(c.createBy);$("input[name=createTime]").val(c.createTime);
$("select[name='type']").attr("disabled","disabled");if(c.type==="sku_entity"){if(c.eavKeyMap.sku){$("#multiSkuContainer").show();$("#skuImageContainer").show();
$("#normalSkuContainer").hide();a.eavSku.setEntityId(c.id);a.eavSku.getEavSetList(c.eavKeyMap.sku);a.eavSku.setEavSetKey(c.eavKeyMap.sku);a.eavSku.renderEavForm();
SkuUtils.recoverSkuTable(c.prodSkuVoList);$("#skuSelect").attr("disabled","disabled");}}else{$("#skuSelect").attr("disabled","disabled");$("#skuSelect").empty().append("<option value=''>默认sku</option>");
$("#skuSelect").attr("disabled","disabled");var d=c.prodSkuVoList[0];$("#skuCode").val(d.code);$("#skuPrice").val(d.price);$("#skuStatus").val(d.status);
}});},_save:function(){var i=this;var a=$("#id").val();var h=null;if(a!=null&&a!=""){h=ProdService._CONS_.SAVE_EDIT_URL;}else{h=ProdService._CONS_.SAVE_ADD_URL;
}if($("#prodServiceForm").valid()){if($("select[name='type']").val()==="entity"){if(!$("#normalSkuForm").valid()){return;}}ButtonUtils.disableBtn("saveBtn");
var g=new StringBuffer();$("select[name='type']").removeAttr("disabled","disabled");$("#skuSelect").removeAttr("disabled","disabled");g.append($("#"+ProdService._CONS_.EDIT_FORM_ID).serialize());
g.append("&cateId="+i.cateId);g.append("&salesType=always");if($("select[name='type']").val()==="sku_entity"){g.append("&"+i.eavSku.getEavParams());var d=SkuUtils.getSkuJson();
if(d){g.append("&skus="+d);}else{ButtonUtils.enableBtn("saveBtn");return;}}else{var b=$("#skuCode").val();var e=$("#skuPrice").val();var c=$("#skuStatus").val();
var f=[{code:b,price:e,createType:"single",isDefault:"y",status:c,sort:1}];g.append("&skus="+JSON.stringify(f));}FormUtils.submit(h,g.toString(),function(j){ButtonUtils.enableBtn("saveBtn");
if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}i.isEdit=false;i.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("prodService.button.detail")){$(".prodServiceDetail").hide();}if(!ResUtils.canShow("prodService.button.add")){$(".prodServiceAdd").hide();
}if(!ResUtils.canShow("prodService.button.edit")){$(".prodServiceEdit").hide();}if(!ResUtils.canShow("prodService.button.delete")){$(".prodServiceDel").hide();
}},_bindFormValidation:function(){var a={rules:{name:{required:true},key:{required:true}},messages:{}};FormUtils.bindFormValidation(ProdService._CONS_.EDIT_FORM_ID,a);
var b={rules:{skuCode:{required:true},skuPrice:{required:true,number:true}}};FormUtils.bindFormValidation("normalSkuForm",b);},_initJqgrid:function(a){$(ProdService._CONS_.GRID).JTJqgrid({url:ProdService._CONS_.LIST_DATA_URL,pager:ProdService._CONS_.PAGER,postData:a,colNames:["名称","副名称","服务编码","服务类型","销售类型","联系人电话","联系人","企业法人","服务状态","创建时间","操作"],colModel:[{name:"name",index:"name_",width:120},{name:"shortName",index:"short_name_",width:120},{name:"key",width:120,index:"key_",},{name:"type",sortable:false,width:120,formatter:function(b){switch(b){case"entity":return"<label class='label label-primary'>普通服务</label>";
break;case"sku_entity":return"<label class='label label-warning'>多SKU服务</label>";break;}}},{name:"salesType",sortable:false,width:120,formatter:function(b){switch(b){case"stock":return"<label class='label label-primary'>按库存销售</label>";
break;case"always":return"<label class='label label-info'>永远可售</label>";break;}}},{name:"eavMap.contactMob.value",sortable:false,width:120},{name:"eavMap.contact.value",sortable:false,width:120},{name:"eavMap.representative.value",sortable:false,width:120},{name:"status",width:120,sortable:false,formatter:function(b){switch(b){case"on_sale":return"<label class='label label-primary'>上架</label>";
break;case"not_on_sell":return"<label class='label label-danger'>下架</label>";break;case"deleted":return"<label class='label label-danger'>已删除</label>";
break;}}},{name:"createTime",width:120,index:"create_time_",},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}]});
},_getManagerBtns:function(){var a=[];if(canShow("prodService.button.delete")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger prodServiceDel",iconClasses:"fa fa-remove"});
}if(canShow("prodService.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary prodServiceEdit",iconClasses:"fa fa-edit"});}if(canShow("prodService.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary prodServiceDetail",iconClasses:"fa fa-th-list"});
}if(canShow("prodService.button.status")){a.push({switchCol:{colName:"status",colVals:["on_sale","not_on_sell"],colLables:["下架","上架"],btnClasses:["btn btn-primary putOnSaleBtn","btn btn-primary pullOffShelvesBtn"],iconClasses:["fa fa-toggle-on","fa fa-toggle-off"]}});
}return a;},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(ProdService._CONS_.GRID,a);}};