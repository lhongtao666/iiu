$(function(){var a=new ProdEntity();a.init();});function ProdEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this._hadInitJqgrid=false;
this.flag=false;this.eavCommon=null;this.eavSku=null;this.cateId="";this.cateName="";this.reinitCate=0;switch(type){case"product":this.rootKey=ProdEntity._CONS_.PRODUCT_ROOT_CATE_KEY;
break;case"point":this.rootKey=ProdEntity._CONS_.POINT_ROOT_CATE_KEY;break;}this.prodEntitySeries=new ProdEntitySeries("#normalSkuContainer .col-sm-12");
this.seniorSearch=new SeniorSearch();}ProdEntity._CONS_={EDIT_URL:ctx+"/ec/product/prodEntity/edit.htm",DELETE_URL:ctx+"/ec/product/prodEntity/delete.htm",SAVE_ADD_URL:ctx+"/ec/product/prodEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/product/prodEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/product/prodEntity/listData.htm",UPDATE_STATUS_URL:ctx+"/ec/product/prodEntity/updateStatus.htm",CHANGE_CATE_URL:ctx+"/ec/product/prodEntity/changeCate.htm",RECOVER_PROD_URL:ctx+"/ec/product/prodEntity/recover.htm",IMPORT_PROD_EXCEL_URL:ctx+"/ec/product/prodEntity/importExcel.htm",EXPORT_URL:ctx+"/ec/product/prodEntity/export.htm",EDIT_FORM_ID:"prodEntityForm",COMMON_EAV_PARAM:{bizType:"common",entityType:"prod",entityTypeSelectId:"entityTypeSelect",containerId:"eavCommonContainer"},SKU_EAV_PARAM:{bizType:"sku",entityType:"prod",entityTypeSelectId:"skuSelect",containerId:"eavSkuContainer"},TAG_EAV_PARAM:{bizType:"tag",entityType:"cs",eavSetKey:"cs_tag",containerId:"tagContainer"},CREATE_TYPE:{SINGLE:"single",OPTIONS:"options"},DELETE_BY_CATE_URL:ctx+"/ec/product/prodEntity/deleteByCateId.htm",DELETE_PROD_CATE_URL:ctx+"/ec/product/prodEntity/deleteByCateId.htm",INVALID_PROD_URL:ctx+"/ec/product/prodEntity/invalidProdEntity.htm",BATCH_UPDATE:ctx+"/ec/product/prodEntity/batchUpdate.htm",COUNT_LIST_DATA:ctx+"/ec/product/prodEntity/countListData.htm",PRODUCT_ROOT_CATE_KEY:"category",POINT_ROOT_CATE_KEY:"prodPoint",GRID:"#prodEntityGrid",PAGER:"#prodEntityPager"};
ProdEntity.prototype={init:function(c){if(!this.hadInit){this.hadInit=true;this._loadProdCateTree();this._bindFormValidation();this._bindEventHandler();
this.eavCommon=new Eav(ProdEntity._CONS_.COMMON_EAV_PARAM);this.eavSku=new Eav(ProdEntity._CONS_.SKU_EAV_PARAM);this.eavTag=new Eav(ProdEntity._CONS_.TAG_EAV_PARAM);
this.prodEntitySeries.init();var b=$("body").height();var a=b-130+"px";$("#tab-des").css("height",a);$("#tab-des").css("overflow-y","auto");CateUtils.getOptions([{typeKey:"system",pKey:"unit",container:"unitSelect"},{typeKey:"system",pKey:"product_brand",container:"brandSelect",},{typeKey:"system",pKey:"product_sku_spec",container:"specSelect",}]);
this._hideNotGrantBtn();this.seniorSearch.init();this._locateToGlHelp();}},_locateToGlHelp:function(){if(type=="product"){var a="glHelp.prodEntity.prodManage";
}if(status=="delete"){var a="glHelp.prodEntity.prodRecycled";}glHelpUtil.init(a);},_loadProdCateTree:function(){var a=this;var d=true;if(status&&status=="delete"){d=false;
}var c="n";if(type=="point"){c="n";}var b={treeId:"prodEntityCateTree",cateTypeKey:"product_catalog",rootKey:this.rootKey,userId:"",limitProdCate:c,dragAble:ResUtils.canShow("prodEntity.button.drag")?true:false,contextMenu:{add:{isShow:ResUtils.canShow("prodEntity.button.addCate"),title:"添加分类",clickFn:function(e){},clazz:"addAlbumBtn"},update:{isShow:ResUtils.canShow("prodEntity.button.updateCate"),title:"更新分类",clickFn:function(){},clazz:"updateAlbumBtn"},del:{isShow:d&&ResUtils.canShow("prodEntity.button.deleteCate"),title:"删除分类",clickFn:function(e){msgCode.DELETE_TITLE="您确定要删除这个节点吗";
DialogUtils.confirm(function(){FormUtils.submit(ProdEntity._CONS_.DELETE_PROD_CATE_URL,"cateId="+e.id,function(g){if(g.success){var f=$.fn.zTree.getZTreeObj("prodEntityCateTree");
f.removeNode(e);DialogUtils.success(msgCode.SUCCESS,g.msg);}else{DialogUtils.error(msgCode.ERROR,g.msg);}});});},clazz:"deleteAlbumBtn"},},saveFn:function(e){a.cateId=e.id;
a.cateName=e.name;a.reinitCate=1;a.reloadJqgrid();},onClick:function(e){a.seniorSearch.initCrumbs(e,"prodEntityCateTree");a.cateId=e.id;a.cateName=e.name;
if(a._hadInitJqgrid){a.reloadJqgrid();}else{a._hadInitJqgrid=true;a._initJqgrid();}}};ZtreeUtils.init(b);},_hideNotGrantBtn:function(){if(type=="point"){$(".prodEntityAddService").hide();
$(".prodEntityAddCard").hide();$(".prodEntityAddFinance").hide();$("#prodBatchImport").hide();$("#prodBatchExport").hide();$("#exportProdTemplate").hide();
if(status=="delete"){$(".prodEntityDel").hide();$(".prodEntityAdd").hide();$(".prodEntityEdit").hide();$(".prodEntityChangeCate").hide();$(".putOnSaleBtn").hide();
$(".pullOffShelvesBtn").hide();$(".prodCopyBtn").hide();$(".prodEntityBatchUpdate").hide();if(!ResUtils.canShow("prodEntityCol.button.detailPoint")){$(".prodEntityDetail").hide();
}if(!ResUtils.canShow("prodEntityCol.button.recoverPoint")){$(".prodEntityRecover").hide();}if(!ResUtils.canShow("prodEntityCol.button.prodEntityInvalid")){$(".prodEntityInvalid").hide();
}}else{$(".prodEntityRecover").hide();$(".prodEntityInvalid").hide();if(!ResUtils.canShow("prodEntity.button.onSalePoint")){$(".putOnSaleBtn").hide();}if(!ResUtils.canShow("prodEntity.button.notOnSalePoint")){$(".pullOffShelvesBtn").hide();
}if(!ResUtils.canShow("prodEntity.button.detailPoint")){$(".prodEntityDetail").hide();}if(!ResUtils.canShow("prodEntity.button.addPoint")){$(".prodEntityAdd").hide();
}if(!ResUtils.canShow("prodEntity.button.editPoint")){$(".prodEntityEdit").hide();}if(!ResUtils.canShow("prodEntity.button.deletePoint")){$(".prodEntityDel").hide();
}if(!ResUtils.canShow("prodEntity.button.changeCatePoint")){$(".prodEntityChangeCate").hide();}if(!ResUtils.canShow("prodEntity.button.copyPoint")){$(".prodCopyBtn").hide();
}if(!ResUtils.canShow("prodEntityCol.button.batchUpdate")){$(".prodEntityBatchUpdate").hide();}}}else{if(status=="delete"){$("#operateBtnGroup").hide();
$(".prodEntityDel").hide();$(".prodEntityAdd").hide();$(".prodEntityAddService").hide();$(".prodEntityAddCard").hide();$(".prodEntityAddFinance").hide();
$(".prodEntityEdit").hide();$(".prodEntityChangeCate").hide();$(".putOnSaleBtn").hide();$(".pullOffShelvesBtn").hide();$("button.prodCopyBtn").hide();$(".prodEntityBatchUpdate").hide();
$("#prodBatchImport").hide();$("#prodBatchExport").hide();$("#exportProdTemplate").hide();if(!ResUtils.canShow("prodEntityCol.button.detail")){$(".prodEntityDetail").hide();
}if(!ResUtils.canShow("prodEntityCol.button.recover")){$(".prodEntityRecover").hide();}if(!ResUtils.canShow("prodEntityCol.button.prodEntityInvalid")){$(".prodEntityInvalid").hide();
}}else{$(".prodEntityRecover").hide();$(".prodEntityInvalid").hide();if(!ResUtils.canShow("prodEntity.button.onSale")){$(".putOnSaleBtn").hide();}if(!ResUtils.canShow("prodEntity.button.notOnSale")){$(".pullOffShelvesBtn").hide();
}if(!ResUtils.canShow("prodEntity.button.detail")){$(".prodEntityDetail").hide();}if(!ResUtils.canShow("prodEntity.button.add")){$(".prodEntityAdd").hide();
}if(!ResUtils.canShow("prodEntity.button.prodEntityAddService")){$(".prodEntityAddService").hide();}if(!ResUtils.canShow("prodEntity.button.prodEntityAddCard")){$(".prodEntityAddCard").hide();
}if(!ResUtils.canShow("prodEntity.button.prodEntityAddFinance")){$(".prodEntityAddFinance").hide();}if(!ResUtils.canShow("prodEntity.button.edit")){$(".prodEntityEdit").hide();
}if(!ResUtils.canShow("prodEntity.button.delete")){$(".prodEntityDel").hide();}if(!ResUtils.canShow("prodEntity.button.changeCate")){$(".prodEntityChangeCate").hide();
}if(!ResUtils.canShow("prodEntity.button.copy")){$(".prodCopyBtn").hide();}if(!ResUtils.canShow("prodEntityCol.button.batchUpdate")){$(".prodEntityBatchUpdate").hide();
}if(!ResUtils.canShow("prodEntity.button.prodImport")){$("#exportProdTemplate").hide();}if(!ResUtils.canShow("prodEntity.button.exportProd")){$("#prodBatchImport").hide();
}if(!ResUtils.canShow("prodEntity.button.export")){$("#prodBatchExport").hide();}}}},clear:function(c){var a=this;function b(){FormUtils.enableForm(ProdEntity._CONS_.EDIT_FORM_ID);
FormUtils.clear(ProdEntity._CONS_.EDIT_FORM_ID);FormUtils.enableForm(ProdEntity._CONS_.EDIT_FORM_ID+"-prodType");FormUtils.clear(ProdEntity._CONS_.EDIT_FORM_ID+"-prodType");
a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;a.prodEntitySeries.clear();a.eavCommon.setEntityId("");a.eavSku.setEntityId("");a.eavCommon.clear();
a.eavSku.clear();$("#imageContainer").empty();$("#imageContainer").empty();$("#commonImageContainer").empty();$("#cateContainer").empty();$("#summary").val("");
$("#normalSkuContainer").show();$("#multiSkuContainer").hide();$("#skuImageContainer").hide();$("#skuPrice").val("");$("#skuCode").val("");$("#prodCode").val("");
$("#barCode").val("");$("#skuShortName").val("");$("#startStock").val("");$("#bizPrice").val("");$("#startStore").parent("td").hide();$("[name=startStock]").attr("readonly",false);
$("[name=bizPrice]").attr("readonly",false);$("button.prodStockBtn").attr("skuId","");$("button.saveBtn").show();$("select[name='type']").removeAttr("disabled");
$("#skuSelect").empty();$("#skuSelect").append("<option value='default'>默认sku</option>");$("#skuSelect").attr("disabled","disabled");tinyMCE.activeEditor.setContent("");
$("#fileContainer").empty();$("#skuContainer").empty();$(".tabs-container li").removeClass("active");$(".tabs-container li").eq(0).addClass("active");$(".tabs-container .tab-content .tab-pane").removeClass("active");
$(".tabs-container .tab-content .tab-pane").eq(0).addClass("active");$("#selectCommonImageBtn").show();$("#addFileBtn").show();$("#addCateBtn").show();
$("button.selectMainImageBtn").show();$("button.selectOtherImageBtn").show();$("#createSkuBtn").show();$("#skuStatCountContainer").empty();$("#prod-total-number").text("0");
$("#prod-total-money").text("0.00");$("#prod-month-number").text("0");$("#prod-month-money").text("0.00");if(c){$(".prodEntitySearch").trigger("click");
}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".form-layer").stop().animate({"left":"110%","opacity":0},500);
},_showFormWrapper:function(){$(".form-layer").stop().animate({"left":0,"opacity":1},500);this._initDesc();$(".form-layer").scrollTop(0);},_initDesc:function(){$(".note-editor").show();
tinyMCE.activeEditor.setContent("");},_switchToBizType:function(a){var c=new StringBuffer();var b=new StringBuffer();b.append("<tr>");b.append("<td>sku型号(最多20字)<span style='color: red;'>*</span></td>");
if(type=="product"){b.append("<td>价格<span style='color: red;'>*</span></td>");if(a=="finance"){c.append("<option value=''>请选择</option>");c.append("<option value='finance'>金融产品</option>");
}else{c.append("<option value='entity'>普通商品</option>");c.append("<option value='sku_entity'>多sku商品</option>");}}else{c.append("<option value='pointNormal' selected='selected'>普通积分商品</option>");
c.append("<option value='pointSku'>多sku积分商品</option>");b.append("<td>积分数量<span style='color: red;'>*</span></td>");}b.append("<td>规格</td>");b.append("<td style='min-width:67px;'>状态<span style='color: red;'>*</span></td>");
b.append("<td style='min-width:30px;'>每单限制<label><a style='margin-left:10px' title='该商品每单最多能售卖多少个'><img src='/t9-ecm/img/jt/help.png'></a></label></td>");
b.append("<td style='min-width:30px;'>sku折扣限制<label><a style='margin-left:10px' title='该商品允许的最低折扣，存在部门折扣时以两者中低的为准'><img src='/t9-ecm/img/jt/help.png'></a></label></td>");
b.append("<td class='shortNameTd'>报表简称(最多20字)<span style='color: red;'>*</span></td>");b.append("<td class='prodCodeTd'>产品代码</td>");b.append("<td class='barCodeTd' style='display:none;'>条形码</td>");
b.append("<td>初始库存</td>");b.append("<td>采购价</td>");if($('input[name="id"]').val()){b.append("<td style='min-width:100px;'>操作</td>");}else{b.append('<td style="min-width:100px;">仓库</td>');
StoreUtils.loadSimpleStores({container:"startStore",useDefaultOpt:true,});}$("select[name='type']").empty().append(c.toString());b.append("</tr>");$("#headerContainer").empty().append(b.toString());
},_add:function(a){this.prodEntitySeries.init();this._showFormWrapper();this._switchToBizType(a);this.eavCommon.getEavSetList();this.eavTag.setEntityId("");
this.eavTag.renderEavForm(function(){$("#tagContainer").find("legend").remove();});$("#salesType").val("stock");tinyMCE.activeEditor.setContent("");$("[name=unit]").val(["盒"]);
$("[name=saleRange]").val(["all"]);$("[name=qualityPeriodVal]").val("24");$("[name=qualityPeriodUnit]").val(["m"]);$("#cateId").val(this.cateId);$("#cateName").val(this.cateName);
$("select[name='salesType'] option[value='stock']").attr("selected","selected");$("button.prodStockBtn").parent("td").hide();$("#startStore").parent("td").show();
$("#prodType").val(a);if(a&&a=="finance"){$("#entityTypeSelect").rules("remove");$("[name=unit]").val("单");$(".addFinanceShow").show();$(".addFinanceHide").hide();
}else{if(a=="service"||a=="card"){$(".addProdShow").hide();$(".addFinanceShow").hide();$("#unitSelect").rules("remove");$("#qualityPeriodVal").rules("remove");
$("#qualityPeriodUnit").rules("remove");}else{$(".addFinanceShow").hide();$(".addProdShow").show();$("#unitSelect").rules("add",{required:true});$("#qualityPeriodVal").rules("add",{required:true,digits:true,min:1});
$("#qualityPeriodUnit").rules("add",{required:true});}}},_edit:function(d,a){this._showFormWrapper();this.edit=true;var c=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",d);
var b=c["type"];if(b=="finance"){$(".addFinanceShow").show();$(".addFinanceHide").hide();}else{if(b=="service"||b=="card"){$(".addProdShow").hide();$(".addFinanceShow").hide();
}else{$(".addFinanceShow").hide();$(".addProdShow").show();}}this._loadData(d,false,a);$("button.prodStockBtn").parent("td").show();},_detail:function(c){this._showFormWrapper();
this._loadData(c,true);var b=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",c);var a=b["type"];if(a=="finance"){$(".addFinanceShow").show();$(".addFinanceHide").hide();
}else{if(a=="service"||a=="card"){$(".addProdShow").hide();$(".addFinanceShow").hide();}else{$(".addFinanceShow").hide();$(".addProdShow").show();}}$("button.saveBtn").hide();
FormUtils.disableForm(ProdEntity._CONS_.EDIT_FORM_ID);$("button.prodStockBtn").parent("td").show();},_loadData:function(e,c,a,d){var b=this;if(a){}else{}FormUtils.loadData(ProdEntity._CONS_.EDIT_URL+"?id="+e,function(g){$("#id").val(a?"":g.id);
$("#name").val(g.name);$("#key").val(a?"":g.key);$("#summary").val(g.summary);$("input[name=desc]").val(g.desc);$("input[name=markdownDesc]").val(g.markdownDesc);
$("input[name=descType]").val(g.descType);$("#salesType").val(g.salesType);$("#salesType").val(g.salesType);$("#shortName").val(g.shortName);$("#cateId").val(g.cateId);
$("#cateName").val(g.cate);$("#qualityPeriodVal").val(g.qualityPeriodVal);$("#qualityPeriodUnit").val(g.qualityPeriodUnit);$("#qualityPeriod").val(g.qualityPeriod);
b._switchToBizType(d);$("select[name='type']").val(g.type);$("select[name='type']").attr("disabled","disabled");$("#createBy").val(g.createBy);$("#createTime").val(g.createTime);
$("#priceType").val(g.priceType);$("[name=saleRange]").val(g.saleRange);$("[name=brand]").val(g.brand);$("[name=isSeries]").val(g.isSeries).trigger("change");
tinyMCE.activeEditor.setContent(g.desc);$("[name=unit]").val([g.unit]);$("[name=figure]").val([g.figure]);if(g.type==="sku_entity"||g.type==="pointSku"){if(g.eavKeyMap.sku){$("#multiSkuContainer").show();
$("#skuImageContainer").show();$("#normalSkuContainer").hide();$("#skuSelect").attr("disabled","disabled");b.eavSku.setEntityId(g.id);b.eavSku.getEavSetList(g.eavKeyMap.sku);
b.eavSku.setEavSetKey(g.eavKeyMap.sku);b.eavSku.renderEavForm(function(){$("#eavSkuContainer").find("legend").remove();SkuUtils.recoverSkuTable(g.prodSkuPoList);
b._createImageTable();ProdImageUtils.createImages(g.prodImgPoList);if(c){$(".selectMainImageBtn").hide();$(".selectOtherImageBtn").hide();$("#eavSkuContainer").find("input[type='checkbox']").attr("disabled","disabled");
$("#skuContainer").find("table tr").each(function(){$(this).find("th:last").remove();$(this).find("td:last").remove();});var j=$("#normalSkuForm");j.find("input,select").attr("disabled","disabled");
$("#commonImageContainer").find("img.deleteImage").remove();var i=$("#skuContainer");i.find("input,select").attr("disabled","disabled");}$("#priceType").trigger("click");
SkuUtils.emptySkuCode(a);});}}else{$("#skuSelect").attr("disabled","disabled");$("#skuSelect").empty().append("<option value='default'>默认sku</option>");
$("#skuSelect").attr("disabled","disabled");if(g.prodSkuPoList&&g.prodSkuPoList.length){var f=g.prodSkuPoList[0];var h={prodId:e,skuId:f.id,isSeries:g.isSeries,};
b.prodEntitySeries.init(h);$("#skuCode").val(f.code);$("#prodCode").val(f.prodCode);$("#barCode").val(f.barCode);$("#skuPrice").val(f.price);$("#skuStatus").val(f.status);
if(f.buyLimit){$("#buyLimit").val(f.buyLimit);}else{$("#buyLimit").val("");}if(f.skuPercentLimit){$("#skuPercentLimit").val(f.skuPercentLimit);}else{$("#skuPercentLimit").val("");
}$("#skuShortName").val(f.shortName);$("[name=startStock]").val(f.startStock).attr("readonly",a?false:true);$("[name=bizPrice]").val(f.bizPrice).attr("readonly",a?false:true);
$("[name=spec]").val(f.spec);if(a){$("button.prodStockBtn").parent("td").hide();$("#startStore").parent("td").show();}else{$("button.prodStockBtn").attr("skuId",f.skuId);
}}ProdImageUtils.createImages(g.prodImgPoList);if(c){$("#commonImageContainer").find("img.deleteImage").remove();}$("#priceType").trigger("click");SkuUtils.emptySkuCode(a);
}b.eavCommon.setEntityId(g.id);b.eavCommon.getEavSetList(g.eavKeyMap.common);b.eavCommon.setEavSetKey(g.eavKeyMap.common);b.eavCommon.renderEavForm(function(){if(c){var i=$("#eavCommonContainer");
i.find(".selectImageBtn").hide();i.find(".selectSystemFile ").hide();i.find("input").attr("disabled","disabled");i.find("select").attr("disabled","disabled");
i.find("textarea").attr("disabled","disabled");}});b.eavTag.setEntityId(g.id);b.eavTag.renderEavForm(function(){$("#tagContainer").find("legend").remove();
if(c){$("#tagContainer").find("input[type='checkbox']").attr("disabled","disabled");}});ProdFileUtils.createFiles(g.prodFilePoList);$("#fileContainer").find("img.deleteFile").remove();
ProdCateUtils.createCates(g.prodCatePoList);if(c){$("#addFileBtn").hide();$("#addCateBtn").hide();$("#createSkuBtn").hide();$("#selectCommonImageBtn").hide();
$("#summary").attr("disabled","disabled");tinymce.EditorManager.execCommand("mceRemoveEditor",true,"tinyMceContent");}if(g.type!="sku_entity"&&g.type!="pointSku"){}});
},_buildRow:function(a){var b=new StringBuffer();b.append("<tr>");b.append('<td class="td">');b.append(a.skuCode);b.append("</td>");b.append(' <td class="td">');
b.append(a.skuName);b.append("</td>");b.append(' <td class="td">');b.append(a.totalMoney);b.append("</td>");b.append('<td class="td">');b.append(a.totalCount);
b.append("</td>");b.append("</tr>");return b.toString();},_buildSkuRow:function(c){var a="";var b=0;switch(c.type){case"sku_total_money":a="销售金额";b=c.total.toFixed(2);
break;case"sku_month_money":a="月销售金额";b=c.total.toFixed(2);break;case"sku_total_number":a="销售数量";b=c.total.toFixed(0);break;case"sku_month_number":a="月销售数量";
b=c.total.toFixed(0);break;}if(a==="月销售金额"||a==="月销售数量"){return;}var d=new StringBuffer();d.append("<tr>");d.append('<td class="td">');d.append(c.skuCode);
d.append("</td>");d.append(' <td class="td">');d.append(c.skuName);d.append("</td>");d.append(' <td class="td">');d.append(a);d.append("</td>");d.append('<td class="td">');
d.append(b);d.append("</td>");d.append("</tr>");return d.toString();},_validateMultipleForm:function(){var a=this;$(".nav.nav-tabs li").eq(0).find("a").trigger("click");
if(!$("#prodEntityForm").valid()||!$("#normalSkuForm").valid()||!$("#prodEntityForm-prodType").valid()){return false;}if(!(typeof($("#skuContainer").html())=="undefined")&&$("#skuContainer").html().trim().length>0){if(!$("#skuContainer form").valid()){return false;
}}if("sku_entity"==$("[name=type]").val()&&"y"==$("[name=isSeries]").val()){DialogUtils.error(msgCode.ERROR,"套装目前只支持普通商品");return false;}$(".nav.nav-tabs li").eq(1).find("a").trigger("click");
if(!SkuUtils.isValid()){return false;}if($("#prodType").val()&&$("#prodType").val()!="service"&&$("#prodType").val()!="card"){$(".nav.nav-tabs li").eq(2).find("a").trigger("click");
if(!a.eavCommon.isValid()){DialogUtils.error(msgCode.ERROR,"请检查扩展信息界面的数据");return false;}}if(!a.prodEntitySeries.isValid()){DialogUtils.error(msgCode.ERROR,"请检查套装数据");
return false;}return true;},_save:function(){var m=this;if(!m._validateMultipleForm()){return;}var a=$("#id").val();var k=null;if(a!=null&&a!=""){k=ProdEntity._CONS_.SAVE_EDIT_URL;
}else{k=ProdEntity._CONS_.SAVE_ADD_URL;}$("#entityTypeSelect").removeAttr("disabled");var e=$("#entityTypeSelect").val();$("select[name='type']").removeAttr("disabled");
$("#skuSelect").removeAttr("disabled");var j=$("[name=qualityPeriodVal]").val();var c=$("[name=qualityPeriodUnit]").val();$("[name=qualityPeriod]").val(j+""+c);
ButtonUtils.disableBtn("saveBtn");var h=$("#summary").val();var b=$("#prodType").val();if(b){$("select[name='type'] option[selected='selected']").removeAttr("selected");
$("select[name='type']").find("option[value='"+b+"']").attr("selected",true);}var g="";var d="";var f=$("[name=descType]").val();if(f&&"markdown"==f){g=$(".editormd-html-textarea").text();
d=$(".editormd-markdown-textarea").text();if(d){var l=new RegExp(g,"g");d=d.replace(l,"");}}else{g=tinyMCE.activeEditor.getContent();}var i=new StringBuffer();
i.append($("#"+ProdEntity._CONS_.EDIT_FORM_ID).serialize());i.append("&"+$("#"+ProdEntity._CONS_.EDIT_FORM_ID+"-prodType").serialize());i.append("&desc="+g);
i.append("&markdownDesc="+d);i.append("&descType="+f);i.append("&entityType="+e);i.append("&summary="+h);i.append("&"+m.eavCommon.getEavParams());i.append("&"+m.eavTag.getEavParams());
if($("select[name='type']").val()=="sku_entity"||$("select[name='type']").val()=="pointSku"){i.append("&"+m.eavSku.getEavParams());}i.append("&"+ProdCateUtils.getCateJson());
i.append("&skus="+SkuUtils.getSkuJson());i.append("&"+ProdFileUtils.getFiles());i.append("&"+ProdImageUtils.getImages());i.append("&"+m.prodEntitySeries.getForm());
FormUtils.submit(k,i.toString(),function(p){ButtonUtils.enableBtn("saveBtn");if(p.success){if(p.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(p.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}m.isEdit=false;m.clear(true);}else{var q=JSON.parse(p.msg);
var o="";for(var n in q){o+=q[n]+",";}o=o.substring(0,o.length-1);DialogUtils.error(msgCode.FAIL_MSG,o);$(".nav.nav-tabs li:eq(1) a").trigger("click");
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(ProdEntity._CONS_.DELETE_URL,b,function(c){if(c.success){a.reloadJqgrid();
DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_invalidProd:function(b){var a=this;var c={title:"确定彻底删除商品吗?",text:"彻底删除商品无法恢复,商品编码将释放",cancelButtonText:"取消",confirmButtonText:"确定",isNeedAutoClose:true,yesFunc:function(){FormUtils.submit(ProdEntity._CONS_.INVALID_PROD_URL,{ids:b},function(d){if(d.success){a.reloadJqgrid();
DialogUtils.success(msgCode.INFO,d.msg);}else{DialogUtils.error("失败",d.msg);}},function(){DialogUtils.error("错误","后台异常，请稍后重试");});}};DialogUtils.confirmWithOptions(c);
},_recoverProd:function(b){var a=this;FormUtils.submit(ProdEntity._CONS_.RECOVER_PROD_URL,{ids:b},function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,"复原成功");
a.reloadJqgrid();}else{DialogUtils.error(msgCode.FAIL,"失败");}});},_updateStatus:function(a,b){var c=this;FormUtils.submit(ProdEntity._CONS_.UPDATE_STATUS_URL,{prodEntityIds:a,status:b},function(d){if(d.success){if(b==="no_sale"){DialogUtils.success(msgCode.INFO,"上架成功");
}else{if(d.msg==="not_on_sale"){DialogUtils.success(msgCode.INFO,"下架成功");}}$(".prodEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL,"失败");
}});},_changeCate:function(c){if(jQuery.isArray(c)){c=c.join(",");}var a=this;var b={isMultiple:0,typeKey:"product_catalog",pKey:"category",selectedCateIds:c,fn:function(d){if(d.length>0){FormUtils.submit(ProdEntity._CONS_.CHANGE_CATE_URL,{cateId:d[0].id,ids:c},function(e){if(e.success){a.reloadJqgrid();
DialogUtils.success(msgCode.INFO,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
}}};if(type=="point"){b.pKey="prodPoint";}CateUtils.selectCate(b);},_createImageTable:function(){$("#skuImageContainer").show();var b=[];$("#eavSkuContainer").find("input[isMainAttr='y']").each(function(){if($(this).is(":checked")){var d={label:$(this).next().text(),value:$(this).val()};
b.push(d);}});var c=new StringBuffer();for(var a=0;a<b.length;a++){c.append("<tr optVal='"+b[a].value+"'>");c.append("<td>");c.append(b[a].label);c.append("</td>");
c.append("<td></td>");c.append("<td>");c.append("<button type='button' class='btn btn-primary selectMainImageBtn'>选择图片</button>");c.append("</td>");c.append("<td></td>");
c.append("<td>");c.append("<button type='button' class='btn btn-primary selectOtherImageBtn'>选择图片</button>");c.append("</td>");c.append("</tr>");}$("#imageContainer").empty().append(c.toString());
},_bindEventHandler:function(){$(window).resize(function(){var c=$("body").height();var b=c-130+"px";$("#tab-des").css("height",b);$("#tab-des").css("overflow-y","auto");
});var a=this;if($(".note-editable.panel-body").find("p").html()){$(".note-editable.panel-body").css("mix-height","200px");}ProdFileUtils.bindEventHanlder();
ProdImageUtils.bindEventHanlder();ProdCateUtils.bindEventHanlder();SkuUtils.bindEventHandler();$(window).resize(function(){var b=$(window).height();var c=b-400+"px";
$(".note-editable.panel-body").css("max-height",c);});$("body").on("click",".prodEntityBatchUpdate",function(){var f="";var c=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c&&c.length>0){var d=null;var e=null;if($.isArray(c)){d=c.join(",");e=c.length;}else{d=c;e=1;}f="prodEntityIds="+d;$("#batchUpdateModalLabel").html("批量修改&emsp;<span>您正在对<font style='color:red;'>【"+e+"个】</font>个商品进行批量修改操作。<font style='color:red;'>提示：只有勾选才有效</font><span>");
}else{f=$("#prodEntitySearchForm").serialize();if(f){if($.type(f)=="string"){if(status){f+="&Q__S__EQ__prod.status_="+status;}f+="&Q__S__EQ__prod.cate_id_="+a.cateId;
}else{f["Q__S__EQ__prod.status_"]=status;f["Q__S__EQ__prod.cate_id_"]=a.cateId;}}else{f={};f["Q__S__EQ__prod.status_"]=status;f["Q__S__EQ__prod.cate_id_"]=a.cateId;
}FormUtils.loadData(ProdEntity._CONS_.COUNT_LIST_DATA+"?"+f,function(g){$("#batchUpdateModalLabel").html("批量修改&emsp;<span>您正在对<font style='color:red;'>【"+g.msg+"个】</font>个商品进行批量修改操作。<font style='color:red;'>提示：只有勾选才有效</font><span>");
});}$("#batchUpdateContainer").modal("show");var b=new ProdEntityBatchUpdate();b.init(f);});$("body").on("click",".prodEntityPreview",function(){var c=$(this).attr("idVal"),b,d,e;
if(!c){c=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要预览的商品");return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.ERROR,"不可以同时预览多个商品");
return;}}}b=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",c);d=e=$(b.name).text();if(d&&d.length>5){e=d.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodEntityId="+c,"商品【"+e+"】",d);
});$("#prodEntityForm").on("click","input[name=cateName]",function(){var b={isMultiple:0,typeKey:"product_catalog",selectedCateIds:$("input[name='cateId']").val(),pKey:"category",reinit:a.reinitCate,container:"cateName",fn:function(c){$('input[name="cateId"]').val(c);
a.reinit=0;}};if(type=="point"){b.pKey="prodPoint";}CateUtils.selectCateTreeBox(b);});$(".tabs-container").on("click"," ul li",function(b){if(!$("#prodEntityForm-prodType").valid()){b.stopPropagation();
}});$("a[href=#tab-skuInfo]").parent().on("click",function(){$("[id*=tooltip]").css("display","none");});$("a[href=#tab-baseInfo]").parent().on("click",function(){$("[id*=tooltip]").css("display","none");
});$("a[href=#tab-extendInfo]").parent().on("click",function(){$("[id*=tooltip]").css("display","none");});$("#createSkuBtn").on("click",function(){SkuUtils._createSkuTable();
a._createImageTable();a._getSkuSpecOption();});$(".prodEntityChangeCate").on("click",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要移动分类的商品");return;}}a._changeCate(b);});$("body").on("click",".prodEntityRecover",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要复原的商品");
return;}}a._recoverProd(b);});$(document).on("click",".putOnSaleBtn",function(d){d.stopPropagation();var g=$(this).attr("idVal");if(!g){g=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(g==null||g.length==0){DialogUtils.error(msgCode.error,"请选择要上架的商品");return;}var f=false;for(var b=0;b<g.length;b++){var c=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",g[b]);
if(c.status.indexOf("下架")!=-1){f=true;break;}}if(!f){$(".putOnSaleBtn").attr("disabled","disabled");return;}else{$(".putOnSaleBtn").removeAttr("disabled");
}}a._updateStatus(g,"on_sale");});$(document).on("click",".pullOffShelvesBtn",function(f){f.stopPropagation();var g=$(this).attr("idVal");if(!g){g=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(g==null||g.length==0){DialogUtils.error(msgCode.error,"请选择要下架的商品");return;}var b=false;for(var c=0;c<g.length;c++){var d=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",g[c]);
if(d.status.indexOf("上架")!=-1){b=true;break;}}if(!b){$(".pullOffShelvesBtn").attr("disabled","disabled");return;}else{$(".pullOffShelvesBtn").removeAttr("disabled");
}}a._updateStatus(g,"not_on_sale");});$("select[name='type']").on("change",function(){var b=$(this).val();if(b==="sku_entity"){$("#skuSelect").removeAttr("disabled");
$("#multiSkuContainer").show();$("#normalSkuContainer").hide();a.eavSku.getEavSetList();}else{if(b==="entity"){$("#skuSelect").empty();$("#skuSelect").append("<option value='default'>默认sku</option>");
$("#skuSelect").attr("disabled","disabled");$("#normalSkuContainer").show();$("#multiSkuContainer").hide();$("#skuImageContainer").hide();}else{if(b=="pointNormal"){$("#skuSelect").empty();
$("#skuSelect").append("<option value='default'>默认sku</option>");$("#skuSelect").attr("disabled","disabled");$("#normalSkuContainer").show();$("#multiSkuContainer").hide();
$("#skuImageContainer").hide();}else{if(b=="pointSku"){$("#skuSelect").removeAttr("disabled");$("#multiSkuContainer").show();$("#normalSkuContainer").hide();
a.eavSku.getEavSetList();}}}}});$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){var b=$("#startStock").val();
var c=$("#startStore").val();if(b!=""){if(c!=""){a._save();}else{ButtonUtils.enableBtn("saveBtn");DialogUtils.error("请选择仓库",msgCode.ERROR_MSG);return;}}else{a._save();
}});$("#"+ProdEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+ProdEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+ProdEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(document).on("click",".prodEntitySearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#prodEntitySearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);
return false;}});$("#clearSearch").on("click",function(){$("#prodEntitySearchForm").find("input").val("");$("#prodEntitySearchForm").find("select").val("");
});$("body").on("click",".prodEntityAdd",function(){a._add();});$("body").on("click",".prodEntityAddCard",function(){a._add("card");});$("body").on("click",".prodEntityAddService",function(){a._add("service");
});$("body").on("click",".prodEntityAddFinance",function(){a._add("finance");});$("body").on("click",".prodEntityEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);$(ProdEntity._CONS_.GRID).trigger("reloadGrid");
});$("body").on("click",".prodEntityDel",function(){var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".prodEntityInvalid",function(){var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._invalidProd(b);});$("body").on("click",".prodEntityDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);$(ProdEntity._CONS_.GRID).trigger("reloadGrid");
});$("body").on("click","#priceType",function(){var b=$(this).val();SkuUtils.setPrice(b);});$("body").on("click",".prodCopyBtn",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要复制的商品");
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,"不能同时复制多个商品");return;}}}a._edit(b,true);$(ProdEntity._CONS_.GRID).trigger("reloadGrid");
});$("#prodEntityCateTreeSearch").on("keyup",function(b){if(b.keyCode==13){a._searchNode(b);a._callNumber();}});$("#clickUp").on("click",function(){a._clickUp();
});$("#clickDown").on("click",function(){a._clickDown();});$("body").on("click",".baiduBtn",function(){$(".note-editor").show();$(".baiduBtn").attr("disabled",true);
$("#markdownDescContainer").hide();$(".markdownBtn").attr("disabled",false);$("[name=descType]").val("baidu");var b=$("[name=desc]").val();tinyMCE.activeEditor.setContent(b);
});$("body").on("click",".markdownBtn",function(){$(".note-editor").hide();$(".baiduBtn").attr("disabled",false);$("#markdownDescContainer").show();$(".markdownBtn").attr("disabled",true);
$("[name=descType]").val("markdown");a._initEditMd();});$("body").on("click","#exportProdTemplate",function(){window.location.href=ctx+"/gl/mc/moduleColumn/genExcelByModule.htm?moduleType=prod&moduleText=商品";
});$("body").on("click","#prodBatchImport",function(){var b={"importUrl":ProdEntity._CONS_.IMPORT_PROD_EXCEL_URL,"tabTitle":"导入商品excel数据"};excelUtil.importExcel(b);
});$("body").on("click","#prodBatchExport",function(){var c=$("#prodEntitySearchForm").serialize();if(c){if($.type(c)=="string"){if(status){c+="&Q__S__EQ__prod.status_="+status;
}c+="&Q__S__EQ__prod.cate_id_="+a.cateId;}else{c["Q__S__EQ__prod.status_"]=status;c["Q__S__EQ__prod.cate_id_"]=a.cateId;}}else{c={};c["Q__S__EQ__prod.status_"]=status;
c["Q__S__EQ__prod.cate_id_"]=a.cateId;}var b=ProdEntity._CONS_.EXPORT_URL+"?"+c;FormUtils.loadData(b,function(d){if(d.success){DialogUtils.success("成功",d.msg);
}else{DialogUtils.error("错误",d.msg);}});});},_initEditMd:function(){$("#markdownDescContainer").html("");var a=editormd("markdownDescContainer",{width:"100%",height:740,path:ctx+"/plugins/editorMd/lib/",markdown:"",codeFold:true,saveHTMLToTextarea:true,searchReplace:true,htmlDecode:"style,script,iframe|on*",emoji:true,taskList:true,tocm:true,tex:true,flowChart:true,sequenceDiagram:true,imageUpload:true,imageFormats:["jpg","jpeg","gif","png","bmp","webp"],imageUploadURL:"./php/upload.php",onload:function(){this.setMarkdown($("[name=markdownDesc]").val());
}});},_getSkuSpecOption:function(){var a=ctx+"/gl/cate/cate/getOptions.htm";a=a+"?typeKey="+options.typeKey+"&pKey="+options.pKey;FormUtils.loadData(a,function(b){window.sessionStorage.setItem(key,JSON.stringify(b));
_buildOpt(options,b,selectEle);});},_searchNode:function(d){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");var c=$.trim($("#prodEntityCateTreeSearch").val());
var b="name";if(this.lastValue===c){return;}this.lastValue=c;this._updateNodes(true,this.nodeList);if(c!=""){this.nodeList=a.getNodesByParamFuzzy(b,c);
this._updateNodes(true,this.nodeList);}else{this.nodeList=[];}},_updateNodes:function(b,d){var c=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(d){for(var e=0,a=d.length;
e<a;e++){d[e].highlight=b;if(b){c.expandNode(d[e].getParentNode(),true,false,false);}c.updateNode(d[e]);}}},_callNumber:function(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");
if(this.nodeList.length){a.selectNode(this.nodeList[0],false);this.clickCount=1;document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
}else{if(this.nodeList.length==0){document.getElementById("number").innerHTML="[0/0]";a.cancelSelectedNode();}}if($.trim($("#prodEntityCateTreeSearch").val())==""){document.getElementById("number").innerHTML="";
a.cancelSelectedNode();}},_clickUp:function(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");
return;}else{if(this.clickCount==1){DialogUtils.error(msgCode.FAIL_MSG,"您已位于第一条记录上！");return;}else{this.clickCount--;a.selectNode(this.nodeList[this.clickCount-1],false);
}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";},_clickDown:function clickDown(){var a=$.fn.zTree.getZTreeObj("prodEntityCateTree");
if(this.nodeList.length==0){DialogUtils.error(msgCode.FAIL_MSG,"没有搜索结果！");return;}else{if(this.nodeList.length==this.clickCount){DialogUtils.error(msgCode.FAIL_MSG,"您已位于最后一条记录上！");
return;}else{a.selectNode(this.nodeList[this.clickCount],false);this.clickCount++;}}document.getElementById("number").innerHTML="["+this.clickCount+"/"+this.nodeList.length+"]";
},_bindFormValidation:function(){var a={rules:{name:{required:true},barcodes:{required:true},key:{required:true},shortName:{required:true},saleRange:{required:true,},type:{required:true},skuSelect:{required:true},figure:{required:true,digits:true,min:1}},messages:{qualityPeriodVal:{digits:"请输入正整数",},figure:{digits:"请输入正整数",min:"请输入大于1的正整数"}}};
FormUtils.bindFormValidation(ProdEntity._CONS_.EDIT_FORM_ID+"-prodType",a);FormUtils.bindFormValidation(ProdEntity._CONS_.EDIT_FORM_ID,a);SkuUtils.bindFormValidation();
},reloadJqgrid:function(a){if(a){if($.type(a)=="string"){if(status){a+="&Q__S__EQ__prod.status_="+status;}a+="&Q__S__EQ__prod.cate_id_="+this.cateId;}else{a["Q__S__EQ__prod.status_"]=status;
a["Q__S__EQ__prod.cate_id_"]=this.cateId;}}else{a={};a["Q__S__EQ__prod.status_"]=status;a["Q__S__EQ__prod.cate_id_"]=this.cateId;}JTJqgridUtils.reloadJqgrid(ProdEntity._CONS_.GRID,a);
},_getManagerBtns:function(){var a=[];if(type=="point"){if(status=="delete"){if(ResUtils.canShow("prodEntityCol.button.recoverPoint")){a.push({lable:"复原",btnClasses:"btn btn-warning prodEntityRecover",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("prodEntityCol.button.detailPoint")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary prodEntityDetail",iconClasses:"fa fa-th-list"});
}a.push({lable:"预览",btnClasses:"btn btn-primary prodEntityPreview",iconClasses:"fa fa-edit"});if(ResUtils.canShow("prodEntityCol.button.prodEntityInvalid")){a.push({lable:"彻底删除",btnClasses:"btn btn-danger prodEntityInvalid",iconClasses:"fa fa-edit"});
}}else{if(ResUtils.canShow("prodEntity.button.editPoint")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary prodEntityEdit",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("prodEntity.button.detailPoint")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary prodEntityDetail",iconClasses:"fa fa-th-list"});
}a.push({lable:"预览",btnClasses:"btn btn-primary prodEntityPreview",iconClasses:"fa fa-edit"});if(ResUtils.canShow("prodEntity.button.onSalePoint")||ResUtils.canShow("prodEntity.button.notOnSalePoint")){var b={colName:"status",colVals:[],colLables:[],btnClasses:[],iconClasses:[]};
if(ResUtils.canShow("prodEntity.button.notOnSalePoint")){b.colVals.push("on_sale");b.colLables.push("下架");b.btnClasses.push("btn btn-danger pullOffShelvesBtn");
b.iconClasses.push("fa fa-toggle-off");}if(ResUtils.canShow("prodEntity.button.onSalePoint")){b.colVals.push("not_on_sale");b.colLables.push("上架");b.btnClasses.push("btn btn-primary putOnSaleBtn");
b.iconClasses.push("fa fa-toggle-on");}a.push({switchCol:b});}if(ResUtils.canShow("prodEntity.button.deletePoint")){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger prodEntityDel",iconClasses:"fa fa-remove"});
}}}else{if(status=="delete"){if(ResUtils.canShow("prodEntityCol.button.recover")){a.push({lable:"复原",btnClasses:"btn btn-warning prodEntityRecover",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("prodEntityCol.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary prodEntityDetail",iconClasses:"fa fa-th-list"});
}a.push({lable:"预览",btnClasses:"btn btn-primary prodEntityPreview",iconClasses:"fa fa-edit"});if(ResUtils.canShow("prodEntityCol.button.prodEntityInvalid")){a.push({lable:"彻底删除",btnClasses:"btn btn-danger prodEntityInvalid",iconClasses:"fa fa-edit"});
}}else{if(ResUtils.canShow("prodEntity.button.edit")&&status!="delete"){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary prodEntityEdit",iconClasses:"fa fa-edit"});
}if(ResUtils.canShow("prodEntity.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary prodEntityDetail",iconClasses:"fa fa-th-list"});
}a.push({lable:"预览",btnClasses:"btn btn-primary prodEntityPreview",iconClasses:"fa fa-edit"});if(ResUtils.canShow("prodEntity.button.onSale")||ResUtils.canShow("prodEntity.button.notOnSale")){var b={colName:"status",colVals:[],colLables:[],btnClasses:[],iconClasses:[]};
if(ResUtils.canShow("prodEntity.button.notOnSale")){b.colVals.push("on_sale");b.colLables.push("下架");b.btnClasses.push("btn btn-danger pullOffShelvesBtn");
b.iconClasses.push("fa fa-toggle-off");}if(ResUtils.canShow("prodEntity.button.onSale")){b.colVals.push("not_on_sale");b.colLables.push("上架");b.btnClasses.push("btn btn-primary putOnSaleBtn");
b.iconClasses.push("fa fa-toggle-on");}a.push({switchCol:b});}if(ResUtils.canShow("prodEntity.button.delete")&&status!="delete"){a.push({lable:msgCode.DELETE_BTN_TEXT,btnClasses:"btn btn-danger prodEntityDel",iconClasses:"fa fa-remove"});
}}}return a;},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}a["Q__S__EQ__prod.cate_id_"]=this.cateId;a["Q__S__EQ__prod.status_"]=status;
$(ProdEntity._CONS_.GRID).JTJqgrid({url:ProdEntity._CONS_.LIST_DATA_URL,pager:ProdEntity._CONS_.PAGER,postData:a,colNames:["图片","名称","款号","产品代码","规格","分类","范围","类型","类型","价格","创建时间","状态","操作","操作"],simplify:{key:"spgl",entry:[],must:["图片","名称"]},colModel:[{name:"path",sortable:false,width:50,fixed:true,formatter:function(c){var b="<img style='display: inline; height:35px;' ";
if(c){b=b+" src='"+ctx+c+"'>";}else{b=b+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";}return b;}},{name:"name",index:"prod.name_",width:230,formatter:function(c,b,d){if(ResUtils.canShow("prodEntity.button.edit")){var e=new StringBuffer();
e.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");e.append("<a idVal='"+d.id+"' class='prodEntityEdit' href='javascript:void(0);' prodKeyVal='"+d.key+"' prodIdVal='"+d.id+"'>"+c+"</a>");
e.append("</div>");return e.toString();}else{return c;}}},{name:"code",width:70,index:"sku.code_",sortable:false,formatter:function(f,c,g){var e=g.prodSkuPoList;
var b="";if(e&&e.length){var j=new StringBuffer();for(var d=0;d<e.length;d++){var h=e[d];j.append(h.code).append(",");}b=j.toString();b=b.substring(0,b.length-1);
}return b;}},{name:"code",width:70,index:"sku.prod_code_",sortable:false,formatter:function(f,c,g){var e=g.prodSkuPoList;var b="";if(e&&e.length){var j=new StringBuffer();
for(var d=0;d<e.length;d++){var h=e[d];if(h.prodCode){j.append(h.prodCode).append(",");}}b=j.toString();b=b.substring(0,b.length-1);}return b;}},{name:"prodSkuPoList",width:120,sortable:false,formatter:function(f,c,g){var e=g.prodSkuPoList;
var b="";if(e&&e.length){var j=new StringBuffer();for(var d=0;d<e.length;d++){var h=e[d];j.append(h.spec).append(",");}b=j.toString();if(b.length==e.length){b="";
}else{b=b.substring(0,b.length-1);}}return b;}},{name:"cate",width:80,sortable:true,index_:"prod.cate_id_",sortable:false,},{name:"saleRange",width:60,sortable:true,index_:"prod.sale_range_",formatter:function(b){if(b=="first"){return"一线";
}else{if(b=="second"){return"二线";}else{return"共用";}}},},{name:"type",index:"prod.type_",width:260,hidden:true},{name:"typeShow",width:60,sortable:false,formatter:function(b,c,d){switch(d.type){case"entity":return"普通";
break;case"sku_entity":return"多SKU";break;case"package":return"商品套餐";break;case"service":return"服务";break;case"pointNormal":return"普通积分";break;case"pointSku":return"多sku积分";
break;case"finance":return"金融产品";break;}}},{name:"priceType",sortable:false,width:80,index:"prod.price_type_",formatter:function(h,c,e){var j="";if(h=="common"){j="正价";
}else{if(h=="special"){j="特价";}else{if(h=="gift"){j="赠品";}else{if(h=="exchange"){j="换购";}else{if(h=="experience"){j="体验价";}else{j="";}}}}}var f=e.prodSkuPoList;
var b="";if(f&&f.length){var k=new StringBuffer();for(var d=0;d<f.length;d++){var g=f[d];k.append(g.price).append("，");}b=k.toString();b=b.substring(0,b.length-1);
}return j+"："+b;}},{name:"createTime",index:"prod.create_time_",width:80,formatter:function(b){return DateUtils.mini2Time(b);}},{name:"status",width:50,sortable:false,formatter:function(b){switch(b){case"on_sale":return"<span class='text-danger'>上架</span>";
case"not_on_sale":return"<span class='text-primary'>下架</span>";case"delete":return"<span class='text-primary'>已删除</span>";case"sold_out":return"<span class='text-warning'>售罄</span>";
}}},{name:"btnManage",width:150,formatter:function(b,d,c){var e=new StringBuffer();if(status!="delete"){if(ResUtils.canShow("prodEntity.button.edit")){e.append("<button idVal='"+c.id+"' type='button' class='jt-btn-opt prodEntityEdit' >编辑</button>&nbsp;");
}if(ResUtils.canShow("prodEntity.button.copy")){e.append("<button idVal='"+c.id+"' type='button' class='jt-btn-safe prodCopyBtn' >复制</button>&nbsp;");}if(ResUtils.canShow("prodEntity.button.detail")){e.append("<button idVal='"+c.id+"' type='button' class='jt-btn-safe prodEntityDetail' >明细</button>&nbsp;");
}e.append("<button idVal='"+c.id+"' type='button' class='jt-btn-safe prodEntityPreview' >预览</button>");}else{if(ResUtils.canShow("prodEntity.button.detail")){e.append("<button idVal='"+c.id+"' type='button' class='jt-btn-safe prodEntityDetail' >明细</button>&nbsp;");
}}return e.toString();}},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],gridComplete:function(){$(".pullOffShelvesBtn").attr("disabled","disabled");
$(".putOnSaleBtn").attr("disabled","disabled");$(ProdEntity._CONS_.GRID).jqGrid("setGridWidth",$(".jt-grid-panel").width());$(window).on("resize",function(){$(ProdEntity._CONS_.GRID).jqGrid("setGridWidth",$(".jt-grid-panel").width());
});$(window).resize();},onSelectAll:function(c,d){if(!d){$(".pullOffShelvesBtn").attr("disabled","disabled");$(".putOnSaleBtn").attr("disabled","disabled");
}else{var g=false;var b=false;for(var e=0;e<c.length;e++){var f=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",c[e]);if(b&&g){break;}if(!g&&f.status.indexOf("下架")!=-1){g=true;
}else{if(!b&&f.status.indexOf("上架")!=-1){b=true;}}}if(g){$(".putOnSaleBtn").removeAttr("disabled","disabled");}else{$(".putOnSaleBtn").attr("disabled","disabled");
}if(b){$(".pullOffShelvesBtn").removeAttr("disabled");}else{$(".pullOffShelvesBtn").attr("disabled","disabled");}}},onSelectRow:function(f){var c=$(ProdEntity._CONS_.GRID).jqGrid("getGridParam","selarrrow");
var g=false;var b=false;for(var d=0;d<c.length;d++){var e=$(ProdEntity._CONS_.GRID).jqGrid("getRowData",c[d]);if(b&&g){break;}if(!g&&e.status.indexOf("下架")!=-1){g=true;
}else{if(!b&&e.status.indexOf("上架")!=-1){b=true;}}}if(g){$(".putOnSaleBtn").removeAttr("disabled","disabled");}else{$(".putOnSaleBtn").attr("disabled","disabled");
}if(b){$(".pullOffShelvesBtn").removeAttr("disabled");}else{$(".pullOffShelvesBtn").attr("disabled","disabled");}}});}};