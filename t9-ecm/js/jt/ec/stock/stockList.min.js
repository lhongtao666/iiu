$(function(){var a=new StockList();a.init();});StockList._CONS_={LIST_DATA_URL:ctx+"/ec/stock/stStock/listData.htm",DETAIL_URL:ctx+"/ec/stock/stStock/detail.htm",SAVE_EDIT_URL:ctx+"/ec/stock/stStock/saveEdit.htm",FIND_SKU_URL:ctx+"/ec/stock/stStock/findSkuByStock.htm",FIND_CHECK_URL:ctx+"/ec/stock/stStock/findCheckData.htm",SAVE_BUY_URL:ctx+"/ec/stock/stBill/saveAdd.htm",DONE_BUY_URL:ctx+"/ec/stock/stBill/doneAdd.htm",SAVE_OUT_URL:ctx+"/ec/stock/stBill/saveOutAdd.htm",DONE_OUT_URL:ctx+"/ec/stock/stBill/doneOutAdd.htm",SAVE_ALLOCATE_URL:ctx+"/ec/stock/stAllocate/saveALAdd.htm",DONE_ALLOCATE_URL:ctx+"/ec/stock/stAllocate/doneALAdd.htm",GET_END_URL:ctx+"/ec/stock/stStock/getEndTime.htm",SAVE_CKECK_URL:ctx+"/ec/stock/stStock/saveCheck.htm",EXPORT_STOCK_URL:ctx+"/ec/stock/stStock/exportExcel.htm",EXPORT_TAMPLATE_URL:ctx+"/ec/stock/stStock/exportTamplate.htm",IMPORT_CHECK_URL:ctx+"/ec/stock/stStock/importExcel.htm",LIST_LOCK_DATA:ctx+"/ec/stock/stStock/findLockedStock.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",FIND_BATCH_CHECK_URL:ctx+"/ec/stock/stStock/findBatchCheckData.htm",EDIT_FORM_ID:"stStockForm",BUY_FORM:"buyForm",OUT_FORM:"outForm",ALLOCATE_FORM:"stAllocateForm",GRID:"#stStockGrid",PAGER:"#stStockPager",};
function StockList(){this.hadInit=false;this.storeId="";this.storeName="";this.stockLog=new StStockLog();this.stockBillBuy=new StStockBill({type:"in"});
this.stockBillOut=new StStockBill({type:"out"});this.stockBillBuyDraft=new StStockBill({type:"in",status:"draft"});this.stockBillOutDraft=new StStockBill({type:"out",status:"draft"});
this.regQty=/^[0-9]*[1-9][0-9]*$/;this.regPrice=/^\d+(\.\d{0,2})?$/;this.isManyStore=isManyStore?isManyStore:"y";this.operate="";this.canViewSo=ResUtils.canShow("stStock.button.viewSo");
this._hadInitJqgrid=false;this.cateId="";this.rootType="category";this.seniorSearch=new SeniorSearch();}StockList.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;
this._bindFormValidation();this._bindEventHander();this._hideNotGrantBtn();this._loadProdCateTree();this.storeId=$(".nav-tabs").find(".active").attr("id");
this.storeName=$(".nav-tabs").find(".active").attr("store-name");this.stockLog.init();this.stockBillBuy.init({type:"in"});this.stockBillOut.init({type:"out"});
this.stockBillBuyDraft.init({type:"in",status:"draft"});this.stockBillOutDraft.init({type:"out",status:"draft"});CateUtils.getOptions({typeKey:"system",pKey:"unit",container:"unitSelect"});
this.seniorSearch.init();this._locateToGlHelp();this._prodSearch();}},_locateToGlHelp:function(){var a="glHelp.stock.prodStock";glHelpUtil.init(a);},_loadProdCateTree:function(c){var a=this;
var b={treeId:"prodEntityCateTree",cateTypeKey:"product_catalog",rootKey:c?c:"category",userId:"",dragAble:ResUtils.canShow("prodEntity.button.drag")?true:false,onClick:function(d){a.seniorSearch.initCrumbs(d,"prodEntityCateTree",{attr:"store-name",id:a.storeId});
a.cateId=d.id;if(a._hadInitJqgrid){var e=$(this).closest("form").serialize();e+="&Q__S__EQ__store_id_="+a.storeId+"&Q__S__EQ__prod_type_="+(a.rootType=="category"?"product":"point");
a.reloadJqgrid(e);}else{a._hadInitJqgrid=true;var e="Q__S__EQ__store_id_="+a.storeId+"&Q__S__EQ__cate_id_="+a.cateId+"&Q__S__EQ__prod_type_="+(a.rootType=="category"?"product":"point");
var f={"Q__S__EQ__store_id_":a.storeId,"Q__S__EQ__cate_id_":a.cateId,"Q__S__EQ__prod_type_":(a.rootType=="category"?"product":"point"),};a._initJqgrid(f);
}}};ZtreeUtils.init(b);},clear:function(c){var a=this;function b(){a._showListWrapper();$("#buyProductFooterContainer").empty();$("#buyProductContainer").empty();
FormUtils.clear(StockList._CONS_.BUY_FORM);$("#outProductFooterContainer").empty();$("#outProductContainer").empty();FormUtils.clear(StockList._CONS_.OUT_FORM);
$("#allocateProductFooterContainer").empty();$("#allocateProductContainer").empty();$("#batchCheckItemsContainer").empty();a.isFormDataChange=false;a.isEdit=false;
if(c){$(".stStockSearch").trigger("click");}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("stStock.button.edit")){$(".stStockEdit").hide();
}if(!ResUtils.canShow("stStock.button.buy")){$(".stStockBuy").hide();}if(!ResUtils.canShow("stStock.button.out")){$(".stStockOut").hide();}if(!ResUtils.canShow("stStock.button.allocate")||this.isManyStore=="n"){$(".stStockAllocate").hide();
}if(!ResUtils.canShow("stStock.button.export")){$(".stStockExport").hide();}if(!ResUtils.canShow("stStock.button.template")){$(".stStockExportTamplate").hide();
}if(!ResUtils.canShow("stStock.button.import")){$(".stStockImport").hide();}if(!ResUtils.canShow("stStock.button.check")){$(".stStockCheck").hide();}},_showListWrapper:function(){$(".edit-form-layer").stop().animate({"left":"110%","opacity":0},500);
$(".buy-form-layer").stop().animate({"left":"110%","opacity":0},500);$(".out-form-layer").stop().animate({"left":"110%","opacity":0},500);$(".allocate-form-layer").stop().animate({"left":"110%","opacity":0},500);
$(".check-form-layer").stop().animate({"left":"110%","opacity":0},500);$(".batchCheck-form-layer").stop().animate({"left":"110%","opacity":0},500);},_showFormWrapper:function(){$(".edit-form-layer").stop().animate({"left":0,"opacity":1},500);
},_showBuyWrapper:function(){$(".buy-form-layer").stop().animate({"left":0,"opacity":1},500);},_showOutWrapper:function(){$(".out-form-layer").stop().animate({"left":0,"opacity":1},500);
},_showAllocateWrapper:function(){$(".allocate-form-layer").stop().animate({"left":0,"opacity":1},500);},_showCheckWrapper:function(){$(".check-form-layer").stop().animate({"left":0,"opacity":1},500);
},_showBatchCheckWrapper:function(){$(".batchCheck-form-layer").stop().animate({"left":0,"opacity":1},500);},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_buy:function(c){this._showBuyWrapper();var a=this;$("#"+StockList._CONS_.BUY_FORM+" input[name=operTime]").val(new Date().currentDate()+" 00:00:00");
if(c&&c.length>0){var b=StockList._CONS_.FIND_SKU_URL;FormUtils.loadData(b+"?ids="+c,function(d){a._createBuyItems(d);});}else{a._createBuyItems(new Array());
}},_out:function(c){this._showOutWrapper();var a=this;$("#"+StockList._CONS_.OUT_FORM+" input[name=operTime]").val(new Date().currentDate()+" 00:00:00");
var b=StockList._CONS_.FIND_SKU_URL;FormUtils.loadData(b+"?ids="+c,function(d){a._createOutItems(d,"#outProduct");});},_allocate:function(c){this._showAllocateWrapper();
StoreUtils.loadStores("","storeIdSearchContainer2",false,this.storeId);$("#"+StockList._CONS_.ALLOCATE_FORM+" input[name=name]").val("调库单(["+this.storeName+"]调出)"+DateUtils.format(new Date(),"yyyy-MM-dd"));
var a=this;var b=StockList._CONS_.FIND_SKU_URL;FormUtils.loadData(b+"?ids="+c,function(d){a._createOutItems(d,"#allocateProduct");});},_batchCheck:function(a){this._showBatchCheckWrapper();
this._loadtCheckData(a);},_loadtCheckData:function(c){var a=this;var b=StockList._CONS_.FIND_BATCH_CHECK_URL;FormUtils.loadData(b+"?ids="+c,function(d){a._createBatchCheckItems(d);
});},_createBuyItems:function(l){if(!l){return;}var k=$("#buyProductContainer tr");var n=new StringBuffer();var p=0;var m=new StringBuffer();for(var f=0;
f<l.length;f++){var o=false;if(k&&k.length>0){for(var d=0;d<k.length;d++){if($(k[d]).attr("skuIdVal")==l[f].skuId){o=true;break;}}}if(o){continue;}var q=0;
var h=0;var b=0;var g=l[f].position?l[f].position:"";var c=l[f].totalQty?l[f].totalQty:"";var a=l[f].qualityBegin?l[f].qualityBegin.replace(/00:00:00/,""):DateUtils.format(new Date(),"yyyy-MM-dd");
var e=0;p+=parseInt(q);m.append("<tr prodIdVal='"+l[f].prodId+"' skuIdVal='"+l[f].skuId+"'>");m.append("<td title='"+l[f].prodName+"'>"+(l[f].prodName.length<=12?l[f].prodName:(l[f].prodName.substring(0,10)+"..."))+"</td>");
m.append("<td ><a href='javascript:void(0)' class='skuPreviewBtn'>"+l[f].skuCode+"</a></td>");m.append("<td ><input type='tel' required class='form-control prodQty' value='"+parseInt(q)+"' placeholder='数量'></td>");
m.append("<td ><input type='tel' required class='form-control prodPrice' value='"+(b>0?b:"")+"' placeholder='采购价'></td>");m.append("<td ><input type='tel' required class='form-control totalMoney' readonly='readonly' value='"+e.toFixed(2)+"'></td>");
m.append("<td ><input class='laydate-icon form-control layer-date qualityBegin' required value='"+a+"' placeholder='YYYY-MM-DD' ></td>");m.append("<td ><input value='"+g+"' class='form-control position' placeholder='所在仓位'></td>");
m.append("<td><button class='btn btn-outline btn-sm btn-danger buyItemDelBtn' type='button'>删除</button></td>");m.append("</tr>");}$("#buyProductContainer").append(m.toString());
this._updateBuyTotal();},_createOutItems:function(f,a){if(!f){return;}var e=$(a+"Container"+" tr");var h=new StringBuffer();var l=0;var g=new StringBuffer();
for(var c=0;c<f.length;c++){var k=false;if(e&&e.length>0){for(var b=0;b<e.length;b++){if($(e[b]).attr("skuIdVal")==f[c].skuId){k=true;break;}}}if(k){continue;
}var m=0;var d=f[c].position?f[c].position:"";g.append("<tr prodIdVal='"+f[c].prodId+"' skuIdVal='"+f[c].skuId+"'>");g.append("<td title='"+f[c].prodName+"'>"+(f[c].prodName.length<=12?f[c].prodName:(f[c].prodName.substring(0,10)+"..."))+"</td>");
g.append("<td ><a href='javascript:void(0)' class='skuPreviewBtn'>"+f[c].skuCode+"</a></td>");g.append("<td >"+f[c].skuJson+"</td>");g.append("<td class='totalQty'>"+f[c].totalQty+"</td>");
g.append("<td class='lockQty'>"+f[c].lockQty+"</td>");g.append("<td class='savedQty'>"+f[c].savedQty+"</td>");g.append("<td class='badQty'>"+f[c].badQty+"</td>");
g.append("<td ><input style='width:50%' type='tel' required class='prodOutQty' value='"+parseInt(m)+"' placeholder='数量'><input style='margin-left:10px;' type='checkbox' name='isBad'>出次品</td>");
g.append("<td class='position'>"+d+"</td>");g.append("<td><button class='btn btn-outline btn-sm btn-danger outItemDelBtn' type='button'>删除</button></td>");
g.append("</tr>");}$(a+"Container").append(g.toString());this._updateOutTotal(a);},_createBatchCheckItems:function(b){var d=new StringBuffer();if(b){for(var a=0;
a<b.length;a++){var c=b[a];d.append("<tr stock-id='"+c.id+"' class='stock-items'><td>"+c.skuCode+"</td>").append("<td>"+c.prodName+"</td>").append("<td><input type='number' class='form-control goodQty' value='"+c.goodQty+"'></input></td>").append("<td><input type='number' class='form-control badQty' value='"+c.badQty+"'></input></td>").append("<td><table class='table-striped table-bordered items-table' sku-id='"+c.skuId+"'>").append("<tbody>").append(this._createItems(c.stockQualityPos)).append("</tbody>").append("<tfoot><td colspan='2' style='text-align:right;'>总计：</td><td class='totalQty_f'>"+this._sumQuality(c.stockQualityPos)+"</td></tfoot>").append("</table>").append("</td>").append("<td><button type='button' class='btn btn-sm btn-outline btn-primary addNew' title='添加新批次'><i class='fa fa-plus'></i></button>").append("<button type='button' class='btn btn-sm btn-outline btn-danger deleteCheck' title='删除盘点' style='margin-left:10px;'><i class='fa fa-remove'></i></button></td>").append("</tr>");
}}$("#batchCheckItemsContainer").empty().append(d.toString());},_createItems:function(a){var c=new StringBuffer();for(var b=0;b<a.length;b++){c.append("<tr>").append("<td><input  class='laydate-icon form-control layer-date chechDate' value='"+$.trim(a[b].begin.replace("00:00:00",""))+"'></td>").append("<td><input  class='laydate-icon form-control layer-date endDate' value='"+$.trim(a[b].end.replace("00:00:00",""))+"'></td>").append("<td><input type='number' class='form-control checkItemqty' value='"+a[b].qty+"'></td>");
c.append("<td><button type='button' class='btn btn-sm btn-outline btn-danger deleteCheckItem'>删除</button></td>");c.append("</tr>");}return c.toString();
},_sumQuality:function(a){var c=0;for(var b=0;b<a.length;b++){c+=parseInt(a[b].qty);}return c;},_updateBuyTotal:function(){var a=Number(0);$("#buyProductContainer").find(".prodQty").each(function(){a+=Number($(this).val());
});$("#buyTotalCountContainer").text(a);var b=Number(0);$("#buyProductContainer").find(".totalMoney").each(function(){b+=Number($(this).val());});$("#buyAllMoneyContainer").text(b.toFixed(2));
$("#buyProductFooterContainer").empty().append("<tr><td>合计</td>"+"<td colspan='2' style='text-align:right'>总数量：<strong id='buyTotalCountContainer'>"+a+"</strong></td>"+"<td colspan='2' style='text-align:right'>总金额：<strong id='buyAllMoneyContainer'>"+b.toFixed(2)+"</strong></td>"+"<td colspan='3'>&nbsp;</td><tr>");
},_updateOutTotal:function(b){var a=Number(0);$(b+"Container").find(".prodOutQty").each(function(){a+=Number($(this).val());});$(".totalCountContainer").text(a);
$(b+"FooterContainer").empty().append("<tr><td>合计</td>"+"<td colspan='6'></td>"+"<td style='text-align:right'>总数量：<strong class='totalCountContainer'>"+a+"</strong></td>"+"<td colspan='2'></td>");
},_updateCheckTotal:function(b){var a=Number(0);$(b).parents(".items-table").find(".checkItemqty").each(function(){a+=Number($(this).val());});$(b).parents(".items-table").find(".totalQty_f").empty().append(a);
},_loadData:function(d,b){var a=this;var c=StockList._CONS_.DETAIL_URL;FormUtils.loadData(c+"?id="+d,function(g){$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=id]").val(g.id);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=skuId]").val(g.skuId);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=prodId]").val(g.prodId);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=prodName]").val(g.prodName);
$("#skuCode").val(g.skuCode);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=position]").val(g.position);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=total]").val(g.total);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=total]").attr("totalQtyVal",g.total);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=lockQty]").val(g.lockQty);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=savedQty]").val(g.savedQty);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=badQty]").val(g.badQty);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=alertMax]").val(g.alertMax);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=alertMin]").val(g.alertMin);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=staticAlertMax]").val(g.staticAlertMax);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=staticAlertMin]").val(g.staticAlertMin);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=dynamicAlertMax]").val(g.dynamicAlertMax);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=dynamicAlertMin]").val(g.dynamicAlertMin);$("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=unit]").val(g.unit);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=salesDays]").val(g.salesDays);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=salesAvg]").val(g.salesAvg);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=salesSupport]").val(g.salesSupport);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=createTime]").val(g.createTime);
$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=updateTime]").val(g.updateTime);$("#"+StockList._CONS_.EDIT_FORM_ID+" [name=canSale]").val(g.canSale);
if(g.notifyType){$("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=notifyType]").val(g.notifyType);}else{$("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=notifyType]").val("static");
}$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=empIds]").val(g.empIds);$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=empNames]").val(g.empNames);
var e="n";if(g.isNotify=="y"){e="y";$("#"+StockList._CONS_.EDIT_FORM_ID).find(".receiver").show();}else{$("#"+StockList._CONS_.EDIT_FORM_ID).find(".receiver").hide();
}$("#"+StockList._CONS_.EDIT_FORM_ID).find("#needSendMsg").empty().append("<input name='isNotify' "+(e=="y"?"checked":"")+" value='"+e+"' type='checkbox' class='js-switch' />");
var f=document.querySelector(".js-switch");var h=new Switchery(f,{className:"switchery switchery-small"});StoreUtils.loadStores(g.storeId,"storeIdContainer");
a.stockLog.reloadJqgrid({Q__S__EQ__store_id_:g.storeId,Q__S__EQ__sku_id_:g.skuId});a.stockBillBuy.reloadJqgrid({Q__S__IN__type_:"in,allocate_in,reject_in",Q__S__EQ__store_id_:g.storeId,Q__S__LK__sku_ids_:g.skuId,Q__S__EQ__status_:"done"});
a.stockBillOut.reloadJqgrid({Q__S__IN__type_:"out,manual_out,allocate_out",Q__S__EQ__store_id_:g.storeId,Q__S__LK__sku_ids_:g.skuId,Q__S__EQ__status_:"done"});
a.stockBillBuyDraft.reloadJqgrid({Q__S__IN__type_:"in,allocate_in,reject_in",Q__S__EQ__store_id_:g.storeId,Q__S__LK__sku_ids_:g.skuId,Q__S__EQ__status_:"draft"});
a.stockBillOutDraft.reloadJqgrid({Q__S__IN__type_:"out,manual_out,allocate_out",Q__S__EQ__store_id_:g.storeId,Q__S__LK__sku_ids_:g.skuId,Q__S__EQ__status_:"draft"});
a._initLock(g.skuId,g.storeId);if($("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=notifyType]").val()=="static"){$(document).find(".staticDiv").show();
$(document).find(".dynamicDiv").hide();}else{$(document).find(".staticDiv").hide();$(document).find(".dynamicDiv").show();}});},_save:function(){var b=this;
var a=StockList._CONS_.SAVE_EDIT_URL;var d="预警方式【";var c=$("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=notifyType]").val();if(c=="dynamic"){d=d+"动态预警】, 采购周期【"+$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=salesDays]").val()+"】天";
}else{d=d+"固定值预警】,安全库存上限【"+$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=staticAlertMax]").val()+"】,安全库存下限【"+$("#"+StockList._CONS_.EDIT_FORM_ID+" input[name=staticAlertMin]").val()+"】";
}if($("#stStockForm").valid()){DialogUtils.confirmWithOptions({title:"请核对下面参数再保存",text:d,confirmButtonText:"确认",yesFunc:function(){ButtonUtils.disableBtn("saveBtn");
FormUtils.submitByFormId(a,StockList._CONS_.EDIT_FORM_ID,function(e){ButtonUtils.enableBtn("saveBtn");if(e.success){if(e.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(e.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});}},_saveBuy:function(d){var e=this;var a=StockList._CONS_.SAVE_BUY_URL;
if(d){a=StockList._CONS_.DONE_BUY_URL;}$("#buyForm input[name=storeId]").val(e.storeId);if($("#buyForm").valid()){var c=[];var b=false;if($("#buyProductContainer").find("tr").length<=0){DialogUtils.error(msgCode.ERROR,"请选择要采购的产品");
return false;}$("#buyProductContainer").find("tr").each(function(){var g={};g.skuId=$(this).attr("skuIdVal");g.prodId=$(this).attr("prodIdVal");g.qty=$(this).find(".prodQty").val();
g.inQty=0;g.price=$(this).find(".prodPrice").val();g.position=$(this).find(".position").val();g.qualityBegin=$(this).find(".qualityBegin").val();if(!g.qty){$(this).find(".prodQty").focus();
DialogUtils.error(msgCode.ERROR,"数量不能为空");b=true;return false;}if(!e.regQty.test(g.qty)){$(this).find(".prodQty").focus();DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");
b=true;return false;}if(!g.qualityBegin){$(this).find(".qualityBegin").focus();DialogUtils.error(msgCode.ERROR,"生产日期不能为空");b=true;return false;}c.push(g);
});if(b){return;}var f=$("#"+StockList._CONS_.BUY_FORM).serialize();f+="&type=in";f+="&billItemJson="+JSON.stringify(c);DialogUtils.confirmWithOptions({title:"确定完成吗？",text:"",confirmButtonText:"完成",yesFunc:function(){ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(a,f,function(g){ButtonUtils.enableBtn("saveBtn");if(g.success){DialogUtils.success(msgCode.INFO,g.msg);e.isEdit=false;e.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});}},_saveOut:function(d){var e=this;var a=StockList._CONS_.SAVE_OUT_URL;
if(d){a=StockList._CONS_.DONE_OUT_URL;}$("#outForm input[name=storeId]").val(e.storeId);if($("#outForm").valid()){var c=[];var b=false;if($("#outProductContainer").find("tr").length<=0){DialogUtils.error(msgCode.ERROR,"请选择出库的产品");
return false;}$("#outProductContainer").find("tr").each(function(){var h={};h.skuId=$(this).attr("skuIdVal");h.prodId=$(this).attr("prodIdVal");h.qty=$(this).find(".prodOutQty").val();
h.type=$(this).find("input[name=isBad]")[0].checked?"bad":"common";h.position=$(this).find(".position").text();var g=parseInt($(this).find(".totalQty").text());
var i=parseInt($(this).find(".lockQty").text());var k=parseInt($(this).find(".savedQty").text());var j=parseInt($(this).find(".badQty").text());if(!h.qty){$(this).find(".prodOutQty").focus();
DialogUtils.error(msgCode.ERROR,"数量不能为空");b=true;return false;}if(!e.regQty.test(h.qty)){$(this).find(".prodOutQty").focus();DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");
b=true;return false;}if(h.type=="bad"){if(j<h.qty){$(this).find(".prodOutQty").focus();DialogUtils.error(msgCode.ERROR,"次品数量不足");b=true;return false;}}else{if(g-i-k-j<h.qty){$(this).find(".prodOutQty").focus();
DialogUtils.error(msgCode.ERROR,"出库数量不足");b=true;return false;}}c.push(h);});if(b){return;}var f=$("#"+StockList._CONS_.OUT_FORM).serialize();f+="&type=manual_out";
f+="&billItemJson="+JSON.stringify(c);DialogUtils.confirmWithOptions({title:"确定完成吗？",text:"",confirmButtonText:"完成",yesFunc:function(){ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(a,f,function(g){ButtonUtils.enableBtn("saveBtn");if(g.success){DialogUtils.success(msgCode.INFO,g.msg);e.isEdit=false;e.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});}},_saveAllocate:function(d){var e=this;var a=StockList._CONS_.SAVE_ALLOCATE_URL;
if(d){a=StockList._CONS_.DONE_ALLOCATE_URL;}$("#stAllocateForm input[name=outStoreId]").val(e.storeId);if($("#stAllocateForm").valid()){var c=[];var b=false;
if($("#allocateProductContainer").find("tr").length<=0){DialogUtils.error(msgCode.ERROR,"请添加要调拨的商品");b=true;return false;}$("#allocateProductContainer").find("tr").each(function(){var h={};
h.skuId=$(this).attr("skuIdVal");h.prodId=$(this).attr("prodIdVal");var g=parseInt($(this).find(".totalQty").text());var i=parseInt($(this).find(".lockQty").text());
var k=parseInt($(this).find(".savedQty").text());var j=parseInt($(this).find(".badQty").text());h.totalQty=g;h.qty=parseInt($(this).find(".prodOutQty").val());
h.type=$(this).find("input[name=isBad]")[0].checked?"bad":"common";h.position=$(this).find(".position").text();if(!e.regQty.test(h.qty)){$(this).find(".prodOutQty").focus();
DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");b=true;return false;}if(h.type=="bad"){if(j<h.qty){$(this).find(".prodOutQty").focus();DialogUtils.error(msgCode.ERROR,"次品数量不足");
b=true;return false;}}else{if(g-i-k-j<h.qty){$(this).find(".prodOutQty").focus();DialogUtils.error(msgCode.ERROR,"出库数量不足");b=true;return false;}}c.push(h);
});if(b){ButtonUtils.enableBtn("saveBtn");return;}var f=$("#"+StockList._CONS_.ALLOCATE_FORM).serialize();f+="&billItemJson="+JSON.stringify(c);DialogUtils.confirmWithOptions({title:"确定完成吗？",text:"",confirmButtonText:"完成",yesFunc:function(){ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(a,f,function(g){ButtonUtils.enableBtn("saveBtn");if(g.success){DialogUtils.success(msgCode.INFO,g.msg);e.isEdit=false;e.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});}},_saveCheck:function(){var a=[];var c=this;var b=false;
$("#batchCheckItemsContainer").find(".stock-items").each(function(){var f=[];$(this).find(".items-table").find("tbody").find("tr").each(function(){var i={};
i.begin=$(this).find("td:eq(0) input").val();i.qty=$(this).find("td:eq(2) input").val()==""?0:$(this).find("td:eq(2) input").val();i.end=$(this).find("td:eq(1) input").val();
if(i.begin==null||i.begin==""){DialogUtils.error(msgCode.error,"保质期开始时间不能为空");$(this).find("td:eq(0) input").focus();b=true;return false;}if(!c._validata(i.qty,$(this).find("td:eq(2) input"))){b=true;
return false;}f.push(i);});if(b){return false;}var h=$(this).find(".goodQty").val();var g=$(this).find(".badQty").val();var d=$(this).attr("stock-id");
if(!c._validata(h,$(this).find(".goodQty"))){b=true;return false;}if(!c._validata(g,$(this).find(".badQty"))){b=true;return false;}var e={stockId:d,goodQty:h,badQty:g,stockQualityPos:f};
a.push(e);});if(b){return false;}if(a.length<=0){DialogUtils.error(msgCode.error,"请选择要盘点的产品");return false;}DialogUtils.confirmWithOptions({title:"确定完成吗？",text:"",confirmButtonText:"完成",yesFunc:function(){FormUtils.submit(StockList._CONS_.SAVE_CKECK_URL,"paramJson="+JSON.stringify(a),function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
c.isEdit=false;c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},_bindEventHander:function(){var a=this;
a.isClose=true;$(".helper").hover(function(b){$("#stock-helper").css({"top":$(this).offset().top,"left":$(this).offset().left+30}).stop(true).show();},function(b){setTimeout(function(){if(a.isClose){$("#stock-helper").stop().hide("fast");
}},500);});$("#stock-helper").hover(function(b){a.isClose=false;$("#stock-helper").show();},function(b){$("#stock-helper").stop().hide("fast");a.isClose=true;
});$("#"+StockList._CONS_.EDIT_FORM_ID).on("change","input[name=isNotify]",function(){var b=$("#"+StockList._CONS_.EDIT_FORM_ID).find("[name=isNotify]").is(":checked");
if(b){$("#"+StockList._CONS_.EDIT_FORM_ID).find("[name=isNotify]").val("y");$("#"+StockList._CONS_.EDIT_FORM_ID).find(".receiver").show();}else{$("#"+StockList._CONS_.EDIT_FORM_ID).find("[name=isNotify]").val("n");
$("#"+StockList._CONS_.EDIT_FORM_ID).find(".receiver").hide();}});$(".selectEmp").on("click",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.stock")){b:1;
}var d={isShowAllGroup:b,grantType:"/stock/",isMultiple:1,isSale:0,callBack:function(g){if(g!=null){var h="",e="";for(var f=0;f<g.length;f++){h=h+g[f].aid+"("+g[f].name+")";
e=e+g[f].id;if(f!=g.length-1){h=h+", ";e=e+",";}}$("input[name=empNames]").val(h);$("input[name=empIds]").val(e);$("input[name=mgrName]").keyup();}}};var c=new EmployeesSelect();
c.init(d);});$("#"+StockList._CONS_.EDIT_FORM_ID).on("change","select[name=notifyType]",function(){if($("#"+StockList._CONS_.EDIT_FORM_ID+" select[name=notifyType]").val()=="dynamic"){$(document).find(".staticDiv").hide();
$(document).find(".dynamicDiv").show();}else{$(document).find(".dynamicDiv").hide();$(document).find(".staticDiv").show();}});$("body").on("click",".showStockDetail",function(){var b=$(this).parents("tr").attr("id");
a._edit(b);});$(document).on("click",".qualityBegin",function(){laydate({istime:true,format:"YYYY-MM-DD"});});$(document).on("click",".buyItemDelBtn",function(){$(this).parents("tr").remove();
a._updateBuyTotal();});$(document).on("click",".soTab",function(){var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(StockList._CONS_.DETAIL_PAGE_URL+"?soNo="+b,b+"明细");
});$(document).on("click",".outItemDelBtn",function(){$(this).parents("tr").remove();a._updateOutTotal("#outProduct");});$("body").on("click",".prevBtn",function(){a.clear();
});$("body").on("click",".store .tabli",function(){a._showListWrapper();a.storeId=$(this).attr("id");a.storeName=$(this).attr("store-name");$(".resetBtn").trigger("click");
a.reloadJqgrid("Q__S__EQ__store_id_="+a.storeId);});$("body").on("click",".prod-type .tabli",function(){var b=$(this).attr("root-type");a.rootType=b;a._showListWrapper();
$(".resetBtn").trigger("click");a._loadProdCateTree(b);if(a.rootType=="category"){$("#selectProdBtn").show();$("#selectPointBtn").hide();}else{$("#selectPointBtn").show();
$("#selectProdBtn").hide();}a._prodSearch();});$("body").on("click",".stStockSearch",function(){var b=$(this).closest("form").serialize();b+="&Q__S__EQ__store_id_="+a.storeId;
a.reloadJqgrid(b);});$("#"+StockList._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#stStockSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".stStockSearch").trigger("click");
}});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");FormUtils.clear("#"+b);});$("body").on("click",".stStockBuy",function(){var b=$(this).attr("idVal");
if(!b){b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");}a.operate="buy";a._buy(b);});$("body").on("click",".stStockOut",function(){var b=$(this).attr("idVal");
if(!b){b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要出库的商品");return false;
}}a.operate="out";a._out(b);});$("body").on("click",".stStockAllocate",function(){var b=$(this).attr("idVal");if(!b){b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要调库的商品");return false;}}a.operate="allocate";a._allocate(b);});$("body").on("click",".stStockCheck",function(){var b=$(this).attr("idVal");
if(!b){b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要盘点的商品");return false;
}}a._batchCheck(b);});$("body").on("click",".stStockEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}a._edit(b);});$(".edit-form-layer").on("click",".saveBtn",function(){a._save();
});$(".buy-form-layer").on("click",".saveBtn",function(){a._saveBuy(false);});$(".buy-form-layer").on("click",".doneBtn",function(){a._saveBuy(true);});
$(".out-form-layer").on("click",".saveBtn",function(){a._saveOut(false);});$(".out-form-layer").on("click",".doneBtn",function(){a._saveOut(true);});$(".allocate-form-layer").on("click",".saveBtn",function(){a._saveAllocate(false);
});$(".allocate-form-layer").on("click",".doneBtn",function(){a._saveAllocate(true);});$(".check-form-layer").on("click",".doneBtn",function(){a._saveCheck(true);
});$(".batchCheck-form-layer").on("click",".doneBtn",function(){a._saveCheck(true);});$("#selectProdBtn").on("click",function(){var b=a.storeId;SelectProdService.selectSku({storeId:b,isMultiple:1,hasStock:"n",hideCanSale:"y",canSale:"n",showNotOnSale:"y",type:"product",fn:function(c){a._createBuyItems(c);
}});});$("#selectPointBtn").on("click",function(){var b=a.storeId;SelectProdService.selectSku({storeId:b,isMultiple:1,hasStock:"n",hideCanSale:"y",canSale:"n",type:"point",fn:function(c){a._createBuyItems(c);
}});});$(document).on("click",".skuPreviewBtn",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodEntityId="+$(this).parents("tr").attr("prodIdVal")+"&prodSkuId="+$(this).parents("tr").attr("skuIdVal"),"商品【"+$(this).parents("tr").find("td:eq(1)").text()+"】",$(this).parents("tr").find("td:eq(0)").text());
});$("body").on("keyup",".prodOutQty",function(){var c=$(this).val();var b=a.operate=="out"?"#outProduct":"#allocateProduct";if(!c){a._updateOutTotal(b);
return;}if(!a.regQty.test(c)){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");$(this).focus();return;}a._updateOutTotal(b);});$("body").on("keyup",".prodQty",function(){var d=$(this).val();
if(!d){a._updateBuyTotal();return;}if(!a.regQty.test(d)){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");$(this).focus();return;}var b=$(this).parents("td").next().next().find("input");
var c=$(this).parents("td").next().find("input").val();if(c&&!a.regPrice.test(c)){DialogUtils.error(msgCode.ERROR,"价格必须为大于0的数字。小数点2位");$(this).parents("td").next().find("input").focus();
return;}if(!c){c=0;}b.val((d*c).toFixed(2));a._updateBuyTotal();});$("body").on("keyup",".prodPrice",function(){var c=$(this).val();if(!c){return;}if(!a.regPrice.test(c)){DialogUtils.error(msgCode.ERROR,"价格必须为大于0的数字。小数点保留0-2位");
$(this).focus();return;}var d=$(this).parents("td").prev().find("input").val();var b=$(this).parents("td").next().find("input");b.val((d*c).toFixed(2));
a._updateBuyTotal();});$("body").on("click",".chechDate",function(){var b=this;laydate({istime:true,format:"YYYY-MM-DD",choose:function(d){var c=$(b).val();
if(!a._isNewTime(c,b)){$(b).val("");DialogUtils.error(msgCode.error,"已存在相同的保质期起始日期！");return false;}a._setEndTime(c,b);}});});$("body").on("click",".endDate",function(){laydate({istime:true,format:"YYYY-MM-DD"});
});$("body").on("keyup",".checkQty",function(){var d=parseInt($(".totalQty").text());var c=$("#checkForm").find("input[name=checkBadQty]").val();var b=$("#checkForm").find("input[name=checkQty]").val();
$(".checkLostQty").empty().append(d-c-b);});$("body").on("keyup",".checkItemqty",function(){var b=$(this).val();if(a._validata(b,this)){a._updateCheckTotal(this);
}});$(document).on("click",".deleteCheckItem",function(){$(this).parent().parent().remove();a._updateCheckTotal(this);});$(document).on("click",".deleteCheck",function(){$(this).parents("tr").remove();
});$(document).on("click",".addNew",function(){var b=new StringBuffer();b.append("<tr>").append("<td ><input class='laydate-icon form-control layer-date chechDate' placeholder='YYYY-MM-DD' ></td>").append("<td ><input class='laydate-icon form-control layer-date endDate' placeholder='YYYY-MM-DD' ></td>").append("<td> <input type='number' class='form-control checkItemqty'></td>").append("<td><button type='button' class='btn btn-sm btn-outline btn-danger deleteCheckItem'>删除</button></td>").append("</tr>");
$(this).parent().parent().find(".items-table").append(b.toString());});$("body").on("click",".stStockExport",function(){DialogUtils.success(msgCode.SUCCESS,"正在导出....");
var b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");var c="Q__S__EQ__stock.store_id_="+a.storeId+"&selectIds="+b+"&"+$("#stStockSearchForm").closest("form").serialize();
FormUtils.submit(StockList._CONS_.EXPORT_STOCK_URL,c,function(d){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);});$("body").on("click",".exportBill",function(){var c=$(this).attr("id-value");
var b=$(this).attr("type-value");if(b=="in"||b=="manual_out"){a._exportBill(c,b);}else{a._exportAllocate(c,b);}});$("body").on("click",".stStockExportTamplate",function(){DialogUtils.success(msgCode.SUCCESS,"正在导出....");
var b=$(StockList._CONS_.GRID).jqGrid("getGridParam","selarrrow");var c="Q__S__EQ__stock.store_id_="+a.storeId+"&selectIds="+b+"&"+$("#stStockSearchForm").closest("form").serialize();
FormUtils.submit(StockList._CONS_.EXPORT_TAMPLATE_URL,c,function(d){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);});$("body").on("click",".stStockImport",function(){var b={"importUrl":StockList._CONS_.IMPORT_CHECK_URL+"?storeId="+a.storeId,"tabTitle":"盘点到["+(a.storeName).substring(0,5)+"...]"+""};
excelUtil.importExcel(b);});$("#stStockSearchForm").on("click",".stockNumber",function(){if($(this).attr("checked")=="checked"){$(this).prop("checked",false);
$(this).removeAttr("checked");}else{$(this).attr("checked","checked");}});$(document).on("click",".detailRow",function(){var c=$(this).attr("data-id");
var b=$(this).attr("data-name");JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/prodStoreList.html?Q__S__EQ__prod_id_="+c,"["+b+"]的全部库存");});},_exportBill:function(d,c){var a="";
var b="";if(c=="in"){a=ctx+"/ec/stock/stBill/export.htm";b="采购单";}else{if(c=="manual_out"){a=ctx+"/ec/stock/stBill/export.htm";b="出库单";}else{return false;
}}FormUtils.submit(a,"id="+d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,"成功");JTTabUtils.addOrRefreshTab(ctx+e.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D",b);
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_exportAllocate:function(d,b){var a=ctx+"/ec/stock/stAllocate/export.htm";
var c="";if(b=="allocate_in"){c="inId="+d;}else{c="outId="+d;}FormUtils.submit(a,c,function(e){if(e.success){DialogUtils.success(msgCode.INFO,"成功");JTTabUtils.addOrRefreshTab(ctx+e.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D","调库单");
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_isNewTime:function(a,b){var c=0;
$(b).parents(".items-table").find("tr").each(function(){var d=$(this).find("td:eq(0) input").val();if(a==d){c++;}});if(c==1){return true;}else{return false;
}},_setEndTime:function(a,c){var b=$(c).parents(".items-table").attr("sku-id");var d={beginTime:a,skuId:b};FormUtils.submit(StockList._CONS_.GET_END_URL,d,function(e){if(e.success){$(c).parent().parent().find("td:eq(1) input").val(e.msg);
}});},_validata:function(b,a){if(!/[0-9]*/.test(b)){DialogUtils.error(msgCode.error,"数量只能输入数字！");$(a).focus();return false;}if(b<0){DialogUtils.error(msgCode.error,"数量只能大于等于0！");
$(a).focus();return false;}return true;},reloadJqgrid:function(c){var b="";var a="";if($("input[name=alertMax]").attr("checked")){b="alertMax";}if($("input[name=alertMin]").attr("checked")){b=b+",alertMin";
}if($("input[name=hasStock]").attr("checked")){b=b+",hasStock";}if($("input[name=noStock]").attr("checked")){b=b+",noStock";}if(b){c=c+"&stockNumber="+b;
}if($("input[name=statusOnsale]").attr("checked")){a="on_sale";}if($("input[name=statusNotSale]").attr("checked")){a+=",not_on_sale";}if(a){c=c+"&Q__S__IN__sku.status_="+a;
}if(this.cateId){c=c+"&Q__S__EQ__cate_id_="+this.cateId;}JTJqgridUtils.reloadJqgrid(StockList._CONS_.GRID,c);},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}$(StockList._CONS_.GRID).JTJqgrid({url:StockList._CONS_.LIST_DATA_URL,pager:StockList._CONS_.PAGER,width:"100%",autowidth:true,postData:a,footerrow:true,userDataOnFooter:true,colNames:["id","图片","名称","skuId","sku编码","总数","锁定","预留","次品","库存预警","上限","下限","保质期","保质期(剩余天数)","是否销售","上下架","上次盘点时间","操作","操作"],colModel:[{name:"id",index:"stock.id_",width:700,hidden:true},{name:"path",sortable:false,width:100,formatter:function(c){var b="<img style='display: inline; height:35px;' ";
if(c){b=b+" src='"+ctx+c+"'>";}else{b=b+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";}return b;}},{name:"prodName",index:"prod.name_",width:180,sortable:false,formatter:function(c,b,e){var d='<a class ="showStockDetail" title="'+c+'">';
d+=c+"</a>";return d;}},{name:"skuId",index:"sku.sku_id_",hidden:true},{name:"skuCode",index:"sku.code_",width:100},{name:"total",index:"stock.total_",width:80},{name:"lockQty",index:"stock.lock_qty_",width:50,formatter:function(b){return"<span class='text text-warning'>"+b+"</sapn>";
}},{name:"savedQty",index:"stock.saved_qty_",width:50,formatter:function(b){return"<span class='text text-info'>"+b+"</span>";}},{name:"badQty",index:"stock.bad_qty_",width:50,formatter:function(b){return"<span class='text text-danger'>"+b+"</span>";
}},{name:"alert",width:60,sortable:false,formatter:function(b,k,f){var i=f.total;var g=f.badQty;var c=parseInt(f.staticAlertMax);var j=parseInt(f.staticAlertMin);
var e=parseInt(f.alertMin);var h=parseInt(f.alertMax);var d=parseInt(i)-parseInt(g);if(f.notifyType=="dynamic"){if(d==0){return"<span style='font-weight: bold;color: #ED1C24;'>无货</span>";
}else{if(d<e){return"<span style='font-weight: bold;color: #FF7F27;'>缺货</span>";}else{if(d>h&&h!=0){return"<span style='font-weight: bold;color: #00B0F0;'>积压</span>";
}else{return"<span style='font-weight: bold;color: green;'>有货</span>";}}}}else{if(d==0){return"<span style='font-weight: bold;color: #ED1C24;'>无货</span>";
}else{if(d<=j){return"<span style='font-weight: bold;color: #FF7F27;'>缺货</span>";}else{return"<span style='font-weight: bold;color: green;'>有货</span>";
}}}}},{name:"alertMax",index:"stock.alert_max_",width:60,hidden:true},{name:"alertMin",index:"stock.alert_min_",width:60,hidden:true},{name:"qualityStatus",index:"stock.quality_status_",width:60,formatter:function(b){if(b=="common"){return"良好";
}else{if(b=="notice"){return"正常";}else{if(b=="important"){return"普通";}else{if(b=="critical"){return"<span class='text-danger'>将过期</span>";}else{if(b=="expire"){return"<span class='text-danger'>已过期</span>";
}else{return"";}}}}}}},{name:"deadline",index:"stock.deadline_",width:100,formatter:function(b,c,d){if(d.qualityStatus==null||d.qualityStatus==""){return"";
}else{if(b<0){return"<span class='text text-danger'>0</span>";}else{return b;}}}},{name:"canSale",width:70,sortable:false,formatter:function(b){if(b=="y"){return"是";
}else{return"<span class='text text-danger'>否</span>";}}},{name:"status",width:70,sortable:false,formatter:function(b){switch(b){case"on_sale":return"上架";
case"not_on_sale":return"<span class='text text-danger'>下架</span>";case"delete":return"<span class='text-danger'>已删除</span>";case"sold_out":return"<span class='text-warning'>售罄</span>";
}}},{name:"lastQualityTime",index:"stock.last_quailty_time_",width:110,formatter:function(b){return DateUtils.miniTime(b);}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()},{name:"operate",index:"",width:100,formatter:function(b,c,d){return"<button type='button' data-id='"+d.prodId+"' data-name='"+d.prodName+"' class = 'jt-btn-safe detailRow'>查看库存</button>";
}}],loadComplete:function(){},gridComplete:function(){var b=$(".jqGrid_wrapper").find("tr.footrow");b.find("td").hide();b.find('td[aria-describedby*="_id"]').show();
},sortable:true,});},_initLock:function(b,a){var c=this;var d=StockList._CONS_.LIST_LOCK_DATA;FormUtils.loadData(d+"?skuId="+b+"&storeId="+a,function(e){c._createLockItems(e);
});},_createLockItems:function(d){var a=$("#stStockLockGrid");a.empty();$("#stStockLockPager").empty();if(d.length>0){var e=new StringBuffer();var c=0;
for(var b=0;b<d.length;b++){e.append("<tr>");if(this.canViewSo){e.append("<td><a class='soTab' value='"+d[b].code+"'>"+d[b].code+"</a></td>");}else{e.append("<td>"+d[b].code+"</td>");
}e.append("<td>"+d[b].prodName+"</td>").append("<td>"+d[b].count+"</td>").append("</tr>");c+=d[b].count;}a.append(e.toString());$("#stStockLockPager").append("<td colspan='2'></td><td>"+"总计："+c+"</td>");
}},_prodSearch:function(){$("#searchProd").bsSuggest("destroy");var a=this;var d=$("#searchProd").width()+"px";if($("#searchProd").width()<=500){d=($(".itemDiv").width()*5/6)+"px";
}if(a.rootType=="prodPoint"){c="n";b="point";}else{var b="entity";var c="y";}$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+b+"&storeId=&limitProdCate="+c+"&keyword=",effectiveFields:["prodName","prodTotal","skuCode","skuAttr","content"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodName:"产品名字",prodTotal:"价格",skuCode:"sku编码",skuAttr:"sku属性",content:"备注"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(e){a.searchProds=e.value;
return e;},listStyle:{"padding-top":0,"max-height":"500px","max-width":d,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(g,f){}).on("onSetSelectValue",function(h,f){var j=new Array();
for(var g=0;g<a.searchProds.length;g++){if(a.searchProds[g].skuId==f.id){j=j.concat(a.searchProds[g]);break;}}a._createBuyItems(j);$("#searchProd").val("");
}).on("onUnsetSelectValue",function(f){});},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("stStock.button.buy")){a.push({lable:"采购",btnClasses:"btn btn-primary stStockBuy",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("stStock.button.out")){a.push({lable:"出库",btnClasses:"btn btn-primary stStockOut",iconClasses:"fa fa-th-list"});}if(ResUtils.canShow("stStock.button.allocate")&&this.isManyStore=="y"){a.push({lable:"调库",btnClasses:"btn btn-primary stStockAllocate",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("stStock.button.check")){a.push({lable:"盘点",btnClasses:"btn btn-primary stStockCheck",iconClasses:"fa fa-th-list"});}if(ResUtils.canShow("stStock.button.edit")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary stStockEdit",iconClasses:"fa fa-edit"});
}return a;},_bindFormValidation:function(){var c={rules:{operTime:{required:true}},messages:{}};var a={rules:{operTime:{required:true}},messages:{}};var b={rules:{name:{required:true},inStoreId:{required:true}},messages:{}};
FormUtils.bindFormValidation(StockList._CONS_.BUY_FORM,c);FormUtils.bindFormValidation(StockList._CONS_.OUT_FORM,a);FormUtils.bindFormValidation(StockList._CONS_.ALLOCATE_FORM,b);
}};