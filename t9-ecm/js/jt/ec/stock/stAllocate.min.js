$(function(){var a=new StAllocate();a.init();});function StAllocate(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.canSubmit=true;
this.done=false;this.data={};}StAllocate._CONS_={EDIT_URL:ctx+"/ec/stock/stAllocate/edit.htm",DETAIL_URL:ctx+"/ec/stock/stAllocate/detail.htm",DELETE_URL:ctx+"/ec/stock/stAllocate/delete.htm",SAVE_ADD_URL:ctx+"/ec/stock/stAllocate/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/stock/stAllocate/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/stock/stAllocate/listData.htm",GET_BILL_BY_ID:ctx+"/ec/stock/stAllocate/getBillByBillId.htm",TO_CONFIRM_URL:ctx+"/ec/stock/stAllocate/toConfirm.htm",CONFIRM_URL:ctx+"/ec/stock/stAllocate/confirm.htm",BACK_CONFIRM_URL:ctx+"/ec/stock/stAllocate/backConfirm.htm",DONE_URL:ctx+"/ec/stock/stAllocate/done.htm",IVALIDE_URL:ctx+"/ec/stock/stAllocate/invalid.htm",EXPORT_URL:ctx+"/ec/stock/stAllocate/export.htm",EDIT_FORM_ID:"stAllocateForm",GRID:"#stAllocateGrid",PAGER:"#stAllocatePager"};
StAllocate.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this.onSelectRow();StoreUtils.loadStores("","storeIdSearchContainer1");StoreUtils.loadStores("","storeIdSearchContainer2");StoreUtils.loadStores("","storeIdSearchContainer4");
StoreUtils.loadStores("","storeIdSearchContainer5");this._appendTable("productHeaderContainer");}},_appendTable:function(a){var b=new StringBuffer();b.append("<tr>").append("<th width='12%'>名称</th>").append("<th width='12%'>sku</th>").append("<th width='5%'>单位</th>");
b.append("<th  width='8%'>库存数量</th>");b.append("<th width='8%'>良品数量<span style='color: red;'>*</span></th>");b.append("<th width='8%'>次品数量</th>");b.append("<th width='8%'>仓位</th>").append("<th width='8%'>删除</th></tr>");
$("#"+a).empty().append(b.toString());},_hideNotGrantBtn:function(){if(!ResUtils.canShow("stAllocate.button.detail")){$(".stAllocateDetail").hide();}if(!ResUtils.canShow("stAllocate.button.add")){$(".stAllocateAdd").hide();
}if(!ResUtils.canShow("stAllocate.button.edit")){$(".stAllocateEdit").hide();}if(!ResUtils.canShow("stAllocate.button.delete")){$(".stAllocateDel").hide();
}if(!ResUtils.canShow("stAllocate.button.done")){$(".stAllocateDone").hide();}if(!ResUtils.canShow("stAllocate.button.export")){$(".stAllocateExport").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$("button.saveBtn").show();$("button.toConfirmBtn").show();
$(".confirmBtn").show();$(".backConfirmBtn").show();$(".doneBtn").show();$("#productFooterContainer").empty();$("#productContainer").empty();$("#productContainer").find(":input").removeAttr("readonly");
$("#productContainer").find("select").removeAttr("disabled");$(".onlyShowDetail").show();$("#"+StAllocate._CONS_.EDIT_FORM_ID).find(":input").removeAttr("readonly");
$("#"+StAllocate._CONS_.EDIT_FORM_ID).find("select").removeAttr("disabled");$("input[name=key]").attr("readonly","readonly");$("input[name=outBillNo]").attr("readonly","readonly");
$("input[name=inBillNo]").attr("readonly","readonly");ButtonUtils.enableBtn("selectProdBtn");FormUtils.clear(StAllocate._CONS_.EDIT_FORM_ID);FormUtils.enableForm(StAllocate._CONS_.EDIT_FORM_ID);
if(c){$(".stAllocateSearch").trigger("click");}a.onSelectRow();}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){this._showFormWrapper();$(".toConfirmBtn").hide();
$(".confirmBtn").hide();$(".backConfirmBtn").hide();$(".doneBtn").hide();$(".onlyShowDetail").hide();},_edit:function(c,a){this._showFormWrapper();this.edit=true;
var b=false;if(a=="edit"){$(".confirmBtn").hide();$(".toConfirmBtn").hide();$(".backConfirmBtn").hide();$(".doneBtn").hide();}else{if(a=="awaiting_confirm"){b=true;
$(".confirmBtn").hide();$(".saveBtn").hide();$(".doneBtn").hide();$(".backConfirmBtn").hide();}else{if(a=="confirm"){$(".saveBtn").hide();$(".toConfirmBtn").hide();
$(".doneBtn").hide();b=true;}else{if(a=="done"){$(".confirmBtn").hide();$(".saveBtn").hide();$(".backConfirmBtn").hide();$(".toConfirmBtn").hide();}}}}this._loadData(c,b);
},_detail:function(a){this._showFormWrapper();this._loadData(a,true);$(".saveBtn").hide();$(".toConfirmBtn").hide();$(".backConfirmBtn").hide();$(".confirmBtn").hide();
$(".doneBtn").hide();FormUtils.disableForm(StAllocate._CONS_.EDIT_FORM_ID);},_loadData:function(d,c){var a=this;var b=c?StAllocate._CONS_.DETAIL_URL:StAllocate._CONS_.EDIT_URL;
FormUtils.loadData(b+"?id="+d,function(e){$("#stAllocateForm input[name=id]").val(e.id);$("#stAllocateForm input[name=name]").val(e.name);$("#stAllocateForm input[name=key]").val(e.key);
$("#stAllocateForm input[name=outId]").val(e.outId);$("#stAllocateForm input[name=inId]").val(e.inId);$("#stAllocateForm input[name=status]").val(e.status);
$("#stAllocateForm select[name=inStoreId").val(e.inStoreId);$("#stAllocateForm select[name=outStoreId").val(e.outStoreId);$("#stAllocateForm input[name=createBy]").val(e.createBy);
$("#stAllocateForm input[name=createTime]").val(e.createTime);$("#stAllocateForm input[name=updateBy]").val(e.updateBy);$("#stAllocateForm input[name=updateTime]").val(e.updateTime);
$("#stAllocateForm input[name=outBillNo]").val(e.outBillNo);$("#stAllocateForm input[name=inBillNo]").val(e.inBillNo);if(e.stBillItemVoList){a._createBillItems(e.stBillItemVoList,"productContainer");
}if(e.status=="confirm"||e.status=="done"||c){ButtonUtils.disableBtn("selectProdBtn");$(".checkItemDelBtn").attr("disabled","disabled");$(".addNewTypeBtn").attr("disabled","disabled");
$(".deleteNewTypeBtn").attr("disabled","disabled");$("#productContainer").find(":input").attr("readonly","readonly");$("#productContainer").find("select").attr("disabled","disabled");
$("#"+StAllocate._CONS_.EDIT_FORM_ID).find(":input").attr("readonly","readonly");$("#"+StAllocate._CONS_.EDIT_FORM_ID).find("select").attr("disabled","disabled");
}});},_save:function(e){if(this.canSubmit){this.canSubmit=false;var d=this;var g=$("#stAllocateForm input[name=id]").val();var a=null;if(g!=null&&g!=""){a=StAllocate._CONS_.SAVE_EDIT_URL;
}else{a=StAllocate._CONS_.SAVE_ADD_URL;}if(e&&e!=null){a=e;}if($("#stAllocateForm").valid()){var c=[];var b=false;if($("#productContainer").find("tr").length<=0){DialogUtils.error(msgCode.ERROR,"请添加要调拨的商品");
d.canSubmit=true;b=true;return false;}$("#productContainer").find("tr").each(function(){var i={};i.skuId=$(this).attr("skuIdVal");i.prodId=$(this).attr("prodIdVal");
i.unit=$(this).find("td:eq(2)").text().trim();i.totalQty=$(this).find("td:eq(3)").text().trim();i.qty=parseInt($(this).find("td:eq(4) input").val());i.position=$(this).find("td:eq(6) input").val();
i.comment=$(this).find("td:eq(7) input").val();i.type="common";if(!/^[0-9]*$/.test(i.qty)){$(this).find("td:eq(4) input").focus();DialogUtils.error(msgCode.ERROR,"良品数量必须大于等于0的整数");
b=true;d.canSubmit=true;return false;}if(i.qty>0){c.push(i);}var j=$(this).find("td:eq(5) input").val();if(j!=null&&j!=""){var h={};h.skuId=$(this).attr("skuIdVal");
h.prodId=$(this).attr("prodIdVal");h.soId=$(this).attr("soIdVal");h.unit=$(this).find("td:eq(2)").text().trim();h.totalQty=$(this).find("td:eq(3)").text().trim();
h.qty=parseInt(j);h.type="bad";h.position=$(this).find("td:eq(6)").text();h.comment=$(this).find("td:eq(7) input").val();if(!/^[0-9]*$/.test(h.qty)){$(this).find("td:eq(5) input").focus();
DialogUtils.error(msgCode.ERROR,"次品数量必须大于等于0的整数");b=true;d.canSubmit=true;return false;}if(i.qty<=0&&h.qty<=0){$(this).find("td:eq(4) input").focus();DialogUtils.error(msgCode.ERROR,"良品数量和次品数量必须有一个大于0");
b=true;d.canSubmit=true;return false;}c.push(h);}});if(b){ButtonUtils.enableBtn("saveBtn");return;}var f=$("#"+StAllocate._CONS_.EDIT_FORM_ID).serialize();
f+="&billItemJson="+JSON.stringify(c);FormUtils.submit(a,f,function(h){d.canSubmit=true;if(h.success){DialogUtils.success(msgCode.INFO,h.msg);d.isEdit=false;
d.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);d.canSubmit=true;});}else{d.canSubmit=true;
}}},_saveNoItem:function(a,c){if(this.canSubmit){var b=this;b.canSubmit=false;var d="";if(c==null||c==""){d=$("#stAllocateForm input[name=id]").val();}else{d=c;
}if(d==null||d==""){DialogUtils.error(msgCode.FAIL_MSG,"id为空！");b.canSubmit=true;return;}FormUtils.submit(a,{id:d},function(e){b.canSubmit=true;if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);b.canSubmit=true;
});}},_toConfirm:function(){var a=StAllocate._CONS_.TO_CONFIRM_URL;this._saveNoItem(a);},_confirm:function(){var a=StAllocate._CONS_.CONFIRM_URL;this._saveNoItem(a);
},_backConfirm:function(b){var a=StAllocate._CONS_.BACK_CONFIRM_URL;this._saveNoItem(a);},_done:function(){var a=StAllocate._CONS_.DONE_URL;this._saveNoItem(a);
},_invalid:function(b){var a=StAllocate._CONS_.IVALIDE_URL;this._saveNoItem(a,b);},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(StAllocate._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$(".stAllocateSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_createBillItems:function(c,a,g){var h=this;if(!c){return false;
}if(g){h._createAdd(c,a);return false;}var f=new StringBuffer();var j=[];for(var b=0;b<c.length;b++){var d=c[b].type?c[b].type:"";if(d=="bad"){j.push(c[b]);
}}for(var b=0;b<c.length;b++){var d=c[b].type?c[b].type:"";if(d!="bad"){f.append(this._appendTr(c[b],j));}}for(var b=0;b<j.length;b++){var e=[];f.append(this._appendTr(j[b],e));
}$("#"+a).append(f.toString());},_appendTr:function(l,m){var k=1;var d=l.position?l.position:"";var e=l.comment?l.comment:"";var j=l.unit?l.unit:"";var a=l.totalQty?l.totalQty:"";
var g=l.badQty?l.badQty:"";if(l.qty){k=l.qty;}var h=new StringBuffer();h.append("<tr prodIdVal='"+l.prodId+"' skuIdVal='"+l.skuId+"'>").append("<td width='12%' title='"+l.prodName+"'>"+(l.prodName.length<=12?l.prodName:(l.prodName.substring(0,10)+"..."))+"</td>").append("<td width='12%'>"+l.skuCode+"</td>").append("<td width='5%'>"+j+"</td>");
h.append("<td class='totalQty' width='10%' >"+a+"</td>");var f=-1;for(var c=0;c<m.length;c++){var b=m[c];if(l.prodId==b.prodId&&l.prodName==b.prodName&&l.skuCode==b.skuCode){f=c;
}}if(l.type=="common"){h.append("<td width='8%'><input class='form-control prodQty' value='"+parseInt(k)+"' placeholder='良品数量'>");}else{h.append("<td width='8%'><input class='form-control prodQty' value='"+0+"' placeholder='良品数量'>");
}h.append("</td>");if(f>=0){var b=m[f];h.append("<td width='8%'><input class='form-control badQty' value='"+parseInt(b.qty)+"' placeholder='次品数量'>");m.splice(f,1);
}else{if(l.type=="bad"){h.append("<td width='8%'><input class='form-control badQty' value='"+parseInt(k)+"' placeholder='次品数量'>");}else{h.append("<td width='8%'><input class='form-control badQty' value='"+0+"' placeholder='次品数量'>");
}}h.append("</td>");h.append("<td width='8%'><input class='form-control' readonly='readonly' value='"+d+"' placeholder='所在仓位'></td>").append("<td width='8%'><button class='btn btn-outline btn-sm btn-danger checkItemDelBtn' type='button'>删除</button></td>");
h.append("</tr>");return h;},_createAdd:function(d,b){if(!d){return;}var h=$("#"+b+" tr");var g=new StringBuffer();for(var f=0;f<d.length;f++){var a=false;
if(h&&h.length>0){for(var e=0;e<h.length;e++){if($(h[e]).attr("skuIdVal")==d[f].skuId){a=true;break;}}}if(a){continue;}var c=[];g.append(this._appendTr(d[f],c));
}$("#"+b).append(g.toString());},_bindEventHander:function(){var a=this;$("#productContainer").on("keyup",".prodQty",function(c){var d=c.keyCode;var b=$(this).parents("tr").find("td:eq(3)").text();
b=parseInt(b);var e=$(this).val();if(!e){DialogUtils.error(msgCode.ERROR,"良品数量必须为大于等于0的整数");$(this).focus();return;}if(!/^\d+(?=\.{0,1}\d+$|$)/.test(e)){DialogUtils.error(msgCode.ERROR,"良品数量必须为大于等于0的整数");
$(this).val(e.replace(/[^\d]/g,""));$(this).focus();return false;}if(e>b){DialogUtils.error(msgCode.ERROR,"良品数量必须不大于库存数量");$(this).val(b);}});$(document).on("keyup",".badQty",function(){var b=$(this).val();
if(!b||parseInt(b)==0){return false;}if(!/^\d+(?=\.{0,1}\d+$|$)/.test(b)){DialogUtils.error(msgCode.ERROR,"次品数量必须为大于等于0的整数");$(this).val(b.replace(/[^\d]/g,""));
$(this).focus();}});$(document).on("click",".addNewTypeBtn",function(){var b=$(this).parents("tr").find("td:eq(5) select:first option:selected").val();
$(this).parents("tr").find("td:eq(4)").append("<input class='form-control badQty' value='"+1+"' placeholder='不良品数量'>");var c=new StringBuffer();c.append("<select class='form-control itemType'  placeholder='项目类型'>");
if(b=="bad"){c.append("<option value='common' selected='selected'>良品</option><option value='bad' >不良品</option>");}else{c.append("<option value='common' >良品</option><option value='bad' selected='selected'>不良品</option>");
}c.append("</select></td>");$(this).parents("tr").find("td:eq(5)").append(c.toString());$(this).removeClass("addNewTypeBtn").addClass("deleteNewTypeBtn").text("取消");
});$(document).on("click",".deleteNewTypeBtn",function(){$(this).removeClass("deleteNewTypeBtn").addClass("addNewTypeBtn").text("添加");$(this).parents("tr").find("td:eq(4) input:last").remove();
$(this).parents("tr").find("td:eq(5) select:last").remove();});$(document).on("change",".itemType",function(){var d=$(this).parent().find("select");if(d.length>1){var c=$(d[0]).find("option:selected").val();
var b=$(d[1]).find("option:selected").val();if(c==b){$(".deleteNewTypeBtn").removeClass("deleteNewTypeBtn").addClass("addNewTypeBtn").text("添加");$(this).parents("tr").find("td:eq(4) input:last").remove();
$(this).parents("tr").find("td:eq(5) select:last").remove();}}});$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){a._save();
});$(document).on("click",".toConfirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定提交审核吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._toConfirm();
}});});$(document).on("click",".confirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定审核通过吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._confirm();
}});});$(document).on("click",".backConfirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定驳回审核吗？",text:"",confirmButtonText:"驳回",yesFunc:function(){a._backConfirm();
}});});$(document).on("click",".doneBtn",function(){DialogUtils.confirmWithOptions({title:"确定完成调库吗？",text:"",confirmButtonText:"完成",yesFunc:function(){a._done();
}});});$(document).on("click",".stAllocateDone",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能同时选择多条记录");return;}}}a._edit(b,"done");
});$(document).on("click",".stAllocateInvalid",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择记录");return;}}DialogUtils.confirmWithOptions({title:"确定作废所选记录吗？",text:"作废后不可更改！",confirmButtonText:"作废",yesFunc:function(){a._invalid(b);
}});});$(document).on("mouseover","td[aria-describedby='stAllocateGrid_name']",function(){var b=$(this);var c=b.find(".name_value").attr("title");b.attr("title",c);
});$("#"+StAllocate._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+StAllocate._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+StAllocate._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#storeIdSearchContainer1").on("change",function(){$("#productContainer").empty();
var c=$("#storeIdSearchContainer1").val();var b=$("#storeIdSearchContainer2").val();if(c==b){DialogUtils.error(msgCode.ERROR,"所选仓库不能一样！");$("#storeIdSearchContainer1").val("");
}});$("#storeIdSearchContainer2").on("change",function(){var c=$("#storeIdSearchContainer1").val();var b=$("#storeIdSearchContainer2").val();if(c==b){DialogUtils.error(msgCode.ERROR,"所选仓库不能一样！");
$("#storeIdSearchContainer2").val("");}});$(".list_wrapper").on("click",".stAllocateSearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);
});$("#stAllocateSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".stAllocateSearch").trigger("click");return false;}});$("body").on("click",".stAllocateAdd",function(){a._add();
});$("body").on("click",".stAllocateEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}var c=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b);a.data=c;a._edit(b,"edit");});$("body").on("click",".stAllocateToConfirm",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b,"awaiting_confirm");});$("body").on("click",".stAllocateConfirm",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b,"confirm");});$("#productContainer").on("click",".checkItemDelBtn",function(){$(this).parents("tr").remove();
});$("body").on("click",".stAllocateDel",function(){var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}if(b instanceof Array){for(var c=0;c<b.length;c++){var d=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b[c]);if(!(d.status=="draft"||d.status=="waiting_audit")){DialogUtils.error(msgCode.info,"所选数据存在不可删除数据");
return;}}}else{var d=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b);if(!(d.status=="draft"||d.status=="waiting_audit")){DialogUtils.error(msgCode.info,"所选数据存在不可删除数据");
return;}}a._delete(b);});$("body").on("click",".stAllocateDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("body").on("click",".stAllocateExport",function(){var c=$(this).attr("idVal");if(!c){c=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.ERROR,"不能同时选择多条数据");
return;}}}var d=$("#"+c).find("td:eq(2)").attr("title");var b=StAllocate._CONS_.EXPORT_URL;FormUtils.submit(b,"id="+c,function(e){if(e.success){DialogUtils.success(msgCode.INFO,"成功");
JTTabUtils.addOrRefreshTab(ctx+e.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D","调库单["+d+"]");}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".showDetail",function(){var b=$(this).parents("tr").attr("id");
a._detail(b);});$("#selectProdBtn").on("click",function(){var b=$("#storeIdSearchContainer1").val();if(!b){DialogUtils.error(msgCode.ERROR,"请选择仓库");return;
}SelectProdService.selectSku({storeId:b,isMultiple:1,type:a.prodType,canSale:"y",hasStock:"y",fn:function(c){a._createBillItems(c,"productContainer",true);
}});});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");FormUtils.clear("#"+b);});},_bindFormValidation:function(){var a={rules:{name:{required:true},outStoreId:{required:true},inStoreId:{required:true}},messages:{}};
FormUtils.bindFormValidation(StAllocate._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(StAllocate._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
if(ResUtils.canShow("stAllocate.button.edit")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["编辑"]],btnClasses:[["btn btn-primary stAllocateEdit"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("stAllocate.button.done")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["完成"]],btnClasses:[["btn btn-primary stAllocateDone"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("stAllocate.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary stAllocateDetail",iconClasses:"fa fa-list"});
}if(ResUtils.canShow("stAllocate.button.delete")){a.push({switchCol:{colName:"status",colVals:["draft","awaiting_confirm","confirm","invalid"],colLables:[["删除"],["删除"],["删除"],["删除"]],btnClasses:[["btn btn-danger stAllocateDel"],["btn btn-danger stAllocateDel"],["btn btn-danger stAllocateDel"],["btn btn-danger stAllocateDel"]],iconClasses:[["fa fa-remove"],["fa fa-remove"],["fa fa-remove"],["fa fa-remove"]]}});
}if(ResUtils.canShow("stAllocate.button.export")){a.push({lable:"导出单据",btnClasses:"btn btn-primary stAllocateExport",iconClasses:"fa fa-list"});}return a;
},onSelectRow:function(){var b=$(StAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){$(".stAllocateDone").attr("disabled","disabled");
$(".stAllocateToConfirm").attr("disabled",true);$(".stAllocateEdit").attr("disabled",true);$(".stAllocateDel").attr("disabled",true);$(".stAllocateDetail").attr("disabled",true);
$(".stAllocateExport").attr("disabled",true);}else{if(b.length==1){var e=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b);if(e.status=="draft"){$(".stAllocateEdit").attr("disabled",false);
$(".stAllocateDel").attr("disabled",false);$(".stAllocateDone").attr("disabled",false);}if(e.status=="done"){$(".stAllocateExport").attr("disabled",false);
}$(".stAllocateDetail").attr("disabled",false);}else{$(".stAllocateDetail").attr("disabled",true);$(".stAllocateEdit").attr("disabled",true);$(".stAllocateDone").attr("disabled",true);
$(".stAllocateExport").attr("disabled",true);var a=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b[0]).status;for(var d=1;d<b.length;d++){var c=$(StAllocate._CONS_.GRID).jqGrid("getRowData",b[d]).status;
if(a!=c){$(".stAllocateDel").attr("disabled",true);return;}}if(a=="draft"){$(".stAllocateDel").attr("disabled",false);}}}},_initJqgrid:function(c){var a=this;
var b=new Date();b.setMonth(b.getMonth()-1);b=b.currentDate()+" 00:00:00";$("#startTimeSearch").val(b);if(c==null||typeof c==undefined){c={"Q__D__BW__allocate.create_time_":b};
}$(StAllocate._CONS_.GRID).JTJqgrid({url:StAllocate._CONS_.LIST_DATA_URL,pager:StAllocate._CONS_.PAGER,postData:c,colNames:["单据","名称","出库单号","入库单号","出库仓库","入库仓库","出库单ID","入库单ID","状态","状态","创建者","创建时间","操作"],colModel:[{name:"key",index:"key_",width:120,formatter:function(d){return"<a href='javascript:void(0)' class='showDetail'>"+d+"</a>";
}},{name:"name",index:"name_",width:120,formatter:function(d){var e='<lable class ="name_value" title="'+d+'">';if(d&&d.length>10){return e+d.substring(0,8)+"..."+"</lable>";
}else{return d;}}},{name:"outBillNo",index:"out_id_",width:120},{name:"inBillNo",index:"in_id_",width:120},{name:"outStoreName",index:"out_store_id",width:120,sortable:false},{name:"inStoreName",index:"in_store_id",width:120,sortable:false},{name:"outId",index:"out_id_",width:120,hidden:true},{name:"inId",index:"in_id_",width:120,hidden:true},{name:"status",index:"status_",width:60,formatter:function(d){if(d=="draft"){return"<span class='muted'>草稿</span>";
}else{if(d=="awaiting_confirm"){return"待审核";}else{if(d=="confirm"){return"<span class='text-info'>已审核</span>";}else{if(d=="invalid"){return"<span class='text-danger'>作废</span>";
}else{if(d=="done"){return"<span class='text-success'>完成</span>";}else{return"";}}}}}}},{name:"status",index:"status_",width:120,hidden:true},{name:"createBy",index:"create_by_",width:120,classes:"autoHideCol"},{name:"createTime",index:"create_time_",width:100,classes:"autoHideCol",formatter:function(d){return DateUtils.miniTime(d);
}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],onSelectRow:function(e,d){a.onSelectRow(e,d);
},});}};