$(function(){var a=new StStore();a.init();});function StStore(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.addressService=new AddressService("shopAddrOptForm_cateContainer");
this.stStoreAddr=new StStoreAddr();this.isManyStore=isManyStore?isManyStore:"y";}StStore._CONS_={EDIT_URL:ctx+"/ec/stock/stStore/edit.htm",DETAIL_URL:ctx+"/ec/stock/stStore/detail.htm",DELETE_URL:ctx+"/ec/stock/stStore/delete.htm",SAVE_ADD_URL:ctx+"/ec/stock/stStore/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/stock/stStore/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/stock/stStore/listData.htm",FIND_ONE:ctx+"/ec/stock/stStore/findOne.htm",INIT_SELECT_PROVINCE:ctx+"/ec/stock/stStore/initSelectProvince.htm",PROVINCE_LIST_URL:ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm",EDIT_FORM_ID:"stStoreForm",GRID:"#stStoreGrid",PAGER:"#stStorePager",};
StStore.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();if(this.isManyStore=="n"){this._showStoreInfor();
}else{this._initJqgrid(a);this._hideNotGrantBtn();}this.stStoreAddr.init();this._locateToGlHelp();this._initSelectProvince();this.initProSelect("ChinaCityCateType-root","provinceId");
}},_locateToGlHelp:function(){var a="glHelp.systemconfig.stockManage";glHelpUtil.init(a);},_initSelectProvince:function(b){var a=StStore._CONS_.INIT_SELECT_PROVINCE+"?parentKey=ChinaCityCateType-root&typeKey=AddressCateType";
FormUtils.loadData(a,function(c){var g=new StringBuffer();for(var e=0;e<c.length;e++){var f=c[e].id;var d=c[e].subName;g.append("<option value='"+f+"'>"+d+"</option>");
}$("#manageProvince").empty().append(g.toString()).attr("multiple",true).chosen("destroy").chosen();});},initProSelect:function(b,c){var a=StStore._CONS_.PROVINCE_LIST_URL+"?cateType=AddressCateType&parentKey="+b;
FormUtils.loadData(a,function(f){if(f.success){if(f.msg!=null&&f.msg!=""){var g=new StringBuffer();var e=JSON.parse(f.msg);if(e&&e.length>0){g.append("<select class='form-control' name='"+c+"'>");
g.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){g.append("<option idValue='"+e[d].id+"' value='"+e[d].value+"'>"+e[d].name+"</option>");
}$("#prContainer").append(g.toString());}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_showStoreInfor:function(){this._showFormWrapper();
$(".form_wrapper .prevBtn").remove();$(".hiddenWhenStandard").hide();this._loadStoreData();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("stStore.button.detail")){$(".stStoreDetail").hide();
}if(!ResUtils.canShow("stStore.button.add")){$(".stStoreAdd").hide();}if(!ResUtils.canShow("stStore.button.edit")){$(".stStoreEdit").hide();}if(!ResUtils.canShow("stStore.button.delete")){$(".stStoreDel").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$(".region-addr").empty();
$(".showWhenIsSale").show();$(".addRegion").attr("disabled",false);$("#selectMgr").attr("disabled",false);$("#selectNotify").attr("disabled",false);$(".chosen-choices").empty();
FormUtils.clear(StStore._CONS_.EDIT_FORM_ID);FormUtils.enableForm(StStore._CONS_.EDIT_FORM_ID);a.stStoreAddr.clear();if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_add:function(){this._showFormWrapper();this.addressService.init();this.stStoreAddr.loadData();},_edit:function(a){this._showFormWrapper();
this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a,true);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(StStore._CONS_.EDIT_FORM_ID);
},_loadData:function(d,b){var a=this;var c=b?StStore._CONS_.DETAIL_URL:StStore._CONS_.EDIT_URL;FormUtils.loadData(c+"?id="+d,function(e){a._setData(e,b);
});},_loadStoreData:function(){var a=this;var b=StStore._CONS_.FIND_ONE;FormUtils.loadData(b,function(c){a._setData(c);});},_setData:function(c,b){var a=this;
$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=id]").val(c.id);$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=name]").val(c.name);$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=mgrId]").val(c.mgrId);
$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=mgrName]").val(c.mgrName);$("#"+StStore._CONS_.EDIT_FORM_ID+" textarea[name='comment']").val(c.comment);
$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=createTime]").val(c.createTime);$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=updateTime]").val(c.updateTime);
$("#"+StStore._CONS_.EDIT_FORM_ID+" select[name=isSale]").val(c.isSale);$("#"+StStore._CONS_.EDIT_FORM_ID+" select[name=isDefault]").val(c.isDefault);$("#"+StStore._CONS_.EDIT_FORM_ID+" input[name=code]").val(c.code);
$("#"+StStore._CONS_.EDIT_FORM_ID+" select[name=provinceId]").val(c.provinceId);a._setNotifyValue(c.employeePos,b);a.stStoreAddr.loadData(c,b);if(c.isSale=="y"){$(".showWhenIsSale").show();
}else{$(".showWhenIsSale").hide();}if(b){$(".addRegion").attr("disabled",true);$("#selectMgr").attr("disabled",true);$("#selectNotify").attr("disabled",true);
}a._loadRegion(c.stStoreRegionPos,b);},_loadRegion:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];var e={country:d.countryId,province:d.provinceId,city:d.cityId,area:d.arRid,isHideCountry:false};
if(b){e.disabled=true;}this._loadRegionData(e,b);}},_loadRegionData:function(c,a){var e=new StringBuffer();var d=Math.random()+"_shopAddrOptForm_cateContainer";
d=d.replace(".","1");e.append("<tr><td><div claa='form-group'>").append("<div class='col-sm-12' id='"+d+"'></div></div></td>");if(a){e.append("<td><button type='button' class='jt-btn-error delete' disabled='disabled'>删除</button></td></tr>");
}else{e.append("<td><button type='button' class='jt-btn-error delete'>删除</button></td></tr>");}$(".region-addr").append(e.toString());var b=new AddressService(d);
b.init(c);},_save:function(){var b=this;var f=$("#id").val();var a=null;if(f!=null&&f!=""){a=StStore._CONS_.SAVE_EDIT_URL;}else{a=StStore._CONS_.SAVE_ADD_URL;
}b._getNotifyValue();if($("#stStoreForm").valid()){ButtonUtils.disableBtn("saveBtn");var c=[];$(".region-addr").find("tr").each(function(){var h={};var k="";
var g="";var j="";var i="";k=$(this).find("td:eq(0) select:eq(0)");h.countryId=k.val();h.countryName=k.find("option:selected").text();g=$(this).find("td:eq(0) select:eq(1)");
h.provinceId=g.val();h.prName=g.find("option:selected").text();j=$(this).find("td:eq(0) select:eq(2)");h.cityId=j.val();h.ciName=j.find("option:selected").text();
i=$(this).find("td:eq(0) select:eq(3)");h.arRid=i.val();h.arName=i.find("option:selected").text();if(h.provinceId!=null&&h.provinceId!=""){c.push(h);}});
var d=$("#"+StStore._CONS_.EDIT_FORM_ID+" select[name=provinceId]").find("option:selected").text();var e=$("#"+StStore._CONS_.EDIT_FORM_ID).serialize();
e+="&prName="+d;e+="&regionItemJson="+JSON.stringify(c);if(b.isManyStore=="n"){$(".nav.nav-tabs li").eq(0).find("a").trigger("click");}FormUtils.submit(a,e,function(g){ButtonUtils.enableBtn("saveBtn");
if(g.success){if(g.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(g.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;if(b.isManyStore=="y"){b.clear(true);}}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(StStore._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"删除成功");
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){a._save();});$(document).on("mouseover","td[aria-describedby='stStoreGrid_address']",function(){var b=$(this);
var c=b.find(".address_value").attr("title");b.attr("title",c);});$("#"+StStore._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+StStore._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+StStore._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+StStore._CONS_.EDIT_FORM_ID).on("change","select[name='isSale']",function(){var b=$(this).val();if(b=="y"){$(".showWhenIsSale").show();}else{$(".showWhenIsSale").hide();
$("select[name=isDefault]").val("n");$(".region-addr").empty();}});$(".list_wrapper").on("click",".stStoreSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#stStoreSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);
return false;}});$("body").on("click",".stStoreAdd",function(){a._add();});$("body").on("click",".stStoreEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(StStore._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".stStoreDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(StStore._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".stStoreDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StStore._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("#selectMgr").on("click",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.stock")){b:1;}var d={isShowAllGroup:b,grantType:"/stock/",isMultiple:0,isSale:0,callBack:function(e){if(e!=null){if(e.length>0){$("input[name=mgrName]").val(e[0].aid+":"+e[0].name);
$("input[name=mgrId]").val(e[0].id);$("input[name=mgrName]").keyup();}}}};var c=new EmployeesSelect();c.init(d);});$("#selectNotify").on("click",function(){var c=$("input[name=notifyIds]").val();
var e=c?c.split(","):[];var b=0;if(ResUtils.canShow("employeeSelector.button.stock")){b:1;}var f={isShowAllGroup:b,grantType:"/stock/",isMultiple:1,isSale:0,selectedId:e,callBack:function(g){if(g!=null){if(g.length>0){a._setNotifyValue(g);
}}}};var d=new EmployeesSelect();d.init(f);});$(document).on("click",".showDetail",function(){var b=$(this).parents("tr").attr("id");a._detail(b);});$("body").on("click",".addRegion",function(){a._loadRegionData();
});$("body").on("click",".delete",function(){$(this).parents("tr").remove();});$(document).on("click",".search-choice-close",function(){$(this).parent("li").remove();
});},_setNotifyValue:function(g,b){var a=false;if(!g||g==null){return;}for(var d=0;d<g.length;d++){var e=$(".chosen-choices").find("li");var f=false;for(var c=0;
c<e.length;c++){if(g[d].id==$(e[c]).attr("id")){a=true;f=true;continue;}}if(f){continue;}var h="<li  id='"+g[d].id+"'nameVal='"+g[d].aid+":"+g[d].name+"' class='search-choice'><span>";
h+=g[d].aid+":"+g[d].name+"</span>";if(!b){h+="<a class='search-choice-close' ></a>";}h+="</li>";$(".chosen-choices").append(h);}if(a){DialogUtils.error(msgCode.error,"重复员工直接过滤掉！");
}},_getNotifyValue:function(){var b=$(".chosen-choices").find("li");var c=[];for(var a=0;a<b.length;a++){c.push($(b[a]).attr("id"));}$("input[name='notifyIds'").val(c);
},_bindFormValidation:function(){var a={rules:{name:{required:true},code:{required:true},address:{required:true},mgrName:{required:true},provinceId:{required:true}},messages:{}};
FormUtils.bindFormValidation(StStore._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(StStore._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
if(ResUtils.canShow("stStore.button.edit")){a.push({lable:msgCode.EDIT_BTN_TEXT,btnClasses:"btn btn-primary stStoreEdit",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("stStore.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary stStoreDetail",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("stStore.button.delete")){a.push({switchCol:{colName:"isDefault",colVals:["n"],colLables:[["删除"]],btnClasses:[["btn btn-danger stStoreDel"]],iconClasses:[["fa fa-remove"]]}});
}return a;},onSelectRow:function(e,a){var b=$(StStore._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){$(".stStoreEdit").attr("disabled",true);
$(".stStoreDetail").attr("disabled",true);$(".stStoreDel").attr("disabled",true);}else{if(b.length==1){var g=$(StStore._CONS_.GRID).jqGrid("getRowData",b);
if(g.isDefault=="n"){$(".stStoreDel").attr("disabled",false);}$(".stStoreEdit").attr("disabled",false);$(".stStoreDetail").attr("disabled",false);}else{var f=$(StStore._CONS_.GRID).jqGrid("getRowData",b[0]).isDefault;
for(var d=1;d<b.length;d++){var c=$(StStore._CONS_.GRID).jqGrid("getRowData",b[d]).isDefault;if(a!=status2){$(".stStoreDel").attr("disabled",true);return;
}$(".stStoreEdit").attr("disabled",true);$(".stStoreDetail").attr("disabled",true);}}}},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};}$(StStore._CONS_.GRID).JTJqgrid({url:StStore._CONS_.LIST_DATA_URL,pager:StStore._CONS_.PAGER,postData:a,colNames:["名称","编码","负责人","备注","是否销售仓","是否默认","所在省份","创建时间","更新时间","操作"],colModel:[{name:"name",index:"name_",width:120,formatter:function(b){return"<a href='#' class='showDetail'>"+b+"</a>";
}},{name:"code",index:"code_",width:100},{name:"mgrName",index:"mgr_name_",width:100},{name:"comment",index:"comment_",width:220,hidden:true},{name:"isSale",index:"is_sale_",width:80,formatter:function(b){if(b=="y"){return"<label class='label label-primary'>是</label>";
}else{return"<label class='label label-danger'>否</label>";}}},{name:"isDefault",index:"is_default_",width:80,formatter:function(b){if(b=="y"){return"<label class='label label-primary'>是</label>";
}else{return"<label class='label label-danger'>否</label>";}}},{name:"prName",index:"pr_name_",width:80},{name:"createTime",index:"create_time_",width:100,formatter:function(b){return DateUtils.miniTime(b);
}},{name:"updateTime",index:"update_time_",width:100,classes:"autoHideCol",formatter:function(b){return DateUtils.miniTime(b);}},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],onSelectRow:function(c,b){self.onSelectRow(c,b);
}});}};