$(function(){var a=new BuyList();a.init();});function BuyList(){this.hadInit=false;this.isEdit=false;this.regQty=/^[0-9]*[1-9][0-9]*$/;this.regPrice=/^\d+(\.\d{0,2})?$/;
this.needrefresh=false;}BuyList._CONS_={LIST_DATA_URL:ctx+"/ec/stock/stBill/listWithItemData.htm",CONFIRM_URL:ctx+"/ec/stock/stBill/confirm.htm",BACK_CONFIRM_URL:ctx+"/ec/stock/stBill/backConfirm.htm",IN_STOCK_URL:ctx+"/ec/stock/stBill/inStock.htm",BATCH_IN_STOCK_URL:ctx+"/ec/stock/stBill/batchInStock.htm",DONE_STOCK_URL:ctx+"/ec/stock/stBill/done.htm",EXPORT_URL:ctx+"/ec/stock/stBill/export.htm",SAVE_SHIPPINGFEE:ctx+"/ec/stock/stBill/saveShippingFee.htm",SAVE_PRICE:ctx+"/ec/stock/stBill/savePrice.htm",LOAD_DETAIL_URL:ctx+"/ec/stock/stStock/billHistoryData.htm",BACK_STOCK_URL:ctx+"/ec/stock/stStock/back.htm",DELETE_URL:ctx+"/ec/stock/stBill/delete.htm",EXPORT_STBILL_URL:ctx+"/ec/stock/stBill/stBillExport.htm",GRID:"#buyListGrid",PAGER:"#buyListPager",};
BuyList.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();StoreUtils.loadStores("","storeIdSearchContainer");
StoreUtils.loadData({container:"storeSearch",isSale:false});this._locateToGlHelp();}},_locateToGlHelp:function(){var a="glHelp.stock.stBill";glHelpUtil.init(a);
},_hideNotGrantBtn:function(){if(!ResUtils.canShow("stBill.button.confirm")){$("button.stBillConfirm").hide();}if(!ResUtils.canShow("stBill.button.export")){$("button.stBillExport").hide();
}if(!ResUtils.canShow("stBill.button.inStock")){$("button.stBillDone").hide();}if(!ResUtils.canShow("stBill.button.backConfirm")){$("button.stBillBackConfirm").hide();
}if(!ResUtils.canShow("stBill.button.stBillRemove")){$("button.stBillRemove").hide();}if(!ResUtils.canShow("stBill.button.batchInStock")){$("button.batchInStock").hide();
}},clear:function(c){var a=this;function b(){if(c){$(".stBillSearch").trigger("click");}}b();},_saveShippingFee:function(c,b){var a=BuyList._CONS_.SAVE_SHIPPINGFEE;
FormUtils.submit(a,{id:c,shippingFee:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_savePrice:function(c,b){var a=BuyList._CONS_.SAVE_PRICE;FormUtils.submit(a,{id:c,price:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_confrim:function(b){var a=BuyList._CONS_.CONFIRM_URL;FormUtils.submit(a,{ids:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"单据已完成");
$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_done:function(b){var a=BuyList._CONS_.DONE_STOCK_URL;FormUtils.submit(a,{ids:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"入库成功");$(".stBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_delete:function(b){var a=BuyList._CONS_.DELETE_URL;
FormUtils.del(a,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"删除成功");$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_backConfrim:function(b){var a=BuyList._CONS_.BACK_CONFIRM_URL;FormUtils.submit(a,{ids:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,"撤销成功");
$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_bindEventHander:function(){var a=this;$("body").on("click",".tabli",function(){var b=$(this).attr("id");if(b=="buyListTabLi"){$(".stBillSearch").trigger("click");
}else{if(b=="billHistoryTabLi"){$(".historySearch").trigger("click");}}});$("body").on("click",".stBillConfirm",function(){var b=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");
var d=[];var f={};for(var c=0;c<b.length;c++){var e=$(BuyList._CONS_.GRID).jqGrid("getRowData",b[c]);if(!(e.status=="draft"||e.status=="confirm")){DialogUtils.error(msgCode.ERROR,"只有未完成的才能够完成");
return false;}if(!f[e["id"]]){d.push(e["id"]);}}if(d.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");return false;}DialogUtils.confirmWithOptions({title:"确定完成所选记录吗？",text:"完成后不可更改！",confirmButtonText:"完成",yesFunc:function(){a._confrim(d);
}});});$("body").on("click",".stBillBackConfirm",function(){var b=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");var d=[];var f={};for(var c=0;
c<b.length;c++){var e=$(BuyList._CONS_.GRID).jqGrid("getRowData",b[c]);if(e.status!="done"){DialogUtils.error(msgCode.ERROR,"只有已完成才能够撤销完成");return false;
}if(!f[e["id"]]){d.push(e["id"]);}}if(d.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");return false;}DialogUtils.confirmWithOptions({title:"确定撤销所选记录吗？",text:"",confirmButtonText:"撤销",yesFunc:function(){a._backConfrim(d);
}});});$("body").on("click",".stBillRemove",function(){var b=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要删除的记录");
return false;}var d=[];var f={};for(var c=0;c<b.length;c++){var e=$(BuyList._CONS_.GRID).jqGrid("getRowData",b[c]);if(!f[e["id"]]){d.push(e["id"]);}}DialogUtils.confirmWithOptions({title:"确定删除记录吗？",text:"删除后不可更改！",confirmButtonText:"删除",yesFunc:function(){a._delete(d);
}});});$("body").on("click",".stBillExport",function(){ButtonUtils.disableBtn("stBillExport");DialogUtils.success(msgCode.SUCCESS,"正在导出....");var b=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");
var g=$("#stBillSearchForm").serialize()+"&Q__S__EQ__bill.type_=in";var d=[];var f={};for(var c=0;c<b.length;c++){var e=$(BuyList._CONS_.GRID).jqGrid("getRowData",b[c]);
if(!f[e["id"]]){d.push(e["id"]);}}if(b){g+="&Q__S__IN__bill.id_="+d;}ButtonUtils.enableBtn("stBillExport");FormUtils.submit(BuyList._CONS_.EXPORT_STBILL_URL,g,function(h){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);});$("body").on("click",".stBillDone",function(){var b=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");var d=[];var f={};for(var c=0;
c<b.length;c++){var e=$(BuyList._CONS_.GRID).jqGrid("getRowData",b[c]);if(e.status!="draft"){DialogUtils.error(msgCode.ERROR,"只有未完成的才能入库");return false;
}if(!f[b[c]]){d.push(b[c]);}}if(d.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");return false;}DialogUtils.confirmWithOptions({title:"确定入库所选记录吗？",text:"入库后不可更改！",confirmButtonText:"入库",yesFunc:function(){a._done(d);
}});});$(".list_wrapper").on("click",".stBillSearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");
FormUtils.clear("#"+b);});$(document).on("blur",".shippingFeeInput",function(){var b=$(this).val();var c=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");
if(b!=c){a._saveShippingFee(d,b);$(this).attr("org-value",b);}});$(document).on("blur",".priceInput",function(){var c=$(this).val();var b=$(this).attr("org-value");
var d=$(this).attr("item-id");if(c!=b){a._savePrice(d,c);$(this).attr("org-value",c);}});$(document).on("click",".inStockBtn",function(){var h=$(this).parents("tr").find(".buyQty");
var d=h.val();var b=h.attr("org-value");var g=h.attr("bill-id");var f=h.attr("item-id");var c=$(this).parents("tr").find(".priceInput").val();var e={value:d,billId:g,itemId:f,price:c};
a._doInStock(h,b,e);});$(document).on("change",".buyQty",function(){$(this).attr("value",$(this).val());});$(document).on("click",".batchInStock",function(){var l={};
var b=0;var d=$(BuyList._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(d.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要操作的记录");return false;}for(var f=0;
f<d.length;f++){l[d[f]]=d[f];var c=$(BuyList._CONS_.GRID).jqGrid("getRowData",d[f]);var g=$("#buyListGrid tbody").find("tr:gt(0)");for(var e=0;e<g.length;
e++){var h=$(g[e]).find("td[aria-describedby='buyListGrid_id']").html();var m=$(g[e]).find("td[aria-describedby='buyListGrid_itemId']").html();if(h==c["id"]&&m!=c["itemId"]){$(g[e]).attr("aria-selected","true");
l[m]=m;}}}var k=[];$.each(l,function(i,o){var n=$(BuyList._CONS_.GRID).jqGrid("getRowData",o);var p=$(".buyQtyValueDiv").empty().append($(BuyList._CONS_.GRID).getCell(o,"buyQty").toString()).find(".buyQty").val();
var j={qty:p,id:n["id"],itemId:n["itemId"]};k.push(j);if(n["inQty"]>0){b++;}});if(b>0){DialogUtils.error(msgCode.ERROR,"商品已完成入库");return false;}else{a._batchInStock(k);
}});$(document).on("click",".showDetail",function(){var c=$(this).attr("bill-id");var b=$(this).attr("bill-code");$("#historyCaption").empty().append("单据【"+b+"】入库明细");
a._showHistory(c);});$("body").on("click",".preBtn",function(){$(".detail-pannel").hide();$(".list-pannel").show();if(a.needrefresh){$(".stBillSearch").trigger("click");
}a.needrefresh=false;});$(document).on("click",".backBtn",function(){var b=$(this).attr("log-id");var c=[];c.push(b);var d=$(this);a._backFromStock(c,function(){d.parents("tr").empty();
});});},_backFromStock:function(c,b){this.needrefresh=true;var a=BuyList._CONS_.BACK_STOCK_URL;FormUtils.submit(a,{ids:c},function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
if(b&&typeof b=="function"){b();}}else{DialogUtils.error(msgCode.ERROR,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_showHistory:function(c){var a=this;
$(".list-pannel").hide();$(".detail-pannel").show();$("#historyBodyContainer").empty();var b=BuyHistory._CONS_.LIST_DATA_URL;FormUtils.loadData(b+"?Q__S__EQ__bill.id_="+c+"&rows=-1",function(f){var e=f.rows;
var g=new StringBuffer();for(var d=0;d<e.length;d++){g.append("<tr id="+e[d].id+">").append("<td>").append("</td>").append("<td>").append(e[d].skuCode).append("</td>").append("<td>").append(e[d].prodName).append("</td>").append("<td>").append(e[d].qty).append("</td>").append("<td>").append(e[d].price).append("</td>").append("<td>").append(e[d].storeName).append("</td>").append("<td>").append(DateUtils.miniTime(e[d].createTime)).append("</td>").append("<td>").append(a._getOperate(e[d])).append("</td>").append("</tr>");
}$("#historyBodyContainer").append(g.toString());});},_getOperate:function(a){if(ResUtils.canShow("stBill.button.backStock")){return"<button type='button'log-id='"+a.id+"'  class='jt-btn jt-btn-red backBtn'><i class='fa fa-reply'></i>&nbsp;撤销</button>";
}else{return"";}},_doInStock:function(b,a,c){if(parseInt(c.value)<=0){DialogUtils.error(msgCode.FAIL_MSG,"请输入大于0的整数");$(b).focus();return false;}DialogUtils.confirmWithOptions({title:"确定入库吗？",text:"入库后不可更改！",confirmButtonText:"入库",yesFunc:function(){var d=BuyList._CONS_.IN_STOCK_URL;
FormUtils.submit(d,c,function(g){if(g.success){DialogUtils.success(msgCode.INFO,g.msg);var f=$("#"+c.itemId).find("td[aria-describedby='buyListGrid_inQty']");
var e=parseInt(f.text());f.empty().append(e+parseInt(c.value));b.val(0);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});},_batchInStock:function(a){DialogUtils.confirmWithOptions({title:"确定入库吗？",text:"入库后不可更改！",confirmButtonText:"入库",yesFunc:function(){var b=BuyList._CONS_.BATCH_IN_STOCK_URL;
FormUtils.submit(b,"stBillJson="+JSON.stringify(a),function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);$(".stBillSearch").trigger("click");
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(BuyList._CONS_.GRID,a);
this.onSelectRow();},onSelectRow:function(d,a){$("#"+d).removeClass("success");var c=$("tr.success");for(var b=0;b<c.length;b++){if($(c[b]).find("input[type='checkbox']").length<=0){$(c[b]).removeClass("success");
$("#"+d).addClass("success");}}},_initJqgrid:function(e){var a=this;if(e==null||typeof e==undefined){e={};}var c=!ResUtils.canShow("stBill.button.price");
var b=!ResUtils.canShow("stBill.button.total");var d=new Date();d.setMonth(d.getMonth()-1);$(".startTimeSearch").val(DateUtils.format(d,"yyyy-MM-dd"));
e["Q__D__BW__bill.create_time_"]=DateUtils.format(d,"yyyy-MM-dd");$(BuyList._CONS_.GRID).JTJqgrid({url:BuyList._CONS_.LIST_DATA_URL+"?Q__S__EQ__bill.type_=in",pager:BuyList._CONS_.PAGER,postData:e,userDataOnFooter:true,colNames:["id","单据号码","产品编码","产品名称","itemId","仓库","采购量","单价(元)","运费(元)","已入库","总数量","合计","备注","创建时间","状态","状态","隐藏","操作"],colModel:[{name:"id",index:"id_",width:700,hidden:true},{name:"code",index:"code_",width:90,formatter:function(f,g,h){if(h.hideCheckBox=="y"){return"";
}return"<a href='javascript:void(0)' class='showDetail' bill-code='"+f+"' bill-status='"+h.status+"' bill-id='"+h.id+"'>"+f+"</a>"+((h.status=="done")?"【<span style='color:green;'>已</span>】":"【<span style='color:red;'>未</span>】");
}},{name:"skuCode",index:"sku.code_",width:80,sortable:false},{name:"prodName",index:"prod.name_",width:120,sortable:false},{name:"itemId",index:"itemId",width:700,hidden:true,key:true},{name:"storeName",index:"store_id_",width:90,sortable:false},{name:"buyQty",index:"item.qty_",width:120,sortable:false,formatter:function(g,h,j){var i=j.qty-j.inQty;
var f=j.status;if(i<0){i=0;}if((f=="draft"||f=="confirm")&&ResUtils.canShow("stBill.button.inStock")){return"<input style='width:50%' class = 'buyQty' type ='number' org-value='"+i+"' bill-id='"+j.id+"' item-id='"+j.itemId+"' value='"+i+"'><button type='button' class='btn btn-sm  btn-primary inStockBtn' style='margin-left:2px;'>入库</button>";
}else{return i;}}},{name:"price",index:"bill.price_",width:80,sortable:false,hidden:c,formatter:function(g,h,i){var f=i.status;if((f=="draft"||f=="confirm")&&ResUtils.canShow("stBill.button.editPrice")){return"<input style='width:90%' class = 'priceInput' type ='number' org-value='"+g+"' item-id='"+i.itemId+"' value='"+g+"'>";
}else{return g;}}},{name:"shippingFee",index:"shipping_fee_",width:80,sortable:false,formatter:function(g,h,i){if(i.hideCheckBox=="y"){return"";}var f=i.status;
if((f=="draft"||f=="confirm")&&ResUtils.canShow("stBill.button.editShippingFee")){return"<input style='width:90%' class = 'shippingFeeInput' type ='text' org-value='"+g+"' value='"+g+"'>";
}else{return g;}}},{name:"inQty",index:"item.qty_",width:80,sortable:false},{name:"qty",index:"item.qty_",width:80,sortable:false},{name:"total",width:80,sortable:false,hidden:b,formatter:function(f,g,h){return parseFloat(h.qty)*parseFloat(h.price);
}},{name:"comment",index:"bill.comment_",width:120,sortable:false,formatter:function(f,g,h){if(h.hideCheckBox=="y"){return"";}return f;}},{name:"createTime",index:"create_time_",width:110,formatter:function(f,g,h){if(h.hideCheckBox=="y"){return"";
}return DateUtils.miniTime(f);}},{name:"statusShow",index:"status_",width:60,sortable:false,formatter:function(f,g,h){if(h.hideCheckBox=="y"){return"";
}if(h.status=="awaiting_confirm"){return"<span class='text-danger'>未完成</span>";}else{if(h.status=="confirm"){return"<span class='text-danger'>未完成</span>";
}else{if(h.status=="draft"){return"<span class='text-danger'>未完成</span>";}else{if(h.status=="done"){return"<span class='text-info'>已完成</span>";}else{if(h.status=="invalid"){return"<span class='text-danger'>作废</span>";
}else{return h.status;}}}}}}},{name:"status",index:"status_",width:120,hidden:true},{name:"hideCheckBox",width:120,hidden:true},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:[]}],gridComplete:function(){var k=$(".jqGrid_wrapper").find("tr.footrow");
k.find("td").hide();k.find('td[aria-describedby*="_id"]').show();var h=$("#buyListGrid tbody").find("tr:gt(0)").find("td[aria-describedby='buyListGrid_hideCheckBox']");
for(var f=0;f<h.length;f++){var j=$(h[f]);var g=j.text();if(g=="y"){$(j).parents("tr").find("input[type='checkbox']").hide();}}},onSelectRow:function(g,f){a.onSelectRow(g,f);
}});}};