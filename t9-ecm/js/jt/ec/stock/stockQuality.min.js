$(function(){var a=new StockQuality();a.init();});function StockQuality(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.regExpQty=/^[0-9]+$/;
this.isNext=false;}StockQuality._CONS_={LIST_DATA_URL:ctx+"/ec/stock/stStock/listNeedCheckData.htm",CHECK_URL:ctx+"/ec/stock/stStock/getCheckData.htm",DETAIL_URL:ctx+"/ec/stock/stStock/getDetailData.htm",SAVE_URL:ctx+"/ec/stock/stStock/saveCheckData.htm",GET_END_URL:ctx+"/ec/stock/stStock/getEndTime.htm",GRID:"#stStockGrid",PAGER:"#stStockPager"};
StockQuality.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();StoreUtils.loadStores("","searchStoreContainer");
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("stockQuality.button.detail")){$("button.stStockDetail").hide();}if(!ResUtils.canShow("stockQuality.button.check")){$("button.stStockCheck").hide();
}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isNext=false;$("button.saveBtn").show();$("button.saveAndNextBtn").show();$("button.addNew").show();
$(".checkItems").find("input").attr("disabled",false);if(c){$(".stStockSearch").trigger("click");}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_check:function(a){this._showFormWrapper();this._loadData(a);},_detail:function(a){$("button.saveBtn").hide();$("button.saveAndNextBtn").hide();
$("button.addNew").hide();this._showFormWrapper();this._loadData(a,true);},_loadData:function(c,b){var a=this;FormUtils.loadData(StockQuality._CONS_.CHECK_URL+"?id="+c,function(e){var d=JSON.parse(e.msg);
$("input[name='name']").val(d.name);$("input[name='position']").val(d.position);$("input[name='checkTime'").val(d.checkTime);$("input[name='lastQty'").val(d.lastQty);
$("input[name='totalQty_t'").val(d.totalQty);$("input[name='stockId']").val(d.stockId);$("input[name='nextStockId']").val(d.nextStockId);$("input[name='skuId']").val(d.skuId);
a._createItems(d.stockQualityPos,b);if(b){$(".checkItems").find("input").attr("disabled","disabled");$(".hideWhenDetail").hide();}else{$(".hideWhenDetail").show();
}if(d.checkTime==null||d.checkTime==""){$(".hideWhenNo").hide();}else{$(".hideWhenNo").show();}a._updateTotal();});},_save:function(f){var d=[];var a=false;
var c=this;var e=0;$(".checkItems").find("tbody").find("tr").each(function(){var i={};var h=$(this).attr("item-id")?true:false;if(h){i.id=$(this).attr("item-id");
i.qty=$(this).find("td:eq(2) input").val();}else{i.begin=$(this).find("td:eq(0) input").val();i.qty=$(this).find("td:eq(2) input").val();if(i.begin==null||i.begin==""){DialogUtils.error(msgCode.error,"保质期开始时间不能为空");
$(this).find("td:eq(0) input").focus();a=true;return false;}}if(!c._validata(i.qty,$(this).find("td:eq(2) input"))){a=true;return false;}d.push(i);e+=parseInt(i.qty);
});if(a){return false;}var b=$("input[name='totalQty_t").val();if(parseInt(b)!=e){DialogUtils.error(msgCode.error,"数量和必须等于本次盘点总数");return false;}var g={stockId:$("input[name='stockId']").val(),checkItemJson:JSON.stringify(d)};
DialogUtils.confirmWithOptions({title:"确定保存吗？",text:"",confirmButtonText:"保存",yesFunc:function(){FormUtils.submit(StockQuality._CONS_.SAVE_URL,g,function(i){if(i.success){if(f){var h=$("input[name='nextStockId']").val();
if(h!=null&&h!=""){c._loadData(h);}else{DialogUtils.error(msgCode.ERROR,"已经是最后一个");}}else{c.clear(true);}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});},_createItems:function(b,a){var d=new StringBuffer();for(var c=0;c<b.length;c++){d.append("<tr item-id='"+b[c].id+"'>").append("<td><input disabled='disabled' class='laydate-icon form-control layer-date' value='"+$.trim(b[c].begin.replace("00:00:00",""))+"'></td>").append("<td>"+b[c].end.replace("00:00:00","")+"</td>").append("<td><input class='form-control qty' value='"+b[c].qty+"'></td>");
if(!a){d.append("<td></td>");}d.append("</tr>");}$(".checkItems").find("tbody").empty().append(d.toString());},_bindEventHander:function(){var a=this;$(".prevBtn").on("click",function(){a.clear(a.isNext);
});$(".saveBtn").on("click",function(){a._save();});$(".saveAndNextBtn").on("click",function(){a._save(true);a.isNext=true;});$(document).on("mouseover","td[aria-describedby='stStockGrid_prodName']",function(){var b=$(this);
var c=b.find(".name_value").attr("title");b.attr("title",c);});$(".list_wrapper").on("click",".stStockSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#stStockSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".stStockSearch").trigger("click");}});$("body").on("click",".stStockCheck",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(StockQuality._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要盘点的记录");
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,"不能同时盘点多条记录");return;}}}a._check(b);});$("body").on("click",".stStockDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(StockQuality._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(".addNew").on("click",function(){var b=new StringBuffer();
b.append("<tr>").append("<td ><input class='laydate-icon form-control layer-date' placeholder='YYYY-MM-DD' ></td>").append("<td></td>").append("<td> <input class='form-control qty'></td>").append("<td><button type='button' class='btn btn-sm btn-danger deleteItem'>删除</button></td>").append("</tr>");
$(".checkItems").find("tbody").append(b.toString());});$(document).on("click",".layer-date",function(){var b=this;laydate({istime:true,format:"YYYY-MM-DD",choose:function(d){var c=$(b).val();
if(!a._isNewTime(c)){$(b).val("");DialogUtils.error(msgCode.error,"已存在相同的保质期起始日期！");return false;}a._setEndTime(c,b);}});});$(document).on("keyup",".qty",function(){var b=$(this).val();
if(a._validata(b,this)){a._updateTotal();}});$(document).on("click",".deleteItem",function(){$(this).parents("tr").remove();a._updateTotal();});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");
FormUtils.clear("#"+b);});},_isNewTime:function(a){var b=0;$(".checkItems").find("tbody").find("tr").each(function(){var c=$(this).find("td:eq(0) input").val();
console.log(c);console.log(a+(a==c)+c);if(a==c){b++;}console.log(b);});if(b==1){return true;}else{return false;}},_setEndTime:function(a,c){var b=$("input[name='skuId']").val();
var d={beginTime:a,skuId:b};FormUtils.submit(StockQuality._CONS_.GET_END_URL,d,function(e){if(e.success){$(c).parents("tr").find("td:eq(1)").empty().append(e.msg);
}});},_validata:function(b,a){if(b==""||b==null){DialogUtils.error(msgCode.error,"数量不能为空！");$(a).focus();return false;}if(!this.regExpQty.test(b)){DialogUtils.error(msgCode.error,"数量只能输入数字！");
$(a).focus();return false;}return true;},_updateTotal:function(){var a=Number(0);$(".checkItems").find(".qty").each(function(){a+=Number($(this).val());
});$(".totalQty_f").empty().append(a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(StockQuality._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
if(ResUtils.canShow("stockQuality.button.check")){a.push({lable:"盘点",btnClasses:"btn btn-primary stStockCheck",iconClasses:"fa fa-edit"});}if(ResUtils.canShow("stockQuality.button.detail")){a.push({lable:"明细",btnClasses:"btn btn-primary stStockDetail",iconClasses:"fa fa-list"});
}return a;},_initJqgrid:function(b){if(b==null||typeof b==undefined){b={};}var a=$("#needCheck").val();b.Q__S__EQ__prod_type_="product";b.needCheck=a;$(StockQuality._CONS_.GRID).JTJqgrid({url:StockQuality._CONS_.LIST_DATA_URL,pager:StockQuality._CONS_.PAGER,postData:b,footerrow:true,userDataOnFooter:true,colNames:["id","图片","名称","状态","sku","skuID","sku属性","仓库","仓库ID","仓位","总数","盘点时间","盘点数量","单位","操作"],colModel:[{name:"id",index:"id_",width:700,hidden:true},{name:"path",sortable:false,width:100,classes:"autoHideCol",formatter:function(d){var c="<img style='display: inline; height:35px;' ";
c=c+" src='"+ImageUtils.getUrl({url:d,name:"",id:""})+"' >";return c;}},{name:"prodName",index:"prod.name_",width:180,sortable:false,formatter:function(c){var d='<lable class ="name_value" title="'+c+'">';
if(c&&c.length>11){return d+c.substring(0,9)+"..."+"</lable>";}else{return c;}}},{name:"qualityStatus",index:"stock.quality_status_",width:80,formatter:function(c){if(c=="common"){return"<span class='text text-info'>正常</span>";
}else{if(c=="notice"){return"<span class='text text-success'>常规</span>";}else{if(c=="important"){return"<span class='text text-warning'>重要</span>";}else{if(c=="critical"){return"<span  style='color:#FF7744;color:#fff'>紧急</span>";
}else{if(c=="expire"){return"<span class='text text-danger'>逾期</span>";}else{return"";}}}}}}},{name:"skuCode",index:"sku.code_",width:120},{name:"skuId",width:120,hidden:true},{name:"skuJson",index:"sku.attr_json_",width:100,sortable:false,classes:"autoHideCol"},{name:"storeName",index:"store.store_id_",width:120},{name:"storeId",index:"store.store_id_",hidden:true},{name:"position",index:"stock.position_",width:60},{name:"total",index:"stock.total_",width:80},{name:"lastQualityTime",index:"stock.last_quailty_time_",width:120,formatter:function(c){return DateUtils.miniTime(c);
}},{name:"lastQualityQty",index:"stock.last_quality_qty_",width:90},{name:"unit",index:"stock.unit_",width:40,classes:"autoHideCol"},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],gridComplete:function(){var c=$(".jqGrid_wrapper").find("tr.footrow");
c.find("td").hide();c.find('td[aria-describedby*="_id"]').show();},sortable:true,rowNum:20});}};