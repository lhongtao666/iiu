$(function(){var a=new PackingBill();a.init();});function PackingBill(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.soIdList=[];
this.index=0;this.isManyStore=isManyStore?isManyStore:"y";}PackingBill._CONS_={EDIT_URL:ctx+"/ec/stock/packingBill/edit.htm",DETAIL_URL:ctx+"/ec/stock/packingBill/detail.htm",SAVE_EDIT_URL:ctx+"/ec/stock/packingBill/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/stock/packingBill/listData.htm",PACK_DATA_URL:ctx+"/ec/stock/packingBill/packData.htm",PACKING_URL:ctx+"/ec/stock/packingBill/packing.htm",TYPE_KEY:"stock",IN:"in",OUT:"out",EDIT_FORM_ID:"packingBillForm",GRID:"#packingBillGrid",PAGER:"#packingBillPager"};
PackingBill.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
StoreUtils.loadStores("","storeIdSearchContainer");this._hideNeedHide();}},_hideNeedHide:function(){if(this.isManyStore=="n"){$(".hiddenWhenHasOneStore").hide();
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("packingBill.button.detail")){$(".packingBillDetail").hide();}if(!ResUtils.canShow("packingBill.button.pack")){$(".packingBillPack").hide();
}if(!ResUtils.canShow("packingBill.button.export")){$(".packingBillExport").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;FormUtils.clear(PackingBill._CONS_.EDIT_FORM_ID);FormUtils.enableForm(PackingBill._CONS_.EDIT_FORM_ID);a.index=0;ButtonUtils.enableBtn("packNextBtn");
ButtonUtils.enableBtn("nextBtn");ButtonUtils.enableBtn("previousBtn");if(c){$(".packingBillSearch").trigger("click");}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".packedform_wrapper").hide();$(".pack_wrapper").hide();$(".list_wrapper").show();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".packedform_wrapper").hide();$(".pack_wrapper").show();},_showPackedform_wrapper:function(){$(".list_wrapper").hide();$(".pack_wrapper").hide();$(".packedform_wrapper").show();
},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);},_detail:function(a){this._showFormWrapper();this._loadData(a);FormUtils.disableForm(PackingBill._CONS_.EDIT_FORM_ID);
},_pack:function(){if(this.soIdList.lenght<=0){DialogUtils.error(msgCode.error,"错误，所选数据关联订单号为空");return;}this._showPackedform_wrapper();this._loadPackData();
},_loadData:function(b){$("#packingProductContainer").empty();var a=this;FormUtils.loadData(PackingBill._CONS_.DETAIL_URL+"?id="+b,function(c){$("#packingBillForm input[name='id']").val(c.id);
$("#packingBillForm input[name='name']").val(c.name);$("#packingBillForm input[name='code']").val(c.code);$("#packingBillForm textarea[name='comment']").val(c.comment);
$("#packingBillForm input[name='operId']").val(c.operId);$("#packingBillForm input[name='operName']").val(c.operName);$("#packingBillForm input[name='operTime']").val(c.operTime);
$("#packingBillForm input[name='createBy']").val(c.createBy);$("#packingBillForm input[name='createTime']").val(c.createTime);$("#packingBillForm select[name='type'").val(c.type);
$("#packingBillForm input[name='soIds']").val(c.soIds);$("#packingBillForm input[name='status']").val(c.status);$("#packingBillForm input[name='soNos'").val(c.soNos);
StoreUtils.loadStores(c.storeId,"packingStoreIdContainer");$("#packingStoreIdContainer").attr("disabled","disabled");$(".operTimeContainer label").text("出库日期");
if(c.stBillItemVoList){a._createBillItems(c.stBillItemVoList,"packingProductContainer");}$("#packingProductContainer :input").attr("disabled","disabled");
});},_loadPackData:function(){$("#packedProductContainer").empty();var b=this;var a=b.index+1;FormUtils.loadData(PackingBill._CONS_.PACK_DATA_URL+"?soId="+b.soIdList[b.index],function(c){$("#packedBillForm input[name='id']").val(c.id);
$("#packedBillForm input[name='name']").val(c.name);$("#packedBillForm input[name='code']").val(c.code);$("#packedBillForm textarea[name='comment']").val(c.comment);
$("#packedBillForm input[name='operId']").val(c.operId);$("#packedBillForm input[name='operName']").val(c.operName);$("#packedBillForm input[name='operTime']").val(c.operTime);
$("#packedBillForm input[name='companyId']").val(c.companyId);$("#packedBillForm input[name='createBy']").val(c.createBy);$("#packedBillForm input[name='createTime']").val(c.createTime);
$("#packedBillForm select[name='type'").val(c.type);$("#packedBillForm input[name='soNos'").val(c.soNos);StoreUtils.loadStores(c.storeId,"storeIdContainer2");
if(a>=b.soIdList.length){ButtonUtils.disableBtn("packNextBtn");ButtonUtils.disableBtn("nextBtn");}else{if(c.status=="awaiting_confirm"){ButtonUtils.enableBtn("packNextBtn");
}ButtonUtils.enableBtn("nextBtn");}if(a<=1){ButtonUtils.disableBtn("previousBtn");}else{ButtonUtils.enableBtn("previousBtn");}if(c.status=="awaiting_confirm"){ButtonUtils.enableBtn("packedBtn");
}else{ButtonUtils.disableBtn("packNextBtn");ButtonUtils.disableBtn("packedBtn");}$("#storeIdContainer2").attr("disabled","disabled");$(".operTimeContainer label").text("出库日期");
if(c.stBillItemVoList){b._createBillItems(c.stBillItemVoList,"packedProductContainer");}$("#packedProductContainer :input").attr("disabled","disabled");
$("#packedBillForm :input").attr("disabled","disabled");});},_packing:function(c){var b=this;var d=$("#packedBillForm input[name='id']").val();var a=PackingBill._CONS_.PACKING_URL;
FormUtils.submit(a,{id:d},function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);if(c){b.index+=1;b._loadPackData();}else{ButtonUtils.disableBtn("packNextBtn");
ButtonUtils.disableBtn("packedBtn");}}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_createBillItems:function(k,a){if(!k){return;
}var h=$("#"+a+" tr");var l=new StringBuffer();for(var d=0;d<k.length;d++){var n=false;if(h&&h.length>0){for(var c=0;c<h.length;c++){if($(h[c]).attr("skuIdVal")==k[d].skuId){n=true;
break;}}}if(n){continue;}var o=1;var g=0;var e=k[d].position?k[d].position:"";var f=k[d].comment?k[d].comment:"";var m=k[d].unit?k[d].unit:"";var b=k[d].totalQty?k[d].totalQty:"";
if(k[d].qty){o=k[d].qty;}l.append("<tr  prodIdVal='"+k[d].prodId+"' skuIdVal='"+k[d].skuId+"'>").append("<td title='"+k[d].prodName+"'>"+(k[d].prodName.length<=15?k[d].prodName:(k[d].prodName.substring(0,13))+"...")+"</td>").append("<td>"+k[d].skuCode+"</td>").append("<td>"+m+"</td>");
l.append("<td><input class='form-control prodQty' value='"+parseInt(o)+"' placeholder='数量'></td>");l.append("<td><input class='form-control' readonly='readonly' value='"+e+"' placeholder='所在仓位'></td>");
l.append("<td><input class='form-control' value='"+f+"' placeholder='备注信息'></td>").append("</tr>");}$("#"+a).append(l.toString());},_export:function(c,b){var a=ctx+"/ec/salesorder/soEntity/exportPack.htm";
FormUtils.submit(a,"packId="+c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,"成功");JTTabUtils.addOrRefreshTab(ctx+d.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D","备货单["+b+"]信息");
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".prevBtn2",function(){a.clear(true);});$("#"+PackingBill._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+PackingBill._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+PackingBill._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".list_wrapper").on("click",".packingBillSearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});$("#packingBillFormSearch").on("keypress",function(b){if(b.keyCode=="13"){$(".packingBillSearch").trigger("click");
return false;}});$(document).on("click",".exportBtn",function(){var c=$("#packingBillForm input[name=id]").val();var b=$("#packingBillForm input[name=name]").val();
a._export(c,b);});$("body").on("click",".packingBillExport",function(){var b=$(this).attr("idVal");if(!b){b=$(PackingBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要导出的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能同时导出多条记录");return;
}}}var d=$(PackingBill._CONS_.GRID).jqGrid("getRowData",b);var c=d.name;a._export(b,c);});$("body").on("click",".packingBillEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(PackingBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".packingBillDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(PackingBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$(document).on("click",".showDetail",function(){var b=$(this).parents("tr").attr("id");
a._detail(b);});$("body").on("click",".packingBillPack",function(){var b=$(this).attr("idVal");if(!b){b=$(PackingBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要打包的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,"不能同时选择多个记录");return;
}}}var d=$(PackingBill._CONS_.GRID).jqGrid("getRowData",b);if(d["status"]=='<label class="label label-primary">完成</label>'){DialogUtils.error(msgCode.error,"已完成的备货单不可以再打包");
return;}var c=d.soIds;a.soIdList=c.split(",");a.index=0;a._pack();});$("body").on("click",".packingBtn",function(){var c=$("#packingBillForm input[name='soIds']").val();
var b=$("#packingBillForm input[name='status']").val();if(b=="done"){DialogUtils.error(msgCode.error,"已完成的备货单不可以再打包");return;}a.soIdList=c.split(",");a.index=0;
a._pack();});$("body").on("click",".packedBtn",function(){a._packing();});$("body").on("click",".packNextBtn",function(){a._packing(true);});$("body").on("click",".nextBtn",function(){a.index+=1;
a._loadPackData();});$("body").on("click",".previousBtn",function(){a.index-=1;if(a.index<0){return;}a._loadPackData();});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");
FormUtils.clear("#"+b);});},_bindFormValidation:function(){var a={rules:{name:{required:true},storeId:{required:true},subType:{required:true},operTime:{required:true}},messages:{}};
FormUtils.bindFormValidation(PackingBill._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(PackingBill._CONS_.GRID,a);},_getManagerBtns:function(){var a=[];
if(ResUtils.canShow("packingBill.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary packingBillDetail",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("packingBill.button.export")){a.push({lable:"导出备货单",btnClasses:"btn btn-primary packingBillExport",iconClasses:"fa fa-th-list"});}return a;
},_initJqgrid:function(c){if(c==null||typeof c==undefined){c={};}var a=false;if("n"==self.isManyStore){a=true;}var b=new Date();b.setMonth(b.getMonth()-1);
b.setDate(1);$("#startTimeSearch").val(DateUtils.format(b,"yyyy-MM-dd"));c.Q__D__BW__create_time_=DateUtils.format(b,"yyyy-MM-dd");c.Q__S__EQ__type_="packing";
$(PackingBill._CONS_.GRID).JTJqgrid({url:PackingBill._CONS_.LIST_DATA_URL,pager:PackingBill._CONS_.PAGER,postData:c,footerrow:true,userDataOnFooter:true,colNames:["id","名称","单据号码","关联订单号","经手人","出库日期","业务类型","仓库","数量","创建时间","订单id","状态","状态","操作"],colModel:[{name:"id",index:"id_",width:700,hidden:true},{name:"name",index:"name_",width:120,hidden:true},{name:"code",index:"code_",width:120,formatter:function(d){return"<a href='javascript:void(0)' class='showDetail'>"+d+"</a>";
}},{name:"soNos",index:"so_nos_",width:120},{name:"operName",index:"oper_id_",width:100,sortable:false},{name:"operTime",index:"oper_time_",width:100,formatter:function(d){return DateUtils.miniTime(d);
}},{name:"type",index:"type_",width:100,hidden:true,formatter:function(d){if(d="packing"){return"备货单";}else{return"";}}},{name:"storeName",index:"store_id_",hidden:a,width:100},{name:"sum",index:"sum_",width:80},{name:"createTime",index:"create_time_",width:100,formatter:function(d){return DateUtils.miniTime(d);
}},{name:"soIds",index:"so_ids_",width:120,hidden:true},{name:"status",index:"status_",width:60,formatter:function(d){if(d=="done"){return"完成";}else{if(d=="confirm"){return"已审核";
}else{return"";}}}},{name:"status",index:"status_",width:40,hidden:true},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],gridComplete:function(){var d=$(".jqGrid_wrapper").find("tr.footrow");
d.find("td").hide();d.find('td[aria-describedby*="_id"]').show();}});}};