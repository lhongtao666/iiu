$(function(){var a=new StBill();a.init();});function StBill(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.regQty=/^[0-9]*[1-9][0-9]*$/;
this.regPrice=/^\d+(\.\d{0,2})?$/;this.isManyStore=isManyStore?isManyStore:"y";}StBill._CONS_={EDIT_URL:ctx+"/ec/stock/stBill/edit.htm",DETAIL_URL:ctx+"/ec/stock/stBill/detail.htm",DELETE_URL:ctx+"/ec/stock/stBill/delete.htm",SAVE_ADD_URL:ctx+"/ec/stock/stBill/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/stock/stBill/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/stock/stBill/listData.htm",TO_CONFIRM_URL:ctx+"/ec/stock/stBill/toConfirm.htm",CONFIRM_URL:ctx+"/ec/stock/stBill/confirm.htm",BACK_CONFIRM_URL:ctx+"/ec/stock/stBill/backConfirm.htm",IVALIDE_URL:ctx+"/ec/stock/stBill/invalid.htm",DONE_URL:ctx+"/ec/stock/stBill/done.htm",EXPORT_URL:ctx+"/ec/stock/stBill/export.htm",SAVE_SHIPPINGFEE:ctx+"/ec/stock/stBill/saveShippingFee.htm",TYPE_KEY:"stock",IN:"in",OUT:"manual_out",EDIT_FORM_ID:"stBillForm",GRID:"#stBillGrid",PAGER:"#stBillPager",};
StBill.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this.onSelectRow();StoreUtils.loadStores("","storeIdSearchContainer");this._createTable();this._hideNeedHide();}},_hideNeedHide:function(){if(type===StBill._CONS_.OUT){$(".hiddenWhenOut").hide();
}if(this.isManyStore=="n"){$(".hiddenWhenHasOneStore").hide();}},_createTable:function(){var a=new StringBuffer();a.append("<tr>").append("<th width='15%'>名称</th>").append("<th width='10%'>sku</th>");
if(type==StBill._CONS_.IN){a.append("<th width='10%'>采购数量<span style='color: red;'>*</span></th>");a.append("<th width='13%'>采购价格(元)<span style='color: red;'>*</span></th>");
a.append("<th width='11%'>总金额(元)</th>");a.append("<th width='13%'>生产日期<span style='color: red;'>*</span></th>");}else{if(type===StBill._CONS_.OUT){a.append("<th width='10%'>库存数量</th>");
a.append("<th width='10%'>出库数量<span style='color: red;'>*</span></th>");}}a.append("<th width='8%'>仓位</th>").append("<th width='7%'>操作</th></tr>");$("#productHeaderContainer").empty().append(a.toString());
},_hideNotGrantBtn:function(){if(type===StBill._CONS_.IN){if(!ResUtils.canShow("stBill.button.add")){$("button.stBillAdd1").hide();$("button.stBillAdd2").hide();
}if(!ResUtils.canShow("stBill.button.edit")){$("button.stBillEdit").hide();}if(!ResUtils.canShow("stBill.button.confirm")){$("button.stBillConfirm").hide();
}if(!ResUtils.canShow("stBill.button.delete")){$("button.stBillDelete").hide();}if(!ResUtils.canShow("stBill.button.done")){$("button.stBillDone").hide();
}if(!ResUtils.canShow("stBill.button.export")){$("button.stBillExport").hide();}}else{if(type==="manual_out"){if(!ResUtils.canShow("stBillOut.button.detail")){$("button.stBillDetail").hide();
}if(!ResUtils.canShow("stBillOut.button.add")){$("button.stBillAdd1").hide();$("button.stBillAdd2").hide();}if(!ResUtils.canShow("stBillOut.button.edit")){$("button.stBillEdit").hide();
}if(!ResUtils.canShow("stBillOut.button.delete")){$("button.stBillDelete").hide();}if(!ResUtils.canShow("stBillOut.button.done")){$("button.stBillDone").hide();
}if(!ResUtils.canShow("stBillOut.button.export")){$("button.stBillExport").hide();}}}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;$("#productFooterContainer").empty();$("#productContainer").empty();$("#storeIdContainer").removeAttr("disabled");$(".onlyShowDetail").show();
$(".saveBtn").show();$(".confirmBtn").show();$(".backConfirmBtn").show();$(".toConfirmBtn").show();ButtonUtils.enableBtn("selectProdBtn");FormUtils.clear(StBill._CONS_.EDIT_FORM_ID);
FormUtils.enableForm(StBill._CONS_.EDIT_FORM_ID);$("#productContainer").find(":input").removeAttr("disabled");if(c){$(".stBillSearch").trigger("click");
}a.onSelectRow();}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_add:function(){this._showFormWrapper();StoreUtils.loadStores("","storeIdContainer");
if(type===StBill._CONS_.IN){$(".operTimeContainer label").html("采购日期<span style='color: red;'>*</span>");}else{if(type===StBill._CONS_.OUT){$(".operTimeContainer label").html("出库日期<span style='color: red;'>*</span>");
}else{}}var a=$("input[name='prodType']").val();this._changeTr(a);$(".onlyShowDetail").hide();$("input[name='operName']").val(currentUserName);$(".confirmBtn").hide();
$(".backConfirmBtn").hide();$(".toConfirmBtn").hide();var b=new Date();$("input[name='operTime']").val(DateUtils.format(b,"yyyy-MM-dd HH:mm:ss"));},_edit:function(c,a){this._showFormWrapper();
this.edit=true;var b=false;if(a=="edit"){$(".confirmBtn").hide();$(".toConfirmBtn").hide();$(".backConfirmBtn").hide();}else{if(a=="awaiting_confirm"){b=true;
$(".confirmBtn").hide();$(".saveBtn").hide();$(".backConfirmBtn").hide();}else{if(a=="confirm"){b=false;$(".saveBtn").hide();$(".toConfirmBtn").hide();
}}}this._loadData(c,b);},_detail:function(a){this._showFormWrapper();this._loadData(a,true);$(".form_wrapper .saveBtn").hide();$(".confirmBtn").hide();
$(".backConfirmBtn").hide();$(".doneBtn").hide();$(".backBtn").hide();$(".toConfirmBtn").hide();ButtonUtils.disableBtn("selectProdBtn");FormUtils.disableForm(StBill._CONS_.EDIT_FORM_ID);
},_changeTr:function(a){if(a=="product"){$(".sale-title").empty().append("销售价(元)");}else{$(".sale-title").empty().append("销售价(积分)");}},_loadData:function(d,b){var a=this;
var c=b?StBill._CONS_.DETAIL_URL:StBill._CONS_.EDIT_URL;FormUtils.loadData(c+"?id="+d,function(e){$("input[name='id']").val(e.id);$("input[name='name']").val(e.name);
$("input[name='code']").val(e.code);$("textarea[name='comment']").val(e.comment);$("input[name='operId']").val(e.operId);$("input[name='operName']").val(e.operName);
$("input[name='operTime']").val(e.operTime);$("input[name='createBy']").val(e.createBy);$("input[name='createTime']").val(e.createTime);$("input[name='status']").val(e.status);
$("input[name='prodType']").val(e.prodType);$("input[name='shippingFee']").val(e.shippingFee);a._changeTr(e.prodType);StoreUtils.loadStores(e.storeId,"storeIdContainer");
if(type===StBill._CONS_.IN){$(".operTimeContainer label").html("采购日期<span style='color: red;'>*</span>");}else{if(type===StBill._CONS_.OUT){$(".operTimeContainer label").html("出库日期<span style='color: red;'>*</span>");
}else{}}if(e.stBillItemVoList){a._createBillItems(e.stBillItemVoList);}if(b){$(".checkItemDelBtn").attr("disabled","disabled");ButtonUtils.disableBtn("selectProdBtn");
FormUtils.disableForm(StBill._CONS_.EDIT_FORM_ID);$("#productContainer").find(":input").attr("disabled","disabled");}});},_save:function(d){var e=this;
var g=$("#id").val();var a=null;if(g!=null&&g!=""){a=StBill._CONS_.SAVE_EDIT_URL;}else{a=StBill._CONS_.SAVE_ADD_URL;}if(d&&d=="confirm"){$("input[name='status'").val("done");
}if($("#stBillForm").valid()){var c=[];var b=false;$("#productContainer").find("tr").each(function(){var h={};h.skuId=$(this).attr("skuIdVal");h.prodId=$(this).attr("prodIdVal");
if(type===StBill._CONS_.IN){h.qty=$(this).find("td:eq(2) input").val();h.price=$(this).find("td:eq(3) input").val();h.position=$(this).find("td:eq(6) input").val();
h.qualityBegin=$(this).find("td:eq(5) input").val();if(!h.price){$(this).find("td:eq(3) input").focus();DialogUtils.error(msgCode.ERROR,"价格不能为空");b=true;
return false;}if(!e.regPrice.test(h.price)){$(this).find("td:eq(3) input").focus();DialogUtils.error(msgCode.ERROR,"价格必须为不为0的数字。小数点保留0-2位");b=true;return false;
}if(!h.qty){$(this).find("td:eq(2) input").focus();DialogUtils.error(msgCode.ERROR,"数量不能为空");b=true;return false;}if(!e.regQty.test(h.qty)){$(this).find("td:eq(2) input").focus();
DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");b=true;return false;}if(!h.qualityBegin){$(this).find("td:eq(5) input").focus();DialogUtils.error(msgCode.ERROR,"生产日期不能为空");
b=true;return false;}}else{h.qty=$(this).find("td:eq(3) input").val();h.position=$(this).find("td:eq(4) input:first").val();h.type=$(this).find("input[name=isBad]")[0].checked?"bad":"common";
if(!h.qty){$(this).find("td:eq(3) input").focus();DialogUtils.error(msgCode.ERROR,"数量不能为空");b=true;return false;}if(!e.regQty.test(h.qty)){$(this).find("td:eq(3) input").focus();
DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");b=true;return false;}}c.push(h);});if(b){return;}$("#storeIdContainer").removeAttr("disabled");var f=$("#"+StBill._CONS_.EDIT_FORM_ID).serialize();
f+="&type="+type;f+="&billItemJson="+JSON.stringify(c);FormUtils.submit(a,f,function(h){if(h.success){if(h.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(h.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}e.isEdit=false;e.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_saveNoItem:function(a,c){var b=this;var d="";if(c==null||c==""){d=$("#id").val();
}else{d=c;}if(d==null||d==""){DialogUtils.error(msgCode.FAIL_MSG,"id为空！");return;}FormUtils.submit(a,{id:d},function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_toConfirm:function(){var a=StBill._CONS_.TO_CONFIRM_URL;
this._saveNoItem(a);},_confirm:function(b){var a=StBill._CONS_.CONFIRM_URL;this._saveNoItem(a);},_backConfirm:function(b){var a=StBill._CONS_.BACK_CONFIRM_URL;
this._saveNoItem(a,b);},_done:function(b){var a=StBill._CONS_.DONE_URL;this._saveNoItem(a,b);},_invalid:function(b){var a=StBill._CONS_.IVALIDE_URL;this._saveNoItem(a,b);
},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(StBill._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_createBillItems:function(m,c){if(!m){return;}var k=$("#productContainer tr");
var n=new StringBuffer();var s=0;var h=0;var a=new StringBuffer();for(var r=0;r<m.length;r++){var e=false;if(k&&k.length>0){for(var q=0;q<k.length;q++){if($(k[q]).attr("skuIdVal")==m[r].skuId){e=true;
break;}}}if(e){continue;}var g=0;var p=0;var d=0;var v=m[r].position?m[r].position:"";var b=m[r].comment?m[r].comment:"";var l=m[r].unit?m[r].unit:"";var o=m[r].totalQty?m[r].totalQty:"";
var t=m[r].qualityBegin?m[r].qualityBegin.replace(/00:00:00/,""):"";var f=(m[r].type&&m[r].type=="bad")?true:false;if(type===StBill._CONS_.IN){if(c){d=0;
}else{d=m[r].buyPrice;}}if(m[r].qty){g=m[r].qty;}s+=parseInt(g);a.append("<tr prodIdVal='"+m[r].prodId+"' skuIdVal='"+m[r].skuId+"'>").append("<td title='"+m[r].prodName+"'>"+(m[r].prodName.length<=12?m[r].prodName:(m[r].prodName.substring(0,10)+"..."))+"</td>").append("<td ><a href='javascript:void(0)' class='skuPreviewBtn'>"+m[r].skuCode+"</a></td>");
if(type==StBill._CONS_.OUT){a.append("<td >"+o+"</td>");}if(type===StBill._CONS_.IN){a.append("<td ><input type='number' required class='form-control prodQty' value='"+parseInt(g)+"' placeholder='数量'></td>");
a.append("<td ><input type='number' required class='form-control prodPrice' value='"+(d>0?d:"")+"' placeholder='采购价'></td>");var u=0;if(d>0){u=g*d;h+=u;
}a.append("<td ><input type='number' required class='form-control totalMoney' readonly='readonly' value='"+u.toFixed(2)+"'></td>");a.append("<td ><input class='laydate-icon form-control layer-date' required value='"+t+"' placeholder='YYYY-MM-DD' ></td>");
a.append("<td ><input value='"+v+"' class='form-control' placeholder='所在仓位'></td>");}else{if(type===StBill._CONS_.OUT){a.append("<td ><input style='width:50%' type='number' required class='prodQty' value='"+parseInt(g)+"' placeholder='数量'><input style='margin-left:10px;' "+(f?"checked":"")+" type='checkbox' name='isBad'>出次品</td>");
a.append("<td width='10%'><input class='form-control' readonly='readonly' value='"+v+"' placeholder='所在仓位'></td>");}}a.append("<td style='display:none'><input class='form-control' value='"+b+"' placeholder='备注信息'></td>").append("<td><button class='btn btn-outline btn-sm btn-danger checkItemDelBtn' type='button'>删除</button></td>").append("</tr>");
}$("#storeIdContainer").attr("disabled","disabled");$("#productContainer").append(a.toString());this._updateTotal();},_updateTotal:function(){var a=Number(0);
$("#productContainer").find(".prodQty").each(function(){a+=Number($(this).val());});$("#totalCountContainer").text(a);var b=Number(0);$("#productContainer").find(".totalMoney").each(function(){b+=Number($(this).val());
});$("#allMoneyContainer").text(b.toFixed(2));if(type===StBill._CONS_.IN){$("#productFooterContainer").empty().append("<tr><td>合计</td>"+"<td colspan='2' style='text-align:right'>总数量：<strong id='totalCountContainer'>"+a+"</strong></td>"+"<td colspan='2' style='text-align:right'>总金额：<strong id='allMoneyContainer'>"+b.toFixed(2)+"</strong></td>"+"<td colspan='3'>&nbsp;</td><tr>");
}else{$("#productFooterContainer").empty().append("<tr><td>合计</td>"+"<td >&nbsp;</td>"+"<td colspan='2' style='text-align:right'>总数量：<strong id='totalCountContainer'>"+a+"</strong></td>"+"<td colspan='2'>&nbsp;</td><tr>");
}},_saveShippingFee:function(c,b){var a=StBill._CONS_.SAVE_SHIPPINGFEE;FormUtils.submit(a,{id:c,shippingFee:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
$(".stBillSearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_bindEventHander:function(){var a=this;$("#productContainer").on("keyup",".prodQty",function(){var f=$(this).val();if(type!=StBill._CONS_.IN){var c=Number(0);
if(!f){a._updateTotal();return;}if(!a.regQty.test(f)){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");$(this).focus();return;}var d=$(this).parents("tr").find("td:eq(5)").text();
if(Number(f)>parseInt(d)){DialogUtils.error(msgCode.ERROR,"数量不能大于库存数量");$(this).val(d);$(this).focus();}$("#productContainer").find(".prodQty").each(function(){c+=Number($(this).val());
});$("#totalCountContainer").text(c);return;}if(!f){a._updateTotal();return;}if(!a.regQty.test(f)){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");$(this).focus();
return;}var b=$(this).parents("td").next().next().find("input");var e=$(this).parents("td").next().find("input").val();if(e&&!a.regPrice.test(e)){DialogUtils.error(msgCode.ERROR,"价格必须为大于0的数字。小数点2位");
$(this).parents("td").next().find("input").focus();return;}if(!e){e=0;}b.val((f*e).toFixed(2));a._updateTotal();});$("#productContainer").on("keyup",".prodPrice",function(){if(type!=StBill._CONS_.IN){return;
}var c=$(this).val();if(!c){return;}if(!a.regPrice.test(c)){DialogUtils.error(msgCode.ERROR,"价格必须为大于0的数字。小数点保留0-2位");$(this).focus();return;}var d=$(this).parents("td").prev().find("input").val();
var b=$(this).parents("td").next().find("input");b.val((d*c).toFixed(2));a._updateTotal();});$(document).on("click",".skuPreviewBtn",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodEntityId="+$(this).parents("tr").attr("prodIdVal")+"&prodSkuId="+$(this).parents("tr").attr("skuIdVal"),"商品【"+$(this).parents("tr").find("td:eq(1)").text()+"】",$(this).parents("tr").find("td:eq(0)").text());
});$(document).on("click",".prevBtn",function(){a.clear(false);});$(document).on("click",".saveBtn",function(){if(!$("#productContainer").find("tr").length){DialogUtils.error(msgCode.ERROR,"请选择商品");
return;}a._save();});$(document).on("click",".toConfirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定提交审核吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._toConfirm();
}});});$(document).on("click",".backConfirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定驳回审核吗？",text:"",confirmButtonText:"驳回",yesFunc:function(){a._backConfirm();
}});});$(document).on("click",".confirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定审核通过吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._save("confirm");
}});});$(document).on("mouseover","td[aria-describedby='stBillGrid_name']",function(){var b=$(this);var c=b.find(".name_value").attr("title");b.attr("title",c);
});$(document).on("blur",".shippingFeeInput",function(){var b=$(this).val();var c=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");if(b!=c){a._saveShippingFee(d,b);
$(this).attr("org-value",b);}});$("#productContainer").on("click",".checkItemDelBtn",function(){$(this).parents("tr").remove();a._updateTotal();});$("#selectProdBtn").on("click",function(){var b=$("#storeIdContainer").val();
if(!b){DialogUtils.error(msgCode.ERROR,"请选择仓库");return;}var e="y",d="n",c="y";if(type===StBill._CONS_.IN){e="n";d="y";c="n";}SelectProdService.selectSku({storeId:b,isMultiple:1,hasStock:e,hideCanSale:d,canSale:c,type:a.prodType,fn:function(f){a._createBillItems(f,true);
}});});$(document).on("click",".stBillConfirm",function(){var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b!=null&&b.length>1){DialogUtils.error(msgCode.error,"不能同时审核多条记录");return;}var c=$(StBill._CONS_.GRID).jqGrid("getRowData",b);if(c.status!="draft"){DialogUtils.error(msgCode.error,"只有草稿状态的单据才能审核");
return;}}a._edit(b,"confirm");});$(document).on("click",".stBillDone",function(){var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要处理的行");return;}}DialogUtils.confirmWithOptions({title:"确定完成所选记录吗？",text:"完成后不可更改！",confirmButtonText:"完成",yesFunc:function(){a._done(b);
}});});$(document).on("click",".stBillInvalid",function(){var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要作废的数据");return;}}DialogUtils.confirmWithOptions({title:"确定作废所选记录吗？",text:"作废后不可更改！",confirmButtonText:"作废",yesFunc:function(){a._invalid(b);
}});});$("#"+StBill._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+StBill._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+StBill._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;}});$(".list_wrapper").on("click",".stBillSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#stBillSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);}});
$("body").on("click",".stBillAdd1",function(){a.prodType="product";$("input[name='prodType']").val(a.prodType);a._add();$("input[name='prodType']").val("product");
});$("body").on("click",".stBillAdd2",function(){a.prodType="point";$("input[name='prodType']").val(a.prodType);a._add();$("input[name='prodType']").val("point");
});$("body").on("click",".stBillEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._edit(b,"edit");});$("body").on("click",".stBillToConfirm",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要提交审核的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能同时选择多条记录");return;
}}}a._edit(b,"awaiting_confirm");});$("body").on("click",".stBillDelete",function(){var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}a._delete(b);});$("body").on("click",".stBillDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}a._detail(b);});$("body").on("click",".stBillExport",function(){var c=$(this).attr("idVal");
if(!c){c=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要导出的记录");return;}else{if(c&&c.length>1){DialogUtils.error(msgCode.ERROR,"不能同时选择多条数据");
return;}}}var d=$("#"+c).find("td:eq(3)").attr("title");if(type===StBill._CONS_.IN){d="采购单["+d+"]信息";}else{d="出库单["+d+"]信息";}var b=StBill._CONS_.EXPORT_URL;
FormUtils.submit(b,"id="+c,function(e){if(e.success){DialogUtils.success(msgCode.INFO,"成功");JTTabUtils.addOrRefreshTab(ctx+e.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D",d);
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".showDetail",function(){var b=$(this).parents("tr").attr("id");
a._detail(b);});$(document).on("click",".layer-date",function(){laydate({istime:true,format:"YYYY-MM-DD"});});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");
FormUtils.clear("#"+b);});},_bindFormValidation:function(){var a={rules:{name:{required:true},storeId:{required:true},subType:{required:true},operTime:{required:true}},messages:{}};
FormUtils.bindFormValidation(StBill._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(StBill._CONS_.GRID,a);this.onSelectRow();
},_getManagerBtns:function(){var a=[];if(type===StBill._CONS_.IN){if(ResUtils.canShow("stBill.button.edit")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["编辑"]],btnClasses:[["btn btn-primary stBillEdit"]],iconClasses:[["fa fa-list"]]}});
}if(ResUtils.canShow("stBill.button.done")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["完成"]],btnClasses:[["btn btn-primary stBillDone"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("stBill.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary stBillDetail",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("stBill.button.delete")){a.push({switchCol:{colName:"status",colVals:["draft","invalid","confirm","awaiting_confirm"],colLables:[["删除"],["删除"],["删除"],["删除"]],btnClasses:[["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"]],iconClasses:[["fa fa-remove"],["fa fa-remove"],["fa fa-remove"],["fa fa-remove"]]}});
}if(ResUtils.canShow("stBill.button.export")){a.push({switchCol:{colName:"status",colVals:["done"],colLables:[["导出单据"]],btnClasses:[["btn btn-primary stBillExport"]],iconClasses:[["fa fa-edit"]]}});
}}else{if(type==="manual_out"){if(ResUtils.canShow("stBillOut.button.edit")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["编辑"]],btnClasses:[["btn btn-primary stBillEdit"]],iconClasses:[["fa fa-list"]]}});
}if(ResUtils.canShow("stBillOut.button.done")){a.push({switchCol:{colName:"status",colVals:["draft"],colLables:[["完成"]],btnClasses:[["btn btn-primary stBillDone"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("stBillOut.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary stBillDetail",iconClasses:"fa fa-th-list"});
}if(ResUtils.canShow("stBillOut.button.delete")){a.push({switchCol:{colName:"status",colVals:["draft","invalid","confirm","awaiting_confirm"],colLables:[["删除"],["删除"],["删除"],["删除"]],btnClasses:[["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"],["btn btn-danger stBillDelete"]],iconClasses:[["fa fa-remove"],["fa fa-remove"],["fa fa-remove"],["fa fa-remove"]]}});
}if(ResUtils.canShow("stBillOut.button.export")){a.push({switchCol:{colName:"status",colVals:["done"],colLables:[["导出单据"]],btnClasses:[["btn btn-primary stBillExport"]],iconClasses:[["fa fa-edit"]]}});
}}}return a;},onSelectRow:function(c,a){var b=$(StBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){$(".stBillDone").attr("disabled",true);
$(".stBillDelete").attr("disabled",true);$(".stBillEdit").attr("disabled",true);$(".stBillExport").attr("disabled",true);}else{if(b.length==1){var d=$(StBill._CONS_.GRID).jqGrid("getRowData",b);
if(d.status=="draft"){$(".stBillDelete").attr("disabled",false);$(".stBillDone").attr("disabled",false);$(".stBillEdit").attr("disabled",false);}else{if(d.status=="done"){$(".stBillExport").attr("disabled",true);
}}}}},_initJqgrid:function(e){var b=this;if(e==null||typeof e==undefined){e={};}var d=new Date();d.setMonth(d.getMonth()-1);$("#startTimeSearch").val(DateUtils.format(d,"yyyy-MM-dd"));
e.Q__D__BW__create_time_=DateUtils.format(d,"yyyy-MM-dd");var a="";if(type===StBill._CONS_.IN){a="采购日期";}else{if(StBill._CONS_.OUT){a="出库日期";}}var f=false;
if(type==StBill._CONS_.OUT){f=true;}var c=false;if("n"==b.isManyStore){c=true;}$(StBill._CONS_.GRID).JTJqgrid({url:StBill._CONS_.LIST_DATA_URL+"?Q__S__EQ__type_="+type,pager:StBill._CONS_.PAGER,postData:e,footerrow:true,userDataOnFooter:true,colNames:["id","单据号码","名称","经手人",a,"业务类型","产品类型","仓库","数量","运费(元)","金额(元)","总金额(元)","创建时间","状态","状态","操作"],colModel:[{name:"id",index:"id_",width:700,hidden:true},{name:"code",index:"code_",width:120,formatter:function(g){return"<a href='javascript:void(0)' class='showDetail'>"+g+"</a>";
}},{name:"name",index:"name_",width:120,formatter:function(g){var h='<lable class ="name_value" title="'+g+'">';if(g&&g.length>10){return h+g.substring(0,8)+"..."+"</lable>";
}else{return g;}}},{name:"operName",index:"oper_id_",width:100,sortable:false},{name:"operTime",index:"oper_time_",width:110,formatter:function(g){return DateUtils.miniTime(g);
}},{name:"subType",index:"sub_type_",width:100,hidden:true},{name:"prodType",index:"prod_type_",width:100,formatter:function(g){if(g=="product"){return"普通产品";
}else{if(g=="point"){return"积分产品";}else{return"";}}}},{name:"storeName",index:"store_id_",hidden:c,width:120},{name:"sum",index:"sum_",width:80},{name:"shippingFee",index:"shipping_fee_",hidden:f,width:80,formatter:function(h,i,j){var g=j.status;
if(g=="awaiting_confirm"||g=="confirm"||g=="draft"){return"<input style='width:90%' class = 'shippingFeeInput' type ='text' org-value='"+h+"' value='"+h+"'>";
}else{return h;}}},{name:"total",index:"total_",hidden:f,width:80},{name:"totalMoney",sortable:false,hidden:f,width:100},{name:"createTime",index:"create_time_",width:110,formatter:function(g){return DateUtils.miniTime(g);
}},{name:"status",index:"status_",width:60,formatter:function(g){if(g=="awaiting_confirm"){return"待审核";}else{if(g=="confirm"){return"<span class='text-info'>已审核</span>";
}else{if(g=="draft"){return"<span class='muted'>待审核</span>";}else{if(g=="done"){return"<span class='text-success'>已审核</span>";}else{if(g=="invalid"){return"<span class='text-danger'>作废</span>";
}else{return g;}}}}}}},{name:"status",index:"status_",width:120,hidden:true},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],gridComplete:function(){var g=$(".jqGrid_wrapper").find("tr.footrow");
g.find("td").hide();g.find('td[aria-describedby*="_id"]').show();},onSelectRow:function(h,g){b.onSelectRow(h,g);},});}};