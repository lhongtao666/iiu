$(function(){var a=new RejectBill();a.init();});function RejectBill(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.data={};this.isManyStore=isManyStore?isManyStore:"y";
}RejectBill._CONS_={SAVE_URL:ctx+"/ec/stock/rejectBill/save.htm",DETAIL_URL:ctx+"/ec/stock/rejectBill/detail.htm",LIST_DATA_URL:ctx+"/ec/stock/rejectBill/listData.htm",CONFIRM_URL:ctx+"/ec/stock/rejectBill/confirm.htm",BACK_CONFIRM_URL:ctx+"/ec/stock/rejectBill/backConfirm.htm",DONE_URL:ctx+"/ec/stock/rejectBill/done.htm",IVALIDE_URL:ctx+"/ec/stock/rejectBill/invalid.htm",TYPE_KEY:"stock",EDIT_FORM_ID:"rejectBillForm",GRID:"#rejectBillGrid",PAGER:"#rejectBillPager"};
RejectBill.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
this.onSelectRow();StoreUtils.loadStores("","storeIdSearchContainer");var b=new StringBuffer();b.append(" <tr>"+"<th width='12%'>名称</th>"+"<th width='12%'>sku</th>"+"<th width='8%'>单位</th>").append("<th style='display:none'>总数量</th>").append("<th>入库数量</th>").append("<th>项目类型</th>").append("<th width='5%'>仓位</th><th width='18%'>备注</th><th width='6%'>操作</th></tr>");
$("#rejectProductHeaderContainer").empty().append(b.toString());this._hideNeedHide();}},_hideNeedHide:function(){if(this.isManyStore=="n"){$(".hiddenWhenHasOneStore").hide();
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("rejectBill.button.detail")){$(".rejectBillDetail").hide();}if(!ResUtils.canShow("rejectBill.button.confirm")){$(".rejectBillConfirm").hide();
}if(!ResUtils.canShow("rejectBill.button.edit")){$(".rejectBillEdit").hide();}if(!ResUtils.canShow("rejectBill.button.backConfirm")){$(".rejectBillBackConfirm").hide();
}if(!ResUtils.canShow("rejectBill.button.done")){$(".rejectBillDone").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;$("#rejectProductContainer").empty();$("#rejectProductFooterContainer").empty();$(".checkItemDelBtn").removeAttr("disabled");$(".confirmBtn").show();
$(".backConfirmBtn").show();$(".processBtn").show();$(".doneBtn").show();$(".saveBtn").show();FormUtils.clear(RejectBill._CONS_.EDIT_FORM_ID);$("#"+RejectBill._CONS_.EDIT_FORM_ID).find(":input").removeAttr("disabled");
$("#rejectStoreIdContainer").attr("disabled","disabled");if(c){a.reloadJqgrid();}a.onSelectRow();}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_detail:function(a){this._showFormWrapper();this._loadData(a,true);$(".confirmBtn").hide();$(".backConfirmBtn").hide();$(".doneBtn").hide();
$(".processBtn").hide();$(".saveBtn").hide();FormUtils.disableForm(RejectBill._CONS_.EDIT_FORM_ID);},_edit:function(b,a){this._showFormWrapper();this.edit=true;
if(a){$(".saveBtn").hide();}else{$(".confirmBtn").hide();}$(".backConfirmBtn").hide();$(".processBtn").hide();$(".doneBtn").hide();this._loadData(b,a);
},_loadData:function(c,b){var a=this;FormUtils.loadData(RejectBill._CONS_.DETAIL_URL+"?id="+c,function(d){$("input[name='id']").val(d.id);$("input[name='name']").val(d.name);
$("input[name='code']").val(d.code);$("textarea[name='comment']").val(d.comment);$("input[name='operId']").val(d.operId);$("input[name='operName']").val(d.operName);
$("input[name='operTime']").val(d.operTime);$("input[name='createBy']").val(d.createBy);$("input[name='createTime']").val(d.createTime);$("select[name='type']").val(d.type);
$("input[name='subType']").val(d.subType);$("input[name='status']").val(d.status);$("input[name='soNos']").val(d.soNos);$("input[name='soIds']").val(d.soIds);
StoreUtils.loadStores(d.storeId,"rejectStoreIdContainer");if(d.stBillItemVoList){loadBillData.createBillItems(d.stBillItemVoList,true);}if(d.status!="awaiting_confirm"){$("#rejectProductContainer").find(":input").attr("disabled","disabled");
FormUtils.disableForm(RejectBill._CONS_.EDIT_FORM_ID);$(".confirmBtn").hide();}if(b){$("#rejectProductContainer").find(":input").attr("disabled","disabled");
FormUtils.disableForm(RejectBill._CONS_.EDIT_FORM_ID);}});},_saveNoItem:function(a,c){var b=this;var d="";if(c==null||c==""){d=$("#id").val();}else{d=c;
}if(d==null||d==""){DialogUtils.error(msgCode.FAIL_MSG,"id为空！");return;}FormUtils.submit(a,{id:d},function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_save:function(){var d=this;
var a=RejectBill._CONS_.SAVE_URL;var c=$("select[name='storeName']").val();$("#storeId").val(c);if($("#rejectBillForm").valid()){var b=[];$("#rejectProductContainer").find("tr").each(function(){var h={};
h.skuId=$(this).attr("skuIdVal");h.prodId=$(this).attr("prodIdVal");h.soId=$(this).attr("soIdVal");var g=$(this).find("td:eq(4) input");if(g.length>1){var f={};
f.skuId=$(this).attr("skuIdVal");f.prodId=$(this).attr("prodIdVal");f.soId=$(this).attr("soIdVal");f.unit=$(this).find("td:eq(2)").text().trim();f.qty=$(this).find("td:eq(4) input:last").val();
f.type=$(this).find("td:eq(5) select:last").val();f.position=$(this).find("td:eq(6)").text();f.comment=$(this).find("td:eq(7) input").val();if(parseInt(f.qty)>0){b.push(f);
}}h.qty=parseInt($(this).find("td:eq(4) input:first").val());h.unit=$(this).find("td:eq(2)").text().trim();h.type=$(this).find("td:eq(5) select:first").val();
h.position=$(this).find("td:eq(6)").text();h.comment=$(this).find("td:eq(7) input").val();b.push(h);});var e=$("#"+RejectBill._CONS_.EDIT_FORM_ID).serialize();
e+="&billItemJson="+JSON.stringify(b);FormUtils.submit(a,e,function(f){if(f.success){DialogUtils.success(msgCode.INFO,"保存成功");d.isEdit=false;d.clear(true);
}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_confirm:function(){var a=RejectBill._CONS_.CONFIRM_URL;
this._saveNoItem(a);},_backConfirm:function(b){var a=RejectBill._CONS_.BACK_CONFIRM_URL;this._saveNoItem(a,b);},_done:function(b){var a=RejectBill._CONS_.DONE_URL;
this._saveNoItem(a,b);},_invalid:function(b){var a=RejectBill._CONS_.IVALIDE_URL;this._saveNoItem(a,b);},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$(document).on("click",".confirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定审核通过吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._confirm();
}});});$(document).on("click",".backConfirmBtn",function(){DialogUtils.confirmWithOptions({title:"确定驳回审核吗？",text:"",confirmButtonText:"驳回",yesFunc:function(){a._backConfirm();
}});});$(document).on("click",".rejectBillBackConfirm",function(){var b=$(this).attr("idVal");if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}DialogUtils.confirmWithOptions({title:"确定驳回审核吗？",text:"",confirmButtonText:"驳回",yesFunc:function(){a._backConfirm(b);
}});});$(document).on("click",".processBtn",function(){a._processing();});$(document).on("click",".rejectBillProcessing",function(){var b=$(this).attr("idVal");
if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._processing(b);});$(document).on("click",".doneBtn",function(){a._done();});$(document).on("click",".rejectBillDone",function(){var b=$(this).attr("idVal");
if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}DialogUtils.confirmWithOptions({title:"确定完成所选记录吗？",text:"完成后不可更改！",confirmButtonText:"完成",yesFunc:function(){a._done(b);}});});$(document).on("click",".checkItemDelBtn",function(){var b=$(this).parents("tr").find("td:eq(3)").text();
$(this).parents("tr").find("td:eq(4) input:first").val(parseInt(b)-1);var c=$(this).parents("tr").find("td:eq(5) select:first option:selected").val();$(this).parents("tr").find("td:eq(4)").append("<input class='form-control badQty' value='"+1+"' placeholder='不良品数量'>");
var d=new StringBuffer();d.append("<select class='form-control itemType'  placeholder='项目类型'>");if(c=="bad"){d.append("<option value='common' selected='selected'>良品</option><option value='bad' >不良品</option>");
}else{d.append("<option value='common' >良品</option><option value='bad' selected='selected'>不良品</option>");}d.append("</select></td>");$(this).parents("tr").find("td:eq(5)").append(d.toString());
$(this).removeClass("checkItemDelBtn").addClass("deleteItemBtn").text("取消");});$(document).on("click",".deleteItemBtn",function(){$(this).removeClass("deleteItemBtn").addClass("checkItemDelBtn").text("拆分");
var b=$(this).parents("tr").find("td:eq(3)").text();$(this).parents("tr").find("td:eq(4) input:last").remove();$(this).parents("tr").find("td:eq(5) select:last").remove();
$(this).parents("tr").find("td:eq(4) input").val(b);});$(document).on("change",".itemType",function(){var f=$(this).parent().find("select");if(f.length>1){var e=$(f[0]).find("option:selected").val();
var d=$(f[1]).find("option:selected").val();if(e==d){$(this).parents("tr").find("td:eq(8)").empty().append("<button class='btn btn-danger checkItemDelBtn' type='button'>拆分</button></td>");
var c=$(this).parents("tr").find("td:eq(4) input:first").val();var b=$(this).parents("tr").find("td:eq(4) input:last").val();$(this).parents("tr").find("td:eq(3)").text(parseInt(c)+parseInt(b));
$(this).parents("tr").find("td:eq(4) input:first").val(parseInt(c)+parseInt(b));$(this).parents("tr").find("td:eq(4) input:last").remove();$(this).parents("tr").find("td:eq(5) select:last").remove();
}}});$(document).on("keyup",".badQty",function(){var c=$(this).val();var b=$(this).parents("tr").find("td:eq(3)").text();if(!c||parseInt(c)==0){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");
$(this).val("");}if(!/^\d+(?=\.{0,1}\d+$|$)/.test(c)){DialogUtils.error(msgCode.ERROR,"数量必须为大于0的整数");$(this).focus();$(this).val("");}if(parseInt(c)>parseInt(b)){DialogUtils.error(msgCode.ERROR,"数量必须小于总数量");
$(this).focus();$(this).val("");}$(this).parents("tr").find("td:eq(4) input:first").val(b-$(this).val());});$(".list_wrapper").on("click",".rejectBillSearch",function(){var b=$(this).closest("form").serialize();
a.reloadJqgrid(b);});$("#rejectBillFormSearch").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);
return false;}});$("body").on("click",".rejectBillConfirm",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}}var c=$(RejectBill._CONS_.GRID).jqGrid("getRowData",b);a.data=c;a._edit(b,true);});$("body").on("click",".rejectBillEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}var c=$(RejectBill._CONS_.GRID).jqGrid("getRowData",b);
a.data=c;a._edit(b,false);});$("body").on("click",".rejectBillDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$(document).on("click",".showDetail",function(){var b=$(this).parents("tr").attr("id");a._detail(b);});$("body").on("click",".soTab",function(){var d=$(this).attr("value");
var c=$(this).attr("value");if(c.length>4){d="*"+c.substring(c.length-3,c.length);}var b=ctx+"/ec/salesorder/soEntity/detail.htm";JTTabUtils.addOrRefreshTab(b+"?soNo="+c,"订单["+d+"]明细");
});$("body").on("click",".resetBtn",function(){var b=$(this).parents("form").attr("id");FormUtils.clear("#"+b);});},_bindFormValidation:function(){var a={rules:{},messages:{}};
FormUtils.bindFormValidation(RejectBill._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(RejectBill._CONS_.GRID,a);this.onSelectRow();
},_getManagerBtns:function(){var a=[];if(ResUtils.canShow("rejectBill.button.detail")){a.push({lable:msgCode.DETAIL_BTN_TEXT,btnClasses:"btn btn-primary rejectBillDetail",iconClasses:"fa fa-list"});
}if(ResUtils.canShow("rejectBill.button.edit")){a.push({switchCol:{colName:"status",colVals:["awaiting_confirm"],colLables:[["编辑"]],btnClasses:[["btn btn-primary rejectBillEdit"]],iconClasses:[["fa fa-edit"]]}});
}if(ResUtils.canShow("rejectBill.button.done")){a.push({switchCol:{colName:"status",colVals:["awaiting_confirm","confirm"],colLables:[["完成"],["完成"]],btnClasses:[["btn btn-primary rejectBillDone"],["btn btn-primary rejectBillDone"]],iconClasses:[["fa fa-edit"],["fa fa-edit"]]}});
}return a;},onSelectRow:function(e,a){var b=$(RejectBill._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){$(".rejectBillBackConfirm").attr("disabled",true);
$(".rejectBillDone").attr("disabled",true);$(".rejectBillConfirm").attr("disabled",true);$(".rejectBillEdit").attr("disabled",true);$(".rejectBillDetail").attr("disabled",true);
}else{if(b.length==1){var f=$(RejectBill._CONS_.GRID).jqGrid("getRowData",b);if(f.status=="awaiting_confirm"||f.status=="confirm"){$(".rejectBillEdit").attr("disabled",false);
$(".rejectBillDone").attr("disabled",false);}$(".rejectBillDetail").attr("disabled",false);}else{$(".rejectBillEdit").attr("disabled",true);$(".rejectBillDetail").attr("disabled",true);
var a=$(RejectBill._CONS_.GRID).jqGrid("getRowData",b[0]).status;for(var d=1;d<b.length;d++){var c=$(RejectBill._CONS_.GRID).jqGrid("getRowData",b[d]).status;
if(a!=c){$(".rejectBillDone").attr("disabled",true);return;}}if(a=="confirm"||a=="awaiting_confirm"){$(".rejectBillDone").attr("disabled",false);}}}},_initJqgrid:function(d){var a=this;
if(d==null||typeof d==undefined){d={};}var b=false;if("n"==a.isManyStore){b=true;}var c=new Date();c.setMonth(c.getMonth()-1);c=c.currentDate()+" 00:00:00";
$("#startTimeSearch").val(c);d.Q__D__BW__create_time_=c;$(RejectBill._CONS_.GRID).JTJqgrid({url:RejectBill._CONS_.LIST_DATA_URL+"?Q__S__EQ__type_=reject_in",pager:RejectBill._CONS_.PAGER,postData:d,footerrow:true,userDataOnFooter:true,colNames:["id","名称","单据号码","订单号码","经手人","业务类型","仓库","数量","创建时间","状态","状态","操作"],colModel:[{name:"id",index:"id_",width:700,hidden:true},{name:"name",index:"name_",width:120,hidden:true},{name:"code",index:"code_",width:120,formatter:function(e){return"<a href='javascript:void(0)' class='showDetail'>"+e+"</a>";
}},{name:"soNos",index:"so_nos_",width:120,formatter:function(e){return"<a href='#' class='soTab' value='"+e+"'>"+e+"</a>";}},{name:"operName",index:"oper_id_",width:120},{name:"type",index:"type_",width:120,hidden:true,formatter:function(e){if(e=="reject_in"){return"拒收入库";
}else{return"";}}},{name:"storeName",index:"store_id_",hidden:b,width:120},{name:"sum",index:"sum_",width:120},{name:"createTime",index:"create_time_",width:120,formatter:function(e){return DateUtils.miniTime(e);
}},{name:"status",index:"status_",width:60,formatter:function(e){if(e=="awaiting_confirm"){return"<span class='text-warning'>待审核</span>";}else{if(e=="confirm"){return"<span class='text-info'>已审核</span>";
}else{if(e=="done"){return"<span class='text-success'>完成</span>";}else{if(e=="invalid"){return"<span class='text-danger'>作废</span>";}else{return"";}}}}}},{name:"status",index:"status_",width:120,hidden:true},{name:"__manage",width:40,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns()}],gridComplete:function(){var e=$(".jqGrid_wrapper").find("tr.footrow");
e.find("td").hide();e.find('td[aria-describedby*="_id"]').show();},onSelectRow:function(f,e){a.onSelectRow(f,e);},});}};