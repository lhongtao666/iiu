function WaitDeliver(){this.hadInit=false;this.gridRecordsSpan=null;this.soEntityExport=new SoEntityExport();this.canShowScTrankNo="cannot";this.simpleShowLastFollow=(simpleShowLastFollow=="n"?false:true);
this.simpleShowComment=(simpleShowComment=="n"?false:true);this.simpleShowProdName=(simpleShowProdName=="n"?false:true);this.soEntityShipModel="simple";
this.soItemPos=[];this.soEntityPo=null;this.currentIsSendSmsStr=currentIsSendSmsStr;}WaitDeliver._CONS_={MERGE_SO_URL:ctx+"/ec/salesorder/soEntity/mergeSo.htm",LIST_DATA_URL:ctx+"/ec/salesorder/soEntity/listData.htm",DELIVER_URL:ctx+"/ec/salesorder/soEntity/deliver.htm",SAVE_GRID_URL:ctx+"/ec/salesorder/soEntity/saveGrid.htm",SEND_HOTPRINT_URL:ctx+"/ec/salesorder/soEntity/batchHotPrint.htm",IMPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importDeliverInfo.htm",SHIP_PACK_URL:ctx+"/ec/salesorder/soEntity/shipPack.htm",UPDATE_WEIGHT_URL:ctx+"/ec/salesorder/soEntity/updateWeight.htm",GRID:"#soEntityPackGrid",PAGER:"#soEntityPackPager",PACK_FORM_ID:"soEntityPackForm",};
WaitDeliver.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();if(a.gridRecordsSpan){this.gridRecordsSpan=a.gridRecordsSpan;
}if(a.canShowScTrankNo){this.canShowScTrankNo=a.canShowScTrankNo;}if(a.soEntityShipModel){this.soEntityShipModel=a.soEntityShipModel;}this._initJqgrid();
this._hideNotGrantBtn();this._initEmployeeSuggest();this._buildEmployeeSelect();StoreUtils.loadData({container:"storeId",isSale:false});StoreUtils.loadData({container:"store-id1",isSale:false});
ShipCompanyUtils.getOptions({container:"scCodeQry1",caption:"全部"});if(this.currentIsSendSmsStr=="y"){$(".sendSms").each(function(){$(this)[0].checked=true;
});}else{$(".sendSms").each(function(){$(this)[0].checked=false;});}if(this.soEntityShipModel=="ec"){$(".soEntityWrap").show();$(".soEntityDeliver").hide();
}}else{$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeePackSearch").empty().append(d.toString()).select2();
$("#placerSearch").empty().append(d.toString()).select2();}}});},clear:function(c){var a=this;function b(){a._showListWrapper();if(c){$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");
}}b();},_showListWrapper:function(){$("#tabSoWaitDeliver").find(".pack_wrapper").hide();$("#tabSoWaitDeliver").find(".list_wrapper").show();},_showPackWrapper:function(){$("#tabSoWaitDeliver").find(".list_wrapper").hide();
$("#tabSoWaitDeliver").find(".pack_wrapper").show();},resSearchGrid:function(){$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WaitDeliver._CONS_.GRID,a);
this.onSelectRow();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("soEntityShip.button.soAddLock")){$(".soAddLock").hide();}if(!ResUtils.canShow("soEntityShip.button.soUnLock")){$(".soUnLock").hide();
}ConfigUtils.findByKey("soEntity.isSelectStoreInShip",function(a){if(a.success==false){$(".storeBatchUpdate").hide();}});if(!ResUtils.canShow("soEntity.button.shipCompanyBatchUpdate")){$(".shipCompanyBatchUpdate").hide();
}if(!ResUtils.canShow("soEntity.button.selectStoreDeliver")){$(".selectStoreDeliver").hide();}if(!ResUtils.canShow("soEntity.button.storeBatchUpdate")){$(".storeBatchUpdate").hide();
}if(!ResUtils.canShow("soEntity.button.soEntityMerge")){$(".soEntityMerge").hide();}if(!ResUtils.canShow("soEntity.button.packing")){$(".soEntityPrintPack").hide();
}if(!ResUtils.canShow("soEntity.button.exportShip")){$(".soEntityPrintDeliver").hide();$(".printDeliverBtn").hide();}if(!ResUtils.canShow("soEntityStock.button.scPrint")){$(".soEntityPrintShip").hide();
$(".printShipBtn").hide();}if(!ResUtils.canShow("soEntity.button.printHot")){$(".soEntityPrinthot").hide();}if(!ResUtils.canShow("soEntity.button.hotPrint")){$(".soEntityHotPrint").hide();
$(".scHotPrintBtn").hide();}if(!ResUtils.canShow("soDeliver.button.setShipTmp")){$(".soEntitySetShipTmp").hide();}if(!ResUtils.canShow("soEntity.button.deliver")){$(".soEntityDeliver").hide();
}if(!ResUtils.canShow("soEntity.button.backDeliver")){$(".deliverBackBtn").hide();}if(!ResUtils.canShow("soEntity.button.turndown")){$(".soEntityTrunDown").hide();
$(".turnDownUpdate").hide();}if(!ResUtils.canShow("soEntity.button.exportDeliver")){$(".exportDeliverInfo").hide();}if(!ResUtils.canShow("soEntity.button.importDeliverInfo")){$(".importDeliverInfo").hide();
}if(!ResUtils.canShow("soEntity.button.close")){$(".soEntityClose").hide();}if(!ResUtils.canShow("soEntity.button.close")){$(".soEntityClose").hide();}if(!ResUtils.canShow("soEntity.button.sendSmsDeliver")){$(".sendSmsWhenDeliver").hide();
this.currentIsSendSmsStr="n";}if(!ResUtils.canShow("soEntity.button.splitOrder")){$(".soEntitySplitOrder").hide();}if(!ResUtils.canShow("soEntity.button.wrap")){$(".soEntityWrap").hide();
}if(!ResUtils.canShow("soEntity.button.backAwPack")){$(".soEntityBackAwPack").hide();}},_bilidScCodeQrySearch:function(c,a,b){var d=new StringBuffer();
$("#soEntityWaitDeliverSearchForm").find(".scCodeQry option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");
}});c=c+"&scCodeQry="+d.toString();return c;},_bilidCashTypeSearch:function(d,a,c){var b=new StringBuffer();$("#soEntityWaitDeliverSearchForm").find(".cashType option:selected").each(function(e){b.append($(this).val());
if(e==c-1){return false;}else{b.append(",");}});d=d+"&cashType="+b.toString();return d;},_showMergeSo:function(b,c){var a=this;a.layerIndex=layer.open({type:1,title:'订单合并<span style="color:red;padding-left:12px;">请谨慎操作，合并后无法恢复</span>',shadeClose:false,btn:["保存","关闭"],area:["30%","40%"],content:$(".mergeSoPanel"),scrollbar:false,success:function(d,e){var f=new StringBuffer();
f.append("<option value='"+c[0]+"'>"+c[0]+"</option>");$("#mergeToSo").empty().append(f.toString());},yes:function(e,d){var f=$("#mergeToSo").val();a._mergeSo(f,b,c);
},cancel:function(){}});},_splitSo:function(b,c,d){var a=this;$("#splitSoModalContainer").modal("show");$(".splitSoListContent").hide();$(".splitSoBtnContent").hide();
$(".splitSoListDiv").empty();$("#splitSoModal").text(b+" -- 订单拆分");a._buildSplitStr(b,c);},_wrapSo:function(b){var a=this;$("#wrapSoForm").find("input[name=soId]").val(b);
a._openAssignLayer();},_openAssignLayer:function(){self=this;var a=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");layer.open({type:1,title:"订单包装",maxmin:false,scrollbar:false,shadeClose:true,btn:["确定","取消"],area:["40%","40%"],content:$("#wrapSoModalContainer"),yes:function(c,b){self.layerIndex=c;
$(".layui-layer-btn0").hide();var d=$("#wrapSoModalContainer #employeeInput").attr("data-id");self.saveWrapSo();},end:function(){$("#wrapSoForm input[name='employeeSearch']").attr({"data-id":""});
$("#wrapSoForm input[name='employeeSearch']").val("");document.getElementById("wrapSoForm").reset();layer.close(index);}});},saveWrapSo:function(){var c=$("#wrapSoForm").find("input[name=weight]").val();
var b=$("#wrapSoForm").find("input[name=volume]").val();var a=$("#wrapSoForm").find("input[name=soId]").val();var d=$("#wrapSoForm input[name='employeeSearch']").attr("data-id");
FormUtils.submit(WaitDeliver._CONS_.UPDATE_WEIGHT_URL,"soIds="+a+"&weight="+c+"&volume="+b+"&empId="+d,function(e){if(e.success){$("input[name='employeeSearch']").attr({"data-id":""});
$("input[name='employeeSearch']").val("");layer.close(self.layerIndex);self._soEntityDeliver();}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_initEmployeeSuggest:function(){var a=this;$("#wrapSoForm input[name='employeeSearch']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?keyword=",effectiveFields:["aid","name","orgName","newCs"],searchFields:["aid","name"],effectiveFieldsAlias:{aid:"工号",name:"姓名",orgName:"部门",newCs:"新进"},showBtn:false,idField:"id",twoWayMatch:false,autoSelect:false,ignorecase:true,keyField:"aid",allowNoKeyword:true,multiWord:false,getDataMethod:"firstByUrl",delayUntilKeyup:false,showHeader:true,processData:function(b){var h=[];
$(".tag-list li").each(function(){h.push($(this).attr("aidVal"));});var g=[];if(b&&b.value){for(var f=0;f<b.value.length;f++){var e=b.value[f];var d=false;
for(var c=0;c<h.length;c++){if(e.aid==h[c]){d=true;break;}}if(!d){g.push(e);}}}b.value=g;return b;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(c,b){a.searchEmployees=b.value;
}).on("onSetSelectValue",function(d,b){for(var c=0;c<a.searchEmployees.length;c++){if(b.id==a.searchEmployees[c].id){$("input[name='employeeSearch']").val(a.searchEmployees[c].aid);
break;}}});},_splitSoSave:function(){var i=[];var g=0;var h=[];var f="";var b="";var j="";var a="";var c="";var e=false;var d=parseFloat($(".splitAmountDiv").text());
if(d!=(this.soEntityPo.totalAmount-this.soEntityPo.subAmount)){DialogUtils.error(msgCode.ERROR,"拆分金额必须等于订单总金额");return false;}$(".splitSoListDiv tbody").find("tr").each(function(){g++;
if($(this).attr("count")){f=$(this).attr("soId");b=$(this).attr("soNo");j=$(this).find("input[name=splitShipTime]").val();a=$(this).attr("count");c=$(this).find(".splitAmount").val();
}var l={itemId:$(this).find(".itemCount").attr("itemId"),count:$(this).find(".splitCountItem").val(),};if(l.count<0){e=true;return;}h.push(l);if(g==a){var k={id:f,soNo:b,shipTime:j,soItems:h,totalAmount:c};
i.push(k);g=0;h=[];}});if(e){DialogUtils.error(msgCode.ERROR,"产品数量不能小于0");return;}FormUtils.submit(ctx+"/ec/salesorder/soEntity/splitOrder.htm","splitPos="+JSON.stringify(i),function(k){if(k.success){$("#splitSoModalContainer").modal("hide");
DialogUtils.success(msgCode.SUCCESS,k.msg);$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,k.msg);
}});},_backAwPack:function(a){FormUtils.submit(ctx+"/ec/salesorder/soEntity/backAwPack.htm","soIds="+a,function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,b.msg);
$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_buildSplitStr:function(b,c){var a=this;var d=new StringBuffer();$("#splitSoForm").find("input[name=soNo]").val(b);$("#splitSoForm").find("input[name=soId]").val(c);
FormUtils.submit(ctx+"/ec/salesorder/soEntity/edit.htm","soNo="+b,function(g){var f=g.soEntityPo.soItemPos;a.soItemPos=f;a.soEntityPo=g.soEntityPo;d.append("<table class='table table-bordered'>");
d.append("<thead>");d.append("<tr>");d.append("<th width='10%'>#</th>");d.append("<th width='30%'>商品名称</th>");d.append("<th width='15%'>总数量</th>");d.append("<th width='20%'>待分金额</th>");
d.append("<th width='25%'>拆分次数</th>");d.append("</tr>");d.append("</thead>");d.append("</tbody>");for(var e=0;e<f.length;e++){d.append("<tr>");d.append("<td>"+(e+1)+"</td>");
d.append("<td>"+f[e].prodName+"</td>");d.append("<td>"+f[e].count+"</td>");if(e==0){d.append("<td rowspan='"+f.length+"'>"+(g.soEntityPo.totalAmount-g.soEntityPo.subAmount)+"</td>");
d.append("<td rowspan='"+f.length+"'><div class='col-sm-8'><input type='number' class='form-control splitCount' validatetype='default'></div>");d.append("<button type='button' class='btn btn-sm  btn-primary splitPordBtn'>拆分</button>");
d.append("</td>");}d.append("</tr>");}d.append("</tbody>");d.append("</table>");$(".splitPordDiv").empty().append(d.toString());});},_mergeSo:function(e,c,d){var b=this;
var a=WaitDeliver._CONS_.MERGE_SO_URL;FormUtils.submit(a,{toSo:e,soNos:d,soIds:c,needValid:"y"},function(f){if(f.success){DialogUtils.success(msgCode.INFO,f.msg);
layer.close(b.layerIndex);$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);layer.close(b.layerIndex);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},updateStore:function(b,c){var a=ctx+"/ec/salesorder/soEntity/updateStore.htm";FormUtils.submit(a,{storeId:b,selectedIds:c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"修改结束");
$("#storeBatchUpdateModal1").modal("hide");$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.warning(msgCode.FAIL_MSG,d.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},updateShipCompany:function(b,c){var a=ctx+"/ec/salesorder/soEntity/updateShipCompany.htm";
FormUtils.submit(a,{scCode:b,selectedIds:c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);$("#shipCompanyBatchUpdateModal1").modal("hide");
$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},destroyTipPopover:function(a){a.popover("destroy");},_bulidSoType:function(c,b){var a=this;var d=new StringBuffer();$("#soEntityWaitDeliverSearchForm").find(".soTypeQry option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&soType="+d.toString();return c;},_bindEventHander:function(){var a=this;$(".wait_deliver_wrapper").on("click",".soEntityBackAwPack",function(){var b=$(this).attr("idVal");
if(!b){b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要包装的记录");return;}}var c=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);
DialogUtils.confirmWithOptions({title:"您确定要撤销选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._backAwPack(b.toString());}});});$(".wait_deliver_wrapper").on("click",".soEntityWrap",function(){var b=$(this).attr("idVal");
if(!b){b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要包装的记录");return;}}var c=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);
a._wrapSo(b.toString());});$(".wait_deliver_wrapper").on("click",".soAddLock",function(){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要冻结的订单");return;}DialogUtils.confirmWithOptions({title:"您确定要冻结选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.lock(b);
}});});$(".wait_deliver_wrapper").on("click",".soUnLock",function(){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要解冻的订单");
return;}DialogUtils.confirmWithOptions({title:"您确定要解冻选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.unLock(b);}});});$("#storeBatchUpdateModal1").on("click","#storeBatchUpdateBtn1",function(){var b=$("#store-id1").val();
var c=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");a.updateStore(b,c);});$("#shipCompanyBatchUpdateModal1").on("click","#shipCompanyBatchUpdateBtn1",function(){var b=$("#scCodeQry1").val();
var d=$("#scCodeQry1").text();var c=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");DialogUtils.confirmWithOptions({title:"确定修改选中记录快递公司？",text:"",confirmButtonText:"确定",yesFunc:function(){a.updateShipCompany(b,c);
}});});$(".wait_deliver_wrapper").on("click",".storeBatchUpdate",function(){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");
return;}$("#storeBatchUpdateModal1").modal("show");});$(".wait_deliver_wrapper").on("click",".shipCompanyBatchUpdate",function(){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}$("#shipCompanyBatchUpdateModal1").modal("show");});$(".wait_deliver_wrapper").on("click",".soEntityMerge",function(){var i=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(i==null||i.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(i.length!=2){DialogUtils.error("错误","只支持2张订单合并");return;}var g=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",i[0]);
var e=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",i[1]);if(g.csId!=e.csId){DialogUtils.error("错误","订单所属客户必须相同");return;}if(g.cashType!=e.cashType){DialogUtils.error("错误","货款方式必须相同");
return;}var h=$("[row-id="+i[0]+"]").val();var f=$("[row-id="+i[1]+"]").val();if(h!=""||f!=""){DialogUtils.error("错误","已录入快递单号的订单不能合并");return;}var d=[];
var k=g.isSplitOrderHide;var j=e.isSplitOrderHide;if(k==null||k==""){k="n";}if(j==null||j==""){j="n";}var c=g.originSoId;var b=e.originSoId;if(k=="n"&&j=="n"){d.push(g.soNoShow);
d.push(e.soNoShow);a._showMergeSo(i,d);}else{if(k=="n"&&j=="y"){if(g.id==e.originSoId){d.push(g.soNoShow);d.push(e.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","非父子关系的订单不能合并");
return;}}else{if(k=="y"&&j=="n"){if(g.originSoId==e.id){d.push(g.soNoShow);d.push(e.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","非父子关系的订单不能合并");
return;}}else{if(g.originSoId==e.originSoId){d.push(e.soNoShow);d.push(g.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","不属于同一源订单的子订单不能合并");
return;}}}}});$(".wait_deliver_wrapper").on("click",".soEntitySearch",function(){if($(".wait_deliver_wrapper").find(".searchProd").val()==""){$(".wait_deliver_wrapper").find(".skuSearch").val("");
}var d=$(this).closest("form").serialize();var b=$("#soEntityWaitDeliverSearchForm").find(".scCodeQry option:selected").length;if(b!=0){d=a._bilidScCodeQrySearch(d,a,b);
}var c=$("#soEntityWaitDeliverSearchForm").find(".cashType option:selected").length;if(c!=0){d=a._bilidCashTypeSearch(d,a,c);}var e=$("#soEntityWaitDeliverSearchForm").find(".soTypeQry option:selected").length;
if(e!=0){d=a._bulidSoType(d,e);}a.reloadJqgrid(d);});$("#soEntityWaitDeliverSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$(".wait_deliver_wrapper").on("click",".soEntityDeliver",function(){a._isSendMassage();});$("body").on("click",".selectStoreWait",function(){var b=$("#storeId").val();
if(b){a._soEntityDeliver(b);}else{DialogUtils.error("提示","请先选择仓库");}});$(".wait_deliver_wrapper").on("click",".soEntityTrunDown",function(){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要处理的订单");return;}var e=new Array();for(var c=0;c<b.length;c++){var d=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b[c]);
e.push(d["soNoShow"]);}SoEntityUtils.trunDownOrderLayer(b,e,function(){a.clear(true);});});$("#tabSoWaitDeliver").on("click",".showSoDetail",function(){var g=$(this).attr("id-value");
var b=[];var e=$(WaitDeliver._CONS_.GRID).getRowData();var c=false;if(e&&e.length>0){for(var d=0;d<e.length;d++){if(e[d].id==g){c=true;}if(c){var f={id:e[d].id,soNo:e[d].soNoShow};
b.push(f);}}}SoEntityUtils.toDeliver(b);});$(".wait_list_wrapper").on("blur",".scTrackingNoInput",function(){var c=$(this).val();var b=$(this).attr("org-value");
var d=$(this).parents("tr").attr("id");if(c!=b){a._saveScTrackingNo(d,c,this);}});$(".wait_list_wrapper").on("keyup",".scTrackingNoInput",function(d){if(d.keyCode=="13"){var e=false;
var c=$(this).val();var f=$(this).parents("tr").attr("id");if(!e){var b=$(this).attr("org-value");if(c!=b){a._saveScTrackingNo(f,c,this,true);}}else{a._autoMatchSoShip(f,c,this);
}}else{if(d.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".wait_list_wrapper").on("blur",".weightInput",function(){var c=$(this).val();
var b=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");if(c!=b){a._saveWeight(d,c,this);}});$(".wait_list_wrapper").on("keyup",".weightInput",function(c){if(c.keyCode=="13"){$(this).blur();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".wait_list_wrapper").on("blur",".actualAmountInput",function(){var b=$(this).val();
var c=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");if(b!=c){a._saveActualAmount(d,b,this);}});$(".wait_list_wrapper").on("keyup",".actualAmountInput",function(c){if(c.keyCode=="13"){$(this).blur();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".wait_deliver_wrapper").on("change","#autoAddNumValue",function(){var b=$(this).val();
if(parseInt(b)<=0){$(this).val(1).focus();}});$(".wait_deliver_wrapper").on("change","#belongOgnPackSearch",function(){$("#belongEmployeePackSearch").empty().append("<option value=''>请选择</option>");
if($(this).val()){SoEntityUtils.buildEmployeeOption($(this).val(),"belongEmployeePackSearch");}});$(".wait_deliver_wrapper").on("click",".skuSearchImg",function(){SelectProdService.selectSku({isMultiple:0,hideCanSale:"y",fn:function(b){for(var c=0;
c<b.length;c++){$(".wait_deliver_wrapper").find("input[id=skuSearch]").val(b[c].skuId);}}});});$(".wait_deliver_wrapper").on("click",".exportDeliverInfo",function(){if($(".wait_deliver_wrapper").find(".searchProd").val()==""){$(".wait_deliver_wrapper").find(".skuSearch").val("");
}var c=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");var f="isSelectStoreInShip=n&refundStatusIsNull=y&Q__S__EQ__entity.status_=comfirm"+"&"+$("#soEntityWaitDeliverSearchForm").closest("form").serialize();
var b=$("#soEntityWaitDeliverSearchForm").find(".scCodeQry option:selected").length;if(b!=0){f=a._bilidScCodeQrySearch(f,a,b);}var e=$("#soEntityWaitDeliverSearchForm").find(".cashType option:selected").length;
if(e!=0){f=a._bilidCashTypeSearch(f,a,e);}var d=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","records");a.soEntityExport.init({params:f,selectIds:c,toatolCount:d});
});$(".wait_deliver_wrapper").on("click",".soEntityPrintPack",function(){a.soEntityExport.exportPack(WaitDeliver._CONS_.GRID);});$(".wait_deliver_wrapper").on("click",".importDeliverInfo",function(){var b={"importUrl":WaitDeliver._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入发货订单excel数据"};
excelUtil.importExcel(b);});$(".wait_deliver_wrapper").on("click",".soEntityPrintDeliver",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");
return null;}var c=[];var b="ship_proxy";var d=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(d==null||d.length==0){DialogUtils.error("错误","请选择要打印快递单的订单");
return null;}var j=new StringBuffer();for(var f=0;f<d.length;f++){var g=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",d[f]);var h=g["shipName"];j.append(g["soNoShow"]+",");
}var e=j.toString();e=e.substring(0,e.length-1);JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=out_sale&entityId="+d+"&soNo="+e+"&scName="+h+"&proxyType="+b,"发货单打印");
});$(".wait_deliver_wrapper").on("click",".soEntityPrintShip",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");
return null;}var c=[];var f=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(f==null||f.length==0){DialogUtils.error("错误","请选择要打印快递单的订单");
return null;}var g=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",f[0]);var n=g.shipName;var j="ship_proxy";var k=false;var m=new StringBuffer();for(var h=0;
h<f.length;h++){var e=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",f[h]);var l=e.shipName;if(l!=n){DialogUtils.error("错误","请先确定所有订单是否是同类型的快递公司");return null;
}if(e.proxyAmount!=0){k=true;}var b=e["shipName"];m.append(e["soNoShow"]+",");}if(!k){j="ship_not_proxy";}var d=m.toString();d=d.substring(0,d.length-1);
JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=ship&entityId="+f+"&soNo="+d+"&scName="+b+"&proxyType="+j,"普通快递单打印");
});$(".wait_deliver_wrapper").on("click",".soEntityHotPrint",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印热敏纸");
return null;}var d=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(d==null||d.length==0){DialogUtils.error("错误","请选择要打印热敏纸的订单");return null;
}var e=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",d[0]);var l=e.shipName;var g="ship_proxy";var h=false;var k=new StringBuffer();for(var f=0;f<d.length;
f++){var c=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",d[f]);var j=c.shipName;if(j!=l){DialogUtils.error("错误","请选择同类快递公司");return null;}if(c.proxyAmount!=0){h=true;
}k.append(c["soNoShow"]+",");}if(!h){g="ship_not_proxy";}var b=k.toString();b=b.substring(0,b.length-1);JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=hotsensitive&entityId="+d+"&soNo="+b+"&scName="+j+"&proxyType="+g,"热敏快递单打印");
});$(".wait_deliver_wrapper").on("click",".soEntityPrinthot",function(){var b=$(this).attr("idVal");if(!b){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要发送热敏纸的订单");return null;}}if(b&&b.length==1){var d=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);
var c=d["scTrackingNoShow"];if(c){DialogUtils.error("错误","已存在快递单号");return;}}ConfigUtils.findByKey("soEntity.isSendMotherwork",function(e){if(e.success){$("#printhotModalContainer").modal("show");
$("#printhotModalContainer").find("input[name=soId]").val(b);}else{ButtonUtils.disableBtn("soEntityPrinthot");FormUtils.submit(WaitDeliver._CONS_.SEND_HOTPRINT_URL+"?isStore=false&soId="+b,null,function(f){if(f.success){DialogUtils.success(msgCode.SUCCESS,f.msg);
a.clear(true);}else{ButtonUtils.enableBtn("soEntityPrinthot");DialogUtils.error(msgCode.ERROR,f.msg);}},function(){ButtonUtils.enableBtn("soEntityPrinthot");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});});$("body").on("click",".printhotBtn",function(){var c=$("#printhotModalContainer").find("input[name=packQuantit]").val();
var b=$("#printhotModalContainer").find("input[name=soId]").val();ButtonUtils.disableBtn("printhotBtn");FormUtils.submit(WaitDeliver._CONS_.SEND_HOTPRINT_URL+"?isStore=false&soId="+b+"&packQuantit="+c,null,function(d){if(d.success){$("#printhotModalContainer").modal("hide");
DialogUtils.success(msgCode.SUCCESS,d.msg);$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{ButtonUtils.enableBtn("printhotBtn");DialogUtils.error(msgCode.ERROR,d.msg);
}},function(){ButtonUtils.enableBtn("printhotBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".wait_deliver_wrapper").on("click",".selectStoreDeliver",function(){var b=$(this).attr("idVal");
if(!b){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要发送热敏纸的订单");return null;
}}if(b&&b.length==1){var d=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);var c=d["scTrackingNoShow"];if(c){DialogUtils.error("错误","已存在快递单号");return;
}}ButtonUtils.disableBtn("selectStoreDeliver");FormUtils.submit(WaitDeliver._CONS_.SEND_HOTPRINT_URL,"isStore=true&soId="+b,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);
a.clear(true);}else{ButtonUtils.enableBtn("selectStoreDeliver");DialogUtils.error(msgCode.ERROR,e.msg);}},function(){ButtonUtils.enableBtn("selectStoreDeliver");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".wait_deliver_wrapper").on("click",".soEntitySetShipTmp",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/ship/shipCompany/list.htm","物流公司");
});$(document).on("change","#tabSoWaitDeliver .lastFollow",function(){var b=$(this)[0].checked;if(b){a.simpleShowLastFollow=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").show();
$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").hide();}else{a.simpleShowLastFollow=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").hide();
$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").show();}});$(document).on("change","#tabSoWaitDeliver .orderDesc",function(){var b=$(this)[0].checked;
if(b){a.simpleShowComment=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").show();$(this).parents(".jqGrid_wrapper").find(".comment-detail").hide();
}else{a.simpleShowComment=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").hide();$(this).parents(".jqGrid_wrapper").find(".comment-detail").show();
}});$(document).on("change","#tabSoWaitDeliver .isShowProdName",function(){var b=$(this)[0].checked;if(b){a.simpleShowProdName=true;window.localStorage.removeItem("simpleShowProdName");
$(this).parents(".jqGrid_wrapper").find(".tooltip-prodName").show();$(this).parents(".jqGrid_wrapper").find(".prodName-detail").hide();}else{a.simpleShowProdName=false;
window.localStorage.setItem("simpleShowProdName",true);$(this).parents(".jqGrid_wrapper").find(".tooltip-prodName").hide();$(this).parents(".jqGrid_wrapper").find(".prodName-detail").show();
}});$(".wait_deliver_wrapper").on("click",".soEntitySplitOrder",function(){var b=$(this).attr("idVal");if(!b){b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要拆分的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能拆分多条记录");return;
}}}var d=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);var c=d["soNoShow"];a._splitSo(c,b.toString());});$(".delay_ship_wrapper").on("click",".soEntitySplitOrder",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要拆分的记录");
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能拆分多条记录");return;}}}var d=$(DelayShip._CONS_.GRID).jqGrid("getRowData",b);var c=d["soNoShow"];
a._splitSo(c,b.toString());});$("body").on("click",".splitPordBtn",function(){var b=$(".splitCount").val();if(b){a._splitSoList(b);}else{DialogUtils.error(msgCode.ERROR,"请填写拆分次数",$("div.splitSoPane"));
}});$("body").on("click",".splitSoBtn",function(){a._splitSoSave();});$("body").on("change",".splitCountItem",function(){$(this).parent().addClass("isUpdated");
var b=$(this).parent().attr("itemProd");var e=$(this).parent().attr("itemCountTotal");var c=$(this).val();var d=$(this).parent().attr("itemCount");$(this).parents("tr").eq(0).find(".splitMoney").text(c*$(this).parents("tr").eq(0).find(".splitMoney").attr("splitPrice"));
$(".splitSoListDiv tbody").find("."+b).each(function(){if(!$(this).hasClass("isUpdated")){var f=$(this).attr("itemCount")-(c-d);$(this).find(".splitCountItem").val(f);
$(this).parents("tr").eq(0).find(".splitMoney").text(f*$(this).parents("tr").eq(0).find(".splitMoney").attr("splitPrice"));return false;}});$(this).removeClass("isUpdated");
});$("body").on("change",".splitAmount",function(){var m=0;var e=0;var b=$(this).val();var g=$(this).closest("tr");var o=$($(this).closest("td")).attr("rowspan");
var t=$(g);var h=[];h.push(t);var j=false;if(parseInt(o)>1){var d=t;for(var n=0;n<parseInt(o)-1;n++){var s=d.next();var f=$(s);d=f;h.push(f);}}for(var n=0;
n<h.length;n++){var q=$(h[n]).find(".splitCountItem").val();var p=$(h[n]).find(".prodSkuPrice").text();var r=parseInt($(h[n]).find(".skuPercentLimit").text());
if(!r){r=0;}var c=parseFloat(r);if(percentLimit&&parseInt(percentLimit)&&parseInt(percentLimit)<c||c<1){c=parseInt(percentLimit);}if(parseFloat(c)>0){e=parseFloat(e)+parseFloat(parseFloat(p)*parseInt(q)*parseFloat(c)/100).toFixed(2);
j=true;}else{e=parseFloat(e)+parseFloat(parseFloat(p)*parseInt(q)).toFixed(2);}}if(j&&parseFloat(b)<parseFloat(e)){var l=$(this);var k="商品有折扣限制, 最低金额为"+parseFloat(e);
l.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+k+"</h4>").attr("data-html","true").attr("data-placement","bottom");
l.popover("show");l.val(parseFloat(e));setTimeout(function(){a.destroyTipPopover(l);},3000);}$(".splitSoListDiv tbody").find(".splitAmount").each(function(){m=m+parseFloat($(this).val());
});$(".splitAmountDiv").empty().append(m);});},_isSendMassage:function(){var a=this;layer.open({title:"<span style='font-weight:600;font-size:18px'>是否发送短信</span>",type:1,btnAlign:"c",btn:["确定"],area:["300px","200px"],zIndex:"9999",skin:"layui-layer-demo",closeBtn:1,anim:2,content:$(".jt-send-massage"),shadeClose:true,yes:function(c,b){a._soEntityDeliver();
layer.close(c);},});},_shipPack:function(a){FormUtils.submit(WaitDeliver._CONS_.SHIP_PACK_URL,{ids:a},function(b){if(b.success){DialogUtils.success(msgCode.INFO,b.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_splitSoList:function(a){var n=this;
var l=new StringBuffer();var k=n.soItemPos;var g=n.soEntityPo;l.append("<table class='table table-bordered'>");l.append("<thead>");l.append("<tr>");l.append("<th width='5%'>#</th>");
l.append("<th width='12%'>拆分订单</th>");l.append("<th width='25%'>产品名称</th>");l.append("<th style='display:none;'>折扣限制</th>");l.append("<th style='display:none;'>商品原价</th>");
l.append("<th width='12%'>拆出数量</th>");l.append("<th width='12%'>产品金额</th>");l.append("<th width='12%'>订单金额</th>");l.append("<th width='22%'>发货时间</th>");
l.append("</tr>");l.append("</thead>");l.append("<tbody>");var c=g.totalAmount-g.subAmount;var f=parseInt(c/a);var b=c-(f*(a-1));if(b.toString().indexOf(".")!=-1){b=b.toFixed(2);
}$(".splitAmountDiv").empty().append(c);for(var e=1;e<=a;e++){var m=0;for(var d=0;d<k.length;d++){var h=parseInt((k[d].count/a).toFixed(0));m=e*h;if(m>k[d].count){h=k[d].count-((e-1)*h);
}else{if(e==a&&m<k[d].count){h=(k[d].count-m)+h;}}if(a==1){break;}else{l.append("<tr");if(d==0){if(e==1){l.append(" soId="+$("#splitSoForm").find("input[name=soId]").val()+" soNo="+$("#splitSoForm").find("input[name=soNo]").val());
}l.append(" count="+k.length+">");l.append("<td rowspan='"+k.length+"'>"+e+"</td>");if(e==1){l.append("<td rowspan='"+k.length+"'>"+$("#splitSoForm").find("input[name=soNo]").val()+"</td>");
}else{l.append("<td rowspan='"+k.length+"'></td>");}}else{l.append(">");}l.append("<td >"+k[d].prodName+"</td>");l.append("<td style='display:none;' class='skuPercentLimit'>"+k[d].skuPercentLimit+"</td>");
l.append("<td style='display:none;' class='prodSkuPrice'>"+k[d].prodSkuPrice+"</td>");l.append("<td class='itemCount itemPord"+d+"' itemProd=itemPord"+d+" ");
l.append("itemCount="+h+" itemCountTotal="+k[d].count+" itemId="+k[d].id+"><input type='number' class='form-control splitCountItem' validatetype='default' value='"+h+"'></td>");
l.append("<td class='splitMoney' splitPrice="+k[d].salesPrice+">"+(k[d].salesPrice*h).toFixed(1)+"</td>");if(d==0){l.append("<td rowspan='"+k.length+"'><input type='number' class='form-control splitAmount' validatetype='default' value='"+(e==a?b:f)+"'></td>");
}if(d==0){l.append("<td rowspan='"+k.length+"'><input class='laydate-icon form-control layer-date' name='splitShipTime' placeholder='yyyy-mm-dd hh:mm:ss' onclick='laydate({istime: true, min: laydate.now(1), format: \"YYYY-MM-DD hh:mm:ss\"})'></td>");
l.append("</tr>");}}}}l.append("</tbody>");l.append("<tfoot>");l.append("<tr>");l.append("<td colspan='4'></td>");l.append("<td>拆分金额:</td>");l.append("<td colspan='2' class='splitAmountDiv'>"+c+"</td>");
l.append("</tr");l.append("</tfoot>");l.append("</table>");$(".splitSoListContent").show();$(".splitSoBtnContent").show();$(".splitSoListDiv").empty().append(l.toString());
},_soEntityDeliver:function(a){var c=this;var b=$(".soEntityDeliver").attr("idVal");if(!b){b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要发货的订单");return null;}for(var d=0;d<b.length;d++){var f=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b[d]);
var e=$(f.scTrackingNo).attr("org-value");var a=f["storeId"];if(e==""||e==null||e.trim()==""){DialogUtils.error("错误","请先确定是否已有快递单");return null;}if(a==""||a==null||a.trim()==""){DialogUtils.error("错误","请先确定是否已选择仓库");
return null;}}}else{var f=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);var e=$(f.scTrackingNo).attr("org-value");var a=f["storeId"];if(e==""||e==null||e.trim()==""){DialogUtils.error("错误","请先确定是否已有快递单");
return null;}if(a==""||a==null||a.trim()==""){DialogUtils.error("错误","请先确定是否已选择仓库");return null;}}var g=$("input[name='sendSms'")[0].checked;DialogUtils.confirmWithOptions({title:!g?"您确认不发送短信，直接将订单更改为已发货状态吗？":"您确定发货吗？",text:"",confirmButtonText:"确定",yesFunc:function(){c._deliver(b,g,a);
}});},_autoMatchSoShip:function(a,h,k){var g={soId:a,key:"scTrackingNo",value:h};this._saveEditGrid(g,k);var j={};var c=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");
var d=parseInt($("#autoAddNumValue").val());if(c.length<1){return;}else{j[a]=true;var l=0;for(var f=0;f<c.length;f++){var e=$("#"+c[f]).find(".scTrackingNoInput");
if(e.val()==""||e.val()==null){if(!j[c[f]]){j[c[f]]=true;l+=d;var b={soId:c[f],key:"scTrackingNo",value:parseInt(h)+parseInt(l)};this._saveEditGrid(b,e);
}}}}},_saveScTrackingNo:function(e,c,b,a){var d={soId:e,key:"scTrackingNo",value:c};this._saveEditGrid(d,b,a);},_saveWeight:function(d,c,a){var b={soId:d,key:"weight",value:c};
this._saveEditGrid(b,a);},_saveActualAmount:function(d,a,b){var c={soId:d,key:"actualAmount",value:a};this._saveEditGrid(c,b);},_saveEditGrid:function(d,c,b){var a=WaitDeliver._CONS_.SAVE_GRID_URL;
FormUtils.submit(a,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);$(c).attr("org-value",d.value);$(c).val(d.value);if($(c).attr("class")=="scTrackingNoInput"){$(c).parent().prev().text(d.value);
}if(b){var f=$(c).parents("tr").nextAll("tr")[0];$(f).find(".scTrackingNoInput").focus();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);$(c).val($(c).attr("org-value"));
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_deliver:function(e,d,b){var c=this;var a=WaitDeliver._CONS_.DELIVER_URL;ButtonUtils.disableBtn("soEntityDeliver");
FormUtils.submit(a,{ids:e,sendSms:d?"y":"n",storeId:b},function(f){ButtonUtils.enableBtn("soEntityDeliver");if(f.success){DialogUtils.success(msgCode.INFO,f.msg);
$("#selectStoreModal").modal("hide");$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);}},function(){ButtonUtils.enableBtn("soEntityDeliver");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},onSelectRow:function(){},_initJqgrid:function(){var c=this;var d=new Date();var f=DateUtils.format(d,"yyyy-MM-dd");
var h=DateUtils.getBeforeDate(7,d);var e=h+" 00:00:00";var b=f+" 23:59:59";$("#soEntityWaitDeliverSearchForm").find(".minPlaceTime").val(e);$("#soEntityWaitDeliverSearchForm").find(".maxPlaceTime").val(b);
var g={"Q__D__BW__entity.place_time_":e};var a=false;ConfigUtils.findByKey("soEntity.isShowExport",function(j){if(j.success){a=true;$(".isExportDiv").show();
}var i=WaitDeliver._CONS_.LIST_DATA_URL+"?positionType=order_print,dept_manager&Q__S__EQ__entity.status_=comfirm&isSelectStoreInShip=n"+"&isWaitDeliverSearch=y"+"&canShowScTrankNo="+c.canShowScTrankNo;
if(soEntityShipModel=="ec"){i+="&Q__S__EQ__entity.pack_status_=aw_wrap";}$(WaitDeliver._CONS_.GRID).JTJqgrid({url:i,pager:WaitDeliver._CONS_.PAGER,width:"100%",autowidth:true,postData:g,footerrow:true,autoScroll:true,userDataOnFooter:true,colNames:["源订单ID(隐藏)","订单编号(隐藏)","订单编号","客户ID","ID","客户名称","客户","货款方式","加急","拆分(hide)","拆分","仓库","下单人","打包人","配货人","商品条目","快递公司","快递单号","快递单号","打印","重量(千克)","运费(元)","代收款(元)","支付状态","最新跟进","订单备注","下单人id","下单时间","货款类型","仓库（隐藏）","更新时间","操作"],simplify:{key:"ddfh",entry:[{"sClass":"lastFollow","sCheck":(c.simpleShowLastFollow?true:false),"sName":"最新跟进"},{"sClass":"orderDesc","sCheck":(c.simpleShowComment?true:false),"sName":"订单备注"},{"sClass":"isShowProdName","sCheck":(c.simpleShowProdName?true:false),"sName":"商品条目"}],must:["订单编号","客户"]},colModel:[{name:"originSoId",index:"origin_so_id_",width:70,hidedlg:true,hidden:true,},{name:"soNoShow",index:"so_no_",width:70,hidedlg:true,hidden:true,formatter:function(k,l,m){if(k&&k.length>0){return k;
}return m.soNo;}},{name:"soNo",index:"so_no_",width:90,formatter:function(l,m,n){if(!ResUtils.canShow("soEntity.button.deliver")){return l;}if(n.footData){$(".ui-jqgrid-title").css({"width":"100%"});
var k="<div class='titleDiv'>"+n.soNoShow+"</div>"+"<div style='float:right;position:relative;'>"+"</div>";$(WaitDeliver._CONS_.GRID).jqGrid("setCaption",k);
$(".titleDiv").attr("title",$(".titleDiv").text());return n.soNoShow;}else{if(n.soNo!=null&&n.soNo!=""){var o=new StringBuffer();o.append("<a href='#' class='showSoDetail' style='font-weight:bold;' value='"+l+"' id-value='"+n.id+"' csNameVal='"+n.csName+"'>"+l+"</a>");
o.append(SoEntityUtils.getTurnBackStr(n.status,n.preStatus));if(a&&n.isExport=="y"){o.append("&nbsp;<span style='color:red'>out</span>");}if(n.isLock=="y"){o.append("&nbsp;<span style='color:red'>冻</span>");
}return o.toString();}}}},{name:"csId",width:120,hidedlg:true,hidden:true},{name:"id",width:120,hidedlg:true,hidden:true},{name:"csNameShow",index:"name_",width:100,hidedlg:true,hidden:true,formatter:function(k,l,m){if(m.footData){return m.soNo;
}else{return m.csName;}}},{name:"csName",index:"name_",width:80,index:"entity.cs_code_",formatter:function(k,m,n){var l=k+":"+n.csCode;if($(window).width()<1024){l=k+"<br>"+n.csCode;
}return"<a href='#' class='csTab' style='font-weight:bold;' title='"+l+"' value='"+n.csId+"''>"+l+"</a>";}},{name:"cashType",index:"cash_type_",width:80,formatter:function(k){return SoEntityUtils.formatCashType(k);
}},{name:"isFast",index:"is_fast_",width:40,formatter:function(l){var k="否";if(l=="y"){k="<span style='color:red;'>是</span>";}return k;}},{name:"isSplitOrderHide",width:50,hidedlg:true,hidden:true,index:"is_split_order_",formatter:function(k,l,m){return m.isSplitOrder;
}},{name:"isSplitOrder",index:"is_split_order_",width:40,formatter:function(l){var k="否";if(l=="y"){k="<span style='color:red;'>是</span>";}return k;}},{name:"storeName",width:90,index:"entity.store_id_"},{name:"placerName",sortable:false,width:90,formatter:function(k,l,m){return"<span>"+m.placerAid+":"+m.placerName+"</span>";
}},{name:"packEmpName",sortable:false,width:90},{name:"allocateEmpName",sortable:false,width:90},{name:"prodNames",sortable:false,width:90,formatter:function(k,l,n){var m="";
if(k!=""&&k!=null){m='<span  style="color:#1ab394;'+(c.simpleShowProdName?"":"display:none")+'" class="tooltip-prodName jt-grid-tip fa fa-bell" data-value="'+k+'"></span>';
m+='<span style="'+(c.simpleShowProdName?"display:none":"")+'" class="prodName-detail">'+k+"</span>";}return m;}},{name:"shipName",width:90,index:"entity.ship_name_"},{name:"scTrackingNoShow",width:70,hidedlg:true,hidden:true,formatter:function(l,k,m){if(m.scTrackingNo==null){m.scTrackingNo="";
}return m.scTrackingNo;}},{name:"scTrackingNo",sortable:true,width:170,index:"entity.sc_tracking_no_",formatter:function(l,k,m){if(c.canShowScTrankNo=="can"){if(l==null){l="";
}return"<input type='text' class='scTrackingNoInput' row-id='"+m.id+"' org-value='"+l+"' style='width:90%;'value='"+l+"' />";}else{return"<span  class='scTrackingNoInput' row-id='"+m.id+"' org-value='"+l+"'>"+l+"</span>";
}}},{name:"print",width:55,sortable:false,formatter:function(k,m,n){var l="";if(n.isPrintHot=="y"){l="<span style='color:blue' title='已打印热敏纸'>热</span>";
}if(n.isPrintHot=="y"&&n.isPrintShip=="y"){l+="<span style='color:red;'>|</span>";}if(n.isPrintShip=="y"){l+="<span style='color:blue' title='已打印快递单'>快</span>";
}return l;}},{name:"weight",width:70,sortable:false,formatter:function(l){var k=l;if(l==null||l==""){k=0;}k=parseInt(k);return"<input type='number' class='weightInput' org-value='"+k+"' style='width:90%;'value='"+k+"' />";
}},{name:"actualAmount",width:70,sortable:false,formatter:function(k){if(k==null||k==""){k=0;}k=parseFloat(k).toFixed(2);return"<input type='number' class='actualAmountInput' org-value='"+k+"' style='width:90%;'value='"+k+"' />";
}},{name:"proxyAmount",index:"entity.proxy_amount_",width:80,formatter:function(k){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat(k/10).toFixed(2);
}else{return parseFloat(k).toFixed(2);}}},{name:"payStatus",width:120,hidedlg:true,hidden:true},{name:"lastFollow",width:120,sortable:false,formatter:function(k){var l='<span  style="color:#1ab394;'+(c.simpleShowLastFollow?"":"display:none")+'" class="tooltip-follow jt-grid-tip fa fa-bell" data-value="'+k+'"></span>';
l+='<span style="'+(c.simpleShowLastFollow?"display:none":"")+'" class="lastFollow-detail">'+k+"</span>";return l;}},{name:"comment",width:120,formatter:function(n,k,m){var l="";
if(n!=""&&n!=null){l='<span  style="color:#1ab394;'+(c.simpleShowComment?"":"display:none")+'" class="tooltip-comment jt-grid-tip fa fa-bell" data-value="'+n+'"></span>';
l+='<span style="'+(c.simpleShowComment?"display:none":"")+'" class="comment-detail">'+n+"</span>";}return l;}},{name:"placerId",width:110,hidedlg:true,hidden:true},{name:"placeTime",width:110,index:"entity.place_time_",formatter:function(k){return DateUtils.mini2Time(k);
}},{name:"storeId",width:100,hidedlg:true,hidden:true,index:"entity.store_id_"},{name:"cashType",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"entity.update_time_",width:110,hidden:true,formatter:function(k){return DateUtils.mini2Time(k);
}},{name:"__manage",width:50,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:[],}],gridComplete:function(){var k=$(WaitDeliver._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
k.find("td").hide();k.find('td[aria-describedby*="_soNoShow"]').show();k.find("td").css({"font-weight":400});k.hide();},loadComplete:function(){if(c.gridRecordsSpan!=null){$(c.gridRecordsSpan).empty().append($(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","records"));
}if(soEntityShipModel=="simple"){$(WaitDeliver._CONS_.GRID).setGridParam().hideCol("packEmpName");$(WaitDeliver._CONS_.GRID).setGridParam().hideCol("allocateEmpName");
}else{$(WaitDeliver._CONS_.GRID).setGridParam().showCol("packEmpName");$(WaitDeliver._CONS_.GRID).setGridParam().showCol("allocateEmpName");}$(WaitDeliver._CONS_.GRID).setGridWidth($(window).width()-30);
$(window).resize(function(){$(WaitDeliver._CONS_.GRID).setGridWidth($(window).width()-30);});ButtonUtils.enableBtn("soEntityPrinthot");ButtonUtils.enableBtn("selectStoreDeliver");
ButtonUtils.enableBtn("printhotBtn");},onSelectRow:function(l,k){c.onSelectRow(l,k);},ondblClickRow:function(k){if(k){c._packMany(k);}}});});}};function parentCMD(){$(".soEntitySearch").trigger("click");
}