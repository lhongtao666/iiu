$(function(){var a=new SoEntityDeliverEdit();a.init();});function SoEntityDeliverEdit(){this.soEntityBase=new SoEntityBase();this.currentIsSendSmsStr=currentIsSendSmsStr;
}SoEntityDeliverEdit._CONS_={PACK_FORM_ID:"#soEntityPackForm",SAVE_DELIVER_URL:ctx+"/ec/salesorder/soEntity/saveDeliver.htm",PACK_URL:ctx+"/ec/salesorder/soEntity/pack.htm",CACHE_IN_REDIS_URL:ctx+"/ec/salesorder/soEntity/sendSms.htm",UPDATE_WEIGHT_URL:ctx+"/ec/salesorder/soEntity/updateWeight.htm",};
SoEntityDeliverEdit.prototype={init:function(){this.soEntityBase.init();this._initPermissions();this._dealBtnStatus();this._bindEventHander();this._completeData();
this._initPreNextBtn();$(".financeAttachDiv").hide();var a=$(window).width();if(a<=1024){$("#waitDeliverBody").css("margin-top","70px");}else{$("#waitDeliverBody").css("margin-top","44px");
}StoreUtils.loadData({container:"storeId",isSale:false});$("#selectStoreModal").find("#storeId").attr("disabled",false);ConfigUtils.findByKey("system.isBanDelayConfirm",function(b){if(b.success){$(".othersDiv").hide();
}else{$(".othersDiv").show();}$(".delayConfirmTime").find(".simple-time-select").remove();});$(".delayConfirmTime").find(".simple-time-select").remove();
if(this.currentIsSendSmsStr=="y"){$(".sendSms").each(function(){$(this)[0].checked=true;});}else{$(".sendSms").each(function(){$(this)[0].checked=false;
});}if(soEntityShipModel=="ec"){$(".soEntityWrap").show();$(".deliverBtn").hide();}},_completeData:function(){$("select[name=isCloudWarehourse]").attr("disabled",true);
$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name='scCodeShow']").trigger("change");if(soStatus!="comfirm"){$(".remove-deliver-btn").remove();$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID).find(":input").attr("disabled",true);
if(soStatus!="shipping"){$(".deliverBackBtn").remove();}else{$(".deliverBackBtn").attr("disabled",false);}}SoEntityUtils.initDetail();},_initPermissions:function(){if(!ResUtils.canShow("soEntity.button.splitOrder")){$(".splitOrderBtn").hide();
}if(!ResUtils.canShow("soEntityShip.button.soAddLock")){$(".soAddLock").hide();}if(!ResUtils.canShow("soEntityShip.button.soUnLock")){$(".soUnLock").hide();
}if(ResUtils.canShow("soDeliver.button.viewPhoneBtn")){$(".viewPhone").show();}else{$(".viewPhone").hide();}if(!ResUtils.canShow("soDeliver.modify.scCode")){$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name='scCodeShow']").attr("disabled","disabled");
}if(!ResUtils.canShow("soEntity.button.wrap")){$(".soEntityWrap").hide();}if(!ResUtils.canShow("soEntity.button.backAwPack")){$(".soEntityBackAwPack").hide();
}},_dealBtnStatus:function(){var a=$("#soEntityForm").find("[name=isLock]").val();if(a=="y"){$(".soUnLock").removeAttr("disabled");$(".soAddLock").attr("disabled","disabled");
$(".deliverBtn").attr("disabled","disabled");$(".soEntityTrunDown").attr("disabled","disabled");}if(a=="n"){$(".soAddLock").removeAttr("disabled");$(".soUnLock").attr("disabled","disabled");
$(".deliverBtn").removeAttr("disabled");$(".soEntityTrunDown").removeAttr("disabled");}},_bindEventHander:function(){var a=this;$(window).resize(function(){var b=$(this).width();
if(b<=1024){$("#waitDeliverBody").css("margin-top","70px");}else{$("#waitDeliverBody").css("margin-top","44px");}});$("body").on("click",".soEntityBackAwPack",function(){var b=$("#soEntityForm").find("[name=id]").val();
a._backAwPack(b);});$("body").on("click",".soEntityWrap",function(){var b=$("#soEntityForm").find("[name=id]").val();var c=$("#soEntityForm").find("[name=soNo]").val();
a._wrapSo(c,b);});$("body").on("click",".wrapSoBtn",function(){var d=$("#wrapSoForm").find("input[name=weight]").val();var c=$("#wrapSoForm").find("input[name=volume]").val();
var b=$("#wrapSoForm").find("input[name=soId]").val();FormUtils.submit(SoEntityDeliverEdit._CONS_.UPDATE_WEIGHT_URL,"soId="+b+"&weight="+d+"&volume="+c,function(f){if(f.success){$("#wrapSoModalContainer").modal("hide");
var e=$("input[name=realStoreId]").val();if(e){a._saveDeliver();a.isClickSave=true;}else{if(!e&&isSelectStoreInShip=="y"){$("#storeId").val("");$("#selectStoreModal").modal("show");
}}}else{DialogUtils.error(msgCode.ERROR,f.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$("body").on("click",".soAddLock",function(){var b=$("#soEntityForm").find("[name=id]").val();
SoEntityUtils.lock(b,null,function(){a._dealBtnStatus();});});$("body").on("click",".soUnLock",function(){var b=$("#soEntityForm").find("[name=id]").val();
SoEntityUtils.unLock(b,null,function(){a._dealBtnStatus();});});$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});$("body").on("click",".setSmsTpl",function(){a._setSmsTplLayer();});$("body").on("click",".splitOrderBtn",function(){var c=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soNo]").val();
var b=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soId]").val();a._splitSo(c,b.toString());});$("body").on("click",".splitPordBtn",function(){var b=$(".splitCount").val();
if(b){a._splitSoList(b);}else{DialogUtils.error(msgCode.ERROR,"请填写拆分次数",$("div.splitSoPane"));}});$("body").on("click",".splitSoBtn",function(){a._splitSoSave();
});$("body").on("click",".printDeliverBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印发货单");return null;
}var b=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soId]").val();var c=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soNo]").val();
var d=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scName]").val();JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=out_sale&entityId="+b+"&soNo="+c+"&scName="+d+"&proxyType=ship_proxy","订单发货单打印");
});$("body").on("click",".printShipBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");return null;}var c=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soId]").val();
var d=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soNo]").val();var f=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scName]").val();
var e=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=waitPayAmount]").val();var b="ship_proxy";if(e!=0){b="ship_not_proxy";}JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=ship&entityId="+c+"&soNo="+d+"&scName="+f+"&proxyType=ship_proxy","普通快递单打印");
});$("body").on("click",".scHotPrintBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印热敏纸");return null;
}var c=$("#soEntityPackForm input[name=soId]").val();if($(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name=scCode] option:checked").attr("hotVar")=="n"){DialogUtils.error("错误","请先确定当前订单是否支持热敏打印");
return null;}var d=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soNo]").val();var e=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scName]").val();
var b="ship_proxy";if(waitPayAmount!=0){b="ship_not_proxy";}JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=hotsensitive&entityId="+c+"&soNo="+d+"&scName="+e+"&proxyType=ship_proxy","热敏快递单打印");
});$("body").on("click",".deliverBackBtn",function(){var b=$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=soId]").val();SoEntityUtils.backDeliver(b,function(){window.location.href=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+b;
});});$("body").on("change",SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name='scCodeShow']",function(){$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scName]").val($(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name=scCodeShow").find("option:selected").text());
$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scCode]").val($(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" select[name=scCodeShow").find("option:selected").val());
});$("body").on("click","input[name=isHotPrint]",function(){if($(this).is(":checked")==true){$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scTrackingNo]").attr("readonly",true);
}else{$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=scTrackingNo]").attr("readonly",false);}});$("body").on("click",".savePackBtn",function(){a._savePack();
a.isClickSave=true;});$("body").on("click",".deliverBtn",function(){var b=$("input[name=realStoreId]").val();if(b){a._saveDeliver();a.isClickSave=true;
}else{if(!b&&isSelectStoreInShip=="y"){$("#storeId").val("");$("#selectStoreModal").modal("show");}}});$("body").on("click","#selectStoreBtn",function(){var b=$("#storeId").val();
if(b){a._saveDeliver(b);a.isClickSave=true;}else{DialogUtils.error("提示","请先选择仓库");}});$(document).on("click",".preSoBtn",function(){var b="订单["+a.preSoNo+"]发货";
var d=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+$("#soEntityForm input[name=id]").val();var c=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a.preSoId;
JTTabUtils.resetTab(d,c,b);window.location.href=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a.preSoId;});$(document).on("click",".nextSoBtn",function(){var b="订单["+a.nextSoNo+"]发货";
var d=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+$("#soEntityForm input[name=id]").val();var c=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a.nextSoId;
JTTabUtils.resetTab(d,c,b);window.location.href=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a.nextSoId;});$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});$("body").on("click",".soEntityTrunDown",function(){var b=$("#soEntityForm input[name=id]").val();var c=$("#soEntityForm input[name=soNo]").val();if(!b||b==null||!c||c==null){DialogUtils.error("错误","请选择要处理的订单");
return;}var d=new Array();var e=new Array();d.push(c);e.push(b);SoEntityUtils.trunDownOrderLayer(e,d,function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});});$("body").on("change",".splitCountItem",function(){$(this).parent().addClass("isUpdated");var b=$(this).parent().attr("itemProd");var e=$(this).parent().attr("itemCountTotal");
var c=$(this).val();var d=$(this).parent().attr("itemCount");$(this).parents("tr").eq(0).find(".splitMoney").text(c*$(this).parents("tr").eq(0).find(".splitMoney").attr("splitPrice"));
$(".splitSoListDiv tbody").find("."+b).each(function(){if(!$(this).hasClass("isUpdated")){var f=$(this).attr("itemCount")-(c-d);$(this).find(".splitCountItem").val(f);
$(this).parents("tr").eq(0).find(".splitMoney").text(f*$(this).parents("tr").eq(0).find(".splitMoney").attr("splitPrice"));return false;}});$(this).removeClass("isUpdated");
});$("body").on("change",".sendSms",function(){var c=$(this)[0].checked;$(".sendSms").each(function(){$(this)[0].checked=c;});var b=SoEntityDeliverEdit._CONS_.CACHE_IN_REDIS_URL;
FormUtils.submit(b,{employeeId:currentUserId,sendSms:c?"y":"n"},function(d){});});},_backAwPack:function(a){FormUtils.submit(ctx+"/ec/salesorder/soEntity/backAwPack.htm","soIds="+a,function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,b.msg);
}else{DialogUtils.error(msgCode.ERROR,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_wrapSo:function(a,b){$("#wrapSoModal").text(a+" -- 订单包装");
$("#wrapSoForm").find("input[name=soId]").val(b);$("#wrapSoModalContainer").modal("show");},_splitSo:function(b,c,d){var a=this;$("#splitSoModalContainer").modal("show");
$(".splitSoListContent").hide();$(".splitSoBtnContent").hide();$(".splitSoListDiv").empty();$("#splitSoModal").text(b+" -- 订单拆分");a._buildSplitStr(b,c);
},_splitSoList:function(a){var n=this;var l=new StringBuffer();var k=n.soItemPos;var g=n.soEntityPo;l.append("<table class='table table-bordered'>");l.append("<thead>");
l.append("<tr>");l.append("<th width='5%'>#</th>");l.append("<th width='12%'>拆分订单</th>");l.append("<th width='25%'>产品名称</th>");l.append("<th width='12%'>拆出数量</th>");
l.append("<th width='12%'>产品金额</th>");l.append("<th width='12%'>订单金额</th>");l.append("<th width='22%'>发货时间</th>");l.append("</tr>");l.append("</thead>");
l.append("<tbody>");var c=g.totalAmount-g.subAmount;var f=parseInt(c/a);var b=c-(f*(a-1));if(b.toString().indexOf(".")!=-1){b=b.toFixed(2);}$(".splitAmountDiv").empty().append(c);
for(var e=1;e<=a;e++){var m=0;for(var d=0;d<k.length;d++){var h=parseInt((k[d].count/a).toFixed(0));m=e*h;if(m>k[d].count){h=k[d].count-((e-1)*h);}else{if(e==a&&m<k[d].count){h=(k[d].count-m)+h;
}}if(a==1){break;}else{l.append("<tr");if(d==0){if(e==1){l.append(" soId="+$("#splitSoForm").find("input[name=soId]").val()+" soNo="+$("#splitSoForm").find("input[name=soNo]").val());
}l.append(" count="+k.length+">");l.append("<td rowspan='"+k.length+"'>"+e+"</td>");if(e==1){l.append("<td rowspan='"+k.length+"'>"+$("#splitSoForm").find("input[name=soNo]").val()+"</td>");
}else{l.append("<td rowspan='"+k.length+"'></td>");}}else{l.append(">");}l.append("<td >"+k[d].prodName+"</td>");l.append("<td class='itemCount itemPord"+d+"' itemProd=itemPord"+d+" ");
l.append("itemCount="+h+" itemCountTotal="+k[d].count+" itemId="+k[d].id+"><input type='number' class='form-control splitCountItem' validatetype='default' value='"+h+"'></td>");
l.append("<td class='splitMoney' splitPrice="+k[d].salesPrice+">"+(k[d].salesPrice*h).toFixed(1)+"</td>");if(d==0){l.append("<td rowspan='"+k.length+"'><input type='number' class='form-control splitAmount' validatetype='default' value='"+(e==a?b:f)+"'></td>");
}if(d==0){l.append("<td rowspan='"+k.length+"'><input class='laydate-icon form-control layer-date' name='splitShipTime' placeholder='yyyy-mm-dd hh:mm:ss' onclick='laydate({istime: true, min: laydate.now(1), format: \"YYYY-MM-DD hh:mm:ss\"})'></td>");
l.append("</tr>");}}}}l.append("</tbody>");l.append("<tfoot>");l.append("<tr>");l.append("<td colspan='4'></td>");l.append("<td>拆分金额:</td>");l.append("<td colspan='2' class='splitAmountDiv'>"+c+"</td>");
l.append("</tr");l.append("</tfoot>");l.append("</table>");$(".splitSoListContent").show();$(".splitSoBtnContent").show();$(".splitSoListDiv").empty().append(l.toString());
},_splitSoSave:function(){var i=[];var g=0;var h=[];var f="";var b="";var j="";var a="";var c="";var e=false;var d=parseFloat($(".splitAmountDiv").text());
if(d!=(this.soEntityPo.totalAmount-this.soEntityPo.subAmount)){DialogUtils.error(msgCode.ERROR,"拆分金额必须等于订单总金额");return false;}$(".splitSoListDiv tbody").find("tr").each(function(){g++;
if($(this).attr("count")){f=$(this).attr("soId");b=$(this).attr("soNo");j=$(this).find("input[name=splitShipTime]").val();a=$(this).attr("count");c=$(this).find(".splitAmount").val();
}var l={itemId:$(this).find(".itemCount").attr("itemId"),count:$(this).find(".splitCountItem").val(),};if(l.count<0){e=true;return;}h.push(l);if(g==a){var k={id:f,soNo:b,shipTime:j,soItems:h,totalAmount:c};
i.push(k);g=0;h=[];}});if(e){DialogUtils.error(msgCode.ERROR,"产品数量不能小于0");return;}FormUtils.submit(ctx+"/ec/salesorder/soEntity/splitOrder.htm","splitPos="+JSON.stringify(i),function(k){if(k.success){$("#splitSoModalContainer").modal("hide");
DialogUtils.success(msgCode.SUCCESS,k.msg);$("#tabSoWaitDeliver").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,k.msg);
}});},_buildSplitStr:function(b,c){var a=this;var d=new StringBuffer();$("#splitSoForm").find("input[name=soNo]").val(b);$("#splitSoForm").find("input[name=soId]").val(c);
FormUtils.submit(ctx+"/ec/salesorder/soEntity/edit.htm","soNo="+b,function(g){var f=g.soEntityPo.soItemPos;a.soItemPos=f;a.soEntityPo=g.soEntityPo;d.append("<table class='table table-bordered'>");
d.append("<thead>");d.append("<tr>");d.append("<th width='10%'>#</th>");d.append("<th width='30%'>商品名称</th>");d.append("<th width='15%'>总数量</th>");d.append("<th width='20%'>待分金额</th>");
d.append("<th width='25%'>拆分次数</th>");d.append("</tr>");d.append("</thead>");d.append("</tbody>");for(var e=0;e<f.length;e++){d.append("<tr>");d.append("<td>"+(e+1)+"</td>");
d.append("<td>"+f[e].prodName+"</td>");d.append("<td>"+f[e].count+"</td>");if(e==0){d.append("<td rowspan='"+f.length+"'>"+(g.soEntityPo.totalAmount-g.soEntityPo.subAmount)+"</td>");
d.append("<td rowspan='"+f.length+"'><div class='col-sm-8'><input type='number' class='form-control splitCount' validatetype='default'></div>");d.append("<button type='button' class='btn btn-sm  btn-primary splitPordBtn'>拆分</button>");
d.append("</td>");}d.append("</tr>");}d.append("</tbody>");d.append("</table>");$(".splitPordDiv").empty().append(d.toString());});},_initPreNextBtn:function(){var d=new StringBuffer();
var a=window.localStorage.getItem("deliver_"+currentUserId);if(a){var c=JSON.parse(a);if(c&&c.length>0){for(var b=0;b<c.length;b++){if($("#soEntityForm input[name=id]").val()==c[b].id){if(b>0){this.preSoId=c[b-1].id;
this.preSoNo=c[b-1].soNo;$(".preSoBtn").show();}if(b<c.length-1){this.nextSoId=c[b+1].id;this.nextSoNo=c[b+1].soNo;$(".nextSoBtn").show();}break;}}}}},_savePack:function(){ButtonUtils.disableBtn("savePackBtn");
FormUtils.submitByFormId(SoEntityDeliverEdit._CONS_.PACK_URL,"soEntityPackForm",function(a){ButtonUtils.enableBtn("savePackBtn");if(a.success){DialogUtils.success(msgCode.INFO,"打包成功");
JTTabUtils.refreshTable(ctx+"/ec/salesorder/soEntity/stock/list.htm","订单发货","parentCMD");}else{DialogUtils.error(msgCode.FAIL_MSG,a.msg);}},function(){ButtonUtils.enableBtn("savePackBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_saveDeliver:function(a){var c=this;if($("input[name=realStoreId]").val()){a=$("input[name=realStoreId]").val();
}ButtonUtils.disableBtn("deliverBtn");var b=$("#soEntityPackForm").serialize()+"&storeId="+a;FormUtils.submit(SoEntityDeliverEdit._CONS_.SAVE_DELIVER_URL,b,function(d){ButtonUtils.enableBtn("deliverBtn");
if(d.success){$("#selectStoreModal").modal("hide");if(c.nextSoId){$(".nextSoBtn").trigger("click");}else{DialogUtils.success(msgCode.INFO,"发货成功");$(".savePackBtn").attr("disabled",true);
$(".deliverBtn").attr("disabled",true);$(".printDeliverBtn").attr("disabled",true);$(".printShipBtn").attr("disabled",true);$(".scHotPrintBtn").attr("disabled",true);
$(".turnDownUpdate").attr("disabled",true);$(".deliverBackBtn").attr("disabled",false);$(".soEntityTrunDown").attr("disabled",true);$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID).find(":input").attr("disabled",true);
}JTTabUtils.refreshTable(ctx+"/ec/salesorder/soEntity/stock/list.htm","订单发货","parentCMD");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("deliverBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_setSmsTplLayer:function(){self.layerIndex=layer.open({type:1,title:"设置短信模板",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","350px"],content:$(".setSmsTplPane"),success:function(a,b){$("#setSmsTplForm").find("#setSmsTpl").val($(SoEntityDeliverEdit._CONS_.PACK_FORM_ID+" input[name=smsTpl]").val());
},yes:function(b,a){$(SoEntityDeliverEdit._CONS_.PACK_FORM_ID).find("input[name=smsTpl]").val($("#setSmsTplForm").find("#setSmsTpl").val());layer.close(self.layerIndex);
},cancel:function(){FormUtils.clear("setSmsTplForm");}});},};