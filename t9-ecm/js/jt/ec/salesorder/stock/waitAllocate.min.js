function WaitAllocate(){this.hadInit=false;this.canShowScTrankNo="cannot";this.simpleShowLastFollow=(simpleShowLastFollow=="n"?false:true);this.simpleShowComment=(simpleShowComment=="n"?false:true);
this.soEntityShipModel="simple";}WaitAllocate._CONS_={LIST_DATA_URL:ctx+"/ec/salesorder/soEntity/listData.htm",SHIP_ALLOCATE_URL:ctx+"/ec/salesorder/soEntity/shipAllocate.htm",GRID:"#soEntityAllocateGrid",PAGER:"#soEntityAllocatePager",};
WaitAllocate.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;ShipCompanyUtils.getOptions({container:"scCodeQryAllocate",caption:"全部",callBack:function(){$(".scCodeQryAllocate").chosen("destroy").chosen();
}});this._bindEventHander();if(a.canShowScTrankNo){this.canShowScTrankNo=a.canShowScTrankNo;}if(a.soEntityShipModel){this.soEntityShipModel=a.soEntityShipModel;
}this._initJqgrid();this._hideNotGrantBtn();}else{$("#tabSoAllocate").find(".soEntitySearch").trigger("click");}},resSearchGrid:function(){$("#tabSoAllocate").find(".soEntitySearch").trigger("click");
},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WaitAllocate._CONS_.GRID,a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("soEntity.button.allocate")){$(".soEntityAllocate").hide();
}if(!ResUtils.canShow("soEntityShip.button.soAddLock")){$(".soAddLock").hide();}if(!ResUtils.canShow("soEntityShip.button.soUnLock")){$(".soUnLock").hide();
}},_bilidScCodeQrySearch:function(c,a,b){var d=new StringBuffer();$("#soEntityAllocateSearchForm").find(".scCodeQry option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&scCodeQry="+d.toString();return c;},_bilidCashTypeSearch:function(d,a,c){var b=new StringBuffer();
$("#soEntityAllocateSearchForm").find(".cashType option:selected").each(function(e){b.append($(this).val());if(e==c-1){return false;}else{b.append(",");
}});d=d+"&cashType="+b.toString();return d;},_bindEventHander:function(){var a=this;$("#allocateSoForm").on("keypress",".barCode",function(b){if(b.keyCode=="13"){var c=$(this).val();
$(".allocatePordDiv").find(".soItemTr").each(function(){if($(this).attr("barCodeVal")==c){$(this).find(".prodCountTestVal").text($(this).find(".prodCountTestVal").text()+1);
if($(this).find(".prodCountTestVal").text()>$(this).find(".prodCountVal").text()){$(this).find(".testResultVal").text("<span style='colre:red;'>多捡</span/>");
}else{if($(this).find(".prodCountTestVal").text()==$(this).find(".prodCountVal").text()){$(this).find(".testResultVal").text("<span style='colre:red;'>正确</span/>");
}else{if($(this).find(".prodCountTestVal").text()<$(this).find(".prodCountVal").text()){$(this).find(".testResultVal").text("<span style='colre:red;'>少捡</span/>");
}}}}});}});$(".wait_allocate_wrapper").on("click",".soAddLock",function(){var b=$(WaitAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要冻结的订单");
return;}DialogUtils.confirmWithOptions({title:"您确定要冻结选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.lock(b);}});});$(".wait_allocate_wrapper").on("click",".soUnLock",function(){var b=$(WaitAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要解冻的订单");return;}DialogUtils.confirmWithOptions({title:"您确定要解冻选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.unLock(b);
}});});$(".wait_allocate_wrapper").on("click",".soEntityAllocate",function(){var b=$(WaitAllocate._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要配货的订单");
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"不能包装多条记录");return;}}var d=$(WaitAllocate._CONS_.GRID).jqGrid("getRowData",b);var c=d["soNoShow"];
$("#allocateSoForm").find("input[name=soId]").val(b);$("#allocateSoForm").find("input[name=soNo]").val(c);a._openAllocateLayer(c);a._initEmployeeSuggest();
a._buildAllocateStr(b);});$(".wait_allocate_wrapper").on("click",".soEntitySearch",function(){if($(".wait_allocate_wrapper").find(".searchProd").val()==""){$(".wait_allocate_wrapper").find(".skuSearch").val("");
}var d=$(this).closest("form").serialize();var b=$("#soEntityAllocateSearchForm").find(".scCodeQry option:selected").length;if(b!=0){d=a._bilidScCodeQrySearch(d,a,b);
}var c=$("#soEntityAllocateSearchForm").find(".cashType option:selected").length;if(c!=0){d=a._bilidCashTypeSearch(d,a,c);}a.reloadJqgrid(d);});$("#soEntityAllocateSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$(".wait_allocate_wrapper").on("change","#belongEmployeeAllocateSearch",function(){$("#belongEmployeeAllocateSearch").empty().append("<option value=''>请选择</option>");
if($(this).val()){SoEntityUtils.buildEmployeeOption($(this).val(),"belongEmployeeAllocateSearch");}});$(".wait_allocate_wrapper").on("click",".skuSearchImg",function(){SelectProdService.selectSku({isMultiple:0,hideCanSale:"y",fn:function(b){for(var c=0;
c<b.length;c++){$(".wait_pack_wrapper").find("input[id=skuSearch]").val(b[c].skuId);}}});});$(document).on("change","#tabSoAllocate .lastFollow",function(){var b=$(this)[0].checked;
if(b){a.simpleShowLastFollow=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").show();$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").hide();
}else{a.simpleShowLastFollow=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").hide();$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").show();
}});$(document).on("change","#tabSoAllocate .orderDesc",function(){var b=$(this)[0].checked;if(b){a.simpleShowComment=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").show();
$(this).parents(".jqGrid_wrapper").find(".comment-detail").hide();}else{a.simpleShowComment=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").hide();
$(this).parents(".jqGrid_wrapper").find(".comment-detail").show();}});$("#tabSoWaitPack").on("click",".showSoDetail",function(){var j=$(this).attr("csNameVal");
var c=$(this).attr("value");var h=$(this).attr("id-value");var f=[];var g=[];var e=$(WaitAllocate._CONS_.GRID).getRowData();var b=false;if(e&&e.length>0){for(var d=0;
d<e.length;d++){if(e[d].id==h){b=true;}if(b){f.push(e[d].soNo);g.push(e[d].csName);}}}window.localStorage.setItem("detail_so_soNos"+currentUserId,f.toString());
window.localStorage.setItem("detail_cs_names"+currentUserId,g.toString());window.localStorage.setItem("detail_canShowScTrankNo"+currentUserId,a.canShowScTrankNo);
JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.DETAIL_PAGE_URL+"?soNo="+c+"&canModifyProfit=false"+"&canShowScTrankNo="+a.canShowScTrankNo,j+"的订单明细");
});},_buildAllocateStr:function(b){var a=this;var c=new StringBuffer();FormUtils.submit(ctx+"/ec/salesorder/soEntity/findItemBySoId.htm","soId="+b,function(f){var e=f;
c.append("<table class='table table-bordered'>");c.append("<thead>");c.append("<tr>");c.append("<th width='10%'>#</th>");c.append("<th width='30%'>商品名称</th>");
c.append("<th width='10%'>规格</th>");c.append("<th width='10%'>单位</th>");c.append("<th width='10%'>产品数量</th>");c.append("<th width='20%'>验货数量</th>");c.append("<th width='10%'>验货结果</th>");
c.append("</tr>");c.append("</thead>");c.append("</tbody>");for(var d=0;d<e.length;d++){c.append("<tr class='soItemTr' barCodeVal='"+e[d].barCode+"'>");
c.append("<td>"+(d+1)+"</td>");c.append("<td>"+e[d].prodName+"</td>");c.append("<td>"+e[d].spec+"</td>");c.append("<td>"+e[d].unit+"</td>");c.append("<td class='prodCountVal'>"+e[d].count+"</td>");
c.append("<td class='prodCountTestVal'>0</td>");c.append("<td class='testResultVal'></td>");c.append("</tr>");}c.append("</tbody>");c.append("</table>");
$(".allocatePordDiv").empty().append(c.toString());});},_shipAllocate:function(a,c,b){FormUtils.submit(WaitAllocate._CONS_.SHIP_ALLOCATE_URL,{soId:a,comment:c,employeeId:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
$("#tabSoAllocate").find(".soEntitySearch").trigger("click");$("input[name='employeeSearch").attr({"data-id":""});$("input[name='employeeSearch").val("");
layer.close(self.layerIndex);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_openAllocateLayer:function(b){self=this;
var a=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");layer.open({type:1,title:b+" -- 订单配货",maxmin:false,scrollbar:false,shadeClose:true,btn:["确定","取消"],area:["65%","60%"],content:$("#allocateContainer"),yes:function(d,c){self.layerIndex=d;
$(".layui-layer-btn0").hide();var f=$("#allocateSoForm #employeeInput").attr("data-id");var e=$("#allocateSoForm").find("input[name=soId]").val();var g=$("#allocateSoForm").find("textarea[name=comment]").val();
self._shipAllocate(e,g,f);},end:function(){$("input[name='employeeSearch").attr({"data-id":""});$("input[name='employeeSearch").val("");layer.close(index);
}});},_initEmployeeSuggest:function(){var a=this;$("#allocateSoForm input[name='waitAllcateSearch']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?keyword=",effectiveFields:["aid","name","orgName","newCs"],searchFields:["aid","name"],effectiveFieldsAlias:{aid:"工号",name:"姓名",orgName:"部门",newCs:"新进"},showBtn:false,idField:"id",twoWayMatch:false,autoSelect:false,ignorecase:true,keyField:"aid",allowNoKeyword:true,multiWord:false,getDataMethod:"firstByUrl",delayUntilKeyup:false,showHeader:true,processData:function(b){var h=[];
$(".tag-list li").each(function(){h.push($(this).attr("aidVal"));});var g=[];if(b&&b.value){for(var f=0;f<b.value.length;f++){var e=b.value[f];var d=false;
for(var c=0;c<h.length;c++){if(e.aid==h[c]){d=true;break;}}if(!d){g.push(e);}}}b.value=g;return b;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(c,b){a.searchEmployees=b.value;
}).on("onSetSelectValue",function(d,b){for(var c=0;c<a.searchEmployees.length;c++){if(b.id==a.searchEmployees[c].id){$("input[name='waitAllcateSearch']").val(a.searchEmployees[c].aid);
break;}}});},_initJqgrid:function(){var c=this;var d=new Date();var f=DateUtils.format(d,"yyyy-MM-dd");var h=DateUtils.getBeforeDate(7,d);var e=h+" 00:00:00";
var b=f+" 23:59:59";$("#soEntityAllocateSearchForm").find(".minPlaceTime").val(e);$("#soEntityAllocateSearchForm").find(".maxPlaceTime").val(b);var g={"Q__D__BW__entity.place_time_":e};
var a=false;ConfigUtils.findByKey("soEntity.isShowExport",function(i){if(i.success){a=true;$(".isExportDiv").show();}$(WaitAllocate._CONS_.GRID).JTJqgrid({url:WaitAllocate._CONS_.LIST_DATA_URL+"?positionType=order_print,dept_manager&Q__S__EQ__entity.status_=comfirm&Q__S__EQ__entity.pack_status_=aw_allocate&isSelectStoreInShip=n"+"&isWaitDeliverSearch=y"+"&canShowScTrankNo="+c.canShowScTrankNo,pager:WaitAllocate._CONS_.PAGER,postData:g,footerrow:true,shrinkToFit:false,autoScroll:true,userDataOnFooter:true,colNames:["源订单ID(隐藏)","订单编号(隐藏)","订单编号","客户ID","ID","客户名称","客户","货款方式","加急","拆分(hide)","拆分","仓库","下单人","打包人","商品条目","快递公司","代收款(元)","支付状态","最新跟进","订单备注","下单人id","下单时间","货款类型","仓库（隐藏）","更新时间","操作"],colModel:[{name:"originSoId",index:"origin_so_id_",width:70,hidedlg:true,hidden:true,},{name:"soNoShow",index:"so_no_",width:70,hidedlg:true,hidden:true,formatter:function(j,k,l){if(j&&j.length>0){return j;
}return l.soNo;}},{name:"soNo",index:"so_no_",width:90,formatter:function(j,k,l){if(!ResUtils.canShow("soEntity.button.deliver")){return j;}if(l.footData){$(".ui-jqgrid-title").css({"width":"100%"});
$(WaitAllocate._CONS_.GRID).jqGrid("setCaption","<div style='float:left'>"+l.soNoShow+"</div><div style='float:right;'>精简显示<input style='margin-left: 10px;margin-right: 5px;' type='checkbox' "+(c.simpleShowLastFollow?"checked":"")+" class='lastFollow'>最新跟进<input style='margin-left: 10px;margin-right: 5px;' type='checkbox' "+(c.simpleShowComment?"checked":"")+" class='orderDesc'>订单备注</div>");
return l.soNoShow;}else{if(l.soNo!=null&&l.soNo!=""){var m=new StringBuffer();m.append("<a href='#' class='showSoDetail' style='font-weight:bold;' value='"+j+"' id-value='"+l.id+"' csNameVal='"+l.csName+"'>"+j+"</a>");
m.append(SoEntityUtils.getTurnBackStr(l.status,l.preStatus));if(a&&l.isExport=="y"){m.append("&nbsp;<span style='color:red'>out</span>");}if(l.isLock=="y"){m.append("&nbsp;<span style='color:red'>冻</span>");
}return m.toString();}}}},{name:"csId",width:120,hidedlg:true,hidden:true},{name:"id",width:120,hidedlg:true,hidden:true},{name:"csNameShow",index:"name_",width:100,hidedlg:true,hidden:true,formatter:function(j,k,l){if(l.footData){return l.soNo;
}else{return l.csName;}}},{name:"csName",index:"name_",width:80,index:"entity.cs_code_",formatter:function(j,l,m){var k=j+":"+m.csCode;if($(window).width()<1024){k=j+"<br>"+m.csCode;
}return"<a href='#' class='csTab' style='font-weight:bold;' title='"+k+"' value='"+m.csId+"''>"+k+"</a>";}},{name:"cashType",index:"cash_type_",width:80,formatter:function(j){return SoEntityUtils.formatCashType(j);
}},{name:"isFast",index:"is_fast_",width:40,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";}return j;}},{name:"isSplitOrderHide",width:50,hidedlg:true,hidden:true,index:"is_split_order_",formatter:function(j,k,l){return l.isSplitOrder;
}},{name:"isSplitOrder",index:"is_split_order_",width:40,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";}return j;}},{name:"storeName",width:90,index:"entity.store_id_"},{name:"placerName",sortable:false,width:90,formatter:function(j,k,l){return"<span>"+l.placerAid+":"+l.placerName+"</span>";
}},{name:"packEmpName",sortable:false,width:90},{name:"prodNames",sortable:false,width:90},{name:"shipName",width:90,index:"entity.ship_name_"},{name:"proxyAmount",index:"entity.proxy_amount_",width:80,formatter:function(j){return parseFloat(j).toFixed(2);
}},{name:"payStatus",width:120,hidedlg:true,hidden:true},{name:"lastFollow",width:120,sortable:false,formatter:function(j){var k='<span  style="color:#1ab394;'+(c.simpleShowLastFollow?"":"display:none")+'" class="tooltip-follow fa fa-bell" data-toggle="tooltip"  data-placement="right" title="'+j+'"></span>';
k+='<span style="'+(c.simpleShowLastFollow?"display:none":"")+'" class="lastFollow-detail">'+j+"</span>";return k;}},{name:"comment",width:120,formatter:function(m,j,l){var k="";
if(m!=""&&m!=null){k='<span  style="color:#1ab394;'+(c.simpleShowComment?"":"display:none")+'" class="tooltip-comment fa fa-bell" data-toggle="tooltip"  data-placement="left" title="'+m+'"></span>';
k+='<span style="'+(c.simpleShowComment?"display:none":"")+'" class="comment-detail">'+m+"</span>";}return k;}},{name:"placerId",width:110,hidedlg:true,hidden:true},{name:"placeTime",width:110,index:"entity.place_time_",formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"storeId",width:100,hidedlg:true,hidden:true,index:"entity.store_id_"},{name:"cashType",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"entity.update_time_",width:110,hidden:true,formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"__manage",width:50,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:[],}],loadComplete:function(){if(soEntityShipModel=="simple"){$(WaitDeliver._CONS_.GRID).setGridParam().hideCol("packEmpName");
}else{$(WaitDeliver._CONS_.GRID).setGridParam().showCol("packEmpName");}},gridComplete:function(){var j=$(WaitAllocate._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
j.find("td").hide();j.find('td[aria-describedby*="_soNoShow"]').show();j.find("td").css({"font-weight":400});$(window).resize();},ondblClickRow:function(j){if(j){c._packMany(j);
}}});});}};