function WaitPack(){this.hadInit=false;this.canShowScTrankNo="cannot";this.simpleShowLastFollow=(simpleShowLastFollow=="n"?false:true);this.simpleShowComment=(simpleShowComment=="n"?false:true);
this.soEntityShipModel="simple";}WaitPack._CONS_={SHIP_PACK_URL:ctx+"/ec/salesorder/soEntity/shipPack.htm",LIST_DATA_URL:ctx+"/ec/salesorder/soEntity/listData.htm",GRID:"#soEntityWaitPackGrid",PAGER:"#soEntityWaitPackPager",};
WaitPack.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();StoreUtils.loadData({container:"store-id",isSale:false});
if(a.canShowScTrankNo){this.canShowScTrankNo=a.canShowScTrankNo;}if(a.soEntityShipModel){this.soEntityShipModel=a.soEntityShipModel;}this._initJqgrid();
this._hideNotGrantBtn();ShipCompanyUtils.getOptions({container:"scCodeQryPack",caption:"全部",callBack:function(){$(".scCodeQryPack").chosen("destroy").chosen();
}});}else{$("#tabSoWaitPack").find(".soEntitySearch").trigger("click");}},clear:function(c){var a=this;function b(){a._showListWrapper();if(c){$("#tabSoWaitPack").find(".soEntitySearch").trigger("click");
}}b();},_showListWrapper:function(){$("#tabSoWaitPack").find(".waitPack_list_wrapper").hide();$("#tabSoWaitPack").find(".list_wrapper").show();},_showPackWrapper:function(){$("#tabSoWaitPack").find(".waitPack_list_wrapper").hide();
$("#tabSoWaitPack").find(".pack_wrapper").show();},resSearchGrid:function(){$("#tabSoWaitPack").find(".soEntitySearch").trigger("click");},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(WaitPack._CONS_.GRID,a);
},_hideNotGrantBtn:function(){if(!ResUtils.canShow("soEntity.button.shipPack")){$(".soEntityShipPack").hide();}if(!ResUtils.canShow("soEntityShip.button.soAddLock")){$(".soAddLock").hide();
}if(!ResUtils.canShow("soEntityShip.button.soUnLock")){$(".soUnLock").hide();}},_bilidScCodeQrySearch:function(c,a,b){var d=new StringBuffer();$("#soEntityWaitPackSearchForm").find(".scCodeQry option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&scCodeQry="+d.toString();return c;},_bilidCashTypeSearch:function(d,a,c){var b=new StringBuffer();
$("#soEntityWaitPackSearchForm").find(".cashType option:selected").each(function(e){b.append($(this).val());if(e==c-1){return false;}else{b.append(",");
}});d=d+"&cashType="+b.toString();return d;},_bindEventHander:function(){var a=this;$(".wait_pack_wrapper").on("click",".soAddLock",function(){var b=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要冻结的订单");return;}DialogUtils.confirmWithOptions({title:"您确定要冻结选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.lock(b);
}});});$(".wait_pack_wrapper").on("click",".soUnLock",function(){var b=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要解冻的订单");
return;}DialogUtils.confirmWithOptions({title:"您确定要解冻选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.unLock(b);}});});$(".wait_pack_wrapper").on("click",".soEntityShipPack",function(){var c=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(c==null||c.length==0){DialogUtils.error("错误","请选择要打包的订单");return;}for(var d=0;d<c.length;d++){var f=$(WaitPack._CONS_.GRID).jqGrid("getRowData",c[d]);
var e=$(f.scTrackingNo).attr("org-value");var b=f["storeId"];if(b==""||b==null||b.trim()==""){DialogUtils.error("错误","请先确定是否已选择仓库");return;}}DialogUtils.confirmWithOptions({title:"您确定要打包选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){a._openAssignLayer();
a._initEmployeeSuggest();}});});$(".wait_pack_wrapper").on("click",".soEntitySearch",function(){if($(".wait_pack_wrapper").find(".searchProd").val()==""){$(".wait_pack_wrapper").find(".skuSearch").val("");
}var d=$(this).closest("form").serialize();var b=$("#soEntityWaitPackSearchForm").find(".scCodeQry option:selected").length;if(b!=0){d=a._bilidScCodeQrySearch(d,a,b);
}var c=$("#soEntityWaitPackSearchForm").find(".cashType option:selected").length;if(c!=0){d=a._bilidCashTypeSearch(d,a,c);}a.reloadJqgrid(d);});$("#soEntityWaitPackSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$(".wait_pack_wrapper").on("change","#belongEmployeeWaitPackSearch",function(){$("#belongEmployeeWaitPackSearch").empty().append("<option value=''>请选择</option>");
if($(this).val()){SoEntityUtils.buildEmployeeOption($(this).val(),"belongEmployeeWaitPackSearch");}});$(".wait_pack_wrapper").on("click",".skuSearchImg",function(){SelectProdService.selectSku({isMultiple:0,hideCanSale:"y",fn:function(b){for(var c=0;
c<b.length;c++){$(".wait_pack_wrapper").find("input[id=skuSearch]").val(b[c].skuId);}}});});$(document).on("change","#tabSoWaitPack .lastFollow",function(){var b=$(this)[0].checked;
if(b){a.simpleShowLastFollow=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").show();$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").hide();
}else{a.simpleShowLastFollow=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").hide();$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").show();
}});$(document).on("change","#tabSoWaitPack .orderDesc",function(){var b=$(this)[0].checked;if(b){a.simpleShowComment=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").show();
$(this).parents(".jqGrid_wrapper").find(".comment-detail").hide();}else{a.simpleShowComment=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").hide();
$(this).parents(".jqGrid_wrapper").find(".comment-detail").show();}});$("#tabSoAllocate").on("click",".showSoDetail",function(){var j=$(this).attr("csNameVal");
var c=$(this).attr("value");var h=$(this).attr("id-value");var f=[];var g=[];var e=$(WaitPack._CONS_.GRID).getRowData();var b=false;if(e&&e.length>0){for(var d=0;
d<e.length;d++){if(e[d].id==h){b=true;}if(b){f.push(e[d].soNo);g.push(e[d].csName);}}}window.localStorage.setItem("detail_so_soNos"+currentUserId,f.toString());
window.localStorage.setItem("detail_cs_names"+currentUserId,g.toString());window.localStorage.setItem("detail_canShowScTrankNo"+currentUserId,a.canShowScTrankNo);
JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.DETAIL_PAGE_URL+"?soNo="+c+"&canModifyProfit=false"+"&canShowScTrankNo="+a.canShowScTrankNo,j+"的订单明细");
});$("body").off("click","#selectEmployeeBtn").on("click","#selectEmployeeBtn",function(){var b=new EmployeesSelect();var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;
}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,isOnlySelfGroup:1,type:"positionContext",callBack:function(f){if(f!=null){if(f.length>0){$("input[name=employeeSearch]").val(f[0].aid);
$("input[name=employeeSearch]").attr({"data-id":f[0].id});}}}};var d=new EmployeesSelect();d.init(e);});$(".wait_pack_wrapper").on("click",".waitPackStore",function(){var b=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}$("#storeBatchUpdateModal").modal("show");});$("#storeBatchUpdateModal").on("click","#storeBatchUpdateBtn",function(){var b=$("#store-id").val();
var c=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");a.updateStore(b,c);});},updateStore:function(b,c){var a=ctx+"/ec/salesorder/soEntity/updateStore.htm";
FormUtils.submit(a,{storeId:b,selectedIds:c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"修改结束");$("#storeBatchUpdateModal").modal("hide");
$("#tabSoWaitPack").find(".soEntitySearch").trigger("click");}else{DialogUtils.warning(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_openAssignLayer:function(){self=this;var a=$(WaitPack._CONS_.GRID).jqGrid("getGridParam","selarrrow");layer.open({type:1,title:"选择员工",maxmin:false,scrollbar:false,shadeClose:true,btn:["确定","取消"],area:["40%","40%"],content:$("#assignContainer"),yes:function(c,b){self.layerIndex=c;
$(".layui-layer-btn0").hide();var d=$("#assignContainer #employeeInput").attr("data-id");self._shipPack(a,d);},end:function(){$("#employeeInput").attr({"data-id":""});
$("#employeeInput").val("");layer.close(index);}});},_initEmployeeSuggest:function(){var a=this;$("input[name='employeeSearch']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?keyword=",effectiveFields:["aid","name","orgName","newCs"],searchFields:["aid","name"],effectiveFieldsAlias:{aid:"工号",name:"姓名",orgName:"部门",newCs:"新进"},showBtn:false,idField:"id",twoWayMatch:false,autoSelect:false,ignorecase:true,keyField:"aid",allowNoKeyword:true,multiWord:false,getDataMethod:"firstByUrl",delayUntilKeyup:false,showHeader:true,processData:function(b){var h=[];
$(".tag-list li").each(function(){h.push($(this).attr("aidVal"));});var g=[];if(b&&b.value){for(var f=0;f<b.value.length;f++){var e=b.value[f];var d=false;
for(var c=0;c<h.length;c++){if(e.aid==h[c]){d=true;break;}}if(!d){g.push(e);}}}b.value=g;return b;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(c,b){a.searchEmployees=b.value;
}).on("onSetSelectValue",function(d,b){for(var c=0;c<a.searchEmployees.length;c++){if(b.id==a.searchEmployees[c].id){$("input[name='employeeSearch']").val(a.searchEmployees[c].aid);
break;}}});},_shipPack:function(a,b){FormUtils.submit(WaitPack._CONS_.SHIP_PACK_URL,{soIds:a,employeeId:b},function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
$("#tabSoWaitPack").find(".soEntitySearch").trigger("click");$("input[name='employeeSearch']").attr({"data-id":""});$("input[name='employeeSearch']").val("");
layer.close(self.layerIndex);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_initJqgrid:function(){var c=this;
var d=new Date();var f=DateUtils.format(d,"yyyy-MM-dd");var h=DateUtils.getBeforeDate(7,d);var e=h+" 00:00:00";var b=f+" 23:59:59";$("#soEntityWaitPackSearchForm").find(".minPlaceTime").val(e);
$("#soEntityWaitPackSearchForm").find(".maxPlaceTime").val(b);var g={"Q__D__BW__entity.place_time_":e};var a=false;ConfigUtils.findByKey("soEntity.isShowExport",function(i){if(i.success){a=true;
$(".isExportDiv").show();}$(WaitPack._CONS_.GRID).JTJqgrid({url:WaitPack._CONS_.LIST_DATA_URL+"?positionType=order_print,dept_manager&Q__S__EQ__entity.status_=comfirm&Q__S__EQ__entity.pack_status_=aw_pack&isSelectStoreInShip=n"+"&isWaitDeliverSearch=y"+"&canShowScTrankNo="+c.canShowScTrankNo,pager:WaitPack._CONS_.PAGER,postData:g,footerrow:true,shrinkToFit:false,autoScroll:true,userDataOnFooter:true,colNames:["源订单ID(隐藏)","订单编号(隐藏)","订单编号","客户ID","ID","客户名称","客户","货款方式","加急","拆分(hide)","拆分","仓库","下单人","商品条目","快递公司","代收款(元)","支付状态","最新跟进","订单备注","下单人id","下单时间","货款类型","仓库（隐藏）","更新时间","操作"],colModel:[{name:"originSoId",index:"origin_so_id_",width:70,hidedlg:true,hidden:true,},{name:"soNoShow",index:"so_no_",width:70,hidedlg:true,hidden:true,formatter:function(j,k,l){if(j&&j.length>0){return j;
}return l.soNo;}},{name:"soNo",index:"so_no_",width:90,formatter:function(j,k,l){if(!ResUtils.canShow("soEntity.button.deliver")){return j;}if(l.footData){$(".ui-jqgrid-title").css({"width":"100%"});
$(WaitPack._CONS_.GRID).jqGrid("setCaption","<div style='float:left'>"+l.soNoShow+"</div><div style='float:right;'>精简显示<input style='margin-left: 10px;margin-right: 5px;' type='checkbox' "+(c.simpleShowLastFollow?"checked":"")+" class='lastFollow'>最新跟进<input style='margin-left: 10px;margin-right: 5px;' type='checkbox' "+(c.simpleShowComment?"checked":"")+" class='orderDesc'>订单备注</div>");
return l.soNoShow;}else{if(l.soNo!=null&&l.soNo!=""){var m=new StringBuffer();m.append("<a href='#' class='showSoDetail' style='font-weight:bold;' value='"+j+"' id-value='"+l.id+"' csNameVal='"+l.csName+"'>"+j+"</a>");
m.append(SoEntityUtils.getTurnBackStr(l.status,l.preStatus));if(a&&l.isExport=="y"){m.append("&nbsp;<span style='color:red'>out</span>");}if(l.isLock=="y"){m.append("&nbsp;<span style='color:red'>冻</span>");
}return m.toString();}}}},{name:"csId",width:120,hidedlg:true,hidden:true},{name:"id",width:120,hidedlg:true,hidden:true},{name:"csNameShow",index:"name_",width:100,hidedlg:true,hidden:true,formatter:function(j,k,l){if(l.footData){return l.soNo;
}else{return l.csName;}}},{name:"csName",index:"name_",width:80,index:"entity.cs_code_",formatter:function(j,l,m){var k=j+":"+m.csCode;if($(window).width()<1024){k=j+"<br>"+m.csCode;
}return"<a href='#' class='csTab' style='font-weight:bold;' title='"+k+"' value='"+m.csId+"''>"+k+"</a>";}},{name:"cashType",index:"cash_type_",width:80,formatter:function(j){return SoEntityUtils.formatCashType(j);
}},{name:"isFast",index:"is_fast_",width:40,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";}return j;}},{name:"isSplitOrderHide",width:50,hidedlg:true,hidden:true,index:"is_split_order_",formatter:function(j,k,l){return l.isSplitOrder;
}},{name:"isSplitOrder",index:"is_split_order_",width:40,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";}return j;}},{name:"storeName",width:90,index:"entity.store_id_"},{name:"placerName",sortable:false,width:90,formatter:function(j,k,l){return"<span>"+l.placerAid+":"+l.placerName+"</span>";
}},{name:"prodNames",sortable:false,width:90},{name:"shipName",width:90,index:"entity.ship_name_"},{name:"proxyAmount",index:"entity.proxy_amount_",width:80,formatter:function(j){return parseFloat(j).toFixed(2);
}},{name:"payStatus",width:120,hidedlg:true,hidden:true},{name:"lastFollow",width:120,sortable:false,formatter:function(j){var k='<span  style="color:#1ab394;'+(c.simpleShowLastFollow?"":"display:none")+'" class="tooltip-follow fa fa-bell" data-toggle="tooltip"  data-placement="right" title="'+j+'"></span>';
k+='<span style="'+(c.simpleShowLastFollow?"display:none":"")+'" class="lastFollow-detail">'+j+"</span>";return k;}},{name:"comment",width:120,formatter:function(m,j,l){var k="";
if(m!=""&&m!=null){k='<span  style="color:#1ab394;'+(c.simpleShowComment?"":"display:none")+'" class="tooltip-comment fa fa-bell" data-toggle="tooltip"  data-placement="left" title="'+m+'"></span>';
k+='<span style="'+(c.simpleShowComment?"display:none":"")+'" class="comment-detail">'+m+"</span>";}return k;}},{name:"placerId",width:110,hidedlg:true,hidden:true},{name:"placeTime",width:110,index:"entity.place_time_",formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"storeId",width:100,hidedlg:true,hidden:true,index:"entity.store_id_"},{name:"cashType",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"entity.update_time_",width:110,hidden:true,formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"__manage",width:50,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:[],}],gridComplete:function(){var j=$(WaitPack._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
j.find("td").hide();j.find('td[aria-describedby*="_soNoShow"]').show();j.find("td").css({"font-weight":400});$(window).resize();},ondblClickRow:function(j){if(j){c._packMany(j);
}}});});}};