function DelayShip(){this.hadInit=false;this.gridRecordsSpan=null;this.soEntityExport=new SoEntityExport();this.canShowScTrankNo="cannot";this.simpleShowLastFollow=(simpleShowLastFollow=="n"?false:true);
this.simpleShowComment=(simpleShowComment=="n"?false:true);this.soItemPos=[];}DelayShip._CONS_={MERGE_SO_URL:ctx+"/ec/salesorder/soEntity/mergeSo.htm",LIST_DATA_URL:ctx+"/ec/salesorder/soEntity/listData.htm",DELIVER_URL:ctx+"/ec/salesorder/soEntity/deliver.htm",SAVE_GRID_URL:ctx+"/ec/salesorder/soEntity/saveGrid.htm",SEND_HOTPRINT_URL:ctx+"/ec/salesorder/soEntity/batchHotPrint.htm",IMPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importDeliverInfo.htm",GRID:"#soEntityDelayShipGrid",PAGER:"#soEntityDelayShipPager",};
DelayShip.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();if(a.gridRecordsSpan){this.gridRecordsSpan=a.gridRecordsSpan;
}if(a.canShowScTrankNo){this.canShowScTrankNo=a.canShowScTrankNo;}this._initJqgrid();this._hideNotGrantBtn();StoreUtils.loadData({container:"storeId",isSale:false});
StoreUtils.loadData({container:"store-id2",isSale:false});ShipCompanyUtils.getOptions({container:"scCodeQry2",caption:"全部"});}else{$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");
}},clear:function(c){var a=this;function b(){a._showListWrapper();if(c){$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");}}b();},_showListWrapper:function(){$("#tabSoDelayShip").find(".pack_wrapper").hide();
$("#tabSoDelayShip").find(".list_wrapper").show();},_showPackWrapper:function(){$("#tabSoDelayShip").find(".list_wrapper").hide();$("#tabSoDelayShip").find(".pack_wrapper").show();
},resSearchGrid:function(){$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(DelayShip._CONS_.GRID,a);
this.onSelectRow();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("soEntityShip.button.soAddLock")){$(".soAddLock").hide();}if(!ResUtils.canShow("soEntityShip.button.soUnLock")){$(".soUnLock").hide();
}ConfigUtils.findByKey("soEntity.isSelectStoreInShip",function(a){if(a.success==false){$(".storeBatchUpdate").hide();}});if(!ResUtils.canShow("soEntity.button.shipCompanyBatchUpdate")){$(".shipCompanyBatchUpdate").hide();
}if(!ResUtils.canShow("soEntity.button.storeBatchUpdate")){$(".storeBatchUpdate").hide();}if(!ResUtils.canShow("soEntity.button.selectStoreDeliver")){$(".selectStoreDeliver").hide();
}if(!ResUtils.canShow("soEntity.button.soEntityMerge")){$(".soEntityMerge").hide();}if(!ResUtils.canShow("soEntity.button.packing")){$(".soEntityPrintPack").hide();
}if(!ResUtils.canShow("soEntity.button.exportShip")){$(".soEntityPrintDeliver").hide();$(".printDeliverBtn").hide();}if(!ResUtils.canShow("soEntityStock.button.scPrint")){$(".soEntityPrintShip").hide();
$(".printShipBtn").hide();}if(!ResUtils.canShow("soEntity.button.printHot")){$(".soEntityPrinthot").hide();}if(!ResUtils.canShow("soEntity.button.hotPrint")){$(".soEntityHotPrint").hide();
$(".scHotPrintBtn").hide();}if(!ResUtils.canShow("soDeliver.button.setShipTmp")){$(".soEntitySetShipTmp").hide();}if(!ResUtils.canShow("soEntity.button.deliver")){$(".soEntityDeliver").hide();
}if(!ResUtils.canShow("soEntity.button.backDeliver")){$(".deliverBackBtn").hide();}if(!ResUtils.canShow("soEntity.button.turndown")){$(".soEntityTrunDown").hide();
$(".turnDownUpdate").hide();}if(!ResUtils.canShow("soEntity.button.exportDeliver")){$(".exportDeliverInfo").hide();}if(!ResUtils.canShow("soEntity.button.importDeliverInfo")){$(".importDeliverInfo").hide();
}if(!ResUtils.canShow("soEntity.button.close")){$(".soEntityClose").hide();}if(!ResUtils.canShow("soEntity.button.close")){$(".soEntityClose").hide();}if(!ResUtils.canShow("soEntity.button.sendSmsDeliver")){$(".sendSmsWhenDeliver").hide();
this.currentIsSendSms="n";}if(!ResUtils.canShow("soEntity.button.splitOrder")){$(".soEntitySplitOrder").hide();}},_bilidScCodeQrySearch:function(c,a,b){var d=new StringBuffer();
$("#soEntityDelayShipSearchForm").find(".scCodeQry option:selected").each(function(e){d.append($(this).val());if(e==b-1){return false;}else{d.append(",");
}});c=c+"&scCodeQry="+d.toString();return c;},_bilidCashTypeSearch:function(d,a,c){var b=new StringBuffer();$("#soEntityDelayShipSearchForm").find(".cashType option:selected").each(function(e){b.append($(this).val());
if(e==c-1){return false;}else{b.append(",");}});d=d+"&cashType="+b.toString();return d;},_showMergeSo:function(b,c){var a=this;a.layerIndex=layer.open({type:1,title:'订单合并<span style="color:red;padding-left:12px;">请谨慎操作，合并后无法恢复</span>',shadeClose:false,btn:["保存","关闭"],area:["30%","40%"],content:$(".mergeSoPanel"),scrollbar:false,success:function(d,e){var f=new StringBuffer();
f.append("<option value='"+c[0]+"'>"+c[0]+"</option>");f.append("<option value='"+c[1]+"'>"+c[1]+"</option>");$("#mergeToSo").empty().append(f.toString());
},yes:function(e,d){var f=$("#mergeToSo").val();a._mergeSo(f,b,c);},cancel:function(){}});},_splitSo:function(b,c,d){var a=this;$("#splitSoModalContainer").modal("show");
$(".splitSoListContent").hide();$(".splitSoBtnContent").hide();$(".splitSoListDiv").empty();$("#splitSoModal").text(b+" -- 订单拆分");a._buildSplitStr(b,c);
},_splitSoSave:function(){var e=[];var f=0;var d=[];var c="";var b="";var h="";var g="";var a=false;$(".splitSoListDiv tbody").find("tr").each(function(){f++;
if($(this).attr("count")){c=$(this).attr("soId");b=$(this).attr("soNo");h=$(this).find("input[name=splitShipTime]").val();g=$(this).attr("count");}var j={itemId:$(this).find(".itemCount").attr("itemId"),count:$(this).find(".splitCountItem").val(),};
if(j.count<0){a=true;return;}d.push(j);if(f==g){var i={id:c,soNo:b,shipTime:h,soItems:d};e.push(i);f=0;d=[];}});if(a){DialogUtils.error(msgCode.ERROR,"产品数量不能小于0");
return;}FormUtils.submit(ctx+"/ec/salesorder/soEntity/splitOrder.htm","splitPos="+JSON.stringify(e),function(i){if(i.success){$("#splitSoModalContainer").modal("hide");
DialogUtils.success(msgCode.SUCCESS,i.msg);$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.ERROR,i.msg);}});
},_buildSplitStr:function(b,c){var a=this;var d=new StringBuffer();$("#splitSoForm").find("input[name=soNo]").val(b);$("#splitSoForm").find("input[name=soId]").val(c);
FormUtils.submit(ctx+"/ec/salesorder/soEntity/edit.htm","soNo="+b,function(g){var f=g.soEntityPo.soItemPos;a.soItemPos=f;d.append("<table class='table table-bordered'>");
d.append("<thead>");d.append("<tr>");d.append("<th width='10%'>#</th>");d.append("<th width='35%'>商品名称</th>");d.append("<th width='10%'>总数量</th>");d.append("<th width='20%'>订单金额</th>");
d.append("<th width='25%'>拆分次数</th>");d.append("</tr>");d.append("</thead>");d.append("</tbody>");for(var e=0;e<f.length;e++){d.append("<tr>");d.append("<td width='10%'>"+(e+1)+"</td>");
d.append("<td width='30%'>"+f[e].prodName+"</td>");d.append("<td width='20%'>"+f[e].count+"</td>");if(e==0){d.append("<td width='20%' rowspan='"+f.length+"'>"+g.soEntityPo.totalAmount+"</td>");
d.append("<td rowspan='"+f.length+"'><div class='col-sm-8'><input type='number' class='form-control splitCount' validatetype='default'></div>");d.append("<button type='button' class='btn btn-sm  btn-primary splitPordBtn'>拆分</button>");
d.append("</td>");}d.append("</tr>");}d.append("</tbody>");d.append("</table>");$(".splitPordDiv").empty().append(d.toString());});},_mergeSo:function(e,c,d){var b=this;
var a=DelayShip._CONS_.MERGE_SO_URL;FormUtils.submit(a,{toSo:e,soNos:d,soIds:c,needValid:"y"},function(f){if(f.success){DialogUtils.success(msgCode.INFO,f.msg);
layer.close(b.layerIndex);$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);layer.close(b.layerIndex);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},updateStore:function(b,c){var a=ctx+"/ec/salesorder/soEntity/updateStore.htm";FormUtils.submit(a,{storeId:b,selectedIds:c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"修改结束");
$("#storeBatchUpdateModal2").modal("hide");$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");}else{DialogUtils.warning(msgCode.FAIL_MSG,d.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},updateShipCompany:function(b,c){var a=ctx+"/ec/salesorder/soEntity/updateShipCompany.htm";
FormUtils.submit(a,{scCode:b,selectedIds:c},function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);$("#shipCompanyBatchUpdateModal2").modal("hide");
$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bulidSoType:function(c,b){var a=this;var d=new StringBuffer();$("#soEntityDelayShipSearchForm").find(".soTypeQry option:selected").each(function(e){d.append($(this).val());
if(e==b-1){return false;}else{d.append(",");}});c=c+"&soType="+d.toString();return c;},_bindEventHander:function(){var a=this;$(".delay_ship_wrapper").on("click",".soAddLock",function(){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要冻结的订单");return;}DialogUtils.confirmWithOptions({title:"您确定要冻结选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.lock(b);
}});});$(".delay_ship_wrapper").on("click",".soUnLock",function(){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要解冻的订单");
return;}DialogUtils.confirmWithOptions({title:"您确定要解冻选中订单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){SoEntityUtils.unLock(b);}});});$("#storeBatchUpdateModal2").on("click","#storeBatchUpdateBtn2",function(){var b=$("#store-id2").val();
var c=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");a.updateStore(b,c);});$("#shipCompanyBatchUpdateModal2").on("click","#shipCompanyBatchUpdateBtn2",function(){var b=$("#scCodeQry2").val();
var d=$("#scCodeQry2").text();var c=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");a.updateShipCompany(b,c);});$(".delay_ship_wrapper").on("click",".storeBatchUpdate",function(){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}$("#storeBatchUpdateModal2").modal("show");});$(".delay_ship_wrapper").on("click",".shipCompanyBatchUpdate",function(){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}$("#shipCompanyBatchUpdateModal2").modal("show");});$(".delay_ship_wrapper").on("click",".soEntityMerge",function(){var i=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(i==null||i.length==0){DialogUtils.error("错误","请选择要操作的记录");return;}if(i.length!=2){DialogUtils.error("错误","只支持2张订单合并");return;}var g=$(DelayShip._CONS_.GRID).jqGrid("getRowData",i[0]);
var e=$(DelayShip._CONS_.GRID).jqGrid("getRowData",i[1]);if(g.csId!=e.csId){DialogUtils.error("错误","订单所属客户必须相同");return;}if(g.cashType!=e.cashType){DialogUtils.error("错误","货款方式必须相同");
return;}var h=$("[row-id="+i[0]+"]").val();var f=$("[row-id="+i[1]+"]").val();if(h!=""||f!=""){DialogUtils.error("错误","已录入快递单号的订单不能合并");return;}var d=[];
var k=g.isSplitOrderHide;var j=e.isSplitOrderHide;if(k==null||k==""){k="n";}if(j==null||j==""){j="n";}var c=g.originSoId;var b=e.originSoId;if(k=="n"&&j=="n"){d.push(g.soNoShow);
d.push(e.soNoShow);a._showMergeSo(i,d);}else{if(k=="n"&&j=="y"){if(g.id==e.originSoId){d.push(g.soNoShow);d.push(e.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","非父子关系的订单不能合并");
return;}}else{if(k=="y"&&j=="n"){if(g.originSoId==e.id){d.push(g.soNoShow);d.push(e.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","非父子关系的订单不能合并");
return;}}else{if(g.originSoId==e.originSoId){d.push(e.soNoShow);d.push(g.soNoShow);a._showMergeSo(i,d);}else{DialogUtils.error("错误","不属于同一源订单的子订单不能合并");
return;}}}}});$(".delay_ship_wrapper").on("click",".soEntitySearch",function(){if($(".delay_ship_wrapper").find(".searchProd").val()==""){$(".delay_ship_wrapper").find(".skuSearch").val("");
}var d=$(this).closest("form").serialize();var b=$("#soEntityDelayShipSearchForm").find(".scCodeQry option:selected").length;if(b!=0){d=a._bilidScCodeQrySearch(d,a,b);
}var c=$("#soEntityDelayShipSearchForm").find(".cashType option:selected").length;if(c!=0){d=a._bilidCashTypeSearch(d,a,c);}var e=$("#soEntityDelayShipSearchForm").find(".soTypeQry option:selected").length;
if(e!=0){d=a._bulidSoType(d,e);}a.reloadJqgrid(d);});$("#soEntityDelayShipSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();
a.reloadJqgrid(c);return false;}});$(".delay_ship_wrapper").on("click",".soEntityDeliver",function(){a._soEntityDeliver();});$("body").on("click",".selectStoreDelay",function(){var b=$("#storeId").val();
a._soEntityDeliver(b);});$(".delay_ship_wrapper").on("click",".soEntityTrunDown",function(){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要处理的订单");return;}var e=new Array();for(var c=0;c<b.length;c++){var d=$(DelayShip._CONS_.GRID).jqGrid("getRowData",b[c]);
e.push(d["soNoShow"]);}SoEntityUtils.trunDownOrderLayer(b,e,function(){a.clear(true);});});$("#tabSoDelayShip").on("click",".showSoDetail",function(){var g=$(this).attr("id-value");
var b=[];var e=$(DelayShip._CONS_.GRID).getRowData();var c=false;if(e&&e.length>0){for(var d=0;d<e.length;d++){if(e[d].id==g){c=true;}if(c){var f={id:e[d].id,soNo:e[d].soNoShow};
b.push(f);}}}SoEntityUtils.toDeliver(b);});$(".delay_list_wrapper").on("blur",".scTrackingNoInput",function(){var c=$(this).val();var b=$(this).attr("org-value");
var d=$(this).parents("tr").attr("id");if(c!=b){a._saveScTrackingNo(d,c,this);}});$(".delay_list_wrapper").on("keyup",".scTrackingNoInput",function(d){if(d.keyCode=="13"){var e=$("#autoMatchSoShip")[0].checked;
var c=$(this).val();var f=$(this).parents("tr").attr("id");if(!e){var b=$(this).attr("org-value");if(c!=b){a._saveScTrackingNo(f,c,this,true);}}else{a._autoMatchSoShip(f,c,this);
}}else{if(d.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".delay_list_wrapper").on("blur",".weightInput",function(){var c=$(this).val();
var b=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");if(c!=b){a._saveWeight(d,c,this);}});$(".delay_list_wrapper").on("keyup",".weightInput",function(c){if(c.keyCode=="13"){$(this).blur();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".delay_list_wrapper").on("blur",".actualAmountInput",function(){var b=$(this).val();
var c=$(this).attr("org-value");var d=$(this).parents("tr").attr("id");if(b!=c){a._saveActualAmount(d,b,this);}});$(".delay_list_wrapper").on("keyup",".actualAmountInput",function(c){if(c.keyCode=="13"){$(this).blur();
}else{if(c.keyCode=="27"){var b=$(this).attr("org-value");$(this).val(b);}}});$(".delay_ship_wrapper").on("change","#autoAddNumValue",function(){var b=$(this).val();
if(parseInt(b)<=0){$(this).val(1).focus();}});$(".delay_ship_wrapper").on("change","#belongOgnNameDelayShip",function(){$("#belongEmployeeDelayShipSearch").empty().append("<option value=''>请选择</option>");
if($(this).val()){SoEntityUtils.buildEmployeeOption($(this).val(),"belongEmployeeDelayShipSearch");}});$(".delay_ship_wrapper").on("click",".skuSearchImg",function(){SelectProdService.selectSku({isMultiple:0,hideCanSale:"y",fn:function(b){for(var c=0;
c<b.length;c++){$(".delay_ship_wrapper").find("input[id=skuSearch]").val(b[c].skuId);}}});});$(".delay_ship_wrapper").on("click",".exportDeliverInfo",function(){if($(".delay_ship_wrapper").find(".searchProd").val()==""){$(".delay_ship_wrapper").find(".skuSearch").val("");
}var c=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");var f="isSelectStoreInShip=n&refundStatusIsNull=y&Q__S__EQ__entity.status_=comfirm"+"&"+$("#soEntityDelayShipSearchForm").closest("form").serialize();
var b=$("#soEntityDelayShipSearchForm").find(".scCodeQry option:selected").length;if(b!=0){f=a._bilidScCodeQrySearch(f,a,b);}var e=$("#soEntityDelayShipSearchForm").find(".cashType option:selected").length;
if(e!=0){f=a._bilidCashTypeSearch(f,a,e);}var d=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","records");a.soEntityExport.init({params:f,selectIds:c,toatolCount:d});
});$(".delay_ship_wrapper").on("click",".soEntityPrintPack",function(){a.soEntityExport.exportPack(DelayShip._CONS_.GRID);});$(".delay_ship_wrapper").on("click",".importDeliverInfo",function(){var b={"importUrl":DelayShip._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入发货订单excel数据"};
excelUtil.importExcel(b);});$(".delay_ship_wrapper").on("click",".soEntityPrintDeliver",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");
return null;}var c=[];var j="ship_proxy";var f=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(f==null||f.length==0){DialogUtils.error("错误","请选择要打印快递单的订单");
return null;}var g=$(DelayShip._CONS_.GRID).jqGrid("getRowData",f[0]);var k=new StringBuffer();for(var h=0;h<f.length;h++){var e=$(DelayShip._CONS_.GRID).jqGrid("getRowData",f[h]);
var b=e["shipName"];k.append(e["soNoShow"]+",");}var d=k.toString();d=d.substring(0,d.length-1);JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=out_sale&entityId="+f+"&soNo="+d+"&scName="+b+"&proxyType="+j,"发货单打印");
});$(".delay_ship_wrapper").on("click",".soEntityPrintShip",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");
return null;}var c=[];var f=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(f==null||f.length==0){DialogUtils.error("错误","请选择要打印快递单的订单");
return null;}var g=$(DelayShip._CONS_.GRID).jqGrid("getRowData",f[0]);var n=g.shipName;var j="ship_proxy";var k=false;var m=new StringBuffer();for(var h=0;
h<f.length;h++){var e=$(DelayShip._CONS_.GRID).jqGrid("getRowData",f[h]);var l=e.shipName;if(l!=n){DialogUtils.error("错误","请先确定所有订单是否是同类型的快递公司");return null;
}if(e.proxyAmount!=0){k=true;}var b=e["shipName"];m.append(e["soNoShow"]+",");}if(!k){j="ship_not_proxy";}var d=m.toString();d=d.substring(0,d.length-1);
JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=ship&entityId="+f+"&soNo="+d+"&scName="+b+"&proxyType="+j,"普通快递单打印");
});$(".delay_ship_wrapper").on("click",".soEntityHotPrint",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印热敏纸");
return null;}var d=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(d==null||d.length==0){DialogUtils.error("错误","请选择要打印热敏纸的订单");return null;
}var e=$(DelayShip._CONS_.GRID).jqGrid("getRowData",d[0]);var l=e.shipName;var g="ship_proxy";var h=false;var k=new StringBuffer();for(var f=0;f<d.length;
f++){var c=$(DelayShip._CONS_.GRID).jqGrid("getRowData",d[f]);var j=c.shipName;if(j!=l){DialogUtils.error("错误","请选择同类快递公司");return null;}if(c.proxyAmount!=0){h=true;
}k.append(c["soNoShow"]+",");}if(!h){g="ship_not_proxy";}var b=k.toString();b=b.substring(0,b.length-1);JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=hotsensitive&entityId="+d+"&soNo="+b+"&scName="+j+"&proxyType="+g,"热敏快递单打印");
});$(".delay_ship_wrapper").on("click",".soEntityPrinthot",function(){var b=$(this).attr("idVal");if(!b){var b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要发送热敏纸的订单");return null;}}if(b&&b.length==1){var d=$(DelayShip._CONS_.GRID).jqGrid("getRowData",b);
var c=d["scTrackingNoShow"];if(c){DialogUtils.error("错误","已存在快递单号");return;}}ConfigUtils.findByKey("soEntity.isSendMotherwork",function(e){if(e.success){$("#printhotModalContainer").modal("show");
$("#printhotModalContainer").find("input[name=soId]").val(b);}else{ButtonUtils.disableBtn("soEntityPrinthot");FormUtils.submit(DelayShip._CONS_.SEND_HOTPRINT_URL+"?isStore=false&soId="+b,function(f){ButtonUtils.enableBtn("soEntityPrinthot");
if(f.success){$("#printhotModalContainer").modal("hide");DialogUtils.success(msgCode.SUCCESS,f.msg);$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");
}else{DialogUtils.error(msgCode.ERROR,f.msg);}},function(){ButtonUtils.enableBtn("soEntityPrinthot");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});});$("body").on("click",".printhotBtn",function(){var c=$("#printhotModalContainer").find("input[name=packQuantit]").val();var b=$("#printhotModalContainer").find("input[name=soId]").val();
ButtonUtils.disableBtn("printhotBtn");FormUtils.submit(DelayShip._CONS_.SEND_HOTPRINT_URL+"?isStore=false&soId="+b+"&packQuantit="+c,function(d){ButtonUtils.enableBtn("printhotBtn");
if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);a.clear(true);}else{DialogUtils.error(msgCode.ERROR,d.msg);}},function(){ButtonUtils.enableBtn("printhotBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".delay_ship_wrapper").on("click",".selectStoreDeliver",function(){var b=$(this).attr("idVal");
if(!b){var b=$(WaitDeliver._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要发送热敏纸的订单");return null;
}}if(b&&b.length==1){var d=$(WaitDeliver._CONS_.GRID).jqGrid("getRowData",b);var c=d["scTrackingNoShow"];if(c){DialogUtils.error("错误","已存在快递单号");return;
}}ButtonUtils.disableBtn("selectStoreDeliver");FormUtils.submit(WaitDeliver._CONS_.SEND_HOTPRINT_URL,"isStore=true&soId="+b,function(e){ButtonUtils.enableBtn("selectStoreDeliver");
if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);a.clear(true);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){ButtonUtils.enableBtn("selectStoreDeliver");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".delay_ship_wrapper").on("click",".soEntitySetShipTmp",function(){JTTabUtils.addOrRefreshTab(ctx+"/ec/ship/shipCompany/list.htm","物流公司");
});$(document).on("change","#tabSoDelayShip .lastFollow",function(){var b=$(this)[0].checked;if(b){a.simpleShowLastFollow=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").show();
$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").hide();}else{a.simpleShowLastFollow=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-follow").hide();
$(this).parents(".jqGrid_wrapper").find(".lastFollow-detail").show();}});$(document).on("change","#tabSoDelayShip .orderDesc",function(){var b=$(this)[0].checked;
if(b){a.simpleShowComment=true;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").show();$(this).parents(".jqGrid_wrapper").find(".comment-detail").hide();
}else{a.simpleShowComment=false;$(this).parents(".jqGrid_wrapper").find(".tooltip-comment").hide();$(this).parents(".jqGrid_wrapper").find(".comment-detail").show();
}});},_splitSoList:function(g){var b=this;var h=new StringBuffer();var e=b.soItemPos;h.append("<table class='table table-bordered'>");h.append("<thead>");
h.append("<tr>");h.append("<th width='5%'>#</th>");h.append("<th width='15%'>拆分订单</th>");h.append("<th width='30%'>产品名称</th>");h.append("<th width='12%'>拆出数量</th>");
h.append("<th width='12%'>金额</th>");h.append("<th width='26%'>发货时间</th>");h.append("</tr>");h.append("</thead>");h.append("<tbody>");for(var d=1;d<=g;d++){var a=0;
for(var c=0;c<e.length;c++){var f=parseInt((e[c].count/g).toFixed(0));a=d*f;if(a>e[c].count){f=e[c].count-((d-1)*f);}else{if(d==g&&a<e[c].count){f=(e[c].count-a)+f;
}}if(g==1){break;}else{h.append("<tr");if(c==0){if(d==1){h.append(" soId="+$("#splitSoForm").find("input[name=soId]").val()+" soNo="+$("#splitSoForm").find("input[name=soNo]").val());
}h.append(" count="+e.length+">");h.append("<td rowspan='"+e.length+"'>"+d+"</td>");if(d==1){h.append("<td rowspan='"+e.length+"'>"+$("#splitSoForm").find("input[name=soNo]").val()+"</td>");
}else{h.append("<td rowspan='"+e.length+"'></td>");}}else{h.append(">");}h.append("<td >"+e[c].prodName+"</td>");h.append("<td class='itemCount itemPord"+c+"' itemProd=itemPord"+c+" ");
h.append("itemCount="+f+" itemCountTotal="+e[c].count+" itemId="+e[c].id+"><input type='number' class='form-control splitCountItem' validatetype='default' value='"+f+"'></td>");
h.append("<td class='splitMoney' splitPrice="+e[c].salesPrice+">"+(e[c].salesPrice*f).toFixed(1)+"</td>");if(c==0){h.append("<td rowspan='"+e.length+"'><input class='laydate-icon form-control layer-date' name='splitShipTime' placeholder='yyyy-mm-dd hh:mm:ss' onclick='laydate({istime: true, min: laydate.now(1), format: \"YYYY-MM-DD hh:mm:ss\"})'></td>");
h.append("</tr>");}}}}h.append("<tbody>");h.append("</table>");$(".splitSoListContent").show();$(".splitSoBtnContent").show();$(".splitSoListDiv").empty().append(h.toString());
},_soEntityDeliver:function(a){var c=this;var b=$(".soEntityDeliver").attr("idVal");if(!b){b=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要发货的订单");return null;}for(var d=0;d<b.length;d++){var f=$(DelayShip._CONS_.GRID).jqGrid("getRowData",b[d]);
var e=$(f.scTrackingNo).attr("org-value");var a=f["storeId"];if(e==""||e==null||e.trim()==""){DialogUtils.error("错误","请先确定是否已有快递单");return null;}if(isSelectStoreInShip=="n"&&(a==""||a==null||a.trim()=="")){DialogUtils.error("错误","请先确定是否已选择仓库");
return null;}}}else{var f=$(DelayShip._CONS_.GRID).jqGrid("getRowData",b);var e=$(f.scTrackingNo).attr("org-value");var a=f["storeId"];if(e==""||e==null||e.trim()==""){DialogUtils.error("错误","请先确定是否已有快递单");
return null;}if(isSelectStoreInShip=="n"&&(a==""||a==null||a.trim()=="")){DialogUtils.error("错误","请先确定是否已选择仓库");return null;}}var g=$("input[name='sendSms'")[0].checked;
DialogUtils.confirmWithOptions({title:!g?"您确认不发送短信，直接将订单更改为已发货状态吗？":"您确定发货吗？",text:"",confirmButtonText:"确定",yesFunc:function(){c._deliver(b,g,a);}});},_autoMatchSoShip:function(a,h,k){var g={soId:a,key:"scTrackingNo",value:h};
this._saveEditGrid(g,k);var j={};var c=$(DelayShip._CONS_.GRID).jqGrid("getGridParam","selarrrow");var d=parseInt($("#autoAddNumValue").val());if(c.length<1){return;
}else{j[a]=true;var l=0;for(var f=0;f<c.length;f++){var e=$("#"+c[f]).find(".scTrackingNoInput");if(e.val()==""||e.val()==null){if(!j[c[f]]){j[c[f]]=true;
l+=d;var b={soId:c[f],key:"scTrackingNo",value:parseInt(h)+parseInt(l)};this._saveEditGrid(b,e);}}}}},_saveScTrackingNo:function(e,c,b,a){var d={soId:e,key:"scTrackingNo",value:c};
this._saveEditGrid(d,b,a);},_saveWeight:function(d,c,a){var b={soId:d,key:"weight",value:c};this._saveEditGrid(b,a);},_saveActualAmount:function(d,a,b){var c={soId:d,key:"actualAmount",value:a};
this._saveEditGrid(c,b);},_saveEditGrid:function(d,c,b){var a=DelayShip._CONS_.SAVE_GRID_URL;FormUtils.submit(a,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
$(c).attr("org-value",d.value);$(c).val(d.value);if($(c).attr("class")=="scTrackingNoInput"){$(c).parent().prev().text(d.value);}if(b){var f=$(c).parents("tr").nextAll("tr")[0];
$(f).find(".scTrackingNoInput").focus();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);$(c).val($(c).attr("org-value"));}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_deliver:function(e,d,b){var c=this;var a=DelayShip._CONS_.DELIVER_URL;ButtonUtils.disableBtn("soEntityDeliver");FormUtils.submit(a,{ids:e,sendSms:d?"y":"n",storeId:b},function(f){ButtonUtils.enableBtn("soEntityDeliver");
if(f.success){DialogUtils.success(msgCode.INFO,f.msg);$("#selectStoreModal").modal("hide");$("#tabSoDelayShip").find(".soEntitySearch").trigger("click");
}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);}},function(){ButtonUtils.enableBtn("soEntityDeliver");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},onSelectRow:function(){},_initJqgrid:function(){var c=this;var d=new Date();var f=DateUtils.format(d,"yyyy-MM-dd");var h=DateUtils.getBeforeDate(7,d);
var e=h+" 00:00:00";var b=f+" 23:59:59";$("#soEntityDelayShipSearchForm").find(".minPlaceTime").val(e);$("#soEntityDelayShipSearchForm").find(".maxPlaceTime").val(b);
var g={"Q__D__BW__entity.place_time_":e};var a=false;ConfigUtils.findByKey("soEntity.isShowExport",function(i){if(i.success){a=true;$(".isExportDiv").show();
}$(DelayShip._CONS_.GRID).JTJqgrid({url:DelayShip._CONS_.LIST_DATA_URL+"?positionType=order_print,dept_manager&Q__S__EQ__entity.status_=comfirm&isSelectStoreInShip=y"+"&canShowScTrankNo="+c.canShowScTrankNo,pager:DelayShip._CONS_.PAGER,width:"100%",autowidth:true,postData:g,footerrow:true,shrinkToFit:false,autoScroll:true,userDataOnFooter:true,colNames:["源订单ID(隐藏)","拆分(hide)","拆分","订单编号(隐藏)","订单编号","客户ID","ID","客户名称","客户","货款方式","加急","仓库","商品条目","快递公司","快递单号","快递单号","打印","重量(克)","运费(元)","代收款(元)","支付状态","最新跟进","订单备注","下单人","下单时间","延期发货时间","货款类型","更新时间","操作"],simplify:{key:"ddfh_yq",entry:[{"sClass":"lastFollow","sCheck":(c.simpleShowLastFollow?true:false),"sName":"最新跟进"},{"sClass":"orderDesc","sCheck":(c.simpleShowComment?true:false),"sName":"订单备注"}],must:["订单编号","客户"]},colModel:[{name:"originSoId",index:"origin_so_id_",width:70,hidedlg:true,hidden:true,},{name:"isSplitOrderHide",width:50,hidedlg:true,hidden:true,index:"is_split_order_",formatter:function(j,k,l){return l.isSplitOrder;
}},{name:"isSplitOrder",index:"is_split_order_",width:40,hidedlg:true,hidden:true,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";
}return j;}},{name:"soNoShow",index:"so_no_",width:70,hidedlg:true,hidden:true,formatter:function(j,k,l){if(j&&j.length>0){return j;}return l.soNo;}},{name:"soNo",index:"so_no_",width:80,formatter:function(k,l,m){if(!ResUtils.canShow("soEntity.button.deliver")){return k;
}if(m.footData){$(".ui-jqgrid-title").css({"width":"100%"});var j="<div style='float:left;'>"+m.soNoShow+"</div>"+"<div style='float:right;position:relative;'>"+"</div>";
$(DelayShip._CONS_.GRID).jqGrid("setCaption",j);return m.soNoShow;}else{if(m.soNo!=null&&m.soNo!=""){var n=new StringBuffer();n.append("<a href='#' class='showSoDetail' style='font-weight:bold;' value='"+k+"' id-value='"+m.id+"' csNameVal='"+m.csName+"'>"+k+"</a>");
if(a&&m.isExport=="y"){n.append("&nbsp;<span style='color:red'>导</span>");}return n.toString();}}}},{name:"csId",width:120,hidedlg:true,hidden:true},{name:"id",width:120,hidedlg:true,hidden:true},{name:"csNameShow",index:"name_",width:100,hidedlg:true,hidden:true,formatter:function(j,k,l){if(l.footData){return l.soNo;
}else{return l.csName;}}},{name:"csName",index:"name_",width:80,index:"entity.cs_code_",formatter:function(j,l,m){var k=j+":"+m.csCode;if($(window).width()<1024){k=j+"<br>"+m.csCode;
}return"<a href='#' class='csTab' style='font-weight:bold;' title='"+k+"' value='"+m.csId+"''>"+k+"</a>";}},{name:"cashType",index:"cash_type_",width:80,formatter:function(j){return SoEntityUtils.formatCashType(j);
}},{name:"isFast",index:"is_fast_",width:40,formatter:function(k){var j="否";if(k=="y"){j="<span style='color:red;'>是</span>";}return j;}},{name:"storeName",width:100,index:"entity.store_id_"},{name:"prodNames",sortable:false,width:90},{name:"shipName",width:90,index:"entity.ship_name_"},{name:"scTrackingNoShow",width:70,hidedlg:true,hidden:true,formatter:function(k,j,l){if(l.scTrackingNo==null){l.scTrackingNo="";
}return l.scTrackingNo;}},{name:"scTrackingNo",sortable:false,width:170,formatter:function(k,j,l){if(c.canShowScTrankNo=="can"){if(k==null){k="";}return"<input type='text' class='scTrackingNoInput' row-id='"+l.id+"' org-value='"+k+"' style='width:90%;'value='"+k+"' />";
}else{return"<span  class='scTrackingNoInput' row-id='"+l.id+"' org-value='"+k+"'>"+k+"</span>";}}},{name:"print",width:55,sortable:false,formatter:function(j,l,m){var k="";
if(m.isPrintHot=="y"){k="<span style='color:blue' title='已打印热敏纸'>热</span>";}if(m.isPrintHot=="y"&&m.isPrintShip=="y"){k+="<span style='color:red;'>|</span>";
}if(m.isPrintShip=="y"){k+="<span style='color:blue' title='已打印快递单'>快</span>";}return k;}},{name:"weight",width:70,sortable:false,formatter:function(k){var j=k;
if(k==null||k==""){j=0;}j=parseInt(j);return"<input type='number' class='weightInput' org-value='"+j+"' style='width:90%;'value='"+j+"' />";}},{name:"actualAmount",width:70,sortable:false,formatter:function(j){if(j==null||j==""){j=0;
}j=parseFloat(j).toFixed(2);return"<input type='number' class='actualAmountInput' org-value='"+j+"' style='width:90%;'value='"+j+"' />";}},{name:"proxyAmount",index:"entity.proxy_amount_",width:80,formatter:function(j){return parseFloat(j).toFixed(2);
}},{name:"payStatus",width:120,hidedlg:true,hidden:true},{name:"lastFollow",width:120,sortable:false,formatter:function(j){var k='<span  style="color:#1ab394;'+(c.simpleShowLastFollow?"":"display:none")+'" class="tooltip-follow jt-grid-tip fa fa-bell" data-value="'+j+'"></span>';
k+='<span style="'+(c.simpleShowLastFollow?"display:none":"")+'" class="lastFollow-detail">'+j+"</span>";return k;}},{name:"comment",width:120,formatter:function(m,j,l){var k="";
if(m!=""&&m!=null){k='<span  style="color:#1ab394;'+(c.simpleShowComment?"":"display:none")+'" class="tooltip-comment jt-grid-tip fa fa-bell" data-value="'+m+'"></span>';
k+='<span style="'+(c.simpleShowComment?"display:none":"")+'" class="comment-detail">'+m+"</span>";}return k;}},{name:"placerId",width:110,hidedlg:true,hidden:true},{name:"placeTime",width:110,index:"entity.place_time_",formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"delayShipTime",width:110,index:"entity.delay_ship_time_",formatter:function(j){return DateUtils.mini2Time(j);}},{name:"cashType",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"entity.update_time_",width:110,hidden:true,formatter:function(j){return DateUtils.mini2Time(j);
}},{name:"__manage",width:50,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:[],}],gridComplete:function(){var j=$(DelayShip._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
j.find("td").hide();j.find('td[aria-describedby*="_soNoShow"]').show();j.find("td").css({"font-weight":400});j.hide();},loadComplete:function(){if(c.gridRecordsSpan!=null){$(c.gridRecordsSpan).empty().append($(DelayShip._CONS_.GRID).jqGrid("getGridParam","records"));
}},onSelectRow:function(k,j){c.onSelectRow(k,j);},ondblClickRow:function(j){if(j){c._packMany(j);}}});});}};