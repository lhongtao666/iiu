$(function(){var a=new SoEntityWaitToDeliver();a.init();});function SoEntityWaitToDeliver(){this.soEntityBase=new SoEntityBase();}SoEntityWaitToDeliver._CONS_={PACK_FORM_ID:"#soEntityPackForm",SAVE_DELIVER_URL:ctx+"/ec/salesorder/soEntity/saveDeliver.htm",PACK_URL:ctx+"/ec/salesorder/soEntity/pack.htm",SO_SAVE_COMFIRM_URL:ctx+"/ec/salesorder/soEntity/soSaveEdit.htm",};
SoEntityWaitToDeliver.prototype={init:function(){this.soEntityBase.init();this._initPermissions();this._bindEventHander();this._completeData();this._initPreNextBtn();
$(".financeAttachDiv").hide();},_completeData:function(){$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name='scCodeShow']").trigger("change");if(soStatus!="comfirm"){$(".remove-deliver-btn").remove();
$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID).find(":input").attr("disabled",true);if(soStatus!="shipping"){$(".deliverBackBtn").remove();}else{$(".deliverBackBtn").attr("disabled",false);
}}$(".csName").attr("readonly",true);$("select[id=scCode]").attr("disabled",true);$("select[name=soType]").attr("disabled",true);$("select[name=cashType]").attr("disabled",true);
$("select[name=payType]").attr("disabled",true);$("select[name=account]").attr("disabled",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
$("input[name=subAmount]").attr("readonly",true);$("#prod-price-type").hide();$("#hasStock").parent().hide();$("#searchProd").parents(".form-group").hide();
$(".prodPrice").attr("readonly",true);$(".soItemCount").attr("readonly",true);$("select[name=storeId]").attr("disabled",true);$(".delSoItem").hide();$("#selectEmpBtn").hide();
},_initPermissions:function(){if(ResUtils.canShow("soDeliver.button.viewPhoneBtn")){$(".viewPhone").show();}else{$(".viewPhone").hide();}if(!ResUtils.canShow("soDeliver.modify.scCode")){$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name='scCodeShow']").attr("disabled","disabled");
}},_bindEventHander:function(){var a=this;$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});$("body").on("click",".setSmsTpl",function(){a._setSmsTplLayer();});$("body").on("click",".printDeliverBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印发货单");
return null;}var b=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soId]").val();var c=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soNo]").val();
var d=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scName]").val();JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=out_sale&entityId="+b+"&soNo="+c+"&scName="+d+"&proxyType=ship_proxy","订单发货单打印");
});$("body").on("click",".printShipBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印快递单");return null;}var c=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soId]").val();
var d=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soNo]").val();var f=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scName]").val();
var e=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=waitPayAmount]").val();var b="ship_proxy";if(e!=0){b="ship_not_proxy";}JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=ship&entityId="+c+"&soNo="+d+"&scName="+f+"&proxyType=ship_proxy","普通快递单打印");
});$("body").on("click",".scHotPrintBtn",function(){if(navigator.userAgent.indexOf("Firefox")==-1){DialogUtils.error("错误","只支持火狐浏览器打印热敏纸");return null;
}var b=$("#soEntityPackForm input[name=soId]").val();if($(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name=scCode] option:checked").attr("hotVar")=="n"){DialogUtils.error("错误","请先确定当前订单是否支持热敏打印");
return null;}var c=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soNo]").val();var e=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=csName]").val();
var d=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scName]").val();JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/stock/printExpressList.htm?entityType=hotsensitive&entityId="+b+"&soNo="+c+"&scName="+d+"&proxyType=ship_proxy","热敏快递单打印");
});$("body").on("click",".deliverBackBtn",function(){var b=$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=soId]").val();SoEntityUtils.backDeliver(b,function(){window.location.href=SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+b;
});});$("body").on("change",SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name='scCodeShow']",function(){$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scName]").val($(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name=scCodeShow").find("option:selected").text());
$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scCode]").val($(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" select[name=scCodeShow").find("option:selected").val());
});$("body").on("click","input[name=isHotPrint]",function(){if($(this).is(":checked")==true){$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scTrackingNo]").attr("readonly",true);
}else{$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=scTrackingNo]").attr("readonly",false);}});$("body").on("click",".savePackBtn",function(){a._savePack();
a.isClickSave=true;});$("body").on("click",".deliverBtn",function(){a._saveDeliver();a.isClickSave=true;});$(document).on("click",".preSoBtn",function(){var b="订单["+a.preSoNo+"]发货";
var d=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+$("#soEntityForm input[name=id]").val();var c=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+a.preSoId;
JTTabUtils.resetTab(d,c,b);window.location.href=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+a.preSoId;});$(document).on("click",".nextSoBtn",function(){var b="订单["+a.nextSoNo+"]发货";
var d=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+$("#soEntityForm input[name=id]").val();var c=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+a.nextSoId;
JTTabUtils.resetTab(d,c,b);window.location.href=ctx+"/ec/salesorder/soEntity/waitToDeliver.htm"+"?soId="+a.nextSoId;});$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});$("body").on("click",".soEntityTrunDown",function(){var b=$("#soEntityForm input[name=id]").val();var c=$("#soEntityForm input[name=soNo]").val();if(!b||b==null||!c||c==null){DialogUtils.error("错误","请选择要处理的订单");
return;}var d=new Array();var e=new Array();d.push(c);e.push(b);SoEntityUtils.trunDownOrderLayer(e,d,function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});});$(document).on("click",".saveSoComfirmBtn",function(){a._save();});$(document).on("change","#scCode",function(){$("[name='soShipPo.scCode']").val($(this).val());
var b=$("#scCode").find("option:selected").attr("attr-mobile");$("#servicePhoneBtn").attr("masknum",b);});},_initPreNextBtn:function(){var d=new StringBuffer();
var a=window.localStorage.getItem("deliver_"+currentUserId);if(a){var c=JSON.parse(a);if(c&&c.length>0){for(var b=0;b<c.length;b++){if($("#soEntityForm input[name=id]").val()==c[b].id){if(b>0){this.preSoId=c[b-1].id;
this.preSoNo=c[b-1].soNo;$(".preSoBtn").show();}if(b<c.length-1){this.nextSoId=c[b+1].id;this.nextSoNo=c[b+1].soNo;$(".nextSoBtn").show();}break;}}}}},_savePack:function(){ButtonUtils.disableBtn("savePackBtn");
FormUtils.submitByFormId(SoEntityWaitToDeliver._CONS_.PACK_URL,"soEntityPackForm",function(a){ButtonUtils.enableBtn("savePackBtn");if(a.success){DialogUtils.success(msgCode.INFO,"打包成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,a.msg);}},function(){ButtonUtils.enableBtn("savePackBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_saveDeliver:function(){var a=this;ButtonUtils.disableBtn("deliverBtn");FormUtils.submitByFormId(SoEntityWaitToDeliver._CONS_.SAVE_DELIVER_URL,"soEntityPackForm",function(b){ButtonUtils.enableBtn("deliverBtn");
if(b.success){if(a.nextSoId){$(".nextSoBtn").trigger("click");}else{DialogUtils.success(msgCode.INFO,"发货成功");$(".savePackBtn").attr("disabled",true);$(".deliverBtn").attr("disabled",true);
$(".printDeliverBtn").attr("disabled",true);$(".printShipBtn").attr("disabled",true);$(".scHotPrintBtn").attr("disabled",true);$(".turnDownUpdate").attr("disabled",true);
$(".deliverBackBtn").attr("disabled",false);$(".soEntityTrunDown").attr("disabled",true);$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID).find(":input").attr("disabled",true);
}}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){ButtonUtils.enableBtn("deliverBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_setSmsTplLayer:function(){self.layerIndex=layer.open({type:1,title:"设置短信模板",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","350px"],content:$(".setSmsTplPane"),success:function(a,b){$("#setSmsTplForm").find("#setSmsTpl").val($(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID+" input[name=smsTpl]").val());
},yes:function(b,a){$(SoEntityWaitToDeliver._CONS_.PACK_FORM_ID).find("input[name=smsTpl]").val($("#setSmsTplForm").find("#setSmsTpl").val());layer.close(self.layerIndex);
},cancel:function(){FormUtils.clear("setSmsTplForm");}});},_save:function(){var j=this;var b=$("[name='addrId']").val();if(!b){DialogUtils.error(msgCode.ERROR,"请选择收货地址");
return;}var a=$(".defaultAddr").find(".addrName").val();if(!a){DialogUtils.error(msgCode.ERROR,"收货地址请填写收货人");return;}var f=$(".defaultAddr").find(".addrMobile").val();
if(!f){DialogUtils.error(msgCode.ERROR,"收货地址请填写联系方式");return;}var c=$(".defaultAddr").find(".addrInfo").val();if(!c){DialogUtils.error(msgCode.ERROR,"收货地址请填写地址信息");
return;}if(!$("#soProfitTip").is(":hidden")){DialogUtils.error(msgCode.ERROR,$("#soProfitTip").val());return;}var h=$("#scCode").val();if(!h){DialogUtils.error(msgCode.ERROR,"请选择快递方式");
return;}var d=$("[name=totalAmount]").val();if(d==0){var e=$("[name=cashType]").val();if("free"!=e){DialogUtils.error(msgCode.ERROR,"非免费已付的订单总金额不能为0");
return;}}if($("#soEntityForm").valid()){var i=$("#soItemTbody").find("tr");if(!i||i.length<1){DialogUtils.error(msgCode.ERROR,"请添加要购买的商品");return;}$("[name='soShipPo.scName']").val($("#scCode").find("option:selected").text());
$("[name='soShipPo.scCode']").val($("#scCode").find("option:selected").val());$("input[name=prodAmount]").val($("#prodPriceTotal").text());$("input[name=prodQty]").val($("#itemCountTotal").text());
var g=$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).serialize()+"&soItemJson="+j.soEntityBase.getSoItemData()+"&soProfitJson="+j.soEntityBase.getSoProfitData()+"&operComment="+$("input[name=operComment]").val();
DialogUtils.confirmWithOptions({title:"是否确认保存订单？",text:"",confirmButtonText:"确认",yesFunc:function(){j._submitEntity(g);}});}},_submitEntity:function(d){var b=this;
var c=this.nextSoId;ButtonUtils.disableBtn("saveSoComfirmBtn");ButtonUtils.disableBtn("savePackBtn");var a=SoEntityWaitToDeliver._CONS_.SO_SAVE_COMFIRM_URL;
FormUtils.submit(a,d,function(e){ButtonUtils.enableBtn("saveSoComfirmBtn");ButtonUtils.enableBtn("savePackBtn");if(e.success){DialogUtils.success(msgCode.INFO,e.msg+"成功");
b.init();}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("saveSoComfirmBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},};