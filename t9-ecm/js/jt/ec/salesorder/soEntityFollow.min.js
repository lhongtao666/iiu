$(function(){var a=new SoEntityFollow();a.init();});function SoEntityFollow(){this.soEntityBase=new SoEntityBase();this.soEntityQueryLogistics=new SoEntityQueryLogistics();
this.nextSoId="";this.preSoId="";}SoEntityFollow._CONS_={SO_FOLLOW_URL:ctx+"/ec/salesorder/soEntity/follow.htm",SO_TO_FOLLOW_URL:ctx+"/ec/salesorder/soEntity/toFollow.htm",UPDATE_FOLLOW_URL:ctx+"/ec/salesorder/soEntity/updateFollow.htm",SHIP_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/logicsByNo.htm",SAVE_ITEM_INFO_URL:ctx+"/ec/salesorder/soEntity/saveItemInfo.htm",SO_PLACE_HISTORY_URL:ctx+"/ec/salesorder/soEntity/orderHistory.htm",SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",};
SoEntityFollow.prototype={init:function(){this.soEntityBase.init();this._initFollow();this._hideNotGrantedBtn();this._bindEventHander();this.soEntityQueryLogistics.init();
if(ResUtils.canShow("soEntityFollow.button.orderHistory")){this._orderHistory();}},_orderHistory:function(){var a=this;var b=$("#soEntityForm").find("input[name=csCode]").val();
var c=DateUtils.getBeforeMonth(1)+" 00:00:00";FormUtils.loadData(SoEntityFollow._CONS_.SO_PLACE_HISTORY_URL+"?csSearchParam="+b+"&Q__D__BW__entity.place_time_="+c,function(k){var h=k.rows;
if(h&&h.length>0){var l=new StringBuffer();for(var g=0;g<h.length;g++){var f=SoEntityUtils.formatCashType(h[g].cashType);var d=SoEntityUtils.formatStatus(h[g]);
var e=g+1;l.append("<tr>");l.append("<td style='width: 5%'>"+e+"</td>");l.append("<td style='width: 15%' ><a href='#' class='soNoDetail' value='"+h[g].soNo+"'>"+h[g].soNo+"</a></td>");
l.append("<td style='width: 20%'>"+h[g].prodNames+"</td>");l.append("<td style='width: 10%'>"+f+"</td>");l.append("<td style='width: 10%'>"+h[g].totalAmount+"</td>");
l.append("<td style='width: 15%'>"+d+"</td>");l.append("<td style='width: 10%'>"+h[g].placerName+"</td>");l.append("<td style='width: 15%'>"+h[g].placeTime+"</td>");
l.append("</tr>");}$("#orderHistory").empty().append(l.toString());}},null,true);},_hideNotGrantedBtn:function(){if(ResUtils.canShow("csFollow.button.modifySoFee")){if($("select[name=isCloudWarehourse]").val()=="1"){$("select[name=cashType]").attr("disabled",true);
}$("select[name=payType]").attr("disabled",false);$("select[name=account]").attr("disabled",false);$("input[name=subAmount]").attr("readonly",false);$("input[name=totalAmount]").attr("readonly",false);
$("input[name=waitPayAmount]").attr("readonly",false);$("input[name=shippingAmount]").attr("readonly",false);}if(!ResUtils.canShow("soFollow.button.backDeliver")){$(".deliverBack").hide();
}if(!ResUtils.canShow("soEntityFollow.button.orderHistory")){$(".playHistory").hide();}},_initFollow:function(){$("select[name=isCloudWarehourse]").attr("disabled",true);
var b=$("input[name=soStatus]").val();if("complete"==b||"close_reject"==b||"close_lost"==b){$("#saveShippedBtn").hide();$(".saveSoShippedBtn").hide();if("close_reject"==b){$(".backStatusDiv").show();
$(".rejectDiv").show();$("#rejectType").hide();var a=$("input[name=rejectTypeName]").val();$("#rejectTypeOne").empty().append("<option>"+a+"</option>");
$("select[name=newStatus]").attr("disabled",true);$("select[name=backStatus]").attr("disabled",true);$("select[name=rejectTypeOne]").attr("disabled",true);
$("textarea[name=rejectReason]").attr("readonly",true);}if("close_lost"==b){$(".lostDiv").show();$("input[name='soShipPo.breakAmount']").attr("readonly",true);
}}if(ResUtils.canShow("soFollow.button.modifyAmount")){$(".updateTotalAmount").show();}if(!ResUtils.canShow("soFollow.button.shipQry")){$(".shipQryBtn").hide();
}if(!ResUtils.canShow("soFollow.button.shippedSave")){$(".saveShippedBtn").hide();}if(!ResUtils.canShow("soFollow.button.saveSoShippedBtn")){$(".saveSoShippedBtn").hide();
}CateUtils.getOptions([{typeKey:"system",pKey:"damageType",container:"damageType"},{typeKey:"system",pKey:"damageReason",container:"damageReason"}]);if(!ResUtils.canShow("soFollow.button.addSoItemDamage")){$(".revokeDamage").hide();
$(".addSoItemDamage").hide();}this._initShipFollowSelect();this._initPreNextBtn();if($("select[name=cashType]").val()=="cod"||$("select[name=cashType]").val()=="free"||$("select[name=cashType]").val()=="point"){$(".financeAttachDiv").hide();
}SoEntityUtils.initDetail(financeBillAttachPos);var c=new UploadImageUtil();c.init("uploader");$(".uploadImage").show();if(isFollowPage=="y"){ConfigUtils.findByKey("system.isBanDelayConfirm",function(d){if(d.success){$(".othersDiv").hide();
}else{$(".othersDiv").show();}$(".delayConfirmTime").find(".simple-time-select").remove();});}},_bindEventHander:function(){var a=this;$(document).on("click",".soNoDetail",function(){var d=$("#soEntityForm").find(".csName").val();
var c=$(this).attr("value");var b=ResUtils.canShow("mySoEntity.button.showScTrackNo")?"can":"cannot";JTTabUtils.addOrRefreshTab(SoEntityFollow._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+c+"&canShowScTrankNo="+b,d+"的订单明细");
});$(document).on("mouseenter",".playHistory",function(){$("#orderHistoryContent").stop().show("fast");});$("#orderHistoryContent").hover(function(b){$("#orderHistoryContent").stop(true,true).show();
},function(b){if(!$(".playHistory").hasClass("playHistoryOn")){$("#orderHistoryContent").stop().hide("fast");}});$(document).on("mouseleave",".playHistory",function(){if(!$(".playHistory").hasClass("playHistoryOn")){$("#orderHistoryContent").stop().hide("fast");
}});$(document).on("click",".playHistory",function(){if($(this).hasClass("playHistoryOn")){$(this).removeClass("playHistoryOn");}else{$(this).addClass("playHistoryOn");
}});$("body").on("click",".deliverBack",function(){var c=$("#soEntityForm input[name='id']").val();var b=$("#soEntityForm input[name='soNo']").val();SoEntityUtils.backDeliver(c,function(){var d=[];
var e={id:c,soNo:b};d.push(e);SoEntityUtils.toDeliver(d);});});$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});$(document).on("change","select[id=shippedShipResult]",function(){if($(this).val()=="complete"||$(this).val()==""){$(".backStatusDiv").hide();$(".rejectDiv").hide();
$(".lostDiv").hide();}else{if($(this).val()=="close_lost"){$(".backStatusDiv").hide();$(".rejectDiv").hide();$(".lostDiv").show();}else{if($(this).val()=="close_reject"){$(".backStatusDiv").show();
$(".rejectDiv").show();$(".lostDiv").hide();CateUtils.getOptions({typeKey:"system",pKey:"shipRejectType",container:"rejectType"});}}}});$(document).on("change","select[id=backBreakType]",function(){if($(this).val()=="break"){$(".breakAmt").show();
}else{$("input[id=backBreakAmount]").val("0");$("input[id=backBreakAmount]").focus();$("input[id=backBreakAmount]").blur();$(".breakAmt").hide();}});$(document).on("change","select[id=rejectTypeOne]",function(){if($(this).val()=="ship"){CateUtils.getOptions({typeKey:"system",pKey:"shipRejectType",container:"rejectType"});
}else{if($(this).val()=="cs"){CateUtils.getOptions({typeKey:"system",pKey:"csRejectType",container:"rejectType"});}else{if($(this).val()=="emp"){CateUtils.getOptions({typeKey:"system",pKey:"empRejectType",container:"rejectType"});
}else{if($(this).val()=="turn"){CateUtils.getOptions({typeKey:"system",pKey:"turnRejectType",container:"rejectType"});}}}}});$(document).on("click",".saveShippedBtn",function(){var b=$("#shippedShipResult").val();
if(!b){DialogUtils.error(msgCode.ERROR,"请选择发货结果");return;}DialogUtils.confirmWithOptions({title:"您确认要保存发货结果吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._save("y");
}});});$(document).on("click",".saveSoShippedBtn",function(){DialogUtils.confirmWithOptions({title:"您确认要保存订单吗？",text:"",confirmButtonText:"确认",yesFunc:function(){a._save("n");
}});});$(document).on("click",".preSoBtn",function(){var b="订单["+a.preSoNo+"]跟进";var d=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+$("input[name=id]").val()+"&soNo="+$("input[name=soNo]").val();
var c=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+a.preSoId+"&soNo="+a.preSoNo;JTTabUtils.resetTab(d,c,b);window.location.href=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+a.preSoId+"&soNo="+a.preSoNo;
});$(document).on("click",".nextSoBtn",function(){var b="订单["+a.nextSoNo+"]跟进";var d=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+$("input[name=id]").val()+"&soNo="+$("input[name=soNo]").val();
var c=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+a.nextSoId+"&soNo="+a.nextSoNo;JTTabUtils.resetTab(d,c,b);window.location.href=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+a.nextSoId+"&soNo="+a.nextSoNo;
});$(document).on("click",".saveFollowStatus",function(){FormUtils.loadData(SoEntityFollow._CONS_.UPDATE_FOLLOW_URL+"?id="+$("input[name=id]").val()+"&followStatus="+$("#followQry").val(),function(b){if(b.success){DialogUtils.success(msgCode.INFO,"保存跟单状态成功");
}else{DialogUtils.error(msgCode.ERROR,b.msg);}});});$(document).on("click",".changeEmployee",function(){a._changeEmployee();});$(document).on("click",".addSoItemDamage",function(){$("input[name=itemCount]").val($(this).attr("itemCount"));
$("input[name=itemId]").val($(this).attr("itemIdVal"));$("input[name=damageCount]").val($(this).attr("damageCountVal")==0?"1":$(this).attr("damageCountVal"));
$("select[name=damageReason]").val($(this).attr("damageReasonVal"));$("select[name=damageType]").val($(this).attr("damageTypeVal"));$("#damageModalContainer").modal("show");
});$(document).on("click","#saveDamageBtn",function(){var b=this;if($("input[name=damageCount]").val()<1){DialogUtils.error("提示","破损数量不能少于1");return;}if($("input[name=damageCount]").val()>$("input[name=itemCount]").val()){DialogUtils.error("提示","破损数量不能大于订单商品数量");
return;}if($("#damageReason").val()<1){DialogUtils.error("提示","破损原因不能为空");return;}if($("#damageType").val()<1){DialogUtils.error("提示","破损程度不能为空");return;
}$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageCount").val($("input[name=damageCount]").val());$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageReason").val($("#damageReason").val());
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageType").val($("#damageType").val());var c={"id":$("input[name=itemId]").val(),"damageCount":$("input[name=damageCount]").val(),"damageReason":$("#damageReason").val(),"damageType":$("#damageType").val(),};
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",true);FormUtils.submit(SoEntityFollow._CONS_.SAVE_ITEM_INFO_URL,c,function(d){if(d.success){$("#damageModalContainer").modal("hide");
DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").hide();
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".revokeDamage").show();}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",false);
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".revokeDamage",function(){var b=this;var d={"id":$(this).attr("itemIdVal"),"damageCount":0,"damageReason":null,"damageType":null,};
var c=$(this);FormUtils.submit(SoEntityFollow._CONS_.SAVE_ITEM_INFO_URL,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
c.prev().show();c.hide();c.prev().attr("disabled",false);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){c.attr("disabled",false);DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},_initShipFollowSelect:function(){CateUtils.getOptions({typeKey:"system",pKey:"soFollowStatus",container:"followQry",fn:function(a){var b=$("input[name=shipFollow]").val();
var f=new StringBuffer();f.append("<option value=''>请选择跟单状态</option>");for(var d=0;d<a.length;d++){var e=a[d].value;var c=a[d].name;if(b&&b==e){f.append("<option value='"+e+"' selected='selected'>"+c+"</option>");
}else{f.append("<option value='"+e+"'>"+c+"</option>");}}$("#followQry").empty().append(f.toString());}});},_changeEmployee:function(){var a=this;var b=0;
if(ResUtils.canShow("employeeSelector.button.cs")){b:1;}var d={isShowAllGroup:b,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,callBack:function(f){if(f!=null){if(f.length>0){$("input[name=employeeId]").val(f[0].id);
$("input[name=employeeAid]").val(f[0].aid);$("input[id=employeeShow]").val(f[0].aid+"："+f[0].name);var e=[];e.push({employeeId:f[0].id,csEntityIds:$("input[name=csId]").val()});
var g={soId:$("input[name=id]").val(),comment:"跟进转工号，从工号"+$("#originEmployee").val()+"转到工号"+$("#employeeShow").val()};$("#originEmployee").val(f[0].aid+"："+f[0].name);
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(e),csType:"csEntity",soInfo:JSON.stringify(g)},function(h){if(h.success){DialogUtils.success("提示",h.msg);
}else{DialogUtils.error("失败",h.msg);}});}}}};var c=new EmployeesSelect();c.init(d);},_save:function(d){var c=new UploadImageUtil();var b=this;var a="n";
if(ResUtils.canShow("csFollow.button.modifySoFee")){var a="y";}if("cod"==$("select[name=cashType]").val()&&"shipping"==$("input[name=status]").val()){if($("input[name='subAmount']").val()!=0&&parseFloat($("input[name='subAmount']").val()).toFixed(2)!=$("input[name='totalAmount']").val()){DialogUtils.error("货到付款若修改订金，必须订金等于总金额");
return false;}}ButtonUtils.disableBtn("saveShippedBtn");$("select[name=storeId]").attr("disabled",false);if($("#soEntityShippedForm").valid()){var e=$("#soEntityShippedForm").serialize()+"&"+$("#soEntityForm").serialize()+"&soItemJson="+b.soEntityBase.getSoItemData()+"&soProfitJson="+b.soEntityBase.getSoProfitData()+"&isFollow="+d+"&canModifySoFee="+a+"&billAttachJson="+JSON.stringify(c._buildImageJson());
FormUtils.submit(SoEntityFollow._CONS_.SO_FOLLOW_URL,e,function(f){ButtonUtils.enableBtn("saveShippedBtn");if(f.success){if(d=="y"){DialogUtils.success(msgCode.INFO,"发货结果保存成功");
if(b.nextSoId){$(".nextSoBtn").trigger("click");}else{$(".saveShippedBtn").attr("disabled",true);$("#shippedShipResult").attr("disabled",true);$("select[name=newStatus]").attr("disabled",true);
$("select[name=backStatus]").attr("disabled",true);$("select[name=rejectTypeOne]").attr("disabled",true);$("select[name=rejectType]").attr("disabled",true);
$("textarea[name=rejectReason]").attr("readonly",true);$("input[name=updateTotalAmount]").attr("disabled",true);$("select[name=storeId]").attr("disabled",true);
}}else{DialogUtils.success(msgCode.INFO,"订单保存成功");window.location.href=SoEntityFollow._CONS_.SO_TO_FOLLOW_URL+"?soId="+$("input[name=id]").val()+"&soNo="+$("input[name=soNo]").val();
}JTTabUtils.refreshTable(ctx+"/ec/salesorder/soEntity/list.htm?bizType=belong","订单跟进","parentCMD");}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);}},function(){ButtonUtils.enableBtn("saveShippedBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}else{ButtonUtils.enableBtn("saveShippedBtn");}},_initPreNextBtn:function(){var e=new StringBuffer();
e.append("<a style='line-height:30px;' class='csCode' value='"+$("input[name=csId]").val()+"'>"+$(".csName").val()+" - "+$("input[name=soNo]").val()+"</a>");
var b=window.localStorage.getItem("follow_so_ids_"+currentUserId);var d=window.localStorage.getItem("follow_so_nos_"+currentUserId);if(b){b=b.split(",");
d=d.split(",");for(var a=0;a<b.length;a++){if($("input[name=id]").val()==b[a]){if(a>0){this.preSoId=b[a-1];this.preSoNo=d[a-1];$(".preSoBtn").show();}if(a<b.length-1){this.nextSoId=b[a+1];
this.nextSoNo=d[a+1];$(".nextSoBtn").show();}if(b.length>1){var c="（"+(a+1)+"/"+b.length+"）";e.append("<span>"+c+"</span>");}break;}}}$(".soNoDiv").empty().append(e.toString());
},};