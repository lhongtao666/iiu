function SoEntityBase(){this.soCustomer=new SoCustomer();this.csFollow=new CsFollow();}SoEntityBase._CONS_={SO_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CS_DETAIL_URL:ctx+"/crm/cs/csEntity/edit.htm",EDIT_FORM_ID:"soEntityForm",};
SoEntityBase.prototype={init:function(){this._initBaseInfo();this.soCustomer.init(csId);this._initFollow();this._bindFormValidation();this._bindEventHander();
this._initPermissions();this._initServicePhone();this.priceFollowLog="";this.skuFollowLog="";},_initBaseInfo:function(){this._initSoItemPic();var b=$("input[name='status']").val();
if(""==b||"awaiting_post"==b||"awaiting_comfirm"==b||"awaiting_pay"==b){this._loadRecommendProds();var a=$("select[name=storeId]").val();if(a==undefined){a="";
}this._prodSearch(a);}this._calSoItemTotal();this._calWaitPayAmount();if("pay_sub"==$("[name=cashType]").val()){$("[name=subAmount]").attr("readonly",false);
}},_initServicePhone:function(){var a=$("#scCode").find("option:selected").attr("attr-mobile");$("#servicePhoneBtn").attr("masknum",a);},_initPermissions:function(){if(!ResUtils.canShow("mySoEntity.button.modifyProfit")){$("#selectEmpBtn").remove();
}if(!ResUtils.canShow("csEntity.totalPrice.modify")){$("input[name=totalAmount]").attr("readonly","readonly");}else{if(!$("input[name=totalAmount]").attr("readonly")){$("input[name=totalAmount]").removeAttr("readonly");
}}if(ResUtils.canShow("soEntity.button.viewPhoneBtn")){$(".viewPhone").show();}else{$(".viewPhone").hide();}if(!ResUtils.canShow("soEntitySearch.button.deleteSoLog")){$(".deleteSoLogTd").remove();
}ConfigUtils.findByKey("soEntity.isReceivePhone",function(a){if(a.success){$("#receivePhoneDiv").show();isReceivePhone=true;}else{$("#receivePhoneDiv").hide();
}});},_initFollow:function(){var b=this;var c=$("input[name=id]").val();if(c){var a="<a href='#' class='soTab' value='"+$("[name=soNo]").val()+"'>"+$("[name=soNo]").val()+"</a>，订单金额<span style='color:red'>"+$("[name=totalAmount]").val()+"元</span>)";
var d={csId:$("input[name=csId]").val(),csCode:$(".csCode").val(),entityId:c,needTable:false,followType:"so",contentExt:a,fn:function(e){b._addSoLog(e);
}};this.csFollow.init(d,{partyId:$("input[name=employeeId]").val(),partyAid:$("input[name=employeeAid]").val(),partyName:$("input[name=employeeName]").val()});
}},getSoItemData:function(){var e=[];var a=$("#soItemTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;b++){var d=$(a[b]);var c={};c.prodName=d.find(".prodShow").attr("nameValue");
c.id=d.attr("name");c.soId=d.find(".soId").val();c.skuId=d.find(".skuId").val();c.skuKey=d.find(".skuKey").val();c.isMain="y";c.salesPrice=d.find(".prodPrice").val();
c.count=d.find(".soItemCount").val();c.damageCount=d.find(".damageCount").val();c.damageReason=d.find(".damageReason").val();c.damageType=d.find(".damageType").val();
e.push(c);}}return JSON.stringify(e);},getSoProfitData:function(){var f=[];var a=$("#soProfitTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;
b++){var d=$(a[b]);var e={};var c=parseInt(parseFloat(d.find(".soProfitPercent").val())*100);if(c==0){continue;}e.partyId=d.find(".profitEmpId").val();
e.id=d.find(".profitId").val();e.percent=c;f.push(e);}}return JSON.stringify(f);},_loadRecommendProds:function(a){return;var a=$("select[name=storeId]").val();
$("#recomendProdsContainer").empty();var b=ctx+"/ec/salesorder/soEntity/getRecommendProds.htm?csId="+$("input[name=csId]").val()+"&storeId="+a+"&prodType=entity";
FormUtils.loadData(b,function(e){if(e&&e.length){var m=new StringBuffer();for(var g=0;g<e.length;g++){m.append("<div class='form-group' style='border-bottom: 1px solid #ddd;'>");
m.append("<div class='col-sm-2'>");m.append("<img src='"+ctx+e[g].path+"' style='height: 140px; width: 95px; padding-left:5px;'>");m.append("</div>");m.append("<div class='col-sm-5 skuContainer' imgUrlVal='"+e[g].path+"' selectedSkuIdVal='"+e[g].skuId+"' prodIdVal='"+e[g].id+"'>");
m.append("<p style='margin: 0 0 2px 0px;' class='prodNameContainer'><a nameValue='"+e[g].name+"' keyValue='"+e[g].key+"' class='prodShow' value='"+e[g].skuId+"' href='javascript:void(0);'>"+e[g].name+"</a></p>");
m.append("<p>"+e[g].subName+"</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("价格:");m.append("<strong style='color:red;' class='priceContainer'>￥"+e[g].price+"");
m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("sku:");m.append("<strong style='color: red;' class='skuCodeContainer'>");
m.append(e[g].skuCode);m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("库存数量:");m.append("<strong style='color: red;' class='stockContainer'>");
m.append(e[g].canSaleQty);m.append("</strong>");m.append("</p>");if(e[g].skuMap){for(var l in e[g].skuMap){m.append("<p class='chooseSku'>");m.append("<span>"+l+":</span>");
if(e[g].skuMap[l].length){for(var d=0;d<e[g].skuMap[l].length;d++){var f="btn-default";if(e[g].skuMap[l][d].isSelected=="y"){f="btn-primary";}m.append("<button valValue='"+e[g].skuMap[l][d].value+"' type='button' class='btn btn-xs "+f+" skuBtn'>"+e[g].skuMap[l][d].name+"</button>&nbsp;");
}}m.append("</p>");}}m.append("<p>");m.append("<button type='button' class='btn btn-xs  btn-primary addToCartBtn'>");m.append("购买</button>");m.append("</p>");
m.append("</div>");m.append("<div class='col-sm-5'>");for(var h in e[g].eavShowView.eavAttrValueMap){for(var c=0;c<e[g].eavShowView.eavAttrValueMap[h].length;
c++){for(var d=0;d<e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos.length;d++){if(e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].checked){m.append("<div class='checkbox checkbox-success checkbox-inline'>");
m.append("<input disabled='disabled' checked='checked' class='checkRes' type='checkbox'>");m.append("<label>"+e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].label+"</label>");
m.append("</div>");}}}}m.append("</div>");m.append("</div>");}$("#recomendProdsContainer").append(m.toString());}else{$("#recomendProdsContainer").append("<p>无推荐产品</p>");
}});},_bindEventHander:function(){var a=this;$("body").on("click",".viewPhone",function(){var d=this;var c=$(this).attr("attr-num");var b={number:c,callback:function(e){$(d).parents(".addrDiv").find(".addrMobile").val(e);
}};DecryptHelper.decrypt(b);});$(document).on("click",".delSoItem",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calSum();}});});$(document).on("change",".prodPrice",function(){var f=$(this).closest("tr");var g=$(f);var h=parseFloat(g.find(".originPrice").text());
var d=parseFloat(g.find(".skuPercentLimit").val());var b=parseFloat($(this).val());var j=0;var i="";var e=false;if(parseInt(percentLimit)){var k=parseFloat(h*(parseInt(percentLimit)/100)).toFixed(2);
j=k;if(parseFloat(k)>b){i="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+k;e=true;}}if(d){var k=parseFloat(h*(d/100)).toFixed(2);if(parseFloat(k)>b&&(parseFloat(k)<j||j<1)){i="该商品最低折扣为 "+d+"%，即最低金额为 "+k;
e=true;}else{if(parseFloat(k)<j||j<1){e=false;}}}if(e){$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+i+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(h);}a._calSum();});$(document).on("change",".soItemCount",function(){var e=$(this).closest("tr");
var g=$(e);var b=g.find(".buyLimit").val();if(parseFloat(b)){var j=g.find(".skuId").val();var l=$("#soItemTbody").find("tr");if(l&&l.length>0){var h=0;
for(var d=0;d<l.length;d++){var f=$(l[d]);if(f.find(".skuId").val()==j){h+=parseInt(f.find(".soItemCount").val());}}if(h>parseFloat(b)){var k="该商品数量超过每单限制"+b+"个";
$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+k+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(1);}}}a._calSum();});$("#recomendProdsContainer").on("click",".addToCartBtn",function(){var d=ctx+"/img/jt/nophoto.png";
var f=e.attr("imgUrlVal");if(f){var c={url:f,name:"",id:""};d=ImageUtils.getUrl(c);}var e=$(this).parents(".skuContainer");var b={prodId:e.attr("prodIdVal"),prodName:e.find(".prodNameContainer").text(),prodPic:e.attr("imgUrlVal"),prodSrc:d,skuId:e.attr("selectedskuidval"),skuCode:e.find(".skuCodeContainer").text(),isMain:"y",maindId:"",prodPrice:e.find(".priceContainer").text().substring(1),priceType:$("#prod-price-type").val(),canSaleQty:e.find(".stockContainer").text()};
a._addSoItem(b);});$(document).on("click",".delSoProfit",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calProfitPercent();}});});$(document).on("click",".deleteSoLog",function(){var c={id:$(this).attr("idVal")};var b=$(this).parents("tr");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/ec/salesorder/soEntity/deleteSoLog.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
b.remove();}});});});$(document).on("change",".soProfitPercent",function(){var c=$(this).val();$(this).val((parseFloat(c)).toFixed(2));var b=a._calProfitPercent();
if(b<0){}});$("#recomendProdsContainer").on("click",".skuBtn",function(){if($(this).hasClass("btn-default")){$(this).siblings("button").removeClass("btn-primary").addClass("btn-default");
$(this).removeClass("btn-default").addClass("btn-primary");var e=$(this).parents(".skuContainer");var b="";e.find(".chooseSku").each(function(){$(this).find(".skuBtn").each(function(){if($(this).hasClass("btn-primary")){b+=$(this).attr("valValue")+",";
return false;}});});b=b.substring(0,b.length-1);var d=e.attr("prodIdVal");var c=ctx+"/ec/product/prodEntity/switchSku.htm?prodEntityId="+d+"&skuJson="+b+"&storeId="+$("select[name=storeId]").val();
FormUtils.loadData(c,function(f){e.prev().find("img").attr("src",ctx+f.path);e.find(".priceContainer").text("￥"+f.price);e.find(".skuCodeContainer").text(f.skuCode);
e.find(".stockContainer").text(f.canSaleQty);e.attr("imgUrlVal",f.path);e.attr("selectedSkuIdVal",f.skuId);if(f.canSaleQty<=0){e.find(".addToCartBtn").attr("disabled","disabled");
}else{e.find(".addToCartBtn").removeAttr("disabled");}});}});$("#selectSkuBtn").on("click",function(){if(isSelectStoreInShip=="n"&&($("select[name=storeId]").val()==""||$("select[name=storeId]").val()==null)){DialogUtils.error(msgCode.WARING,"请先选择仓库");
return false;}var c="product";var b="y";if(isPoint){c="point";b="n";}a.hadClose=false;SelectProdService.selectSku({storeId:$("select[name=storeId]").val(),isMultiple:1,type:c,canSale:"y",isSale:"y",userId:currentUserId,priceType:$("#prod-price-type").val(),hasStock:$("#hasStock").is(":checked")?"y":"n",limitProdCate:b,fn:function(d){for(var e=0;
e<d.length;e++){if(a.checkIsCanAddSoItem(d[e])){a._addSoItem1({prodId:d[e].prodId,prodName:d[e].prodName,prodPic:d[e].imgUrl,skuId:d[e].skuId,skuCode:d[e].skuCode,isMain:"y",maindId:"",prodPrice:d[e].price,buyLimit:d[e].buyLimit,skuPercentLimit:d[e].skuPercentLimit,canSaleQty:d[e].totalQty,priceType:d[e].priceType,});
}}}});});$(document).on("click","#selectEmpBtn",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,callBack:function(h){if(h&&h.length>0){var f=[];
for(var e=0;e<h.length;e++){if(!a._hasAssignProfit(h[e].id)){var j={id:h[e].id,aid:h[e].aid,name:h[e].name,groupName:h[e].orgName};f.push(j);}}var g={employees:f};
a._addSoProfit(g);a._calProfitPercent();}}};var c=new EmployeesSelect();c.init(d);});$("#soEntityForm").on("change","select[name=storeId]",function(){var b=$(this).val();
var d=$("input[name=realStoreId]").val();var c=$("#soItemTbody").find("tr");if(c&&c.length>0){if(d){$("select[name=storeId]").val(d);}else{$(this).find("option").eq(0).prop("selected",true);
}DialogUtils.error(msgCode.WARING,"已有订购的商品，不能改变仓库");return;}$("input[name=realStoreId]").val(b);a._prodSearch(b);a._loadRecommendProds();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=shippingAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=subAmount]",function(){a._calSum(null,null,true);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=billAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=totalAmount]",function(){var c=$(this).val();var d="总价格从"+$("#totalAmount").val()+"变成"+c;
$("input[name=priceFollowLog]").val(d);var b=$(this);a._calSum(c,b);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=cashType]",function(){var b=$(this).val();
$("input[name=subAmount]").attr("readonly",false);$("input[name=shippingAmount]").attr("readonly",false);$("input[name=totalAmount]").attr("readonly",false);
if(b=="free"){$("input[name=subAmount]").val("0.00");$("input[name=shippingAmount]").val("0.00");$("input[name=totalAmount]").val("0.00");$("input[name=waitPayAmount]").val("0.00");
$("input[name=subAmount]").attr("readonly",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
}else{if(b!="pay_sub"){$("input[name=subAmount]").val("0.00");$("input[name=subAmount]").attr("readonly",true);a._calSum();}}if($(".myCsTotalAmount").hasClass("notModify")){$(".myCsTotalAmount").attr("readonly",true);
}if($(".subCsTotalAmount").hasClass("notModify")){$(".subCsTotalAmount").attr("readonly",true);}if(b=="cod"||b=="free"){$("select[name=payType]").empty().append("<option value='cash'>现金支付</option><option value='weixinhongbao'>微信红包</option><option value='QRCode'>收款码支付</option>");
}else{$("select[name=payType]").empty().append("<option value='alipay'>支付宝</option><option value='weixin'>微信支付</option><option value='weixinhongbao'>微信红包</option><option value='bank'>银行转账</option><option value='cash'>现金支付</option><option value='QRCode'>收款码支付</option>");
}$("select[name=payType]").trigger("change");});$(document).on("change","select[name=payType]",function(){var b=$(this).val();var d=$("select[name=account]").find("option");
if(d&&d.length>0){for(var c=0;c<d.length;c++){if($(d[c]).attr("attr-type")==b){$("select[name=account]").val($(d[c]).attr("value"));break;}else{$("select[name=account]").val("");
}}}if(b=="cash"){$("select[name=account]").attr("disabled",true);}else{$("select[name=account]").attr("disabled",false);}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=billType]",function(){if($("select[name=billType]").val()=="none"){a._hideBillInfo();
$("input[name=billAmount]").val("0").trigger("change");$("input[name=billTitle]").val("");$("input[name=billContent]").val("");}else{if($("select[name=billType]").val()=="common"){a._showBillInfo();
$("input[name=billAmount]").val("0").trigger("change");}else{if($("select[name=billType]").val()=="receipt"){a._showBillInfo();$("input[name=billAmount]").val("0").trigger("change");
}else{a._showBillInfo();}}}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".addAddr",function(){var b=new ShopAddrOpt();b.init({csId:$("input[name=csId]").val(),callBack:function(e){var d=$.templates("#addrTmpl");
var c=d.render(e);$(".defaultAddr").show().after(c);$(".csAddrDiv:first").find("[name=chooseAddr]").trigger("click");$(".changeAddr").show();$(".addAddrDiv").hide();
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".editAddr",function(){var b=$(this).parents(".csAddrDiv");var c=$(this).parents(".csAddrDiv").prevAll(".defaultAddr");
var d=new ShopAddrOpt();d.init({addrId:$(this).attr("idVal"),csId:$('input[name="csId"]').val(),isCs:false,callBack:function(f){b.find(".addrName").val(f.name);
b.find(".addrMobile").val(MaskPhoneNum.getMaskPhoneNum(f.mobile));var e="";if(f.prName){e+=f.prName+",";}if(f.ciName){e+=f.ciName+",";}if(f.arName){e+=f.arName+",";
}b.find(".addrInfo").val(e+f.toName+f.addr);b.find("[name=chooseAddr]").attr("coName",f.coName);b.find("[name=chooseAddr]").attr("prName",f.prName);b.find("[name=chooseAddr]").attr("ciName",f.ciName);
b.find("[name=chooseAddr]").attr("arName",f.arName);b.find("[name=chooseAddr]").attr("addrDetail",f.addr);b.find("[name=chooseAddr]").trigger("click");
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".changeAddr",function(){if($(".csAddrDiv").is(":hidden")){$(".csAddrDiv").show();}else{$(".csAddrDiv").hide();
}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click","[name=chooseAddr]",function(){var i=$(this).parents(".csAddrDiv");var h=$(".defaultAddr");var c=$(this).val();
var e=$(this).attr("coName");var l=$(this).attr("prName");var j=$(this).attr("ciName");var g=$(this).attr("arName");var k=$(this).attr("addrDetail");var b=i.find(".addrName").val();
var f=i.find(".addrMobile").val();var d=i.find(".addrInfo").val();h.find("[name=addrId]").val(c);h.find("[name=coName]").val(e);h.find("[name=prName]").val(l);
h.find("[name=ciName]").val(j);h.find("[name=arName]").val(g);h.find("[name=addrDetail]").val(k);h.find(".addrName").val(b);h.find(".addrMobile").val(f);
h.find(".addrInfo").val(d);$(".csAddrDiv").hide();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("focus","#searchProd",function(){var b=$("select[name=storeId]").val();
if(isSelectStoreInShip=="n"&&(b==null||b=="")){DialogUtils.error(msgCode.WARING,"请先选择仓库");}});$("#hasStock").on("change",function(){a._prodSearch($("select[name=storeId]").val());
});$("#prod-price-type").on("change",function(){a._prodSearch($("select[name=storeId]").val());});$(document).on("click",".soTab",function(){var c=$(this).attr("csNameVal");
var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(SoEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,b+"的订单明细");});$(document).on("click",".prodShow",function(){var c=$(this).attr("value");
var b=$(this).attr("nameValue");var d=b;if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品["+d+"",b);
});$(document).on("click",".copyCsBtn",function(){$("#csCodeText").select();document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});$(document).on("click",".copySoBtn",function(){$("#soCodeText").select();
document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});},destroyPopover:function(a){a.popover("destroy");},_hasAssignProfit:function(d){var a=false;
var c=$(".profitEmpId");if(c&&c.length>0){for(var b=0;b<c.length;b++){if(d==$(c[b]).val()){a=true;}}}return a;},_calProfitPercent:function(){var d=$(".soProfitPercent");
var c=0;$(".soProfitPercent").css("color","black");$("#soProfitTip").empty().hide();if(d&&d.length>1){for(var b=1;b<d.length;b++){if(parseFloat($(d[b]).val())<=0){$(d[b]).css("color","red");
$("#soProfitTip").empty().append("（员工绩效分成比例必须大于0）").show();}c=parseFloat(c)+parseFloat($(d[b]).val());}}var a=(parseFloat(100)-parseFloat(c)).toFixed(2);
$(d[0]).val(a);if(a<0){$(d[0]).css("color","red");$("#soProfitTip").empty().append("（员工分成比例总和必须等于100）").show();}},_validateAmount:function(a){try{$("input[name=totalAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=subAmount]").val()),messages:{}});
if(a){$("input[name=subAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=totalAmount]").val()),max:parseFloat($("input[name=totalAmount]").val()),messages:{min:"订金需等于总金额",max:"订金需等于总金额"}});
}else{$("input[name=subAmount]").rules("add",{required:true,number:true,min:0,max:parseFloat($("input[name=totalAmount]").val()),messages:{}});}}catch(b){}},_prodSearch:function(a){if(a==undefined){a="";
}$("#searchProd").bsSuggest("destroy");if(isSelectStoreInShip=="n"&&(a==null||a=="")){return;}var b=this;var e=$("#searchProd").width()+"px";if($("#searchProd").width()<=500){e=($(".itemDiv").width()*5/6)+"px";
}var c="entity";var g=$("#hasStock").is(":checked")?"y":"n";var f=$("#prod-price-type").val();var d="y";if(isPoint){d="n";c="point";}$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+g+"&storeId="+a+"&priceType="+f+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodPic","prodName","skuCode","cateName","unit","prodTotal","skuAttr","canSaleQty"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodPic:"图片",prodName:"产品名字",skuCode:"sku编码",cateName:"产品分类",unit:"单位",prodTotal:"价格",skuAttr:"sku属性",canSaleQty:"可售数量"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(h){for(var k=0;
k<h.value.length;k++){var j="<img style='display: inline; height:35px;' ";if(h.value[k].prodPic){j=j+" src='"+ctx+h.value[k].prodPic+"'>";}else{j=j+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";
}h.value[k].prodPic=j;}b.searchProds=h.value;return h;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(i,h){}).on("onSetSelectValue",function(k,h){for(var j=0;
j<b.searchProds.length;j++){if(b.searchProds[j].skuId==h.id){b.currentProd=b.searchProds[j];break;}}if(b.checkIsCanAddSoItem(b.currentProd)){b._addSoItem(b.currentProd);
$("#searchProd").val("");}}).on("onUnsetSelectValue",function(h){b.currentProd={};});},checkIsCanAddSoItem:function(b){if(parseFloat(b.buyLimit)){var a=$("#soItemTbody").find("tr");
if(a&&a.length>0){var e=0;for(var c=0;c<a.length;c++){var d=$(a[c]);if(d.find(".skuId").val()==b.skuId){e+=parseInt(d.find(".soItemCount").val());}}if((e+1)>parseFloat(b.buyLimit)){var f=b.prodName+", 每单数量限制不能大于"+b.buyLimit+"个";
$("#soItemWarm").attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+f+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soItemWarm").popover("show");setTimeout(function(){$("#soItemWarm").popover("destroy");},3000);return false;}}return true;}else{return true;}},_addSoItem1:function(f){if(!f.prodPic){f.prodPic="";
f.prodSrc=ctx+"/img/jt/nophoto.png";}else{var c={url:f.prodPic,name:"",id:""};f.prodSrc=ImageUtils.getUrl(c);f.prodPic=ImageUtils.getUrl(c);}if(f.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(f.priceType=="special"){f.spComment="特价";}else{if(f.priceType=="gift"){f.spComment="赠品";}}}var e=f.skuPercentLimit;var g=0;if(e&&parseFloat(e)>0){g=parseFloat(e);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(g)||parseFloat(g)<1)){g=parseInt(percentLimit);}f.prodTotal=this._calProdTotal(f.prodPrice,1,g,f.originPrice);
f.originPrice=f.prodPrice;f.unit=f.unit;var d=$.templates("#soItemTmpl1");var a=d.render(f);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_addSoItem:function(e){if(e.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(e.priceType=="special"){e.spComment="特价";}else{if(e.priceType=="gift"){e.spComment="赠品";}}}var d=e.skuPercentLimit;var f=0;if(d&&parseFloat(d)>0){f=parseFloat(d);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(f)||parseFloat(f)<1)){f=parseInt(percentLimit);}e.prodTotal=this._calProdTotal(e.prodPrice,1,f,e.originPrice);
e.originPrice=e.prodPrice;e.unit=e.unit;var c=$.templates("#soItemTmpl");var a=c.render(e);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_calProdTotal:function(e,d,f,a){var c=(parseFloat(e)*parseInt(d)).toFixed(2);
var b=(parseFloat(a)*parseInt(f)/100).toFixed(2);if(autoPercent!=0){if(parseFloat(e)==parseFloat(a)){if(parseFloat(autoPercent)<f&&f!=100){c=(c*parseInt(f)/100).toFixed(2);
b=(b*parseInt(f)/100).toFixed(2);}else{c=(c*parseInt(autoPercent)/100).toFixed(2);b=(b*parseInt(autoPercent)/100).toFixed(2);}}}if(parseFloat(c)<parseFloat(b)){return b;
}return c;},_calSoItemTotal:function(){var d=0;var m=0;var e=0;var n=$("#soItemTbody").find("tr");if(n&&n.length>0){for(var h=0;h<n.length;h++){var j=$(n[h]);
var b=j.find(".prodPrice").val();var c=j.find(".soItemCount").val();var k=j.find(".originPrice").text();var g=j.find(".skuPercentLimit").val();var l=j.find(".priceType").val();
var a=0;if(g&&parseFloat(g)>0){a=parseFloat(g);}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(a)||parseFloat(a)<1)){a=parseInt(percentLimit);
}var f=this._calProdTotal(b,c,a,k);j.find(".prodTotal").text(f);d=parseInt(d)+parseInt(c);m=(parseFloat(m)+parseFloat(f)).toFixed(2);e=(parseFloat(k)*parseInt(c)+parseFloat(e)).toFixed(2);
}}$("#itemCountTotal").text(d);$("#prodPriceTotal").text(m);$("#itemOriginCount").text(e);},_averageTotal:function(a,n,l){var m=this;var f=$("#soItemTbody").find("tr");
var p=[];if(f&&f.length>0){var r=0;var d=0;for(var s=0;s<f.length;s++){var u=$(f[s]);var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var e=u.find(".soItemCount").val();
d+=parseInt(e);var k=u.find(".originPrice").text();var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<b||b<1)){b=parseInt(percentLimit);
}if(t||parseInt(percentLimit)){r+=parseFloat(k)*(b/100).toFixed(2)*parseInt(e);}else{if(!t&&!parseInt(percentLimit)){}else{r+=parseFloat(k)*parseInt(e);
}}p.push(b);}var g=0;for(var q=0;q<p.length;q++){if(p[q]>parseFloat(a)*100){g++;}}if(g==f.length||(g>0&&g<f.length&&n<r)||(n<r)){var h="修改的总金额小于所有商品最低折扣，最低商品金额为 "+r;
l.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");setTimeout(function(){m.destroyPopover(l);},3000);return false;}if(g==0){for(var s=0;s<f.length;
s++){var u=$(f[s]);var k=u.find(".originPrice").text();var o=parseFloat(parseFloat(k)*parseFloat(a)).toFixed(2);u.find(".prodPrice").val(parseFloat(o));
}this._calSoItemTotal();return true;}if((g>0&&g<f.length)){var c=parseFloat((parseFloat(n)-r)/d).toFixed(2);for(var s=0;s<f.length;s++){var u=$(f[s]);var k=u.find(".originPrice").text();
var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&parseInt(percentLimit)<b||b<1){b=parseInt(percentLimit);
}var o=0;if(t||parseInt(percentLimit)){o=parseFloat(parseFloat(k)*b/100+parseFloat(c)).toFixed(2);}else{o=parseFloat(parseFloat(k)+parseFloat(c)).toFixed(2);
}u.find(".prodPrice").val(o);}this._calSoItemTotal();return true;}}},_calSum:function(n,j,l){var k=this;var p=false;if(isOpenTotalLinkSale&&isOpenTotalLinkSale=="y"){p=true;
}var o=false;if(n){o=true;}k._calSoItemTotal();var r=$("#prodPriceTotal").text();var d=$("#itemOriginCount").text();var i=$("[name=shippingAmount]").val();
var e=$("[name=billAmount]").val();var q=$("[name=cashType]").val();var c=$("[name=cashBenefit]").val();if("free"==q){n=0;}if(o&&p){var m=parseFloat(parseFloat(n)-parseFloat(i)-parseFloat(e)).toFixed(2);
var a=parseFloat(m/parseFloat(d));if(!this._averageTotal(a,m,j)){this._calSum();return;}}if(!n&&n!=0){n=(parseFloat(r)+parseFloat(i)+parseFloat(e)).toFixed(2);
}if(c){n=(parseFloat(n)-parseFloat(c)).toFixed(2);}if(percentLimit&&o&&p){var b=$("#itemOriginCount").text();var f=(parseFloat(b)*(parseInt(percentLimit)/100)+parseFloat(i)+parseFloat(e)).toFixed(2);
if(c){f=(parseFloat(f)-parseFloat(c)).toFixed(2);}if(parseFloat(f)>parseFloat(n)){var h="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+f;j.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");n=f;setTimeout(function(){k.destroyPopover(j);},3000);}}if(!l){$("[name=totalAmount]").val(n);
}k._calWaitPayAmount();var g=false;if("cod"==$("select[name=cashType]").val()&&"shipping"==$("input[name=status]").val()){g=true;}k._validateAmount(g);
},_calWaitPayAmount:function(){var c=0;var d=$("[name=totalAmount]").val();var a=$("[name=subAmount]").val();var b=$("select[name=cashType]").val();if("pay_sub"==b||"cod"==b){c=(parseFloat(d)-parseFloat(a)).toFixed(2);
}else{var e=$("input[name=payedAmount]").val();c=(parseFloat(d)-parseFloat(e)).toFixed(2);}$("[name=waitPayAmount]").val(c);},_addSoProfit:function(b){var c=$.templates("#soProfitTmpl");
var a=c.render(b);$("#soProfitTbody").append(a);},_addSoLog:function(b){var c={};c.employeeAid=currentUserAid;c.employeeName=currentUserName;c.srcType="option_sys";
c.type="task";c.result="跟进成功";c.createTime=DateUtils.format(new Date(),DateUtils._CONS_.DEFAULT_DATE_TIME_PATTERN);c.comment=b.content;var d=$.templates("#soLogTmpl");
var a=d.render(c);$("#soLogTbody").prepend(a);},_showBillInfo:function(){$(".billAmountDiv").show();$(".billTitleDiv").show();$(".billContentDiv").show();
},_hideBillInfo:function(){$(".billAmountDiv").hide();$(".billTitleDiv").hide();$(".billContentDiv").hide();},_bindFormValidation:function(){var a=this;
var b={rules:{shippingAmount:{required:true,number:true,min:0},subAmount:{number:true,min:0},billAmount:{number:true,min:0},totalAmount:{required:true,number:true,min:0},},messages:{}};
FormUtils.bindFormValidation(SoEntityBase._CONS_.EDIT_FORM_ID,b);a._validateAmount();},_initSoItemPic:function(){var a=$(".soItemPic");if(a&&a.length>0){for(var c=0;
c<a.length;c++){var d=$(a[c]).attr("urlVal");if(d){var b={url:d,name:"",id:""};var e=ImageUtils.getUrl(b);$(a[c]).attr("src",e);}else{$(a[c]).attr("src",ctx+"/img/jt/nophoto.png");
}}}}};