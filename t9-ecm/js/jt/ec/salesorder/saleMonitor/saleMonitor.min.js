$(function(){var a=new SaleMonitor();a.init();});function SaleMonitor(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}SaleMonitor._CONS_={};
SaleMonitor.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=this;$("#autoRefresh").hide();$("#oneRefresh").hide();$("#twoRefresh").hide();
this._bindEventHander();this._initTable(a._toBuildParams());this._locateToGlHelp();}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.operations.saleMonitor");
},_toBuildParams:function(){var b=new Array();$('input[name="saleStatusColor"]:checked').each(function(){b.push($(this).val());});var a=b.join(",");var d=$("input[name='order']:checked").val();
var c={groupKey:$("input[name='belongOgn']").val(),employeeId:$("select[name='belongEmployee']").val(),timeSearch:$("select[name='timeSearch']").val(),orderBy:d,checkboxValues:a};
return c;},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString());
}}});},_bindEventHander:function(){var a=this;$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",isEqWidth:true,isAutoHeight:true,fn:function(c,d){$("input[name=belongOgn]").val(d);
a._buildEmployeeSelect(c);}};GroupUtils.selectGroupTreeBox(b);});$("#searchBtn").on("click",function(){var b=a._toBuildParams();if(b.checkboxValues==""){DialogUtils.error("提示：","最少选择一种颜色状态！");
}else{a._initTable(b);}});$("body").on("click",".csDetailTab",function(){var c=$(".csDetailTab").attr("cs_name");var b=$(this).attr("value");if(c.length>4){c="*"+c.substring(c.length-3,c.length);
}JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detail.htm?csId="+b,"客户["+c+"]明细");});$("body").on("click",".soDetailTab",function(){var c=$(".csDetailTab").attr("cs_name");
var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/detail.htm?soNo="+b,c+"的订单明细");});$("body").on("click",".openSaleStatusLayer",function(){var d=$(this).attr("employeeName");
var c=$(this).attr("employeeId");var b=$(this).attr("aid");$("#saleMonitorContainer").modal("show");a._loadMyTalkTime(b);a._initLayoutTable(b);$("#myModalLabel").text("【"+d+":"+b+"】的当日销售情况");
});},getTitleDiv:function(c){var b=this;if(!c){return c;}var d=new StringBuffer();var a=c.split(">");$.each(a,function(f,g){d.append("<div class='crumb-title-unit'>"+this+"</div>");
});return d.toString();},getColorType:function(b){var a=this;if(b=="green"){return" sale-status-green";}else{if(b=="yellow"){return" sale-status-yellow";
}else{if(b=="red"){return" sale-status-red";}else{if(b=="gray"){return" sale-status-gray";}}}}},_initTable:function(b){var a=this;FormUtils.submit(ctx+"/ec/salesorder/saleMonitor/findEmpSaleStatus.htm?params="+$.param(b),b,function(d){if(d.success){var c=d.msg;
var g=$.parseJSON(c);if(g){var l=new StringBuffer();for(var f=0;f<g.length;f++){var h=g[f].employeeSaleMonitorVos;if(h.length==0){continue;}l.append("<div class='col-sm-12' style='padding-top: 20px;'>");
l.append("<div class='panel-title canShowGroupName'><div class='crumb-title-layer'>"+a.getTitleDiv(g[f].crumbStr)+"</div></div>");l.append("<div class='panel-body'>");
l.append("<table class='table table-stripped saleMonitoringTable' border='2' bordercolor='gray' cellspacing='0' cellpadding='5'>");var k=false;for(var e=1;
e<=h.length;e++){if(e==1||e%6==1){l.append("<tr style='height: 60px;'> ");l.append("<td style='text-align: center;width: 10%;height: 60px'>销售状态</td>");
k=true;}if(e==1||e%6==0||e%6>1||k==true){l.append("<td align='center' rowspan='2'>");l.append("<a class='openSaleStatusLayer' aid='"+h[e-1].aid+"' employeeId='"+h[e-1].employeeId+"' employeeName='"+h[e-1].employeeName+"' >");
l.append("<div class='sale-status-layer"+a.getColorType(h[e-1].colorType)+"'>");l.append("<div class='sale-img-layer'>");l.append("<img onerror='onImageError()' class='jt-employee-img' src='"+ctx+""+h[e-1].profile+"'>");
l.append("</div>");l.append("</div>");l.append("</a><br/>");l.append("<div style='margin-top: 5px'><span>"+h[e-1].aid+" : "+h[e-1].employeeName+"</span><br/></div>");
l.append("<div style='margin-top: 5px'><span style='font-weight:bold;'>"+h[e-1].saleCount+" /&nbsp;<em class='jt-achieve-money'>￥</em>&nbsp;"+h[e-1].saleMoney+"</span></div>");
l.append("</td>");}if(e%6==0||e==h.length){l.append("</tr>");l.append("<tr><td style='text-align: center;width: 10%;height: 20px'>业绩情况(单数/金额)</td></tr>");
}}l.append("</table></div></div>");}$("#saleMonitorTable").empty().append(l.toString());$(".openSaleStatusLayer").find(".jt-employee-img").each(function(j,m){$(this).load(function(){$(this).attr("style",imgStyle($(this)[0].naturalWidth,$(this)[0].naturalHeight,60));
});});}}else{DialogUtils.error("错误",d.msg);}});},_loadMyTalkTime:function(b){var a=this;FormUtils.loadData(ctx+"/gl/cti/tRKSheetRecord/loadMyTalkTime.htm?aid="+b,function(h){if(h){var g=h.totalTimeLength;
var f=h.validTimeLength;var e=h.validCount;var d=a._formatSeconds(g);var c=a._formatSeconds(f);$("#talkTime").text(d);$("#effectiveTalkTime").text(c);$("#effectiveTalkTimeNum").text(e+"次");
}});},_formatSeconds:function(d){var b=0;var c=0;if(d>60){b=parseInt(d/60);d=parseInt(d%60);if(b>60){c=parseInt(b/60);b=parseInt(b%60);}}var a=""+parseInt(d)+"秒";
if(b>0){a=""+parseInt(b)+"分"+a;}if(c>0){a=""+parseInt(c)+"小时"+a;}return a;},_initLayoutTable:function(c){var a=this;var d=new StringBuffer();d.append("<table class='table table-bordered table-stripped table-width' id='saleOrderTable'>");
d.append("<thead><tr>");d.append("<th width='2%'>序号</th>");d.append("<th width='6%'>订单编号</th>");d.append("<th width='5%'>客户编号</th>");d.append("<th width='4%'>订单状态</th>");
d.append("<th width='6%'>订单金额</th>");d.append("<th width='6%'>业绩分成</th>");d.append("<th width='6%'>业绩金额</th>");d.append("</tr></thead>");d.append("<tfoot>");
d.append("<tr style='color:red;'>");d.append("<td colspan='6'>");d.append("<span style='padding-left:0px;'>业绩总金额(合计)：</span>");d.append("<span id='totalAmountsum'></span>");
d.append("</td></tr>");d.append("</tfoot>");d.append("</table>");$("#saleOrderDiv").empty().append(d.toString());var b=ctx+"/ec/salesorder/soEntity/findByEmpIdAndTime.htm?aid="+c;
$("#saleOrderTable").DataTable({ajax:{url:b},columns:[{data:"lineNum"},{data:"soNo",render:function(g,f,e){if(g!=null&&g!=""){return"<a href='#' class='soDetailTab' value='"+g+"' attr-id='"+e.id+"'>"+g+"</a>";
}return g;}},{data:"csNo",render:function(g,f,e){if(g!=null&&g!=""){return"<a href='#' class='csDetailTab' cs_name='"+e.csName+"' value='"+e.csId+"' attr-id='"+e.id+"'>"+g+" : "+e.csName+"</a>";
}return g;}},{data:"type",render:function(g,f,e){if(g=="awaiting_pay"){return"待支付";}if(g=="confirm"){return"已审核";}if(g=="shipping"){return"已发货";}if(g=="complete"){return"已签收";
}if(g=="close_reject"){return"已拒收";}if(g=="close_lost"){return"已丢失";}if(g=="close"){return"已关闭";}else{return g;}}},{data:"totalAmount",render:function(g,f,e){return g.substring(0,g.length-2);
}},{data:"profits"},{data:"profitAmount",render:function(g,f,e){return g.substring(0,g.length-2);}},],rowId:"id",lengthMenu:[[20],],fnRowCallback:function(h,g,f,e){if(f==0){total=0;
}total+=parseFloat(g["profitAmount"]);$("#totalAmountsum").html(total.toFixed(2)+"(元)");return h;},scrollY:"125px",paging:false,pagingType:"simple",lengthChange:false,info:false,autoWidth:false,ordering:false,searching:false,scroller:{loadingIndicator:true},order:[[1,"asc"]]});
},};function imgStyle(b,c,a){if(b>c){return"height:100% !important;left:-"+(a*(1-(c/b)))/2+"px;width:auto !important;";}else{if(b==c){return null;}else{if(b<c){return"top:-"+(a*(1-(b/c)))/2+"px;";
}}}}