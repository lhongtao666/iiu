function SoLog(){this.hadInit=false;this.isEdit=false;this.soLogRowid=0;}SoLog._CONS_={GRID:"#soLogGrid",GRID_ID:"soLogGrid",DIV_ID:".soLogDiv",PAGER:"#soLogPager",PAGER_ID:"soLogPager",JSON_ID:"soLogJSON",};
SoLog.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a._initJqgrid(b);},_bindEventHander:function(){var a=this;
},_initJqgrid:function(c){var a=this;var b=[];if(c){if(typeof c.data!=undefined&&c.data!=null&&c.data.length){b=c.data;}}$(SoLog._CONS_.DIV_ID).empty().append('<table id="'+SoLog._CONS_.GRID_ID+'"></table>                         <div id="'+SoLog._CONS_.PAGER_ID+'"></div>                         <input type="hidden"  name="'+SoLog._CONS_.JSON_ID+'"  id="'+SoLog._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoLog._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:b,autowidth:true,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["所属订单 ID","操作者 ID","操作者类型 ","操作者","流水来源","操作类型","操作结果","操作时间","备注","订单前状态","当前状态","支付前状态","当前支付状态"],colModel:[{name:"soId",editable:true,width:120,hidedlg:true,hidden:true},{name:"partyId",editable:true,width:120,hidedlg:true,hidden:true},{name:"partyTypeKey",editable:true,width:120,hidedlg:true,hidden:true},{name:"name",editable:true,width:120,formatter:function(d,e,f){return f.name+":"+f.employeeAid;
}},{name:"srcType",editable:true,width:100,formatter:function(d,f,g){var e=g.srcType;if(g.srcType=="flow_sys"){e="订单状态变动生成";}else{if(g.srcType=="option_sys"){e="其他操作生成";
}else{if(g.srcType=="manual"){e="人工";}}}return e;}},{name:"type",editable:true,width:90,formatter:function(d,f,g){var e=g.type;if(g.type=="add"){e="创建";
}else{if(g.type=="edit"){e="修改";}else{if(g.type=="paid_up"){e="已支付";}else{if(g.type=="submit"){e="提交";}else{if(g.type=="pay"){e="支付确认";}else{if(g.type=="comfirm"){e="审核";
}else{if(g.type=="pack"){e="备货";}else{if(g.type=="deliver"){e="打包";}else{if(g.type=="shipping"){e="发货";}else{if(g.type=="back_deliver"){e="撤销发货";}else{if(g.type=="shipped"){e="订单跟进";
}else{if(g.type=="back_complete"){e="撤销完成";}else{if(g.type=="turndown"){e="驳回";}else{if(g.type=="close"){e="关闭";}else{if(g.type=="back"){e="退回处理";}else{if(g.type=="awaiting_refund"){e="退款申请";
}else{if(g.type=="refund"){e="退款完成";}else{if(g.type=="lock"){e="锁定";}else{if(g.type=="unlock"){e="解锁";}else{if(g.type=="other_oper"){e="其他操作";}else{if(g.type=="remark"){e="人工备注";
}else{if(g.type=="task"){e="跟进";}}}}}}}}}}}}}}}}}}}}}}return e;}},{name:"result",editable:true,width:170},{name:"createTime",editable:true,width:100},{name:"comment",editable:true,width:220},{name:"preStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.preStatus;
if(g.preStatus=="awaiting_pay"){e="等待支付";}else{if(g.preStatus=="awaiting_post"){e="待提交";}else{if(g.preStatus=="paid_up"){e="已支付";}else{if(g.preStatus=="awaiting_comfirm"){e="待审核";
}else{if(g.preStatus=="lock"){e="锁定";}else{if(g.preStatus=="comfirm"){e="已审核";}else{if(g.preStatus=="packing"){e="待备货";}else{if(g.preStatus=="deliver"){e="待发货";
}else{if(g.preStatus=="shipping"){e="已发货";}else{if(g.preStatus=="shipped"){e="已签收";}else{if(g.preStatus=="complete"){e="已签收";}else{if(g.preStatus=="close"){e="订单关闭";
}else{if(g.preStatus=="back"){e="待退回";}else{if(g.preStatus=="awaiting_refund"){e="申请退款";}else{if(g.preStatus=="refund"){e="已退款";}else{if(g.preStatus=="reject"){e="拒收";
}else{if(g.preStatus=="close_repeat"){e="订单结束（需重发）";}else{if(g.preStatus=="close_lost"){e="包裹丢失";}}}}}}}}}}}}}}}}}}return e;}},{name:"curStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.curStatus;
if(g.curStatus=="awaiting_pay"){e="等待支付";}else{if(g.curStatus=="awaiting_post"){e="待提交";}else{if(g.curStatus=="paid_up"){e="已支付";}else{if(g.curStatus=="awaiting_comfirm"){e="待审核";
}else{if(g.curStatus=="lock"){e="锁定";}else{if(g.curStatus=="comfirm"){e="待发货";}else{if(g.curStatus=="packing"){e="待备货";}else{if(g.curStatus=="deliver"){e="待发货";
}else{if(g.curStatus=="shipping"){e="已发货";}else{if(g.curStatus=="shipped"){e="已签收";}else{if(g.curStatus=="complete"){e="已签收";}else{if(g.curStatus=="close"){e="订单作废";
}else{if(g.curStatus=="back"){e="待退回";}else{if(g.curStatus=="awaiting_refund"){e="申请退款";}else{if(g.curStatus=="refund"){e="已退款";}else{if(g.curStatus=="reject"){e="拒收";
}else{if(g.curStatus=="close_repeat"){e="订单结束（需重发）";}else{if(g.curStatus=="close_lost"){e="包裹丢失";}}}}}}}}}}}}}}}}}}return e;}},{name:"prePayStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.prePayStatus;
if(g.prePayStatus=="unpaid"){e="未支付";}else{if(g.prePayStatus=="partial"){e="部分支付";}else{if(g.prePayStatus=="paid_off"){e="已支付";}}}}},{name:"curPayStatus",editable:true,width:120,hidedlg:true,hidden:true,formatter:function(d,f,g){var e=g.curPayStatus;
if(g.curPayStatus=="unpaid"){e="未支付";}else{if(g.curPayStatus=="partial"){e="部分支付";}else{if(g.curPayStatus=="paid_off"){e="已支付";}}}return e;}}],pager:SoLog._CONS_.PAGER,hidegrid:false,});
},addSoLog2Grid:function(c){var a=this;if(a.validateSoLogGrid()){var b={soId:$("input[name=soLog_soId").val(),partyId:$("input[name=soLog_partyId").val(),partyTypeKey:$("input[name=soLog_partyTypeKey").val(),name:$("input[name=soLog_name").val(),srcType:$("input[name=soLog_srcType").val(),comment:$("input[name=soLog_comment").val(),preStatus:$("input[name=soLog_preStatus").val(),curStatus:$("input[name=soLog_curStatus").val(),prePayStatus:$("input[name=soLog_prePayStatus").val(),curPayStatus:$("input[name=soLog_curPayStatus").val(),createTime:$("input[name=soLog_createTime").val()};
$("#"+c).jqGrid("addRowData","tmp@soLog"+a.soLogRowid,b,"last");a.soLogRowid++;}},};function SoShip(){this.hadInit=false;this.isEdit=false;this.soShipRowid=0;
if(typeof SoShip._initialized=="undefined"){SoShip._initialized=true;SoShip.prototype.init=function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();
a._initJqgrid(b);}};SoShip.prototype._bindEventHander=function(){var a=this;$(document).on("click","#soShipButtonId",function(){a.addSoShip2Grid("soShipGrid");
});$(document).on("click","#soShipSaveButton",function(){a.editSoShip2Grid("soShipGrid");});$(document).on("click","#soShipRestButtonId",function(){});
};SoShip.prototype._initJqgrid=function(d){var b=this;$.jgrid.defaults.styleUI="Bootstrap";$(SoShip.GRID).jqGrid({datatype:"json",url:ctx+"/ec/ec/salesorder/soEntity/soShipListData.htm",height:350,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",viewrecords:true,multiselect:true,rowList:[10,20,30],rownumbers:true,colNames:["所属订单 ID","发货单类型。ship=发货；","收货地址快照 ID","快递公司名称","快递公司编码","快递公司物流单号","API - 物流状态。即第三方快递API的返回状态","API - 返回数据","API - 上次调用时间","API - 签收时间","API - 退回时间","实付物流运费","是否需代收货款","代收货款金额","商品损毁类型。lost=丢失；break=损坏（拒收，需退回）","物流赔偿金额","创建时间","更新时间","操作"],colModel:[{name:"soId",editable:true,width:120},{name:"type",edittype:"select",editoptions:{value:"1:选项 1;2:选项 2;3:选项 3;4:选项 4"},editable:false,width:120,formatter:function(e,f,g){if(g.type=="1"){return"选项 1";
}else{if(g.type=="2"){return"选项 2";}else{if(g.type=="3"){return"选项 3";}else{if(g.type=="4"){return"选项 3";}else{if(g.type==undefined){if(e=="1"){return"选项 1";
}else{if(e=="2"){return"选项 2";}else{if(e=="3"){return"选项 3";}else{if(e=="4"){return"选项 4";}}}}}}}}}return g.type;}},{name:"addrId",editable:true,width:120},{name:"scName",editable:true,width:120},{name:"scCode",editable:true,width:120},{name:"scTrackingNo",editable:true,width:120},{name:"apiStatus",editable:true,width:120},{name:"apiReturnData",editable:true,width:120},{name:"apiRevokeTime",editable:true,width:120},{name:"apiReceiveTime",editable:true,width:120},{name:"apiReturnTime",editable:true,width:120},{name:"actualAmount",editable:true,width:120},{name:"isProxy",edittype:"select",editoptions:{value:"n:否;y:是"},editable:false,width:120,formatter:function(e,f,g){if(g.isProxy=="n"){return"否";
}else{if(g.isProxy=="y"){return"是";}else{if(g.isProxy==undefined){if(e=="n"){return"否";}else{if(e=="y"){return"是";}}}}}return g.isProxy;}},{name:"proxyAmount",editable:true,width:120},{name:"breakType",editable:true,width:120},{name:"breakAmount",editable:true,width:120},{name:"createTime",editable:true,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:true,hidedlg:true,hidden:true,width:120},{name:"button",width:120}],pager:SoShip.PAGER,hidegrid:false,gridComplete:function(){addRowButtons("soShipGrid",true,b.soShipOperFunc);
},ondblClickRow:function(g,j,f,i){var h=$("#soShipGrid").jqGrid("getRowData",g);b.showSoShip(g,h);}});function a(){soShipRowid=addRow("soShipGrid",b.soShipRowid);
}function c(e){DialogUtils.confirm(function(){delRows("soShipGrid",e);});}$(SoShip.GRID).jqGrid("navGrid",SoShip.PAGER,{add:false,del:true,deltitle:"删除",delfunc:c,refresh:false,search:false,edit:false});
$(window).bind("resize",function(){var e=$(".jqGrid_wrapper").width();$(SoShip.GRID).setGridWidth(e);});};SoShip.prototype.soShipGridData2Json=function(){var b=$("#soShipGrid");
var a=new StringBuffer();a.append("[");var f=b.jqGrid("getDataIDs");for(var c=0;c<f.length;c++){var g=b.jqGrid("getRowData",f[c]);if(g["isGridRowEdit"]=="Y"){alert("有参数尚未保存，请选择保存或者取消变更!");
getElementById(f[c]).focus();return false;}a.append("{");a.append("'soId':'").append(g["soId"]).append("',");var d="";if(g["type"]=="选项 1"){d="1";}else{if(g["type"]=="选项 2"){d="2";
}else{if(g["type"]=="选项 3"){d="3";}else{if(g["type"]=="选项 4"){d="4";}}}}a.append("'type':'").append(d).append("',");a.append("'addrId':'").append(g["addrId"]).append("',");
a.append("'scName':'").append(g["scName"]).append("',");a.append("'scCode':'").append(g["scCode"]).append("',");a.append("'scTrackingNo':'").append(g["scTrackingNo"]).append("',");
a.append("'apiStatus':'").append(g["apiStatus"]).append("',");a.append("'apiReturnData':'").append(g["apiReturnData"]).append("',");a.append("'apiRevokeTime':'").append(g["apiRevokeTime"]).append("',");
a.append("'apiReceiveTime':'").append(g["apiReceiveTime"]).append("',");a.append("'apiReturnTime':'").append(g["apiReturnTime"]).append("',");a.append("'actualAmount':'").append(g["actualAmount"]).append("',");
var e="";if(g["isProxy"]=="否"){e="n";}else{if(g["isProxy"]=="是"){e="y";}}a.append("'isProxy':'").append(e).append("',");a.append("'proxyAmount':'").append(g["proxyAmount"]).append("',");
a.append("'breakType':'").append(g["breakType"]).append("',");a.append("'breakAmount':'").append(g["breakAmount"]).append("',");a.append("'createTime':'").append(g["createTime"]).append("',");
a.append("'updateTime':'").append(g["updateTime"]).append("',");if(!f[c].startsWith("tmp@")){a.append("'id':'").append(f[c]).append("'");}a.append("},");
}var h=""+a;if(f.length>0){h=h.substring(0,h.length-1);}h=h+"]";$("#soShipJSON").val(h);return true;};SoShip.prototype.soShipOperFunc=function(b,a){return b;
};SoShip.prototype.showSoShip=function(e,f){var d=document.getElementById("soShipDetailDiv");if(d.style.display=="none"){$("#soShipBut").click();}$("#soShipSaveButton").removeClass("free_shrink_save_button");
$("input[name=soShipEditRowId]").val(e);$("input[name=soShip_soId]").val(f["soId"]);var b="";if(f["type"]=="选项 1"){b="1";}else{if(f["type"]=="选项 2"){b="2";
}else{if(f["type"]=="选项 3"){b="3";}else{if(f["type"]=="选项 4"){b="4";}}}}var g=document.getElementById("soShip_type").options;for(var a=0;a<g.length;a++){if(g[a].value==b){g[a].selected=true;
break;}}$("input[name=soShip_addrId]").val(f["addrId"]);$("input[name=soShip_scName]").val(f["scName"]);$("input[name=soShip_scCode]").val(f["scCode"]);
$("input[name=soShip_scTrackingNo]").val(f["scTrackingNo"]);$("input[name=soShip_apiStatus]").val(f["apiStatus"]);$("input[name=soShip_apiReturnData]").val(f["apiReturnData"]);
$("input[name=soShip_apiRevokeTime]").val(f["apiRevokeTime"]);$("input[name=soShip_apiReceiveTime]").val(f["apiReceiveTime"]);$("input[name=soShip_apiReturnTime]").val(f["apiReturnTime"]);
$("input[name=soShip_actualAmount]").val(f["actualAmount"]);var c="";if(f["isProxy"]=="否"){c="n";}else{if(f["isProxy"]=="是"){c="y";}}var h=document.getElementById("soShip_isProxy").options;
for(var a=0;a<h.length;a++){if(h[a].value==c){h[a].selected=true;break;}}$("input[name=soShip_proxyAmount]").val(f["proxyAmount"]);$("input[name=soShip_breakType]").val(f["breakType"]);
$("input[name=soShip_breakAmount]").val(f["breakAmount"]);$("input[name=soShip_createTime]").val(f["createTime"]);$("input[name=soShip_updateTime]").val(f["updateTime"]);
};SoShip.prototype.addSoShip2Grid=function(c){var a=this;if(a.validateSoShipGrid()){var b={soId:$("input[name=soShip_soId").val(),type:JTOtherUtils.getcheckValue("soShip_type"),addrId:$("input[name=soShip_addrId").val(),scName:$("input[name=soShip_scName").val(),scCode:$("input[name=soShip_scCode").val(),scTrackingNo:$("input[name=soShip_scTrackingNo").val(),apiStatus:$("input[name=soShip_apiStatus").val(),apiReturnData:$("input[name=soShip_apiReturnData").val(),apiRevokeTime:$("input[name=soShip_apiRevokeTime").val(),apiReceiveTime:$("input[name=soShip_apiReceiveTime").val(),apiReturnTime:$("input[name=soShip_apiReturnTime").val(),actualAmount:$("input[name=soShip_actualAmount").val(),isProxy:JTOtherUtils.getcheckValue("soShip_isProxy"),proxyAmount:$("input[name=soShip_proxyAmount").val(),breakType:$("input[name=soShip_breakType").val(),breakAmount:$("input[name=soShip_breakAmount").val(),createTime:$("input[name=soShip_createTime").val(),updateTime:$("input[name=soShip_updateTime").val()};
$("#"+c).jqGrid("addRowData","tmp@soShip"+a.soShipRowid,b,"last");a.soShipRowid++;}};SoShip.prototype.editSoShip2Grid=function(c){var a=this;if(a.validateSoShipGrid()){var b={soId:$("input[name=soShip_soId").val(),type:JTOtherUtils.getcheckValue("soShip_type"),addrId:$("input[name=soShip_addrId").val(),scName:$("input[name=soShip_scName").val(),scCode:$("input[name=soShip_scCode").val(),scTrackingNo:$("input[name=soShip_scTrackingNo").val(),apiStatus:$("input[name=soShip_apiStatus").val(),apiReturnData:$("input[name=soShip_apiReturnData").val(),apiRevokeTime:$("input[name=soShip_apiRevokeTime").val(),apiReceiveTime:$("input[name=soShip_apiReceiveTime").val(),apiReturnTime:$("input[name=soShip_apiReturnTime").val(),actualAmount:$("input[name=soShip_actualAmount").val(),isProxy:JTOtherUtils.getcheckValue("soShip_isProxy"),proxyAmount:$("input[name=soShip_proxyAmount").val(),breakType:$("input[name=soShip_breakType").val(),breakAmount:$("input[name=soShip_breakAmount").val(),createTime:$("input[name=soShip_createTime").val(),updateTime:$("input[name=soShip_updateTime").val()};
$("#"+c).jqGrid("setRowData",$("#soShipEditRowId").val(),b);}};SoShip.prototype.addSoShipValidate=function(){};SoShip.prototype.removeSoShipValidate=function(){};
SoShip.prototype.validateSoShipGrid=function(b,a){var c=$("#soShipForm").validate();return true;};SoShip.prototype.reloadJqgrid=function(g){var c=this;
var f={};if(g&&jQuery.type(g)=="string"){g=decodeURIComponent(g,true);var b=g.split("&");if(b.length){for(var d=0;d<b.length;d++){var e=b[d].split("=");
if(e.length==2&&e[1]){f[e[0]]=e[1];}}}}else{f=g;}var a=$(SoShip.GRID).jqGrid("getGridParam","postData");$.extend(a,f);$(SoShip.GRID).jqGrid("setGridParam",{search:true}).trigger("reloadGrid",[{page:1}]);
};}}SoShip.GRID="#soShipGrid";SoShip.PAGER="#soShipPager";function SoItem(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.otherFunc=null;
this.soItemRowid=0;this.isPoint=false;this.csPercent=100;this.canEditPrice=false;}SoItem._CONS_={GRID:"#soItemGrid",GRID_ID:"soItemGrid",DIV_ID:"soItemDiv",PAGER:"#soItemPager",PAGER_ID:"soItemPager",JSON_ID:"soItemJSON",CS_LEVEL_URL:ctx+"/ec/salesorder/soEntity/getCsLevel.htm",};
SoItem.prototype={init:function(b){var a=this;if(b){a.otherFunc=b.otherFunc;if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;}if(b.csId!=undefined){this._getCsPre(b.csId);
}if(b.canEditPrice!=undefined){this.canEditPrice=b.canEditPrice;}}if(a.isPoint){a._initPointJqgrid(b);}else{a._initJqgrid(b);}if(!a.hadInit){a.hadInit=true;
a._bindEventHander();}},_getCsPre:function(b){var a=this;FormUtils.loadData(SoItem._CONS_.CS_LEVEL_URL+"?csId="+b,function(c){if(c!=null){a.csPercent=parseInt(c);
}});},_bindEventHander:function(){var a=this;$(document).on("click",".prodShow",function(){var c=$(this).attr("value"),b=d=$(this).attr("nameValue"),d;
if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品【"+d+"】",b);});$(document).on("click","#soItemButtonId",function(){a.addSoItem2Grid("soItemGrid");
});$(document).on("click","#soItemSaveButton",function(){a.editSoItem2Grid("soItemGrid");});$(document).on("click",".delSoItem",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){$(SoItem._CONS_.GRID).delRowData(b);}});});$(document).on("change","input[name=countShow]",function(){var h=$(this).parent().parent().attr("id");
var f=$(this).val();if(a.isPoint){var b=a.calMaxExchangeCount(h);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");f=b;$(this).val(f);}}$(SoItem._CONS_.GRID).setCell(h,"count",f);var g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(h,"spDiscout")).toFixed(2);
if($(SoItem._CONS_.GRID).getCell(h,"priceType")=="common"){g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*a.csPercent/100).toFixed(2);var c=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);
$(SoItem._CONS_.GRID).setCell(h,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(h,"spDiscoutShow",c);}$(SoItem._CONS_.GRID).setCell(h,"totalAmount",g);var e=a.footerData();
if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=salesPriceShow]",function(){var i=$(this).parent().parent().attr("id");var g=$(this).val();
var f=$("input[name=countShow]").val();if(a.isPoint){var b=a.calMaxExchangeCount(i);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");var f=b;$("input[name=countShow]").val(f);$(SoItem._CONS_.GRID).setCell(i,"count",f);}}$(SoItem._CONS_.GRID).setCell(i,"salesPrice",g);
var h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(i,"spDiscout")).toFixed(2);if($(SoItem._CONS_.GRID).getCell(i,"priceType")=="common"){h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*a.csPercent/100).toFixed(2);
var c=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);$(SoItem._CONS_.GRID).setCell(i,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(i,"spDiscoutShow",c);
}$(SoItem._CONS_.GRID).setCell(i,"totalAmount",h);var e=a.footerData();if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=spDiscoutShow]",function(){var d=$(this).parent().parent().attr("id");
var e="0";if(!(isNaN($(this).val())||$(this).val()=="")){e=parseFloat($(this).val()).toFixed(2);$(this).val(e);}$(SoItem._CONS_.GRID).setCell(d,"spDiscout",e);
var c=$(SoItem._CONS_.GRID).getCell(d,"salesPrice")*$(SoItem._CONS_.GRID).getCell(d,"count")-e;$(SoItem._CONS_.GRID).setCell(d,"totalAmount",c);var b=a.footerData();
if(a.otherFunc!=null){a.otherFunc(b);}});$(document).on("change","input[name=spCommentShow]",function(){var c=$(this).parent().parent().attr("id");var b=$(this).val();
$(SoItem._CONS_.GRID).setCell(c,"spComment",b);});$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},_initJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].salesPriceShow=d[b].salesPrice;d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append("<table class='table table-bordered table-stripped' id=\""+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","原价(元)","库存数量","数量","价格隐藏","数量隐藏","商品价格类型","折扣(元)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(元)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,i){var h=f;
if(i.prodName){h="<a href='#' class='prodShow' value='"+i.skuId+"' nameValue='"+i.prodName+"'>"+i.skuKey+":"+i.prodName+"</a>";h+=a._creatReturnType(i.afterSaleType)+a._creatReturnStatus(i);
}return h;}},{name:"salesPriceShow",sortable:false,align:"center",classes:"test",width:80,editable:a.canEditPrice,formatter:"number"},{name:"stockCount",sortable:false,align:"center",editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:85,formatter:function(f,g,h){if(h.stockCount<1){return"<span>"+h.stockCount+"</span>";
}return"<span>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"center",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"salesPrice",sortable:false,editable:false,hidedlg:true,hidden:true,width:120},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"priceType",sortable:false,width:120,hidedlg:true,hidden:true},{name:"spDiscoutShow",sortable:false,align:"center",editable:a.isCanEdit,formatter:"number",classes:"test",width:90},{name:"spCommentShow",sortable:false,editable:a.isCanEdit,width:120,classes:"test"},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:120},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"center",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var k="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;'  value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}for(var g=0;g<h.length;g++){var j=$(SoItem._CONS_.GRID).jqGrid("getRowData",h[g]);if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
if(j["priceType"]!="exchange"){$("#"+h[g]+"_spDiscoutShow").attr("readonly",true);$("#"+h[g]+"_spCommentShow").attr("readonly",true);}}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();
$("input[name=countShow]").css("text-align","right");$("input[name=spDiscoutShow]").css("text-align","right");},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:7,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
},footerData:function(){var c=$(SoItem._CONS_.GRID).jqGrid("getCol","totalAmount",true,"sum");var b=$(SoItem._CONS_.GRID).jqGrid("getCol","count",true,"sum");
$(SoItem._CONS_.GRID).jqGrid("footerData","set",{prodPic:"总计:",countShow:b,totalAmount:c});var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;
},getFooterData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;},_creatReturnType:function(a){var b="";if("back"==a||"reject"==a){b="<span style='color:red;'>[退]</sapn>";
}else{if("exchange"==a){b="<span style='color:blue;'>[换]</sapn>";}}return b;},_creatReturnStatus:function(a){var b="";if(a.afterSaleType){if(a.afterSaleStatus=="processing"){b="<span style='color:red;'>[未]</sapn>";
}else{if(a.afterSaleStatus=="complete"){b="<span style='color:green;'>[已]</sapn>";}else{if(a.afterSaleStatus=="stop"){b="<span style='color:blue;'>[终]</sapn>";
}else{if(a.afterSaleStatus=="bad"){b="<span style='color:green;'>[已]</sapn>"+"<span style='color:red;'>[次]</sapn>";}}}}}return b;},getSoItemGridData:function(){var c=$(SoItem._CONS_.GRID);
var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;a++){var e=c.jqGrid("getRowData",d[a]);if(e["count"]==""){continue;
}else{if(parseInt(e["count"])<1){continue;}}f++;b.append("soItemPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soItemPos[").append(f-1).append("].skuId=").append(e["skuId"]).append("&").append("soItemPos[").append(f-1).append("].skuKey=").append(e["skuKey"]).append("&").append("soItemPos[").append(f-1).append("].isMain=").append(e["isMain"]).append("&").append("soItemPos[").append(f-1).append("].mainId=").append(e["mainId"]).append("&").append("soItemPos[").append(f-1).append("].salesPrice=").append(e["salesPrice"]).append("&").append("soItemPos[").append(f-1).append("].count=").append(e["count"]).append("&").append("soItemPos[").append(f-1).append("].discout=").append(e["discout"]).append("&").append("soItemPos[").append(f-1).append("].spDiscout=").append(e["spDiscout"]).append("&").append("soItemPos[").append(f-1).append("].spComment=").append(e["spComment"]).append("&").append("soItemPos[").append(f-1).append("].invoice=").append(e["invoice"]).append("&").append("soItemPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soItemPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(d[a].indexOf("tmpSoItem")==-1){b.append("soItemPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},getRowLength:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
return a.length;},soItemOperFunc:function(b,a){return b;},addSoItem2Grid:function(d){var a=this;var c=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");var f=0;
for(var b=0;b<c.length;b++){var e=$(SoItem._CONS_.GRID).jqGrid("getRowData",c[b]);if(e["skuId"]==d.skuId){DialogUtils.error(msgCode.WARING,"订购列表已有该商品");
return;}}d.soId="";d.count="1";d.discout="0.00";d.invoice="";d.createTime="";d.updateTime="";d.countShow=d.count;d.salesPriceShow=d.salesPrice;d.spDiscout="0.00";
if(d.priceType=="common"){d.spDiscout=(parseFloat(d.salesPrice)*(100-a.csPercent)/100).toFixed(2);}d.spComment=d.priceType=="special"?"特价":d.priceType=="gift"?"赠品":" ";
if(d.priceType=="common"){if(a.csPercent==100){d.spComment="正价商品";}else{d.spComment="正价商品"+parseFloat(a.csPercent/10).toFixed(1)+"折";}}d.spDiscoutShow=d.spDiscout;
d.spCommentShow=d.spComment;d.totalAmount=parseFloat(d.salesPrice)*parseInt(d.count)-parseFloat(d.spDiscout);$(SoItem._CONS_.GRID).jqGrid("addRowData","tmpSoItem"+a.soItemRowid,d,"last");
a.soItemRowid++;},isHadData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");if(a.length>0){return true;}return false;},_initPointJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append('<table id="'+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","兑换积分","库存数量","数量","数量隐藏","折扣(积分)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(积分)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,h){if(h.prodName!=null&&h.prodName!=0){return"<a href='#' class='prodShow' value='"+h.prodId+"' keyValue='"+h.skuKey+"' nameValue='"+h.prodName+"'>"+h.prodName+"</a>";
}return h.prodName;}},{name:"salesPrice",sortable:false,align:"center",classes:"test",width:90},{name:"stockCount",sortable:false,editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:90,formatter:function(f,g,h){if(h.stockCount<1){return"<span class='label label-danger'>"+h.stockCount+"</span>";
}return"<span class='label label-primary'>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"right",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"spDiscoutShow",sortable:false,hidedlg:true,hidden:true},{name:"spCommentShow",sortable:false,hidedlg:true,hidden:true},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:90},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"right",classes:"test",formatter:"integer",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;' value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:j});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");for(var g=0;g<h.length;g++){if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:6,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},calMaxExchangeCount:function(h){var a=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
var e=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=totalAmount]").val();var b=$(SoItem._CONS_.GRID).getCell(h,"totalAmount");var d=$(SoItem._CONS_.GRID).getCell(h,"salesPrice");
var g=e-b;var c=a-g;var f=c/d;return parseInt(f);}};function SoProfit(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.soProfitRowid=1;this.orderCreateId=null;
this.data=null;}SoProfit._CONS_={SAVE_PROFIT_URL:ctx+"/ec/salesorder/soEntity/saveProfit.htm",GRID:"#soProfitGrid",GRID_ID:"soProfitGrid",DIV_ID:".soProfitDiv",PAGER:"#soProfitPager",PAGER_ID:"soProfitPager",JSON_ID:"soProfitJSON",};
SoProfit.prototype={init:function(b){var a=this;if(b){if(b.orderCreateId!=undefined){a.orderCreateId=b.orderCreateId;}if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;
}}if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a._initJqgrid(b,true);},_bindEventHander:function(){var a=this;$(document).on("change","input[name=percentShow]",function(){var c=$(this).parent().parent().attr("id");
var b=$(this).val();$(this).val((parseFloat(b)).toFixed(2));a._changePercent(c,b);});$(document).on("click",".delSoProfit",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){$(SoProfit._CONS_.GRID).delRowData(b);
a.changePercent();}});});$(document).on("click",".soProfitEdit",function(){$(".soProfitEdit").hide();$(".soProfitSave").show();$(".soProfitCanel").show();
$(".selectEmpBtnDetail").show();a.changeEdit(true);});$(document).on("click",".soProfitCanel",function(){$(".soProfitEdit").show();$(".soProfitSave").hide();
$(".soProfitCanel").hide();$(".selectEmpBtnDetail").hide();a.changeEdit(false);a._initJqgrid({data:a.data,orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},false);
});$(document).on("click",".soProfitSave",function(){var b=a.save();});$(".form_wrapper").off("click","#selectEmpBtnDetail");$(".form_wrapper").on("click","#selectEmpBtnDetail",function(){var b=0;
if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,mode:0,callBack:function(f){if(f!=null){if(f.length>0){for(var e=0;
e<f.length;e++){if(!a.isHadEmp(f[e].id)){a.addSoProfit2Grid({soId:$("input[name=id]").val(),partyId:f[e].id,employeeName:f[e].name,aid:f[e].aid});}}}}}};
var c=new EmployeesSelect();c.init(d);});},_hideBtn:function(){this.changeEdit(false);$(".soProfitEdit").show();$(".soProfitSave").hide();$(".soProfitCanel").hide();
$(".selectEmpBtnDetail").hide();},_getInitPersent:function(a){if(a!=this.orderCreateId){return 0;}else{var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
if(d.length<=0){return 100;}else{var b=0;for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}return 100-b;}}},_changePercent:function(d,h){var j=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");if(isNaN(h)||h==""){return;}var b=(parseFloat(h)).toFixed(2);
var f=null;var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d);for(var g=0;g<j.length;g++){if(j[g]!=d){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",j[g]);
if(e["partyId"]!=this.orderCreateId){b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));}else{f=j[g];}}}var a=$(SoProfit._CONS_.GRID).jqGrid("getRowData",f);
$(SoProfit._CONS_.GRID).setCell(f,"percentShow",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(f,"percent",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(d,"percent",(parseFloat(h)).toFixed(2));
},checkPercent:function(h,e){var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(e);var b=null;var g=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h);
for(var c=0;c<d.length;c++){if(d[c]!=h){var f=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(f["partyId"]!=this.orderCreateId){a=a+parseFloat(f["percent"]);
}else{b=d[c];}}}if(a>100){return false;}return true;},validPercent:function(){var c=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(0);for(var b=0;
b<c.length;b++){var d=$("#"+c[b]+"_percentShow").val();a=a+parseFloat(d);}if(a>100||a<99.99){return false;}return true;},changePercent:function(){var b=null;
var a=0;var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(e["partyId"]!=this.orderCreateId){a=parseFloat(a)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}else{b=d[c];}}console.log("totalPercent:"+a);$(SoProfit._CONS_.GRID).setCell(b,"percentShow",(100-a).toFixed(2));$(SoProfit._CONS_.GRID).setCell(b,"percent",(100-a).toFixed(2));
},_initJqgrid:function(f,a){var b=this;var e=[];if(a==true){if(f){if(typeof f.data!=undefined&&f.data!=null&&f.data.length){e=f.data;}}if(e!=null&&e.length>0){for(var c=0;
c<e.length;c++){e[c].percent=(parseFloat(e[c].percent)/100).toFixed(2);e[c].percentShow=e[c].percent;}}b.data=e;}else{e=b.data;}var d=$("#profitTitleDiv").width();
$(SoProfit._CONS_.DIV_ID).empty().append('<table id="'+SoProfit._CONS_.GRID_ID+'"></table>            <div id="'+SoProfit._CONS_.PAGER_ID+'"></div>            <input type="hidden"  name="'+SoProfit._CONS_.JSON_ID+'"  id="'+SoProfit._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoProfit._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:e,caption:"绩效分成列表",autowidth:false,width:d,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["订单ID","员工ID","订单编号","工号","员工","比例(%)","比例","创建时间","更新时间","操作"],colModel:[{name:"soId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"partyId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"soNo",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"aid",sortable:false,editable:false,width:120,hidden:true},{name:"employeeName",sortable:false,editable:false,width:120,formatter:function(g,h,i){return i.aid+":"+g;
}},{name:"percentShow",sortable:false,editable:true,width:110},{name:"percent",sortable:false,editable:false,hidedlg:true,hidden:true,width:80},{name:"createTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"button",width:100,hidedlg:!b.isCanEdit,hidden:!b.isCanEdit}],gridComplete:function(){var h=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h[g]);if(j["partyId"]!=f.orderCreateId&&b.isCanEdit==true){var k="<i class='fa fa-remove delSoProfit'style='color:red;cursor:pointer;' title='删除'  value='"+h[g]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});$(SoProfit._CONS_.GRID).editRow(h[g]);}}},});$(window).bind("resize",function(){if(f.widthElement){$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);
}});},getSoProfitGridData:function(){var c=$(SoProfit._CONS_.GRID);var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;
a++){var e=c.jqGrid("getRowData",d[a]);if(e["percent"]==""){continue;}else{if(parseFloat(e["percent"])<0.01){continue;}}f++;b.append("soProfitPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soProfitPos[").append(f-1).append("].partyId=").append(e["partyId"]).append("&").append("soProfitPos[").append(f-1).append("].percent=").append(parseInt(parseFloat(e["percent"])*100)).append("&").append("soProfitPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soProfitPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(!d[a].indexOf("tmpSoProfit")==0){b.append("soProfitPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},addSoProfit2Grid:function(b){var a=this;
b.percent=a._getInitPersent(b.partyId);b.percentShow=b.percent;$(SoProfit._CONS_.GRID).jqGrid("addRowData","tmpSoProfit"+a.soProfitRowid,b,"last");a.soProfitRowid++;
},isHadEmp:function(d){var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);
if(c["partyId"]==d){DialogUtils.error(msgCode.INFO,"已存在该员工!");return true;}}return false;},changeEdit:function(d){if(d==true){this.isCanEdit=true;$(SoProfit._CONS_.GRID).jqGrid("showCol","button");
var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);if(c["partyId"]!=this.orderCreateId){var e="<i class='fa fa-remove delSoProfit' style='color:red;cursor:pointer;' title='删除'  value='"+b[a]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",b[a],{button:e});$(SoProfit._CONS_.GRID).editRow(b[a]);}}}else{this.isCanEdit=false;$(SoProfit._CONS_.GRID).jqGrid("hideCol","button");
}$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);},save:function(){var a=this;if(!a.validPercent()){DialogUtils.error(msgCode.ERROR,"业绩分成必须等于100");
return false;}FormUtils.submit(SoProfit._CONS_.SAVE_PROFIT_URL,a.getSoProfitGridData(),function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"修改成功");
a._hideBtn();a._initJqgrid({data:$.parseJSON(b.msg),orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},true);}else{DialogUtils.error(msgCode.ERROR,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};var GroupUtils={loadGroupOptions:function(a){a.url=ctx+"/gl/ou/group/listData.htm";
if(!a.positionType){a.url=a.url+"?type=dept_manager";}a.key="id";a.keyName="name";a.caption="请选择部门";return OptionsBaseUtils.getOptions(a);},selectGroupTreeBox:function(a){var b={selectedIds:jQuery.isArray(a.selectedGroupId)?a.selectedGroupId.toString():a.selectedGroupId,container:a.container,treeId:"menuContentForGroup"+a.container.split(" ")[0],isMultiple:a.isMultiple,otherParam:{selectedGroupId:a.selectedGroupId},url:ctx+"/gl/ou/group/listData.htm",fn:a.fn,isSale:a.isSale,positionType:a.positionType,hideSale:a.hideSale?a.hideSale:false,isSmsConfigHtml:a.isSmsConfigHtml,isReDisabled:a.isReDisabled?a.isReDisabled:false};
if(a.isEqWidth){b.isEqWidth=true;}if(a.isAutoHeight){b.isAutoHeight=true;}if(!b.positionType){b.url=b.url+"?type=dept_manager";}else{b.url=b.url+"?type="+b.positionType;
}if(a.isSale){b.url=b.url+"?type="+b.positionType+"&isSale=y";}if(a.agentId){b.url=b.url+"&agentId="+a.agentId;}b.dataFilter=function(f,c,g){if(g&&g.length){for(var e=0;
e<g.length;e++){var d=g[e];if(d.isSale=="y"&&!b.hideSale){d.name=d.name+"【销】";d.font={"color":"red"};}}}if(a.dataFilter){return a.dataFilter(f,c,g);}else{return g;
}};CateUtils.selectTreeBox(b);},selectGroup:function(c){var e=c.selectedGroupId?c.selectedGroupId:"";var d=c.hasOwnProperty("isMultiple")&&c.isMultiple;
var a=this;var b=ctx+"/gl/ou/group/listData.htm";if(!c.positionType){b+="?type=dept_manager";}if(jQuery.isArray(e)){e=e.toString();}layer.open({type:1,title:"选择部门",shadeClose:false,btn:["确定","关闭"],area:["70%","70%"],scrollbar:false,maxmin:false,content:'<ul id="organizationSelTree" class="ztree" style="width:260px; overflow:auto;"></ul>',success:function(f,i){var g=this;
var j={async:{enable:true,url:b,contentType:"application/json",dataType:"json",type:"get",autoParam:["id"],otherParam:{selectedGroupId:e},dataFilter:function(n,k,o){if(o&&o.length){for(var m=0;
m<o.length;m++){var l=o[m];if(l.isSale=="y"){l.name=l.name+"【销】";l.font={"color":"red"};}}}return o;},},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},check:{enable:true,chkStyle:d?"checkbox":"radio",chkboxType:{"Y":"s","N":"s"},radioType:"all"},callback:{onClick:function h(l,o,n){var m=n.getCheckStatus().checked;
var k=$.fn.zTree.getZTreeObj("organizationSelTree");k.checkNode(n,!m,false);},onAsyncSuccess:function(m,o,n,p){var l=$.fn.zTree.getZTreeObj("organizationSelTree");
if(!n){var k=l.getNodes()[0];l.expandNode(k,true,false,true);}}}};$.fn.zTree.init($("#organizationSelTree"),j);},yes:function(j,g){var h=$.fn.zTree.getZTreeObj("organizationSelTree");
var f=h.getCheckedNodes(true);var l=[];for(var k=0;k<f.length;k++){var m={id:f[k].id,name:f[k].name};l.push(m);}if(c.fn){c.fn(l);}layer.close(j);}});}};
function SoEntityBase(){this.soCustomer=new SoCustomer();this.csFollow=new CsFollow();}SoEntityBase._CONS_={SO_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CS_DETAIL_URL:ctx+"/crm/cs/csEntity/edit.htm",EDIT_FORM_ID:"soEntityForm",};
SoEntityBase.prototype={init:function(){this._initBaseInfo();this.soCustomer.init(csId);this._initFollow();this._bindFormValidation();this._bindEventHander();
this._initPermissions();this._initServicePhone();this.priceFollowLog="";this.skuFollowLog="";},_initBaseInfo:function(){this._initSoItemPic();var b=$("input[name='status']").val();
if(""==b||"awaiting_post"==b||"awaiting_comfirm"==b||"awaiting_pay"==b){this._loadRecommendProds();var a=$("select[name=storeId]").val();if(a==undefined){a="";
}this._prodSearch(a);}this._calSoItemTotal();this._calWaitPayAmount();if("pay_sub"==$("[name=cashType]").val()){$("[name=subAmount]").attr("readonly",false);
}},_initServicePhone:function(){var a=$("#scCode").find("option:selected").attr("attr-mobile");$("#servicePhoneBtn").attr("masknum",a);},_initPermissions:function(){if(!ResUtils.canShow("mySoEntity.button.modifyProfit")){$("#selectEmpBtn").remove();
}if(!ResUtils.canShow("csEntity.totalPrice.modify")){$("input[name=totalAmount]").attr("readonly","readonly");}else{if(!$("input[name=totalAmount]").attr("readonly")){$("input[name=totalAmount]").removeAttr("readonly");
}}if(ResUtils.canShow("soEntity.button.viewPhoneBtn")){$(".viewPhone").show();}else{$(".viewPhone").hide();}if(!ResUtils.canShow("soEntitySearch.button.deleteSoLog")){$(".deleteSoLogTd").remove();
}ConfigUtils.findByKey("soEntity.isReceivePhone",function(a){if(a.success){$("#receivePhoneDiv").show();isReceivePhone=true;}else{$("#receivePhoneDiv").hide();
}});},_initFollow:function(){var b=this;var c=$("input[name=id]").val();if(c){var a="<a href='#' class='soTab' value='"+$("[name=soNo]").val()+"'>"+$("[name=soNo]").val()+"</a>，订单金额<span style='color:red'>"+$("[name=totalAmount]").val()+"元</span>)";
var d={csId:$("input[name=csId]").val(),csCode:$(".csCode").val(),entityId:c,needTable:false,followType:"so",contentExt:a,fn:function(e){b._addSoLog(e);
}};this.csFollow.init(d,{partyId:$("input[name=employeeId]").val(),partyAid:$("input[name=employeeAid]").val(),partyName:$("input[name=employeeName]").val()});
}},getSoItemData:function(){var e=[];var a=$("#soItemTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;b++){var d=$(a[b]);var c={};c.prodName=d.find(".prodShow").attr("nameValue");
c.id=d.attr("name");c.soId=d.find(".soId").val();c.skuId=d.find(".skuId").val();c.skuKey=d.find(".skuKey").val();c.isMain="y";c.salesPrice=d.find(".prodPrice").val();
c.count=d.find(".soItemCount").val();c.damageCount=d.find(".damageCount").val();c.damageReason=d.find(".damageReason").val();c.damageType=d.find(".damageType").val();
e.push(c);}}return JSON.stringify(e);},getSoProfitData:function(){var f=[];var a=$("#soProfitTbody").find("tr");if(a&&a.length>0){for(var b=0;b<a.length;
b++){var d=$(a[b]);var e={};var c=parseInt(parseFloat(d.find(".soProfitPercent").val())*100);if(c==0){continue;}e.partyId=d.find(".profitEmpId").val();
e.id=d.find(".profitId").val();e.percent=c;f.push(e);}}return JSON.stringify(f);},_loadRecommendProds:function(a){return;var a=$("select[name=storeId]").val();
$("#recomendProdsContainer").empty();var b=ctx+"/ec/salesorder/soEntity/getRecommendProds.htm?csId="+$("input[name=csId]").val()+"&storeId="+a+"&prodType=entity";
FormUtils.loadData(b,function(e){if(e&&e.length){var m=new StringBuffer();for(var g=0;g<e.length;g++){m.append("<div class='form-group' style='border-bottom: 1px solid #ddd;'>");
m.append("<div class='col-sm-2'>");m.append("<img src='"+ctx+e[g].path+"' style='height: 140px; width: 95px; padding-left:5px;'>");m.append("</div>");m.append("<div class='col-sm-5 skuContainer' imgUrlVal='"+e[g].path+"' selectedSkuIdVal='"+e[g].skuId+"' prodIdVal='"+e[g].id+"'>");
m.append("<p style='margin: 0 0 2px 0px;' class='prodNameContainer'><a nameValue='"+e[g].name+"' keyValue='"+e[g].key+"' class='prodShow' value='"+e[g].skuId+"' href='javascript:void(0);'>"+e[g].name+"</a></p>");
m.append("<p>"+e[g].subName+"</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("价格:");m.append("<strong style='color:red;' class='priceContainer'>￥"+e[g].price+"");
m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("sku:");m.append("<strong style='color: red;' class='skuCodeContainer'>");
m.append(e[g].skuCode);m.append("</strong>");m.append("</p>");m.append("<p style='margin: 0 0 2px 0px;'>");m.append("库存数量:");m.append("<strong style='color: red;' class='stockContainer'>");
m.append(e[g].canSaleQty);m.append("</strong>");m.append("</p>");if(e[g].skuMap){for(var l in e[g].skuMap){m.append("<p class='chooseSku'>");m.append("<span>"+l+":</span>");
if(e[g].skuMap[l].length){for(var d=0;d<e[g].skuMap[l].length;d++){var f="btn-default";if(e[g].skuMap[l][d].isSelected=="y"){f="btn-primary";}m.append("<button valValue='"+e[g].skuMap[l][d].value+"' type='button' class='btn btn-xs "+f+" skuBtn'>"+e[g].skuMap[l][d].name+"</button>&nbsp;");
}}m.append("</p>");}}m.append("<p>");m.append("<button type='button' class='btn btn-xs  btn-primary addToCartBtn'>");m.append("购买</button>");m.append("</p>");
m.append("</div>");m.append("<div class='col-sm-5'>");for(var h in e[g].eavShowView.eavAttrValueMap){for(var c=0;c<e[g].eavShowView.eavAttrValueMap[h].length;
c++){for(var d=0;d<e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos.length;d++){if(e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].checked){m.append("<div class='checkbox checkbox-success checkbox-inline'>");
m.append("<input disabled='disabled' checked='checked' class='checkRes' type='checkbox'>");m.append("<label>"+e[g].eavShowView.eavAttrValueMap[h][c].eavAttrOptPos[d].label+"</label>");
m.append("</div>");}}}}m.append("</div>");m.append("</div>");}$("#recomendProdsContainer").append(m.toString());}else{$("#recomendProdsContainer").append("<p>无推荐产品</p>");
}});},_bindEventHander:function(){var a=this;$("body").on("click",".viewPhone",function(){var d=this;var c=$(this).attr("attr-num");var b={number:c,callback:function(e){$(d).parents(".addrDiv").find(".addrMobile").val(e);
}};DecryptHelper.decrypt(b);});$(document).on("click",".delSoItem",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calSum();}});});$(document).on("change",".prodPrice",function(){var f=$(this).closest("tr");var g=$(f);var h=parseFloat(g.find(".originPrice").text());
var d=parseFloat(g.find(".skuPercentLimit").val());var b=parseFloat($(this).val());var j=0;var i="";var e=false;if(parseInt(percentLimit)){var k=parseFloat(h*(parseInt(percentLimit)/100)).toFixed(2);
j=k;if(parseFloat(k)>b){i="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+k;e=true;}}if(d){var k=parseFloat(h*(d/100)).toFixed(2);if(parseFloat(k)>b&&(parseFloat(k)<j||j<1)){i="该商品最低折扣为 "+d+"%，即最低金额为 "+k;
e=true;}else{if(parseFloat(k)<j||j<1){e=false;}}}if(e){$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+i+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(h);}a._calSum();});$(document).on("change",".soItemCount",function(){var e=$(this).closest("tr");
var g=$(e);var b=g.find(".buyLimit").val();if(parseFloat(b)){var j=g.find(".skuId").val();var l=$("#soItemTbody").find("tr");if(l&&l.length>0){var h=0;
for(var d=0;d<l.length;d++){var f=$(l[d]);if(f.find(".skuId").val()==j){h+=parseInt(f.find(".soItemCount").val());}}if(h>parseFloat(b)){var k="该商品数量超过每单限制"+b+"个";
$(this).attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+k+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$(this).popover("show");var c=$(this);setTimeout(function(){a.destroyPopover(c);},3000);$(this).val(1);}}}a._calSum();});$("#recomendProdsContainer").on("click",".addToCartBtn",function(){var d=ctx+"/img/jt/nophoto.png";
var f=e.attr("imgUrlVal");if(f){var c={url:f,name:"",id:""};d=ImageUtils.getUrl(c);}var e=$(this).parents(".skuContainer");var b={prodId:e.attr("prodIdVal"),prodName:e.find(".prodNameContainer").text(),prodPic:e.attr("imgUrlVal"),prodSrc:d,skuId:e.attr("selectedskuidval"),skuCode:e.find(".skuCodeContainer").text(),isMain:"y",maindId:"",prodPrice:e.find(".priceContainer").text().substring(1),priceType:$("#prod-price-type").val(),canSaleQty:e.find(".stockContainer").text()};
a._addSoItem(b);});$(document).on("click",".delSoProfit",function(){var b=$(this).parents("tr");DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){b.remove();
a._calProfitPercent();}});});$(document).on("click",".deleteSoLog",function(){var c={id:$(this).attr("idVal")};var b=$(this).parents("tr");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/ec/salesorder/soEntity/deleteSoLog.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
b.remove();}});});});$(document).on("change",".soProfitPercent",function(){var c=$(this).val();$(this).val((parseFloat(c)).toFixed(2));var b=a._calProfitPercent();
if(b<0){}});$("#recomendProdsContainer").on("click",".skuBtn",function(){if($(this).hasClass("btn-default")){$(this).siblings("button").removeClass("btn-primary").addClass("btn-default");
$(this).removeClass("btn-default").addClass("btn-primary");var e=$(this).parents(".skuContainer");var b="";e.find(".chooseSku").each(function(){$(this).find(".skuBtn").each(function(){if($(this).hasClass("btn-primary")){b+=$(this).attr("valValue")+",";
return false;}});});b=b.substring(0,b.length-1);var d=e.attr("prodIdVal");var c=ctx+"/ec/product/prodEntity/switchSku.htm?prodEntityId="+d+"&skuJson="+b+"&storeId="+$("select[name=storeId]").val();
FormUtils.loadData(c,function(f){e.prev().find("img").attr("src",ctx+f.path);e.find(".priceContainer").text("￥"+f.price);e.find(".skuCodeContainer").text(f.skuCode);
e.find(".stockContainer").text(f.canSaleQty);e.attr("imgUrlVal",f.path);e.attr("selectedSkuIdVal",f.skuId);if(f.canSaleQty<=0){e.find(".addToCartBtn").attr("disabled","disabled");
}else{e.find(".addToCartBtn").removeAttr("disabled");}});}});$("#selectSkuBtn").on("click",function(){if(isSelectStoreInShip=="n"&&($("select[name=storeId]").val()==""||$("select[name=storeId]").val()==null)){DialogUtils.error(msgCode.WARING,"请先选择仓库");
return false;}var c="product";var b="y";if(isPoint){c="point";b="n";}a.hadClose=false;SelectProdService.selectSku({storeId:$("select[name=storeId]").val(),isMultiple:1,type:c,canSale:"y",isSale:"y",userId:currentUserId,priceType:$("#prod-price-type").val(),hasStock:$("#hasStock").is(":checked")?"y":"n",limitProdCate:b,fn:function(d){for(var e=0;
e<d.length;e++){if(a.checkIsCanAddSoItem(d[e])){a._addSoItem1({prodId:d[e].prodId,prodName:d[e].prodName,prodPic:d[e].imgUrl,skuId:d[e].skuId,skuCode:d[e].skuCode,isMain:"y",maindId:"",prodPrice:d[e].price,buyLimit:d[e].buyLimit,skuPercentLimit:d[e].skuPercentLimit,canSaleQty:d[e].totalQty,priceType:d[e].priceType,});
}}}});});$(document).on("click","#selectEmpBtn",function(){var b=0;if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,callBack:function(h){if(h&&h.length>0){var f=[];
for(var e=0;e<h.length;e++){if(!a._hasAssignProfit(h[e].id)){var j={id:h[e].id,aid:h[e].aid,name:h[e].name,groupName:h[e].orgName};f.push(j);}}var g={employees:f};
a._addSoProfit(g);a._calProfitPercent();}}};var c=new EmployeesSelect();c.init(d);});$("#soEntityForm").on("change","select[name=storeId]",function(){var b=$(this).val();
var d=$("input[name=realStoreId]").val();var c=$("#soItemTbody").find("tr");if(c&&c.length>0){if(d){$("select[name=storeId]").val(d);}else{$(this).find("option").eq(0).prop("selected",true);
}DialogUtils.error(msgCode.WARING,"已有订购的商品，不能改变仓库");return;}$("input[name=realStoreId]").val(b);a._prodSearch(b);a._loadRecommendProds();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=shippingAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=subAmount]",function(){a._calSum(null,null,true);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=billAmount]",function(){a._calSum();
});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","input[name=totalAmount]",function(){var c=$(this).val();var d="总价格从"+$("#totalAmount").val()+"变成"+c;
$("input[name=priceFollowLog]").val(d);var b=$(this);a._calSum(c,b);});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=cashType]",function(){var b=$(this).val();
$("input[name=subAmount]").attr("readonly",false);$("input[name=shippingAmount]").attr("readonly",false);$("input[name=totalAmount]").attr("readonly",false);
if(b=="free"){$("input[name=subAmount]").val("0.00");$("input[name=shippingAmount]").val("0.00");$("input[name=totalAmount]").val("0.00");$("input[name=waitPayAmount]").val("0.00");
$("input[name=subAmount]").attr("readonly",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
}else{if(b!="pay_sub"){$("input[name=subAmount]").val("0.00");$("input[name=subAmount]").attr("readonly",true);a._calSum();}}if($(".myCsTotalAmount").hasClass("notModify")){$(".myCsTotalAmount").attr("readonly",true);
}if($(".subCsTotalAmount").hasClass("notModify")){$(".subCsTotalAmount").attr("readonly",true);}if(b=="cod"||b=="free"){$("select[name=payType]").empty().append("<option value='cash'>现金支付</option><option value='weixinhongbao'>微信红包</option><option value='QRCode'>收款码支付</option>");
}else{$("select[name=payType]").empty().append("<option value='alipay'>支付宝</option><option value='weixin'>微信支付</option><option value='weixinhongbao'>微信红包</option><option value='bank'>银行转账</option><option value='cash'>现金支付</option><option value='QRCode'>收款码支付</option>");
}$("select[name=payType]").trigger("change");});$(document).on("change","select[name=payType]",function(){var b=$(this).val();var d=$("select[name=account]").find("option");
if(d&&d.length>0){for(var c=0;c<d.length;c++){if($(d[c]).attr("attr-type")==b){$("select[name=account]").val($(d[c]).attr("value"));break;}else{$("select[name=account]").val("");
}}}if(b=="cash"){$("select[name=account]").attr("disabled",true);}else{$("select[name=account]").attr("disabled",false);}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("change","select[name=billType]",function(){if($("select[name=billType]").val()=="none"){a._hideBillInfo();
$("input[name=billAmount]").val("0").trigger("change");$("input[name=billTitle]").val("");$("input[name=billContent]").val("");}else{if($("select[name=billType]").val()=="common"){a._showBillInfo();
$("input[name=billAmount]").val("0").trigger("change");}else{if($("select[name=billType]").val()=="receipt"){a._showBillInfo();$("input[name=billAmount]").val("0").trigger("change");
}else{a._showBillInfo();}}}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".addAddr",function(){var b=new ShopAddrOpt();b.init({csId:$("input[name=csId]").val(),callBack:function(e){var d=$.templates("#addrTmpl");
var c=d.render(e);$(".defaultAddr").show().after(c);$(".csAddrDiv:first").find("[name=chooseAddr]").trigger("click");$(".changeAddr").show();$(".addAddrDiv").hide();
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".editAddr",function(){var b=$(this).parents(".csAddrDiv");var c=$(this).parents(".csAddrDiv").prevAll(".defaultAddr");
var d=new ShopAddrOpt();d.init({addrId:$(this).attr("idVal"),csId:$('input[name="csId"]').val(),isCs:false,callBack:function(f){b.find(".addrName").val(f.name);
b.find(".addrMobile").val(MaskPhoneNum.getMaskPhoneNum(f.mobile));var e="";if(f.prName){e+=f.prName+",";}if(f.ciName){e+=f.ciName+",";}if(f.arName){e+=f.arName+",";
}b.find(".addrInfo").val(e+f.toName+f.addr);b.find("[name=chooseAddr]").attr("coName",f.coName);b.find("[name=chooseAddr]").attr("prName",f.prName);b.find("[name=chooseAddr]").attr("ciName",f.ciName);
b.find("[name=chooseAddr]").attr("arName",f.arName);b.find("[name=chooseAddr]").attr("addrDetail",f.addr);b.find("[name=chooseAddr]").trigger("click");
}});});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click",".changeAddr",function(){if($(".csAddrDiv").is(":hidden")){$(".csAddrDiv").show();}else{$(".csAddrDiv").hide();
}});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("click","[name=chooseAddr]",function(){var i=$(this).parents(".csAddrDiv");var h=$(".defaultAddr");var c=$(this).val();
var e=$(this).attr("coName");var l=$(this).attr("prName");var j=$(this).attr("ciName");var g=$(this).attr("arName");var k=$(this).attr("addrDetail");var b=i.find(".addrName").val();
var f=i.find(".addrMobile").val();var d=i.find(".addrInfo").val();h.find("[name=addrId]").val(c);h.find("[name=coName]").val(e);h.find("[name=prName]").val(l);
h.find("[name=ciName]").val(j);h.find("[name=arName]").val(g);h.find("[name=addrDetail]").val(k);h.find(".addrName").val(b);h.find(".addrMobile").val(f);
h.find(".addrInfo").val(d);$(".csAddrDiv").hide();});$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).on("focus","#searchProd",function(){var b=$("select[name=storeId]").val();
if(isSelectStoreInShip=="n"&&(b==null||b=="")){DialogUtils.error(msgCode.WARING,"请先选择仓库");}});$("#hasStock").on("change",function(){a._prodSearch($("select[name=storeId]").val());
});$("#prod-price-type").on("change",function(){a._prodSearch($("select[name=storeId]").val());});$(document).on("click",".soTab",function(){var c=$(this).attr("csNameVal");
var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(SoEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,b+"的订单明细");});$(document).on("click",".prodShow",function(){var c=$(this).attr("value");
var b=$(this).attr("nameValue");var d=b;if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品["+d+"",b);
});$(document).on("click",".copyCsBtn",function(){$("#csCodeText").select();document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});$(document).on("click",".copySoBtn",function(){$("#soCodeText").select();
document.execCommand("Copy");DialogUtils.success(msgCode.INFO,"复制成功");});},destroyPopover:function(a){a.popover("destroy");},_hasAssignProfit:function(d){var a=false;
var c=$(".profitEmpId");if(c&&c.length>0){for(var b=0;b<c.length;b++){if(d==$(c[b]).val()){a=true;}}}return a;},_calProfitPercent:function(){var d=$(".soProfitPercent");
var c=0;$(".soProfitPercent").css("color","black");$("#soProfitTip").empty().hide();if(d&&d.length>1){for(var b=1;b<d.length;b++){if(parseFloat($(d[b]).val())<=0){$(d[b]).css("color","red");
$("#soProfitTip").empty().append("（员工绩效分成比例必须大于0）").show();}c=parseFloat(c)+parseFloat($(d[b]).val());}}var a=(parseFloat(100)-parseFloat(c)).toFixed(2);
$(d[0]).val(a);if(a<0){$(d[0]).css("color","red");$("#soProfitTip").empty().append("（员工分成比例总和必须等于100）").show();}},_validateAmount:function(a){try{$("input[name=totalAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=subAmount]").val()),messages:{}});
if(a){$("input[name=subAmount]").rules("add",{required:true,number:true,min:parseFloat($("input[name=totalAmount]").val()),max:parseFloat($("input[name=totalAmount]").val()),messages:{min:"订金需等于总金额",max:"订金需等于总金额"}});
}else{$("input[name=subAmount]").rules("add",{required:true,number:true,min:0,max:parseFloat($("input[name=totalAmount]").val()),messages:{}});}}catch(b){}},_prodSearch:function(a){if(a==undefined){a="";
}$("#searchProd").bsSuggest("destroy");if(isSelectStoreInShip=="n"&&(a==null||a=="")){return;}var b=this;var e=$("#searchProd").width()+"px";if($("#searchProd").width()<=500){e=($(".itemDiv").width()*5/6)+"px";
}var c="entity";var g=$("#hasStock").is(":checked")?"y":"n";var f=$("#prod-price-type").val();var d="y";if(isPoint){d="n";c="point";}$("#searchProd").bsSuggest({url:ctx+"/ec/product/prodEntity/search.htm?prodType="+c+"&hasStock="+g+"&storeId="+a+"&priceType="+f+"&limitProdCate="+d+"&keyword=",effectiveFields:["prodPic","prodName","skuCode","cateName","unit","prodTotal","skuAttr","canSaleQty"],searchFields:["prodName","skuCode"],effectiveFieldsAlias:{prodPic:"图片",prodName:"产品名字",skuCode:"sku编码",cateName:"产品分类",unit:"单位",prodTotal:"价格",skuAttr:"sku属性",canSaleQty:"可售数量"},showBtn:false,idField:"skuId",keyField:"skuCode",showBtn:false,twoWayMatch:false,ignorecase:true,allowNoKeyword:true,multiWord:false,autoSelect:false,delayUntilKeyup:false,getDataMethod:"firstByUrl",processData:function(h){for(var k=0;
k<h.value.length;k++){var j="<img style='display: inline; height:35px;' ";if(h.value[k].prodPic){j=j+" src='"+ctx+h.value[k].prodPic+"'>";}else{j=j+" src='"+ctx+"/js/plugins/zTree_v3/css/zTreeStyle/img/jt-diy-elegant_font3/jt-95.png'>";
}h.value[k].prodPic=j;}b.searchProds=h.value;return h;},listStyle:{"padding-top":0,"max-height":"500px","max-width":e,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(i,h){}).on("onSetSelectValue",function(k,h){for(var j=0;
j<b.searchProds.length;j++){if(b.searchProds[j].skuId==h.id){b.currentProd=b.searchProds[j];break;}}if(b.checkIsCanAddSoItem(b.currentProd)){b._addSoItem(b.currentProd);
$("#searchProd").val("");}}).on("onUnsetSelectValue",function(h){b.currentProd={};});},checkIsCanAddSoItem:function(b){if(parseFloat(b.buyLimit)){var a=$("#soItemTbody").find("tr");
if(a&&a.length>0){var e=0;for(var c=0;c<a.length;c++){var d=$(a[c]);if(d.find(".skuId").val()==b.skuId){e+=parseInt(d.find(".soItemCount").val());}}if((e+1)>parseFloat(b.buyLimit)){var f=b.prodName+", 每单数量限制不能大于"+b.buyLimit+"个";
$("#soItemWarm").attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+f+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soItemWarm").popover("show");setTimeout(function(){$("#soItemWarm").popover("destroy");},3000);return false;}}return true;}else{return true;}},_addSoItem1:function(f){if(!f.prodPic){f.prodPic="";
f.prodSrc=ctx+"/img/jt/nophoto.png";}else{var c={url:f.prodPic,name:"",id:""};f.prodSrc=ImageUtils.getUrl(c);f.prodPic=ImageUtils.getUrl(c);}if(f.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(f.priceType=="special"){f.spComment="特价";}else{if(f.priceType=="gift"){f.spComment="赠品";}}}var e=f.skuPercentLimit;var g=0;if(e&&parseFloat(e)>0){g=parseFloat(e);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(g)||parseFloat(g)<1)){g=parseInt(percentLimit);}f.prodTotal=this._calProdTotal(f.prodPrice,1,g,f.originPrice);
f.originPrice=f.prodPrice;f.unit=f.unit;var d=$.templates("#soItemTmpl1");var a=d.render(f);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_addSoItem:function(e){if(e.priceType=="common"){var b=$("#csEntityDiv").find("[name=levelPercent]").val();
if(!b){b=100;}}else{if(e.priceType=="special"){e.spComment="特价";}else{if(e.priceType=="gift"){e.spComment="赠品";}}}var d=e.skuPercentLimit;var f=0;if(d&&parseFloat(d)>0){f=parseFloat(d);
}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(f)||parseFloat(f)<1)){f=parseInt(percentLimit);}e.prodTotal=this._calProdTotal(e.prodPrice,1,f,e.originPrice);
e.originPrice=e.prodPrice;e.unit=e.unit;var c=$.templates("#soItemTmpl");var a=c.render(e);$("#soItemTbody").append(a);if(ResUtils.canShow("csEntity.price.modify")){$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",false);
}else{$("#soEntityForm #soInfoDiv .prodPrice").attr("readonly",true);}this._calSum();},_calProdTotal:function(e,d,f,a){var c=(parseFloat(e)*parseInt(d)).toFixed(2);
var b=(parseFloat(a)*parseInt(f)/100).toFixed(2);if(autoPercent!=0){if(parseFloat(e)==parseFloat(a)){if(parseFloat(autoPercent)<f&&f!=100){c=(c*parseInt(f)/100).toFixed(2);
b=(b*parseInt(f)/100).toFixed(2);}else{c=(c*parseInt(autoPercent)/100).toFixed(2);b=(b*parseInt(autoPercent)/100).toFixed(2);}}}if(parseFloat(c)<parseFloat(b)){return b;
}return c;},_calSoItemTotal:function(){var d=0;var m=0;var e=0;var n=$("#soItemTbody").find("tr");if(n&&n.length>0){for(var h=0;h<n.length;h++){var j=$(n[h]);
var b=j.find(".prodPrice").val();var c=j.find(".soItemCount").val();var k=j.find(".originPrice").text();var g=j.find(".skuPercentLimit").val();var l=j.find(".priceType").val();
var a=0;if(g&&parseFloat(g)>0){a=parseFloat(g);}if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<parseFloat(a)||parseFloat(a)<1)){a=parseInt(percentLimit);
}var f=this._calProdTotal(b,c,a,k);j.find(".prodTotal").text(f);d=parseInt(d)+parseInt(c);m=(parseFloat(m)+parseFloat(f)).toFixed(2);e=(parseFloat(k)*parseInt(c)+parseFloat(e)).toFixed(2);
}}$("#itemCountTotal").text(d);$("#prodPriceTotal").text(m);$("#itemOriginCount").text(e);},_averageTotal:function(a,n,l){var m=this;var f=$("#soItemTbody").find("tr");
var p=[];if(f&&f.length>0){var r=0;var d=0;for(var s=0;s<f.length;s++){var u=$(f[s]);var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var e=u.find(".soItemCount").val();
d+=parseInt(e);var k=u.find(".originPrice").text();var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&(parseInt(percentLimit)<b||b<1)){b=parseInt(percentLimit);
}if(t||parseInt(percentLimit)){r+=parseFloat(k)*(b/100).toFixed(2)*parseInt(e);}else{if(!t&&!parseInt(percentLimit)){}else{r+=parseFloat(k)*parseInt(e);
}}p.push(b);}var g=0;for(var q=0;q<p.length;q++){if(p[q]>parseFloat(a)*100){g++;}}if(g==f.length||(g>0&&g<f.length&&n<r)||(n<r)){var h="修改的总金额小于所有商品最低折扣，最低商品金额为 "+r;
l.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");setTimeout(function(){m.destroyPopover(l);},3000);return false;}if(g==0){for(var s=0;s<f.length;
s++){var u=$(f[s]);var k=u.find(".originPrice").text();var o=parseFloat(parseFloat(k)*parseFloat(a)).toFixed(2);u.find(".prodPrice").val(parseFloat(o));
}this._calSoItemTotal();return true;}if((g>0&&g<f.length)){var c=parseFloat((parseFloat(n)-r)/d).toFixed(2);for(var s=0;s<f.length;s++){var u=$(f[s]);var k=u.find(".originPrice").text();
var t=parseInt(u.find(".skuPercentLimit").val());if(!t){t=0;}var b=parseFloat(t);if(percentLimit&&parseInt(percentLimit)&&parseInt(percentLimit)<b||b<1){b=parseInt(percentLimit);
}var o=0;if(t||parseInt(percentLimit)){o=parseFloat(parseFloat(k)*b/100+parseFloat(c)).toFixed(2);}else{o=parseFloat(parseFloat(k)+parseFloat(c)).toFixed(2);
}u.find(".prodPrice").val(o);}this._calSoItemTotal();return true;}}},_calSum:function(n,j,l){var k=this;var p=false;if(isOpenTotalLinkSale&&isOpenTotalLinkSale=="y"){p=true;
}var o=false;if(n){o=true;}k._calSoItemTotal();var r=$("#prodPriceTotal").text();var d=$("#itemOriginCount").text();var i=$("[name=shippingAmount]").val();
var e=$("[name=billAmount]").val();var q=$("[name=cashType]").val();var c=$("[name=cashBenefit]").val();if("free"==q){n=0;}if(o&&p){var m=parseFloat(parseFloat(n)-parseFloat(i)-parseFloat(e)).toFixed(2);
var a=parseFloat(m/parseFloat(d));if(!this._averageTotal(a,m,j)){this._calSum();return;}}if(!n&&n!=0){n=(parseFloat(r)+parseFloat(i)+parseFloat(e)).toFixed(2);
}if(c){n=(parseFloat(n)-parseFloat(c)).toFixed(2);}if(percentLimit&&o&&p){var b=$("#itemOriginCount").text();var f=(parseFloat(b)*(parseInt(percentLimit)/100)+parseFloat(i)+parseFloat(e)).toFixed(2);
if(c){f=(parseFloat(f)-parseFloat(c)).toFixed(2);}if(parseFloat(f)>parseFloat(n)){var h="您所在部门限制了最低折扣为 "+percentLimit+"%，即最低金额为 "+f;j.attr("title","").attr("data-container","body").attr("data-toggle","popover").attr("data-content","<h4 style='color:red;'>"+h+"</h4>").attr("data-html","true").attr("data-placement","bottom");
$("#soEntityForm input[name=totalAmount]").popover("show");n=f;setTimeout(function(){k.destroyPopover(j);},3000);}}if(!l){$("[name=totalAmount]").val(n);
}k._calWaitPayAmount();var g=false;if("cod"==$("select[name=cashType]").val()&&"shipping"==$("input[name=status]").val()){g=true;}k._validateAmount(g);
},_calWaitPayAmount:function(){var c=0;var d=$("[name=totalAmount]").val();var a=$("[name=subAmount]").val();var b=$("select[name=cashType]").val();if("pay_sub"==b||"cod"==b){c=(parseFloat(d)-parseFloat(a)).toFixed(2);
}else{var e=$("input[name=payedAmount]").val();c=(parseFloat(d)-parseFloat(e)).toFixed(2);}$("[name=waitPayAmount]").val(c);},_addSoProfit:function(b){var c=$.templates("#soProfitTmpl");
var a=c.render(b);$("#soProfitTbody").append(a);},_addSoLog:function(b){var c={};c.employeeAid=currentUserAid;c.employeeName=currentUserName;c.srcType="option_sys";
c.type="task";c.result="跟进成功";c.createTime=DateUtils.format(new Date(),DateUtils._CONS_.DEFAULT_DATE_TIME_PATTERN);c.comment=b.content;var d=$.templates("#soLogTmpl");
var a=d.render(c);$("#soLogTbody").prepend(a);},_showBillInfo:function(){$(".billAmountDiv").show();$(".billTitleDiv").show();$(".billContentDiv").show();
},_hideBillInfo:function(){$(".billAmountDiv").hide();$(".billTitleDiv").hide();$(".billContentDiv").hide();},_bindFormValidation:function(){var a=this;
var b={rules:{shippingAmount:{required:true,number:true,min:0},subAmount:{number:true,min:0},billAmount:{number:true,min:0},totalAmount:{required:true,number:true,min:0},},messages:{}};
FormUtils.bindFormValidation(SoEntityBase._CONS_.EDIT_FORM_ID,b);a._validateAmount();},_initSoItemPic:function(){var a=$(".soItemPic");if(a&&a.length>0){for(var c=0;
c<a.length;c++){var d=$(a[c]).attr("urlVal");if(d){var b={url:d,name:"",id:""};var e=ImageUtils.getUrl(b);$(a[c]).attr("src",e);}else{$(a[c]).attr("src",ctx+"/img/jt/nophoto.png");
}}}}};function ShopAddrOpt(){this.hadInit=false;this.isEdit=false;this.isExist=false;this.addressService=new AddressService(ShopAddrOpt._CONS_.ADDR_CONTAINER);
this.options={callBack:null,};}ShopAddrOpt._CONS_={ADDR_CONTAINER:"shopAddrOptForm_cateContainer",EDIT_FROM_ID:"partyAddrEdidddddtForm",EDIT_URL:ctx+"/crm/cs/csEntity/addr/addrEditForm.htm",SAVE_URL:ctx+"/crm/cs/csEntity/addr/partyAddrAdd.htm",LISTNUM_BYCSID:ctx+"/crm/cs/csEntity/findPhonesByCsIdNotRepeat.htm",};
ShopAddrOpt.prototype={init:function(a){this._bindEventHander();this._openShopAddrDialog(a);this._bindFormValidation();},_openShopAddrDialog:function(d){var b=$(window).width();
var c=["650px","300px"];if(b<1024){c=["450px","230px"];}var a=this;layer.open({type:1,title:"收货地址处理",maxmin:false,shadeClose:false,btn:["保存","关闭"],skin:"addr-skin",area:c,content:$("."+ShopAddrOpt._CONS_.EDIT_FROM_ID),success:function(e,f){FormUtils.clear("shopAddrOptForm");
$(".addrDetaileDescribe").text("");$("input[id=shopAddrOptForm_types]").val("shipping");$("input[id=shopAddrOptForm_isSnapshot]").val("n");a._loadData(d.csId,d.addrId,d.isCs);
},yes:function(h,g){var f=$("div.partyAddrEdidddddtForm");if($("#shopAddrOptForm").valid()&&a.addressService.isValid(f)){$("textarea[name=addr]").val($("#shopAddrOptForm_addr").val());
if($("#shopAddrOptForm_mobile").val()==0){$("input[name=mobile]").val($("#maskNumber").val());}else{$("input[name=mobile]").val($("#shopAddrOptForm_mobile").val());
}var e=a.addressService.getAddress();$("input[name=coRid]").val(e.country);$("input[name=coName]").val(e.countryName);$("input[name=prRid]").val(e.province);
$("input[name=prName]").val(e.provinceName);$("input[name=ciRid]").val(e.city);$("input[name=ciName]").val(e.cityName);$("input[name=arRid]").val(e.area);
$("input[name=arName]").val(e.areaName);$("input[name=toRid]").val(e.town);$("input[name=toName]").val(e.townName);if($("#shopAddrOptForm_mobile").val()==0){if(!$("#maskNumber").val()){$(".tip").text("号码不能为空！").show();
return;}if(a.isExist){return;}}var i=$("#shopAddrOptForm").serialize();FormUtils.submit(ShopAddrOpt._CONS_.SAVE_URL,i,function(j){if(j.success){if(d.callBack){d.callBack(j.partyAddrPo);
}layer.close(h);}else{DialogUtils.error("失败",j.msg,f);}},function(){DialogUtils.error("错误","后台异常，请稍后重试",f);});}},cancel:function(){$("#shopAddrOptForm").validate().resetForm();
FormUtils.clear("shopAddrOptForm");}});},_loadData:function(d,c,b){var a=this;FormUtils.loadData(ShopAddrOpt._CONS_.EDIT_URL+"?csId="+d+"&addrId="+c,function(h){if(c){$("#shopAddrOptForm_isDefault").val(h.isDefault);
}else{if(h.isHaveDefault=="y"){$("#shopAddrOptForm_isDefault").val("n");}else{$("#shopAddrOptForm_isDefault").val("y");}}$("#shopAddrOptForm_partyId").val(d);
h.types&&$("input[id=shopAddrOptForm_types]").val(h["types"]);h.isSnapshot&&$("input[id=shopAddrOptForm_isSnapshot]").val(h["isSnapshot"]);if(b){h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("csEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}else{h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("soEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}h.addr&&$("textarea[name=addr]").val(h["addr"]);h.zipcode&&$("input[id=shopAddrOptForm_zipcode]").val(h["zipcode"]);h.name&&$("input[id=shopAddrOptForm_name]").val(h["name"]);
h.mobile&&$("input[id=mobile]").val(h["mobile"]);h.position&&$("input[id=shopAddrOptForm_position]").val(h["position"]);h.fax&&$("input[id=shopAddrOptForm_fax]").val(h["fax"]);
h.maskEmail&&$("input[id=shopAddrOptForm_email]").val(h["maskEmail"]);h.email&&$("input[name=email]").val(h["email"]);h.im&&$("input[id=shopAddrOptForm_im]").val(h["im"]);
h.createBy&&$("input[id=shopAddrOptForm_createBy]").val(h["createBy"]);h.createTime&&$("input[id=shopAddrOptForm_createTime]").val(h["createTime"]);h.id&&$("input[id=shopAddrOptForm_id]").val(h["id"]);
if(h.maskMobile){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();var f=$("#maskNumber");f.val("");}var g=new StringBuffer();
if(h.maskMobile){g.append("<option value="+h["mobile"]+" selected='selected'>"+h["maskMobile"]+"</option>");}if(h.csPhonePos&&h.csPhonePos.length){if(h.csPhonePos&&h.csPhonePos.length){for(var e=0;
e<h.csPhonePos.length;e++){g.append("<option value="+h.csPhonePos[e].number+">"+h.csPhonePos[e].maskPhone+"["+h.csPhonePos[e].type+"]</option>");}}}g.append("<option class='addNewNum' value='0'>添加新号码</option>");
$("#shopAddrOptForm_mobile").empty().append(g.toString());a.addressService.init({country:h["coRid"]?h["coRid"]:"ChinaCityCateType-root",province:h["prRid"],city:h["ciRid"],area:h["arRid"],town:h["toRid"],});
if($("#shopAddrOptForm_mobile").val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}});},_bindFormValidation:function(){jQuery.validator.addMethod("isPhone",function(c,b){return this.optional(b)||/^(1+\d{10})$/.test(c);
},"手机号码格式错误");var a={rules:{maskAddr:{required:true,maxlength:["1024"]},zipcode:{maxlength:["20"],zipcode:true},fax:{maxlength:["20"]},im:{maxlength:["64"]},name:{required:true,maxlength:["64"]},email:{required:true},maskNumber:{isPhone:true,},position:{maxlength:["64"]}},messages:{}};
FormUtils.bindFormValidation("shopAddrOptForm",a);},_bindEventHander:function(){var a=this;$(document).on("change","#maskNumber",function(){$(".tip").hide();
});$("#shopAddrOptForm").off("click","#shopAddrOptForm_email").on("click","#shopAddrOptForm_email",function(){if($("#shopAddrOptForm_email").val().indexOf("*")>0){$("#shopAddrOptForm_email").val("");
}});$("#shopAddrOptForm_mobile").off("change").on("change",function(){if($(this).val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();
var b=$("#maskNumber");b.val("");}});$("#maskNumber").off("blur").on("blur",function(){var b=$(this).val();if(b&&b.length>=7&&(!a.phonePrefix||a.phonePrefix!=b.substring(0,7))){FormUtils.loadData(ctx+"/crm/cs/csPhoneArea/getArea.htm?phone="+b,function(e){if(e.success){a.phonePrefix=b.substring(0,7);
var d=JSON.parse(e.msg);a.addressService.init({country:"ChinaCityCateType-root",province:d.provinceCateKey,city:d.cityCateKey,area:"",});}});}var c=new CsPhone();
if(b){if(c._checkIsPhone(b)){c.findCsByPhone(b,function(e){if(e&&e.success){var f=JSON.parse(e.msg);var d="号码重复，客户["+f.code+"]已拥有该号码";$(".tip").text(d).show();
a.isExist=true;}else{$(".tip").hide();a.isExist=false;}});}}});$(document).on("change","select[name=country_],select[name=province_],select[name=city_],select[name=area_],select[name=town_]",function(){var b=$("div.partyAddrEdidddddtForm");
var c=b.find("select[name=country_] option:selected").text();if(b.find("select[name=province_]").val()){c+="-"+b.find("select[name=province_] option:selected").text();
}if(b.find("select[name=city_]").val()){c+="-"+b.find("select[name=city_] option:selected").text();}if(b.find("select[name=area_]").val()){c+="-"+b.find("select[name=area_] option:selected").text();
}if(b.find("select[name=town_]").val()){c+="-"+b.find("select[name=town_] option:selected").text();}b.find(".addrDetaileDescribe").text(c);});}};function AddressService(a){this.container=a;
this.isHideCountry=false;}AddressService._CONS_={CATE_TYPE_KEY:"AddressCateType",ROOT_KEY:"AddressCateType-root"};AddressService.prototype={init:function(b,a){if(!b||!b.isNotRequired){$("#"+this.container).empty().append("<div class='col-sm-12'><label class='control-label col-sm-2'>所在地<span style='color:red;'>*</span></label><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.isSelect&&b.isSelect=="y"){$("#"+this.container).empty().append("<div class='col-sm-12'><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.rowFit&&b.rowFit=="y"){$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-11 container' style='padding-left:0px !important;'></div>");
}else{$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-6 container'></div></div>");}}}this.params=b;
this._bindEventHandler();if(b.isHideCountry){self.isHideCountry=b.isHideCountry;this._loadProvinces("ChinaCityCateType-root");}else{this._loadCountrys();
}if(a&&typeof(a)=="function"){a();}},getAddress:function(){var e=$("#"+this.container).find('select[name="country_"]').val();var a=$("#"+this.container).find('select[name="province_"]').val();
var d=$("#"+this.container).find('select[name="city_"]').val();var c=$("#"+this.container).find('select[name="area_"]').val();var b=$("#"+this.container).find("select[name='town_']").val();
return{country:e,countryName:$("#"+this.container).find('select[name="country_"]').find('option[value="'+e+'"]').text(),province:a,provinceName:$("#"+this.container).find('select[name="province_"]').find('option[value="'+a+'"]').text(),city:d,cityName:$("#"+this.container).find('select[name="city_"]').find('option[value="'+d+'"]').text(),area:c,areaName:$("#"+this.container).find('select[name="area_"]').find('option[value="'+c+'"]').text(),town:b,townName:b?$("#"+this.container).find("select[name='town_']").find("option[value='"+b+"']").text():"",};
},isValid:function(b){var a=true;$("#"+this.container).find("select").each(function(){var c=$(this).attr("name");var e=$(this).val();if(!e&&c!="town_"){a=false;
var d="";switch(c){case"country_":d="请选择国家";break;case"province_":d="请选择省份";break;case"city_":d="请选择城市";break;case"area_":d="请选择区县";break;}DialogUtils.error(msgCode.ERROR,d,b);
return false;}});return a;},_loadCountrys:function(){this._loadCates(AddressService._CONS_.ROOT_KEY,"country_");},_loadProvinces:function(a){this._loadCates(a,"province_");
},_loadCitys:function(a){this._loadCates(a,"city_");},_loadAreas:function(a){this._loadCates(a,"area_");},_loadTowns:function(a){this._loadCates(a,"town_");
},_loadCates:function(c,d){var a=this;var b=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm";b+="?cateType="+AddressService._CONS_.CATE_TYPE_KEY+"&parentKey="+c;
FormUtils.loadData(b,function(h){if(h.success){if(h.msg!=null&&h.msg!=""){var j=new StringBuffer();var g=JSON.parse(h.msg);if(g&&g.length>0){j.append("<div class='col-sm-2' style='padding-left:0px !important;'>");
j.append("<select class='form-control' name='"+d+"'>");j.append("<option value=''>请选择</option>");for(var e=0;e<g.length;e++){var f="";if(a.params){switch(d){case"country_":if(g[e].value==a.params.country){f="selected='selected'";
}break;case"province_":if(g[e].value==a.params.province){f="selected='selected'";}break;case"city_":if(g[e].value==a.params.city){f="selected='selected'";
}break;case"area_":if(g[e].value==a.params.area){f="selected='selected'";}break;case"town_":if(g[e].value==a.params.town){f="selected='selected'";}break;
}}j.append("<option "+f+" idValue='"+g[e].id+"' value='"+g[e].value+"'>"+g[e].name+"</option>");}j.append("</select>");j.append("</div>");$("#"+a.container).find(".container").append(j.toString());
if(a.params&&a.params.disabled){$("#"+a.container).find(".container").find("select").attr("disabled","disabled");}if(a.params){switch(d){case"country_":if(a.params.country&&!a.isHideCountry){a._loadProvinces(a.params.country);
}break;case"province_":if(a.params.province){a._loadCitys(a.params.province);}break;case"city_":if(a.params.city){a._loadAreas(a.params.city);}break;case"area_":if(a.params.area){a._loadTowns(a.params.area);
}break;}}}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHandler:function(){var a=this;$("#"+this.container).off("change",'select[name="country_"]');
$("#"+this.container).off("change",'select[name="province_"]');$("#"+this.container).off("change",'select[name="city_"]');$("#"+this.container).off("change","select[name='area_']");
$("#"+this.container).find("select[name='area_']").off("change");$("#"+this.container).on("change",'select[name="country_"]',function(){a.params=null;var b=$(this).val();
if(b){$(this).parent().nextAll().remove();a._loadProvinces(b);}else{$("#"+a.container).find("select[name=province_]").empty().append("<option value=''>请选择</option>");
$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="province_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadCitys(b);}else{$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="city_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadAreas(b);}else{$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");}$.log("change");});$("#"+this.container).on("change","select[name='area_']",function(){a.params=null;
var b=$(this).val();if(b){$(this).parent().nextAll().remove();a._loadTowns(b);}else{$("#"+a.container).find("select[name='town_']").empty().append("<option value=''>请选择</option>");
}$.log("change");});}};var StoreUtils={loadStores:function(f,a,e,c){var b=this;var d={selectedStore:f,container:a,isSale:e,notShowStore:c};b.loadData(d);
},loadData:function(e){var b=this;var a=ctx+"/ec/stock/stStore/listStores.htm";var d=e.isSale;if(d){a+="?isSale=y";}var c=window.sessionStorage.getItem("loacalstores"+(d?"isSale":""));
if(c&&c!=null&&c!=""){b._apendData(e,JSON.parse(c));}else{FormUtils.loadData(a,function(f){window.sessionStorage.setItem("loacalstores"+(d?"isSale":""),JSON.stringify(f));
b._apendData(e,f);});}},_apendData:function(d,j){var k=d.callBackFunc?d.callBackFunc:null;var f=d.selectedStore?d.selectedStore:null;var a=d.container;
var g=d.notShowStore?d.notShowStore:null;var b=isManyStore?isManyStore:"y";var h=new StringBuffer();if(b=="y"){h.append("<option value=''>请选择仓库</option>");
}for(var e=0;e<j.length;e++){if(g&&j[e].id==g){continue;}if(b=="n"){if(j[e].isDefault=="y"){h.append("<option selected='selected' value='"+j[e].id+"'>"+j[e].name+"</option>");
}}else{if(j[e].id==f){h.append("<option selected='selected' value='"+j[e].id+"'>"+j[e].name+"</option>");}else{h.append("<option value='"+j[e].id+"'>"+j[e].name+"</option>");
}}}var c=$("#"+a);if(!c.length){c=$("."+a);}c.empty().append(h.toString());if(b=="n"){c.trigger("change");}if(k&&typeof(k)=="function"){k(j);}},loadSimpleStores:function(a){return StoreUtils.loadStores("",a.container);
}};var MaskPhoneNum={getMaskPhoneNum:function(a){if(a){if(a.length>=11){return a.substring(0,3)+"******"+a.substring(9,a.length);}else{if(a.length>6&&a.length<11){return a.substring(0,1)+"******"+a.substring(7,a.length);
}else{if(a.length>3&&a.length<=6){return a.substring(0,1)+"***"+a.substring(4,a.length);}}}}return"";},maskEmail:function(a){var c=new StringBuffer();if(a){var b=a.indexOf("@");
if(b>2){c.append(a.substring(0,b-2)).append("**").append(a.substring(b));}else{if(b>=1){c.append(a.substring(0,b-1)).append("*").append(a.substring(b));
}}}return c.toString();},maskAddr:function(b){var a=new StringBuffer();if(b){if(b.length>25){b=b.replace(b.substring(7,15),"*****");}else{if(10<b.length<=25){b=b.replace(b.substring(6,13),"*****");
}else{if(0<b.length<=10){b=b.replace(b.substring(5,6),"****");}}}}return b;},maskDesc:function(a){if(a){a=a.replace(" ","");a=a.trim().replaceAll("\\d{11}","***********");
}return a;}};var ShipCompanyUtils={getOptions:function(c){var b=this;var a=window.sessionStorage.getItem("loacalShipCompany");if(a&&a!=null&&a!=""){b._appendData(c,JSON.parse(a));
}else{FormUtils.loadData(ctx+"/ec/ship/shipCompany/allActiveCompany.htm",function(d){window.sessionStorage.setItem("loacalShipCompany",JSON.stringify(d));
b._appendData(c,d);});}},_appendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);if(f.length==0){f=$("select[name='"+c.container+"']");
if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}if(a&&a.length>0){if(c.fn){c.fn(a);
}else{var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].id;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("' hotVar='").append(a[d].isHot).append("' selected='selected'>").append(b).append("</option>");
}else{g.append("<option value='").append(e).append("' hotVar='").append(a[d].isHot).append("'>").append(b).append("</option>");}}f.empty().append(g.toString());
}}if(c.callBack&&typeof c.callBack=="function"){c.callBack();}}};function CsFollow(){this.hadInit=false;this.needTable=true;this.fn=null;this.employeeId="";
this.csType="";this.permissionType="";this.partyInfo=null;this.followType="";this.contentExt="";this.isWeixin=false;}CsFollow._CONS_={EDIT_URL:ctx+"/crm/cs/csFollow/edit.htm",DELETE_URL:ctx+"/crm/cs/csFollow/delete.htm",SAVE_ADD_URL:ctx+"/crm/cs/csFollow/saveAdd.htm",SAVE_EDIT_URL:ctx+"/crm/cs/csFollow/saveEdit.htm",LIST_DATA_URL:ctx+"/crm/cs/csFollow/findByCsId.htm",EDIT_FORM_ID:"csFollowForm"};
CsFollow.prototype={init:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._bindFormValidation();}if(b){this.needTable=b.needTable;
this.fn=b.fn;this.employeeId=b.employeeId;this.csType=b.csType;this.permissionType=b.permissionType;this.followType=b.followType;this.contentExt=b.contentExt;
this._initInputAndOption(b);if(b.isWeixin){this.isWeixin=b.isWeixin;}if(b.shipQry){this.entityId=b.entityId;this.soNo=b.soNo;this.csPhone=b.csPhone;this._addFollowBtn();
}}if(this.needTable){this._initTable();}this.partyInfo=a;},clear:function(c){var a=this;b();function b(){var d=$("#csFollowForm");d.find('input[name="hasTask"]').val(["n"]).trigger("change");
d.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");var e=document.querySelector(".js-switch");
var f=new Switchery(e,{className:"switchery switchery-small"});d.find("[name=csFollowId]").val("");d.find("#followType option:first").prop("selected","selected");
d.find("#satisfy option:first").prop("selected","selected");d.find("[name=content]").val("");d.find("#taskTimeDiv").hide();d.find("#followEmployeeDiv").hide();
d.find("input[name=taskTime]").val("").removeClass("validate_input_error");d.find("input[name=partyShow]").val("").removeClass("validate_input_error");
d.find("input[name=partyId]").val("");d.find("input[name=employeeAid]").val("");}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();
},_save:function(){var h=this;var d=$("#csFollowForm");var a=d.find("[name=csFollowId]").val();var g=a?CsFollow._CONS_.SAVE_EDIT_URL:CsFollow._CONS_.SAVE_ADD_URL;
var f=new StringBuffer();var i=d.find("[name=type]").val();if(!$("#csFollowForm").valid()){return;}if("so"==this.followType){type="订单跟进";}var e=d.find("[name=content]").val();
e=e.replace("&","");d.find("[name=content]").val(e);var c="";if(this.contentExt){c=i+"："+this.contentExt+e;}else{c=i+"："+e;}var b={id:a,type:d.find("[name=type]").val(),content:encodeURI(d.find("[name=content]").val()),smsContent:encodeURI(d.find("[name=smsContent]").val()),contentExt:encodeURI(c),hasTask:d.find('input[name="hasTask"]').val(),satisfy:d.find("[name=satisfy]").val(),csId:d.find("input[name='csId']").val(),csCode:d.find("input[name='csCode']").val(),createAid:currentUserAid,entityId:$("#soEntityForm").find('input[name="id"]').val()||$("#csEntityForm").find('input[name="id"]').val()||this.entityId,seconds:d.find("[name=seconds]").val(),soNo:$("[name=soNo]").val()||this.soNo,isSms:$("[name=isSms]").val(),};
if(d.find("input[name=partyId]").val()&&d.find('input[name="hasTask"]').val()=="y"){b.taskTime=d.find("[name=taskTime]").val();b.partyId=d.find("input[name=partyId]").val();
b.employeeAid=d.find("input[name=employeeAid]").val();b.csPhone=d.find("input[name='csFollowPhone']").val()||$("#soEntityForm").find(".addrMobile").val()||this.csPhone;
b.status="new";}else{b.partyId=currentUserId;b.employeeAid=currentUserAid;b.status="done";}if(b.isSms=="y"){if(b.csPhone==""){DialogUtils.error(msgCode.FAIL_MSG,"该客户无手机号码，不能发送短信!");
return;}}FormUtils.submit(g,b,function(j){if(j.success){if(j.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(j.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}if(h.needTable){h._initTable();}if(h.fn&&(typeof h.fn=="function")){b.content=d.find("[name=content]").val();h.fn(b);}layer.close(h.layerIndex);h.clear();
if(h.isWeixin){$("#reload-follow").trigger("click");}}else{DialogUtils.error(msgCode.FAIL_MSG,j.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_bindEventHander:function(){var a=this;var b=$("#csFollowForm");$("#followRecordTab").on("click",".deleteCsFollow",function(){var c={csId:$(this).attr("csIdVal"),id:$(this).attr("idVal")};
DialogUtils.confirm(function(){FormUtils.submit(ctx+"/crm/cs/csFollow/delete.htm",c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,d.msg);
a._initTable();}});});});b.on("change","input[name='hasTask']",function(){if($(this).val()=="y"){b.find("#taskTimeDiv").hide();b.find("#followEmployeeDiv").hide();
b.find("#smsContentDiv").hide();b.find("input[name=partyShow]").removeClass("validate_input_error");b.find("input[name=taskTime]").removeClass("validate_input_error");
$(this).val("n");$("#isSmsDivContainer").hide();$("input[name='isSms']").val("n");b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");
var d=document.querySelector(".js-switch2");var f=new Switchery(d,{className:"switchery switchery-small"});layer.style(a.layerIndex,{height:"250px"});}else{b.find("#taskTimeDiv").show();
b.find("#followEmployeeDiv").show();var c=$(".followCount").height();layer.style(a.layerIndex,{height:"310px"});$(this).val("y");if(a.partyInfo){b.find("input[name=partyId]").val(a.partyInfo.partyId);
b.find("input[name=employeeAid]").val(a.partyInfo.partyAid);b.find("input[name=partyShow]").val(a.partyInfo.partyAid+":"+a.partyInfo.partyName);}else{b.find("input[name=partyId]").val(currentUserId);
b.find("input[name=employeeAid]").val(currentUserAid);b.find("input[name=partyShow]").val(currentUserAid+":"+currentUserName);}var e=new Date();now=e.current();
b.find("input[name=taskTime]").val(now.substr(0,16));$("#isSmsDivContainer").show();}});b.on("change","input[name='isSms']",function(){if($(this).val()=="y"){$(this).val("n");
b.find("#smsContentDiv").hide();layer.style(a.layerIndex,{height:"310px"});}else{$(this).val("y");b.find("#smsContentDiv").show();var c=$(".followCount").height();
layer.style(a.layerIndex,{height:"400px"});}});b.on("click",".selectEmployee",function(){$("input[name=partyShow]").removeClass("validate_input_error");
var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:1,isOnlySelfGroup:1,callBack:function(f){if(f!=null||f.length>0){b.find("input[name=partyShow]").val(f[0].aid+"："+f[0].name);
b.find("input[name=partyId]").val(f[0].id);b.find("input[name=employeeAid]").val(f[0].aid);}}};var d=new EmployeesSelect();d.init(e);});$(document).on("click","#followTaskTime",function(){b.find("input[name=taskTime]").removeClass("validate_input_error");
});$(document).on("click",".appendFollow",function(){$(this).hide();$("#csFollowFormDiv").show();});$('select[name="suffix"]').on("change",function(){a._initTable();
});$(document).on("click",".saveAddFollow",function(){if(a.valid()){a._save();}});$(document).on("click","#addFollowBtn",function(){a._addFollowBtn();});
},_addFollowBtn:function(){var a=this;var b="form-config-layer";ButtonUtils.disableBtn("addFollowBtn");layer.close(a.layerIndex);a.layerIndex=layer.open({type:1,skin:"followCount",title:"跟进记录",shade:false,btn:["保存","取消"],area:["650px","auto"],offset:"10%",content:$(".csFollowEdit"),scrollbar:true,skin:b,success:function(c,d){ButtonUtils.enableBtn("addFollowBtn");
},yes:function(d,c){if(a.valid()){a._save();}},btn2:function(){a.clear();}});},_initTable:function(){var a=this;if(!a._hasPermission()){return;}var b=CsFollow._CONS_.LIST_DATA_URL+"?csId="+csId+"&suffix="+$("select[name='suffix']").val();
var d="";if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){d="<th width='7%'>操作</th>";
}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){d="<th width='7%'>操作</th>";
}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){d="<th width='7%'>操作</th>";}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){d="<th width='7%'>操作</th>";
}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){d="<th width='7%'>操作</th>";}}}}}}$("#csFollowDiv").empty().append("<table class='table table-striped table-bordered' id='csFollowTable'>            <thead>                <tr>                    <th width='3%'></th>                    <th width='15%'>主题</th>                    <th width='35%'>待办内容</th>                    <th width='10%'>安排人</th>                    <th width='10%' >跟进人</th>                    <th width='10%'>记录时间</th>                    <th width='10%'>跟进时间</th>                    "+d+"                </tr>            </thead>        </table>");
var c=[{data:"lineNum",width:"3%"},{data:"type",},{data:"content",render:function(g,f,e){if(ResUtils.canShow("csEntity.button.viewFollowPhone")){return e.content;
}else{return MaskPhoneNum.maskDesc(e.content);}}},{data:"createName",render:function(g,f,e){if(e.createName.indexOf("null")>-1){return"[已删除]";}else{return e.createName;
}}},{data:"partyName",render:function(g,f,e){if(e.partyName.indexOf("null")>-1){return"[已删除]";}else{return e.partyName;}}},{data:"createTime",render:function(g,f,e){if(e.createTime){return DateUtils.miniTime(e.createTime);
}else{return"";}}},{data:"taskTime",render:function(g,f,e){if(e.taskTime){return DateUtils.miniTime(e.taskTime);}else{return"";}}},];if(a.csType){if("self"==a.csType||(a.permissionType&&"self"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteMyself")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("mysub"==a.csType||(a.permissionType&&"mysub"==a.permissionType)){if(ResUtils.canShow("csFollow.button.deleteSub")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("task"==a.csType){if(ResUtils.canShow("csFollow.button.deleteTask")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}else{if("callRecord"==a.csType){if(ResUtils.canShow("csFollow.button.deleteCallRecord")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<button class='btn btn-danger btn-sm btn-outline deleteCsFollow' csIdVal='"+e.csId+"' idVal='"+g+"' type='button' title='删除'><i class='fa fa-remove'></i></button>";
}});}}else{if(ResUtils.canShow("csFollow.button.deleteSearch")){c.push({data:"id",width:"7%",render:function(g,f,e){return"<i class='fa fa-remove deleteCsFollow' title='删除' csIdVal='"+e.csId+"' idVal='"+g+"'style='color: red; cursor: pointer;'></i>";
}});}}}}}}$("#csFollowTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:true,ordering:true,order:[[5,"desc"]]});
},valid:function(){var a=true;var b=$("#csFollowForm");if(!b.valid()){a=false;}var c=b.find("[name = hasTask]:checkbox").val();if(c=="y"){if(!b.find("input[name=partyShow]").val()){b.find("input[name=partyShow]").addClass("validate_input_error");
a=false;}if(!b.find("input[name=taskTime]").val()){b.find("input[name=taskTime]").addClass("validate_input_error");a=false;}}return a;},_enableInput:function(){var b=$("#csFollowForm");
b.find("#followType").attr("disabled",false);b.find("#followContent").attr("readonly",false);b.find("[name=hasTask]").attr("disabled",false);b.find("#followTaskTime").attr("disabled",false);
b.find("#satisfy").attr("disabled",false);b.find("#seconds").attr("disabled",false);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});b.find(".selectEmployee").show();$(".appendFollow").show();
$("#csFollowFormDiv").hide();},_initInputAndOption:function(f){var b=$("#csFollowForm");b.find("input[name=csId]").val(f.csId);b.find("input[name=csCode]").val(f.csCode);
b.find("input[name=contentExt]").val(f.contentExt);b.find("#hasTaskDiv").empty().append("<input name='hasTask' value='n' type='checkbox' class='js-switch' />");
b.find("#isSmsDiv").empty().append("<input name='isSms' value='n' type='checkbox' class='js-switch2' />");var d=document.querySelector(".js-switch");var e=new Switchery(d,{className:"switchery switchery-small"});
var a=document.querySelector(".js-switch2");var c=new Switchery(a,{className:"switchery switchery-small"});if("so"==this.followType){b.find("#followType").empty().append("<option value='订单跟进'>订单跟进</option>");
if(ResUtils.canShow("soEntity.button.addFollowBtn")){$(".addFollow").show();}else{$(".addFollow").hide();}}else{CateUtils.getOptions({typeKey:"system",pKey:"CsFollowType",container:"followType",fn:function(h){var j=new StringBuffer();
if(h&&h.length>0){for(var g=0;g<h.length;g++){j.append("<option value='"+h[g].value+"'>"+h[g].name+"</option>");}}b.find("#followType").append(j.toString());
}});if(this.csType){$(".addFollow").show();if("self"==this.csType||(this.permissionType&&"self"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtn")){$(".addFollow").hide();
}}else{if("mysub"==this.csType||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.addFollowBtnSub")){$(".addFollow").hide();
}}else{if("task"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnTask")){$(".addFollow").hide();}}else{if("callRecord"==this.csType){if(!ResUtils.canShow("csEntity.button.addFollowBtnCallRecord")){$(".addFollow").hide();
}}else{if(!ResUtils.canShow("csEntity.button.addFollowBtnSearch")){$(".addFollow").hide();}}}}}if(f.fn&&typeof f.fn=="function"){f.fn();}}}},_bindFormValidation:function(){var a={rules:{"content":{required:true,maxlength:1023},"seconds":{required:true,min:0},}};
FormUtils.bindFormValidation("csFollowForm",a);},_initFollowEmp:function(){var a=$("#csFollowForm");a.find("[name=content]").attr("disabled",false);a.find("input[name=partyShow]").val(currentUserAid+"："+currentUserName);
a.find("input[name=partyId]").val(currentUserId);a.find("input[name=employeeAid]").val(currentUserAid);},_prodSearch:function(a){$("#partyShow").bsSuggest("destroy");
if(a==null||a==""){return;}var b=this;$("#searchProd").bsSuggest({url:ctx+"/crm/ou/employee/selectEmployee.htm",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"姓名"},showBtn:false,idField:"id",keyField:"name",autoSelect:false,getDataMethod:"url",listStyle:{"padding-top":0,"max-height":"500px","max-width":width,"overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onDataRequestSuccess",function(d,c){b.searchProds=c.value;
}).on("onSetSelectValue",function(f,c){for(var d=0;d<b.searchProds.length;d++){if(b.searchProds[d].skuId==c.id){b.currentProd=b.searchProds[d];break;}}$("#searchProd").val("");
}).on("onUnsetSelectValue",function(c){b.searchProds=[];b.currentProd={};});},_initEmployeeSuggest:function(){var a=this;$("input[name='partyShow']").bsSuggest({url:ctx+"/crm/ou/employee/search.htm?grantType=/cs/&keyword=",effectiveFields:["aid"],searchFields:["aid"],effectiveFieldsAlias:{aid:"工号"},showBtn:false,idField:"id",keyField:"aid",getDataMethod:"url",processData:function(b){var e={value:[]};
if(b&&b.value){for(var d=0;d<b.value.length;d++){var c=b.value[d];e.value.push({id:c.id,aid:c.aid+"："+c.name});}}return e;},listStyle:{"padding-top":0,"max-height":"500px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"}}).on("onSetSelectValue",function(d,b){var c=$("#csFollowForm");
c.find("input[name=partyId]").val(b.id);c.find("input[name=employeeAid]").val(b.aid);});},_hasPermission:function(){var a=true;if("self"==type||(this.permissionType&&"self"==this.permissionType)){}else{if("mysub"==type||(this.permissionType&&"mysub"==this.permissionType)){if(!ResUtils.canShow("csEntity.button.viewFollowSub")){a=false;
}}else{if("task"==type){if(!ResUtils.canShow("csEntity.button.viewFollowTask")){a=false;}}else{if("callRecord"==type){if(!ResUtils.canShow("csEntity.button.viewFollowCallRecord")){a=false;
}}else{if(!ResUtils.canShow("csEntity.button.viewFollowSearch")){a=false;}}}}}return a;}};function CsPhonePanel(){this.hadInit=false;this.csName="";this.soStatus="";
}CsPhonePanel._CONS_={FIND_PHONES_URL:ctx+"/crm/cs/csEntity/findPhonesByCsId.htm",FIND_CS_BY_PHONE:ctx+"/crm/cs/csEntity/getByPhone.htm",EDIT_CS_NAME:ctx+"/crm/cs/csEntity/editCsName.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",};
CsPhonePanel.prototype={init:function(b,a){if(!this.hadInit){this.hadInit=true;this._bindEventHandler();}this.soStatus=a;this._initForm();this._fillData(b);
},_bindEventHandler:function(){var a=this;var b=$("#csPhonePanel");b.on("click",".callPhone",function(){var c=b.find("[name=phoneSelect]").find("option:selected").attr("attr-phone");
if(c.startsWith("020")){c=c.substring(3);}window.top.jtCtiService.dialout("9"+c);});b.on("click",".callPhoneAddZero",function(){var c=b.find("[name=phoneSelect]").find("option:selected").attr("attr-phone");
var d=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;if(c.startsWith("020")){c=c.substring(3);}if(d.test(c)){window.top.jtCtiService.dialout("90"+c);
}else{window.top.jtCtiService.dialout("9"+c);}});b.on("click",".sendMessage",function(){var d=b.find("[name=csId]").val();var g=b.find("[name=phoneSelect]").val();
var f=b.find("[name=phoneSelect]").find("option:selected").text();var e=new SendMessage();var c={csId:d,number:g,maskNum:f};e.openSendMessageView(c);});
b.on("change","[name=phoneSelect]",function(){var c=$(this).find("option:selected").attr("attr-type");b.find("[name=phoneType]").val(c);});b.on("click","[name=csName]",function(){a.csName=$(this).val();
$(this).removeClass("validate_input_error");});b.on("blur","[name=csName]",function(){if(ResUtils.canShow("soEntity.button.editCsName")){if($(this).val()){if(a.csName!=$(this).val()){a._editCsName();
}}else{$(this).addClass("validate_input_error");DialogUtils.error("提示","请填写客户名称");}}});b.on("click",".csCode",function(){var c=b.find("[name=csId]").val();
JTTabUtils.addOrRefreshTab(CsPhonePanel._CONS_.DETAIL_CS_PAGE_URL+"?csId="+c,"客户明细");});b.on("click",".changeEmployee",function(){a._changeEmployee();});
$(document).on("click","#servicePhoneBtn",function(d){var c=$(this).attr("masknum");if(c&&c!=""){if(c.startsWith("020")){c=c.substring(3);}window.top.jtCtiService.dialout("9"+c);
}else{DialogUtils.error(msgCode.ERROR,"没有此快递公司的客服电话");return;}});},_changeEmployee:function(){var a=this;var d=$("#csPhonePanel");var b=0;if(ResUtils.canShow("employeeSelector.button.cs")){b:1;
}var e={isShowAllGroup:b,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,callBack:function(g){if(g!=null){if(g.length>0){var i=d.find("input[name=employeeAid]").val();
d.find("input[name=employeeId]").val(g[0].id);d.find("input[name=employeeAid]").val(g[0].aid);d.find("input[name=csBelong]").val(g[0].aid+"："+g[0].name);
var f=[];f.push({employeeId:g[0].id,csEntityIds:d.find("input[name=csId]").val()});var h={soId:$("input[name=id]").val(),comment:"签收转工号，从工号"+i+"转到工号"+g[0].aid};
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(f),csType:"csEntity",soInfo:JSON.stringify(h)},function(j){if(j.success){DialogUtils.success("提示",j.msg);
}else{DialogUtils.error("失败",j.msg);}});}}}};var c=new EmployeesSelect();c.init(e);},maskPhoneNum:function(a){if(a){return PhoneEncryptUtils.encryptPhone(a);
}return"";},_loadPhones:function(b,c){var a=this;FormUtils.loadData(CsPhonePanel._CONS_.FIND_PHONES_URL+"?csId="+b,function(d){if(d&&d.length>0){if(c&&typeof c==="function"){c(d);
}}});},_editCsName:function(){var a=$("#csPhonePanel");$.ajax({type:"GET",url:CsPhonePanel._CONS_.EDIT_CS_NAME+"?csId="+a.find("[name=csId]").val()+"&csName="+a.find("[name=csName]").val(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(b){if(b.success){DialogUtils.success("成功","修改客户名字成功");
}}});},_descryptPhoneNum:function(a,d,c){var b={number:a,callback:c,};DecryptHelper.decrypt(b);},_fillData:function(c){var a=this;if(c){var b=$("#csPhonePanel");
b.find("[name=csId]").val(c.id);b.find("[name=csName]").val(c.name);if(!ResUtils.canShow("soEntity.button.editCsName")){b.find("[name=csName]").attr("readonly",true);
}b.find(".csCode").text(c.code);b.find("[name=csBelong]").val(c.employeeAid+"："+c.employeeName);b.find("[name=employeeId]").val(c.employeeId);b.find("[name=employeeAid]").val(c.employeeAid);
a._loadPhones(c.id,function(f){var g=new StringBuffer();var d=false;for(var e=0;e<f.length;e++){if("停用"!=f[e].type){g.append("<option value='"+f[e].number+"' attr-type='"+f[e].type+"' attr-phone = '"+f[e].phone+"'>"+f[e].maskPhone+"</option>");
}if(!d){b.find("[name=phoneType]").val(f[0].type);d=true;}}b.find("[name=phoneSelect]").append(g.toString());b.find("#callPhoneDiv").show();});$("input[name=pointUsable]").val(c.pointUsable);
}},_initForm:function(){var a=$("#csPhonePanel");a.find("[name=csId]").val("");a.find("[name=csName]").val("");a.find("[name=csBelong]").val("");a.find("[name=phoneSelect]").val("");
a.find("#callPhoneDiv").hide();if(this.soStatus&&"complete"==this.soStatus&&ResUtils.canShow("soEntity.button.completeChangeEmp")){a.find(".changeEmployee").show();
}}};function SoCustomer(){this.hadInit=false;this.csName="";}SoCustomer._CONS_={EDIT_CS_NAME:ctx+"/crm/cs/csEntity/editCsName.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",GET_CS_MODEL_URL:ctx+"/crm/rfmt/rfmtModel/getCsRfmtModelPo.htm"};
SoCustomer.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=this;var c=$("input[name='status']").val();if(c&&ResUtils.canShow("soEntity.button.completeChangeEmp")){$(".changeEmployee").show();
}ConfigUtils.findByKey("system.version.name",function(d){if("旗舰版"==d.msg){a.initCsRfmt(b);}});this._bindEventHandler();}},_bindEventHandler:function(){var b=this;
var a=$("#csEntityDiv");a.on("click",".callPhone",function(){var c=a.find("[name=phoneSelect]").find("option:selected").val();CallerHelper.call(c,function(d){var e=d;
if(d.startsWith("020")){e=d.substring(3);}else{e=d;}window.top.jtCtiService.dialout("9"+e);});});a.on("click",".callPhoneAddZero",function(){var c=a.find("[name=phoneSelect]").find("option:selected").val();
var d=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;CallerHelper.call(c,function(e){var f=e;if(e.startsWith("020")){f=e.substring(3);}else{f=e;}if(d.test(f)){window.top.jtCtiService.dialout("90"+f);
}else{window.top.jtCtiService.dialout("9"+f);}});});a.on("click",".sendMessage",function(){var d=a.find("[name=csId]").val();var g=a.find("[name=phoneSelect]").val();
var f=a.find("[name=phoneSelect]").find("option:selected").text();var e=new SendMessage();var c={csId:d,number:g,maskNum:f};e.openSendMessageView(c);});
a.on("change","[name=phoneSelect]",function(){var c=$(this).find("option:selected").attr("attr-type");a.find("[name=phoneType]").val(c);});a.on("click",".csName",function(){b.csName=$(this).val();
$(this).removeClass("validate_input_error");});a.on("blur",".csName",function(){if(ResUtils.canShow("soEntity.button.editCsName")){if($(this).val()){if(b.csName!=$(this).val()){b._editCsName();
}}else{$(this).addClass("validate_input_error");DialogUtils.error("提示","请填写客户名称");}}});a.on("click",".changeEmployee",function(){b._changeEmployee();});
$(document).on("click",".csCode",function(){var c=a.find("[name=csId]").val();JTTabUtils.addOrRefreshTab(SoCustomer._CONS_.DETAIL_CS_PAGE_URL+"?csId="+c,"客户明细");
});$(document).on("click","#servicePhoneBtn",function(d){var c=$(this).attr("masknum");if(c&&c!=""){if(c.startsWith("020")){c=c.substring(3);}window.top.jtCtiService.dialout("9"+c);
}else{DialogUtils.error(msgCode.ERROR,"没有此快递公司的客服电话");return;}});},_changeEmployee:function(){var b=this;var a=$("#csEntityDiv");var c=0;if(ResUtils.canShow("employeeSelector.button.cs")){c:1;
}var e={isShowAllGroup:c,grantType:"/cs/",isMultiple:0,mode:0,isSale:1,callBack:function(g){if(g!=null){if(g.length>0){var i=a.find("input[name=employeeAid]").val();
a.find("input[name=employeeId]").val(g[0].id);a.find("input[name=employeeAid]").val(g[0].aid);a.find("input[name=csBelong]").val(g[0].aid+"："+g[0].name);
var f=[];f.push({employeeId:g[0].id,csEntityIds:a.find("input[name=csId]").val()});var h={soId:$("input[name=id]").val(),comment:"签收转工号，从工号"+i+"转到工号"+g[0].aid};
FormUtils.submit(ctx+"/crm/cs/csEntity/saveAssign.htm",{resultJson:JSON.stringify(f),csType:"csEntity",soInfo:JSON.stringify(h)},function(j){if(j.success){DialogUtils.success("提示",j.msg);
}else{DialogUtils.error("失败",j.msg);}});}}}};var d=new EmployeesSelect();d.init(e);},_editCsName:function(){var a=$("#csEntityDiv");$.ajax({type:"GET",url:CsPhonePanel._CONS_.EDIT_CS_NAME+"?csId="+a.find("[name=csId]").val()+"&csName="+a.find(".csName").val(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(b){if(b.success){DialogUtils.success("成功","修改客户名字成功");
}}});},initCsRfmt:function(b){var a=this;var c=new StringBuffer();FormUtils.loadData(SoCustomer._CONS_.GET_CS_MODEL_URL+"?csId="+b,function(d){if(d){c.append("【客户价值："+parseInt(d.rate*100)+"。RFMT分类："+d.rfmt+"("+d.rfmtType+")。营销分类："+d.rfmtSuggest+"】");
$("#csInfoRfmt").empty().append(c.toString());}});}};function SendMessage(){this.hadInit=false;}SendMessage._CONS_={LIST_DATA_URL:ctx+"/gl/sms/smsRecord/findByCsId.htm",SEND_MSG_URL:ctx+"/gl/sms/smsRecord/sendMsg.htm",SEND_ALI_TEMPLATE_URL:ctx+"/gl/sms/smsRecord/sendAliTemplateMsg.htm",RE_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/resend.htm",JUDGE_IS_PHONE_URL:ctx+"/crm/cs/csEntity/judgeIsPhone.htm",BATCH_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/batchSendMsg.htm",DIV:"#smsRecordGridDiv",GRID:"#smsRecordGrid",PAGER:"#smsRecordPager",GRID_ID:"smsRecordGrid",PAGER_ID:"smsRecordPager"};
SendMessage.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}this._initSelectPlatformType();},_initSelectPlatformType:function(){if("y"==isOpenSelectPlatform){$("body").find(".smsSelectPlatformDiv").show();
}else{$("body").find(".smsSelectPlatformDiv").remove();}},_bindEventHander:function(){var a=this;$("body").on("click",".resendMsg",function(){a.reSendMsg($(this).attr("attr-id"));
});$("body").on("click",".deleteMsgBtn",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/sms/smsRecord/delete.htm",{ids:b},function(){a.initTable(a.initParam);
});});});},initTable:function(e){var a=this;a.initParam=e;$("#sendMessageForm").find("[name=sendContent]").attr("disabled",false);var d="";if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){d="<th>操作</th>";
}$("#smsRecordDiv").empty().append("<table class='table table-bordered table-stripped' id='smsRecordTable'>            <thead>                <tr>                    <th></th>                    <th>手机号码</th>                    <th>短信内容</th>                    <th>收发</th>                    <th>平台</th>                    <th>结果</th>                    <th>发送人</th>                    <th>时间</th>"+d+"</tr>            </thead>        </table>");
var b=SendMessage._CONS_.LIST_DATA_URL+"?csId="+e.csId;var c=[{data:"lineNum"},{data:"mobile"},{data:"content"},{data:"type",render:function(f){if(f=="send"){return"<span class='text-success'>发送</span>";
}else{return"<span class='text-primary'>收到</span>";}}},{data:"platform",render:function(g){var f="短信猫";if(g){if(g.startsWith("gst")){f="高斯通";}else{if(g.startsWith("lsm")){f="螺丝帽";
}else{if(g.startsWith("ali")){f="阿里";}}}}return f;}},{data:"result",render:function(f,h,g){if(f=="SUCCESS"){return"<span class='text-success'>成功</span>";
}else{if(f=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";}else{if(f=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";
}else{if(f.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}else{if(f.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}}}}}}},{data:"employeeAid",render:function(h,g,f){if(f.type=="send"){return h;}else{return"无";}}},{data:"createTime"}];if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){c.push({data:"createTime",width:"10%",render:function(h,g,f){return"<button class='btn btn-sm btn-danger btn-outline deleteMsgBtn' idVal='"+f.id+"' type='button'>删除</button>";
}});}$("#smsRecordTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"asc"]]});
},openSendMessageView:function(c){var a=this;a.initForm();$("#sendMessageModalLabel").text("TO："+c.maskNum);var b=$("#sendMessageForm");b.find("[name=csId]").val(c.csId);
b.find("[name=sendPhoneNum]").val(c.number);b.find("[name=replyId]").val(c.replyId);$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){var d=b.find("[name=sendContent]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var e=new CateOptService();e.isHasSensitiveWord(d,function(j){if(j.isCanSendMsg!=null&&!j.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+j.msg,$("#sendMessageContainer"));
}else{var g=b.find("[name=csId]").val();var h=b.find("[name=sendPhoneNum]").val();var f=b.find("[name=replyId]").val();var i=b.find("[name=selectPlatformType]").val();
var k={csId:g,phone:h,sendContent:encodeURIComponent(d),selectPlatformType:i,replyId:f};$("#sendStatus").text("发送中...");FormUtils.submit(SendMessage._CONS_.SEND_MSG_URL,k,function(l){if(l.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,l.msg);$("#sendMessageContainer").modal("hide");}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});}});});},openBatchSendMessageView:function(c){var a=this;a._initSelectPlatformType();$("#sendMessageModalLabel").html("批量发短信&emsp;<span>批量给<font style='color:red;'>【"+c.csIds.length+"个】</font>个客户发短信<span>");
var b=$("#sendMessageForm");b.find("[name=sendContent]").val("");$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){DialogUtils.confirmWithOptions({title:"确定批量发短信？",text:"",confirmButtonText:"确定",yesFunc:function(){var f=c.csIds;
var d=b.find("[name=sendContent]").val();var e=b.find("[name=selectPlatformType]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var g=new CateOptService();g.isHasSensitiveWord(d,function(h){if(h.isCanSendMsg!=null&&!h.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+h.msg,$("#sendMessageContainer"));
}else{var i={"sendContent":encodeURIComponent(d),"csIds":f,selectPlatformType:e};FormUtils.submit(SendMessage._CONS_.BATCH_SEND_MSG_URL,i,function(j){if(j.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,j.msg);}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,j.msg);}},null);}});}});});},openAilTemplateMessageView:function(b){var a=this;
$("#aliTemplateModalCsIds").val(b.csIds);a.getAliTemplateSms();$("#aliTemplateModal").modal("show");$("#aliTemplateModal").removeAttr("tabindex");},initForm:function(){var a=$("#sendMessageModalLabel");
a.find("[name=csId]").val("");a.find("[name=sendPhoneNum]").val("");a.find("[name=sendContent]").val("");a.find(".tabli").removeClass("active").eq(0).addClass("active");
a.find(".tab-pane").removeClass("active").removeClass("in").eq(0).addClass("active").addClass("in");this._initSelectPlatformType();},reSendMsg:function(d){var a=this;
var b=SendMessage._CONS_.RE_SEND_MSG_URL;var c={"ids":d};DialogUtils.success(msgCode.SUCCESS,"发送中...");FormUtils.submit(b,c,function(e){if(e.success){a.initTable(a.initParam);
DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},null,true);},getTplOptions:function(c){var a=this;if(!c.type||!c.cateId){return;
}var b=window.sessionStorage.getItem("t9-ecm-loacaltpl"+c.type+c.cateId);if(b&&b!=null&&b!=""){a._apendData(c,JSON.parse(b));}else{FormUtils.loadData(ctx+"/gl/tpl/glTpl/findTplByTypeAndCateId.htm?type="+c.type+"&cateId="+c.cateId,function(d){window.sessionStorage.setItem("t9-ecm-loacaltpl"+c.type+c.cateId,JSON.stringify(d));
a._apendData(c,d);});}},getAliTemplateSms:function(){FormUtils.loadData(ctx+"/gl/tpl/glTpl/findAliTemplateSms.htm",function(a){var c=new StringBuffer();
if(a.length>0){var c=new StringBuffer();c.append('<option value="">请选择</option>');for(var b=0;b<a.length;b++){c.append("<option value='"+a[b].type+"' content='"+a[b].content+"'>"+a[b].templateName+"</option>");
}$(".aliTemplateModalSelect").empty().append(c.toString()).select2();}});},_apendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);
if(f.length==0){f=$("select[name='"+c.container+"']");if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");
}if(a&&a.length>0){var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].tplContent;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("'>").append(b).append("</option>");}else{g.append("<option value='").append(e).append("'>").append(b).append("</option>");
}}f.empty().append(g.toString());}f.off("change").on("change",function(){var h=c.fn;if(h&&typeof h==="function"){h(f.val());}});}};function CateOptService(){}CateOptService._CONS_={};
CateOptService.prototype={isHasSensitiveWord:function(b,a){var c={};$.ajax({type:"GET",url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=smsSensitiveWord",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){b=b.replace(/\s/g,"");
if(d&&d.length>0){for(var e=0;e<d.length;e++){if(b.indexOf(d[e].value)>-1){c.isCanSendMsg=false;c.msg=d[e].value;}}}if(a){a(c);}},error:function(d){if(a){a(c);
}}});}};function CsPhone(){this.hadInit=false;}CsPhone._CONS_={FIND_PHONES_URL:ctx+"/crm/cs/csEntity/findPhonesByCsId.htm",FIND_CS_BY_PHONE:ctx+"/crm/cs/csEntity/getByPhone.htm",GET_PHONE_AREA:ctx+"/crm/cs/csPhoneArea/getArea.htm",VALID_PHONE:ctx+"/crm/cs/csEntity/validPhoneIsUsed.htm",DELETE_PHONE:ctx+"/crm/cs/csEntity/deletePhone.htm",};
CsPhone.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindEventHandler();}},_bindEventHandler:function(){var a=this;$(".showInvalidPhone").on("click",function(){$(this).hide();
$(".hideInvalidPhone").show();$("#invalidPhoneNumDiv").show();});$(".hideInvalidPhone").on("click",function(){$(this).hide();$(".showInvalidPhone").show();
$("#invalidPhoneNumDiv").hide();});$(document).on("click",".addCsPhone",function(){$("#phoneNumDiv").append(a.genNewTemplate());});$("#phoneNumDiv").on("click",".removePhone",function(){$(this).parents(".form-group").remove();
});$("#phoneNumDiv").on("click",".makePhone",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;}$(".makePhone").addClass("BtnFlag");
$(".makePhoneAddZero").addClass("BtnFlag");}var f=$(this).attr("attr-num");var d=new Date().getTime()+"";var c="";var g=JTEncoder.encode(f);var e=JTEncoder.encode(f+c+d);
var b=CryptoUtils.encrypt(g+e,f,d);var h={number:f,encoder1:g,encoder2:e,checkCode:b,randomCode:d,};if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");
$(".makePhoneAddZero").removeClass("BtnFlag");},5000);}});$("#phoneNumDiv").on("click",".makePhoneAddZero",function(){if(isOpenCallOutBtnInternal){if($(this).hasClass("BtnFlag")){return;
}$(".makePhone").addClass("BtnFlag");$(".makePhoneAddZero").addClass("BtnFlag");}var b=$(this).attr("attr-num");var c=/^(((1[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{9})$/;
FormUtils.loadData(CsPhone._CONS_.CALL_PHONE_URL+"?number="+b,function(e){var d=e.msg.toString();if(d.startsWith("020")){b=d.substring(3);}else{b=d;}if(c.test(b)){window.top.jtCtiService.dialout("90"+b);
}else{window.top.jtCtiService.dialout("9"+b);}});if(isOpenCallOutBtnInternal){setTimeout(function(){$(".makePhone").removeClass("BtnFlag");$(".makePhoneAddZero").removeClass("BtnFlag");
},5000);}});$("#phoneNumDiv").on("click",".sendMessage",function(){var f=this;var c=$("#csEntityForm").find("[name=id]").val();var d=new SendMessage();
var e=$(f).attr("attr-num");if(!e){e=$(f).parent().parent().parent().parent().find(".newPhone").val();var b={csId:c,number:e,maskNum:e,fn:function(g){d.initTable({csId:g});
}};d.openSendMessageView(b);}else{var b={csId:c,number:e,maskNum:$(f).attr("attr-maskNum"),fn:function(g){d.initTable({csId:g});}};d.openSendMessageView(b);
}});$("#phoneNumDiv").on("click",".viewPhone",function(){var c=this;var b=$(this).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DECRYPT_NUMBER_URL+"?number="+b,function(e){var d=e.msg;
$(c).parent().parent().parent().find(".oldPhone").val(d);});});$(document).on("blur",".newPhone",function(){var e=this;var c=$(e).val();var d=$(e).parent().next().find("select").val();
$(e).parents(".form-group").eq(0).find("p").text("").hide();$(e).parents(".form-group").eq(0).find(".tip").text("").hide();if(c){if(a._checkIsPhone(c,d)){a._getPhoneArea(c,function(f){$(e).parents(".form-group").eq(0).find(".tip").css("color","green").text(f.province+f.city).show();
});a.findCsByPhone(c,function(g){if(g&&g.success){var h=JSON.parse(g.msg);var f="号码重复，客户["+h.code+"]已拥有该号码";$(e).parents(".form-group").eq(0).find("p").text(f).show();
}});}else{if(d=="座机"){if(!a._checkIsTel(c)){var b="座机号格式错误";$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text(b).show();}}else{$(e).parents(".form-group").eq(0).find(".tip").css("color","red").text("非手机类型请选座机").show();
}}}});$(document).on("change",".phoneType",function(){$(this).attr("attr-hasChange","true");var b=$(this).parent().prev().find(".newPhone");if(b){b.trigger("blur");
}});$("#phoneNumDiv").on("click",".deletePhone",function(){var b=this;DialogUtils.confirmWithOptions({title:"是否要删除选中的联系电话",text:"点击确认将删除，并无法恢复",confirmButtonText:"确认",yesFunc:function(){var c=$("#csEntityForm").find("[name=id]").val();
var d=$(b).attr("attr-num");FormUtils.loadData(CsPhone._CONS_.DELETE_PHONE+"?number="+d+"&csId="+c,function(e){if(e.success){DialogUtils.success("成功","删除号码成功");
$(b).parents(".form-group").remove();}else{DialogUtils.error("失败","删除号码失败");}});}});});},_getTypeSelectStr:function(a,c){var b=this;var d=new StringBuffer();
d.append("<select class='form-control phoneType' "+(a?" disabled='disabled'":"''")+">");if(c&&"首选"==c){d.append("<option value='首选' selected>首选</option>");
}else{d.append("<option value='首选'>首选</option>");}if(c&&"停用"==c){d.append("<option value='停用' selected>停用</option>");}else{d.append("<option value='停用'>停用</option>");
}if(c&&"本人"==c){d.append("<option value='本人' selected>本人</option>");}else{d.append("<option value='本人'>本人</option>");}if(c&&"老公"==c){d.append("<option value='老公' selected>老公</option>");
}else{d.append("<option value='老公'>老公</option>");}if(c&&"老婆"==c){d.append("<option value='老婆' selected>老婆</option>");}else{d.append("<option value='老婆'>老婆</option>");
}if(c&&"家人"==c){d.append("<option value='家人' selected>家人</option>");}else{d.append("<option value='家人'>家人</option>");}if(c&&"他人"==c){d.append("<option value='他人' selected>他人</option>");
}else{d.append("<option value='他人'>他人</option>");}if(c&&"朋友"==c){d.append("<option value='朋友' selected>朋友</option>");}else{d.append("<option value='朋友'>朋友</option>");
}if(c&&"座机"==c){d.append("<option value='座机' selected>座机</option>");}else{d.append("<option value='座机'>座机</option>");}d.append("</select>");return d.toString();
},_getCsPhoneButtonStr:function(c){var e=new StringBuffer();if("actived"==c.status){var d=ctx+"/img/jt/phone.png'";var a=ctx+"/img/jt/phoneAddZero.png";
var b=ctx+"/img/jt/message.png";e.append("<div class='col-sm-4' style='display: inline;'>");if(ResUtils.canShow("csEntity.button.deletePhone")||ResUtils.canShow("csEntity.button.deletePhoneSub")||ResUtils.canShow("csEntity.button.deletePhoneSearch")||ResUtils.canShow("csEntity.button.deletePhoneTask")){e.append("<span style='line-height:30px;''><i class='fa fa-remove deletePhone' title='删除号码'' style='color: red; cursor: pointer;'' attr-num='"+c.number+"' ></i></span>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneBtn")||ResUtils.canShow("csEntity.button.callPhoneBtnSub")||ResUtils.canShow("csEntity.button.callPhoneBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='本地号码' src='"+d+"' class='makePhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.callPhoneAddZeroBtn")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSub")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnSearch")||ResUtils.canShow("csEntity.button.callPhoneAddZeroBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='外地号码加0' src='"+a+"' class='makePhoneAddZero' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if(ResUtils.canShow("csEntity.button.sendMsgBtn")||ResUtils.canShow("csEntity.button.sendMsgBtnSub")||ResUtils.canShow("csEntity.button.sendMsgBtnSearch")||ResUtils.canShow("csEntity.button.sendMsgBtnTask")){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='短信' src='"+b+"' class='sendMessage' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>&nbsp;");
}if((ResUtils.canShow("soDeliver.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtn")||ResUtils.canShow("csEntity.button.viewPhoneBtnSub")||ResUtils.canShow("csEntity.button.viewPhoneBtnSearch")||ResUtils.canShow("csEntity.button.viewPhoneBtnTask"))&&c.number){e.append("<a style='cursor:hand'><img style='width:20px; height:20px;' title='查看联系电话明文' src='"+ctx+"/img/jt/view.png' class='viewPhone' attr-maskNum='"+c.maskPhone+"' attr-num='"+c.number+"'/></a>");
}e.append("</div>");}else{e.append("<span class='col-sm-3' style='color:red;line-height:30px;'>无效号码</span>");}return e.toString();},initTemplate:function(b){var a=this;
var c=new StringBuffer();c.append("<div class='form-group'>");c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control oldPhone' attr-id='"+b.id+"' validateType='default' value='"+b.maskPhone+"' readonly>");
c.append("<input type='hidden' value='"+b.number+"' readonly>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr("actived"!=b.status,b.type));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genInTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control' validateType='default' value='"+a.maskPhoneNum(b.phone)+"' readonly>");
c.append("<input type='hidden' readonly class='newPhone' value='"+b.phone+"'>");c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));
c.append("</div>");c.append(this._getCsPhoneButtonStr(b));c.append("<span class='col-sm-1' style='color:red;line-height:30px;'>通话</span>");c.append("<span class='col-sm-3 tip' style='color:green;line-height:30px;'>"+b.province+b.city+"</span>");
c.append("</div>");c.append("</div>");return c.toString();},genNewTemplate:function(b){var a=this;var c=new StringBuffer();c.append("<div class='form-group'>");
c.append("<div class='col-sm-12'>");c.append("<div class='col-sm-3'>");c.append("<input type='text' placeholder='联系电话' class='form-control newPhone' validateType='default' value=''>");
c.append("</div>");c.append("<div class='col-sm-2'>");c.append(this._getTypeSelectStr(false));c.append("</div>");if(!b){c.append("<span class='col-sm-1' style='line-height:30px;'><i class='fa fa-remove removePhone' title='删除号码' style='color: red; cursor: pointer;'></i></span>");
}c.append("<span class='col-sm-3 tip' style='line-height:30px;'></span>");if(b){c.append("<div class='col-sm-1'>");c.append("<button type='button' class='btn btn-sm btn-outline btn-primary addCsPhone'>添加</button>");
c.append("</div>");}c.append("</div>");c.append("</div>");c.append("<p class='ceshi' style='color:red;display:none;'></p>");return c.toString();},csPhoneData2Json:function(){var f=$(".newPhone");
var h=$(".oldPhone");var c=[];if(f&&f.length>0){for(var d=0;d<f.length;d++){if($(f[d]).val()){var e=$(f[d]).parent().next().find("select").val();var g=$.trim($(f[d]).val());
var b=$(f[d]).parent().next().next().find("input").val();if(e=="座机"&&g.indexOf("&")>-1){g=g.substr(0,g.indexOf("&"));}var a={id:"",pk:"",phone:g,type:e,linkman:b};
c.push(a);}}}if(h&&h.length>0){for(var d=0;d<h.length;d++){var e=$(h[d]).parent().next().find("select").val();var g=$(h[d]).next().val();var b=$(f[d]).parent().next().next().find("input").val();
if("true"==$(h[d]).parent().next().find("select").attr("attr-hasChange")){var a={id:$(h[d]).attr("attr-id"),pk:$(h[d]).attr("attr-id"),phone:"",number:g,type:e,linkman:b};
c.push(a);}}}return JSON.stringify(c);},bindFormValidation:function(){var a={rules:{"phone":{required:true,mobile:true,maxlength:["20"],}}};FormUtils.bindFormValidation("csPhoneAdd",a);
},maskPhoneNum:function(a){if(a){return PhoneEncryptUtils.encryptPhone(a);}return"";},loadData:function(b){var a=this;FormUtils.loadData(CsPhone._CONS_.FIND_PHONES_URL+"?csId="+b.csId,function(f){var e=new StringBuffer();
var d=new StringBuffer();if(f&&f.length>0){for(var c=0;c<f.length;c++){if("actived"==f[c].status){e.append(a.initTemplate(f[c])+"");$("#csFollowForm").find("input[name='csFollowPhone']").val(f[c].number);
}else{d.append(a.initTemplate(f[c],false)+"");}}}$("#phoneNumDiv").empty().append(e.toString());$("#phoneNumDiv").append(a.genNewTemplate(true));$("#invalidPhoneNumDiv").empty().append(d.toString());
if(d.toString().length>0){$(".showInvalidPhone").show();}else{$(".showInvalidPhone").hide();}if(b.fn&&typeof b.fn=="function"){b.fn();}},function(){},true);
},_checkIsPhone:function(a,c){if(c&&("微信"==c)){return true;}if(c&&("座机"==c)){return false;}var b=/^(1+\d{10})$/;if(b.test(a)){return true;}return false;
},_checkIsTel:function(a,c){if(c!="座机"&&c!=undefined){return false;}if(a.length<=6){return false;}else{if(a.startsWith("0")){return true;}else{if(isCheckQuhao&&isCheckQuhao=="y"){var b=/(^[0-9]*)$/;
if(b.test(a)){return true;}return false;}else{return true;}}}},_descryptPhoneNum:function(a,c,b){$.ajax({type:"GET",url:CsPhone._CONS_.DESCRYPT_PHONE_NUM+"?number="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success&&b&&typeof b=="function"){b(d.msg);
}}});},findCsByPhone:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.FIND_CS_BY_PHONE+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(b&&typeof b=="function"){b(c);
}}});},_getPhoneArea:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.GET_PHONE_AREA+"?phone="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d.success){if(b&&typeof b=="function"){var c=JSON.parse(d.msg);
b(c);}}}});},vaildPhondIsUsed:function(a,b){$.ajax({type:"GET",url:CsPhone._CONS_.VALID_PHONE+"?phones="+a.toString(),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c.success){b();
}else{DialogUtils.error("错误","新增的手机号码重复");}}});},};var SelectProdService={selectSku:function(o){var n=o&&o.storeId;var f=o.isMultiple;var k=o.type;var m=o.hasStock;
var e=o.canSale;var b=o.hideCanSale;var j=o.isSale;var d=o.limitProdCate;var i=o.priceType;var h=o.userId;var l=o.showNotOnSale;var g=o.filterSeries;var c=o.agentId;
if(!m){m="n";}if(!k){k="product";}if(!n){n="";}if(!b){b="n";}if(!d){d="n";}if(!j){j="n";}if(!i){i="";}if(!e){e="n";}if(!l){l="n";}if(!c){c="";}var a=ctx+"/ec/product/prodEntity/selectSku.htm?";
a+="storeId="+n;a+="&isMultiple="+f;a+="&type="+k;a+="&hasStock="+m;a+="&hideCanSale="+b;a+="&limitProdCate="+d;a+="&priceType="+i;a+="&canSale="+e;a+="&isSale="+j;
a+="&userId="+h;a+="&showNotOnSale="+l;a+="&filterSeries="+g;a+="&agentId="+c;layer.open({type:2,title:"选择商品",maxmin:true,shadeClose:true,btn:["确定","取消"],area:["95%","95%"],scrollbar:false,maxmin:false,content:a,yes:function(q,p){var s=layer.getChildFrame("body",q);
var r=$("#selectedRowData",s).val();if(r&&r.length){layer.close(q);if(o.fn){o.fn(JSON.parse(r));}}else{DialogUtils.error("警告","请选择商品！或者点击取消",s);}},end:function(){if(o.end){o.end();
}}});},selectProd:function(a){var b=a.isMultiple;layer.open({type:2,title:"选择商品",shadeClose:true,btn:["确定","取消"],area:["80%","80%"],scrollbar:false,content:ctx+"/ec/product/prodEntity/selectProd.htm?isMultiple="+b,yes:function(e,c){var j=layer.getChildFrame("body",e);
var d=$("#prodEntityGrid",j).jqGrid("getGridParam","selarrrow");if(d){var h=[];for(var f=0;f<d.length;f++){var g=$("#prodEntityGrid",j).jqGrid("getRowData",d[f]);
g.prodId=d[f];g.prodName=g.name;h.push(g);}layer.close(e);if(a.fn){a.fn(h);}}}});}};function TplPrint(){this.hadInit=false;}TplPrint._CONS_={EDIT_URL:ctx+"/crm/components/upload/download.htm",ENTITY_INFO_URL:ctx+"/gl/tpl/tplPrint/getTplInfo.htm",ADD_TPL_URL:ctx+"/gl/tpl/tplPrint/addTpl.htm",ENTITY_PRINT_DATA_URL:ctx+"/gl/tpl/tplPrint/getPrintData.htm",};
TplPrint.prototype={init:function(a){},loadTplFuc:function(b,a,d,c){loadTpl(TplPrint._CONS_.EDIT_URL+"?dname="+a+"&durl="+d,b,c);},saveReport:function(c,b){c.Post();
var a=c.Report.SaveToStr();$.ajax({type:"POST",url:TplPrint._CONS_.ADD_TPL_URL+"?id="+b,data:a,contentType:"text/html",dataType:"json",success:function(d){if(d.success){alert(d.msg);
DialogUtils.success(msgCode.INFO,d.msg);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},error:function(d){console.log(d);}});c.DefaultAction=false;},loadEntityInfo:function(b,c,d){c=c.split(",");
var a=this;$.ajax({type:"GET",url:TplPrint._CONS_.ENTITY_INFO_URL+"?entityId="+c[0]+"&entityType="+d,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.path){var f=e.path.substr(e.path.lastIndexOf("/")+1,e.path.length);
a.loadTplFuc(b,f,e.path,function(){a.loadPrintData(b,c,d);});}else{alert("找不到模板");}},error:function(e){console.log(e);}});},loadEntityShipInfo:function(c,d,e,a){d=d.split(",");
var b=this;$.ajax({type:"GET",url:TplPrint._CONS_.ENTITY_INFO_URL+"?entityId="+d[0]+"&entityType="+e+"&proxyType="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f.path){var g=f.path.substr(f.path.lastIndexOf("/")+1,f.path.length);
b.loadTplFuc(c,g,f.path,function(){b.loadPrintShipData(c,d,e);});}else{alert("找不到模板");}},error:function(f){console.log(f);}});},loadPrintData:function(b,c,d){var a=this;
b.Stop();$.ajax({type:"GET",url:TplPrint._CONS_.ENTITY_PRINT_DATA_URL+"?entityId="+c+"&entityType="+d,contentType:"application/x-www-form-urlencoded",dataType:"text",success:function(e){b.Report.LoadDataFromXML(e);
b.Start();},error:function(e){console.log(e);}});},loadPrintShipData:function(b,c,d){var a=this;b.Stop();$.ajax({type:"GET",url:TplPrint._CONS_.ENTITY_PRINT_DATA_URL+"?entityId="+c+"&entityType="+d,contentType:"application/x-www-form-urlencoded",dataType:"text",success:function(e){b.Report.LoadDataFromXML(e);
b.Start();},error:function(e){console.log(e);}});},};function SoEntityExport(){this.hadInit=false;this.params="";}SoEntityExport._CONS_={EXPORT_ASYNCHRO:ctx+"/ec/salesorder/soEntity/exportAsynchronous.htm",EXPORT_PACK_URL:ctx+"/ec/salesorder/soEntity/exportPack.htm",EXPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportSoEntityModule.htm",EXPORT_PRODUCT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportSoProduct.htm",EXPORT_EMPPROD_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEmpProduct.htm",EXPORT_EMPSOPROD_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEmpSoProduct.htm",EXPORT_EDIANBAO_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportEDianBao.htm",EXPORT_YANWEN_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportYwSoShip.htm",ISRECPHONE:false};
SoEntityExport.prototype={init:function(a){this.params=a;if(!this.params.selectIds){this.params.selectIds="";}this.openExportLayer();if(!this.hadInit){this._bindEventHander();
}this.hadInit=true;ConfigUtils.findByKey("soEntity.isReceivePhone",function(b){if(b.success){SoEntityExport._CONS_.ISRECPHONE=true;}});},_bindEventHander:function(){$("#selectAll").on("change",function(){var c=$(this)[0].checked;
var b=$("#columnContainer").find(".columnCheckBox");for(var a=0;a<b.length;a++){b[a].checked=c;}});},openExportLayer:function(){var a=this;a.layerIndex=layer.open({type:1,title:"订单导出",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["导出","取消"],area:["70%","70%"],content:$(".soEntityExportPane"),success:function(b,c){a._initData();
},yes:function(d,f){var i=$("input[name='startCount'").val();var c=$("input[name='endCount'").val();var b=parseInt($("input[name='maxCount'").val());if(b<1){DialogUtils.error(msgCode.FAIL_MSG,"导出数量不能小于1");
return false;}if(c==""||c==null||i==""||i==null){DialogUtils.error(msgCode.FAIL_MSG,"导出数量不能小于1");return false;}c=parseInt(c);i=parseInt(i);if(i>c||c>b||i>b||c<0||i<0){DialogUtils.error(msgCode.FAIL_MSG,"请填写正确的订单数量。最大值不能大于"+b);
return false;}if(c-i>100000){DialogUtils.error(msgCode.FAIL_MSG,"一次导出订单不能超过100000条，请分批导出！");return false;}var j=a._exportParams(i,c);var e=$("input[name='exportType']:checked").val();
if(!j&&!e=="soAndProd"){DialogUtils.error(msgCode.FAIL_MSG,"请选择要导出的字段");return false;}DialogUtils.success(msgCode.SUCCESS,"正在导出....");layer.close(a.layerIndex);
var k=$("input[name='fileType']:checked").val();if(e=="soAndProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_PRODUCT_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(e=="csAndProd"||e=="empAndProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EMPPROD_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(e=="csAndSoProd"||e=="empAndSoProd"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EMPSOPROD_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="edianbaoExcel"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_EDIANBAO_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="yanwenShipExcel"){FormUtils.submit(SoEntityExport._CONS_.EXPORT_YANWEN_EXCEL_URL,a.params.params+j+"&selectIds="+a.params.selectIds+"&exportType="+e,function(l){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);}else{if(k=="module"){window.location.href=SoEntityExport._CONS_.EXPORT_EXCEL_URL+"?"+a.params.params+j+"&selectIds="+a.params.selectIds;return;
}else{var h=SoEntityExport._CONS_.EXPORT_ASYNCHRO;var g=a.params.requestQueryParams?("?"+a.params.requestQueryParams):"";h=h+g;FormUtils.submit(h,a.params.params+j+"&selectIds="+a.params.selectIds,function(l){if(!l.success){DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);},true);}}}}}}window.top.showTimming(c-i);},cancel:function(){}});},_initData:function(){$("input[name='exportType']")[0].checked=true;
$("input[name='fileType']")[0].checked=true;this._initColoms();this._initCount();},_initColoms:function(){var a=[];var b=LocalStorageUtils.get("SO_EXPORT_COLUMNS_"+currentUserId);
if(b){a=b.split(",");}excelUtil.findExportColByModule("soEntity",true,function(d){var e=new StringBuffer();if(d&&d.length>0){for(var c=0;c<d.length;c++){if(d[c].devCode=="tranPhone"||d[c].devCode=="recPhone"){if(!SoEntityExport._CONS_.ISRECPHONE){continue;
}}e.append("<div class='checkbox checkbox-success checkbox-inline'>");if($.inArray(d[c].devCode,a)!=-1){e.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
}else{e.append("<input type='checkbox' class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
}e.append("</div>");}}$("#columnContainer").empty().append(e.toString());});},_initCount:function(){var b=this.params;var a=b.toatolCount;if(b.selectIds&&b.selectIds.length>0){a=b.selectIds.length;
}$("input[name='startCount'").val(1);$("input[name='endCount'").val(a);$("input[name='maxCount'").val(a);},_exportParams:function(d,g){var c="";var e=$("#columnContainer").find(".columnCheckBox");
var f=[];$(e).each(function(){if($(this).is(":checked")){f.push($(this).val());}});if(f.length<=0){return false;}var b=$("input[name='exportType']:checked").val();
var a=$("input[name='fileType']:checked").val();c="&columns="+f+"&startCount="+d+"&pageSize="+(g-d+1)+"&exportType="+b+"&fileType="+a;LocalStorageUtils.set("SO_EXPORT_COLUMNS_"+currentUserId,f.toString());
return c;},exportPack:function(a){var b=$(a).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要导出备货信息的订单");return null;
}FormUtils.submit(SoEntityExport._CONS_.EXPORT_PACK_URL,"soId="+b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"成功");window.location=ctx+c.msg+"?pw=42385A79697676502F512F33454F58333337794472513D3D";
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};var excelUtil={toGenExcel:function(a,b,c){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/toGenExcel.htm?module="+a+"&moduleText="+c,b);
},importExcel:function(a){if(a.isCreateSub){JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl+"&isCreateSub="+a.isCreateSub,a.tabTitle);
}else{JTTabUtils.addOrRefreshTab(ctx+"/gl/mc/moduleColumn/importExcel.htm?importUrl="+a.importUrl,a.tabTitle);}},findExportColByModule:function(c,b,d){var a=ctx+"/gl/mc/moduleColumn/findByModule.htm?module="+c;
if(b){a=ctx+"/gl/mc/moduleColumn/findGrantCol.htm?module="+c;}FormUtils.loadData(a,function(e){if(d){d(e);}});}};var SoEntityUtils={formatStatus:function(e){var b="";
var a=e.status;var d=e.delayConfirmTime;var c=e.delayShipTime;if(a=="awaiting_pay"){b="待支付";}else{if(a=="awaiting_post"){b="待提交";}else{if(a=="awaiting_comfirm"){if(d!=null){b="待审核"+"<span style='color:red;font-size: 8px;'>[延审]</span>";
}else{b="待审核";}}else{if(a=="comfirm"){if(c!=null){b="待发货"+"<span style='color:red;font-size: 8px;'>[延发]</span>";}else{b="待发货";}}else{if(a=="shipping"){b="已发货";
}else{if(a=="complete"){b="已签收";}else{if(a=="close"){b="已作废";}else{if(a=="close_reject"){b="已拒收";}else{if(a=="close_lost"){b="已丢失";}}}}}}}}}return b;},formatCashType:function(b){var a="";
if(b=="pay"){a="款到发货";}else{if(b=="pay_sub"){a="支付订金";}else{if(b=="green"){a="绿色通道";}else{if(b=="green_by"){a="绿色通道订金";}else{if(b=="cod"){a="货到付款";}else{if(b=="free"){a="免费已付";
}else{if(b=="point"){a="积分付款";}}}}}}}return a;},formatPayType:function(b){var a="";if(b=="alipay"){a="支付宝";}else{if(b=="weixin"){a="微信支付";}else{if(b=="weixinhongbao"){a="微信红包";
}else{if(b=="bank"){a="银行转账";}else{if(b=="cash"){a="现金支付";}else{if(b=="point"){a="积分支付";}}}}}}return a;},getTurnBackStr:function(b,a){var c="";switch(b){case"awaiting_post":if(!(a==null||a==""||a=="awaiting_post")){c="&nbsp;<span style='color:red'>撤</span>";
}break;case"awaiting_comfirm":if(!(a=="awaiting_post"||a=="awaiting_comfirm")){c="&nbsp;<span style='color:red'>撤</span>";}break;case"comfirm":if(!(a=="awaiting_post"||a=="awaiting_comfirm"||a=="awaiting_pay"||a=="comfirm")){c="&nbsp;<span style='color:red'>撤</span>";
}break;}return c;},confirm:function(b,a){window.localStorage.setItem("comfirm_"+currentUserId,b.toString());JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_TO_COMFIRM_URL+"?soId="+b[0],"订单["+a+"审核");
},toDeliver:function(a){window.localStorage.setItem("deliver_"+currentUserId,JSON.stringify(a));ConfigUtils.findByKey("soEntity.isEditSaveSo",function(b){if(b.success&&ResUtils.canShow("soEntity.button.saveSoComfirmBtn")){JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/waitToDeliver.htm?soId="+a[0].id,"订单["+a[0].soNo+"发货");
}else{JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_TO_DELIVER_URL+"?soId="+a[0].id,"订单["+a[0].soNo+"发货");}});},backDeliver:function(b,a){DialogUtils.confirmWithOptions({title:"确定撤销发货吗？",text:"",confirmButtonText:"确认",yesFunc:function(){var c=SoEntityUtils._CONS_.BACK_DELIVER_URL;
FormUtils.submit(c,{ids:b},function(d){if(d.success){DialogUtils.success(msgCode.INFO,"撤销发货成功");if(a&&typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});},confirmBatch:function(d,c,b){var a=SoEntityUtils._CONS_.COMFIRM_BATCH_URL;FormUtils.submit(a,{ids:d,isRepeatAudit:c,operComment:b,isBatch:"y"},function(e){if(e.success){DialogUtils.success(msgCode.INFO,e.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}$(".sowait_wrapper").find(".soEntitySearch").click();$(".so_delay_wrapper").find(".soEntitySearch").click();
},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},buildEmployeeOption:function(b,c,d){var a=d?d:"dept_manager";$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm?groupId="+b+"&type="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f&&f.length>0){var g=new StringBuffer();
g.append("<option value=''>请选择</option>");for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}if(c){$("#"+c).empty().append(g.toString());
}else{$("#belongEmployeeSearch").empty().append(g.toString());}}}});},trunDownOrderLayer:function(d,c,b){var a=this;layer.open({type:1,title:"订单驳回",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","450px"],content:$(".soEntityTurnDownPane"),success:function(e,f){var h=new StringBuffer();
for(var g=0;g<c.length;g++){if(g!=0){h.append("，");}h.append("<span style='line-height:30px;'>"+c[g]+"</span>");}$("#trunDownSaveReForm").find(".soNoDiv").empty().append(h.toString());
$("#trunDownSaveReForm").find("#soIds").val(d.toString());(function(){var i=this;$("#trunDownSaveReFormComment").bsSuggest("destroy");$("#trunDownSaveReFormComment").bsSuggest({url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=NotApprovedType",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"驳回备注"},showBtn:false,inputWarnColor:"",showHeader:false,idField:"id",keyField:"name",getDataMethod:"url",processData:function(l){var k,j,m={value:[]};
if(!l||l.records===0){return false;}j=l.length;for(k=0;k<j;k++){m.value.push({id:l[k].id,name:l[k].name});}return m;}});})();},yes:function(g,e){var f=$("#trunDownSaveReForm").find("input[name=trunDownSaveReFormComment]").val();
if(!f){DialogUtils.error("","请选择驳回原因");}else{FormUtils.submit(SoEntityUtils._CONS_.TURN_DOWN_URL,"soIds="+$("#trunDownSaveReForm").find("#soIds").val()+"&comment="+$("input[name=trunDownSaveReFormComment]").val(),function(h){if(h.success){DialogUtils.success(msgCode.INFO,h.msg);
$(".soEntitySearch").click();layer.close(g);if(b&&typeof b==="function"){b();}}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);layer.close(g);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},cancel:function(){FormUtils.clear("trunDownSaveReForm");}});},closeOrderLayer:function(d,c,b){var a=this;layer.open({type:1,title:"订单作废确认",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","450px"],content:$(".soEntityClosePane"),success:function(e,g){var j=new StringBuffer();
for(var h=0;h<c.length;h++){if(h!=0){j.append("，");}j.append("<span style='line-height:30px;'>"+c[h]+"</span>");}$("#closeSaveReForm").find(".soNoDiv").empty().append(j.toString());
$("#closeSaveReForm").find("#soIds").val(d.toString());var f={rules:{closeSaveReFormComment:{required:true,maxlength:["512"],}}};FormUtils.bindFormValidation("closeSaveReForm",f);
},yes:function(f,e){if($("#closeSaveReForm").valid()){FormUtils.submit(SoEntityUtils._CONS_.CLOSE_URL,"soIds="+$("#closeSaveReForm").find("#soIds").val()+"&comment="+$("textarea[name=closeSaveReFormComment]").val()+"&isNeddValid=y",function(g){if(g.success){DialogUtils.success(msgCode.INFO,g.msg);
if(b&&typeof b==="function"){b();}$(".soEntitySearch").click();layer.close(f);}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);layer.close(f);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},cancel:function(){FormUtils.clear("closeSaveReForm");}});},submit:function(b,a,c){JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.SO_PLACE_URL+"?soId="+b+"&type=self","订单["+a+"]提交");
},deleteSoEntity:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(SoEntityUtils._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"删除成功");
$(".end_wrapper").find(".soEntitySearch").click();}else{DialogUtils.error(msgCode.ERROR,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},lock:function(c,d,a){var b=this;FormUtils.submit(SoEntityUtils._CONS_.LOCK_URL,"soIds="+c,function(e){if(e.success){$("#soEntityForm").find("[name=isLock]").val("y");
DialogUtils.success(msgCode.INFO,e.msg);if(d){b.reloadJqgrid(d,selectedId);}if(typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},unLock:function(c,d,a){var b=this;FormUtils.submit(SoEntityUtils._CONS_.UNLOCK_URL,"soIds="+c,function(e){if(e.success){$("#soEntityForm").find("[name=isLock]").val("n");
DialogUtils.success(msgCode.INFO,e.msg);if(d){b.reloadJqgrid(d,selectedId);}if(typeof(a)=="function"){a();}}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},initDetail:function(a){var b=this;$(".csName").attr("readonly",true);$(".changeAddr").hide();
$(".addAddr").hide();$("#prod-price-type").hide();$("#hasStock").parent().hide();$("#searchProd").parents(".form-group").hide();$(".prodPrice").attr("readonly",true);
$(".soItemCount").attr("readonly",true);$("select[name=storeId]").attr("disabled",true);$(".delSoItem").hide();$("select[id=scCode]").attr("disabled",true);
$("select[name=cashType]").attr("disabled",true);$("select[name=isCloudWarehourse]").attr("disabled",true);$("select[name=payType]").attr("disabled",true);
$("select[name=soType]").attr("disabled",true);$("input[name=shippingAmount]").attr("readonly",true);$("input[name=subAmount]").attr("readonly",true);$("input[name=totalAmount]").attr("readonly",true);
$("input[name=waitPayAmount]").attr("readonly",true);$("#selectEmpBtn").hide();$(".soProfitPercent").attr("readonly",true);$(".delSoProfit").hide();$("select[name=isFast]").attr("disabled",true);
$("select[name=billType]").attr("disabled",true);$("input[name=billAmount]").attr("readonly",true);$("textarea[name=billTitle]").attr("readonly",true);
$("textarea[name=billContent]").attr("readonly",true);$("textarea[name=comment]").attr("readonly",true);$("select[name=account]").attr("disabled",true);
$("input[name=shipFollow]").attr("readonly",true);$(".othersDiv").find("#delayConfirmTime").attr("readonly",true);$(".updateSoFollow").hide();if(a&&a.length>0){$(".uploadImage").hide();
$("#imageContainer").empty().append(ImageUtils.createImageDivStr(a,null,true,true,true));var c=b.buildImages(a);$(".downLoadFile").find("img").ImageEnlarge({isNotShowImage:true,imageGroup:c});
}if($("input[name=status]").val()!="shipping"&&$("input[name=status]").val()!="close_lost"){$(".uploadImage").hide();}if($("select[name=cashType]").val()=="cod"||$("select[name=cashType]").val()=="free"||$("select[name=cashType]").val()=="point"){$(".financeAttachDiv").hide();
}ConfigUtils.findByKey("soEntity.isReceivePhone",function(d){if(d.success){$("#receivePhoneDiv").show();$("input[name=tranPhone]").attr("readonly",true);
$("input[name=recPhone]").attr("readonly",true);}else{$("#receivePhoneDiv").hide();}});$(".cashSettingDiv").hide();if($("input[name=cashCode]").val()){$(".cashSettingInfoDiv").show();
}},buildImages:function(b){var a=[];for(var c=0;c<b.length;c++){var d={href:ctx+b[c].path,title:(c+1)+" / "+b.length};a.push(d);}return a;}};SoEntityUtils._CONS_={LIST_URL:ctx+"/ec/salesorder/soEntity/listData.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",SO_TO_COMFIRM_URL:ctx+"/ec/salesorder/soEntity/toComfirm.htm",SO_TO_DELIVER_URL:ctx+"/ec/salesorder/soEntity/toDeliver.htm",BACK_DELIVER_URL:ctx+"/ec/salesorder/soEntity/backDeliver.htm",COMFIRM_BATCH_URL:ctx+"/ec/salesorder/soEntity/comfirm.htm",TURN_DOWN_URL:ctx+"/ec/salesorder/soEntity/turndown.htm",DELETE_URL:ctx+"/ec/salesorder/soEntity/delete.htm",CLOSE_URL:ctx+"/ec/salesorder/soEntity/close.htm",LOCK_URL:ctx+"/ec/salesorder/soEntity/lockSo.htm",UNLOCK_URL:ctx+"/ec/salesorder/soEntity/unLockSo.htm",SO_PLACE_URL:ctx+"/ec/salesorder/soEntity/place.htm",FOLLOW_PAGE:ctx+"/ec/salesorder/soEntity/toFollow.htm",EXCHANGEORBACK_URL:ctx+"/ec/salesorder/soEntity/exchange.htm",BATCHRECEIVED_URL:ctx+"/ec/salesorder/soEntity/batchReceived.htm",BACKRECEIVED_URL:ctx+"/ec/salesorder/soEntity/backReceived.htm",STOCK_MANY_URL:ctx+"/ec/salesorder/soEntity/stockForMany.htm",BACK_COMPLETE_URL:ctx+"/ec/salesorder/soEntity/backComplete.htm",REVISIT_PAGE_URL:ctx+"/ec/salesorder/soEntity/toRevisit.htm",IMPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importSoStatus.htm",FOLLOW:function(a,b){window.localStorage.setItem("follow_so_ids_"+currentUserId,a.toString());
window.localStorage.setItem("follow_so_nos_"+currentUserId,b.toString());JTTabUtils.addOrRefreshTab(SoEntityUtils._CONS_.FOLLOW_PAGE+"?soId="+a[0]+"&soNo="+b[0],"订单["+b[0]+"]跟进");
}};function EmployeesSelect(){}EmployeesSelect.prototype={init:function(b){var c=ctx+"/crm/ou/employee/selectEmployee.htm";var e=new StringBuffer();for(var a in b){if(a!="callBack"){e.append("&"+a+"="+b[a]);
}else{window.myCallBack=b.callBack;}}e.append("&treeNodeType=group");var d=e.toString();parent.layer.open({type:2,title:b.title?b.title:"选择员工",maxmin:false,shadeClose:true,btn:["确定","取消"],area:["85%","83%"],scrollbar:false,content:c+"?1=1"+d,success:function(f,g){f.myCallBack=b.callBack;
},end:function(){window.parent.myCallBack=null;},yes:function(j,g){var f=parent.layer.getChildFrame("body",j);var l=[];if(b&&b.isMultiple==1){var l=$("#employeeGrid",f).jqGrid("getGridParam","selarrrow");
}else{var n=$("#employeeGrid",f).jqGrid("getGridParam","selrow");if(n){l.push(n);}}if(l.length<0){DialogUtils.error(msgCode.ERROR,"请选择员工",f);return;}var m=[];
for(var k=0;k<l.length;k++){var h=$("#employeeGrid",f).jqGrid("getRowData",l[k]);h.id=l[k];m.push(h);}if(b.callBack){b.callBack(m);}parent.layer.close(j);
}});},initSelectComponent:function(a){function b(c){var d=null;if(c.container){if((typeof c.container)=="string"){d=$("#"+c.container);if(d.length==0){d=$("."+c.container);
if(d.length==0){d=$("[name='"+c.container+"']");if(d.length==0){d=null;throw Error(c.container+"容器不存在");}}}}else{if(c.container.length){d=c.container;}}}return d;
}FormUtils.loadData(ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+a.groupId+"",function(g){if(a.fn){a.fn(g);return;}var c=b(a);c.empty();if(a.buildSelector){var d='<select class="form-control '+a.buildSelector.className+'" name="'+a.buildSelector.name+'" ></select>';
var f=$(d);c.append(f);c=f;}var h=new StringBuffer();h.append("<option value=''>请选择</option>");if(g&&g.length){for(var e=0;e<g.length;e++){if(a.selectedIds&&a.selectedIds.indexOf(g[e].id)>-1){h.append("<option selected='selected' value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");
}else{h.append("<option value='"+g[e].id+"'>"+g[e].aid+":"+g[e].name+"</option>");}}}c.append(h.toString());if("chosen"==a.containerType){c.chosen("destroy");
c.chosen();}else{c.select2();}},null,true);},};$(function(){var a=new SoEntityDetail();a.init();});function SoEntityDetail(){this.soEntityBase=new SoEntityBase();
this.soEntityQueryLogistics=new SoEntityQueryLogistics();this.nextSoId="";this.preSoId="";this.preCsName="";this.nextCsName="";}SoEntityDetail._CONS_={SHIP_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/logicsByNo.htm",SAVE_ITEM_INFO_URL:ctx+"/ec/salesorder/soEntity/saveItemInfo.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",};
SoEntityDetail.prototype={init:function(){this.soEntityBase.init();if(isDetialPage=="y"){ConfigUtils.findByKey("system.isBanDelayConfirm",function(a){if(a.success){$(".othersDiv").hide();
}else{$(".othersDiv").show();}$(".delayConfirmTime").find(".simple-time-select").remove();});}SoEntityUtils.initDetail(financeBillAttachPos);this._bindEventHander();
$(".csName").attr("disabled",true);this._hideNotGrantBtn();CateUtils.getOptions([{typeKey:"system",pKey:"damageType",container:"damageType"},{typeKey:"system",pKey:"damageReason",container:"damageReason"}]);
if(!ResUtils.canShow("soFollow.button.addSoItemDamage")){$(".revokeDamage").hide();$(".addSoItemDamage").hide();}this.soEntityQueryLogistics.init();this._initPreNextBtn();
$(".uploadImage").hide();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mySoEntity.button.shipQry")&&!ResUtils.canShow("soEntitySearch.button.shipQry")){$(".shipQryBtn").hide();
}},_initPreNextBtn:function(){var b=this;var c=$("#soEntityForm").find("[name=soNo]").val();var h=$("#soEntityForm").find(".csName").val();var g=window.localStorage.getItem("detail_so_soNos"+currentUserId);
var a=window.localStorage.getItem("detail_cs_names"+currentUserId);if(g){var e=g.split(",");var f=a.split(",");for(var d=0;d<e.length;d++){if(c==e[d]){if(d>0){b.preSoId=e[d-1];
b.preCsNames=f[d-1];$(".preSoBtn").show();}if(d<e.length-1){b.nextSoId=e[d+1];b.nextCsNames=f[d+1];$(".nextSoBtn").show();}break;}}}},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));});
$(document).on("click",".preSoBtn",function(){var c=a.preCsNames+"的订单明细";var e=window.localStorage.getItem("detail_canModifyProfit"+currentUserId);var b=window.localStorage.getItem("detail_canShowScTrankNo"+currentUserId);
var f=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+$("input[name=soNo]").val()+"&canModifyProfit="+e+"&canShowScTrankNo="+b;var d=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.preSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
JTTabUtils.resetTab(f,d,c);window.location.href=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.preSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;});
$(document).on("click",".nextSoBtn",function(){var c=a.nextCsNames+"的订单明细";var e=window.localStorage.getItem("detail_canModifyProfit"+currentUserId);var b=window.localStorage.getItem("detail_canShowScTrankNo"+currentUserId);
var f=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+$("input[name=soNo]").val()+"&canModifyProfit="+e+"&canShowScTrankNo="+b;var d=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.nextSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
JTTabUtils.resetTab(f,d,c);window.location.href=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.nextSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
});$(document).on("click",".addSoItemDamage",function(){$("input[name=itemCount]").val($(this).attr("itemCount"));$("input[name=itemId]").val($(this).attr("itemIdVal"));
$("input[name=damageCount]").val($(this).attr("damageCountVal")==0?"1":$(this).attr("damageCountVal"));$("select[name=damageReason]").val($(this).attr("damageReasonVal"));
$("select[name=damageType]").val($(this).attr("damageTypeVal"));$("#damageModalContainer").modal("show");});$(document).on("click","#saveDamageBtn",function(){var b=this;
if($("input[name=damageCount]").val()<1){DialogUtils.error("提示","破损数量不能少于1");return;}if($("input[name=damageCount]").val()>$("input[name=itemCount]").val()){DialogUtils.error("提示","破损数量不能大于订单商品数量");
return;}if($("#damageReason").val()<1){DialogUtils.error("提示","破损原因不能为空");return;}if($("#damageType").val()<1){DialogUtils.error("提示","破损程度不能为空");return;
}$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageCount").val($("input[name=damageCount]").val());$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageReason").val($("#damageReason").val());
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageType").val($("#damageType").val());var c={"id":$("input[name=itemId]").val(),"damageCount":$("input[name=damageCount]").val(),"damageReason":$("#damageReason").val(),"damageType":$("#damageType").val(),};
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",true);FormUtils.submit(SoEntityDetail._CONS_.SAVE_ITEM_INFO_URL,c,function(d){if(d.success){$("#damageModalContainer").modal("hide");
DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").hide();
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".revokeDamage").show();}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",false);
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".revokeDamage",function(){var b=this;var d={"id":$(this).attr("itemIdVal"),"damageCount":0,"damageReason":null,"damageType":null,};
var c=$(this);FormUtils.submit(SoEntityDetail._CONS_.SAVE_ITEM_INFO_URL,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
c.prev().show();c.hide();c.prev().attr("disabled",false);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){$(".revokeDamage").attr("disabled",false);
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".soEntityDetailSubTab").on("click",".tabLi",function(d){var c=$(this).attr("attr-id");if("soEntityDetailSubTab-backOrExchangeTab"==c&&!a.backOrExchangeInit){var b=$("[name=id]").val();
if(b){a._loadBackOrExchangeTab(b);}a.backOrExchangeInit=true;}});},_loadBackOrExchangeTab:function(b){var a=ctx+"/ec/salesorder/soEntity/loadBackOrExchangeSoInfoPos.htm?id="+b;
FormUtils.loadData(a,function(g){if(g){var h=new StringBuffer();for(var e=0;e<g.length;e++){var d=g[e];var c="";if("exchange"==d.baseType){c="(换)";}else{if("back"==d.baseType){c="(退)";
}else{if("back_before_exchange"==d.baseType){c="(换前退)";}}}var f="";if(d.completeTime){if(d.completeTime=="null"){f="";}else{f=d.completeTime;}}h.append("<tr>");
h.append("<td>");h.append("<a href='#' title='"+d.soNo+"'  class='soTab' value='"+d.soNo+"' csIdVal='"+d.csId+"' attr-status='"+d.status+"' attr-placerId='"+d.placerId+"' attr-soType='"+d.soType+"' attr-id='"+d.id+"'>"+d.soNo+c+"</a>");
h.append("</td>");h.append("<td>"+d.scTrackingNo+"</td>");h.append("<td>"+d.partyName+"</td>");h.append("<td>"+d.partyAddr+"</td>");h.append("<td>"+d.partyMaskPhone+"</td>");
h.append("<td>"+d.totalAmount+"</td>");h.append("<td>"+d.prodNames+"</td>");h.append("<td>"+d.placeTime+"</td>");h.append("<td>"+f+"</td>");h.append("<td>"+SoEntityUtils.formatStatus(d)+"</td>");
h.append("<td>"+d.placerName+"</td>");h.append("<td>"+d.profits+"</td>");h.append("</tr>");}$("#tab-backOrExchange-tbody").empty().append(h.toString());
}},null,false);},};$(function(){var a=new SoEntityQueryLogistics();a.init();});function SoEntityQueryLogistics(){}SoEntityQueryLogistics._CONS_={SHIP_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/logicsByNo.htm",};
SoEntityQueryLogistics.prototype={init:function(){this._bindEventHander();},_bindEventHander:function(){var a=this;$(document).on("click",".main-page .nav div.queryPlatform",function(){var b=$(this);
$(".main-page .nav div").removeClass("on");b.addClass("on");});$(".queryLogistics").off("click").on("click",function(){$(".queryLogistics").attr("disabled",true);
var b="kuaidiwo";if($(".main-page .nav div.on").hasClass("queryPlatform")){b=$(".main-page .nav div.on").attr("id");}if(b=="shunfengkuaidi"||b=="jdkuaidi"){b="kuaidiwo";
}FormUtils.submit(SoEntityQueryLogistics._CONS_.SHIP_INFO_QRY_URL,"id="+$("#shipInfoDiv").find("input[name=soId]").val()+"&shipType="+b,function(h){if(h.success){if(!h.msg){DialogUtils.success(msgCode.FAIL_MSG,"没有快递信息！");
}else{DialogUtils.success(msgCode.INFO,"查询成功");var g=$.parseJSON(h.msg);if(g.apiReturnData){var e="";var c=g.apiReturnData.split("<br>");for(var d=c.length-2;
d>=0;d--){var f=c[d].split("|");if(d==c.length-2){e+='<tr class="last">'+'<td class="row1">'+'<span class="day">'+f[0].substring(0,10)+"</span>"+'<span class="time">'+f[0].substring(10,16)+"</span>&nbsp;&nbsp;"+'<span class="week">'+f[0].substring(19,f[0].length)+"</span>"+"</td>"+'<td class="status status-wait">&nbsp;'+'<div class="col2">'+'<span class="step">'+'<span class="line1"></span>'+'<span class="line2"></span>'+"</span>"+"</div>"+"</td>"+'<td class="contex" t="">'+f[1]+"</td>"+"</tr>";
}else{if(d==0){e+="<tr >"+'<td class="row1">'+'<span class="day">'+f[0].substring(0,10)+"</span>"+'<span class="time">'+f[0].substring(10,16)+"</span>&nbsp;&nbsp;"+'<span class="week">'+f[0].substring(19,f[0].length)+"</span>"+"</td>"+'<td class="status status-first">&nbsp;'+"</td>"+'<td class="contex" t="">'+f[1]+"</td>"+"</tr>";
}else{e+="<tr >"+'<td class="row1">'+'<span class="day">'+f[0].substring(0,10)+"</span>"+'<span class="time">'+f[0].substring(10,16)+"</span>&nbsp;&nbsp;"+'<span class="week">'+f[0].substring(19,f[0].length)+"</span>"+"</td>"+'<td class="status ">&nbsp;'+'<div class="col2">'+'<span class="step">'+'<span class="line1"></span>'+'<span class="line2"></span>'+"</span>"+"</div>"+"</td>"+'<td class="contex" t="">'+f[1]+"</td>"+"</tr>";
}}}$(".time-axis").empty().append(e);}$("input[name=scNameShow]").val(g.scName);$("input[name=scTrackingNoShow]").val(g.scTrackingNo);$("#shipInfoDiv").show();
}}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});$(".queryLogistics").attr("disabled",false);
});$(".shipQryBtn").off("click").on("click",function(){$(".shipQryBtn").attr("disabled",true);var b=$("input[name=id]").val();a.layerFollow=layer.open({type:1,title:["查询物流信息","background-color:#2ac1ac;font-size:1.2em;color:white;"],shade:false,btn:["关闭",],area:["51%","65%"],content:$(".soEntityDetailShipInfo"),scrollbar:false,skin:"my-skin",offset:"65px",success:function(c,d){var e=$("#scCode").find("option:selected").text();
$("input[name=scNameShow]").val(e);$("#shipInfoDiv").find("input[name=soId]").val(b);$("#shipInfoDiv").find("input[name=scTrackingNoShow]").val($("input[name=scTrackingNo]").val());
$(".main-page .nav div").removeClass("on");if(e.indexOf("京东")>-1){$("#jdkuaidi").addClass("on");$(".main-page .nav div").addClass("queryPlatform");}else{if(e.indexOf("顺丰")>-1){$("#shunfengkuaidi").addClass("on");
$("#shunfengkuaidi").addClass("queryPlatform");}else{$("#kuaidiwo").addClass("on");}}},yes:function(d,c){layer.close(a.layerFollow);},on:function(d,c){layer.close(a.layerFollow);
},cancel:function(){layer.close(a.layerFollow);}});$(".shipQryBtn").attr("disabled",false);});$(document).on("click",".soEntityShipQryBtn",function(){$(this).attr("disabled",true);
var d=$(this);var e=d.attr("idVal");var c=d.attr("scTrackingNo");var b=d.attr("shipName");a.layerIndex=layer.open({type:1,title:["队列排队列表","background-color:#2ac1ac;color:white;font-size:1em;"],shade:false,btn:["关闭"],area:["51%","60%"],content:$(".soEntityListShipInfo"),scrollbar:false,skin:"my-skin",success:function(f,g){$("#shipInfoDiv").find("input[name=scNameShow]").val(b);
$("#shipInfoDiv").find("input[name=soId]").val(e);$("#shipInfoDiv").find("input[name=scTrackingNoShow]").val(c);$(".main-page .nav div").removeClass("on");
if(b.indexOf("京东")>-1){$("#jdkuaidi").addClass("on");$(".main-page .nav div").addClass("queryPlatform");}else{if(b.indexOf("顺丰")>-1){$("#shunfengkuaidi").addClass("on");
$("#shunfengkuaidi").addClass("queryPlatform");}else{$("#kuaidiwo").addClass("on");}}},yes:function(g,f){layer.close(a.layerIndex);},on:function(g,f){layer.close(a.layerIndex);
},cancel:function(){layer.close(a.layerIndex);}});$(this).attr("disabled",false);});}};$(function(){var a=new UploadImageUtil();a.init();});function UploadImageUtil(){this.userId=currentUserId;
this.contentId="uploader";this.images=[];}UploadImageUtil._CONS_={SAVE_ADD_URL:ctx+"/gl/image/image/saveAdd.htm",UPLOAD_PARAMS:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":"image/*","fileSingleSizeLimit":1*1024*1024*6,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
UploadImageUtil.prototype={init:function(b,a){if(b){this.contentId=b;}$("#"+this.contentId).hide();if(!a){this._bindEventHandler();}},_bindEventHandler:function(){var a=this;
$(".uploadImage").on("click",function(){a._bindWebuploader();});$("#imageContainer").on("mouseenter",".file-box",function(){if(a._status!="selecting"){$(this).addClass("animated "+"pulse");
}});$("#imageContainer").on("mouseleave",".file-box",function(){if(a._status!="selecting"){var b=$(this);window.setTimeout(function(){b.removeClass("animated "+"pulse");
},2000);}});if(a.contentId=="uploader"){$("#imageContainer").on("click",".showPhotoAlbum",function(){var b=new stringBuffer();b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1669/23976340262_a5ca3859f6_b.jpg" title="Twilight Memories (doraartem)">');
b.append('<img src="http://farm2.staticflickr.com/1669/23976340262_a5ca3859f6_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1459/23610702803_83655c7c56_b.jpg" title="Electrical Power Lines and Pylons disappear over t.. (pautliubomir)">');
b.append('<img src="http://farm2.staticflickr.com/1459/23610702803_83655c7c56_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm2.staticflickr.com/1617/24108587812_6c9825d0da_b.jpg" title="Morning Godafoss (Brads5)">');
b.append('	<img src="http://farm2.staticflickr.com/1617/24108587812_6c9825d0da_m.jpg" alt="" />');b.append("</a>");b.append('<a class="fancybox" rel="gallery1" href="http://farm4.staticflickr.com/3691/10185053775_701272da37_b.jpg" title="Vertical - Special Edition! (cedarsphoto)">');
b.append('<img src="http://farm4.staticflickr.com/3691/10185053775_701272da37_m.jpg" alt="" />');b.append("</a>");$("#imageContainer").append(b.toString());
$(".fancybox").fancybox({openEffect:"none",closeEffect:"none"});});}},_bindWebuploader:function(b,g){var c=this;if(!g){g=c.contentId;}if(b){$("#imageContainer").empty().append(ImageUtils.createImageDivStr(b,null,true,null,true));
}var d=0;function e(j,i){if(i.flag){var k={height:i.height,width:i.width,path:i.localPath,name:i.fileName,byteCount:i.byteCount,isWater:i.water,isZoom:i.zoom,saveType:"relative",cateId:c.albumId,sort:d++};
c.images=[];c.images.push(k);}}function a(i,j){alert("上传"+i.name+"失败，原因是"+j);}function f(){$("#imageContainer").append(ImageUtils.createImageDivStr(c.images,null,true,null,true));
$("#"+g).hide();}var h=new JTWebUploader({config:{"acceptTypes":"gif,jpg,jpeg,bmp,png","mimeTypes":".jpg,.jpeg,.png,.bmp,.gif","fileSingleSizeLimit":100*1024*1024*6,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"},container:"uploader",caption:"支持所有格式的文件上传！单个文件不得超过100M，一次最多上传10个文件！",success:e,error:a,finish:f,auto:true});
h.init();setTimeout(function(){$("#filePicker").find(".webuploader-element-invisible").trigger("click");},1);},_buildImageJson:function(){var a=[];$("#imageContainer").find(".file-box").each(function(){var c=$(this).find(".file a").attr("nameVal");
c=c.replace(/[\-\_\,\!\|\~\`\(\)\#\$\%\^\&\*\{\}\:\;\"\L\<\>\?\[\]\@]/g,"");var b=$(this).find(".file a").attr("urlVal");var d={name:c,path:b};a.push(d);
});return a;},getOptions:function(b){var c=this;var a=window.sessionStorage.getItem("loacalCashPicture");if(a&&a!=null&&a!=""){c._apendData(b,JSON.parse(a));
}else{FormUtils.loadData(ctx+"/gl/image/image/listImageByKey.htm?key=cashPicture&typeKey=system",function(d){window.sessionStorage.setItem("loacalCashPicture",JSON.stringify(d));
c._apendData(b,d);});}},_apendData:function(a,c){var d;if(a){d=$("#"+a);if(d.length==0){d=$("select."+a);if(d.length==0){d=$("select[name='"+a+"']");if(d.length==0){return false;
}}}}var e=new StringBuffer();if(c&&c.length>0){e.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){e.append("<option value='"+c[b].path+"'>"+c[b].name+"</option>");
}d.empty().append(e.toString());}}};