function SoItem(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.otherFunc=null;this.soItemRowid=0;this.isPoint=false;this.csPercent=100;
this.canEditPrice=false;}SoItem._CONS_={GRID:"#soItemGrid",GRID_ID:"soItemGrid",DIV_ID:"soItemDiv",PAGER:"#soItemPager",PAGER_ID:"soItemPager",JSON_ID:"soItemJSON",CS_LEVEL_URL:ctx+"/ec/salesorder/soEntity/getCsLevel.htm",};
SoItem.prototype={init:function(b){var a=this;if(b){a.otherFunc=b.otherFunc;if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;}if(b.csId!=undefined){this._getCsPre(b.csId);
}if(b.canEditPrice!=undefined){this.canEditPrice=b.canEditPrice;}}if(a.isPoint){a._initPointJqgrid(b);}else{a._initJqgrid(b);}if(!a.hadInit){a.hadInit=true;
a._bindEventHander();}},_getCsPre:function(b){var a=this;FormUtils.loadData(SoItem._CONS_.CS_LEVEL_URL+"?csId="+b,function(c){if(c!=null){a.csPercent=parseInt(c);
}});},_bindEventHander:function(){var a=this;$(document).on("click",".prodShow",function(){var c=$(this).attr("value"),b=d=$(this).attr("nameValue"),d;
if(b&&b.length>5){d=b.substring(0,5)+"...";}JTTabUtils.addOrRefreshTab(ctx+"/ec/product/prodEntity/preview.htm?prodSkuId="+c,"商品【"+d+"】",b);});$(document).on("click","#soItemButtonId",function(){a.addSoItem2Grid("soItemGrid");
});$(document).on("click","#soItemSaveButton",function(){a.editSoItem2Grid("soItemGrid");});$(document).on("click",".delSoItem",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从列表删除该商品吗?",text:"",confirmButtonText:"删除",yesFunc:function(){$(SoItem._CONS_.GRID).delRowData(b);}});});$(document).on("change","input[name=countShow]",function(){var h=$(this).parent().parent().attr("id");
var f=$(this).val();if(a.isPoint){var b=a.calMaxExchangeCount(h);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");f=b;$(this).val(f);}}$(SoItem._CONS_.GRID).setCell(h,"count",f);var g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(h,"spDiscout")).toFixed(2);
if($(SoItem._CONS_.GRID).getCell(h,"priceType")=="common"){g=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*a.csPercent/100).toFixed(2);var c=($(SoItem._CONS_.GRID).getCell(h,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);
$(SoItem._CONS_.GRID).setCell(h,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(h,"spDiscoutShow",c);}$(SoItem._CONS_.GRID).setCell(h,"totalAmount",g);var e=a.footerData();
if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=salesPriceShow]",function(){var i=$(this).parent().parent().attr("id");var g=$(this).val();
var f=$("input[name=countShow]").val();if(a.isPoint){var b=a.calMaxExchangeCount(i);if(f>b){var d=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
DialogUtils.error(msgCode.WARING,"用户当前只有"+d+"积分，最多兑换"+b+"个这种商品");var f=b;$("input[name=countShow]").val(f);$(SoItem._CONS_.GRID).setCell(i,"count",f);}}$(SoItem._CONS_.GRID).setCell(i,"salesPrice",g);
var h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f-$(SoItem._CONS_.GRID).getCell(i,"spDiscout")).toFixed(2);if($(SoItem._CONS_.GRID).getCell(i,"priceType")=="common"){h=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*a.csPercent/100).toFixed(2);
var c=($(SoItem._CONS_.GRID).getCell(i,"salesPrice")*f*(100-a.csPercent)/100).toFixed(2);$(SoItem._CONS_.GRID).setCell(i,"spDiscout",c);$(SoItem._CONS_.GRID).setCell(i,"spDiscoutShow",c);
}$(SoItem._CONS_.GRID).setCell(i,"totalAmount",h);var e=a.footerData();if(a.otherFunc!=null){a.otherFunc(e);}});$(document).on("change","input[name=spDiscoutShow]",function(){var d=$(this).parent().parent().attr("id");
var e="0";if(!(isNaN($(this).val())||$(this).val()=="")){e=parseFloat($(this).val()).toFixed(2);$(this).val(e);}$(SoItem._CONS_.GRID).setCell(d,"spDiscout",e);
var c=$(SoItem._CONS_.GRID).getCell(d,"salesPrice")*$(SoItem._CONS_.GRID).getCell(d,"count")-e;$(SoItem._CONS_.GRID).setCell(d,"totalAmount",c);var b=a.footerData();
if(a.otherFunc!=null){a.otherFunc(b);}});$(document).on("change","input[name=spCommentShow]",function(){var c=$(this).parent().parent().attr("id");var b=$(this).val();
$(SoItem._CONS_.GRID).setCell(c,"spComment",b);});$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},_initJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].salesPriceShow=d[b].salesPrice;d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append("<table class='table table-bordered table-stripped' id=\""+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","原价(元)","库存数量","数量","价格隐藏","数量隐藏","商品价格类型","折扣(元)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(元)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,i){var h=f;
if(i.prodName){h="<a href='#' class='prodShow' value='"+i.skuId+"' nameValue='"+i.prodName+"'>"+i.skuKey+":"+i.prodName+"</a>";h+=a._creatReturnType(i.afterSaleType)+a._creatReturnStatus(i);
}return h;}},{name:"salesPriceShow",sortable:false,align:"center",classes:"test",width:80,editable:a.canEditPrice,formatter:"number"},{name:"stockCount",sortable:false,align:"center",editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:85,formatter:function(f,g,h){if(h.stockCount<1){return"<span>"+h.stockCount+"</span>";
}return"<span>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"center",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"salesPrice",sortable:false,editable:false,hidedlg:true,hidden:true,width:120},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"priceType",sortable:false,width:120,hidedlg:true,hidden:true},{name:"spDiscoutShow",sortable:false,align:"center",editable:a.isCanEdit,formatter:"number",classes:"test",width:90},{name:"spCommentShow",sortable:false,editable:a.isCanEdit,width:120,classes:"test"},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:120},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"center",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var k="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;'  value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}for(var g=0;g<h.length;g++){var j=$(SoItem._CONS_.GRID).jqGrid("getRowData",h[g]);if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
if(j["priceType"]!="exchange"){$("#"+h[g]+"_spDiscoutShow").attr("readonly",true);$("#"+h[g]+"_spCommentShow").attr("readonly",true);}}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();
$("input[name=countShow]").css("text-align","right");$("input[name=spDiscoutShow]").css("text-align","right");},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:7,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
},footerData:function(){var c=$(SoItem._CONS_.GRID).jqGrid("getCol","totalAmount",true,"sum");var b=$(SoItem._CONS_.GRID).jqGrid("getCol","count",true,"sum");
$(SoItem._CONS_.GRID).jqGrid("footerData","set",{prodPic:"总计:",countShow:b,totalAmount:c});var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;
},getFooterData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("footerData","get");return a;},_creatReturnType:function(a){var b="";if("back"==a||"reject"==a){b="<span style='color:red;'>[退]</sapn>";
}else{if("exchange"==a){b="<span style='color:blue;'>[换]</sapn>";}}return b;},_creatReturnStatus:function(a){var b="";if(a.afterSaleType){if(a.afterSaleStatus=="processing"){b="<span style='color:red;'>[未]</sapn>";
}else{if(a.afterSaleStatus=="complete"){b="<span style='color:green;'>[已]</sapn>";}else{if(a.afterSaleStatus=="stop"){b="<span style='color:blue;'>[终]</sapn>";
}else{if(a.afterSaleStatus=="bad"){b="<span style='color:green;'>[已]</sapn>"+"<span style='color:red;'>[次]</sapn>";}}}}}return b;},getSoItemGridData:function(){var c=$(SoItem._CONS_.GRID);
var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;a++){var e=c.jqGrid("getRowData",d[a]);if(e["count"]==""){continue;
}else{if(parseInt(e["count"])<1){continue;}}f++;b.append("soItemPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soItemPos[").append(f-1).append("].skuId=").append(e["skuId"]).append("&").append("soItemPos[").append(f-1).append("].skuKey=").append(e["skuKey"]).append("&").append("soItemPos[").append(f-1).append("].isMain=").append(e["isMain"]).append("&").append("soItemPos[").append(f-1).append("].mainId=").append(e["mainId"]).append("&").append("soItemPos[").append(f-1).append("].salesPrice=").append(e["salesPrice"]).append("&").append("soItemPos[").append(f-1).append("].count=").append(e["count"]).append("&").append("soItemPos[").append(f-1).append("].discout=").append(e["discout"]).append("&").append("soItemPos[").append(f-1).append("].spDiscout=").append(e["spDiscout"]).append("&").append("soItemPos[").append(f-1).append("].spComment=").append(e["spComment"]).append("&").append("soItemPos[").append(f-1).append("].invoice=").append(e["invoice"]).append("&").append("soItemPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soItemPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(d[a].indexOf("tmpSoItem")==-1){b.append("soItemPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},getRowLength:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
return a.length;},soItemOperFunc:function(b,a){return b;},addSoItem2Grid:function(d){var a=this;var c=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");var f=0;
for(var b=0;b<c.length;b++){var e=$(SoItem._CONS_.GRID).jqGrid("getRowData",c[b]);if(e["skuId"]==d.skuId){DialogUtils.error(msgCode.WARING,"订购列表已有该商品");
return;}}d.soId="";d.count="1";d.discout="0.00";d.invoice="";d.createTime="";d.updateTime="";d.countShow=d.count;d.salesPriceShow=d.salesPrice;d.spDiscout="0.00";
if(d.priceType=="common"){d.spDiscout=(parseFloat(d.salesPrice)*(100-a.csPercent)/100).toFixed(2);}d.spComment=d.priceType=="special"?"特价":d.priceType=="gift"?"赠品":" ";
if(d.priceType=="common"){if(a.csPercent==100){d.spComment="正价商品";}else{d.spComment="正价商品"+parseFloat(a.csPercent/10).toFixed(1)+"折";}}d.spDiscoutShow=d.spDiscout;
d.spCommentShow=d.spComment;d.totalAmount=parseFloat(d.salesPrice)*parseInt(d.count)-parseFloat(d.spDiscout);$(SoItem._CONS_.GRID).jqGrid("addRowData","tmpSoItem"+a.soItemRowid,d,"last");
a.soItemRowid++;},isHadData:function(){var a=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");if(a.length>0){return true;}return false;},_initPointJqgrid:function(e){var a=this;
var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;
d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}var c=$(".itemDiv").width()-20;$("."+SoItem._CONS_.DIV_ID).empty().append('<table id="'+SoItem._CONS_.GRID_ID+'"></table>				                                                           <div id="'+SoItem._CONS_.PAGER_ID+'"></div>				                                                           <input type="hidden"  name="'+SoItem._CONS_.JSON_ID+'"  id="'+SoItem._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoItem._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"商品订购列表",datastr:d,height:"auto",width:c,shrinkToFit:true,multiselect:false,sortable:false,rowNum:1000,rownumbers:true,colNames:["商品图片","商品ID","商品SKU ID","商品SKU编码","商品名称","兑换积分","库存数量","数量","数量隐藏","折扣(积分)","折扣备注","折扣备注隐藏","折扣隐藏","活动折扣","是否主项目","从属主项目ID","发票金额","小计(积分)","创建时间","修改时间","操作"],colModel:[{name:"prodPic",sortable:false,width:80,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:220,formatter:function(f,g,h){if(h.prodName!=null&&h.prodName!=0){return"<a href='#' class='prodShow' value='"+h.prodId+"' keyValue='"+h.skuKey+"' nameValue='"+h.prodName+"'>"+h.prodName+"</a>";
}return h.prodName;}},{name:"salesPrice",sortable:false,align:"center",classes:"test",width:90},{name:"stockCount",sortable:false,editable:false,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,width:90,formatter:function(f,g,h){if(h.stockCount<1){return"<span class='label label-danger'>"+h.stockCount+"</span>";
}return"<span class='label label-primary'>"+h.stockCount+"</span>";}},{name:"countShow",sortable:false,editable:a.isCanEdit,width:90,align:"right",classes:"test",formatter:"integer",editrules:{required:true,number:true},summaryType:"sum"},{name:"count",sortable:false,editable:false,hidedlg:true,hidden:true,width:120,formatter:"integer"},{name:"spDiscoutShow",sortable:false,hidedlg:true,hidden:true},{name:"spCommentShow",sortable:false,hidedlg:true,hidden:true},{name:"spComment",sortable:false,hidedlg:true,hidden:true,editable:false,width:90},{name:"spDiscout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"discout",sortable:false,editable:false,hidedlg:true,hidden:true,formatter:"number",width:120},{name:"isMain",sortable:false,width:120,hidedlg:true,hidden:true},{name:"mainId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"invoice",sortable:false,width:120,hidedlg:true,hidden:true},{name:"totalAmount",sortable:false,width:90,align:"right",classes:"test",formatter:"integer",summaryType:"sum"},{name:"createTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",sortable:false,hidedlg:true,hidden:true,width:120},{name:"button",sortable:false,align:"center",width:100,hidedlg:!a.isCanEdit,hidden:!a.isCanEdit,}],footerrow:true,gridComplete:function(){var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j="<i class='fa fa-remove delSoItem' title='删除' style='color:red;cursor:pointer;' value='"+h[g]+"'></i>";$(SoItem._CONS_.GRID).jqGrid("setRowData",h[g],{button:j});
}var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}var h=$(SoItem._CONS_.GRID).jqGrid("getDataIDs");for(var g=0;g<h.length;g++){if(h[g]!="total"){$(SoItem._CONS_.GRID).editRow(h[g]);
}}$(SoItem._CONS_.GRID).find("img").ImageEnlarge();},});$(SoItem._CONS_.GRID).jqGrid("setGroupHeaders",{useColSpanStyle:true,groupHeaders:[{startColumnName:"prodPic",numberOfColumns:6,titleText:"商品信息"},{startColumnName:"countShow",numberOfColumns:12,titleText:"购买信息"}]});
$(window).bind("resize",function(){$(SoItem._CONS_.GRID).setGridWidth($(".itemDiv").width()-20);});},calMaxExchangeCount:function(h){var a=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=pointUsable]").val();
var e=$("#"+SoEntityPlace._CONS_.EDIT_FORM_ID).find("[name=totalAmount]").val();var b=$(SoItem._CONS_.GRID).getCell(h,"totalAmount");var d=$(SoItem._CONS_.GRID).getCell(h,"salesPrice");
var g=e-b;var c=a-g;var f=c/d;return parseInt(f);}};