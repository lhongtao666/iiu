$(function(){var a=new ExchangeOrBack();a.init();});function ExchangeOrBack(){this.hadInit=false;}ExchangeOrBack._CONS_={};ExchangeOrBack.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;
this._bindEventHander();var a=$("[name=soId]").val();this._reloadData(a);FormUtils.bindFormValidation("tableForm",{});}},_reloadData:function(b){var a=ctx+"/ec/salesorder/soEntity/loadBackOrExchangeSoInfo.htm?id="+b;
FormUtils.loadData(a,function(f){if(f){var i=f.backSoInfoVos;var h=$.templates("#backSoInfoTmpl");var k=h.render(i);$("#backSoInfo").empty().append(k);
var c=f.exchangeSoInfoVos;var l=$.templates("#exchangeSoInfoTmpl");var g=l.render(c);$("#exchangeSoInfo").empty().append(g);var d=f.originSoItemVos;var e=$.templates("#originSoItemInfoTmpl");
var j=e.render(d);$("#soItemVoTbody").empty().append(j);}},null,false);},_refreshTab:function(){var a=$("[name=soId]").val();this._reloadData(a);},_bindEventHander:function(){var a=this;
$("body").on("click",".cancelBackSo",function(){var c=$(this).attr("backSoIdVal");var b={backingSoIds:c,};DialogUtils.confirmWithOptions({title:"您确认取消退货吗？",text:"取消退货会删除已生成的退货单",confirmButtonText:"确定",yesFunc:function(){var d=ctx+"/ec/salesorder/soEntity/cancelBackSo.htm";
FormUtils.submit(d,b,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS_MSG,e.msg);a._refreshTab();}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});});$("body").on("click",".cancelExchangeSo",function(){var c=$(this).attr("backSoIdVal");
var b={backingSoIds:c,};DialogUtils.confirmWithOptions({title:"您确认取消换货吗？",text:"",confirmButtonText:"确定",yesFunc:function(){var d=ctx+"/ec/salesorder/soEntity/cancelExchangeSo.htm";
FormUtils.submit(d,b,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS_MSG,e.msg);a._refreshTab();}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});});$("body").on("click",".toLinkSo",function(){var c=$(this).attr("soNo");var b=$(this).attr("linkType");
if(!c){DialogUtils.error(msgCode.ERROR,"订单不存在,可能已被删除,请通过查询进入");return;}var d=b+"订单["+c+"]";JTTabUtils.addOrRefreshTab(ctx+"/ec/salesorder/soEntity/detail.htm?soNo="+c,d);
});$(document).on("click",".csCode",function(){var b=$(this).attr("csId");var c=$(this).attr("csName");if(b){JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/detail.htm"+"?csId="+b,"客户["+c+"]");
}});$("body").on("click",".select-all-th-checkbox",function(){var b=this.checked;$(".select-td-checkbox-can-choose").attr("checked",b).prop("checked",b);
});$("body").on("click",".backBtn",function(){var b=[];var d=$(this).attr("idVal");if(!d){var e=$(".select-td-checkbox-can-choose:checked");if(!e.size()){DialogUtils.error(msgCode.ERROR,"请选择要退货的商品");
return;}e.each(function(m,n){var r=$(this).parents("tr");var p=r.attr("idVal");var l=r.find("[name=canBackCount]").val();var q=$(this).attr("actualPrice");
if(l&&l>0){var o={id:p,count:l,actualPrice:q};b.push(o);}});}else{var i=$(this).parents("tr").find("[name=canBackCount]").val();var g=$(this).attr("actualPrice");
if(i==0||!i){DialogUtils.error(msgCode.ERROR,"请选择要退货的商品");return;}var j={id:d,count:i,actualPrice:g};b.push(j);}if(!b.length){DialogUtils.error(msgCode.ERROR,"请选择要退货的商品");
return;}var c=$("#tableForm").valid();if(!c){return;}var f=$("[name=soId]").val();var k={selectedArr:b,soId:f,backType:"back",};k.successFn=function(){a._refreshTab();
};var h=new ExchangeOrBackModal();h.init(k);});$("body").on("click",".exchangeBtn",function(){var b=[];var d=$(this).attr("idVal");if(!d){var e=$(".select-td-checkbox-can-choose:checked");
if(!e.size()){DialogUtils.error(msgCode.ERROR,"请选择要换货的商品");return;}e.each(function(m,n){var r=$(this).parents("tr");var p=r.attr("idVal");var l=r.find("[name=canBackCount]").val();
var q=$(this).attr("actualPrice");if(l&&l>0){var o={id:p,count:l,actualPrice:q};b.push(o);}});}else{var i=$(this).parents("tr").find("[name=canBackCount]").val();
if(i==0||!i){DialogUtils.error(msgCode.ERROR,"请选择要换货的商品");return;}var g=$(this).attr("actualPrice");var j={id:d,count:i,actualPrice:g};b.push(j);}if(!b.length){DialogUtils.error(msgCode.ERROR,"请选择要退货的商品");
return;}var c=$("#tableForm").valid();if(!c){return;}var f=$("[name=soId]").val();var k={selectedArr:b,soId:f,backType:"exchange",};k.successFn=function(){a._refreshTab();
};var h=new ExchangeOrBackModal();h.init(k);});$("body").on("click",".generateChangeSo",function(){var c={};c.originSoId=$(this).attr("originSoIdVal");
c.backSoId=$(this).attr("backSoIdVal");var d=$("[name=csName]").val();var b=$("[name=csId]").val();DialogUtils.confirmWithOptions({title:"您确认生成换货单吗？",text:"",confirmButtonText:"确定",yesFunc:function(){var e=ctx+"/ec/salesorder/soEntity/checkCanGenarateExchangeSo.htm";
FormUtils.submit(e,c,function(h){if(h.success){var f=ctx+"/ec/salesorder/soEntity/place.htm";var g="search";JTTabUtils.addOrRefreshTab(f+"?baseType=exchange&originSoId="+c.backSoId+"&isAdd=true&isPoint=false&csId="+b+"&type="+g,"["+d+"]换货单");
}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}});});},};