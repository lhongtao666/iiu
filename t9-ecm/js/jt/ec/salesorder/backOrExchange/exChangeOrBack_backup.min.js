$(function(){var a=new ExChangeOrBack();a.init();});function ExChangeOrBack(){this.hadInit=false;}ExChangeOrBack._CONS_={RETURN_URL:ctx+"/ec/salesorder/soEntity/exchangeOrBack.htm",EDIT_URL:ctx+"/ec/salesorder/soEntity/edit.htm",DETAIL_FORM:"#soEntityExchangeOrBackForm",};
ExChangeOrBack.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();$("select[id=rejectTypeOne]").trigger("change");
}},_bindEventHander:function(){var a=this;$("body").on("click",".backBtn",function(){a._doExchangeOrback("back");});$("body").on("click",".exchangeBtn",function(){a._doExchangeOrback("exchange");
});$("body").on("change",".backCount",function(){var b=$(this).attr("totalCount");var c=$(this).val();a._checkCount(b,c);});$("body").on("change","select[id=rejectTypeOne]",function(){if($(this).val()=="ship"){CateUtils.getOptions({typeKey:"system",pKey:"shipRejectType",container:"rejectType"});
}else{if($(this).val()=="cs"){CateUtils.getOptions({typeKey:"system",pKey:"csRejectType",container:"rejectType"});}else{if($(this).val()=="emp"){CateUtils.getOptions({typeKey:"system",pKey:"empRejectType",container:"rejectType"});
}else{if($(this).val()=="turn"){CateUtils.getOptions({typeKey:"system",pKey:"turnRejectType",container:"rejectType"});}}}}});},_checkCount:function(a,b){if(b<=0){DialogUtils.error(msgCode.ERROR,"退回数量不能小于等于0");
return false;}else{if(b>parseInt(a)){DialogUtils.error(msgCode.ERROR,"退回数量不能大于总数量");return false;}}return true;},_doExchangeOrback:function(f){var k=this;
var b=$(ExChangeOrBack._CONS_.DETAIL_FORM+" input[name=soId]").val();var i=$(ExChangeOrBack._CONS_.DETAIL_FORM+" input[name=afterSaleType]").val();var d=[];
var e=true;$("#exchangeOrBackContainer").find("tr").each(function(){var n={};var m=$(this).find(".isReturn")[0].checked;if(m){n.id=$(this).attr("id");n.count=$(this).find(".backCount").val();
var l=$(this).find(".backCount").attr("totalCount");if(!k._checkCount(l,n.count)){$(this).find(".backCount").focus();e=false;return false;}d.push(n);}});
if(!e){return false;}if(d.length<=0){DialogUtils.error(msgCode.ERROR,"请选择要退货或者换货的商品");return false;}var h=$("#rejectComment").val();var g=$("#rejectTypeOne").find("option:selected").text();
var c=$("#rejectType").find("option:selected").text().replaceAll("请选择","");var a="soId="+b+"&type="+f+"&items="+JSON.stringify(d)+"&rejectComment="+encodeURI(h)+"&rejectType="+encodeURI(c)+"&rejectTypeOne="+encodeURI(g);
var j=ExChangeOrBack._CONS_.RETURN_URL;DialogUtils.confirmWithOptions({title:f=="back"?"您确认退货吗？":"您确认换货吗？",text:"",confirmButtonText:"确定",yesFunc:function(){FormUtils.submit(j,a,function(l){if(l.success){DialogUtils.success(msgCode.SUCCESS,"操作成功！");
window.location.href=ctx+"/ec/salesorder/soEntity/exchange.htm?id="+b;}else{DialogUtils.error(msgCode.FAIL_MSG,"操作失败");}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});}};