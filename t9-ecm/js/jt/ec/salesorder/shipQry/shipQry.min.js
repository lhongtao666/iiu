ShipQry._CONS_={SHIP_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/logicsByNo.htm",SO_FOLLOW_URL:ctx+"/ec/salesorder/soEntity/shipQryfollow.htm",SO_STORE_IN_URL:ctx+"/ec/salesorder/soEntity/soBackAndStoreIn.htm",BACK_COMPLETE_URL:ctx+"/ec/salesorder/soEntity/backComplete.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",BACK_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/setApiRevokeTime.htm",};
function ShipQry(){this.hadInit=false;this.csFollow=new CsFollow();}ShipQry.prototype={init:function(b){if(!this.hadInit){this.shipSoEntityMap=b;this._resetSize();
this._hideNotGrantBtn();this.hadInit=true;this._bindEventHander();this.shipQryTableShowStyle=("true"==window.localStorage.getItem("batchShipQryTableShowStyle")||window.localStorage.getItem("batchShipQryTableShowStyle")==null)?true:false;
if(this.shipQryTableShowStyle){$("#batchShipQryGrid").find("input[name=simpleShow]").prop("checked",true);}else{$("#batchShipQryGrid").find("input[name=simpleShow]").prop("checked",false);
}if(!$.isEmptyObject(b)){var c=$("#batchShipQrybodyContainer").find("tr");for(var a=0;a<c.length;a++){this._initShipInfo($(c[a]).attr("id"));}}}},_initShipInfo:function(e){var o=this;
var k=o.shipSoEntityMap[e];if(k){var l=new StringBuffer();var f=k.split("<br>");var m=false;for(var d=f.length-1;d>=0;d--){var c=f[d];var a=/\d+/g;var h=c.match(a);
var g="";if(h){for(var b=0;b<h.length;b++){if(h[b].length==11){g=h[b];}}}console.log(g);if(g){var n=c.split(g);c=n[0]+"<a class='phoneBtn' masknum='"+g+"'>"+g+"</a>"+n[1];
}if(!f[d]){m=true;continue;}if(m){m=false;if(o.shipQryTableShowStyle){l.append("<p >").append(c).append("<button type='button' class='btn btn-sm   btn-info UpAndDown' data-value='"+e+"' status='0' style='margin-left:3px;'><span class='btnText'>展开</span><span class='fa fa-sort-down expand'></span><span class='fa fa-sort-up collapse ' style='display:none;'></span></button></p>");
}else{l.append("<p >").append(c).append("<button type='button' class='btn btn-sm   btn-info UpAndDown' data-value='"+e+"' status='1' style='margin-left:3px;'><span class='btnText'>收起</span><span class='fa fa-sort-down expand' style='display:none;'></span><span class='fa fa-sort-up collapse ' ></span></button></p>");
}}else{if(o.shipQryTableShowStyle){l.append("<p class='"+e+"P' style='display:none;'>").append(c).append("</p>");}else{l.append("<p class='"+e+"P' >").append(c).append("</p>");
}}}$("#"+e).find(".ship-info").empty().append(l.toString());}},_resetSize:function(){var a=$(window).height()-$(".sweep_deliver_wrapper").outerHeight()+20;
$(".jqGrid_wrapper").height(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("shipQry.button.soBackAndStoreIn")){$("button.soBackAndStoreInBtn").hide();
}if(!ResUtils.canShow("shipQry.button.complete")){$("button.completeBtn").hide();}if(!ResUtils.canShow("shipQry.button.reject")){$("button.rejectBtn").hide();
}if(!ResUtils.canShow("shipQry.button.lost")){$("button.lostBtn").hide();}if(!ResUtils.canShow("shipQry.button.back")){$("button.backCompleteBtn").hide();
}if(!ResUtils.canShow("shipQry.button.refresh")){$("button.refreshBtn").hide();}if(!ResUtils.canShow("shipQry.button.addCsFollow")){$("button.addFollowBtn").hide();
}},_bindEventHander:function(){var a=this;$(document).on("click",".phoneBtn",function(c){var b=$(this);DialogUtils.confirmWithOptions({title:"是否拨打快递员电话？",text:"拨打快递员电话",confirmButtonText:"确认",yesFunc:function(){var d=b.attr("masknum");
if(d&&d!=""){if(d.startsWith("020")){d=d.substring(3);}window.top.jtCtiService.dialout("9"+d);}else{DialogUtils.error(msgCode.ERROR,"获取号码失败");return;}}});
});$(document).on("click",".addFollowBtn",function(){var d=$(this).parent().prev();var c={followType:"so",contentExt:"<a href='#' class='soTab' value='"+d.attr("soNo")+"'>"+d.attr("soNo")+"</a>，订单金额<span style='color:red'>"+d.attr("totalAmount")+"元</span>)",csId:d.attr("csId"),csCode:d.attr("csCode"),entityId:d.attr("entityId"),soNo:d.attr("soNo"),csPhone:d.attr("csPhone"),shipQry:true};
var b={partyAid:d.attr("partyAid"),partyId:d.attr("partyId"),partyName:d.attr("partyName")};a.csFollow.init(c,b);});$("body").on("change","input[name='checkAll']",function(){var d=$(this)[0].checked;
var c=$("input[name='shipQryCheckbox']");for(var b=0;b<c.length;b++){c[b].checked=d;}});$("body").on("click",".searchBtn",function(){a.shipSoEntityMap={};
var c=$("#batchShipQrybodyContainer").find("tr");var d=$("input[name='shipType']:checked").val();for(var b=0;b<c.length;b++){a._search($(c[b]).attr("id"),d);
}});$("body").on("click",".completeBtn",function(){var c=[];var e=$(this).attr("id-value");if(!e){var d=$("input[name='shipQryCheckbox']:checked");for(var b=0;
b<d.length;b++){if($(d[b]).attr("status-value")!="shipping"){DialogUtils.error(msgCode.FAIL_MSG,"必须是所有订单都是已发货状态的才能签收");return false;}c.push($(d[b]).attr("id-value"));
}}else{c.push(e);}if(c.length<=0){DialogUtils.error(msgCode.FAIL_MSG,"请选择要处理的订单");return false;}DialogUtils.confirmWithOptions({title:"您确认收货？",text:"",confirmButtonText:"确定",yesFunc:function(){a._follow(c,"complete");
}});});$("body").on("click",".rejectBtn",function(){var c=[];var e=$(this).attr("id-value");if(!e){var d=$("input[name='shipQryCheckbox']:checked");for(var b=0;
b<d.length;b++){if($(d[b]).attr("status-value")!="shipping"){DialogUtils.error(msgCode.FAIL_MSG,"必须是所有订单都是已发货状态的才能拒收");return false;}c.push($(d[b]).attr("id-value"));
}}else{c.push(e);}if(c.length<=0){DialogUtils.error(msgCode.FAIL_MSG,"请选择要处理的订单");return false;}DialogUtils.confirmWithOptions({title:"您确认拒收？",text:"",confirmButtonText:"确定",yesFunc:function(){a._follow(c,"close_reject");
}});});$("body").on("click",".soBackAndStoreInBtn",function(){var c=[];var e=$(this).attr("id-value");if(!e){var d=$("input[name='shipQryCheckbox']:checked");
for(var b=0;b<d.length;b++){if($(d[b]).attr("status-value")!="shipping"){DialogUtils.error(msgCode.FAIL_MSG,"必须是所有订单都是已发货状态的才能退货入仓");return false;}c.push($(d[b]).attr("id-value"));
}}else{c.push(e);}if(c.length<=0){DialogUtils.error(msgCode.FAIL_MSG,"请选择要处理的订单");return false;}DialogUtils.confirmWithOptions({title:"此操作不可逆, 您确认退货入仓？",text:"",confirmButtonText:"确定",yesFunc:function(){a._backAndStoreIn(c,"close_reject");
}});});$("body").on("click",".lostBtn",function(){var c=[];var e=$(this).attr("id-value");if(!e){var d=$("input[name='shipQryCheckbox']:checked");for(var b=0;
b<d.length;b++){if($(d[b]).attr("status-value")!="shipping"){DialogUtils.error(msgCode.FAIL_MSG,"必须是所有订单都是已发货状态的才能拒收");return false;}c.push($(d[b]).attr("id-value"));
}}else{c.push(e);}if(c.length<=0){DialogUtils.error(msgCode.FAIL_MSG,"请选择要处理的订单");return false;}DialogUtils.confirmWithOptions({title:"您确认丢失？",text:"",confirmButtonText:"确定",yesFunc:function(){a._follow(c,"close_lost");
}});});$("body").on("click",".backCompleteBtn",function(){var c=[];var e=$(this).attr("id-value");if(!e){var d=$("input[name='shipQryCheckbox']:checked");
for(var b=0;b<d.length;b++){if(!($(d[b]).attr("status-value")=="complete"||$(d[b]).attr("status-value")=="close_reject"||$(d[b]).attr("status-value")=="close_lost")){DialogUtils.error(msgCode.FAIL_MSG,"必须是所有订单都是已签收、拒收、丢失状态的才能拒收");
return false;}c.push($(d[b]).attr("id-value"));}}else{c.push(e);}if(c.length<=0){DialogUtils.error(msgCode.FAIL_MSG,"请选择要处理的订单");return false;}DialogUtils.confirmWithOptions({title:"您确认撤销？",text:"",confirmButtonText:"确定",yesFunc:function(){a._backComplete(c);
}});});$("body").on("click",".soTab",function(){var c=$(this).attr("csNameVal");var b=$(this).attr("value");JTTabUtils.addOrRefreshTab(ShipQry._CONS_.DETAIL_PAGE_URL+"?soNo="+b,c+"的订单明细");
});$("body").on("click","#batchShipQrybodyContainer tr",function(){var b=event.target;if(b.name=="shipQryCheckbox"){return;}var c=$(this).find("input[name='shipQryCheckbox']")[0].checked;
if(c){$(this).find("input[name='shipQryCheckbox']")[0].checked=false;}else{$(this).find("input[name='shipQryCheckbox']")[0].checked=true;}});$("body").on("click",".refreshBtn",function(d){var j=$("#batchShipQrybodyContainer").find("tr");
var e=$("input[name='shipType']:checked").val();var f=revokeTime=null;var b=[];var c=0;for(var g=0;g<j.length;g++){b.push($(j[g]).attr("id"));startDate=$(j[g]).children("td").eq(5).text();
endDate=$(j[g+1]).children("td").eq(5).text();if(startDate==""){c+=1;}f=startDate>endDate?startDate:"";revokeTime=revokeTime>f?revokeTime:f;}if(c!=0){FormUtils.submit(ShipQry._CONS_.BACK_INFO_QRY_URL,"ids="+b,function(i){if(i.success){a._initSearch();
}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}});}else{diffTime=a._getTimeDiff(revokeTime);if(diffTime=="0"){FormUtils.submit(ShipQry._CONS_.BACK_INFO_QRY_URL,"ids="+b,function(i){if(i.success){a._initSearch();
}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}});}if(diffTime=="10"){$(".refreshBtn").hide();$(".colckDiv").show();var k=10;var h=setInterval(function(){if(k<10&&k>0){$("#num").html("0"+k);
}else{$("#num").html(k);}k--;if(k<0){clearInterval(h);$(".refreshBtn").show();$(".colckDiv").hide();return;}},1000);}if(diffTime=="3"){return;}}});$(document).on("click",".UpAndDown",function(){var b=$(this).attr("status");
if("0"==b){$(this).attr("status","1");$(".btnText").text("收起");$(".collapse").show();$(".expand").hide();var c=$(this).attr("data-value");$("."+c+"P").show();
}else{$(this).attr("status","0");$(".btnText").text("展开");$(".collapse").hide();$(".expand").show();var c=$(this).attr("data-value");$("."+c+"P").hide();
}});$("body").on("change",".simpleShow",function(){var b=$(this);if(b.is(":checked")){window.localStorage.setItem("batchShipQryTableShowStyle","true");
}else{window.localStorage.setItem("batchShipQryTableShowStyle","false");}$(".UpAndDown").trigger("click");});},_getTimeDiff:function(d){var a=new Date(d.replace(/-/g,"/"));
var c=new Date();var k="";var f=null;var b=new Date().getTime()-a.getTime();var l=Math.floor(b/(24*3600*1000));if(l>0){k+=l;}var h=b%(24*3600*1000);var i=Math.floor(h/(3600*1000));
if(i>0){k+=i;}else{if(k!==""){k+=i;}}if(k==""){var g=h%(3600*1000);f=Math.floor(g/(60*1000));if(f>0&&f<3){k+=f;return"3";}else{if(f==0||f==3){k+="";}else{return"0";
}}}if(k==""){var e=g%(60*1000);var j=Math.round(e/1000);if(j>0&&j<10){k+=j;return"10";}else{if(j>10&&f<3){k+=j;return"3";}}}return"0";},_follow:function(c,a){var b=this;
FormUtils.submit(ShipQry._CONS_.SO_FOLLOW_URL,"ids="+c+"&status="+a,function(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");b._disAble(c,a);
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_backAndStoreIn:function(c,a){var b=this;FormUtils.submit(ShipQry._CONS_.SO_STORE_IN_URL,"ids="+c+"&status="+a,function(d){if(d.success){DialogUtils.success(msgCode.INFO,"操作成功");
b._disAble(c,"soBackAndStoreIn");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}});},_backComplete:function(b){var a=this;FormUtils.submit(ShipQry._CONS_.BACK_COMPLETE_URL,"ids="+b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,c.msg);
a._disAble(b,"shipping");}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_disAble:function(c,a){for(var b=0;
b<c.length;b++){$("#"+c[b]).find(":input").attr("status-value",a);$("#"+c[b]).find(".soTab").attr("status",a);var d=new StringBuffer();if(a=="shipping"){d.append("<span>已发货</span><br>").append("<button type='button'  id-value='"+c[b]+"' class='btn btn-sm btn-primary completeBtn' >收货</button>&nbsp;").append("<button type='button'  id-value='"+c[b]+"' class='btn btn-sm btn-danger rejectBtn' >拒收</button>&nbsp;").append("<button type='button'  id-value='"+c[b]+"' class='btn btn-sm btn-danger lostBtn' >丢失</button>&nbsp;").append("<button type='button'  id-value='"+c[b]+"' class='btn btn-sm btn-danger soBackAndStoreInBtn' >退货入仓</button>&nbsp;").append("<button type='button'  id-value='"+c[b]+"' class='btn btn-sm btn-primary refreshBtn'>刷新</button>").append('<div style="margin-left:20px; display: none;" class="btn btn-sm btn-primary colckDiv"><h4 id="num"></h4></div>');
}else{if(a=="complete"){d.append("<span style='color:green'>已签收</span><br>").append("<button type='button' id-value='"+c[b]+"'  class='btn btn-sm btn-outline btn-danger backCompleteBtn' >撤销收货</button>");
}else{if(a=="close_lost"){d.append("<span style='color:red'>包裹丢失</span><br>").append("<button type='button' id-value='"+c[b]+"'  class='btn btn-sm btn-outline btn-danger backCompleteBtn' >撤销丢失</button>");
}else{if(a=="close_reject"){d.append("<span style='color:red'>订单拒收</span><br>").append("<button type='button' id-value='"+c[b]+"'  class='btn btn-sm btn-outline btn-danger backCompleteBtn' >撤销拒收</button>");
}else{if(a=="soBackAndStoreIn"){d.append("<span style='color:red'>已退回</span><br>");}}}}}$("#"+c[b]).find(".td-status").empty().append(d.toString());}},_search:function(c,b){var a=this;
if(c&&c!=""){FormUtils.submit(ShipQry._CONS_.SHIP_INFO_QRY_URL,"id="+c+"&shipType="+b,function(h){if(h.success&&h.msg){var g=$.parseJSON(h.msg);if(g.apiReturnData){var j=new StringBuffer();
var d=g.apiReturnData.split("<br>");var f=false;for(var e=d.length-1;e>=0;e--){if(!d[e]){f=true;continue;}if(f){f=false;if(a.shipQryTableShowStyle){j.append("<p >").append(d[e]).append("<button type='button' class='btn btn-sm   btn-info UpAndDown' data-value='"+c+"' status='0' style='margin-left:3px;'><span class='btnText'>展开</span><span class='fa fa-sort-down expand'></span><span class='fa fa-sort-up collapse ' style='display:none;'></span></button></p>");
}else{j.append("<p >").append(d[e]).append("<button type='button' class='btn btn-sm   btn-info UpAndDown' data-value='"+c+"' status='1' style='margin-left:3px;'><span class='btnText'>收起</span><span class='fa fa-sort-down expand' style='display:none;'></span><span class='fa fa-sort-up collapse ' ></span></button></p>");
}}else{if(a.shipQryTableShowStyle){j.append("<p class='"+c+"P' style='display:none;'>").append(d[e]).append("</p>");}else{j.append("<p class='"+c+"P' >").append(d[e]).append("</p>");
}}}$("#"+c).find(".ship-info").empty().append(j.toString());}if(g.apiRevokeTime){var j=new StringBuffer();j.append("<p>").append(g.apiRevokeTime).append("</p>");
$("#"+c).find(".revokeTime").empty().append(j.toString());}}else{if(h.msg){$("#"+c).find(".ship-info").empty().append("<p style='color:red'>"+h.msg+"</p>");
}else{$("#"+c).find(".ship-info").empty().append("<p style='color:red'>暂无快递信息</p>");}}});}}};