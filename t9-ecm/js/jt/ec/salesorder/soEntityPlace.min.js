$(function(){var a=new SoEntityPlace();a.init();});function SoEntityPlace(){this.soEntityBase=new SoEntityBase();}SoEntityPlace._CONS_={SAVE_ADD_URL:ctx+"/ec/salesorder/soEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/salesorder/soEntity/saveEdit.htm",FIND_THREE_DAYS_ORDER_URL:ctx+"/ec/salesorder/soEntity/findByCsIdAndTime.htm",FIND_GROUP_NOORDERTIME_URL:ctx+"/gl/ou/group/groupNoOrdertime.htm",};
$(document).ready(function(){$("#isCloudWarehourse").trigger("change");});SoEntityPlace.prototype={init:function(){this.soEntityBase.init();this._initPlace();
this._bindEventHander();this._hideNotGrantedBtn();},_hideNotGrantedBtn:function(a){if(ResUtils.canShow("myCsEntity.totalPrice.modify")){$(".myCsTotalAmount").removeAttr("readonly");
}else{$(".myCsTotalAmount").addClass("notModify");}if(ResUtils.canShow("subCsEntity.totalPrice.modify")){$(".subCsTotalAmount").removeAttr("readonly");
}else{$(".subCsTotalAmount").addClass("notModify");}},_initPlace:function(){if("exchange"==baseType){$("[name=soType]").val("exchange").attr("readonly",true);
}if(isPlacePage=="y"){ConfigUtils.findByKey("system.isBanDelayConfirm",function(a){if(a.success){$(".othersDiv").hide();}else{$(".othersDiv").show();}$(".delayConfirmTime").find(".simple-time-select").remove();
$("#delayConfirmTime").removeAttr("disabled");});}if(type=="self"){$(".myCs").show();$(".subCs").hide();}if(type=="mysub"){$(".myCs").hide();$(".subCs").show();
}$("[name=planId]").val(planId);if($("select[name=payType]").val()=="cash"||$("select[name=payType]").val()=="point"){$("select[name=account]").attr("disabled",true);
FinanceAccountSelect.initSelectActived("account",null);}else{$("select[name=account]").attr("disabled",false);FinanceAccountSelect.initSelectActived("account",$("input[name=accountHide]").val());
}if(ResUtils.canShow("soEntity.ship.updateShipCompany")){if($("#scCode").find("option:selected").val()==""||$("#scCode").find("option:selected").val()==null){$("#scCode").find("option:nth-child(2)").attr("selected","selected");
}}else{$("#scCode").attr("disabled",true);}ConfigUtils.findByKey("soEntity.defaultCashType",function(a){if(!$("select[name=cashType]").find("option:selected").attr("cashTypeVal")){$("select[name=cashType]").val(a.msg);
$("select[name=cashType]").trigger("change");}});ConfigUtils.findByKey("soEntity.repeatSoTypeValue",function(a){if(!$("select[name=soType]").find("option:selected").attr("soTypeVal")){if(a.msg&&$(".csSoCompleteCount").val()!=0){$("select[name=soType]").val(a.msg);
}}});this._loadOrderList();if($("input[name=cashCode]").val()){$("#userCashBtn").attr("disabled",true);$(".cashSettingInfoDiv").show();}},_save:function(B){var k=this;
var e=$("[name='addrId']").val();if(!e){DialogUtils.error(msgCode.ERROR,"请选择收货地址");return;}var f=$(".defaultAddr").find(".addrName").val();if(!f){DialogUtils.error(msgCode.ERROR,"收货地址请填写收货人");
return;}var A=$(".defaultAddr").find(".addrMobile").val();if(!A){DialogUtils.error(msgCode.ERROR,"收货地址请填写联系方式");return;}var c=$(".defaultAddr").find(".addrInfo").val();
if(!c){DialogUtils.error(msgCode.ERROR,"收货地址请填写地址信息");return;}var g=$("input[name='coName']").val();var u=$("input[name='prName']").val();var o=$("input[name='ciName']").val();
var z=$("input[name='arName']").val();var y=$("input[name='addrDetail']").val();if(!y){DialogUtils.error(msgCode.ERROR,"请填写收货地址的详细地址");return;}if(!u||!o){DialogUtils.error(msgCode.ERROR,"请填写收货地址的省市区");
return;}if(u=="澳门特别行政区"&&o=="离岛"||u=="澳门特别行政区"&&o=="澳门半岛"||u=="广东省"&&o=="东沙群岛"||u=="海南省"&&o=="海南省直辖"||u=="湖北省"&&o=="湖北省直辖"||u=="新疆维吾尔自治区"&&o=="省直辖"||g!="中国"||(u=="河南省"&&o=="济源市")){}else{if(!z){DialogUtils.error(msgCode.ERROR,"请填写收货地址的省市区");
return;}}if(!$("#soProfitTip").is(":hidden")){DialogUtils.error(msgCode.ERROR,$("#soProfitTip").text());return;}if(ResUtils.canShow("soEntity.ship.updateShipCompany")){var i=$("#scCode").val();
if(!i){DialogUtils.error(msgCode.ERROR,"请选择快递方式");return;}}var m=true;$("#soItemTbody").find(".soItemCount").each(function(){if($(this).val()<1){m=false;
DialogUtils.error(msgCode.ERROR,"商品数量不能少于1件");return false;}});if(!m){return;}var p=$("[name=totalAmount]").val();if(p==0){var v=$("[name=cashType]").val();
if("free"!=v){DialogUtils.error(msgCode.ERROR,"非免费已付的订单总金额不能为0");return;}}if(isReceivePhone){var t=/^1\d{10}$/;var C=$("input[name='tranPhone']").val();
if(!C){DialogUtils.error(msgCode.ERROR,"请填写成交号码");return;}else{if(t.test(C)==false){DialogUtils.error(msgCode.ERROR,"请填写正确成交号码");return;}}var a=$("input[name='recPhone']").val();
if(!a){DialogUtils.error(msgCode.ERROR,"请填写收款号码");return;}else{if(t.test(a)==false){DialogUtils.error(msgCode.ERROR,"请填写正确收款号码");return;}}}if($("#isCloudWarehourse").val()=="1"&&!($("#scCode").find("option:selected").text().startsWith("京东"))){if($("#cashType").val()=="cod"||$("#cashType").val()=="pay_sub"){if($("#soItemTbody tr").size()>1){m=false;
DialogUtils.error(msgCode.ERROR,"代收的商品条目不能大于1个");return false;}var r=true;$("#soItemTbody").find(".soItemCount").each(function(){if(parseInt($(this).val())>1){m=false;
r=false;DialogUtils.error(msgCode.ERROR,"代收的商品数量不能大于1件");return false;}});if(!r){return false;}}}var q=$("#payType").val();if(q=="alipay"||q=="weixin"||q=="bank"){var d=$("#account").val();
if(!d){DialogUtils.error(msgCode.ERROR,"请选择公司账户");return;}}var n=$("#delayConfirmTime").val();if(n!=""){n+=" 23:59:59";$("#isDelay").val("y");var l=n.replace(/-/g,"/");
var x=new Date(l);var b=x.getTime();var s=new Date().getTime();if(b<s){DialogUtils.error(msgCode.ERROR,"延期审单时间必须为未来的某个时间");return;}}else{$("#isDelay").val("n");
}if($("#soEntityForm").valid()){var h=$("#soItemTbody").find("tr");if(!h||h.length<1){DialogUtils.error(msgCode.ERROR,"请添加要购买的商品");return;}$("[name='soShipPo.scName']").val($("#scCode").find("option:selected").text());
$("[name='soShipPo.scCode']").val($("#scCode").find("option:selected").val());$("input[name=prodAmount]").val($("#prodPriceTotal").text());$("input[name=prodQty]").val($("#itemCountTotal").text());
var w=$("#"+SoEntityBase._CONS_.EDIT_FORM_ID).serialize()+"&isSubmit="+B+"&soItemJson="+k.soEntityBase.getSoItemData()+"&soProfitJson="+k.soEntityBase.getSoProfitData()+"&baseType="+baseType+"&originSoId="+originSoId;
if(B=="y"){var j="是否确认提交订单？";}else{var j="是否确认保存订单？";}DialogUtils.confirmWithOptions({title:j,text:"",confirmButtonText:"确认",yesFunc:function(){k._submitEntity(w,B);
}});}},_submitEntity:function(c,b){ButtonUtils.disableBtn("saveAndSubmitBtn");ButtonUtils.disableBtn("saveBtn");var a=$("input[name='id']").val()?SoEntityPlace._CONS_.SAVE_EDIT_URL:SoEntityPlace._CONS_.SAVE_ADD_URL;
FormUtils.submit(a,c,function(d){ButtonUtils.enableBtn("saveAndSubmitBtn");ButtonUtils.enableBtn("saveBtn");if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
if(b=="y"){window.location.href=SoEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+d.soEntityPo.soNo+"&canShowScTrankNo=true";}else{window.location.href=SoEntityBase._CONS_.SO_PLACE_URL+"?soId="+d.soId;
}}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);if(d.soId&&d.soId!=null&&d.soId!=""){setTimeout(function(){window.location.href=SoEntityBase._CONS_.SO_PLACE_URL+"?soId="+d.soId;
},500);}}},function(){ButtonUtils.enableBtn("saveAndSubmitBtn");ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});
},_bindEventHander:function(){var a=this;$(document).on("click","#userCashBtn",function(){FormUtils.loadData(ctx+"/gl/cash/cashHi/findByCode.htm"+"?cashCode="+$("input[name=cashCode]").val()+"&csId="+$("input[name=csId]").val(),function(c){if(c.success){var b=JSON.parse(c.msg);
$("input[name=cashId]").val(b.settingId);$("input[name=cashBenefit]").val(b.cashMoney);$(".cashSettingInfoDiv").show();$(".cashSettingLable").text("现金券券码："+b.code+"；冲抵金额："+b.cashMoney);
$(".saveAndSubmitBtn").removeAttr("disabled");$(".saveBtn").removeAttr("disabled");$("#userCashBtn").attr("disabled",true);a.soEntityBase._calSum();}else{DialogUtils.error(msgCode.ERROR,c.msg);
$("input[name=cashBenefit]").val("");$("input[name=cashId]").val("");$(".cashSettingInfoDiv").hide();$(".cashSettingLable").text("");a.soEntityBase._calSum();
}});});$(document).on("change","#csCash",function(){$("input[name=cashCode]").val($(this).val());$("input[name=cashCode]").trigger("change");});$(document).on("change","input[name=cashCode]",function(){if($(this).val()){$(".saveAndSubmitBtn").attr("disabled",true);
$(".saveBtn").attr("disabled",true);}else{$(".saveAndSubmitBtn").removeAttr("disabled");$(".saveBtn").removeAttr("disabled");$(".cashSettingInfoDiv").hide();
$("input[name=cashBenefit]").val("");$("input[name=cashId]").val("");$(".cashSettingInfoDiv").hide();$(".cashSettingLable").text("");a.soEntityBase._calSum();
}$("#userCashBtn").removeAttr("disabled");});$(document).on("click",".prevBtn",function(){DialogUtils.confirmWithOptions({title:"是否确定关闭",text:"关闭数据将丢失",confirmButtonText:"关闭",yesFunc:function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
}});});$(document).on("change","#isCloudWarehourse",function(){var b=noCloudShipCompany.split(",");if($(this).val()=="1"){for(var c=0;c<b.length;c++){$("#scCode").find("option[value='"+b[c]+"']").css("display","none");
}if($("[name='soShipPo.scCode']").val()){$("#scCode").find("option[value='"+$("[name='soShipPo.scCode']").val()+"']").prop("selected","selected");$("#scCode").trigger("change");
}else{$("#scCode option").each(function(){if($(this).css("display")=="block"){$(this).prop("selected","selected");$("#scCode").trigger("change");return false;
}});}}else{for(var c=0;c<b.length;c++){$("#scCode").find("option[value='"+b[c]+"']").css("display","block");}}});$(document).on("change","#scCode",function(){var d=$("#scCode option:selected").attr("jdPayStyle");
var c=$("#cashType").find("option:selected").val();if(d=="1"){$("#cashType option").each(function(){$(this).css("display","none");});$("#cashType").find("option[value='cod']").css("display","block");
if(c!="cod"&&c!="pay_sub"){$("#cashType").find("option[value='cod']").prop("selected","selected");}$("#cashType").find("option[value='pay_sub']").css("display","block");
}else{if(d=="2"){$("#cashType option").each(function(){$(this).css("display","none");});$("#cashType").find("option[value='pay']").css("display","block");
if(c!="pay"&&c!="green"&&c!="free"){$("#cashType").find("option[value='pay']").prop("selected","selected");}$("#cashType").find("option[value='green']").css("display","block");
$("#cashType").find("option[value='free']").css("display","block");}else{if(d=="3"||!d){$("#cashType option").each(function(){$(this).css("display","block");
});}}}var b=$(this).find("option:selected").attr("attr-mobile");$("#servicePhoneBtn").attr("masknum",b);});$(document).on("click",".saveBtn",function(){ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(c){var b=a._judgeCanPlace(c.msg);
if(b){FormUtils.loadData(SoEntityPlace._CONS_.FIND_GROUP_NOORDERTIME_URL,function(e){var d=a._judgeCanPlace(e.noOrderTime);if(d){a._save("n");}});}});});
$(document).on("click",".saveAndSubmitBtn",function(){ConfigUtils.findByKey("soEntityPlace.forbidPlaceOrderTime",function(c){var b=a._judgeCanPlace(c.msg);
if(b){FormUtils.loadData(SoEntityPlace._CONS_.FIND_GROUP_NOORDERTIME_URL,function(e){var d=a._judgeCanPlace(e.noOrderTime);if(d){a._save("y");}});}});});
$(document).on("change","#scCode",function(){var b=$(this).find("option:selected").attr("attr-mobile");$("[name='soShipPo.scCode']").val($(this).val());
$("#servicePhoneBtn").attr("masknum",b);});$(document).on("click","#servicePhoneBtn",function(c){var b=$(this).attr("masknum");if(b&&b!=""){if(b.startsWith("020")){b=b.substring(3);
}window.top.jtCtiService.dialout("9"+b);}else{DialogUtils.error(msgCode.ERROR,"没有此快递公司的客服电话");return;}});$(document).on("click",".orderMoreList",function(d){$(this).slideUp("fast");
var b=$(this).prevAll(":hidden");if(b.length>0){var c=50*(b.length-1);b.each(function(f,h){var g=$(this);setTimeout(function(){g.stop(true).fadeIn("fast").animate({"margin-left":0},"fast");
},c);c-=50;});}});},_judgeCanPlace:function(h){var e=this;var b=true;if(h==null){return b;}else{if(h!=null&&h.trim()==""){return b;}var g=h;var d=g.split("-");
if(d.length!=2){DialogUtils.error("提示","禁止下单时段参数格式有误！");return false;}var a=d[0].trim();var c=d[1].trim();if(a.length!=5||c.length!=5){DialogUtils.error("提示","禁止下单时段参数格式有误！");
return false;}var f=DateUtils.timeRangeJudge(a,c);if(!f){return b;}else{DialogUtils.error("提示","该时段("+h+")禁止下单！");return false;}}},_loadOrderList:function(){var a=SoEntityPlace._CONS_.FIND_THREE_DAYS_ORDER_URL+"?csId="+$("input[name=csId]").val();
FormUtils.loadData(a,function(d){if(d&&d.length>0){var e=new StringBuffer();e.append("<form><div class='form-group'>");e.append("<div class='form-group'><span style='color:red;'>注意：客户编号："+d[0].csCode+"在三天内已有如下订单，请注意是否重复下单。</span></div>");
for(var c=0;c<d.length;c++){var b=null;if(d[c].status=="awaiting_pay"){b="等待支付";}else{if(d[c].status=="awaiting_post"){b="待提交";}else{if(d[c].status=="awaiting_comfirm"){b="待审核";
}else{if(d[c].status=="comfirm"){b="待发货";}else{if(d[c].status=="shipping"){b="已发货";}else{if(d[c].status=="complete"){b="已签收";}else{if(d[c].status=="close"){b="订单作废";
}else{if(d[c].status=="close_reject"){b="拒收";}else{if(d[c].status=="close_lost"){b="包裹丢失";}}}}}}}}}e.append("<div  class='form-group col-sm-11'"+(c>1?" style='display:none;margin-left:2.5%;'":"")+">"+"<div class='col-sm-2'><span style='color:red;'>"+(c+1)+". 订单编号: </span><a href='#' class='soTab' csNameVal='"+d[c].csName+"'  value='"+d[c].soNo+"'>"+d[c].soNo+"</a></div>"+"<div class='col-sm-2'><span style='color:red;'>  订单金额: "+parseFloat(d[c].totalAmount).toFixed(2)+"</span></div>"+"<div class='col-sm-2'><span style='color:red;'>状态: "+b+"</span></div>"+"<div class='col-sm-2'><span style='color:red;'>下单工号: "+d[c].aid+"</span></div>");
if(d[c].statu=="awaiting_post"){e.append("<div class='col-sm-3'><span style='color:red;'>下单时间: "+d[c].placeTime+"</span></div></div>");}else{e.append("<div class='col-sm-3'><span style='color:red;'>创建时间: "+d[c].createTime+"</span></div></div>");
}}if(d.length>2){e.append("<div class='form-group col-sm-11 orderMoreList'><i class='fa fa-plus'></i>点击加载更多订单...</div> ");}e.append("</div></form>");$("#orderListContent").empty().append(e.toString());
$("#orderListDiv").stop().slideDown();}});},};