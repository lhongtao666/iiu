function SoProfit(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.soProfitRowid=1;this.orderCreateId=null;this.data=null;}SoProfit._CONS_={SAVE_PROFIT_URL:ctx+"/ec/salesorder/soEntity/saveProfit.htm",GRID:"#soProfitGrid",GRID_ID:"soProfitGrid",DIV_ID:".soProfitDiv",PAGER:"#soProfitPager",PAGER_ID:"soProfitPager",JSON_ID:"soProfitJSON",};
SoProfit.prototype={init:function(b){var a=this;if(b){if(b.orderCreateId!=undefined){a.orderCreateId=b.orderCreateId;}if(b.isCanEdit!=undefined){a.isCanEdit=b.isCanEdit;
}}if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a._initJqgrid(b,true);},_bindEventHander:function(){var a=this;$(document).on("change","input[name=percentShow]",function(){var c=$(this).parent().parent().attr("id");
var b=$(this).val();$(this).val((parseFloat(b)).toFixed(2));a._changePercent(c,b);});$(document).on("click",".delSoProfit",function(){var b=$(this).attr("value");
DialogUtils.confirmWithOptions({title:"您确定要从删除该分成记录吗?",text:"删除后需要点击上面的保存按钮才会生效",confirmButtonText:"删除",yesFunc:function(){$(SoProfit._CONS_.GRID).delRowData(b);
a.changePercent();}});});$(document).on("click",".soProfitEdit",function(){$(".soProfitEdit").hide();$(".soProfitSave").show();$(".soProfitCanel").show();
$(".selectEmpBtnDetail").show();a.changeEdit(true);});$(document).on("click",".soProfitCanel",function(){$(".soProfitEdit").show();$(".soProfitSave").hide();
$(".soProfitCanel").hide();$(".selectEmpBtnDetail").hide();a.changeEdit(false);a._initJqgrid({data:a.data,orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},false);
});$(document).on("click",".soProfitSave",function(){var b=a.save();});$(".form_wrapper").off("click","#selectEmpBtnDetail");$(".form_wrapper").on("click","#selectEmpBtnDetail",function(){var b=0;
if(ResUtils.canShow("employeeSelector.button.salesorder")){b:1;}var d={isShowAllGroup:b,grantType:"/salesorder/",isMultiple:1,mode:0,callBack:function(f){if(f!=null){if(f.length>0){for(var e=0;
e<f.length;e++){if(!a.isHadEmp(f[e].id)){a.addSoProfit2Grid({soId:$("input[name=id]").val(),partyId:f[e].id,employeeName:f[e].name,aid:f[e].aid});}}}}}};
var c=new EmployeesSelect();c.init(d);});},_hideBtn:function(){this.changeEdit(false);$(".soProfitEdit").show();$(".soProfitSave").hide();$(".soProfitCanel").hide();
$(".selectEmpBtnDetail").hide();},_getInitPersent:function(a){if(a!=this.orderCreateId){return 0;}else{var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
if(d.length<=0){return 100;}else{var b=0;for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}return 100-b;}}},_changePercent:function(d,h){var j=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");if(isNaN(h)||h==""){return;}var b=(parseFloat(h)).toFixed(2);
var f=null;var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d);for(var g=0;g<j.length;g++){if(j[g]!=d){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",j[g]);
if(e["partyId"]!=this.orderCreateId){b=parseFloat(b)+parseFloat((parseFloat(e["percent"])).toFixed(2));}else{f=j[g];}}}var a=$(SoProfit._CONS_.GRID).jqGrid("getRowData",f);
$(SoProfit._CONS_.GRID).setCell(f,"percentShow",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(f,"percent",(100-b).toFixed(2));$(SoProfit._CONS_.GRID).setCell(d,"percent",(parseFloat(h)).toFixed(2));
},checkPercent:function(h,e){var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(e);var b=null;var g=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h);
for(var c=0;c<d.length;c++){if(d[c]!=h){var f=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(f["partyId"]!=this.orderCreateId){a=a+parseFloat(f["percent"]);
}else{b=d[c];}}}if(a>100){return false;}return true;},validPercent:function(){var c=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");var a=parseFloat(0);for(var b=0;
b<c.length;b++){var d=$("#"+c[b]+"_percentShow").val();a=a+parseFloat(d);}if(a>100||a<99.99){return false;}return true;},changePercent:function(){var b=null;
var a=0;var d=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var c=0;c<d.length;c++){var e=$(SoProfit._CONS_.GRID).jqGrid("getRowData",d[c]);if(e["partyId"]!=this.orderCreateId){a=parseFloat(a)+parseFloat((parseFloat(e["percent"])).toFixed(2));
}else{b=d[c];}}console.log("totalPercent:"+a);$(SoProfit._CONS_.GRID).setCell(b,"percentShow",(100-a).toFixed(2));$(SoProfit._CONS_.GRID).setCell(b,"percent",(100-a).toFixed(2));
},_initJqgrid:function(f,a){var b=this;var e=[];if(a==true){if(f){if(typeof f.data!=undefined&&f.data!=null&&f.data.length){e=f.data;}}if(e!=null&&e.length>0){for(var c=0;
c<e.length;c++){e[c].percent=(parseFloat(e[c].percent)/100).toFixed(2);e[c].percentShow=e[c].percent;}}b.data=e;}else{e=b.data;}var d=$("#profitTitleDiv").width();
$(SoProfit._CONS_.DIV_ID).empty().append('<table id="'+SoProfit._CONS_.GRID_ID+'"></table>            <div id="'+SoProfit._CONS_.PAGER_ID+'"></div>            <input type="hidden"  name="'+SoProfit._CONS_.JSON_ID+'"  id="'+SoProfit._CONS_.JSON_ID+'">');
$.jgrid.defaults.styleUI="Bootstrap";$(SoProfit._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:e,caption:"绩效分成列表",autowidth:false,width:d,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["订单ID","员工ID","订单编号","工号","员工","比例(%)","比例","创建时间","更新时间","操作"],colModel:[{name:"soId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"partyId",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"soNo",sortable:false,editable:false,width:120,hidedlg:true,hidden:true},{name:"aid",sortable:false,editable:false,width:120,hidden:true},{name:"employeeName",sortable:false,editable:false,width:120,formatter:function(g,h,i){return i.aid+":"+g;
}},{name:"percentShow",sortable:false,editable:true,width:110},{name:"percent",sortable:false,editable:false,hidedlg:true,hidden:true,width:80},{name:"createTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"updateTime",editable:false,hidedlg:true,hidden:true,width:120},{name:"button",width:100,hidedlg:!b.isCanEdit,hidden:!b.isCanEdit}],gridComplete:function(){var h=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){var j=$(SoProfit._CONS_.GRID).jqGrid("getRowData",h[g]);if(j["partyId"]!=f.orderCreateId&&b.isCanEdit==true){var k="<i class='fa fa-remove delSoProfit'style='color:red;cursor:pointer;' title='删除'  value='"+h[g]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",h[g],{button:k});$(SoProfit._CONS_.GRID).editRow(h[g]);}}},});$(window).bind("resize",function(){if(f.widthElement){$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);
}});},getSoProfitGridData:function(){var c=$(SoProfit._CONS_.GRID);var b=new StringBuffer();var d=c.jqGrid("getDataIDs");var f=0;for(var a=0;a<d.length;
a++){var e=c.jqGrid("getRowData",d[a]);if(e["percent"]==""){continue;}else{if(parseFloat(e["percent"])<0.01){continue;}}f++;b.append("soProfitPos[").append(f-1).append("].soId=").append(e["soId"]).append("&").append("soProfitPos[").append(f-1).append("].partyId=").append(e["partyId"]).append("&").append("soProfitPos[").append(f-1).append("].percent=").append(parseInt(parseFloat(e["percent"])*100)).append("&").append("soProfitPos[").append(f-1).append("].createTime=").append(e["createTime"]).append("&").append("soProfitPos[").append(f-1).append("].updateTime=").append(e["updateTime"]).append("&");
if(!d[a].indexOf("tmpSoProfit")==0){b.append("soProfitPos[").append(f-1).append("].id=").append(d[a]).append("&");}}return b.toString();},addSoProfit2Grid:function(b){var a=this;
b.percent=a._getInitPersent(b.partyId);b.percentShow=b.percent;$(SoProfit._CONS_.GRID).jqGrid("addRowData","tmpSoProfit"+a.soProfitRowid,b,"last");a.soProfitRowid++;
},isHadEmp:function(d){var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);
if(c["partyId"]==d){DialogUtils.error(msgCode.INFO,"已存在该员工!");return true;}}return false;},changeEdit:function(d){if(d==true){this.isCanEdit=true;$(SoProfit._CONS_.GRID).jqGrid("showCol","button");
var b=$(SoProfit._CONS_.GRID).jqGrid("getDataIDs");for(var a=0;a<b.length;a++){var c=$(SoProfit._CONS_.GRID).jqGrid("getRowData",b[a]);if(c["partyId"]!=this.orderCreateId){var e="<i class='fa fa-remove delSoProfit' style='color:red;cursor:pointer;' title='删除'  value='"+b[a]+"'></i>";
$(SoProfit._CONS_.GRID).jqGrid("setRowData",b[a],{button:e});$(SoProfit._CONS_.GRID).editRow(b[a]);}}}else{this.isCanEdit=false;$(SoProfit._CONS_.GRID).jqGrid("hideCol","button");
}$(SoProfit._CONS_.GRID).setGridWidth($("#profitTitleDiv").width()-4);},save:function(){var a=this;if(!a.validPercent()){DialogUtils.error(msgCode.ERROR,"业绩分成必须等于100");
return false;}FormUtils.submit(SoProfit._CONS_.SAVE_PROFIT_URL,a.getSoProfitGridData(),function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,"修改成功");
a._hideBtn();a._initJqgrid({data:$.parseJSON(b.msg),orderCreateId:a.orderCreateId,isCanEdit:a.isCanEdit,widthElement:".soProfitWidth"},true);}else{DialogUtils.error(msgCode.ERROR,b.msg);
}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};