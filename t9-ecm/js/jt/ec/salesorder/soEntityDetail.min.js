$(function(){var a=new SoEntityDetail();a.init();});function SoEntityDetail(){this.soEntityBase=new SoEntityBase();this.soEntityQueryLogistics=new SoEntityQueryLogistics();
this.nextSoId="";this.preSoId="";this.preCsName="";this.nextCsName="";}SoEntityDetail._CONS_={SHIP_INFO_QRY_URL:ctx+"/ec/salesorder/soEntity/logicsByNo.htm",SAVE_ITEM_INFO_URL:ctx+"/ec/salesorder/soEntity/saveItemInfo.htm",DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",};
SoEntityDetail.prototype={init:function(){this.soEntityBase.init();if(isDetialPage=="y"){ConfigUtils.findByKey("system.isBanDelayConfirm",function(a){if(a.success){$(".othersDiv").hide();
}else{$(".othersDiv").show();}$(".delayConfirmTime").find(".simple-time-select").remove();});}SoEntityUtils.initDetail(financeBillAttachPos);this._bindEventHander();
$(".csName").attr("disabled",true);this._hideNotGrantBtn();CateUtils.getOptions([{typeKey:"system",pKey:"damageType",container:"damageType"},{typeKey:"system",pKey:"damageReason",container:"damageReason"}]);
if(!ResUtils.canShow("soFollow.button.addSoItemDamage")){$(".revokeDamage").hide();$(".addSoItemDamage").hide();}this.soEntityQueryLogistics.init();this._initPreNextBtn();
$(".uploadImage").hide();},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mySoEntity.button.shipQry")&&!ResUtils.canShow("soEntitySearch.button.shipQry")){$(".shipQryBtn").hide();
}},_initPreNextBtn:function(){var b=this;var c=$("#soEntityForm").find("[name=soNo]").val();var h=$("#soEntityForm").find(".csName").val();var g=window.localStorage.getItem("detail_so_soNos"+currentUserId);
var a=window.localStorage.getItem("detail_cs_names"+currentUserId);if(g){var e=g.split(",");var f=a.split(",");for(var d=0;d<e.length;d++){if(c==e[d]){if(d>0){b.preSoId=e[d-1];
b.preCsNames=f[d-1];$(".preSoBtn").show();}if(d<e.length-1){b.nextSoId=e[d+1];b.nextCsNames=f[d+1];$(".nextSoBtn").show();}break;}}}},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));});
$(document).on("click",".preSoBtn",function(){var c=a.preCsNames+"的订单明细";var e=window.localStorage.getItem("detail_canModifyProfit"+currentUserId);var b=window.localStorage.getItem("detail_canShowScTrankNo"+currentUserId);
var f=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+$("input[name=soNo]").val()+"&canModifyProfit="+e+"&canShowScTrankNo="+b;var d=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.preSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
JTTabUtils.resetTab(f,d,c);window.location.href=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.preSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;});
$(document).on("click",".nextSoBtn",function(){var c=a.nextCsNames+"的订单明细";var e=window.localStorage.getItem("detail_canModifyProfit"+currentUserId);var b=window.localStorage.getItem("detail_canShowScTrankNo"+currentUserId);
var f=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+$("input[name=soNo]").val()+"&canModifyProfit="+e+"&canShowScTrankNo="+b;var d=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.nextSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
JTTabUtils.resetTab(f,d,c);window.location.href=SoEntityDetail._CONS_.DETAIL_PAGE_URL+"?soNo="+a.nextSoId+"&canModifyProfit="+e+"&canShowScTrankNo="+b;
});$(document).on("click",".addSoItemDamage",function(){$("input[name=itemCount]").val($(this).attr("itemCount"));$("input[name=itemId]").val($(this).attr("itemIdVal"));
$("input[name=damageCount]").val($(this).attr("damageCountVal")==0?"1":$(this).attr("damageCountVal"));$("select[name=damageReason]").val($(this).attr("damageReasonVal"));
$("select[name=damageType]").val($(this).attr("damageTypeVal"));$("#damageModalContainer").modal("show");});$(document).on("click","#saveDamageBtn",function(){var b=this;
if($("input[name=damageCount]").val()<1){DialogUtils.error("提示","破损数量不能少于1");return;}if($("input[name=damageCount]").val()>$("input[name=itemCount]").val()){DialogUtils.error("提示","破损数量不能大于订单商品数量");
return;}if($("#damageReason").val()<1){DialogUtils.error("提示","破损原因不能为空");return;}if($("#damageType").val()<1){DialogUtils.error("提示","破损程度不能为空");return;
}$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageCount").val($("input[name=damageCount]").val());$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageReason").val($("#damageReason").val());
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".damageType").val($("#damageType").val());var c={"id":$("input[name=itemId]").val(),"damageCount":$("input[name=damageCount]").val(),"damageReason":$("#damageReason").val(),"damageType":$("#damageType").val(),};
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",true);FormUtils.submit(SoEntityDetail._CONS_.SAVE_ITEM_INFO_URL,c,function(d){if(d.success){$("#damageModalContainer").modal("hide");
DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").hide();
$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".revokeDamage").show();}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){$("#soItemTbody").find("tr[name="+$("input[name=itemId]").val()+"]").find(".addSoItemDamage").attr("disabled",false);
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".revokeDamage",function(){var b=this;var d={"id":$(this).attr("itemIdVal"),"damageCount":0,"damageReason":null,"damageType":null,};
var c=$(this);FormUtils.submit(SoEntityDetail._CONS_.SAVE_ITEM_INFO_URL,d,function(e){if(e.success){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
c.prev().show();c.hide();c.prev().attr("disabled",false);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){$(".revokeDamage").attr("disabled",false);
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(".soEntityDetailSubTab").on("click",".tabLi",function(d){var c=$(this).attr("attr-id");if("soEntityDetailSubTab-backOrExchangeTab"==c&&!a.backOrExchangeInit){var b=$("[name=id]").val();
if(b){a._loadBackOrExchangeTab(b);}a.backOrExchangeInit=true;}});},_loadBackOrExchangeTab:function(b){var a=ctx+"/ec/salesorder/soEntity/loadBackOrExchangeSoInfoPos.htm?id="+b;
FormUtils.loadData(a,function(g){if(g){var h=new StringBuffer();for(var e=0;e<g.length;e++){var d=g[e];var c="";if("exchange"==d.baseType){c="(换)";}else{if("back"==d.baseType){c="(退)";
}else{if("back_before_exchange"==d.baseType){c="(换前退)";}}}var f="";if(d.completeTime){if(d.completeTime=="null"){f="";}else{f=d.completeTime;}}h.append("<tr>");
h.append("<td>");h.append("<a href='#' title='"+d.soNo+"'  class='soTab' value='"+d.soNo+"' csIdVal='"+d.csId+"' attr-status='"+d.status+"' attr-placerId='"+d.placerId+"' attr-soType='"+d.soType+"' attr-id='"+d.id+"'>"+d.soNo+c+"</a>");
h.append("</td>");h.append("<td>"+d.scTrackingNo+"</td>");h.append("<td>"+d.partyName+"</td>");h.append("<td>"+d.partyAddr+"</td>");h.append("<td>"+d.partyMaskPhone+"</td>");
h.append("<td>"+d.totalAmount+"</td>");h.append("<td>"+d.prodNames+"</td>");h.append("<td>"+d.placeTime+"</td>");h.append("<td>"+f+"</td>");h.append("<td>"+SoEntityUtils.formatStatus(d)+"</td>");
h.append("<td>"+d.placerName+"</td>");h.append("<td>"+d.profits+"</td>");h.append("</tr>");}$("#tab-backOrExchange-tbody").empty().append(h.toString());
}},null,false);},};