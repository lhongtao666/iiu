$(function(){var a=new FinanceBillToEdit();a.init();});function FinanceBillToEdit(){isPoint=false;this.soEntityBase=new SoEntityBase();this.financeBillBase=new FinanceBillBase();
this.csFollow=new CsFollow();}FinanceBillToEdit._CONS_={SO_SAVE_PAY_URL:ctx+"/ec/salesorder/soEntity/soSaveEdit.htm",LIST_DATA_URL:ctx+"/ec/finance/financeBill/listData.htm",EDIT_URL:ctx+"/ec/finance/financeBill/edit.htm",EDIT_FORM_ID:"financeBillForm",};
FinanceBillToEdit.prototype={init:function(){this.soEntityBase.init();this._initPay();this._initFollow();this._hideNotGrantBtn();this._bindEventHander();
this._bindFormValidation();ConfigUtils.findByKey("soEntity.isEditSaveSo",function(a){if(a.success&&ResUtils.canShow("financeBill.button.saveSoPayBtn")){}else{$(".saveSoPayBtn").hide();
FormUtils.disableForm("soEntityForm");}ConfigUtils.findByKey("system.isBanDelayConfirm",function(b){if(b.success){$(".othersDiv").hide();}else{$(".othersDiv").show();
}$(".delayConfirmTime").find(".simple-time-select").remove();});});$(".cashSettingDiv").hide();if($("input[name=cashCode]").val()){$(".cashSettingInfoDiv").show();
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("financeBillToEdit.button.changeAndAddAddr")){$(".changeAddr").hide();$(".addAddr").hide();}if(!ResUtils.canShow("financeBillToEdit.button.delAndSelectSoItem")){$(".delSoItem").hide();
$("#selectSkuBtn").hide();}if(!ResUtils.canShow("financeBillToEdit.button.callBtns")){$(".callBtns").hide();}if(!ResUtils.canShow("financeBillToEdit.button.viewPhone")){$(".viewPhone").hide();
}},_initPay:function(){$(".delayConfirmTime").find(".simple-time-select").remove();$(".csName").attr("readonly",true);$("select[name=soType]").attr("disabled",true);
$("select[name=cashType]").attr("disabled",true);$("select[name=payType]").attr("disabled",true);$("select[name=account]").attr("disabled",true);$("#selectEmpBtn").hide();
$("#typeSelect").val(financeType);$("input[name=type]").val(financeType);if($("select[name=entityType]").val()=="none"){$("input[name=entityNo]").val("");
$("input[name=entityNo]").attr("readonly",true);}else{$("input[name=entityNo]").attr("readonly",false);}var a=$("#"+FinanceBillToEdit._CONS_.EDIT_FORM_ID);
a.find("input[name=status]").val("done");a.find("select[name=status]").val("done");a.find("select[name=payAccount]").attr("disabled",false);a.find("select[name=receiptAccount]").attr("disabled",false);
FormUtils.disableForm(FinanceBillToEdit._CONS_.EDIT_FORM_ID);this._showComplete();this._loadData(financeId,false);this._initTabName();},_initFollow:function(){var a=this;
var b=$("#soEntityForm").find("input[name=id]").val();if(b){var c={csId:$("#soEntityForm").find("input[name=csId]").val(),csCode:$("#soEntityForm").find(".csCode").val(),entityId:b,needTable:false,followType:"so",fn:function(d){a._addSoLog(d);
}};this.csFollow.init(c,{partyId:$("#soEntityForm").find("input[name=employeeId]").val(),partyAid:$("#soEntityForm").find("input[name=employeeAid]").val(),partyName:$("#soEntityForm").find("input[name=employeeName]").val()});
}},_initTabName:function(){var a=$("input[name=soNo]").val();if($("select[name=payType]").val()=="cash"){$("select[name=account]").attr("disabled",true);
}var b="订单["+a+"]收付";JTTabUtils.renameForActiveTab(b);},_addSoLog:function(b){var c={};c.employeeAid=currentUserAid;c.employeeName=currentUserName;c.srcType="option_sys";
c.type="task";c.result="跟进成功";c.createTime=DateUtils.format(new Date(),DateUtils._CONS_.DEFAULT_DATE_TIME_PATTERN);c.comment=b.content;var d=$.templates("#soLogTmpl");
var a=d.render(c);$("#soLogTbody").prepend(a);},_bindEventHander:function(){var a=this;$(".saveSoPayBtn").on("click",function(){a._save();});$(document).on("click",".completeBtn",function(){var b=true;
a.financeBillBase._saveFinish(b);});$(document).on("click",".financeBillTrunDown",function(){var b=$(this).parent().parent().parent().parent().parent().next();
a.financeBillBase._trunDownSingle(b,true);});$(document).on("click",".prevBtn",function(){JTTabUtils.closeTab($(window.top.document).find(".page-tabs-content").find(".active").attr("data-id"));
});},_bindFormValidation:function(){var a={rules:{payAccount:{required:true,maxlength:["250"]},receiptAccount:{required:true,maxlength:["250"]},},messages:{}};
FormUtils.bindFormValidation("financeBillForm",a);},_showComplete:function(){$(".addDiv").show();$(".statusDiv").hide();$(".processInfoDiv").hide();$(".financeItemAdd").hide();
$(".financeBillAttachAdd").hide();$(".completeBtn").show();$(".saveBtn").hide();$(".entityNoDiv").show();$(".entityTypeDiv").show();this._initInput();},_initInput:function(){if("receipt"==financeType){$(".receiptAccountDiv").empty().append("<select name='receiptAccount'  id='receiptAccount' class='form-control' validateType='default' ></select>");
$(".payAccountContent").hide();$(".receiptAccountContent").show();}else{$(".payAccountContent").show();$(".receiptAccountContent").hide();$(".payAccountDiv").empty().append("<select name='payAccount' id='payAccount' class='form-control' validateType='default' ></select>");
}},_loadData:function(b){var a=this;FormUtils.loadData(FinanceBillToEdit._CONS_.EDIT_URL+"?id="+b,function(e){var d=new UploadImageUtil();d.init("uploader");
if(e.financeBillAttachPos&&e.financeBillAttachPos.length>0){$("#imageContainer").empty().append(ImageUtils.createImageDivStr(e.financeBillAttachPos,null,true,null,true));
}if(e.entityType=="salesorder"||e.entityType=="returnentity"||e.entityType=="exchange"){$(".otherInfo").hide();}else{$(".otherInfo").show();}if(e.type!="receipt"&&e.type!=null){FinanceAccountSelect.initSelectActived("payAccount",e.payAccount,function(){if(!$("#payAccount").val()){$("#payAccount").find("option:nth-child(2)").attr("selected","selected");
}});}else{FinanceAccountSelect.initSelectActived("receiptAccount",e.receiptAccount,function(){if(!$("#receiptAccount").val()){$("select[name=payType]").trigger("change");
}});}var c=$("#"+FinanceBillToEdit._CONS_.EDIT_FORM_ID);c.find("input[name=id]").val(e.id);c.find("#typeSelect").val(e.type);c.find("input[name=type]").val(e.type);
c.find("select[name=entityType]").val(e.entityType);c.find("input[name=entityType]").val(e.entityType);c.find("input[name=entityNo]").val(e.entityNo);c.find("input[name=title]").val(e.title);
c.find("input[name=payType]").val(e.payType);c.find("select[name=payType]").val(e.payType);c.find("select[name=payAccount]").val(e.payAccount);c.find("select[name=receiptAccount]").val(e.receiptAccount);
c.find("input[name=personId]").val(e.personId);c.find("input[name=orgId]").val(e.orgId);c.find("input[name=personName]").val(e.personName);c.find("input[name=groupName]").val(e.groupName);
c.find("input[name=status]").val(e.status);c.find("select[name=status]").val(e.status);c.find("textarea[name=summary]").val(e.summary);c.find("input[name=total]").val(e.total);
c.find("input[name=completeTime]").val(e.completeTime);c.find("input[name=auditTime]").val(e.auditTime);c.find("input[name=auditorId]").val(e.auditorId);
c.find("input[name=auditorName]").val(e.auditorName);c.find("textarea[name=auditComment]").val(e.auditComment);c.find("input[name=attachCount]").val(e.attachCount);
c.find("input[name=createTime]").val(e.createTime);c.find("input[name=updateTime]").val(e.updateTime);});},_save:function(){var k=this;var b=$("[name='addrId']").val();
if(!b){DialogUtils.error(msgCode.ERROR,"请选择收货地址");return;}var a=$(".defaultAddr").find(".addrName").val();if(!a){DialogUtils.error(msgCode.ERROR,"收货地址请填写收货人");
return;}var f=$(".defaultAddr").find(".addrMobile").val();if(!f){DialogUtils.error(msgCode.ERROR,"收货地址请填写联系方式");return;}var c=$(".defaultAddr").find(".addrInfo").val();
if(!c){DialogUtils.error(msgCode.ERROR,"收货地址请填写地址信息");return;}var i=$("#scCode").val();if(!i){DialogUtils.error(msgCode.ERROR,"请选择快递方式");return;}var d=$("[name=totalAmount]").val();
if(d==0){var e=$("[name=cashType]").val();if("free"!=e){DialogUtils.error(msgCode.ERROR,"非免费已付的订单总金额不能为0");return;}}if($("#soEntityForm").valid()){var j=$("#soItemTbody").find("tr");
if(!j||j.length<1){DialogUtils.error(msgCode.ERROR,"请添加要购买的商品");return;}$("[name='soShipPo.scName']").val($("#scCode").find("option:selected").text());
$("[name='soShipPo.scCode']").val($("#scCode").find("option:selected").val());$("input[name=prodAmount]").val($("#prodPriceTotal").text());$("input[name=prodQty]").val($("#itemCountTotal").text());
var h=new UploadImageUtil();var g=$("#soEntityForm").serialize()+"&soItemJson="+k.soEntityBase.getSoItemData()+"&soProfitJson="+k.soEntityBase.getSoProfitData()+"&operComment="+$("input[name=operComment]").val()+"&billAttachJson="+JSON.stringify(h._buildImageJson());
DialogUtils.confirmWithOptions({title:"是否确认保存订单？",text:"",confirmButtonText:"确认",yesFunc:function(){k._submitEntity(g);}});}},_submitEntity:function(d){var b=this;
var c=this.nextSoId;ButtonUtils.disableBtn("saveSoPayBtn");var a=FinanceBillToEdit._CONS_.SO_SAVE_PAY_URL;FormUtils.submit(a,d,function(e){ButtonUtils.enableBtn("saveSoPayBtn");
if(e.success){DialogUtils.success(msgCode.INFO,e.msg+"成功");b.init();}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("saveSoPayBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};