$(function(){var a=new SoShipment();a.init();});function SoShipment(){this.hadInit=false;this.isEdit=false;this.files=[];}SoShipment._CONS_={LIST_DATA_URL:ctx+"/ec/salesorder/soEntity/soShipmentData.htm",KEYSEARCH_URL:ctx+"/crm/cs/csEntity/findByNameOrCode.htm",BALANCE_COMPLETE_URL:ctx+"/ec/salesorder/soEntity/balanceComplete.htm",DETAIL_URL:ctx+"/ec/salesorder/soEntity/soShipmentDetail.htm",REVOKE_TIME:ctx+"/ec/salesorder/soEntity/revokeTime.htm",IMPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/importExcel.htm",EXPORT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportExcel.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",EMPLOYEE_LIST_URL:ctx+"/crm/ou/employee/listEmployees.htm",LIST_DATA_STAT_URL:ctx+"/ec/salesorder/soEntity/soShipmentStatData.htm",EXPORT_STAT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportStatExcel.htm",BATCHRECEIVED_URL:ctx+"/ec/salesorder/soEntity/batchReceived.htm",GRID:"#soShipmentGrid",PAGER:"#soShipmentPager",UPLOAD_PARAMS:{"acceptTypes":".*","mimeTypes":".xls,.xlsx","fileSingleSizeLimit":1*1024*1024*1,"fileNumLimit":10,"uploadUrl":ctx+"/crm/components/upload/ajax.htm?categoryDir=temp"}};
SoShipment.prototype={init:function(c){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantBtn();var a=new Date().currentDate()+" 00:00:00";
$("#placeTimeStartSearch").val(a);$("#placeTimeStatStartSearch").val(a);ShipCompanyUtils.getOptions({container:"scNameSearch",caption:"全部"});ShipCompanyUtils.getOptions({container:"scNameStatSearch",caption:"全部"});
$(".hideSearchParam").hide();var b={"Q__D__BW__entity.place_time_":a};this._initJqgrid(b);this._locateToGlHelp();this._initStatSo(b);}},_locateToGlHelp:function(){var a="glHelp.finance.soShipment";
glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("soShipment.button.balanceComplete")){$(".balanceComplete").hide();}if(!ResUtils.canShow("soShipment.button.importExcel")){$(".importExcel").hide();
}if(!ResUtils.canShow("soShipment.button.exportExcel")){$(".toExportExcel").hide();}if(!ResUtils.canShow("soShipment.button.batchReceived")){$(".soEntityBatchReceived").hide();
}},_bindEventHander:function(){var a=this;$(".showSearch").on("click",function(){$(".hideSearchParam").show();$(".hideSearch").show();$(this).hide();});
$(".hideSearch").on("click",function(){$(".hideSearchParam").hide();$(".showSearch").show();$(this).hide();});$(document).on("change","#codeSearchIpt",function(){if(!$("#codeSearchIpt").val()){$("#searchCode").val("");
}});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",positionType:"all",fn:function(c){$("input[name=belongOgn]").val(c);
a.buildEmployeeOption(c);}};GroupUtils.selectGroupTreeBox(b);});$(document).on("click",".balanceSoShip",function(){$(".form_wrapper").show();var b=new SoShipmentLayer();
b.init({id:$(this).attr("idVal"),callBack:function(c){$(".soShipmentSearch").trigger("click");}});});$(document).on("click",".revokeSoShip",function(){var d=$(this).attr("idVal");
var b=SoShipment._CONS_.REVOKE_TIME;var c="id="+d;FormUtils.submit(b,c,function(e){if(e.success){a.reloadJqgrid(a.handleParams());}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(".list_wrapper").on("click",".soShipmentSearch",function(){a.reloadJqgrid(a.handleParams());});$(".list_wrapper").on("click",".soShipmentStatSearch",function(){if(!$("#soShipmentStatSearchForm").find("input[name='Q__D__BW__entity.create_time_']").val()){DialogUtils.error("错误","请填写开始时间");
return;}var b=$("#soShipmentStatSearchForm").serialize();a._initStatSo(b);});$(".panel-body").on("keypress","form",function(b){if(b.keyCode=="13"){$(".soShipmentSearch").eq(0).trigger("click");
}});$(".panel-body").on("click",".soShipmentClearSearch",function(){$("#soShipmentSearchForm").find(".balanceSearch").each(function(){$(this).removeAttr("checked");
});FormUtils.clear("#soShipmentSearchForm");});$(document).on("click",".balanceComplete",function(){var d=$(this).attr("idVal");if(!d){d=$(SoShipment._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(d==null||d.length==0){DialogUtils.error(msgCode.error,"请选择要结算的记录");return;}}var b=SoShipment._CONS_.BALANCE_COMPLETE_URL;var c="&ids="+d;FormUtils.submit(b,c,function(e){ButtonUtils.enableBtn("balanceComplete");
if(e.success){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);a.reloadJqgrid(a.handleParams());}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("balanceComplete");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".prevBtn",function(){a.clear(false);});$("body").on("click",".toExportExcel",function(){var b=$(SoShipment._CONS_.GRID).jqGrid("getGridParam","selarrrow");
a._toExportExcel(b);});$("body").on("click",".toExportStatExcel",function(){var b=$("#soShipmentStatSearchForm").serialize();a._toExportStatExcel(b);});
$("body").on("click",".importExcel",function(){var b={"importUrl":SoShipment._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入出货订单excel数据"};excelUtil.importExcel(b);
});$("body").on("click",".exportExcel",function(){a._exportExcel();});$("body").on("click","#allCheck",function(){var b=true;if(!$(this).is(":checked")){b=false;
}$("#columnContainer").find(".columnCheckBox").each(function(){$(this).prop("checked",b);});});$(document).on("click",".soDetailLink",function(){var b=$(this).attr("value");
if(b.length>4){var c="*"+b.substring(b.length-3,b.length);}JTTabUtils.addOrRefreshTab(SoShipment._CONS_.SO_DETAIL_URL+"?soNo="+b,"订单["+c+"]明细");});$(document).on("click",".soDetailListBtn",function(){$("#soDetailTabLi").addClass("active");
$("#tabSoDetail").addClass("active");$("#soStatTabLi").removeClass("active");$("#tabSoStat").removeClass("active");$(".soShipmentClearSearch").trigger("click");
$("#soShipmentSearchForm").find(".timeStartSearch").val($("#soShipmentStatSearchForm").find(".timeStartSearch").val());$("#soShipmentSearchForm").find(".timeEndSearch").val($("#soShipmentStatSearchForm").find(".timeEndSearch").val());
$("#soShipmentSearchForm").find("#scNameSearch").val($(this).parents("tr").attr("scCodeVal"));a.reloadJqgrid(a.handleParams());});$("body").on("click",".soEntityBatchReceived",function(){var b=$(SoShipment._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要处理的订单");return;}var f=new StringBuffer();for(var d=0;d<b.length;d++){var e=$(SoShipment._CONS_.GRID).jqGrid("getRowData",b[d]);
f.append(e["soId"]+",");}var c=f.toString();c=c.substring(0,c.length-1);FormUtils.submit(SoShipment._CONS_.BATCHRECEIVED_URL,{ids:c},function(g){ButtonUtils.enableBtn("soEntityBatchReceived");
if(g.success){if(g.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(g.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}a.reloadJqgrid(a.handleParams());}else{DialogUtils.error(msgCode.FAIL_MSG,g.msg);}},function(){ButtonUtils.enableBtn("soEntityBatchReceived");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},_initStatSo:function(b){var a=this;FormUtils.submit(SoShipment._CONS_.LIST_DATA_STAT_URL,b,function(c){$("#soShipmentStatBody").empty();if(c!=null){for(var d=0;
d<c.length;d++){$("#soShipmentStatBody").append(a._buildTableStr(d+1,c[d]));}}});},_buildTableStr:function(a,b){var c=new StringBuffer();c.append("<tr scCodeVal='"+b.scCode+"'>");
c.append("<td>"+a+"</td>");c.append("<td>"+b.scName+"</td>");c.append("<td>"+b.actualAmount+"</td>");c.append("<td>"+b.proxyAmount+"</td>");c.append("<td>"+b.counterAmount+"</td>");
c.append("<td>"+b.breakAmount+"</td>");c.append("<td>"+b.notBalanceAmount+"</td>");c.append("<td>"+b.actualedAmount+"</td>");c.append("<td>"+b.proxyedAmount+"</td>");
c.append("<td>"+b.counteredAmount+"</td>");c.append("<td>"+b.breakedAmount+"</td>");c.append("<td>"+b.balanceAmount+"</td>");c.append("<td>"+b.totalAmount+"</td>");
c.append("<td><button type='button' class='jt-btn-safe soDetailListBtn'>明细</button></td>");c.append("</tr>");return c.toString();},buildEmployeeOption:function(b,c,d){var a=d?d:"dept_manager";
$.ajax({type:"GET",url:SoShipment._CONS_.EMPLOYEE_LIST_URL+"?groupId="+b+"&type="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f&&f.length>0){var g=new StringBuffer();
g.append("<option value=''>请选择</option>");for(var e=0;e<f.length;e++){g.append("<option value='"+f[e].id+"'>"+f[e].aid+":"+f[e].name+"</option>");}if(c){$("#"+c).empty().append(g.toString());
}else{$("#belongEmployeeSearch").empty().append(g.toString());}}}});},_toExportExcel:function(b){var a=this;$(".prevBtn").show();$(".list_wrapper").hide();
$(".form_wrapper").hide();$(".excel_wrapper").show();if(b&&b.length>0){$("#endExportNum").val(b.length);}$("input[name=selectIds]").val(b);excelUtil.findExportColByModule("soShip",true,function(d){var e=new StringBuffer();
if(d&&d.length>0){for(var c=0;c<d.length;c++){e.append("<div class='checkbox checkbox-success checkbox-inline'>");e.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
e.append("</div>");}}$("#columnContainer").empty().append(e.toString());});},_toExportStatExcel:function(a){window.location.href=SoShipment._CONS_.EXPORT_STAT_EXCEL_URL+"?"+a;
},_exportExcel:function(){var b=this;var d=$("#columnContainer").find(".columnCheckBox");var f=[];$(d).each(function(){if($(this).is(":checked")){f.push($(this).val());
}});var a=$("#beginExportNum").val();var c=$("#endExportNum").val();if(!a){DialogUtils.error(msgCode.ERROR,"请填写正确的开始记录");return;}if(!c){DialogUtils.error(msgCode.ERROR,"请填写正确的结束记录");
return;}if(a>c){DialogUtils.error(msgCode.ERROR,"开始记录不能大于结束记录");return;}if(parseInt(a)-parseInt($(SoShipment._CONS_.GRID).jqGrid("getGridParam","records"))>0){DialogUtils.error(msgCode.ERROR,"开始记录不能大于记录总条数");
return;}if(!c){c=a;}var h=b.handleParams();var e=$("input[name=selectIds]").val();if(e&&e.length>0){var g=h+"&columns="+f.toString()+"&Q__S__IN__ship.id_="+e;
}else{var g=h+"&columns="+f.toString()+"&beginExportNum="+a+"&endExportNum="+c;}window.location.href=SoShipment._CONS_.EXPORT_EXCEL_URL+"?"+g;},handleParams:function(){var a="";
if($("input[name=balanceActualSearch]").is(":checked")){a="actualBlance";}if($("input[name=balanceProxySearch]").is(":checked")){a=a+",proxyBlance";}if($("input[name=balanceLostSearch]").is(":checked")){a=a+",breakBlance";
}if($("input[name=balanceCloseSearch]").is(":checked")){a=a+",completeBlance";}if($("input[name=balancedShipSearch]").is(":checked")){a=a+",shipBlanced";
}if($("input[name=balanceCollectSearch]").is(":checked")){a=a+",collectBlanced";}var b=$("#soShipmentSearchForm").serialize();if(a){b=b+"&type="+a;}return b;
},clear:function(c){var a=this;function b(){a._showListWrapper();a.isEdit=false;if(c){a.reloadJqgrid(a.handleParams());}}if(a.isEdit){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();$(".excel_wrapper").hide();},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(SoShipment._CONS_.GRID,a);
},_initJqgrid:function(d){var a=this;var c=false;if(d==null||typeof d==undefined){d={};}var b=SoShipment._CONS_.LIST_DATA_URL;$(SoShipment._CONS_.GRID).JTJqgrid({url:b,pager:SoShipment._CONS_.PAGER,postData:d,autoScroll:true,shrinkToFit:false,colNames:["订单ID","快递公司","快递单号","订单号","货款类型","订单状态","总金额（元）","发货时间","运费","代收款/手续费","已收代收款/手续费","丢失/拒收","出货状态","代收款","手续费","赔付","其他","操作"],colModel:[{name:"soId",index:"so_id_",width:60,hidden:true},{name:"scName",index:"sc_name_",width:60},{name:"scTrackingNo",index:"sc_tracking_no_",width:110},{name:"soNo",width:70,formatter:function(e,f,g){if(g.footData){return g.soNo;
}else{return"<a href='#'  class='soDetailLink' value='"+g.soNo+"'>"+g.soNo+"</a>";}},},{name:"cashType",width:60,height:30,formatter:function(e,g,h){var f=h.cashType;
if(h.cashType=="pay"){f="款到发货";}else{if(h.cashType=="pay_sub"){f="支付订金";}else{if(h.cashType=="cod"){f="货到付款";}else{if(h.cashType=="free"){f="免费已付";}}}}return f;
}},{name:"status",width:60,formatter:function(e,g,h){var f=h.status;if(h.status=="complete"){if(h.isReceived=="y"){f="已签收(已回款)";}else{f="已签收(未回款)";}}else{if(h.status=="close_reject"){f="拒收";
}else{if(h.status=="close_lost"){f="丢失";}else{if(h.status=="shipping"){f="已发货";}}}}return f;}},{name:"totalAmount",width:75,formatter:function(e,f,g){return g.totalAmount;
}},{name:"shipTime",width:75,title:"ship_time_",formatter:function(e){return DateUtils.miniTime(e);}},{name:"actualAmount",width:40,formatter:function(e,f,g){return g.actualAmount;
}},{name:"proxyAndCounterAmount",width:98,sortable:false,formatter:function(e,f,g){return g.proxyAmount+"/"+parseFloat(g.counterAmount).toFixed(2);}},{name:"proxyedAndCounteredAmount",width:98,index:"ship.proxyed_amount_",formatter:function(e,f,g){return g.proxyedAmount+"/"+parseFloat(g.counteredAmount).toFixed(2);
}},{name:"breakAndOtherAmount",width:142,sortable:false,formatter:function(e,f,g){var h=new StringBuffer();h.append("<div class='form-group'><span class='col-sm-7' style='padding:0px;'>赔付:"+g.breakAmount+"</span>");
h.append("<span class='col-sm-5' style='padding:0px;'>其他:"+g.otherAmount+"</span></div>");return h.toString();}},{name:"entirety",width:58,sortable:false,formatter:function(e,g,h){if(h.cashType=="pay_sub"||h.cashType=="cod"){var f="";
if(h.status=="complete"){if(h.actualTime&&h.proxyTime){c=true;f="<span class='balanceComplete'>结算完成</span>";}}else{if(h.actualTime&&h.otherTime){c=true;
f="<span class='balanceComplete'>结算完成</span>";}}}else{if(h.status=="complete"){if(h.actualTime){c=true;f="<span class='balanceComplete'>结算完成</span>";}}else{if(h.actualTime&&h.otherTime){c=true;
f="<span class='balanceComplete'>结算完成</span>";}}}if(!f){c=false;f="<span class='unfinished'>未完成</span>";}return f;}},{name:"proxyAmount",index:"proxy_amount_",width:110,hidedlg:true,hidden:true},{name:"counterAmount",index:"counter_amount_",width:110,hidedlg:true,hidden:true},{name:"breakAmount",index:"break_amount_",width:110,hidedlg:true,hidden:true},{name:"otherAmount",index:"other_amount_",width:110,hidedlg:true,hidden:true},{name:"operation",width:45,formatter:function(e,f,g){if(c){return"<a href='#' class='revokeSoShip' style='color:red;' idVal='"+g.id+"'>撤销</a>";
}else{return"<a href='#' class='balanceSoShip' idVal='"+g.id+"'>结算</a>";}}}],footerrow:true,userDataOnFooter:true,gridComplete:function(){var e=$(SoShipment._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
e.find('td[aria-describedby*="rn"],td[aria-describedby*="cb"],td[aria-describedby*="__manage"],td[aria-describedby*="cashType"],td[aria-describedby*="status"],td[aria-describedby*="totalAmount"],td[aria-describedby*="shipTime"],td[aria-describedby*="scName"],td[aria-describedby*="scTrackingNo"],td[aria-describedby*="actualAmount"],td[aria-describedby*="proxyAndCounterAmount"],td[aria-describedby*="proxyedAndCounteredAmount"],td[aria-describedby*="breakAndOtherAmount"],td[aria-describedby*="entirety"],td[aria-describedby*="operation"]').hide();
e.find('td[aria-describedby*="soShipmentGrid_soNo"]').show();},loadComplete:function(){$("#endExportNum").val($(SoShipment._CONS_.GRID).jqGrid("getGridParam","records"));
},});},};