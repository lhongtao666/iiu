function FinanceBillBase(){this.hadInit=false;this.isEdit=false;this.grid=null;this.pager=null;this.onSelectRow=null;this.listDataUrl=null;this.exportUrl=null;
this.gridRecordsSpan=null;this.widthElement=null;this.type=null;this.status=null;this.uploadImageUtil=new UploadImageUtil();this.searchParam={};this.metaParams={};
}FinanceBillBase._CONS_={EXPORT_URL:ctx+"/ec/finance/financeBill/export.htm",LIST_DATA_URL:ctx+"/ec/finance/financeBill/listData.htm",EDIT_URL:ctx+"/ec/finance/financeBill/edit.htm",DETAIL_URL:ctx+"/ec/finance/financeBill/detail.htm",DELETE_URL:ctx+"/ec/finance/financeBill/delete.htm",REMOVE_URL:ctx+"/ec/finance/financeBill/remove.htm",SAVE_ADD_URL:ctx+"/ec/finance/financeBill/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/finance/financeBill/saveEdit.htm",COMPLETE_URL:ctx+"/ec/finance/financeBill/complete.htm",BATCHCOMPLETE_URL:ctx+"/ec/finance/financeBill/batchComplete.htm",SO_DETAIL_PAGE_URL:ctx+"/ec/salesorder/soEntity/detail.htm",RETURN_DETAIL_PAGE_URL:ctx+"/ec/ret/returnEntity/detail.htm",CHANGE_DETAIL_PAGE_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",TURN_DOWN_URL:ctx+"/ec/salesorder/soEntity/turndown.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detail.htm",SO_WAIT_PAY_URL:ctx+"/ec/salesorder/soEntity/waitPay.htm",EXPORT_PRODUCT_EXCEL_URL:ctx+"/ec/salesorder/soEntity/exportSoProduct2.htm",EDIT_FORM_ID:"financeBillForm",DISABLE_ALL_BTNS:function(){$(".financeBillEdit").attr("disabled",true);
$(".financeBillComplete").attr("disabled",true);$(".financeBatchComplete").attr("disabled",true);$(".financeBillAudit").attr("disabled",true);$(".financeBillDel").attr("disabled",true);
$(".financeBillDetail").attr("disabled",true);$(".financeBillDelete").attr("disabled",true);}};FinanceBillBase.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;
this.listDataUrl=FinanceBillBase._CONS_.LIST_DATA_URL;this.exportUrl=FinanceBillBase._CONS_.EXPORT_URL;if(a){if(a.type){this.type=a.type;}if(a.listParams){this.listDataUrl=this.listDataUrl+"?"+a.listParams;
this.status=a.listParams;this.metaParams=a.listParams;}if(a.grid){this.grid=a.grid;}if(a.pager){this.pager=a.pager;}if(a.gridRecordsSpan){this.gridRecordsSpan=a.gridRecordsSpan;
}if(a.getManagerBtns){this.getManagerBtns=a.getManagerBtns;}if(a.onSelectRow){this.onSelectRow=a.onSelectRow;}if(a.widthElement){this.widthElement=a.widthElement;
}if(a.searchParam){this.searchParam=a.searchParam;var b=new StringBuffer();$.each(a.searchParam,function(c,d){b.append(c);b.append("="+d);});this.metaParams=this.metaParams+"&"+b.toString();
}}this._bindEventHander();this._initJqgrid(this.searchParam);this._buildEmployeeSelect();this.uploadImageUtil.init("uploader");}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString()).select2();
$("#planMan").empty().append(d.toString()).select2();}}});},_showExportLayer:function(c){var b=this;var a="&"+b.status;FormUtils.submit(FinanceBillBase._CONS_.EXPORT_PRODUCT_EXCEL_URL,c.params+a+"&selectIds="+c.selectIds,function(d){},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
},true);},_bindEventHander:function(){var a=this;$(a.widthElement).on("click",".exportSo",function(){var d=$(a.widthElement).find(".financeBillForm").serialize();
var b=$(a.grid).jqGrid("getGridParam","selarrrow");var c=$(a.grid).jqGrid("getGridParam","records");a._showExportLayer({params:d,selectIds:b,toatolCount:c});
});$(a.widthElement).on("click",".financeBillSearch",function(){var b=$(this).closest("form").serialize();a.metaParams=b;a.reloadJqgrid(b);});$(a.widthElement).on("click",".soEntityTrunDown",function(){var b=$(a.grid).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error("错误","请选择要处理的订单");return;}var e=new Array();for(var c=0;c<b.length;c++){var d=$(a.grid).jqGrid("getRowData",b[c]);
e.push(d["entityNoHide"]);}a.trunDownOrderLayer(e);a._commentSearch();});$(".panel-body").on("keypress","form",function(b){if(b.keyCode=="13"){$(".financeBillSearch").eq(0).trigger("click");
}});$("body").on("click",".csTab",function(){var c=$(this).text();var b=$(this).attr("value");if(c.length>4){c="*"+c.substring(c.length-3,c.length);}JTTabUtils.addOrRefreshTab(FinanceBillBase._CONS_.DETAIL_CS_PAGE_URL+"?csId="+b,"客户["+c+"]明细");
});$("body").on("change","select[name=payType]",function(){var b=$(this).val();var d="";if(a.type!="receipt"&&a.type!=null){d=$("select[name=payAccount]").find("option");
}else{d=$("select[name=receiptAccount]").find("option");}if(d&&d.length>0){for(var c=0;c<d.length;c++){if($(d[c]).attr("attr-type")==b){$(d[c]).attr("selected",true);
break;}else{$(d[c]).attr("selected",false);}}}});$(".selectBelongOgn").on("click",function(){GroupUtils.selectGroupTreeBox({isMultiple:1,selectedGroupId:$("input[name='belongOgn']").val(),container:"belongOgnName",fn:function(b){$("input[name='belongOgn']").val(b);
a.buildEmployeeOption(b);}});});},buildEmployeeOption:function(b){var a="dept_manager";$.ajax({type:"GET",url:FinanceBill._CONS_.EMPLOYEE_LIST_URL+"?groupId="+b+"&type="+a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(d){if(d&&d.length>0){var e=new StringBuffer();
e.append("<option value=''>请选择</option>");for(var c=0;c<d.length;c++){e.append("<option value='"+d[c].id+"'>"+d[c].aid+":"+d[c].name+"</option>");}$("#belongEmployeeSearch").empty().append(e.toString());
}}});},_trunDownSingle:function(b,c){var d=new Array();d.push($("#financeBillForm").find("input[name=entityNo]").val());var a=this;a.trunDownOrderLayer(d,c);
a._commentSearch();},trunDownOrderLayer:function(d,c,b){var a=this;a.layerIndex=layer.open({type:1,title:"订单驳回",maxmin:false,move:false,scrollbar:false,shadeClose:false,btn:["确定","取消"],area:["600px","450px"],content:$(".financeBillTurnDownPane"),success:function(e,g){var j=new StringBuffer();
for(var h=0;h<d.length;h++){if(h!=0){j.append("，");}j.append("<span style='line-height:30px;'>"+d[h]+"</span>");}$("#trunDownSaveReForm").find(".soNoDiv").empty().append(j.toString());
$("#trunDownSaveReForm").find("#soIds").val(d.toString());var f={rules:{trunDownSaveReFormComment:{required:true,maxlength:["512"],}}};FormUtils.bindFormValidation("trunDownSaveReForm",f);
},yes:function(f,e){if($("#trunDownSaveReForm").valid()){FormUtils.submit(FinanceBillBase._CONS_.TURN_DOWN_URL,"soNos="+$("#trunDownSaveReForm").find("#soIds").val()+"&comment="+$("input[name=trunDownSaveReFormComment]").val(),function(i){if(i.success){DialogUtils.success(msgCode.INFO,"驳回成功");
$(".sowait_wrapper").find(".soEntitySearch").click();$(".wait_pay_wrapper").find(".soEntitySearch").click();$(".wait_stock_wrapper").find(".soEntitySearch").click();
layer.close(a.layerIndex);if(c){var h=$("#soEntityForm").find("input[name=soNo]").val();var j=$("#soEntityForm").find(".csName").val();var g=$("#financeBillForm").find("#id").val();
JTTabUtils.addOrRefreshTab(ctx+"/ec/finance/financeBill/list.htm","订单收付");JTTabUtils.closeTab(ctx+"/ec/salesorder/soEntity/waitPay.htm?soNo="+h+"&financeId="+g+"&financeType="+financeType);
}else{a.clear(true);}}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},cancel:function(){FormUtils.clear("trunDownSaveReForm");
}});},_commentSearch:function(){var a=this;$("#trunDownSaveReFormComment").bsSuggest("destroy");$("#trunDownSaveReFormComment").bsSuggest({url:ctx+"/gl/cate/cate/getOptions.htm?typeKey=system&pKey=NotApprovedType",effectiveFields:["name"],searchFields:["name"],effectiveFieldsAlias:{name:"驳回备注"},showBtn:false,inputWarnColor:"",showHeader:false,idField:"id",keyField:"name",getDataMethod:"url",processData:function(d){var c,b,e={value:[]};
if(!d||d.records===0){return false;}b=d.length;for(c=0;c<b;c++){e.value.push({id:d[c].id,name:d[c].name});}return e;}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(this.grid,a);
},_initJqgrid:function(e){var a=this;if(!e){e={};}var b=false;if(this.listDataUrl.indexOf("processing")!=-1||this.listDataUrl.indexOf("cancel")!=-1){b=true;
}var d=true;if(this.type=="receipt"){d=false;}var c=true;if(this.type=="pay"){c=false;}$(a.grid).JTJqgrid({url:a.listDataUrl,pager:a.pager,postData:e,footerrow:true,colNames:["订单编号","客户","单据类型","关联类型","关联类型(隐藏)","关联单据编码(隐藏)","货款方式","结算方式","财务应收","订金","待收","订单总额","快递公司","下单人","下单部门","付款账户(隐藏)","收款账户(隐藏)","付款账户","收款账户","经办人 ID","经办人","经办人所在部门 ID","状态(隐藏)","摘要","完成时间","单据附件数量","更新时间"],colModel:[{name:"entityNo",index:"entity_no_",width:90,formatter:function(f,g,h){if(h.footData){return h.entityNo;
}else{if(h.entityNo!=null&&h.entityNo!=""){if(h.entityType=="salesorder"){return"<a idVal='"+h.id+"' entityNoVal='"+h.entityNo+"'  href='#' class='soTab' value='"+h.entityNo+"' >"+h.entityNo+"</a>";
}else{if(h.entityType=="returnentity"){return"<a idVal='"+h.id+"' href='#' class='soTab' value='"+h.entityNo+"' >"+h.entityNo+"</a>";}else{if(h.entityType=="exchange"){return"<a idVal='"+h.id+"' href='#' class='soTab' value='"+h.entityNo+"' >"+h.entityNo+"</a>";
}}}}}return h.entityNo;}},{name:"csName",width:80,index:"entity.cs_code_",formatter:function(f,g,h){if(h.csCode){return"<a href='#' style='font-weight:bold;' class='csTab' value='"+h.csId+"' >"+h.csName+":"+h.csCode+"</a>";
}return h.csName+":"+h.csCode;}},{name:"type",index:"type_",width:80,hidedlg:true,hidden:true,formatter:function(f,h,i){var g="";if(i.type=="receipt"){g="<span>收款单</span>";
}else{if(i.type=="pay"){g="<span>付款单</span>";}else{if(i.type=="refund"){g="<span>退款单</span>";}}}return g;}},{name:"entityTypeShow",index:"entity_type_",width:80,hidedlg:true,hidden:true,formatter:function(f,h,i){var g=i.entityType;
if(i.entityType=="none"){g="<span>人工录入</span>";}else{if(i.entityType=="salesorder"){g="<span>订单</span>";}else{if(i.entityType=="returnentity"){g="<span>退货单</span>";
}else{if(i.entityType=="exchange"){g="<span>换货单</span>";}else{if(i.entityType=="contract"){g="<span>合同</span>";}}}}}return g;}},{name:"entityType",hidedlg:true,hidden:true},{name:"entityNoHide",index:"entity_no_",hidedlg:true,hidden:true,formatter:function(f,g,h){return h.entityNo;
}},{name:"cashType",index:"cashType",width:80,formatter:function(f,h,i){var g=i.cashType;if(i.cashType=="cod"){g="货到付款";}else{if(i.cashType=="pay"){g="款到发货";
}else{if(i.cashType=="pay_sub"){g="支付订金";}else{if(i.cashType=="green"){g="绿色通道";}else{if(i.cashType=="free"){g="免费已付";}}}}}return g;}},{name:"payType",index:"pay_type_",width:80,formatter:function(f,h,i){var g=i.payType;
if(g=="alipay"){g="支付宝";}else{if(g=="weixin"){g="微信支付";}else{if(g=="weixinhongbao"){g="微信红包";}else{if(g=="bank"){g="银行转账";}else{if(g=="cash"){g="现金支付";
}else{if(g=="QRCode"){g="收款码支付";}}}}}}return g;}},{name:"total",index:"total_",width:100,formatter:function(f,g,h){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat(h.total/10).toFixed(2);
}else{return parseFloat(h.total).toFixed(2);}}},{name:"subAmount",index:"entity.sub_amount_",width:100,formatter:function(f,g,h){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat(h.subAmount/10).toFixed(2);
}else{return parseFloat(h.subAmount).toFixed(2);}},},{name:"proxyAmount",width:100,hidden:b,formatter:function(f,g,h){if(window.localStorage.getItem("ts_money_reduce")=="true"){return parseFloat((h.totalAmount-h.subAmount)/10).toFixed(2);
}else{return parseFloat(h.totalAmount-h.subAmount).toFixed(2);}},},{name:"totalAmount",index:"totalAmount",width:100,formatter:function(f,g,h){if(window.localStorage.getItem("ts_money_reduce")=="true"){return h.totalAmount/10;
}else{return h.totalAmount;}},},{name:"shipName",index:"entity.sc_code_",width:70},{name:"placerId",index:"entity.placer_id_",width:100},{name:"groupName",index:"entity.group_id_",width:100},{name:"payAccount",index:"pay_account_",hidedlg:true,hidden:true},{name:"receiptAccount",index:"receipt_account_",hidedlg:true,hidden:true},{name:"payAccountName",index:"pay_account_",width:140,hidden:c,formatter:function(f,g,h){if(h.payAccount){return h.payAccountName+"("+h.payAccount+")";
}return h.payAccount;},},{name:"receiptAccountName",index:"receipt_account_",width:140,hidden:d,formatter:function(f,g,h){if(h.receiptAccount){return h.receiptAccountName+"("+h.receiptAccount+")";
}return h.receiptAccount;},},{name:"personId",index:"person_id_",hidedlg:true,hidden:true},{name:"personName",width:90,sortable:false,hidden:b},{name:"orgId",index:"org_id_",hidedlg:true,hidden:true},{name:"status",hidedlg:true,hidden:true},{name:"summary",index:"summary_",width:120,hidedlg:true,hidden:true},{name:"completeTime",index:"complete_time_",width:110,hidden:b},{name:"attachCount",index:"attach_count_",width:120,hidedlg:true,hidden:true},{name:"updateTime",index:"update_time_",width:120,hidedlg:true,hidden:true,formatter:function(f){if(f){return f.substring(5,16);
}else{return"";}}}],footerrow:true,userDataOnFooter:true,gridComplete:function(){FinanceBillBase._CONS_.DISABLE_ALL_BTNS();var f=$(a.widthElement).next(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
f.find('td[aria-describedby*="rn"],td[aria-describedby*="cb"],td[aria-describedby*="cashType"],td[aria-describedby*="entityTypeShow"],td[aria-describedby*="csName"],td[aria-describedby*="placerId"],td[aria-describedby*="receiptAccountName"],td[aria-describedby*="totalAmount"],td[aria-describedby*="proxyAmount"],td[aria-describedby*="subAmount"],td[aria-describedby*="payAccountName"],td[aria-describedby*="payType"],td[aria-describedby*="personName"],td[aria-describedby*="groupName"],td[aria-describedby*="total"],td[aria-describedby*="completeTime"],td[aria-describedby*="auditorName"]').hide();
},loadComplete:function(){if(a.gridRecordsSpan!=null){$(a.gridRecordsSpan).empty().append($(a.grid).jqGrid("getGridParam","records"));}},onSelectAll:function(g,f){if(g&&g.length>0){if(typeof(a.onSelectRow)=="function"){a.onSelectRow(g,f,a.otherOperFlag);
}}},onSelectRow:function(g,f){if(a.onSelectRow&&typeof(a.onSelectRow)==="function"){a.onSelectRow(g,f,a.otherOperFlag);}},ondblClickRow:function(f){if(f){a.detail(f);
}},});},resSearchGrid:function(){$(this.widthElement).find(".financeBillSearch").click();},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isEdit=false;$(".form_wrapper .saveBtn").show();FormUtils.clear(FinanceBillBase._CONS_.EDIT_FORM_ID);FormUtils.enableForm(FinanceBillBase._CONS_.EDIT_FORM_ID);
if(c){$(".financeBillSearch").trigger("click");}}b();},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();if($("select[name=entityType]").val()=="none"){$("input[name=entityNo]").val("");$("input[name=entityNo]").attr("readonly",true);
}else{$("input[name=entityNo]").attr("readonly",false);}$("#typeSelect").val(this.type);$("input[name=type]").val(this.type);},_showAdd:function(){$(".addDiv").hide();
$(".statusDiv").hide();$(".processInfoDiv").hide();$(".financeItemAdd").show();$(".financeBillAttachAdd").show();$(".saveBtn").show();$(".completeBtn").hide();
$(".entityDetailIframe").parent().hide();$(".entityNoDiv").hide();$(".entityTypeDiv").hide();$(".financeBillTrunDown").hide();$(".saveSoPayBtn").hide();
this._initInput();if("receipt"==this.type){FinanceAccountSelect.initSelectActived("receiptAccount",null,function(){if(!$("#receiptAccount").val()){$("select[name=payType]").trigger("change");
}});}else{FinanceAccountSelect.initSelectActived("payAccount",null,function(){if(!$("#payAccount").val()){$("select[name=payType]").trigger("change");}});
}},_showEdit:function(){$(".addDiv").show();$(".processInfoDiv").hide();$(".financeItemAdd").show();$(".financeBillAttachAdd").show();$(".saveBtn").show();
$(".completeBtn").hide();$(".entityNoDiv").hide();$(".entityTypeDiv").hide();$("select[name=status]").attr("disabled",true);this._initInput();if("receipt"==this.type){FinanceAccountSelect.initSelectActived("receiptAccount",null,function(){if(!$("#receiptAccount").val()){$("select[name=payType]").trigger("change");
}});}else{FinanceAccountSelect.initSelectActived("payAccount",null,function(){if(!$("#payAccount").val()){$("select[name=payType]").trigger("change");}});
}},_showComplete:function(){$(".addDiv").show();$(".statusDiv").hide();$(".processInfoDiv").hide();$(".financeItemAdd").hide();$(".financeBillAttachAdd").hide();
$(".completeBtn").show();$(".saveBtn").hide();$(".entityNoDiv").show();$(".entityTypeDiv").show();this._initInput();},_showDetail:function(){$(".addDiv").show();
$(".processInfoDiv").show();$(".statusDiv").show();$(".financeItemAdd").hide();$(".financeBillAttachAdd").hide();$(".completeBtn").hide();$(".saveBtn").hide();
$(".entityNoDiv").show();$(".entityTypeDiv").show();this._initInput();},add:function(){this._showFormWrapper();this._showAdd();$("select[name=entityType]").val("none");
$("select[name=status]").attr("disabled",true);$("input[name=status]").val("processing");$("select[name=status]").val("processing");},_initInput:function(){if("receipt"==this.type){$(".receiptAccountDiv").empty().append("<select name='receiptAccount'  id='receiptAccount' class='form-control' validateType='default' ></select>");
$(".payAccountContent").hide();$(".receiptAccountContent").show();}else{$(".payAccountContent").show();$(".receiptAccountContent").hide();$(".payAccountDiv").empty().append("<select name='payAccount' id='payAccount' class='form-control' validateType='default' ></select>");
}},edit:function(a){if(!a){a=$(this.grid).jqGrid("getGridParam","selarrrow");if(a==null||a.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);
return;}else{if(a&&a.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);return;}}}this._showFormWrapper();this._showEdit();this._loadData(a);
},finish:function(e,b){var a=this;var c=a.type;if(!e){e=$(this.grid).jqGrid("getGridParam","selarrrow");var d=$(this.grid).jqGrid("getRowData",e);b=d["entityNoHide"];
if(e==null||e.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(e&&e.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}JTTabUtils.addOrRefreshTab(FinanceBillBase._CONS_.SO_WAIT_PAY_URL+"?soNo="+b+"&financeId="+e+"&financeType="+c,"订单["+b+"收付");},detail:function(a){if(!a){a=$(this.grid).jqGrid("getGridParam","selarrrow");
if(a==null||a.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(a&&a.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}this._showFormWrapper();this._showDetail();this._loadData(a,false);$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(FinanceBillBase._CONS_.EDIT_FORM_ID);
},getFinanceRowData:function(b){var a=$(this.grid).jqGrid("getRowData",b);return a;},addOrRefresh:function(b,c){if(c=="so"){var a=FinanceBill._CONS_.FIND_BY_SONO_URL;
FormUtils.loadData(a+"?soNo="+b,function(d){JTTabUtils.addOrRefreshTab(FinanceBill._CONS_.SO_DETAIL_PAGE_URL+"?soNo="+b,d.name+"的订单明细");});}else{if(c=="return"){var a=FinanceBill._CONS_.FIND_BY_RNO_URL;
FormUtils.loadData(a+"?rNo="+b,function(d){JTTabUtils.addOrRefreshTab(FinanceBill._CONS_.RETURN_DETAIL_PAGE_URL+"?rno="+b,d.name+"的退货单明细");});}else{if(c=="change"){var a=FinanceBill._CONS_.FIND_BY_ENO_URL;
FormUtils.loadData(a+"?eNo="+b,function(d){JTTabUtils.addOrRefreshTab(FinanceBill._CONS_.CHANGE_DETAIL_PAGE_URL+"?eno="+b,d.name+"的换货单明细");});}}}},_loadData:function(d,a){var b=this;
var c=true;if(a==false){c=false;}FormUtils.loadData(FinanceBillBase._CONS_.EDIT_URL+"?id="+d,function(e){$("input[name=id]").val(e.id);$("#typeSelect").val(e.type);
$("input[name=type]").val(e.type);$("select[name=entityType]").val(e.entityType);$("input[name=entityType]").val(e.entityType);if(e.entityType=="salesorder"||e.entityType=="returnentity"||e.entityType=="exchange"){$(".otherInfo").hide();
}else{$(".otherInfo").show();}$("input[name=entityNo]").val(e.entityNo);$("input[name=title]").val(e.title);$("select[name=payType]").val(e.payType);if(e.type!="receipt"&&e.type!=null){FinanceAccountSelect.initSelectActived("payAccount",e.payAccount,function(){if(!$("#payAccount").val()&&!e.payAccount){$("select[name=payType]").trigger("change");
}});}else{FinanceAccountSelect.initSelectActived("receiptAccount",e.receiptAccount,function(){if(!$("#receiptAccount").val()&&!e.receiptAccount){$("select[name=payType]").trigger("change");
}});}$("select[name=payAccount]").val(e.payAccount);$("select[name=receiptAccount]").val(e.receiptAccount);$("input[name=personId]").val(e.personId);$("input[name=orgId]").val(e.orgId);
$("input[name=personName]").val(e.personName);$("input[name=groupName]").val(e.groupName);$("input[name=status]").val(e.status);$("select[name=status]").val(e.status);
$("textarea[name=summary]").val(e.summary);$("input[name=total]").val(e.total);$("input[name=completeTime]").val(e.completeTime);$("input[name=auditTime]").val(e.auditTime);
$("input[name=auditorId]").val(e.auditorId);$("input[name=auditorName]").val(e.auditorName);$("textarea[name=auditComment]").val(e.auditComment);$("input[name=attachCount]").val(e.attachCount);
$("input[name=createTime]").val(e.createTime);$("input[name=updateTime]").val(e.updateTime);b._loadEntityDetail(e.entityNo);});},_save:function(){var b=this;
var d=$("#id").val();var a=null;if(d!=null&&d!=""){a=FinanceBillBase._CONS_.SAVE_EDIT_URL;}else{a=FinanceBillBase._CONS_.SAVE_ADD_URL;}if($("#financeBillForm").valid()){var c=$("#"+FinanceBillBase._CONS_.EDIT_FORM_ID).serialize();
ButtonUtils.disableBtn("saveBtn");FormUtils.submit(a,c,function(e){ButtonUtils.enableBtn("saveBtn");if(e.success){if(e.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(e.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);
}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_delete:function(b){var a=this;if(!b){b=$(this.grid).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}DialogUtils.confirm(function(){FormUtils.del(FinanceBillBase._CONS_.DELETE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_remove:function(b){var a=this;if(!b){b=$(this.grid).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);return;}}DialogUtils.confirm(function(){FormUtils.del(FinanceBillBase._CONS_.REMOVE_URL,b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);
a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_exportFinanceBillExcel:function(){var b=this;var a=[];a=$(b.grid).jqGrid("getGridParam","selarrrow");
if(a==null||a.length==0){DialogUtils.error("错误","请选择要导出的记录");return null;}var c=b.metaParams;FormUtils.submit(b.exportUrl+"?selectedId="+a,c,function(d){if(d.success){DialogUtils.success(msgCode.INFO,d.msg);
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_batchFinish:function(){var c=this;
var b=[];b=$(c.grid).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error("错误","请选择要完成的记录");return null;}var e=[];var a=[];var d=[];
for(var f=0;f<b.length;f++){var g=$(c.grid).jqGrid("getRowData",b[f]);e.push(b[f]);if(g["payAccount"]){a.push(g["payAccount"]);}else{a.push("-");}if(g["receiptAccount"]){d.push(g["receiptAccount"]);
}else{d.push("-");}}var h="billIds="+e.toString()+"&payAccounts="+a.toString()+"&receiptAccounts="+d.toString();DialogUtils.confirmWithOptions({title:"确定完成这些财务单吗",text:"完成财务单",confirmButtonText:"完成",yesFunc:function(){ButtonUtils.disableBtn("completeBtn");
FormUtils.submit(FinanceBillBase._CONS_.BATCHCOMPLETE_URL,h,function(i){ButtonUtils.enableBtn("completeBtn");if(i.success){if(i.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(i.msgCode==actionCode.UPDATE){if(i.msg.indexOf("账户")>-1){DialogUtils.error(msgCode.INFO,i.msg);}else{DialogUtils.success(msgCode.INFO,i.msg);}}}c.isEdit=false;
c.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,i.msg);}},function(){ButtonUtils.enableBtn("completeBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});},_saveFinish:function(c){var b=this;if($("select[name=payType]").val()!="cash"){if(b.type=="pay"){$("#payAccount").rules("add",{required:true,maxlength:["250"],messages:{}});
}else{$("#receiptAccount").rules("add",{required:true,maxlength:["250"],messages:{}});}}var a=$("#financeBillForm").find("#id").val();if($("#"+FinanceBillBase._CONS_.EDIT_FORM_ID).valid()){var d="id="+$("#id").val()+"&payAccount="+$("#payAccount").val()+"&receiptAccount="+$("#receiptAccount").val()+"&billAttachJson="+JSON.stringify(b.uploadImageUtil._buildImageJson());
DialogUtils.confirmWithOptions({title:"确定完成本财务单吗",text:"完成财务单",confirmButtonText:"完成",yesFunc:function(){ButtonUtils.disableBtn("completeBtn");FormUtils.submit(FinanceBillBase._CONS_.COMPLETE_URL,d,function(f){ButtonUtils.enableBtn("completeBtn");
if(f.success){if(f.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(f.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}if(b.type=="pay"){$("#payAccount").rules("remove");}else{$("#receiptAccount").rules("remove");}b.isEdit=false;b.clear(true);if(c){var e=$("#soEntityForm").find("input[name=soNo]").val();
var g=$("#soEntityForm").find(".csName").val();$(".financeBillSearch").trigger("click");JTTabUtils.closeTab(ctx+"/ec/salesorder/soEntity/waitPay.htm?soNo="+e+"&financeId="+a+"&financeType="+financeType);
}}else{DialogUtils.error(msgCode.FAIL_MSG,f.msg);}},function(){ButtonUtils.enableBtn("completeBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}});}},_loadEntityDetail:function(a){if(a){var b=FinanceBillBase._CONS_.SO_DETAIL_PAGE_URL;$(".entityDetailIframe").attr("src",b+"?soNo="+a+"&isIframe=true").parent().show();
$(".entityDetailIframe").find(".soEntityTurnDownPane").remove();}else{$(".entityDetailIframe").parent().hide();}},_csAccountSearch:function(b,c){var a=ctx+"/ec/salesorder/soEntity/findCsBySoNo.htm";
FormUtils.loadData(a+"?soNo="+b,function(e){$("#"+c).bsSuggest("destroy");if(e.id==null||e.id==""){return;}var d=this;$("#"+c).bsSuggest({url:ctx+"/crm/cs/csEntity/searchAccount.htm?Q__S__EQ__cs_id_="+e.id+"&Q__S__LK__account_=",effectiveFields:["account","accountType"],searchFields:["account"],effectiveFieldsAlias:{account:"账户",accountType:"类型"},showBtn:false,inputWarnColor:"",showHeader:false,idField:"id",keyField:"account",getDataMethod:"url",processData:function(h){var g,f,k={value:[]};
if(!h||h.records===0){return false;}f=h.records;for(g=0;g<f;g++){if(h.rows[g].accountType=="alipay"){var j="支付宝";}else{if(h.rows[g].accountType=="bank"){var j="银行转账";
}else{if(h.rows[g].accountType=="weixin"){var j="微信支付";}}}k.value.push({id:h.rows[g].id,account:h.rows[g].account,accountType:j});}return k;}});});},};
