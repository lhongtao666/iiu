$(function(){var a=new RpSoReject();a.init();});function RpSoReject(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}RpSoReject._CONS_={EXPORT_URL:ctx+"/ec/rp/rpSoReject/exportReport.htm",EDIT_URL:ctx+"/ec/rp/rpSoReject/edit.htm",DETAIL_URL:ctx+"/ec/rp/rpSoReject/detail.htm",DELETE_URL:ctx+"/ec/rp/rpSoReject/delete.htm",SAVE_ADD_URL:ctx+"/ec/rp/rpSoReject/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/rp/rpSoReject/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/rp/rpSoReject/listData.htm",EDIT_FORM_ID:"rpSoRejectForm",GRID:"#rpSoRejectGrid",PAGER:"#rpSoRejectPager"};
RpSoReject.prototype={init:function(b){if(!this.hadInit){this.hadInit=true;var a=this;this._bindEventHander();this._buildEmployeeSelect();$("#timeTypeSearch").val("month");
ReportDateUtil.initDate(".report-content");$("#timeTypeSearch").change();this._initJqgrid(a._toBuildParams());ShipCompanyUtils.getOptions({container:"shipCompany",caption:"全部"});
a._getData(a._toBuildParams(),"pie");}},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString()).select2();
}}});},_getData:function(c,b){var a=this;FormUtils.submit(RpSoReject._CONS_.LIST_DATA_URL,a._toBuildParams(),function(d){if(d){if(d.rows.length>0){$(".chartByCountBtn").attr("disabled",true);
$(".chartByMoneyBtn").attr("disabled",false);$("#chartByCount").show();$("#chartByMoney").show();a.createReportChartByMoney(d);a.createReportChartByCount(d);
$("#chartByMoney").hide();}else{$(".chartByCountBtn").attr("disabled",true);$(".chartByMoneyBtn").attr("disabled",true);$("#chartByCount").hide();$("#chartByMoney").hide();
}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},createReportChartByCount:function(c){var a=new Report();var d=c.rows[0].rejectTotalCount;
for(var b=0;b<c.rows.length;b++){c.rows[b].rejectReason1=c.rows[b].rejectReason+"("+((c.rows[b].rejectCount)/d*100).toFixed(2)+"%)";}a.data=c.rows;a.setLegend(true,null,"rejectReason1");
a.initSeries([{type:"pie",colName:"rejectCount",legendName:"数量"}],"rejectReason1");a._initChart("soRejectReportChartByCount","拒收原因图(按单数)"+" [拒收总数:"+d+"件]");
},createReportChartByMoney:function(c){var a=new Report();var d=c.rows[0].rejectTotalMoney;for(var b=0;b<c.rows.length;b++){c.rows[b].rejectReason2=c.rows[b].rejectReason+"("+((c.rows[b].rejectMoney)/d*100).toFixed(2)+"%)";
}a.data=c.rows;a.setLegend(true,null,"rejectReason2");a.initSeries([{type:"pie",colName:"rejectMoney",legendName:"金额"}],"rejectReason2");a._initChart("soRejectReportChartByMoney","拒收原因图(按金额)"+" [拒收总额:"+d+"元]");
},_buildEmployeeSelect:function(a){$.ajax({type:"GET",url:ctx+"/crm/ou/employee/listEmployees.htm"+"?groupId="+(a?a:""),contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(c){if(c&&c.length>0){var d=new StringBuffer();
d.append("<option value=''>请选择</option>");for(var b=0;b<c.length;b++){d.append("<option value='"+c[b].id+"'>"+c[b].aid+":"+c[b].name+"</option>");}$("#belongEmployeeSearch").empty().append(d.toString());
}}});},_toBuildParams:function(){var a=ReportDateUtil.getDateTimeRangeStr().split(",");var b={beginTime:a[0],endTime:a[1],rejectType:$("select[name=rejectType] option:selected").val(),rejectReason:$("select[name=rejectReason] option:selected").val(),shipCompany:$("select[name=shipCompany] option:selected").text(),groupKey:$("input[name='belongOgn']").val(),employeeId:$("select[name='belongEmployee']").val()};
return b;},_bindEventHander:function(){var a=this;$(document).on("change","select[id=rejectType]",function(){if($(this).val()=="物流原因"){CateUtils.getOptions({typeKey:"system",pKey:"shipRejectType",container:"rejectReason"});
}else{if($(this).val()=="客户原因"){CateUtils.getOptions({typeKey:"system",pKey:"csRejectType",container:"rejectReason"});}else{if($(this).val()=="客服原因"){CateUtils.getOptions({typeKey:"system",pKey:"empRejectType",container:"rejectReason"});
}else{if($(this).val()=="寄方要求退回"){CateUtils.getOptions({typeKey:"system",pKey:"turnRejectType",container:"rejectType"});}}}}});$("#groupName").on("click",function(){var b={isMultiple:0,selectedGroupId:$("input[name='belongOgn']").val(),container:"groupName",fn:function(c,d){$("input[name=belongOgn]").val(d);
a._buildEmployeeSelect(c);}};GroupUtils.selectGroupTreeBox(b);});$("#searchBtn").on("click",function(){$("#chartByCount").show();$("#chartByMoney").show();
a.reloadJqgrid(a._toBuildParams());a._getData(a._toBuildParams());});$(".exportExcel").on("click",function(){ButtonUtils.disableBtn("exportExcel");FormUtils.submit(RpSoReject._CONS_.EXPORT_URL,a._toBuildParams(),function(b){ButtonUtils.enableBtn("exportExcel");
if(b.success){DialogUtils.success(msgCode.INFO,b.msg+"成功");}else{DialogUtils.error(msgCode.FAIL_MSG,b.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});$(document).on("click",".toThisTypeSoList",function(){var e=ReportDateUtil.getDateTimeRangeStr().split(",");var b=e[0];var d=e[1];var c=encodeURI(encodeURI($(this).attr("rejectType")));
var f=encodeURI(encodeURI($(this).attr("rejectReason")));JTTabUtils.addOrRefreshTab(ctx+"/ec/rp/rpSoReject/toSoRejectDetail.htm?beginTime="+b+"&endTime="+d+"&rejectType="+c+"&rejectReason="+f,"拒收订单列表");
});$(document).on("click",".chartByCountBtn",function(){$(this).attr("disabled",true);$("#chartByCount").show();$("#chartByMoney").hide();$(".chartByMoneyBtn").attr("disabled",false);
});$(document).on("click",".chartByMoneyBtn",function(){$(this).attr("disabled",true);$("#chartByMoney").show();$("#chartByCount").hide();$(".chartByCountBtn").attr("disabled",false);
});},reloadJqgrid:function(b){var a=this;JTJqgridUtils.reloadJqgrid(RpSoReject._CONS_.GRID,a._toBuildParams());},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};
}$(RpSoReject._CONS_.GRID).JTJqgrid({url:RpSoReject._CONS_.LIST_DATA_URL,pager:RpSoReject._CONS_.PAGER,postData:b,footerrow:true,rowNum:-1,colNames:["拒收类别","拒收原因","发货数量","发货金额","发货单数(件)/金额(RMB)","拒收数量","拒收金额","拒收单数(件)/金额(RMB)","拒收率(%)"],colModel:[{name:"rejectType",width:120,sortable:false},{name:"rejectReason",width:120,sortable:false},{name:"shipCount",hidedlg:true,hidden:true,sortable:false},{name:"shipTotalMoney",hidedlg:true,hidden:true,sortable:false},{name:"shipCountAndMoney",width:120,sortable:false,formatter:function(c,d,e){return"<span style='color:black;'>"+e.shipCount+"</span>"+" / <span style='color:black;'>"+e.shipTotalMoney+"</span>";
}},{name:"rejectCount",hidedlg:true,hidden:true,sortable:false},{name:"rejectMoney",hidedlg:true,hidden:true,sortable:false},{name:"rejectCountAndMoney",width:120,sortable:false,formatter:function(c,d,e){if(e.rejectReason.indexOf("总计")>-1){return"<span style='color:red;'>"+e.rejectCount+"</span>"+"/<span style='color:blue;'>"+e.rejectMoney+"</span>";
}else{return"<a href='#' class='toThisTypeSoList' rejectType='"+e.rejectType+"' rejectReason='"+e.rejectReason+"'><span style='color:red;'>"+e.rejectCount+"</span>"+"/<span style='color:blue;'>"+e.rejectMoney+"</span></a>";
}}},{name:"rejectRate",width:120,sortable:false,formatter:function(c,d,e){return e.rejectRate+"%";}}],gridComplete:function(){var f=$(RpSoReject._CONS_.GRID).jqGrid("getCol","shipCount",true,"max");
var g=$(RpSoReject._CONS_.GRID).jqGrid("getCol","shipTotalMoney",true,"max");if(f==undefined){f=0;}if(g==undefined){g=0;}var e=$(RpSoReject._CONS_.GRID).jqGrid("getCol","rejectCount",true,"sum");
var c=$(RpSoReject._CONS_.GRID).jqGrid("getCol","rejectMoney",true,"sum");var d=0;if(f){d=(e/f*100).toFixed(2);}$(RpSoReject._CONS_.GRID).footerData("set",{"rejectReason":"总计:","shipCount":f,"shipTotalMoney":g,"shipCountAndMoney":"","rejectCount":e,"rejectMoney":c,"rejectCountAndMoney":"","rejectRate":d});
var h=$(RpSoReject._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");h.find("td").css({"font-weight":400});},});}};