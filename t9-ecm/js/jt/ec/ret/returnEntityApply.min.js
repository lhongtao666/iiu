$(function(){var a=new ReturnEntityApply();a.init();});function ReturnEntityApply(){this.soInfo=new SoInfo();this.returnEntityBase=new ReturnEntityBase();
this.returnLog=new ReturnLog();}ReturnEntityApply._CONS_={SAVE_ADD_URL:ctx+"/ec/ret/returnEntity/saveAdd.htm",RETURN_ENTITY_RECORDS:ctx+"/ec/ret/returnEntity/records.htm",REFRESH_URL:ctx+"/ec/ret/returnEntity/soShow.htm",APPLY_FORM_ID:"returnApplyForm",SAVE_BUTTON:"save",CANCEL_BUTTON:"cancel",GRID:"#returnEntityRecordsGrid",};
ReturnEntityApply.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initInputAndOption();
this._initSoInfo();}},_initJqgrid:function(c){var a=this;var b=[];if(c){if(typeof c.data!=undefined&&c.data!=null&&c.data.length){b=c.data;}}$.jgrid.defaults.styleUI="Bootstrap";
$(ReturnEntityApply._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"退货单列表",datastr:b,autowidth:true,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["退货单号","订单号","skuId","商品名称","数量","是否回寄","申请时间","状态","操作"],colModel:[{name:"rno",index:"rno_",width:100},{name:"soNo",index:"so_no_",width:100},{name:"skuId",index:"sku_id_",width:200,hidden:true},{name:"skuName",index:"sku_name_",width:140,formatter:function(d){if(d&&d.length>12){return d.substring(0,11)+"...";
}else{return d;}}},{name:"skuCount",index:"sku_count_",width:100},{name:"needReturn",index:"need_return_",width:100,formatter:function(d,f,g){var e=g.needReturn;
if(g.needReturn=="Y"){e="<span class='label label-primary'>需要</span>";}else{if(g.needReturn=="N"){e="<span class='label label-primary'>不需要</span>";}}return e;
}},{name:"createTime",index:"create_time_",width:120},{name:"status",index:"status_",width:120,formatter:function(d,f,g){var e=g.status;if(g.status=="awaiting"){e="<span class='label label-primary'>待审核</span>";
}else{if(g.status=="reject"){e="<span class='label label-danger'>审核不通过</span>";}else{if(g.status=="comfirm"){e="<span class='label label-info'>已审核(等待退货)</span>";
}else{if(g.status=="comfirm_direct"){e="<span class='label label-primary'>已审核(无需退货)</span>";}else{if(g.status=="receive"){e="<span class='label label-info'>已收货</span>";
}else{if(g.status=="not_receive"){e="<span class='label label-danger'>未收到</span>";}else{if(g.status=="refund"){e="<span class='label label-warning'>退款中</span>";
}else{if(g.status=="complete"){e="<span class='label label-primary'>已完成</span>";}}}}}}}}return e;}},{name:"button",sortable:false,align:"center",width:120,formatter:function(d,f,g){var e="<button  type='button' class='btn btn-sm btn-outline btn-primary viewApplyDetail'   style='margin: 0px 3px 0px 0px;' value='"+g.id+"' >查看详情</button>";
return e;}}],});},_bindEventHander:function(){var a=this;$(SoItemList._CONS_.GR_lIST_ID).on("click",".toApply",function(){var b=$(this).val();a._initApplyForm();
a._apply(b);});$(SoItemList._CONS_.GR_lIST_ID).on("click",".applyRecords",function(){var d=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getRowData",$(this).val());
var b=d["skuId"];var c=$("#"+SoInfo._CONS_.SOINFO_FORM_ID).find("[name=soNo]").val();a._viewRecords(c,b);});$(ReturnEntityApply._CONS_.GRID).on("click",".viewApplyDetail",function(){var b=$(this).val();
a._detail(b);a.returnLog.init(b);});$(".recordsDiv").on("click",".recordsPreBtn",function(){a.clear(true,null);});$("#detailDiv").on("click",".prevBtn",function(){a._initApplyForm();
a._showRecordsWrapper();});$("#applyDiv").on("click",".prevBtn",function(){a.clear(false,ReturnEntityApply._CONS_.CANCEL_BUTTON);});$("#applyDiv").on("click",".saveBtn",function(){a._submitApply();
});$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).on("change","input",function(){a.isFormDataChange=true;});$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).on("change","select",function(){a.isFormDataChange=true;
});$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).on("change","textarea",function(){a.isFormDataChange=true;});$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=needReturn]").on("click",function(){if($(this).val()=="N"){a.returnEntityBase.hideReturnInfo();
}else{a.returnEntityBase.showReturnInfo();}});$("#returnApplyForm").on("change","[name=skuCount]",function(){var b=$("#"+SoInfo._CONS_.SOINFO_FORM_ID).find("[name=canReturnCount]").val();
if(parseInt($(this).val())>parseInt(b)){$(this).val(b);}if(parseInt($(this).val())<1){$(this).val(1);}});$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).on("click",".selectImageBtn",function(){ImageUtils.selectImage(1,function(c){if($("#imgContainer").find("ul").length==0){var d=new StringBuffer();
d.append("<ul class='dragsort'>");for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}d.append("</ul>");
$("#imgContainer").append(d.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
}else{var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}$("#imgContainer ul").append(d.toString());
}});a.isFormDataChange=true;});$(document).on("click",".shipQryBtn",function(){var b=$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[name=id]").val();
FormUtils.submit(ReturnEntityBase._CONS_.SHIP_INFO_QRY_URL,"id="+b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"查询成功");var d=$("#shipInfoForm");
d.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(c.returnEntityPo.apiStatus));d.find("[name=apiRevokeTime]").val(c.returnEntityPo.apiRevokeTime);
d.find(".shippingDataDiv").empty().append(c.returnEntityPo.apiReturnData);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},_apply:function(b){var a=this;$(".returnEntityDetailDiv").find("[id=detailDiv]").hide();$(".returnEntityDetailDiv").find("[id=applyDiv]").show();
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=skuCount]").attr("readonly",false);a._showFormWrapper();a.soInfo.loadSoItemData(b);},_detail:function(b){var a=this;
$(".returnEntityDetailDiv").find("[id=detailDiv]").show();$(".returnEntityDetailDiv").find("[id=applyDiv]").hide();a._showFormWrapper();a.returnEntityBase.loadData(b,a._initDetailForm);
},_viewRecords:function(d,a){var b=this;var c=ReturnEntityApply._CONS_.RETURN_ENTITY_RECORDS+"?soNo="+d+"&skuId="+a;b._showRecordsWrapper();FormUtils.loadData(c,function(e){b._initJqgrid({data:e});
});},_submitApply:function(){var a=this;var b=$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID);var c=$("#"+SoInfo._CONS_.SOINFO_FORM_ID);if(b.valid()){reqUrl=ReturnEntityApply._CONS_.SAVE_ADD_URL;
var d=new StringBuffer();d.append("csId="+c.find("[name=csId]").val());d.append("&soNo="+c.find("[name=soNo]").val());d.append("&skuName="+c.find("[name=skuName]").val());
d.append("&skuId="+c.find("[name=skuId]").val());d.append("&skuImage="+c.find("[name=skuImage]").val());d.append("&skuCount="+b.find("[name=skuCount]").val());
d.append("&needReturn="+b.find("[name=needReturn]").val());d.append("&returnAddr="+b.find("[name=returnAddr]").val());d.append("&trackingNo="+b.find("[name=trackingNo]").val());
d.append("&shipAmount="+b.find("[name=shipAmount]").val());d.append("&reasonName="+b.find("[name=reasonName]").val());d.append("&comment="+b.find("[name=comment]").val());
d.append("&imgUrls="+a._getImgUrl());d.append("&scId="+b.find("[name=scId]").val());ButtonUtils.disableBtn("saveBtn");FormUtils.submit(reqUrl,d.toString(),function(e){ButtonUtils.enableBtn("saveBtn");
if(e.success){if(e.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(e.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}a.isEdit=false;a.clear(true,ReturnEntityApply._CONS_.SAVE_BUTTON);}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("saveBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_getImgUrl:function(){var b=new Array();var a=$("#imgContainer").find("ul.dragsort");if(a.length>0){a.find("li").each(function(){var c=$(this).find("div.file-box div.file");
b.push(c.attr("urlVal"));});}return b.join(",");},clear:function(d,c){var a=this;function b(){if(d){JTTabUtils.refreshTab(ReturnEntityApply._CONS_.REFRESH_URL+"?soNo="+soNo);
}else{a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;a.soInfo.clearDataInfo();a._initApplyForm();}}if(c==ReturnEntityApply._CONS_.CANCEL_BUTTON&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".soInfoDiv").show();$(".returnEntityDetailDiv").hide();$(".recordsDiv").hide();},_showFormWrapper:function(){$(".soInfoDiv").hide();
$(".returnEntityDetailDiv").show();$(".recordsDiv").hide();},_showRecordsWrapper:function(){$(".soInfoDiv").hide();$(".returnEntityDetailDiv").hide();$(".recordsDiv").show();
},_initApplyForm:function(){var a=this;$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=skuCount]").val("1");$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=reasonName]").val("").attr("readonly",false);
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=needReturn]").val("Y").attr("disabled",false);$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=shipAmount]").val("0").attr("readonly",false);
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=trackingNo]").val("").attr("readonly",false);$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=returnAddr]").val("").attr("readonly",false);
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=comment]").val("").attr("readonly",false);$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=reasonName]").val("").attr("readonly",false);
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[id=commentDiv]").show();$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[id=imgDiv]").show();$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID+" .selectImageBtn").show();
$("#imgContainer").text("");$("#detailTabLi").addClass("active");$("#detailTab").addClass("active");$("#logTabLi").removeClass("active");$("#logTab").removeClass("active");
$("#logTabLi").hide();$("#logTab").hide();a.returnEntityBase.showReturnInfo();},_initDetailForm:function(b){var a=this;$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=skuCount]").attr("readonly","readonly");
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=reasonName]").attr("readonly","readonly");$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=needReturn]").attr("disabled",true);
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=shipAmount]").attr("readonly","readonly");$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=trackingNo]").attr("readonly","readonly");
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=returnAddr]").attr("readonly","readonly");$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[name=reasonName]").attr("readonly","readonly");
$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[id=commentDiv]").hide();$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID+" .selectImageBtn").hide();if($("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID+" .deleteImage").length>0){$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID+" .deleteImage").remove();
}else{$("#"+ReturnEntityApply._CONS_.APPLY_FORM_ID).find("[id=imgDiv]").hide();}$("#detailTabLi").addClass("active");$("#detailTab").addClass("active");
$("#logTabLi").removeClass("active");$("#logTab").removeClass("active");$("#logTabLi").show();},_bindFormValidation:function(){var a={rules:{skuCount:{required:true,number:true,min:1},shipAmount:{number:true,min:0},trackingNo:{maxlength:["128"]},reasonName:{required:true,maxlength:["1024"]},returnAddr:{maxlength:["512"]},comment:{maxlength:["1024"]}},messages:{}};
FormUtils.bindFormValidation(ReturnEntityApply._CONS_.APPLY_FORM_ID,a);},_initInputAndOption:function(){CateUtils.getOptions({typeKey:"system",pKey:"shipCode",container:"shipCompany"});
},_initSoInfo:function(){var a={type:SoInfo._CONS_.RETURN_TYPE};this.soInfo.init(a);}};