$(function(){var a=new ExchangeEntityApply();a.init();});function ExchangeEntityApply(){this.soInfo=new SoInfo();this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeLog=new ExchangeLog();}ExchangeEntityApply._CONS_={SAVE_ADD_URL:ctx+"/ec/ret/exchangeEntity/saveAdd.htm",RETURN_ENTITY_RECORDS:ctx+"/ec/ret/exchangeEntity/records.htm",REFRESH_URL:ctx+"/ec/ret/exchangeEntity/soShow.htm",FORM_ID:"exchangeEntityForm",SAVE_BUTTON:"save",CANCEL_BUTTON:"cancel",GRID:"#exchangeEntityRecordsGrid",};
ExchangeEntityApply.prototype={init:function(){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initInputAndOption();
this._initSoInfo();}},_initJqgrid:function(c){var a=this;var b=[];if(c){if(typeof c.data!=undefined&&c.data!=null&&c.data.length){b=c.data;}}$.jgrid.defaults.styleUI="Bootstrap";
$(ExchangeEntityApply._CONS_.GRID).jqGrid({datatype:"jsonstring",caption:"换货单列表",datastr:b,autowidth:true,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["换货单号","订单号","skuId","商品名称","数量","是否回寄","申请时间","状态","操作"],colModel:[{name:"eno",index:"eno_",width:100},{name:"soNo",index:"so_no_",width:100},{name:"skuId",index:"sku_id_",width:200,hidden:true},{name:"skuName",index:"sku_name_",width:140,formatter:function(d){if(d&&d.length>12){return d.substring(0,11)+"...";
}else{return d;}}},{name:"skuCount",index:"sku_count_",width:100},{name:"needReturn",index:"need_return_",width:100,formatter:function(d,f,g){var e=g.needReturn;
if(g.needReturn=="Y"){e="<span class='label label-primary'>需要</span>";}else{if(g.needReturn=="N"){e="<span class='label label-primary'>不需要</span>";}}return e;
}},{name:"createTime",index:"create_time_",width:100,formatter:function(d){return DateUtils.miniTime(d);}},{name:"status",index:"status_",width:120,formatter:function(d,f,g){var e=g.status;
if(g.status=="awaiting"){e="<span class='label label-primary'>待审核</span>";}else{if(g.status=="reject"){e="<span class='label label-danger'>审核不通过</span>";
}else{if(g.status=="comfirm"){e="<span class='label label-info'>已审核(等待退货)</span>";}else{if(g.status=="comfirm_direct"){e="<span class='label label-primary'>已审核(无需退货)</span>";
}else{if(g.status=="receive"){e="<span class='label label-info'>已收货</span>";}else{if(g.status=="not_receive"){e="<span class='label label-danger'>未收到</span>";
}else{if(g.status=="exchange"){e="<span class='label label-warning'>换货中</span>";}else{if(g.status=="complete"){e="<span class='label label-primary'>已完成</span>";
}}}}}}}}return e;}},{name:"button",sortable:false,align:"center",width:120,formatter:function(d,f,g){var e="<button  type='button' class='btn btn-sm btn-outline btn-primary viewApplyDetail'   style='margin: 0px 3px 0px 0px;' value='"+g.id+"' >查看详情</button>";
return e;}}],});},_bindEventHander:function(){var a=this;$(SoItemList._CONS_.GR_lIST_ID).on("click",".toApply",function(){var b=$(this).val();a._initApplyForm();
a._apply(b);});$(SoItemList._CONS_.GR_lIST_ID).on("click",".applyRecords",function(){var d=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getRowData",$(this).val());
var b=d["skuId"];var c=$("#"+SoInfo._CONS_.SOINFO_FORM_ID).find("[name=soNo]").val();a._viewRecords(c,b);});$(ExchangeEntityApply._CONS_.GRID).on("click",".viewApplyDetail",function(){var b=$(this).val();
a._detail(b);a.exchangeLog.init(b);});$(".records_wrapper").on("click",".recordsPreBtn",function(){a.clear(true,null);});$("#detailDiv").on("click",".prevBtn",function(){a.clear(false,ExchangeEntityApply._CONS_.CANCEL_BUTTON);
a._showRecordsWrapper();});$("#applyDiv").on("click",".prevBtn",function(){a.clear(false,ExchangeEntityApply._CONS_.CANCEL_BUTTON);});$("#applyDiv").on("click",".saveBtn",function(){a._submitApply();
});$("#"+ExchangeEntityApply._CONS_.FORM_ID).on("change","input",function(){a.isFormDataChange=true;});$("#"+ExchangeEntityApply._CONS_.FORM_ID).on("change","select",function(){a.isFormDataChange=true;
});$("#"+ExchangeEntityApply._CONS_.FORM_ID).on("change","textarea",function(){a.isFormDataChange=true;});$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=needReturn]").on("click",function(){if($(this).val()=="N"){a.exchangeEntityBase.hideReturnInfo();
}else{a.exchangeEntityBase.showReturnInfo();}});$("#"+ExchangeEntityApply._CONS_.FORM_ID).on("change","[name=skuCount]",function(){var b=$("#"+SoInfo._CONS_.SOINFO_FORM_ID).find("[name=canReturnCount]").val();
if(parseInt($(this).val())-parseInt(b)>0){$(this).val(b);}if(parseInt($(this).val())-1<0){$(this).val(1);}});$("#"+ExchangeEntityApply._CONS_.FORM_ID).on("click",".selectImageBtn",function(){ImageUtils.selectImage(1,function(c){if($("#imgContainer").find("ul").length==0){var d=new StringBuffer();
d.append("<ul class='dragsort'>");for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}d.append("</ul>");
$("#imgContainer").append(d.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
}else{var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}$("#imgContainer ul").append(d.toString());
}});a.isFormDataChange=true;});$(document).on("click",".shipQryBtn",function(){var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=id]").val();FormUtils.submit(ExchangeEntityBase._CONS_.SHIP_INFO_QRY_URL,"id="+b,function(c){if(c.success){DialogUtils.success(msgCode.INFO,"查询成功");
var d=$("#shipInfoForm");d.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(c.exchangeEntityPo.apiStatus));d.find("[name=apiRevokeTime]").val(c.exchangeEntityPo.apiRevokeTime);
d.find(".shippingDataDiv").empty().append(c.exchangeEntityPo.apiReturnData);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});});},_apply:function(b){var a=this;$(".exchangeEntityDetailDiv").find("[id=detailDiv]").hide();$(".exchangeEntityDetailDiv").find("[id=applyDiv]").show();
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=skuCount]").attr("readonly",false);$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=reasonName]").attr("readonly",false);
a._showFormWrapper();a.soInfo.loadSoItemData(b);},_detail:function(b){var a=this;$(".exchangeEntityDetailDiv").find("[id=detailDiv]").show();$(".exchangeEntityDetailDiv").find("[id=applyDiv]").hide();
a._showFormWrapper();a.exchangeEntityBase.loadData(b,a._initDetailForm);},_viewRecords:function(d,a){var b=this;var c=ExchangeEntityApply._CONS_.RETURN_ENTITY_RECORDS+"?soNo="+d+"&skuId="+a;
b._showRecordsWrapper();FormUtils.loadData(c,function(e){b._initJqgrid({data:e});});},_submitApply:function(){var a=this;var b=$("#"+ExchangeEntityApply._CONS_.FORM_ID);
var c=$("#"+SoInfo._CONS_.SOINFO_FORM_ID);if(b.valid()){reqUrl=ExchangeEntityApply._CONS_.SAVE_ADD_URL;var d=new StringBuffer();d.append("csId="+c.find("[name=csId]").val());
d.append("&soNo="+c.find("[name=soNo]").val());d.append("&skuName="+c.find("[name=skuName]").val());d.append("&skuId="+c.find("[name=skuId]").val());d.append("&skuImage="+c.find("[name=skuImage]").val());
d.append("&skuCount="+b.find("[name=skuCount]").val());d.append("&needReturn="+b.find("[name=needReturn]").val());d.append("&returnAddr="+b.find("[name=returnAddr]").val());
d.append("&trackingNo="+b.find("[name=trackingNo]").val());d.append("&shipAmount="+b.find("[name=shipAmount]").val());d.append("&reasonName="+b.find("[name=reasonName]").val());
d.append("&comment="+b.find("[name=comment]").val());d.append("&imgUrls="+a._getImgUrl());d.append("&scId="+b.find("[name=scId]").val());ButtonUtils.disableBtn("saveBtn");
FormUtils.submit(reqUrl,d.toString(),function(e){ButtonUtils.enableBtn("saveBtn");if(e.success){if(e.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(e.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}a.isEdit=false;a.clear(true,ExchangeEntityApply._CONS_.SAVE_BUTTON);
}else{DialogUtils.error(msgCode.FAIL_MSG,e.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_getImgUrl:function(){var b=new Array();
var a=$("#imgContainer").find("ul.dragsort");if(a.length>0){a.find("li").each(function(){var c=$(this).find("div.file-box div.file");b.push(c.attr("urlVal"));
});}return b.join(",");},clear:function(d,c){var a=this;function b(){if(d){JTTabUtils.refreshTab(ExchangeEntityApply._CONS_.REFRESH_URL+"?soNo="+soNo);
}else{a._showListWrapper();a.isFormDataChange=false;a.isEdit=false;a.soInfo.clearDataInfo();a._initApplyForm();}}if(c==ExchangeEntityApply._CONS_.CANCEL_BUTTON&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".soInfoDiv").show();$(".exchangeEntityDetailDiv").hide();$(".records_wrapper").hide();},_showFormWrapper:function(){$(".soInfoDiv").hide();
$(".exchangeEntityDetailDiv").show();$(".records_wrapper").hide();},_showRecordsWrapper:function(){$(".soInfoDiv").hide();$(".exchangeEntityDetailDiv").hide();
$(".records_wrapper").show();},_initApplyForm:function(){$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=skuCount]").val("1");$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=reasonName]").val("").attr("readonly",false);
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=needReturn]").val("Y").attr("disabled",false);$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=shipAmount]").val("0").attr("readonly",false);
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=trackingNo]").val("").attr("readonly",false);$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=returnAddr]").val("").attr("readonly",false);
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=comment]").val("").attr("readonly",false);$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=reasonName]").val("").attr("readonly",false);
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[id=commentDiv]").show();$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[id=imgDiv]").show();$("#"+ExchangeEntityApply._CONS_.FORM_ID+" .selectImageBtn").show();
$("#imgContainer").text("");$("#detailTabLi").addClass("active");$("#detailTab").addClass("active");$("#logTabLi").removeClass("active");$("#logTab").removeClass("active");
$("#logTabLi").hide();$(".editInfoDiv").hide();},_initDetailForm:function(){$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=skuCount]").attr("readonly","readonly");
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=reasonName]").attr("readonly","readonly");$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=needReturn]").attr("disabled",true);
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=shipAmount]").attr("readonly","readonly");$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=trackingNo]").attr("readonly","readonly");
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=returnAddr]").attr("readonly","readonly");$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[name=reasonName]").attr("readonly","readonly");
$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[id=commentDiv]").hide();$("#"+ExchangeEntityApply._CONS_.FORM_ID+" .selectImageBtn").hide();if($("#"+ExchangeEntityApply._CONS_.FORM_ID+" .deleteImage").length>0){$("#"+ExchangeEntityApply._CONS_.FORM_ID+" .deleteImage").remove();
}else{$("#"+ExchangeEntityApply._CONS_.FORM_ID).find("[id=imgDiv]").hide();}$("#detailTabLi").addClass("active");$("#detailTab").addClass("active");$("#logTabLi").removeClass("active");
$("#logTab").removeClass("active");$("#logTabLi").show();},_bindFormValidation:function(){var a={rules:{skuCount:{required:true,number:true,min:1},shipAmount:{number:true,min:0},trackingNo:{maxlength:["128"]},reasonName:{required:true,maxlength:["1024"]},returnAddr:{maxlength:["512"]},comment:{maxlength:["1024"]}},messages:{}};
FormUtils.bindFormValidation(ExchangeEntityApply._CONS_.FORM_ID,a);},_initSoInfo:function(){var a={type:SoInfo._CONS_.EXCHANGE_TYPE};this.soInfo.init(a);
},_initInputAndOption:function(){CateUtils.getOptions({typeKey:"system",pKey:"shipCode",container:"shipCompany"});}};