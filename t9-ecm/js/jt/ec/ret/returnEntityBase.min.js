function ReturnEntityBase(){this.hadInit=false;this.isFormDataChange=false;this.soItemList=new SoItemList();}ReturnEntityBase._CONS_={EDIT_URL:ctx+"/ec/ret/returnEntity/edit.htm",DETAIL_URL:ctx+"/ec/ret/returnEntity/detail.htm",DELETE_URL:ctx+"/ec/ret/returnEntity/delete.htm",SAVE_ADD_URL:ctx+"/ec/ret/returnEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/ret/returnEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/ret/returnEntity/listData.htm",COUNT_STATUS_URL:ctx+"/ec/ret/returnEntity/countAllStatus.htm",CS_EDIT_URL:ctx+"/crm/cs/csEntity/edit.htm",APPLY_FORM_ID:"returnApplyForm",COMFIRM_TAB_TYPE:"comfirm",RECEIVE_TAB_TYPE:"receive",REFUND_TAB_TYPE:"refund",REFUNDING_TAB_TYPE:"refunding",COMPLETE_TAB_TYPE:"complete",REJECT_TAB_TYPE:"reject",NOT_RECEIVE_TAB_TYPE:"notReceive",SHIP_INFO_QRY_URL:ctx+"/ec/ret/returnEntity/renewShipInfo.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",RETURN_DETAIL_PAGE_URL:ctx+"/ec/ret/returnEntity/detail.htm",FIND_BY_RNO_URL:ctx+"/ec/ret/returnEntity/findCsByRno.htm",};
ReturnEntityBase.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}this.listDataUrl=ReturnEntityBase._CONS_.LIST_DATA_URL;
if(a!=null&&typeof a!=undefined){if(a.listParams!=undefined){this.listDataUrl=this.listDataUrl+"?"+a.listParams;}if(a.grid!=undefined){this.grid=a.grid;
}if(a.pager!=undefined){this.pager=a.pager;}if(a.getManagerBtns!=undefined){this.getManagerBtns=a.getManagerBtns;}if(a.widthElement!=undefined){this.widthElement=a.widthElement;
}if(a.gridRecordsSpan!=undefined){this.gridRecordsSpan=a.gridRecordsSpan;}if(a.type!=undefined){this.type=a.type;}if(a.onSelectRow!=undefined){this.onSelectRow=a.onSelectRow;
}}this._initJqgrid(null);},loadData:function(c,b){var a=this;FormUtils.loadData(ReturnEntityBase._CONS_.EDIT_URL+"?id="+c+"&canShowScTrankNo="+(ResUtils.canShow("returnEntity.button.showScTrackNo")?"can":"canot"),function(e){var d=$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID);
var f=$("#refundAddForm");$(".editInfoDiv").show();d.find("[name=rno]").val(e.rno);d.find("[name=id]").val(e.id);d.find("[name=skuCount]").val(e.skuCount);
d.find("[name=returnAddr]").val(e.returnAddr);d.find("[name=trackingNo]").val(e.trackingNo);d.find("[name=scId]").val(e.scId);d.find("[name=shipAmount]").val(e.shipAmount);
d.find("[name=reasonName]").val(e.reasonName);d.find("[name=csName]").val(e.soInfoVo.csName);d.find("[name=statusName]").val(e.statusName);d.find("[name=needReturn]").val(e.needReturn);
f.find("[id=canReturnMaxAmount]").val(e.soInfoVo.soItemVos[0].sum);a.initCsAccount(e.csId);if(e.deductPoint){if(e.diffMoney&&parseInt(e.diffMoney)>0){f.find("[id=pointTip]").text("（退货将扣除消费赠送的积分:"+e.deductPoint+"，由于部分积分已兑换，需要扣除对应金额，金额为:"+e.diffMoney+"元）");
}else{f.find("[id=pointTip]").text("（退货将扣除消费赠送的积分:"+e.deductPoint+"）");}}if(e.financeBillPo){f.find("[name=payType]").val(e.financeBillPo.payType);f.find("[name=amount]").val(e.financeBillPo.total);
f.find("[name=receiptAccount]").val(e.financeBillPo.receiptAccount);f.find("[name=status]").val(e.financeBillPo.statusName);$("#viewBillDiv").show();}if(e.needReturn=="N"){if("awaiting"==e.status){a.hideReturnInfo(false);
}else{a.hideReturnInfo(true);}}else{if("awaiting"==e.status){a.showReturnInfo(false);}else{a.showReturnInfo(true);}}if("comfirm"==e.status){$(".shipQryBtn").show();
}else{$(".shipQryBtn").hide();}a._showImages(e.returnImgPos);a.soItemList.init({data:e.soInfoVo.soItemVos,type:SoItemList._CONS_.ONE_TYPE});if(b&&typeof(b)=="function"){b(e);
}a._fillShipInfo(e);});},_bindEventHander:function(){var a=this;$(document).on("click",".selectImageBtn",function(){ImageUtils.selectImage(1,function(c){if($("#imgContainer").find("ul").length==0){var d=new StringBuffer();
d.append("<ul class='dragsort'>");for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}d.append("</ul>");
$("#imgContainer").append(d.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
}else{var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}$("#imgContainer ul").append(d.toString());
}});a.isFormDataChange=true;});$(document).on("click",".shipQryBtn",function(){ButtonUtils.disableBtn("shipQryBtn");var b=$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[name=id]").val();
FormUtils.submit(ReturnEntityBase._CONS_.SHIP_INFO_QRY_URL,"id="+b,function(c){ButtonUtils.enableBtn("shipQryBtn");if(c.success){DialogUtils.success(msgCode.INFO,"查询成功");
var d=$("#shipInfoForm");d.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(c.returnEntityPo.apiStatus));d.find("[name=apiRevokeTime]").val(c.returnEntityPo.apiRevokeTime);
d.find(".shippingDataDiv").empty().append(c.returnEntityPo.apiReturnData);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){ButtonUtils.enableBtn("shipQryBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".soTab",function(){var c=$(this).attr("csIdVal");var b=$(this).attr("value");
FormUtils.submit(ReturnEntityBase._CONS_.CS_EDIT_URL,"id="+c,function(d){JTTabUtils.addOrRefreshTab(ReturnEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,d.name+"的订单明细");
});});$("body").on("click",".returnTab",function(){var c=$(this).attr("value");var b=ReturnEntityBase._CONS_.FIND_BY_RNO_URL;FormUtils.loadData(b+"?rNo="+c,function(d){JTTabUtils.addOrRefreshTab(ReturnEntityBase._CONS_.RETURN_DETAIL_PAGE_URL+"?rno="+c,d.name+"的退货单明细");
});});},_getManagerBtns:function(c){var b=this;var a=[];var c=b.type;if(c==ReturnEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("returnEntity.button.comfirm")){a.push({lable:"去审核",btnClasses:"btn btn-primary returnEntityComfirm",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("returnEntity.button.comfirmEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary comfirmEdit",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("returnEntity.button.comfirmDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary comfirmDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("returnEntity.button.receive")){a.push({lable:"去确认收货",btnClasses:"btn btn-primary returnEntityReceive",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("returnEntity.button.receiveEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary receiveEdit",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("returnEntity.button.receiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary receiveDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.REFUND_TAB_TYPE&&ResUtils.canShow("returnEntity.button.refund")){a.push({lable:"退 款",btnClasses:"btn btn-primary returnEntityRefund",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.REFUND_TAB_TYPE&&ResUtils.canShow("returnEntity.button.refundEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary refundEdit",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.REFUND_TAB_TYPE&&ResUtils.canShow("returnEntity.button.refundDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary refundDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.REFUNDING_TAB_TYPE&&ResUtils.canShow("returnEntity.button.refundingDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary refundingDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.COMPLETE_TAB_TYPE&&ResUtils.canShow("returnEntity.button.completeDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary completeDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.REJECT_TAB_TYPE&&ResUtils.canShow("returnEntity.button.rejectDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary rejectDetail",iconClasses:"fa fa-edit"});
}if(c==ReturnEntityBase._CONS_.NOT_RECEIVE_TAB_TYPE&&ResUtils.canShow("returnEntity.button.notReceiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary notReceiveDetail",iconClasses:"fa fa-edit"});
}if(a.length>0){return a;}else{return"";}},_initJqgrid:function(b){var a=this;if(b==null||typeof b==undefined){b={};}$(a.grid).JTJqgrid({url:a.listDataUrl,pager:a.pager,postData:b,multiselectWidth:20,colNames:["退货单号","订单号","商品名称","数量","是否回寄","申请时间","状态","操作"],colModel:[{name:"rno",index:"rno_",width:100,formatter:function(c,d,e){if(e.rno!=null&&e.rno!=""){return"<a href='#' class='returnTab' value='"+e.rno+"' >"+e.rno+"</a>";
}return e.rno;}},{name:"soNo",index:"so_no_",width:100,formatter:function(c,d,e){return"<a class='soTab' csIdVal='"+e.csId+"' value='"+e.soNo+"'>"+e.soNo+"</a>";
}},{name:"skuName",index:"sku_name_",width:140,formatter:function(d){var c=new StringBuffer();c.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");
c.append(d);c.append("</div>");return c.toString();}},{name:"skuCount",index:"sku_count_",width:100},{name:"needReturn",index:"need_return_",width:100,formatter:function(c,e,f){var d=f.needReturn;
if(f.needReturn=="Y"){d="<span>需要</span>";}else{if(f.needReturn=="N"){d="<span>不需要</span>";}}return d;}},{name:"createTime",index:"create_time_",width:100,formatter:function(c){return DateUtils.miniTime(c);
}},{name:"status",index:"status_",width:120,formatter:function(c,e,f){var d=f.status;if(f.status=="awaiting"){d="<span>待审核</span>";}else{if(f.status=="reject"){d="<span>审核不通过</span>";
}else{if(f.status=="comfirm"){d="<span>已审核(等待退货)</span>";}else{if(f.status=="comfirm_direct"){d="<span>已审核(无需退货)</span>";}else{if(f.status=="receive"){d="<span>已收货</span>";
}else{if(f.status=="not_receive"){d="<span>未收到货</span>";}else{if(f.status=="refund"){d="<span>退款中</span>";}else{if(f.status=="complete"){d="<span>已完成</span>";
}}}}}}}}return d;}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:a._getManagerBtns(a.type)}],loadComplete:function(){a._disableBtn();
if(a.gridRecordsSpan!=null){$(a.gridRecordsSpan).empty().append($(a.grid).jqGrid("getGridParam","records"));}},onSelectRow:function(d,c){if(a.onSelectRow&&typeof(a.onSelectRow)=="function"){a.onSelectRow(d,c);
}}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(a.grid,a.searchParam);},_edit:function(a){this._showFormWrapper();this.edit=true;this.loadData(a);
},_save:function(b,f,e){var d=this;var c=$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID);if("Y"==c.find("[name=needReturn]").val()){c.find("[name=scId]").rules("add",{required:true});
c.find("[name=trackingNo]").rules("add",{required:true});}else{c.find("[name=scId]").rules("remove");c.find("[name=trackingNo]").rules("remove");}if(c.valid()){var a=ReturnEntity._CONS_.SAVE_EDIT_URL;
if(e){a=e;}var g=new StringBuffer();g.append("id="+c.find("[name=id]").val());g.append("&reasonName="+c.find("[name=reasonName]").val());g.append("&needReturn="+c.find("[name=needReturn]").val());
g.append("&returnAddr="+c.find("[name=returnAddr]").val());g.append("&scId="+c.find("[name=scId]").val());g.append("&trackingNo="+c.find("[name=trackingNo]").val());
g.append("&shipAmount="+(c.find("[name=shipAmount]").val()<0?0:c.find("[name=shipAmount]").val()));g.append("&comment="+c.find("[name=comment]").val());
g.append("&imgUrls="+d._getImgUrl());g.append("&status="+b);if(b=="refund"){g.append("&payType="+$("#refundAddForm").find("[name=payType]").val());g.append("&amount="+$("#refundAddForm").find("[name=amount]").val());
g.append("&receiptAccount="+$("#refundAddForm").find("[name=receiptAccount]").val());g.append("&pointTip="+$("#refundAddForm").find("[id=pointTip]").text());
}d._disableBtn();FormUtils.submit(a,g.toString(),function(h){d._enableGrantBtn();if(h.success){if(h.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(h.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}d.clear(false);f(true);}else{DialogUtils.error(msgCode.FAIL_MSG,h.msg);
}},function(){d._enableGrantBtn();DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}},_detail:function(a){this._showFormWrapper();this.loadData(a);
$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(ReturnEntityBase._CONS_.APPLY_FORM_ID);},_showListWrapper:function(){$(".list_wrapper").show();
$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();$(".form_wrapper").show();},_showImages:function(a){var c=new StringBuffer();
c.append("<ul class='dragsort'>");for(var b=0;b<a.length;b++){c.append("<li>");c.append(ImageUtils.createImageDivStr([a[b]],true));c.append("</li>");}c.append("</ul>");
$("#imgContainer").empty().append(c.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
$(".deleteImage").remove();},_getImgUrl:function(){var b=new Array();var a=$("#imgContainer").find("ul.dragsort");if(a.length>0){a.find("li").each(function(){var c=$(this).find("div.file-box div.file");
b.push(c.attr("urlVal"));});}return b.join(",");},_disableBtn:function(){ButtonUtils.disableBtn("comfirmEdit");ButtonUtils.disableBtn("receiveEdit");ButtonUtils.disableBtn("receiveDetail");
ButtonUtils.disableBtn("returnEntityComfirm");ButtonUtils.disableBtn("returnEntityReceive");ButtonUtils.disableBtn("comfirmDetail");ButtonUtils.disableBtn("receiveDetail");
ButtonUtils.disableBtn("refundDetail");ButtonUtils.disableBtn("comfirm");ButtonUtils.disableBtn("comfirm_direct");ButtonUtils.disableBtn("reject");ButtonUtils.disableBtn("receive");
ButtonUtils.disableBtn("not_receive");ButtonUtils.disableBtn("prevBtn");ButtonUtils.disableBtn("returnEntityRefund");ButtonUtils.disableBtn("refundEdit");
ButtonUtils.disableBtn("refundingDetail");ButtonUtils.disableBtn("completeDetail");ButtonUtils.disableBtn("rejectDetail");ButtonUtils.disableBtn("notReceiveDetail");
},_enableGrantBtn:function(){ButtonUtils.enableBtn("comfirm");ButtonUtils.enableBtn("comfirm_direct");ButtonUtils.enableBtn("reject");ButtonUtils.enableBtn("receive");
ButtonUtils.enableBtn("not_receive");ButtonUtils.enableBtn("prevBtn");},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a._initTabShow();FormUtils.clear(ReturnEntityBase._CONS_.APPLY_FORM_ID);FormUtils.enableForm(ReturnEntityBase._CONS_.APPLY_FORM_ID);$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[name=csName]").attr("disabled",true);
$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[name=skuCount]").attr("disabled",true);$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[name=statusName]").attr("disabled",true);
a.initRefundAddForm();$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[id=imgDiv]").show();$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID).find("[id=imgContainer]").show();
$("#refundAddForm").find("[id=pointTip]").hide();}if(c&&a.isFormDataChange){DialogUtils.warning(function(){b();});}else{b();}},countAllStatus:function(){FormUtils.loadData(ReturnEntityBase._CONS_.COUNT_STATUS_URL,function(a){if(a){$("#returnEntityComfirmGrid_record").text(a[0]);
$("#returnEntityReceiveGrid_record").text(a[1]);$("#returnEntityRefundGrid_record").text(a[2]);$("#returnEntityRefundingGrid_record").text(a[3]);$("#returnEntityCompleteGrid_record").text(a[4]);
$("#returnEntityRejectGrid_record").text(a[5]);$("#returnEntityNotReceiveGrid_record").text(a[6]);}});},openEditDialog:function(c,b){var a=this;a.layerIndex=layer.open({type:1,title:"退款单据",maxmin:false,shadeClose:false,scrollbar:false,btn:["确定","关闭"],area:["600px","350px"],content:$("#refundPage"),success:function(d,e){},yes:function(e,d){if(c){var f=$("#refundAddForm").find("[name=amount]").val();
var g=$("#refundAddForm").find("[name=receiptAccount]").val();if(!(f&&f>0)){DialogUtils.error(msgCode.FAIL_MSG,"请填写有效的退款金额");return;}if(!g){DialogUtils.error(msgCode.FAIL_MSG,"请填写收款账号");
return;}b();layer.close(a.layerIndex);}else{layer.close(a.layerIndex);}}});},showReturnInfo:function(a){$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .returnInfoDiv").show();
$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .needReturnDiv").show();$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .shipAmountDiv").show();$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .scDiv").show();
$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .trackingNoDiv").show();$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .returnAddrDiv").show();if(a){$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .needReturnDiv").hide();
}},hideReturnInfo:function(a){$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .shipAmountDiv").hide().find("input[name=shipAmount]").val(0);$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .scDiv").hide().find("[name=scId]").val("");
$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .trackingNoDiv").hide().find("input[name=trackingNo]").val("");$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .returnAddrDiv").hide().find("input[name=returnAddr]").val("");
if(a){$("#"+ReturnEntityBase._CONS_.APPLY_FORM_ID+" .returnInfoDiv").hide();}},initRefundAddForm:function(){$("#refundAddForm").find("[name=payType]").val("alipay");
$("#refundAddForm").find("[name=amount]").val(0);$("#refundAddForm").find("[name=receiptAccount]").val("");},initCsAccount:function(b){$("#receiptAccount").bsSuggest("destroy");
var a=$("#receiptAccount").bsSuggest({getDataMethod:"url",url:ctx+"/crm/cs/csEntity/findAccount.htm?csId="+b+"&account=",inputWarnColor:null,autoSelect:false,idField:"accountType",keyField:"account",effectiveFields:["typeName","account"],effectiveFieldsAlias:{typeName:"结算方式",account:"账户"},processData:function(f){var e,c,g={value:[]};
if(!f||f.length===0){return false;}c=f.length;for(e=0;e<c;e++){var d="";if("alipay"==f[e].accountType){d="支付宝";}else{if("weixin"==f[e].accountType){d="微信";
}else{if("bank"==f[e].accountType){d="银行转账";}}}g.value.push({id:f[e].id,typeName:d,account:f[e].account,accountType:f[e].accountType});}return g;}}).on("onSetSelectValue",function(d,c){$("[name=payType]").val(c.id);
});$("#receiptAccount").bsSuggest("enable");},_fillShipInfo:function(a){if(a.scName&&a.trackingNo){$("#shipTabLi").show();var b=$("#shipInfoForm");b.find("[name=scName]").val(a.scName);
b.find("[name=trackingNo]").val(a.trackingNo);b.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(a.apiStatus));b.find("[name=apiRevokeTime]").val(a.apiRevokeTime);
b.find(".shippingDataDiv").empty().append(a.apiReturnData);}else{$("#shipTabLi").hide();}},_initTabShow:function(){$(".returnDetailDiv .tabli").removeClass("active");
$(".returnDetailDiv .tabli").eq(0).addClass("active");$(".returnDetailDiv .tab-pane").removeClass("active");$(".returnDetailDiv .tab-pane").eq(0).addClass("active");
},};