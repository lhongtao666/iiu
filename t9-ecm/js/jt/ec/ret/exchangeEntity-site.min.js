$(function(){var a=new ExchangeEntity();a.init();});function ExchangeEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityComfirm=new ExchangeEntityComfirm();this.exchangeEntityReceive=new ExchangeEntityReceive();this.exchangeEntityExchange=new ExchangeEntityExchange();
this.exchangeEntityExchangeing=new ExchangeEntityExchangeing();this.exchangeEntityComplete=new ExchangeEntityComplete();this.exchangeEntityReject=new ExchangeEntityReject();
this.exchangeEntityNotReceive=new ExchangeEntityNotReceive();this.exchangeLog=new ExchangeLog();}ExchangeEntity._CONS_={EDIT_URL:ctx+"/ec/ret/exchangeEntity/edit.htm",DETAIL_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",DELETE_URL:ctx+"/ec/ret/exchangeEntity/delete.htm",SAVE_ADD_URL:ctx+"/ec/ret/exchangeEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/ret/exchangeEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/ret/exchangeEntity/listData.htm",EDIT_FORM_ID:"exchangeEntityForm",GRID:"#exchangeEntityGrid",PAGER:"#exchangeEntityPager"};
ExchangeEntity.prototype={init:function(a){if(!this.hadInit){excWidth=$(".wait_submit_wrapper").width();this.hadInit=true;this._hideNotGrantBtn();this._initTabShow();
this._bindFormValidation();this._bindEventHander();this._initInputAndOption();this.exchangeEntityComfirm.init();this.exchangeEntityReceive.init();this.exchangeEntityExchange.init();
this.exchangeEntityExchangeing.init();this.exchangeEntityComplete.init();this.exchangeEntityReject.init();this.exchangeEntityNotReceive.init();this.exchangeEntityBase.countAllStatus();
if("index"==fromType){this._initTabForReceive();}}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("exchangeEntity.button.comfirm")){$(".exchangeEntityComfirm").hide();
}if(!ResUtils.canShow("exchangeEntity.button.comfirmEdit")){$(".comfirmEdit").hide();}if(!ResUtils.canShow("exchangeEntity.button.comfirmDetail")){$(".comfirmDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.receive")){$(".exchangeEntityReceive").hide();}if(!ResUtils.canShow("exchangeEntity.button.receiveEdit")){$(".receiveEdit").hide();
}if(!ResUtils.canShow("exchangeEntity.button.receiveDetail")){$(".receiveDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.exchange")){$(".exchangeEntityExchange").hide();
}if(!ResUtils.canShow("exchangeEntity.button.exchangeEdit")){$(".exchangeEdit").hide();}if(!ResUtils.canShow("exchangeEntity.button.exchangeDetail")){$(".exchangeDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.exchangeingDetail")){$(".exchangeingDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.completeDetail")){$(".completeDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.rejectDetail")){$(".rejectDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.notReceiveDetail")){$(".notReceiveDetail").hide();
}},_bindEventHander:function(){var a=this;$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".exchangeDetailDiv").on("click","#prevBtn",function(){a.initEditForm(true);});$(".exchangeDetailDiv").on("click","#save",function(){a.exchangeEntityBase._save("",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#comfirm",function(){var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=needReturn]").val();if(b=="N"){DialogUtils.error(msgCode.FAIL_MSG,"请确认等待退货跟是否需要回寄一致");
return;}a.exchangeEntityBase._save("comfirm",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#comfirm_direct",function(){var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=needReturn]").val();
if(b=="Y"){DialogUtils.error(msgCode.FAIL_MSG,"请确认无需退货跟是否需要回寄一致");return;}a.exchangeEntityBase._save("comfirm_direct",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#reject",function(){a.exchangeEntityBase._save("reject",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#receive",function(){a.exchangeEntityBase._save("receive",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#not_receive",function(){a.exchangeEntityBase._save("not_receive",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#exchange",function(){a.exchangeEntityBase.exchangeAdd();
});$(".exchangeAddDiv").on("click","#submitExchange",function(){if(a.validExchangeAdd()){a.exchangeEntityBase._save("exchange",function(){a.initEditForm(false);
},ExchangeEntityExchange._CONS_.SAVE_ADD_URL);}});$(".exchangeAddDiv").on("click","#cancelSubmit",function(){a.exchangeEntityExchange.reInitAddForm();a.exchangeEntityBase._showExchangeDetailDiv();
});$("body").on("click",".exchangeEntityComfirm",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initComfirmBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".comfirmEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);
});$("body").on("click",".comfirmDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeEntityReceive",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initReceiveBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".receiveEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".receiveDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeEntityExchange",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initExchangeBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){a.exchangeEntityBase.soItemList.genEditSoItemGrid({data:c.soInfoVo.soItemVos,soType:c.soInfoVo.soType});
StoreUtils.loadStores(c.soInfoVo.storeId,"storeIdContainer");a.exchangeEntityExchange.genAddrContainer(c.addrList,c.soInfoVo.soShipPos[0].addrId);a.exchangeEntityExchange.fillInitData(c.soInfoVo);
});});$("body").on("click",".exchangeEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeingDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchangeing._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){if(c.exSoInfoVo){a.exchangeEntityBase.soItemList.genExchangeSoItemGrid({data:c.exSoInfoVo.soItemVos,soType:c.exSoInfoVo.soType});
}if(!(c.exchangeImgPos&&c.exchangeImgPos.length>0)){$("#imgDiv").hide();}$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").show();a.exchangeEntityExchangeing.initBillForm(c);
});});$("body").on("click",".completeDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComplete._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){if(c.exSoInfoVo){a.exchangeEntityBase.soItemList.genExchangeSoItemGrid({data:c.exSoInfoVo.soItemVos,soType:c.exSoInfoVo.soType});
}if(!(c.exchangeImgPos&&c.exchangeImgPos.length>0)){$("#imgDiv").hide();}$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").show();a.exchangeEntityExchangeing.initBillForm(c);
});});$("body").on("click",".rejectDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReject._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".notReceiveDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityNotReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$(".exchangeListDiv").on("click",".listTabli",function(){var c=$(this).attr("attr-type");var b=a._getActiveTab();if(c==b){return;
}if("comfirm"==c){a.exchangeEntityComfirm.init();}if("receive"==c){a.exchangeEntityReceive.init();}if("exchange"==c){a.exchangeEntityExchange.init();}if("exchangeing"==c){a.exchangeEntityExchangeing.init();
}if("complete"==c){a.exchangeEntityComplete.init();}if("reject"==c){a.exchangeEntityReject.init();}if("notReceive"==c){a.exchangeEntityNotReceive.init();
}});$(document).on("click",".exchangeEntitySearch",function(){var d=$(this).closest("form").serialize();var c=$(this).closest("form").find("#skuInfoSearch").val();
d=d+"&skuInfo="+c;var b=a._getActiveTab();a.reloadJqgrid(b,d);});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).find("[name=needReturn]").on("click",function(){if($(this).val()=="N"){a.exchangeEntityBase.hideReturnInfo();
}else{a.exchangeEntityBase.showReturnInfo();}});},_bindFormValidation:function(){var a={rules:{skuCount:{required:true,number:true,min:1},shipAmount:{number:true,min:0},trackingNo:{maxlength:["128"]},reasonName:{required:true,maxlength:["1024"]},returnAddr:{maxlength:["512"]},comment:{maxlength:["1024"]}},messages:{}};
FormUtils.bindFormValidation(ExchangeEntity._CONS_.EDIT_FORM_ID,a);FormUtils.bindFormValidation(ExchangeEntityExchange._CONS_.EXCHANGE_ADD_FORM,a);},_initTabShow:function(){$(".listTabPane").not(":eq(0)").removeClass("active");
},_getActiveTab:function(){var b=this;var a=$(".listTabli");var c="";$.each(a,function(d,e){if($(this).hasClass("active")){c=$(this).attr("attr-type");
}});return c;},_initComfirmBtn:function(){$("#saveDiv").hide();$("#comfirmDiv").show();$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("comfirm");
ButtonUtils.enableBtn("comfirm_direct");ButtonUtils.enableBtn("reject");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initReceiveBtn:function(){$("#saveDiv").hide();
$("#comfirmDiv").hide();$("#receiveDiv").show();$("#exchangeDiv").hide();ButtonUtils.enableBtn("receive");ButtonUtils.enableBtn("not_receive");ButtonUtils.enableBtn("prevBtn");
$("#commentDiv").show();},_initExchangeBtn:function(){$("#saveDiv").hide();$("#comfirmDiv").hide();$("#receiveDiv").hide();$("#exchangeDiv").show();$("#exchangeAddForm").find("[id=pointTip]").show();
ButtonUtils.enableBtn("exchange");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initEditBtn:function(){$("#saveDiv").show();$("#comfirmDiv").hide();
$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("save");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initDetailBtn:function(){$("#saveDiv").hide();
$("#comfirmDiv").hide();$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("prevBtn");FormUtils.disableForm(ExchangeEntity._CONS_.EDIT_FORM_ID);
$("#commentDiv").hide();},initEditForm:function(b){var a=this;if(!b){$(".exchangeEntitySearch").trigger("click");a.exchangeEntityBase.countAllStatus();
}a.exchangeEntityBase.isFormDataChange=a.isFormDataChange;a.exchangeEntityBase.clear(b);a.isFormDataChange=false;},reloadJqgrid:function(b,c){var a=this;
if("comfirm"==b){a.exchangeEntityComfirm.init(c);}if("receive"==b){a.exchangeEntityReceive.init(c);}if("exchange"==b){a.exchangeEntityExchange.init(c);
}if("exchangeing"==b){a.exchangeEntityExchangeing.init(c);}if("complete"==b){a.exchangeEntityComplete.init(c);}if("reject"==b){a.exchangeEntityReject.init(c);
}if("notReceive"==b){a.exchangeEntityNotReceive.init(c);}},validExchangeAdd:function(){var h=$("#exchangeAddForm");var d=h.find("[name=financeType]").val();
if("noChange"!=d){var f=h.find("[name=exAmount]").val();var g=h.find("[name=receiptAccount]").val();var a=h.find("[name=companyAccount]").val();if(!(f&&f>0)){DialogUtils.error(msgCode.FAIL_MSG,"请填写有效的付退金额");
return false;}if("pay"==d&&!a){DialogUtils.error(msgCode.FAIL_MSG,"请选择公司账号");return false;}if("refund"==d&&!g){DialogUtils.error(msgCode.FAIL_MSG,"请填写收款账号");
return false;}}var e=$("#exchangeAddForm").find("[name=exCount]").val();if(!(e&&e>0)){DialogUtils.error(msgCode.FAIL_MSG,"请填写有效的换货数量");return false;}var c="";
var b=$("#exchangeAddForm .addrli");$.each(b,function(j,i){if(!$(this).is(":hidden")){c=$(this).attr("attr-id");}});if(!c){DialogUtils.error(msgCode.FAIL_MSG,"请选择收货地址");
return false;}return true;},_initTabForReceive:function(){$("#comfirmTabLi").removeClass("active");$("#comfirmTab").removeClass("active");$("#receiveTabLi").trigger("click").addClass("active");
$("#receiveTab").addClass("active");},_initInputAndOption:function(){CateUtils.getOptions({typeKey:"system",pKey:"shipCode",container:"shipCompany"});}};
function ExchangeLog(){this.hadInit=false;this.isEdit=false;this.exchangeLogRowid=0;}ExchangeLog._CONS_={SAVE_ADD_URL:ctx+"/ec/ret/exchangeEntity/logSaveAdd.htm",DIV_ID:"#exchangeLogDiv",GRID:"#exchangeLogGrid",GRID_ID:"exchangeLogGrid",PAGER:"#exchangeLogPager",PAGER_ID:"exchangeLogPager",JSON_ID:"exchangeLogJSON",};
ExchangeLog.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();}a.loadListData(b);},loadListData:function(b){var a=this;
FormUtils.loadData(ctx+"/ec/ret/exchangeEntity/exchangeLogListData.htm?Q__S__EQ__entity_id_="+b,function(c){a._initJqgrid({data:c});});},_bindEventHander:function(){var a=this;
$(".form_wrapper").on("click",".exchangeLogDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeLog._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要查看的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,"只能选择一条要查看的记录");return;
}}}var c=$(ExchangeLog._CONS_.GRID).jqGrid("getRowData",b);$("#exchangeLogEditForm").find("[id=nameDiv]").show();$("#exchangeLogEditForm").find("[name=name]").val(c["name"]);
$("#exchangeLogEditForm").find("[name=comment]").val(c["comment"]).attr("disabled",true);$("#logEditType").val("detail");a._openEditDialog();});$(".form_wrapper").on("click",".exchangeLogAdd",function(){$("#exchangeLogEditForm").find("[id=nameDiv]").hide();
$("#exchangeLogEditForm").find("[name=comment]").val("").attr("disabled",false);$("#logEditType").val("add");a._openEditDialog();});},_initJqgrid:function(c){var a=this;
var b=[];if(c){b=c.data;}$(ExchangeLog._CONS_.DIV_ID).empty().append("<table id='"+ExchangeLog._CONS_.GRID_ID+"'></table><div id='"+ExchangeLog._CONS_.PAGER_ID+"'></div>");
$.jgrid.defaults.styleUI="Bootstrap";$(ExchangeLog._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:b,height:350,autowidth:true,shrinkToFit:true,rowNum:10,rownumbers:true,mtype:"POST",viewrecords:true,multiselect:true,colNames:["操作者姓名","源状态","目的状态","操作时间","备注说明","备注（隐藏）"],colModel:[{name:"name",width:120},{name:"srcStatus",width:100,formatter:function(d,f,g){var e=g.srcStatus;
if(g.srcStatus=="awaiting"){e="待审核";}else{if(g.srcStatus=="reject"){e="审核不通过";}else{if(g.srcStatus=="comfirm"){e="已审核(等待退货)";}else{if(g.srcStatus=="comfirm_direct"){e="已审核(无需退货)";
}else{if(g.srcStatus=="receive"){e="已收货";}else{if(g.srcStatus=="not_receive"){e="未收到";}else{if(g.srcStatus=="exchange"){e="换货中";}else{if(g.srcStatus=="complete"){e="已完成";
}else{if(g.srcStatus=="reject"){e="审核不通过";}}}}}}}}}return e;}},{name:"destStatus",width:100,formatter:function(d,f,g){var e=g.destStatus;if(g.destStatus=="awaiting"){e="待审核";
}else{if(g.destStatus=="reject"){e="审核不通过";}else{if(g.destStatus=="comfirm"){e="已审核(等待退货)";}else{if(g.destStatus=="comfirm_direct"){e="已审核(无需退货)";}else{if(g.destStatus=="receive"){e="已收货";
}else{if(g.destStatus=="not_receive"){e="未收到";}else{if(g.destStatus=="exchange"){e="换货中";}else{if(g.destStatus=="complete"){e="已完成";}else{if(g.destStatus=="reject"){e="审核不通过";
}}}}}}}}}return e;}},{name:"createTime",width:150},{name:"commentShow",width:300,formatter:function(d,e,f){var g=new StringBuffer();g.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");
g.append(f.comment);g.append("</div>");return g.toString();}},{name:"comment",width:200,hidden:true},],pager:ExchangeLog._CONS_.PAGER,hidegrid:false});
},reloadJqgrid:function(b){var a=this;$(ExchangeLog._CONS_.GRID).jqGrid("setGridParam",{postData:"Q__S__EQ__entity_id_="+b}).trigger("reloadGrid");},_openEditDialog:function(b){var a=this;
a.layerIndex=layer.open({type:1,title:"换货日志",shadeClose:false,btn:["确定","关闭"],area:["600px","450px"],content:$("#exchangeLogPage"),scrollbar:false,success:function(c,d){},yes:function(d,c){if($("#logEditType").val()=="add"){a._save();
}layer.close(a.layerIndex);}});},_save:function(){var b=this;var a=ExchangeLog._CONS_.SAVE_ADD_URL;var c=new StringBuffer();c.append("entityId="+$("#exchangeEntityForm").find("[name=id]").val());
c.append("&comment="+$("#exchangeLogEditForm").find("[name=comment]").val());FormUtils.submit(a,c.toString(),function(d){if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);
}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);}}b.reloadJqgrid($("#exchangeEntityForm").find("[name=id]").val());
}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};function ExchangeImg(){this.hadInit=false;
this.isEdit=false;this.exchangeImgRowid=0;}ExchangeImg._CONS_={GRID:"#exchangeImgGrid",GRID_ID:"exchangeImgGrid",PAGER:"#exchangeImgPager",PAGER_ID:"exchangeImgPager",JSON_ID:"exchangeImgJSON",};
ExchangeImg.prototype={init:function(b){var a=this;if(!a.hadInit){a.hadInit=true;a._bindEventHander();a._initJqgrid(b);}},_bindEventHander:function(){var a=this;
},_initJqgrid:function(b){var a=this;$.jgrid.defaults.styleUI="Bootstrap";$(ExchangeImg._CONS_.GRID).jqGrid({datatype:"json",url:ctx+"/ec/ret/exchangeEntity/exchangeImgListData.htm",height:350,autowidth:true,shrinkToFit:true,rowNum:20,mtype:"POST",viewrecords:true,multiselect:true,rowList:[10,20,30],rownumbers:true,colNames:["所属换货单 ID","所属换货单日志 ID","图片路径","创建时间","操作"],colModel:[{name:"entityId",editable:true,width:120},{name:"logId",editable:true,width:120},{name:"path",editable:true,width:120},{name:"createTime",editable:true,hidedlg:true,hidden:true,width:120},{name:"button",width:120}],pager:ExchangeImg._CONS_.PAGER,hidegrid:false,gridComplete:function(){JTSubGridUtils.addRowButtons(ExchangeImg._CONS_.GRID_ID);
}});$(ExchangeImg._CONS_.GRID).jqGrid("navGrid",ExchangeImg._CONS_.PAGER,{add:true,addtitle:"添加",addfunc:a.addExchangeImgRow,del:true,deltitle:"删除",delfunc:a.delExchangeImg,refresh:false,search:false,edit:false});
},addExchangeImgRow:function(){var a=new Date().getTime();JTSubGridUtils.addRow(ExchangeImg._CONS_.GRID_ID,"tmpexchangeImg"+a);},delExchangeImg:function(a){DialogUtils.confirm(function(){JTSubGridUtils.delRows(ExchangeImg._CONS_.GRID_ID,a);
});},exchangeImgGridData2Json:function(){var c=$(ExchangeImg._CONS_.GRID);var a=new StringBuffer();a.append("[");var d=c.jqGrid("getDataIDs");for(var b=0;
b<d.length;b++){var e=c.jqGrid("getRowData",d[b]);if(e["isGridRowEdit"]=="Y"){alert("有参数尚未保存，请选择保存或者取消变更!");getElementById(d[b]).focus();return false;}a.append("{");
a.append("'entityId':'").append(e["entityId"]).append("',");a.append("'logId':'").append(e["logId"]).append("',");a.append("'path':'").append(e["path"]).append("',");
a.append("'createTime':'").append(e["createTime"]).append("',");if(!d[b].startsWith("tmpexchangeImg")){a.append("'id':'").append(d[b]).append("'");}a.append("},");
}var f=""+a;if(d.length>0){f=f.substring(0,f.length-1);}f=f+"]";$("#"+ExchangeImg._CONS_.JSON_ID).val(f);return true;},validateExchangeImgGrid:function(b,a){var c=$("#exchangeImgForm").validate();
return true;},reloadJqgrid:function(b){var a=this;$(ExchangeImg._CONS_.GRID).jqGrid("setGridParam",{postData:b}).trigger("reloadGrid");},};function ExchangeEntityBase(){this.hadInit=false;
this.isFormDataChange=false;this.soItemList=new SoItemList();}ExchangeEntityBase._CONS_={EDIT_URL:ctx+"/ec/ret/exchangeEntity/edit.htm",DETAIL_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",SAVE_EDIT_URL:ctx+"/ec/ret/exchangeEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/ret/exchangeEntity/listData.htm",COUNT_STATUS_URL:ctx+"/ec/ret/exchangeEntity/countAllStatus.htm",CS_EDIT_URL:ctx+"/crm/cs/csEntity/edit.htm",FORM_ID:"exchangeEntityForm",COMFIRM_TAB_TYPE:"comfirm",RECEIVE_TAB_TYPE:"receive",EXCHANGE_TAB_TYPE:"exchange",EXCHANGEING_TAB_TYPE:"exchangeing",COMPLETE_TAB_TYPE:"complete",REJECT_TAB_TYPE:"reject",NOT_RECEIVE_TAB_TYPE:"notReceive",SHIP_INFO_QRY_URL:ctx+"/ec/ret/exchangeEntity/renewShipInfo.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CHANGE_DETAIL_PAGE_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",FIND_BY_ENO_URL:ctx+"/ec/ret/exchangeEntity/findCsByEno.htm",};
ExchangeEntityBase.prototype={init:function(a){this.listDataUrl=ExchangeEntityBase._CONS_.LIST_DATA_URL;if(a!=null&&typeof a!=undefined){if(a.listParams!=undefined){this.listDataUrl=this.listDataUrl+"?"+a.listParams;
}if(a.grid!=undefined){this.grid=a.grid;}if(a.pager!=undefined){this.pager=a.pager;}if(a.getManagerBtns!=undefined){this.getManagerBtns=a.getManagerBtns;
}if(a.widthElement!=undefined){this.widthElement=a.widthElement;}if(a.gridRecordsSpan!=undefined){this.gridRecordsSpan=a.gridRecordsSpan;}if(a.type!=undefined){this.type=a.type;
}if(a.onSelectRow!=undefined){this.onSelectRow=a.onSelectRow;}}this._initJqgrid(null);if(!this.hadInit){this.hadInit=true;this._bindEventHander();}},loadData:function(c,b){var a=this;
FormUtils.loadData(ExchangeEntityBase._CONS_.EDIT_URL+"?id="+c+"&canShowScTrankNo="+(ResUtils.canShow("exchangeEntity.button.showScTrackNo")?"can":"canot"),function(d){if(d){var f=$("#exchangeEntityForm");
$(".editInfoDiv").show();f.find("[name=eno]").val(d.eno);f.find("[name=id]").val(d.id);f.find("[name=skuCount]").val(d.skuCount);f.find("[name=needReturn]").val(d.needReturn);
f.find("[name=returnAddr]").val(d.returnAddr);f.find("[name=trackingNo]").val(d.trackingNo);f.find("[name=scId]").val(d.scId);f.find("[name=shipAmount]").val(d.shipAmount);
f.find("[name=reasonName]").val(d.reasonName);f.find("[name=csName]").val(d.soInfoVo.csName);f.find("[name=csId]").val(d.soInfoVo.csId);f.find("[name=statusName]").val(d.statusName);
a._initCsAccount(d.csId);a._initCompanyAccount();if(d.deductPoint){var e=$("#exchangeAddForm");if(d.diffMoney&&parseInt(d.diffMoney)>0){e.find("[id=pointTip]").text("（换货将扣除消费赠送的积分:"+d.deductPoint+"，由于部分积分已兑换，需要扣除对应金额，金额为:"+d.diffMoney+"元）");
}else{e.find("[id=pointTip]").text("（换货将扣除消费赠送的积分:"+d.deductPoint+"）");}}if(d.needReturn=="N"){if(d.status=="awaiting"){a.hideReturnInfo(false);}else{a.hideReturnInfo(true);
}}else{if(d.status=="awaiting"){a.showReturnInfo(false);}else{a.showReturnInfo(true);}}if("comfirm"==d.status){$(".shipQryBtn").show();}else{$(".shipQryBtn").hide();
}a._showImages(d.exchangeImgPos);a.soItemList.init({data:d.soInfoVo.soItemVos,type:SoItemList._CONS_.ONE_TYPE});if(b&&typeof(b)=="function"){b(d);}a._fillShipInfo(d);
}});},_bindEventHander:function(){var a=this;$("#"+ExchangeEntityBase._CONS_.FORM_ID).on("click",".selectImageBtn",function(){openSelectImageDialog(1,function(c){if($("#imgContainer").find("ul").length==0){var d=new StringBuffer();
d.append("<ul class='dragsort'>");for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}d.append("</ul>");
$("#imgContainer").append(d.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
}else{var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}$("#imgContainer ul").append(d.toString());
}});a.isFormDataChange=true;});$(document).on("click",".shipQryBtn",function(){ButtonUtils.disableBtn("shipQryBtn");var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=id]").val();
FormUtils.submit(ExchangeEntityBase._CONS_.SHIP_INFO_QRY_URL,"id="+b,function(c){ButtonUtils.enableBtn("shipQryBtn");if(c.success){DialogUtils.success(msgCode.INFO,"查询成功");
var d=$("#shipInfoForm");d.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(c.exchangeEntityPo.apiStatus));d.find("[name=apiRevokeTime]").val(c.exchangeEntityPo.apiRevokeTime);
d.find(".shippingDataDiv").empty().append(c.exchangeEntityPo.apiReturnData);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){ButtonUtils.enableBtn("shipQryBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".soTab",function(){var c=$(this).attr("csIdVal");var b=$(this).attr("value");
FormUtils.submit(ExchangeEntityBase._CONS_.CS_EDIT_URL,"id="+c,function(d){JTTabUtils.addOrRefreshTab(ExchangeEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,d.name+"的订单明细");
});});$("body").on("click",".changeTab",function(){var c=$(this).attr("value");var b=ExchangeEntityBase._CONS_.FIND_BY_ENO_URL;FormUtils.loadData(b+"?eNo="+c,function(d){JTTabUtils.addOrRefreshTab(ExchangeEntityBase._CONS_.CHANGE_DETAIL_PAGE_URL+"?eno="+c,d.name+"的换货单明细");
});});},_getManagerBtns:function(b){var a=[];if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirm")){a.push({lable:"去审核",btnClasses:"btn btn-primary exchangeEntityComfirm",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirmEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary comfirmEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirmDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary comfirmDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receive")){a.push({lable:"去确认收货",btnClasses:"btn btn-primary exchangeEntityReceive",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receiveEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary receiveEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary receiveDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchange")){a.push({lable:"换 货",btnClasses:"btn btn-primary exchangeEntityExchange",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary exchangeEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary exchangeDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGEING_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeingDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary exchangeingDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMPLETE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.completeDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary completeDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.REJECT_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.rejectDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary rejectDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.NOT_RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.notReceiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary notReceiveDetail",iconClasses:"fa fa-edit"});
}if(a.length>0){return a;}else{return"";}},_initJqgrid:function(c){var a=this;if(c==null||typeof c==undefined){c={};}var b=true;if(a.grid=="#exchangeEntityCompleteGrid"||a.grid=="#exchangeEntityExchangeingGrid"){b=false;
}$(a.grid).JTJqgrid({url:a.listDataUrl,pager:a.pager,postData:c,multiselectWidth:20,colNames:["换货单号","订单号","新订单号","商品名称","数量","是否回寄","申请时间","状态","操作"],colModel:[{name:"eno",index:"eno_",width:100,formatter:function(d,e,f){if(f.eno!=null&&f.eno!=""){return"<a href='#' class='changeTab' value='"+f.eno+"' >"+f.eno+"</a>";
}return f.eno;}},{name:"soNo",index:"so_no_",width:100,formatter:function(d,e,f){return"<a class='soTab' csIdVal='"+f.csId+"' value='"+f.soNo+"'>"+f.soNo+"</a>";
}},{name:"exSno",index:"ex_sno_",width:100,hidden:b,formatter:function(d,e,f){return"<a class='soTab' csIdVal='"+f.csId+"' value='"+f.exSno+"'>"+f.exSno+"</a>";
}},{name:"skuName",index:"sku_name_",width:140,formatter:function(e){var d=new StringBuffer();d.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");
d.append(e);d.append("</div>");return d.toString();}},{name:"skuCount",index:"sku_count_",width:100},{name:"needReturn",index:"need_return_",width:100,formatter:function(d,f,g){var e=g.needReturn;
if(g.needReturn=="Y"){e="<span>需要</span>";}else{if(g.needReturn=="N"){e="<span>不需要</span>";}}return e;}},{name:"createTime",index:"create_time_",width:100,formatter:function(d){return DateUtils.miniTime(d);
}},{name:"status",index:"status_",width:120,formatter:function(d,f,g){var e=g.status;if(g.status=="awaiting"){e="<span>待审核</span>";}else{if(g.status=="reject"){e="<span>审核不通过</span>";
}else{if(g.status=="comfirm"){e="<span>已审核(等待退货)</span>";}else{if(g.status=="comfirm_direct"){e="<span>已审核(无需退货)</span>";}else{if(g.status=="receive"){e="<span>已收货</span>";
}else{if(g.status=="not_receive"){e="<span>未收到</span>";}else{if(g.status=="exchange"){e="<span>换货中</span>";}else{if(g.status=="complete"){e="<span>已完成</span>";
}else{if(g.status=="reject"){e="<span>审核不通过</span>";}}}}}}}}}return e;}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns(a.type)}],loadComplete:function(){a._disableBtn();
if(a.gridRecordsSpan!=null){$(a.gridRecordsSpan).empty().append($(a.grid).jqGrid("getGridParam","records"));}},onSelectRow:function(e,d){if(a.onSelectRow&&typeof(a.onSelectRow)=="function"){a.onSelectRow(e,d);
}}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(a.grid,a.searchParam);},_edit:function(b,a){this._showExchangeDetailDiv();this.edit=true;this.loadData(b,a);
},_save:function(f,g,b){var j=this;var c=$("#"+ExchangeEntityBase._CONS_.FORM_ID);if("Y"==c.find("[name=needReturn]").val()){c.find("[name=scId]").rules("add",{required:true});
c.find("[name=trackingNo]").rules("add",{required:true});}else{c.find("[name=scId]").rules("remove");c.find("[name=trackingNo]").rules("remove");}if(c.valid()){var i=ExchangeEntity._CONS_.SAVE_EDIT_URL;
if(b){i=b;}var h=new StringBuffer();h.append("id="+c.find("[name=id]").val());h.append("&reasonName="+c.find("[name=reasonName]").val());h.append("&needReturn="+c.find("[name=needReturn]").val());
h.append("&returnAddr="+c.find("[name=returnAddr]").val());h.append("&scId="+c.find("[name=scId]").val());h.append("&trackingNo="+c.find("[name=trackingNo]").val());
h.append("&shipAmount="+c.find("[name=shipAmount]").val());h.append("&comment="+c.find("[name=comment]").val());h.append("&imgUrls="+j._getImgUrl());h.append("&status="+f);
if(f=="exchange"){var k=$("#exchangeAddForm");var d=$(SoItemList._CONS_.EDIT_GRID).jqGrid("getRowData");var a=k.find("[name=financeType]").val();h.append("&exSkuId="+d[0].skuId);
h.append("&exSkuKey="+d[0].skuKey);h.append("&exStoreId="+k.find("[id=initStoreId]").val());h.append("&exCount="+k.find("[name=exCount]").val());h.append("&financeType="+a);
h.append("&exAmount="+k.find("[name=exAmount]").val());h.append("&payType="+k.find("[name=payType]").val());if("pay"==a){h.append("&receiptAccount="+k.find("[name=companyAccount]").val());
}else{if("refund"==a){h.append("&receiptAccount="+k.find("[name=receiptAccount]").val());}}h.append("&pointTip="+k.find("[id=pointTip]").text());var e=k.find(".addrli");
$.each(e,function(m,l){if(!$(this).is(":hidden")){h.append("&exAddrId="+$(this).attr("attr-id"));}});}j._disableBtn();FormUtils.submit(i,h.toString(),function(l){j._enableGrantBtn();
if(l.success){if(l.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(l.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}j.clear(false);g(true);}else{DialogUtils.error(msgCode.FAIL_MSG,l.msg);}},function(){j._enableGrantBtn();DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},exchangeAdd:function(a){this._showExchangeAddDiv();},_showExchangeListDiv:function(){$(".exchangeListDiv").show();$(".exchangeDetailDiv").hide();
$(".exchangeAddDiv").hide();},_showExchangeDetailDiv:function(){$(".exchangeListDiv").hide();$(".exchangeDetailDiv").show();$(".exchangeAddDiv").hide();
},_showExchangeAddDiv:function(){$(".exchangeListDiv").hide();$(".exchangeDetailDiv").hide();$(".exchangeAddDiv").show();},_showImages:function(a){var c=new StringBuffer();
c.append("<ul class='dragsort'>");for(var b=0;b<a.length;b++){c.append("<li>");c.append(ImageUtils.createImageDivStr([a[b]],true));c.append("</li>");}c.append("</ul>");
$("#imgContainer").empty().append(c.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
$(".deleteImage").remove();},_getImgUrl:function(){var b=new Array();var a=$("#imgContainer").find("ul.dragsort");if(a.length>0){a.find("li").each(function(){var c=$(this).find("div.file-box div.file");
b.push(c.attr("urlVal"));});}return b.join(",");},_disableBtn:function(){ButtonUtils.disableBtn("comfirmEdit");ButtonUtils.disableBtn("receiveEdit");ButtonUtils.disableBtn("exchangeEntityComfirm");
ButtonUtils.disableBtn("exchangeEntityReceive");ButtonUtils.disableBtn("comfirm");ButtonUtils.disableBtn("comfirmDetail");ButtonUtils.disableBtn("receiveDetail");
ButtonUtils.disableBtn("exchangeDetail");ButtonUtils.disableBtn("comfirm_direct");ButtonUtils.disableBtn("reject");ButtonUtils.disableBtn("receive");ButtonUtils.disableBtn("not_receive");
ButtonUtils.disableBtn("prevBtn");ButtonUtils.disableBtn("exchangeEntityExchange");ButtonUtils.disableBtn("exchangeEdit");ButtonUtils.disableBtn("exchangeingDetail");
ButtonUtils.disableBtn("completeDetail");ButtonUtils.disableBtn("rejectDetail");ButtonUtils.disableBtn("notReceiveDetail");},_enableGrantBtn:function(){ButtonUtils.enableBtn("comfirm");
ButtonUtils.enableBtn("comfirm_direct");ButtonUtils.enableBtn("reject");ButtonUtils.enableBtn("receive");ButtonUtils.enableBtn("not_receive");ButtonUtils.enableBtn("prevBtn");
},clear:function(c){var a=this;function b(){a._showExchangeListDiv();a.isFormDataChange=false;a._initTabShow();$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").hide();
FormUtils.clear(ExchangeEntityBase._CONS_.FORM_ID);FormUtils.enableForm(ExchangeEntityBase._CONS_.FORM_ID);$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=csName]").attr("disabled",true);
$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=skuCount]").attr("disabled",true);$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=statusName]").attr("disabled",true);
$("#exchangeAddForm").find("[id=addrContainer]").empty();$("#exchangeAddForm").find("[id=pointTip]").hide();}if(c&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},countAllStatus:function(){FormUtils.loadData(ExchangeEntityBase._CONS_.COUNT_STATUS_URL,function(a){if(a){$("#exchangeEntityComfirmGrid_record").text(a[0]);
$("#exchangeEntityReceiveGrid_record").text(a[1]);$("#exchangeEntityExchangeGrid_record").text(a[2]);$("#exchangeEntityExchangeingGrid_record").text(a[3]);
$("#exchangeEntityCompleteGrid_record").text(a[4]);$("#exchangeEntityRejectGrid_record").text(a[5]);$("#exchangeEntityNotReceiveGrid_record").text(a[6]);
}});},showReturnInfo:function(b){var a=$("#"+ExchangeEntityBase._CONS_.FORM_ID);a.find(".returnInfoDiv").show();a.find(".needReturnDiv").show();a.find(".shipAmountDiv").show();
a.find(".trackingNoDiv").show();a.find(".returnAddrDiv").show();if(b){a.find(".needReturnDiv").hide();}},hideReturnInfo:function(b){var a=$("#"+ExchangeEntityBase._CONS_.FORM_ID);
a.find(".shipAmountDiv").hide().find("[name=shipAmount]").val(0);a.find(".scDiv").hide().find("[name=scId]").val("");a.find(".trackingNoDiv").hide().find("[name=trackingNo]").val("");
a.find(".returnAddrDiv").hide().find("[name=returnAddr]").val("");if(b){a.find(".returnInfoDiv").hide();}},_initCsAccount:function(b){$("#receiptAccount").bsSuggest("destroy");
var a=$("#receiptAccount").bsSuggest({getDataMethod:"url",url:ctx+"/crm/cs/csEntity/findAccount.htm?csId="+b+"&account=",inputWarnColor:null,autoSelect:false,idField:"accountType",keyField:"account",effectiveFields:["typeName","account"],effectiveFieldsAlias:{typeName:"结算方式",account:"账户"},processData:function(f){var e,c,g={value:[]};
if(!f||f.length===0){return false;}c=f.length;for(e=0;e<c;e++){var d="";if("alipay"==f[e].accountType){d="支付宝";}else{if("weixin"==f[e].accountType){d="微信";
}else{if("bank"==f[e].accountType){d="银行转账";}}}g.value.push({id:f[e].id,typeName:d,account:f[e].account,accountType:f[e].accountType});}return g;}}).on("onSetSelectValue",function(d,c){$("[name=payType]").val(c.id);
});$("#receiptAccount").bsSuggest("enable");},_initCompanyAccount:function(){FinanceAccountSelect.initSelect("companyAccount");},_fillShipInfo:function(a){if(a.scName&&a.trackingNo){$("#shipTabLi").show();
var b=$("#shipInfoForm");b.find("[name=scName]").val(a.scName);b.find("[name=trackingNo]").val(a.trackingNo);b.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(a.apiStatus));
b.find("[name=apiRevokeTime]").val(a.apiRevokeTime);b.find(".shippingDataDiv").empty().append(a.apiReturnData);}else{$("#shipTabLi").hide();}},_initTabShow:function(){$(".exchangeDetailDiv .tabli").removeClass("active");
$(".exchangeDetailDiv .tabli").eq(0).addClass("active");$(".exchangeDetailDiv .tab-pane").removeClass("active");$(".exchangeDetailDiv .tab-pane").eq(0).addClass("active");
}};function SoItemList(){this.hadInit=false;this.isEdit=false;this.isCanEdit=true;this.otherFunc=null;this.soItemRowid=0;}SoItemList._CONS_={LIST_TYPE:"list",ONE_TYPE:"one",GRID_DIV:"#soItemGridDiv",GR_LIST_DIV:"#soItemListGridDiv",GR_lIST_ID:"#soItemListGrid",GRID:"#soItemGrid",EDIT_GRID:"#editSoItemGrid",EXCHANGE_GRID:"#exchangeSoItemGrid"};
SoItemList.prototype={init:function(b){var a=this;if(b){a.calType=b.calType;if(!a.hadInit&&b.type==SoItemList._CONS_.LIST_TYPE){a.hadInit=true;a._bindEventHander();
}if(b.type==SoItemList._CONS_.LIST_TYPE){a._initListJqgrid(b);}else{if(b.type==SoItemList._CONS_.ONE_TYPE){a._initJqgrid(b);}}}},_bindEventHander:function(){var a=this;
},_initListJqgrid:function(e){var a=this;var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;}}var c="元";if("point"==e.soType){c="积分";
}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;d[b].spDiscoutShow=d[b].spDiscout;d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);
}}$.jgrid.defaults.styleUI="Bootstrap";$(SoItemList._CONS_.GR_lIST_ID).jqGrid({datatype:"jsonstring",caption:"产品列表",datastr:d,autowidth:true,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["产品图片","产品ID","产品SKU ID","产品SKU编码","已退货数量","审核不通过数量","产品名称","原价("+c+")","数量","折扣("+c+")","小计("+c+")","操作"],colModel:[{name:"prodPic",sortable:false,width:120,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:100,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"returnCount",sortable:false,width:120,hidedlg:true,hidden:true},{name:"rejectReturnCount",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:200},{name:"salesPrice",sortable:false,width:120,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"countShow",sortable:false,align:"right",classes:"test",width:120},{name:"spDiscoutShow",sortable:false,width:120,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"totalAmount",sortable:false,width:120,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"button",sortable:false,align:"center",width:100,formatter:function(f,g,i){var h="";
if(i.countShow>(i.returnCount+i.exchangeCount)){h=h+"<button  type='button'   class='btn btn-sm btn-outline btn-primary toApply'   style='margin: 0px 3px 0px 0px;'    value='"+i.id+"' >申请</button>";
}if((a.calType==SoInfo._CONS_.RETURN_TYPE&&i.returnCount+i.rejectReturnCount>0)||(a.calType==SoInfo._CONS_.EXCHANGE_TYPE&&i.exchangeCount+i.rejectExchangeCount>0)){h=h+"<button  type='button' class='btn btn-sm btn-outline btn-primary applyRecords'   style='margin: 0px 3px 0px 0px;'    value='"+i.id+"' >查看</button>";
}if(h==""){if(a.calType==SoInfo._CONS_.RETURN_TYPE){h=h+"<span class='label label-primary'>已申请换货</span>";}else{h=h+"<span class='label label-primary'>已申请退货</span>";
}}return h;}}],footerrow:true,gridComplete:function(){var f=a.footerData();if(a.otherFunc!=null){a.otherFunc(f);}var h=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getDataIDs");
for(var g=0;g<h.length;g++){if(h[g]!="total"){$(SoItemList._CONS_.GR_lIST_ID).editRow(h[g]);}}},});},reloadListJqgrid:function(f){var e={};if(params&&jQuery.type(params)=="string"){params=decodeURIComponent(params,true);
var b=params.split("&");if(b.length){for(var c=0;c<b.length;c++){var d=b[c].split("=");if(d.length==2&&d[1]){e[d[0]]=d[1];}}}}else{e=params;}var a=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getGridParam","postData");
$.extend(a,{datastr:f});$(SoItemList._CONS_.GR_lIST_ID).jqGrid("setGridParam",{search:true}).trigger("reloadGrid",[{page:1}]);},footerData:function(){var c=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getCol","totalAmount",true,"sum");
var b=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("getCol","count",true,"sum");$(SoItemList._CONS_.GR_lIST_ID).jqGrid("footerData","set",{prodPic:"总计:",countShow:b,totalAmount:c});
var a=$(SoItemList._CONS_.GR_lIST_ID).jqGrid("footerData","get");return a;},_initJqgrid:function(e){var a=this;var d=[];if(e){if(typeof e.data!=undefined&&e.data!=null&&e.data.length){d=e.data;
}}var c="元";if("point"==e.soType){c="积分";}if(d!=null&&d.length>0){for(var b=0;b<d.length;b++){d[b].countShow=d[b].count;d[b].spDiscoutShow=d[b].spDiscout;
d[b].spCommentShow=d[b].spComment;d[b].totalAmount=parseFloat(d[b].salesPrice)*parseInt(d[b].count)-parseFloat(d[b].spDiscout);}}$("#soItemDiv").empty().append("<table id='soItemGrid'></table>");
$.jgrid.defaults.styleUI="Bootstrap";$(SoItemList._CONS_.GRID).jqGrid({datatype:"jsonstring",datastr:d,width:$("#soItemDiv").width(),height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["产品图片","产品ID","产品SKU ID","产品SKU编码","产品名称","原价("+c+")","数量",],colModel:[{name:"prodPic",sortable:false,width:100,formatter:function(f,i,j){var h="<img style='display: inline; width:35px;' ";
if(j.prodPic=="总计:"){return j.prodPic;}else{if(j.prodPic!=""&&j.prodPic!=null){h=h+" urlval='"+j.prodPic+"' ";var g={url:j.prodPic,name:"",id:""};h=h+" src='"+ImageUtils.getUrl(g)+"' ";
}else{h=h+" src='"+ctx+"/img/jt/nophoto.png' ";h=h+" urlval='' ";}}h+=" >";return h;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:200},{name:"salesPrice",sortable:false,width:100,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"countShow",sortable:false,align:"right",classes:"test",width:120}],});
},genEditSoItemGrid:function(d){var a=this;var c=[];if(d){if(typeof d.data!=undefined&&d.data!=null&&d.data.length){c=d.data;}}var b="元";if("point"==d.soType){b="积分";
}$("#editSoItemGridDiv").empty().append("<table id='editSoItemGrid'></table>");$.jgrid.defaults.styleUI="Bootstrap";$(SoItemList._CONS_.EDIT_GRID).jqGrid({datatype:"jsonstring",datastr:c,width:800,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["产品图片","产品ID","产品SKU ID","产品SKU编码","产品名称","原价("+b+")","操作"],colModel:[{name:"prodPic",sortable:false,width:120,formatter:function(e,h,i){var g="<img style='display: inline; width:35px;' ";
if(i.prodPic=="总计:"){return i.prodPic;}else{if(i.prodPic!=""&&i.prodPic!=null){g=g+" urlval='"+i.prodPic+"' ";var f={url:i.prodPic,name:"",id:""};g=g+" src='"+ImageUtils.getUrl(f)+"' ";
}else{g=g+" src='"+ctx+"/img/jt/nophoto.png' ";g=g+" urlval='' ";}}g+=" >";return g;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:200},{name:"salesPrice",sortable:false,width:100,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"},{name:"button",sortable:false,align:"center",width:120,formatter:function(e,f,h){var g="<button  type='button'   class='btn btn-primary changeSku'   style='margin: 0px 2px 0px 0px;'    value='"+h.id+"' >更换</button>";
return g;}}],});},addSoItem2Grid:function(b){var a=this;$(SoItemList._CONS_.EDIT_GRID).empty();$(SoItemList._CONS_.EDIT_GRID).jqGrid("addRowData","tmpSoItem",b,"last");
},genExchangeSoItemGrid:function(d){var a=this;var c=[];if(d){if(typeof d.data!=undefined&&d.data!=null&&d.data.length){c=d.data;}}var b="元";if("point"==d.soType){b="积分";
}$("#exchangeSoItemGridDiv").empty().append("<table id='exchangeSoItemGrid'></table>");$.jgrid.defaults.styleUI="Bootstrap";$(SoItemList._CONS_.EXCHANGE_GRID).jqGrid({datatype:"jsonstring",datastr:c,width:800,height:"auto",shrinkToFit:true,multiselect:false,sortable:false,rownumbers:true,colNames:["产品图片","产品ID","产品SKU ID","产品SKU编码","产品名称","原价("+b+")"],colModel:[{name:"prodPic",sortable:false,width:150,formatter:function(e,h,i){var g="<img style='display: inline; width:35px;' ";
if(i.prodPic=="总计:"){return i.prodPic;}else{if(i.prodPic!=""&&i.prodPic!=null){g=g+" urlval='"+i.prodPic+"' ";var f={url:i.prodPic,name:"",id:""};g=g+" src='"+ImageUtils.getUrl(f)+"' ";
}else{g=g+" src='"+ctx+"/img/jt/nophoto.png' ";g=g+" urlval='' ";}}g+=" >";return g;}},{name:"prodId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuId",sortable:false,width:120,hidedlg:true,hidden:true},{name:"skuKey",sortable:false,width:120,hidedlg:true,hidden:true},{name:"prodName",sortable:false,width:200},{name:"salesPrice",sortable:false,width:150,align:"right",sorttype:"float",classes:"test",formatter:"number",summaryType:"sum"}],});
}};function ExchangeEntityComfirm(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();this.exchangeEntityBase.hadInit=false;
}ExchangeEntityComfirm._CONS_={GRID:"#exchangeEntityComfirmGrid",PAGER:"#exchangeEntityComfirmPager"};ExchangeEntityComfirm.prototype={init:function(b){var a={grid:ExchangeEntityComfirm._CONS_.GRID,pager:ExchangeEntityComfirm._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityComfirmGrid_record",listParams:"Q__S__EQ__entity.status_=awaiting",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},reloadJqgrid:function(b){var a={grid:ExchangeEntityComfirm._CONS_.GRID,pager:ExchangeEntityComfirm._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.comfirm")){ButtonUtils.enableBtn("exchangeEntityComfirm");}if(ResUtils.canShow("exchangeEntity.button.comfirmEdit")){ButtonUtils.enableBtn("comfirmEdit");
}if(ResUtils.canShow("exchangeEntity.button.comfirmDetail")){ButtonUtils.enableBtn("comfirmDetail");}}else{ButtonUtils.disableBtn("comfirmEdit");ButtonUtils.disableBtn("exchangeEntityComfirm");
ButtonUtils.disableBtn("comfirmDetail");}}};function ExchangeEntityReceive(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityBase.hadInit=true;}ExchangeEntityReceive._CONS_={GRID:"#exchangeEntityReceiveGrid",PAGER:"#exchangeEntityReceivePager"};ExchangeEntityReceive.prototype={init:function(b){var a={grid:ExchangeEntityReceive._CONS_.GRID,pager:ExchangeEntityReceive._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityReceiveGrid_record",listParams:"Q__S__EQ__entity.status_=comfirm",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},reloadJqgrid:function(b){var a={grid:ExchangeEntityReceive._CONS_.GRID,pager:ExchangeEntityReceive._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.receive")){ButtonUtils.enableBtn("exchangeEntityReceive");}if(ResUtils.canShow("exchangeEntity.button.receiveEdit")){ButtonUtils.enableBtn("receiveEdit");
}if(ResUtils.canShow("exchangeEntity.button.receiveDetail")){ButtonUtils.enableBtn("receiveDetail");}}else{ButtonUtils.disableBtn("receiveEdit");ButtonUtils.disableBtn("exchangeEntityReceive");
ButtonUtils.disableBtn("receiveDetail");}}};function ExchangeEntityExchange(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityBase.hadInit=true;}ExchangeEntityExchange._CONS_={SAVE_ADD_URL:ctx+"/ec/ret/exchangeEntity/exchangeSaveAdd.htm",GRID:"#exchangeEntityExchangeGrid",PAGER:"#exchangeEntityExchangePager",EXCHANGE_ADD_FORM:"exchangeAddForm"};
ExchangeEntityExchange.prototype={init:function(b){var a={grid:ExchangeEntityExchange._CONS_.GRID,pager:ExchangeEntityExchange._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityExchangeGrid_record",listParams:"Q__S__IN__entity.status_=comfirm_direct,receive",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);this._bindEventHander();}else{this.reloadJqgrid(b);}},_bindEventHander:function(){var a=this;
var b=$("#"+ExchangeEntityExchange._CONS_.EXCHANGE_ADD_FORM);$(document).on("click",".changeSku",function(){if(b.find("[id=initStoreId]").val()==""||b.find("[id=initStoreId]").val()==null){DialogUtils.error(msgCode.WARING,"请先选择仓库");
return false;}SelectProdService.selectSku({storeId:b.find("[id=initStoreId]").val(),isMultiple:1,canSale:"y",hasStock:"y",fn:function(c){for(var d=0;d<c.length;
d++){a.exchangeEntityBase.soItemList.addSoItem2Grid({prodId:c[d].prodId,prodName:c[d].prodName,prodPic:c[d].imgUrl,skuId:c[d].skuId,skuKey:c[d].skuCode,isMain:"y",maindId:"",salesPrice:c[d].price});
}}});});$(document).on("change","[name=exAmount]",function(){if($(this).val()<0){$(this).val(0);}});$(document).on("change","[name=exCount]",function(){if($(this).val()<1){$(this).val(1);
}});$(document).on("click",".addrli",function(){$(".addrli").hide();$(this).show();});$(document).on("click",".showAddrList",function(){$(".addrli").show();
});$(document).on("click",".addAddr",function(){var c=new ShopAddrOpt();c.init({csId:$("input[name=csId]").val(),callBack:function(e){$(".addrli").hide();
var d=[];d.push(e);$(".addrDiv").append(a._addAddrStrLine(a,d));$(".addrDiv li:last-child").show();if($(".addrDiv li").length>1){$(".showAddrList").show();
}else{$(".showAddrList").hide();}}});});$(document).on("click",".edit-addr",function(){var f=new ShopAddrOpt();var e=$(this).parent().parent().prev();var c=$(this).parent().parent().next();
var d=$(this).parent().parent();f.init({addrId:$(this).parent().attr("id"),csId:$("input[name=csId]").val(),callBack:function(h){$(".addrli").hide();var g=[];
g.push(h);d.remove();if(e.length>0){e.after(a._addAddrStrLine(a,g));e.next().show();}else{if(c.length>0){c.before(a._addAddrStrLine(a,g));c.prev().show();
}else{$(".addrDiv").append(a._addAddrStrLine(a,g));$(".addrDiv li:last-child").show();}}}});});$(document).on("change","[name=financeType]",function(){var c=$(this).val();
if("noChange"==c){b.find("[name=exAmount]").val(0).attr("readonly",true);}else{if("pay"==c){b.find("[name=exAmount]").attr("readonly",false);b.find("[id=companyAccountDiv]").show();
b.find("[id=receiptAccountDiv]").hide();}else{if("refund"==c){b.find("[name=exAmount]").attr("readonly",false);b.find("[id=companyAccountDiv]").hide();
b.find("[id=receiptAccountDiv]").show();}}}});},reloadJqgrid:function(b){var a={grid:ExchangeEntityExchange._CONS_.GRID,pager:ExchangeEntityExchange._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.exchange")){ButtonUtils.enableBtn("exchangeEntityExchange");}if(ResUtils.canShow("exchangeEntity.button.exchangeEdit")){ButtonUtils.enableBtn("exchangeEdit");
}if(ResUtils.canShow("exchangeEntity.button.exchangeDetail")){ButtonUtils.enableBtn("exchangeDetail");}}else{ButtonUtils.disableBtn("exchangeEdit");ButtonUtils.disableBtn("exchangeEntityExchange");
ButtonUtils.disableBtn("exchangeDetail");}},openEditDialog:function(b){var a=this;a.layerIndex=layer.open({type:1,title:"生成换货单",maxmin:true,shadeClose:false,btn:["确定","关闭"],area:["980px","580px"],content:$("#exchangePage"),success:function(c,d){},yes:function(d,c){if($("#"+ExchangeEntityExchange._CONS_.EXCHANGE_ADD_FORM).valid()){b();
layer.close(a.layerIndex);}}});},genAddrContainer:function(c,a){if(c&&c.length>0){var d=new StringBuffer();for(var b=0;b<c.length;b++){if(b==0){d.append("<li class='addrli col-sm-9' attr-id='").append(c[b].id).append("' style='list-style-type:none;position:relative;'>");
}else{d.append("<li class='addrli col-sm-9' attr-id='").append(c[b].id).append("' style='list-style-type:none; display:none;'>");}d.append("<div class='contact-box-line' id='").append(c[b].id).append("'>");
if(c[b].isSnapshot=="n"){d.append("<button type='button' class='glyphicon glyphicon-edit edit-addr' title='编辑地址' style='margin-right:38px;color:#18a689;'></button>");
}d.append(" <h3 style='margin-bottom:5px;'><strong>").append(c[b].name).append("</strong><span  style='font-size: 13px;'>&nbsp;").append("</span></h3>").append("<p  style='margin-bottom:5px;'><i class='fa fa-map-marker'></i>").append(c[b].prName).append(c[b].ciName).append(c[b].arName).append(ResUtils.canShow("soEntity.button.viewAddrBtn")?c[b].addr:MaskPhoneNum.maskAddr(c[b].addr)).append("&nbsp;&nbsp;").append(c[b].zipcode).append("</p>").append("<address style='margin-bottom:5px;'><strong><abbr title='Phone'>手机号码:</abbr> (+86)").append(MaskPhoneNum.getMaskPhoneNum(c[b].mobile)).append("</strong></address>").append(" <b style='background: transparent url(\"").append(ctx).append("/img/jt/selected-icon.png\") no-repeat scroll 0% 0%;'></b><div class='clearfix'></div></div></li>");
}$("#exchangeAddForm").find("[id=addrContainer]").append(d.toString());}},reInitAddForm:function(){var d=this;$("#exchangeAddForm").find("[name=exCount]").val(1);
$("#exchangeAddForm").find("[name=financeType]").val("pay");$("#exchangeAddForm").find("[name=exAmount]").val(0);$("#exchangeAddForm").find("[name=payType]").val("alipay");
$("#exchangeAddForm").find("[name=receiptAccount]").val("");var c=$("#exchangeAddForm").find("[id=initStoreId]").val();var e=JSON.parse($("#exchangeAddForm").find("[id=initSoItemJson]").val());
var b=$("#exchangeAddForm").find("[id=initAddrId]").val();var a=$("#exchangeAddForm .addrDetailLi");$.each(a,function(g,f){$(this).removeClass("contact-box-selected");
if($(this).attr("attr-id")==b){$(this).addClass("contact-box-selected");}});$("#exchangeAddForm").find("[id=storeIdContainer]").val(c);d.exchangeEntityBase.soItemList.addSoItem2Grid(e);
},fillInitData:function(a){$("#exchangeAddForm").find("[id=initSoItemJson]").val(JSON.stringify(a.soItemVos[0]));$("#exchangeAddForm").find("[id=initStoreId]").val(a.storeId);
$("#exchangeAddForm").find("[id=initAddrId]").val(a.soShipPos[0].addrId);},_addAddrStrLine:function(a,c){var d=new StringBuffer();for(var b=0;b<c.length;
b++){if(c[b].isSnapshot=="n"){d.append("<li class='addrli col-sm-9' attr-id='").append(c[b].id).append("' style='list-style-type:none;position:relative; ");
if((c[b].isDefault=="y"||c.length==1&&c[b].isDefault=="n")){$("input[name=addrId]").val(c[b].id);d.append("'>");}else{d.append("display:none;' idval=''>");
}d.append("<div class='contact-box-line");d.append("' id='").append(c[b].id).append("'>");d.append("<button type='button' class='glyphicon glyphicon-edit edit-addr' title='编辑地址' style='margin-right:38px;color:#18a689;'></button>");
d.append(" <h3 style='margin-bottom:5px;'><strong>").append(c[b].name).append("</strong><span  style='font-size: 13px;'>&nbsp;").append(c.title).append("</span></h3>").append("<p  style='margin-bottom:5px;'><i class='fa fa-map-marker'></i>").append(c[b].prName).append(c[b].ciName).append(c[b].arName).append(c[b].toName).append(ResUtils.canShow("soEntity.button.viewAddrBtn")?c[b].addr:MaskPhoneNum.maskAddr(c[b].addr)).append("<br/>").append(c[b].zipcode).append("</p>").append("<address style='margin-bottom:5px;'><strong><abbr title='Phone'>手机号码:</abbr> (+86)").append(c[b].mobile).append("</strong></address>").append(" <b style='background: transparent url(\"").append(ctx).append("/img/jt/selected-icon.png\") no-repeat scroll 0% 0%;'></b><div class='clearfix'></div></div></li>");
}}return d.toString();},};function ExchangeEntityExchangeing(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();this.exchangeEntityBase.hadInit=true;
}ExchangeEntityExchangeing._CONS_={GRID:"#exchangeEntityExchangeingGrid",PAGER:"#exchangeEntityExchangeingPager"};ExchangeEntityExchangeing.prototype={init:function(b){var a={grid:ExchangeEntityExchangeing._CONS_.GRID,pager:ExchangeEntityExchangeing._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityExchangeingGrid_record",listParams:"Q__S__EQ__entity.status_=exchange",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.EXCHANGEING_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this._bindEventHander();this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},_bindEventHander:function(){$(document).on("click","[name=financeType]",function(){});
},reloadJqgrid:function(b){var a={grid:ExchangeEntityExchangeing._CONS_.GRID,pager:ExchangeEntityExchangeing._CONS_.PAGER,searchParam:b};this.exchangeEntityBase.reloadJqgrid(a);
},onSelectRow:function(b,a){selectedId=$(ExchangeEntityExchangeing._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.exchangeingDetail")){ButtonUtils.enableBtn("exchangeingDetail");
}}else{ButtonUtils.disableBtn("exchangeingDetail");}},initBillForm:function(b){var a=this;$("#exchangeBillTabLi").removeAttr("style");$("#exchangeBillTabLi").show();
$("#exchangeBillForm").find("[name=exSno]").val(b.exSno);$("#exchangeBillForm").find("[name=exCount]").val(b.exCount);$("#exchangeBillForm").find("[name=financeType]").val(b.financeType);
$("#exchangeBillForm").find("[name=exAmount]").val(b.exAmount);if(b.financeBillPo){$("#exchangeBillForm").find("[id=financeBillDiv]").show();$("#exchangeBillForm").find("[name=payType]").val(b.financeBillPo.payType);
$("#exchangeBillForm").find("[name=receiptAccount]").val(b.financeBillPo.receiptAccount);$("#exchangeBillForm").find("[name=statusName]").val(b.financeBillPo.statusName);
}else{$("#exchangeBillForm").find("[id=financeBillDiv]").hide();}a.genAddrContainer(b.exSoInfoVo.soShipPos[0].partyAddrPo);},genAddrContainer:function(a){var b=new StringBuffer();
b.append("<li class='addrli' style='list-style-type:none;'>");b.append("<div class='contact-box-line' value='").append(a.id).append("'  style='padding: 10px; margin-bottom: 10px;margin-right:5px;'>");
b.append(" <h3 style='margin-bottom:5px;'><strong>").append(a.name).append("</strong><span  style='font-size: 13px;'>&nbsp;").append("</span></h3>").append("<p  style='margin-bottom:5px;'><i class='fa fa-map-marker'></i>").append(a.prName).append(a.ciName).append(a.arName).append(ResUtils.canShow("soEntity.button.viewAddrBtn")?a.addr:MaskPhoneNum.maskAddr(a.addr)).append("&nbsp;&nbsp;").append(a.zipcode).append("</p>").append("<address style='margin-bottom:5px;'><strong><abbr title='Phone'>手机号码:</abbr> (+86)").append(MaskPhoneNum.getMaskPhoneNum(a.mobile)).append("</strong></address>").append(" <b style='background: transparent url(\"").append(ctx).append("/img/jt/selected-icon.png\") no-repeat scroll 0% 0%;'></b><div class='clearfix'></div></div></li>");
$("#exchangeBillForm").find("[id=addrDiv]").empty().append(b.toString());},};function ExchangeEntityComplete(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityBase.hadInit=true;}ExchangeEntityComplete._CONS_={GRID:"#exchangeEntityCompleteGrid",PAGER:"#exchangeEntityCompletePager"};ExchangeEntityComplete.prototype={init:function(b){var a={grid:ExchangeEntityComplete._CONS_.GRID,pager:ExchangeEntityComplete._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityCompleteGrid_record",listParams:"Q__S__EQ__entity.status_=complete",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.COMPLETE_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},reloadJqgrid:function(b){var a={grid:ExchangeEntityComplete._CONS_.GRID,pager:ExchangeEntityComplete._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityComplete._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.completeDetail")){ButtonUtils.enableBtn("completeDetail");}}else{ButtonUtils.disableBtn("completeDetail");
}}};function ExchangeEntityReject(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();this.exchangeEntityBase.hadInit=true;
}ExchangeEntityReject._CONS_={GRID:"#exchangeEntityRejectGrid",PAGER:"#exchangeEntityRejectPager"};ExchangeEntityReject.prototype={init:function(b){var a={grid:ExchangeEntityReject._CONS_.GRID,pager:ExchangeEntityReject._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityRejectGrid_record",listParams:"Q__S__EQ__entity.status_=reject",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.REJECT_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},reloadJqgrid:function(b){var a={grid:ExchangeEntityReject._CONS_.GRID,pager:ExchangeEntityReject._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityReject._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.rejectDetail")){ButtonUtils.enableBtn("rejectDetail");
}}else{ButtonUtils.disableBtn("rejectDetail");}}};function ExchangeEntityNotReceive(){this.hadInit=false;this.isEdit=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityBase.hadInit=true;}ExchangeEntityNotReceive._CONS_={GRID:"#exchangeEntityNotReceiveGrid",PAGER:"#exchangeEntityNotReceivePager"};ExchangeEntityNotReceive.prototype={init:function(b){var a={grid:ExchangeEntityNotReceive._CONS_.GRID,pager:ExchangeEntityNotReceive._CONS_.PAGER,gridRecordsSpan:"#exchangeEntityNotReceiveGrid_record",listParams:"Q__S__EQ__entity.status_=not_receive",widthElement:".wait_submit_wrapper",onSelectRow:this.onSelectRow,type:ExchangeEntityBase._CONS_.NOT_RECEIVE_TAB_TYPE};
if(!this.hadInit){this.hadInit=true;this.exchangeEntityBase.init(a);}else{this.reloadJqgrid(b);}},reloadJqgrid:function(b){var a={grid:ExchangeEntityNotReceive._CONS_.GRID,pager:ExchangeEntityNotReceive._CONS_.PAGER,searchParam:b};
this.exchangeEntityBase.reloadJqgrid(a);},onSelectRow:function(b,a){selectedId=$(ExchangeEntityNotReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(selectedId.length==1){if(ResUtils.canShow("exchangeEntity.button.notReceiveDetail")){ButtonUtils.enableBtn("notReceiveDetail");}}else{ButtonUtils.disableBtn("notReceiveDetail");
}}};var StoreUtils={loadStores:function(f,a,e,c){var b=this;var d={selectedStore:f,container:a,isSale:e,notShowStore:c};b.loadData(d);},loadData:function(e){var b=this;
var a=ctx+"/ec/stock/stStore/listStores.htm";var d=e.isSale;if(d){a+="?isSale=y";}var c=window.sessionStorage.getItem("loacalstores"+(d?"isSale":""));if(c&&c!=null&&c!=""){b._apendData(e,JSON.parse(c));
}else{FormUtils.loadData(a,function(f){window.sessionStorage.setItem("loacalstores"+(d?"isSale":""),JSON.stringify(f));b._apendData(e,f);});}},_apendData:function(d,j){var k=d.callBackFunc?d.callBackFunc:null;
var f=d.selectedStore?d.selectedStore:null;var a=d.container;var g=d.notShowStore?d.notShowStore:null;var b=isManyStore?isManyStore:"y";var h=new StringBuffer();
if(b=="y"){h.append("<option value=''>请选择仓库</option>");}for(var e=0;e<j.length;e++){if(g&&j[e].id==g){continue;}if(b=="n"){if(j[e].isDefault=="y"){h.append("<option selected='selected' value='"+j[e].id+"'>"+j[e].name+"</option>");
}}else{if(j[e].id==f){h.append("<option selected='selected' value='"+j[e].id+"'>"+j[e].name+"</option>");}else{h.append("<option value='"+j[e].id+"'>"+j[e].name+"</option>");
}}}var c=$("#"+a);if(!c.length){c=$("."+a);}c.empty().append(h.toString());if(b=="n"){c.trigger("change");}if(k&&typeof(k)=="function"){k(j);}},loadSimpleStores:function(a){return StoreUtils.loadStores("",a.container);
}};var SelectProdService={selectSku:function(o){var n=o&&o.storeId;var f=o.isMultiple;var k=o.type;var m=o.hasStock;var e=o.canSale;var b=o.hideCanSale;
var j=o.isSale;var d=o.limitProdCate;var i=o.priceType;var h=o.userId;var l=o.showNotOnSale;var g=o.filterSeries;var c=o.agentId;if(!m){m="n";}if(!k){k="product";
}if(!n){n="";}if(!b){b="n";}if(!d){d="n";}if(!j){j="n";}if(!i){i="";}if(!e){e="n";}if(!l){l="n";}if(!c){c="";}var a=ctx+"/ec/product/prodEntity/selectSku.htm?";
a+="storeId="+n;a+="&isMultiple="+f;a+="&type="+k;a+="&hasStock="+m;a+="&hideCanSale="+b;a+="&limitProdCate="+d;a+="&priceType="+i;a+="&canSale="+e;a+="&isSale="+j;
a+="&userId="+h;a+="&showNotOnSale="+l;a+="&filterSeries="+g;a+="&agentId="+c;layer.open({type:2,title:"选择商品",maxmin:true,shadeClose:true,btn:["确定","取消"],area:["95%","95%"],scrollbar:false,maxmin:false,content:a,yes:function(q,p){var s=layer.getChildFrame("body",q);
var r=$("#selectedRowData",s).val();if(r&&r.length){layer.close(q);if(o.fn){o.fn(JSON.parse(r));}}else{DialogUtils.error("警告","请选择商品！或者点击取消",s);}},end:function(){if(o.end){o.end();
}}});},selectProd:function(a){var b=a.isMultiple;layer.open({type:2,title:"选择商品",shadeClose:true,btn:["确定","取消"],area:["80%","80%"],scrollbar:false,content:ctx+"/ec/product/prodEntity/selectProd.htm?isMultiple="+b,yes:function(e,c){var j=layer.getChildFrame("body",e);
var d=$("#prodEntityGrid",j).jqGrid("getGridParam","selarrrow");if(d){var h=[];for(var f=0;f<d.length;f++){var g=$("#prodEntityGrid",j).jqGrid("getRowData",d[f]);
g.prodId=d[f];g.prodName=g.name;h.push(g);}layer.close(e);if(a.fn){a.fn(h);}}}});}};function CascadeCate(b,a,c){if(!(this instanceof CascadeCate)){return new CascadeCate(b,a,c);
}if(b==null||b==undefined||!b){throw new Error("cateType不能为空");}if(a==null||typeof a==undefined||!a){throw new Error("containerId不能为空");}this.cateType=b;
this.topCateKey="";this.loadedTopCateFlag=false;this.hadBindChangeHandler=false;this.containerId="#"+a;this.selectLabelList=c;this.selectedOptions=[];this.cacheMap=new Map();
}CascadeCate.prototype={bindEventHandler:function(){var a=this;if(a.hadBindChangeHandler){return;}a.hadBindChangeHandler=true;$(a.containerId).off("change");
$(a.containerId).on("change","select",function(){var b=$(this).val();var c=$(this).parent().nextAll().remove();if(b){a.loadCate(b);}});},init:function(){this.bindEventHandler();
$(this.containerId).empty().append("<label class='col-sm-1 control-label'>所在地区</label>");if(this.selectedOptions.length==0){this.loadCate("");}else{this.loadCascade();
}},setSelectedOptions:function(a){this.selectedOptions=[];this.selectedOptions=this.selectedOptions.concat(a);},getCascadeParams:function(){var a=[];$(this.containerId).find("select").each(function(){var c=$(this).val();
var b=$(this).find("option[value='"+c+"']");a.push({id:b.attr("idValue"),value:c,name:b.text()});});return a;},checkCascadeParamsHaveVal:function(){var a=true;
$(this.containerId).find("select").each(function(){var b=$(this).val();if(b==null||b==""){a=false;}});return a;},loadCascade:function(){this._recurLoadCate(0);
},_recurLoadCate:function(c){var a=this;if(c<a.selectedOptions.length){var b="";if(c!=0){b=a.selectedOptions[c-1];}a.loadCate(b,function(){c++;if(c<a.selectedOptions.length){a._recurLoadCate(c);
}else{var d=0;$(a.containerId).find("select").each(function(){$(this).find("option[value='"+a.selectedOptions[d++]+"']").attr("selected","selected");});
}});}},loadCate:function(d,e){var a=this;var c=this.cacheMap.get(d);if(c!=null){$(a.containerId).append(c);if(e!=null){e();}return;}var b=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm";
b+="?cateType="+a.cateType+"&parentKey="+d;FormUtils.loadData(b,function(j){if(j.success){if(j.msg!=null&&j.msg!=""){var k=new StringBuffer();var h=JSON.parse(j.msg);
if(h&&h.length>0){var f=$(a.containerId).find("select").length;if(f==0){k.append("<div class='col-sm-2' style='display:none;'>");}else{k.append("<div class='col-sm-2' >");
}k.append("<select class='form-control'>");k.append("<option value=''>请选择</option>");for(var g=0;g<h.length;g++){a.topCateKey=h[g].value;if(f==0&&g==0){k.append("<option idValue='"+h[g].id+"' value='"+h[g].value+"'  selected=selected>"+h[g].name+"</option>");
}else{k.append("<option idValue='"+h[g].id+"' value='"+h[g].value+"'>"+h[g].name+"</option>");}}k.append("</select>");k.append("</div>");$(a.containerId).append(k.toString());
if(a.selectedOptions.length==0&&!a.loadedTopCateFlag){a.loadedTopCateFlag=true;a.loadCate(a.topCateKey);}a.cacheMap.put(d,k.toString());if(e!=null){console.log(e);
e();}}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}};var MaskPhoneNum={getMaskPhoneNum:function(a){if(a){if(a.length>=11){return a.substring(0,3)+"******"+a.substring(9,a.length);
}else{if(a.length>6&&a.length<11){return a.substring(0,1)+"******"+a.substring(7,a.length);}else{if(a.length>3&&a.length<=6){return a.substring(0,1)+"***"+a.substring(4,a.length);
}}}}return"";},maskEmail:function(a){var c=new StringBuffer();if(a){var b=a.indexOf("@");if(b>2){c.append(a.substring(0,b-2)).append("**").append(a.substring(b));
}else{if(b>=1){c.append(a.substring(0,b-1)).append("*").append(a.substring(b));}}}return c.toString();},maskAddr:function(b){var a=new StringBuffer();if(b){if(b.length>25){b=b.replace(b.substring(7,15),"*****");
}else{if(10<b.length<=25){b=b.replace(b.substring(6,13),"*****");}else{if(0<b.length<=10){b=b.replace(b.substring(5,6),"****");}}}}return b;},maskDesc:function(a){if(a){a=a.replace(" ","");
a=a.trim().replaceAll("\\d{11}","***********");}return a;}};function AddressService(a){this.container=a;this.isHideCountry=false;}AddressService._CONS_={CATE_TYPE_KEY:"AddressCateType",ROOT_KEY:"AddressCateType-root"};
AddressService.prototype={init:function(b,a){if(!b||!b.isNotRequired){$("#"+this.container).empty().append("<div class='col-sm-12'><label class='control-label col-sm-2'>所在地<span style='color:red;'>*</span></label><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.isSelect&&b.isSelect=="y"){$("#"+this.container).empty().append("<div class='col-sm-12'><div class='col-sm-10 container' style='padding-left:0px !important;'></div></div>");
}else{if(b.rowFit&&b.rowFit=="y"){$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-11 container' style='padding-left:0px !important;'></div>");
}else{$("#"+this.container).empty().append("<label class='control-label col-sm-1'>所在地</label><div class='col-sm-6 container'></div></div>");}}}this.params=b;
this._bindEventHandler();if(b.isHideCountry){self.isHideCountry=b.isHideCountry;this._loadProvinces("ChinaCityCateType-root");}else{this._loadCountrys();
}if(a&&typeof(a)=="function"){a();}},getAddress:function(){var e=$("#"+this.container).find('select[name="country_"]').val();var a=$("#"+this.container).find('select[name="province_"]').val();
var d=$("#"+this.container).find('select[name="city_"]').val();var c=$("#"+this.container).find('select[name="area_"]').val();var b=$("#"+this.container).find("select[name='town_']").val();
return{country:e,countryName:$("#"+this.container).find('select[name="country_"]').find('option[value="'+e+'"]').text(),province:a,provinceName:$("#"+this.container).find('select[name="province_"]').find('option[value="'+a+'"]').text(),city:d,cityName:$("#"+this.container).find('select[name="city_"]').find('option[value="'+d+'"]').text(),area:c,areaName:$("#"+this.container).find('select[name="area_"]').find('option[value="'+c+'"]').text(),town:b,townName:b?$("#"+this.container).find("select[name='town_']").find("option[value='"+b+"']").text():"",};
},isValid:function(b){var a=true;$("#"+this.container).find("select").each(function(){var c=$(this).attr("name");var e=$(this).val();if(!e&&c!="town_"){a=false;
var d="";switch(c){case"country_":d="请选择国家";break;case"province_":d="请选择省份";break;case"city_":d="请选择城市";break;case"area_":d="请选择区县";break;}DialogUtils.error(msgCode.ERROR,d,b);
return false;}});return a;},_loadCountrys:function(){this._loadCates(AddressService._CONS_.ROOT_KEY,"country_");},_loadProvinces:function(a){this._loadCates(a,"province_");
},_loadCitys:function(a){this._loadCates(a,"city_");},_loadAreas:function(a){this._loadCates(a,"area_");},_loadTowns:function(a){this._loadCates(a,"town_");
},_loadCates:function(c,d){var a=this;var b=ctx+"/gl/cate/cate/getCateByCateTypeAndParentId.htm";b+="?cateType="+AddressService._CONS_.CATE_TYPE_KEY+"&parentKey="+c;
FormUtils.loadData(b,function(h){if(h.success){if(h.msg!=null&&h.msg!=""){var j=new StringBuffer();var g=JSON.parse(h.msg);if(g&&g.length>0){j.append("<div class='col-sm-2' style='padding-left:0px !important;'>");
j.append("<select class='form-control' name='"+d+"'>");j.append("<option value=''>请选择</option>");for(var e=0;e<g.length;e++){var f="";if(a.params){switch(d){case"country_":if(g[e].value==a.params.country){f="selected='selected'";
}break;case"province_":if(g[e].value==a.params.province){f="selected='selected'";}break;case"city_":if(g[e].value==a.params.city){f="selected='selected'";
}break;case"area_":if(g[e].value==a.params.area){f="selected='selected'";}break;case"town_":if(g[e].value==a.params.town){f="selected='selected'";}break;
}}j.append("<option "+f+" idValue='"+g[e].id+"' value='"+g[e].value+"'>"+g[e].name+"</option>");}j.append("</select>");j.append("</div>");$("#"+a.container).find(".container").append(j.toString());
if(a.params&&a.params.disabled){$("#"+a.container).find(".container").find("select").attr("disabled","disabled");}if(a.params){switch(d){case"country_":if(a.params.country&&!a.isHideCountry){a._loadProvinces(a.params.country);
}break;case"province_":if(a.params.province){a._loadCitys(a.params.province);}break;case"city_":if(a.params.city){a._loadAreas(a.params.city);}break;case"area_":if(a.params.area){a._loadTowns(a.params.area);
}break;}}}}}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});},_bindEventHandler:function(){var a=this;$("#"+this.container).off("change",'select[name="country_"]');
$("#"+this.container).off("change",'select[name="province_"]');$("#"+this.container).off("change",'select[name="city_"]');$("#"+this.container).off("change","select[name='area_']");
$("#"+this.container).find("select[name='area_']").off("change");$("#"+this.container).on("change",'select[name="country_"]',function(){a.params=null;var b=$(this).val();
if(b){$(this).parent().nextAll().remove();a._loadProvinces(b);}else{$("#"+a.container).find("select[name=province_]").empty().append("<option value=''>请选择</option>");
$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="province_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadCitys(b);}else{$("#"+a.container).find("select[name=city_]").empty().append("<option value=''>请选择</option>");$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");
}$.log("change");});$("#"+this.container).on("change",'select[name="city_"]',function(){a.params=null;var b=$(this).val();if(b){$(this).parent().nextAll().remove();
a._loadAreas(b);}else{$("#"+a.container).find("select[name=area_]").empty().append("<option value=''>请选择</option>");}$.log("change");});$("#"+this.container).on("change","select[name='area_']",function(){a.params=null;
var b=$(this).val();if(b){$(this).parent().nextAll().remove();a._loadTowns(b);}else{$("#"+a.container).find("select[name='town_']").empty().append("<option value=''>请选择</option>");
}$.log("change");});}};function ShopAddrOpt(){this.hadInit=false;this.isEdit=false;this.isExist=false;this.addressService=new AddressService(ShopAddrOpt._CONS_.ADDR_CONTAINER);
this.options={callBack:null,};}ShopAddrOpt._CONS_={ADDR_CONTAINER:"shopAddrOptForm_cateContainer",EDIT_FROM_ID:"partyAddrEdidddddtForm",EDIT_URL:ctx+"/crm/cs/csEntity/addr/addrEditForm.htm",SAVE_URL:ctx+"/crm/cs/csEntity/addr/partyAddrAdd.htm",LISTNUM_BYCSID:ctx+"/crm/cs/csEntity/findPhonesByCsIdNotRepeat.htm",};
ShopAddrOpt.prototype={init:function(a){this._bindEventHander();this._openShopAddrDialog(a);this._bindFormValidation();},_openShopAddrDialog:function(d){var b=$(window).width();
var c=["650px","300px"];if(b<1024){c=["450px","230px"];}var a=this;layer.open({type:1,title:"收货地址处理",maxmin:false,shadeClose:false,btn:["保存","关闭"],skin:"addr-skin",area:c,content:$("."+ShopAddrOpt._CONS_.EDIT_FROM_ID),success:function(e,f){FormUtils.clear("shopAddrOptForm");
$(".addrDetaileDescribe").text("");$("input[id=shopAddrOptForm_types]").val("shipping");$("input[id=shopAddrOptForm_isSnapshot]").val("n");a._loadData(d.csId,d.addrId,d.isCs);
},yes:function(h,g){var f=$("div.partyAddrEdidddddtForm");if($("#shopAddrOptForm").valid()&&a.addressService.isValid(f)){$("textarea[name=addr]").val($("#shopAddrOptForm_addr").val());
if($("#shopAddrOptForm_mobile").val()==0){$("input[name=mobile]").val($("#maskNumber").val());}else{$("input[name=mobile]").val($("#shopAddrOptForm_mobile").val());
}var e=a.addressService.getAddress();$("input[name=coRid]").val(e.country);$("input[name=coName]").val(e.countryName);$("input[name=prRid]").val(e.province);
$("input[name=prName]").val(e.provinceName);$("input[name=ciRid]").val(e.city);$("input[name=ciName]").val(e.cityName);$("input[name=arRid]").val(e.area);
$("input[name=arName]").val(e.areaName);$("input[name=toRid]").val(e.town);$("input[name=toName]").val(e.townName);if($("#shopAddrOptForm_mobile").val()==0){if(!$("#maskNumber").val()){$(".tip").text("号码不能为空！").show();
return;}if(a.isExist){return;}}var i=$("#shopAddrOptForm").serialize();FormUtils.submit(ShopAddrOpt._CONS_.SAVE_URL,i,function(j){if(j.success){if(d.callBack){d.callBack(j.partyAddrPo);
}layer.close(h);}else{DialogUtils.error("失败",j.msg,f);}},function(){DialogUtils.error("错误","后台异常，请稍后重试",f);});}},cancel:function(){$("#shopAddrOptForm").validate().resetForm();
FormUtils.clear("shopAddrOptForm");}});},_loadData:function(d,c,b){var a=this;FormUtils.loadData(ShopAddrOpt._CONS_.EDIT_URL+"?csId="+d+"&addrId="+c,function(h){if(c){$("#shopAddrOptForm_isDefault").val(h.isDefault);
}else{if(h.isHaveDefault=="y"){$("#shopAddrOptForm_isDefault").val("n");}else{$("#shopAddrOptForm_isDefault").val("y");}}$("#shopAddrOptForm_partyId").val(d);
h.types&&$("input[id=shopAddrOptForm_types]").val(h["types"]);h.isSnapshot&&$("input[id=shopAddrOptForm_isSnapshot]").val(h["isSnapshot"]);if(b){h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("csEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}else{h.maskAddr&&$("input[id=shopAddrOptForm_addr]").val(ResUtils.canShow("soEntity.button.viewAddrBtn")?h["maskAddr"]:MaskPhoneNum.maskAddr(h["maskAddr"]));
}h.addr&&$("textarea[name=addr]").val(h["addr"]);h.zipcode&&$("input[id=shopAddrOptForm_zipcode]").val(h["zipcode"]);h.name&&$("input[id=shopAddrOptForm_name]").val(h["name"]);
h.mobile&&$("input[id=mobile]").val(h["mobile"]);h.position&&$("input[id=shopAddrOptForm_position]").val(h["position"]);h.fax&&$("input[id=shopAddrOptForm_fax]").val(h["fax"]);
h.maskEmail&&$("input[id=shopAddrOptForm_email]").val(h["maskEmail"]);h.email&&$("input[name=email]").val(h["email"]);h.im&&$("input[id=shopAddrOptForm_im]").val(h["im"]);
h.createBy&&$("input[id=shopAddrOptForm_createBy]").val(h["createBy"]);h.createTime&&$("input[id=shopAddrOptForm_createTime]").val(h["createTime"]);h.id&&$("input[id=shopAddrOptForm_id]").val(h["id"]);
if(h.maskMobile){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();var f=$("#maskNumber");f.val("");}var g=new StringBuffer();
if(h.maskMobile){g.append("<option value="+h["mobile"]+" selected='selected'>"+h["maskMobile"]+"</option>");}if(h.csPhonePos&&h.csPhonePos.length){if(h.csPhonePos&&h.csPhonePos.length){for(var e=0;
e<h.csPhonePos.length;e++){g.append("<option value="+h.csPhonePos[e].number+">"+h.csPhonePos[e].maskPhone+"["+h.csPhonePos[e].type+"]</option>");}}}g.append("<option class='addNewNum' value='0'>添加新号码</option>");
$("#shopAddrOptForm_mobile").empty().append(g.toString());a.addressService.init({country:h["coRid"]?h["coRid"]:"ChinaCityCateType-root",province:h["prRid"],city:h["ciRid"],area:h["arRid"],town:h["toRid"],});
if($("#shopAddrOptForm_mobile").val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}});},_bindFormValidation:function(){jQuery.validator.addMethod("isPhone",function(c,b){return this.optional(b)||/^(1+\d{10})$/.test(c);
},"手机号码格式错误");var a={rules:{maskAddr:{required:true,maxlength:["1024"]},zipcode:{maxlength:["20"],zipcode:true},fax:{maxlength:["20"]},im:{maxlength:["64"]},name:{required:true,maxlength:["64"]},email:{required:true},maskNumber:{isPhone:true,},position:{maxlength:["64"]}},messages:{}};
FormUtils.bindFormValidation("shopAddrOptForm",a);},_bindEventHander:function(){var a=this;$(document).on("change","#maskNumber",function(){$(".tip").hide();
});$("#shopAddrOptForm").off("click","#shopAddrOptForm_email").on("click","#shopAddrOptForm_email",function(){if($("#shopAddrOptForm_email").val().indexOf("*")>0){$("#shopAddrOptForm_email").val("");
}});$("#shopAddrOptForm_mobile").off("change").on("change",function(){if($(this).val()!=0){$("#newNumberContainer").hide();$(".tip").hide();}else{$("#newNumberContainer").show();
var b=$("#maskNumber");b.val("");}});$("#maskNumber").off("blur").on("blur",function(){var b=$(this).val();if(b&&b.length>=7&&(!a.phonePrefix||a.phonePrefix!=b.substring(0,7))){FormUtils.loadData(ctx+"/crm/cs/csPhoneArea/getArea.htm?phone="+b,function(e){if(e.success){a.phonePrefix=b.substring(0,7);
var d=JSON.parse(e.msg);a.addressService.init({country:"ChinaCityCateType-root",province:d.provinceCateKey,city:d.cityCateKey,area:"",});}});}var c=new CsPhone();
if(b){if(c._checkIsPhone(b)){c.findCsByPhone(b,function(e){if(e&&e.success){var f=JSON.parse(e.msg);var d="号码重复，客户["+f.code+"]已拥有该号码";$(".tip").text(d).show();
a.isExist=true;}else{$(".tip").hide();a.isExist=false;}});}}});$(document).on("change","select[name=country_],select[name=province_],select[name=city_],select[name=area_],select[name=town_]",function(){var b=$("div.partyAddrEdidddddtForm");
var c=b.find("select[name=country_] option:selected").text();if(b.find("select[name=province_]").val()){c+="-"+b.find("select[name=province_] option:selected").text();
}if(b.find("select[name=city_]").val()){c+="-"+b.find("select[name=city_] option:selected").text();}if(b.find("select[name=area_]").val()){c+="-"+b.find("select[name=area_] option:selected").text();
}if(b.find("select[name=town_]").val()){c+="-"+b.find("select[name=town_] option:selected").text();}b.find(".addrDetaileDescribe").text(c);});}};var ShipCompanyUtils={getOptions:function(c){var b=this;
var a=window.sessionStorage.getItem("loacalShipCompany");if(a&&a!=null&&a!=""){b._appendData(c,JSON.parse(a));}else{FormUtils.loadData(ctx+"/ec/ship/shipCompany/allActiveCompany.htm",function(d){window.sessionStorage.setItem("loacalShipCompany",JSON.stringify(d));
b._appendData(c,d);});}},_appendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);if(f.length==0){f=$("select[name='"+c.container+"']");
if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}if(a&&a.length>0){if(c.fn){c.fn(a);
}else{var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].id;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("' hotVar='").append(a[d].isHot).append("' selected='selected'>").append(b).append("</option>");
}else{g.append("<option value='").append(e).append("' hotVar='").append(a[d].isHot).append("'>").append(b).append("</option>");}}f.empty().append(g.toString());
}}if(c.callBack&&typeof c.callBack=="function"){c.callBack();}}};var ShipInfoUtil={getShipStatusName:function(a){var b=a;if("0"==a){b="在途";}else{if("1"==a){b="揽件";
}else{if("2"==a){b="疑难";}else{if("3"==a){b="签收";}else{if("4"==a){b="退签";}else{if("5"==a){b="派件";}else{if("6"==a){b="退回";}else{if("-1"==a){b="查不到快递公司编码";
}}}}}}}}return b;},getLastShipInfo:function(b){var c="";if(b){var a=b.split("<br>");if(a.length>1){c=a[a.length-2];}else{c=a[0];}}return c;}};var FinanceAccountSelect={initSelect:function(c,b,a){$.ajax({type:"GET",url:ctx+"/ec/finance/financeAcount/listPo.htm",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f!=null&&f!=""){var d=document.getElementById(c);
d.options.length=0;for(var e=0;e<f.length;e++){d.options.add(new Option(f[e].account+"("+f[e].name+")",f[e].account));if(f[e].account==b){d.options[d.options.length-1].selected="selected";
}}}if(a){a();}},error:function(d){alert(d);}});},initSelectActived:function(c,b,a){$.ajax({type:"GET",url:ctx+"/ec/finance/financeAcount/listPo.htm?Q__S__EQ__status_=actived",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e!=null&&e!=""){var f=new StringBuffer();
f.append("<option value=''>请选择</option>");for(var d=0;d<e.length;d++){f.append("<option attr-type='"+e[d].accountType+"' value='"+e[d].account+"'");if(e[d].account==b){f.append("selected=selected");
}f.append(">"+e[d].account+"（"+e[d].name+"）"+"</option>");}$("#"+c).empty().append(f.toString());}if(a){a();}},error:function(d){alert(d);}});},initSelectType:function(c,b){var a=ctx+"/ec/finance/financeAcount/listPo.htm?Q__S__EQ__status_=actived";
if(c.accountType){a+="&Q__S__EQ__account_type_="+c.accountType;}$.ajax({type:"GET",url:a,contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){var d=document.getElementById(c.selectId);
d.options.length=0;if(f!=null&&f!=""){for(var e=0;e<f.length;e++){d.options.add(new Option(f[e].account+"("+f[e].name+")",f[e].account));if(f[e].account==c.selectedValue){d.options[d.options.length-1].selected="selected";
}}}if(b){b();}},error:function(d){alert(d);}});},initSelectIsUsed:function(c,b,a){$.ajax({type:"GET",url:ctx+"/ec/finance/financeAcount/listPo.htm",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(f){if(f!=null&&f!=""){var d=document.getElementById(c);
d.options.length=0;for(var e=0;e<f.length;e++){if(f[e].isUsed=="y"){d.options.add(new Option(f[e].name,f[e].account));if(f[e].account==b){d.options[d.options.length-1].selected="selected";
}}}}if(a){a();}},error:function(d){alert(d);}});}};