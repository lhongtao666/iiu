$(function(){var a=new ExchangeEntity();a.init();});function ExchangeEntity(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.exchangeEntityBase=new ExchangeEntityBase();
this.exchangeEntityComfirm=new ExchangeEntityComfirm();this.exchangeEntityReceive=new ExchangeEntityReceive();this.exchangeEntityExchange=new ExchangeEntityExchange();
this.exchangeEntityExchangeing=new ExchangeEntityExchangeing();this.exchangeEntityComplete=new ExchangeEntityComplete();this.exchangeEntityReject=new ExchangeEntityReject();
this.exchangeEntityNotReceive=new ExchangeEntityNotReceive();this.exchangeLog=new ExchangeLog();}ExchangeEntity._CONS_={EDIT_URL:ctx+"/ec/ret/exchangeEntity/edit.htm",DETAIL_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",DELETE_URL:ctx+"/ec/ret/exchangeEntity/delete.htm",SAVE_ADD_URL:ctx+"/ec/ret/exchangeEntity/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/ret/exchangeEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/ret/exchangeEntity/listData.htm",EDIT_FORM_ID:"exchangeEntityForm",GRID:"#exchangeEntityGrid",PAGER:"#exchangeEntityPager"};
ExchangeEntity.prototype={init:function(a){if(!this.hadInit){excWidth=$(".wait_submit_wrapper").width();this.hadInit=true;this._hideNotGrantBtn();this._initTabShow();
this._bindFormValidation();this._bindEventHander();this._initInputAndOption();this.exchangeEntityComfirm.init();this.exchangeEntityReceive.init();this.exchangeEntityExchange.init();
this.exchangeEntityExchangeing.init();this.exchangeEntityComplete.init();this.exchangeEntityReject.init();this.exchangeEntityNotReceive.init();this.exchangeEntityBase.countAllStatus();
if("index"==fromType){this._initTabForReceive();}}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("exchangeEntity.button.comfirm")){$(".exchangeEntityComfirm").hide();
}if(!ResUtils.canShow("exchangeEntity.button.comfirmEdit")){$(".comfirmEdit").hide();}if(!ResUtils.canShow("exchangeEntity.button.comfirmDetail")){$(".comfirmDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.receive")){$(".exchangeEntityReceive").hide();}if(!ResUtils.canShow("exchangeEntity.button.receiveEdit")){$(".receiveEdit").hide();
}if(!ResUtils.canShow("exchangeEntity.button.receiveDetail")){$(".receiveDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.exchange")){$(".exchangeEntityExchange").hide();
}if(!ResUtils.canShow("exchangeEntity.button.exchangeEdit")){$(".exchangeEdit").hide();}if(!ResUtils.canShow("exchangeEntity.button.exchangeDetail")){$(".exchangeDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.exchangeingDetail")){$(".exchangeingDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.completeDetail")){$(".completeDetail").hide();
}if(!ResUtils.canShow("exchangeEntity.button.rejectDetail")){$(".rejectDetail").hide();}if(!ResUtils.canShow("exchangeEntity.button.notReceiveDetail")){$(".notReceiveDetail").hide();
}},_bindEventHander:function(){var a=this;$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".exchangeDetailDiv").on("click","#prevBtn",function(){a.initEditForm(true);});$(".exchangeDetailDiv").on("click","#save",function(){a.exchangeEntityBase._save("",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#comfirm",function(){var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=needReturn]").val();if(b=="N"){DialogUtils.error(msgCode.FAIL_MSG,"请确认等待退货跟是否需要回寄一致");
return;}a.exchangeEntityBase._save("comfirm",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#comfirm_direct",function(){var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=needReturn]").val();
if(b=="Y"){DialogUtils.error(msgCode.FAIL_MSG,"请确认无需退货跟是否需要回寄一致");return;}a.exchangeEntityBase._save("comfirm_direct",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#reject",function(){a.exchangeEntityBase._save("reject",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#receive",function(){a.exchangeEntityBase._save("receive",function(){a.initEditForm(false);
});});$(".exchangeDetailDiv").on("click","#not_receive",function(){a.exchangeEntityBase._save("not_receive",function(){a.initEditForm(false);});});$(".exchangeDetailDiv").on("click","#exchange",function(){a.exchangeEntityBase.exchangeAdd();
});$(".exchangeAddDiv").on("click","#submitExchange",function(){if(a.validExchangeAdd()){a.exchangeEntityBase._save("exchange",function(){a.initEditForm(false);
},ExchangeEntityExchange._CONS_.SAVE_ADD_URL);}});$(".exchangeAddDiv").on("click","#cancelSubmit",function(){a.exchangeEntityExchange.reInitAddForm();a.exchangeEntityBase._showExchangeDetailDiv();
});$("body").on("click",".exchangeEntityComfirm",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initComfirmBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".comfirmEdit",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);
});$("body").on("click",".comfirmDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComfirm._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeEntityReceive",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initReceiveBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".receiveEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".receiveDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeEntityExchange",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initExchangeBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){a.exchangeEntityBase.soItemList.genEditSoItemGrid({data:c.soInfoVo.soItemVos,soType:c.soInfoVo.soType});
StoreUtils.loadStores(c.soInfoVo.storeId,"storeIdContainer");a.exchangeEntityExchange.genAddrContainer(c.addrList,c.soInfoVo.soShipPos[0].addrId);a.exchangeEntityExchange.fillInitData(c.soInfoVo);
});});$("body").on("click",".exchangeEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initEditBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchange._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$("body").on("click",".exchangeingDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityExchangeing._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){if(c.exSoInfoVo){a.exchangeEntityBase.soItemList.genExchangeSoItemGrid({data:c.exSoInfoVo.soItemVos,soType:c.exSoInfoVo.soType});
}if(!(c.exchangeImgPos&&c.exchangeImgPos.length>0)){$("#imgDiv").hide();}$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").show();a.exchangeEntityExchangeing.initBillForm(c);
});});$("body").on("click",".completeDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityComplete._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b,function(c){if(c.exSoInfoVo){a.exchangeEntityBase.soItemList.genExchangeSoItemGrid({data:c.exSoInfoVo.soItemVos,soType:c.exSoInfoVo.soType});
}if(!(c.exchangeImgPos&&c.exchangeImgPos.length>0)){$("#imgDiv").hide();}$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").show();a.exchangeEntityExchangeing.initBillForm(c);
});});$("body").on("click",".rejectDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityReject._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);
return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);a.exchangeEntityBase._edit(b);});$("body").on("click",".notReceiveDetail",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(ExchangeEntityNotReceive._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}b=b[0];}a._initDetailBtn();a.exchangeLog.init(b);
a.exchangeEntityBase._edit(b);});$(".exchangeListDiv").on("click",".listTabli",function(){var c=$(this).attr("attr-type");var b=a._getActiveTab();if(c==b){return;
}if("comfirm"==c){a.exchangeEntityComfirm.init();}if("receive"==c){a.exchangeEntityReceive.init();}if("exchange"==c){a.exchangeEntityExchange.init();}if("exchangeing"==c){a.exchangeEntityExchangeing.init();
}if("complete"==c){a.exchangeEntityComplete.init();}if("reject"==c){a.exchangeEntityReject.init();}if("notReceive"==c){a.exchangeEntityNotReceive.init();
}});$(document).on("click",".exchangeEntitySearch",function(){var d=$(this).closest("form").serialize();var c=$(this).closest("form").find("#skuInfoSearch").val();
d=d+"&skuInfo="+c;var b=a._getActiveTab();a.reloadJqgrid(b,d);});$("#"+ExchangeEntity._CONS_.EDIT_FORM_ID).find("[name=needReturn]").on("click",function(){if($(this).val()=="N"){a.exchangeEntityBase.hideReturnInfo();
}else{a.exchangeEntityBase.showReturnInfo();}});},_bindFormValidation:function(){var a={rules:{skuCount:{required:true,number:true,min:1},shipAmount:{number:true,min:0},trackingNo:{maxlength:["128"]},reasonName:{required:true,maxlength:["1024"]},returnAddr:{maxlength:["512"]},comment:{maxlength:["1024"]}},messages:{}};
FormUtils.bindFormValidation(ExchangeEntity._CONS_.EDIT_FORM_ID,a);FormUtils.bindFormValidation(ExchangeEntityExchange._CONS_.EXCHANGE_ADD_FORM,a);},_initTabShow:function(){$(".listTabPane").not(":eq(0)").removeClass("active");
},_getActiveTab:function(){var b=this;var a=$(".listTabli");var c="";$.each(a,function(d,e){if($(this).hasClass("active")){c=$(this).attr("attr-type");
}});return c;},_initComfirmBtn:function(){$("#saveDiv").hide();$("#comfirmDiv").show();$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("comfirm");
ButtonUtils.enableBtn("comfirm_direct");ButtonUtils.enableBtn("reject");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initReceiveBtn:function(){$("#saveDiv").hide();
$("#comfirmDiv").hide();$("#receiveDiv").show();$("#exchangeDiv").hide();ButtonUtils.enableBtn("receive");ButtonUtils.enableBtn("not_receive");ButtonUtils.enableBtn("prevBtn");
$("#commentDiv").show();},_initExchangeBtn:function(){$("#saveDiv").hide();$("#comfirmDiv").hide();$("#receiveDiv").hide();$("#exchangeDiv").show();$("#exchangeAddForm").find("[id=pointTip]").show();
ButtonUtils.enableBtn("exchange");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initEditBtn:function(){$("#saveDiv").show();$("#comfirmDiv").hide();
$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("save");ButtonUtils.enableBtn("prevBtn");$("#commentDiv").show();},_initDetailBtn:function(){$("#saveDiv").hide();
$("#comfirmDiv").hide();$("#receiveDiv").hide();$("#exchangeDiv").hide();ButtonUtils.enableBtn("prevBtn");FormUtils.disableForm(ExchangeEntity._CONS_.EDIT_FORM_ID);
$("#commentDiv").hide();},initEditForm:function(b){var a=this;if(!b){$(".exchangeEntitySearch").trigger("click");a.exchangeEntityBase.countAllStatus();
}a.exchangeEntityBase.isFormDataChange=a.isFormDataChange;a.exchangeEntityBase.clear(b);a.isFormDataChange=false;},reloadJqgrid:function(b,c){var a=this;
if("comfirm"==b){a.exchangeEntityComfirm.init(c);}if("receive"==b){a.exchangeEntityReceive.init(c);}if("exchange"==b){a.exchangeEntityExchange.init(c);
}if("exchangeing"==b){a.exchangeEntityExchangeing.init(c);}if("complete"==b){a.exchangeEntityComplete.init(c);}if("reject"==b){a.exchangeEntityReject.init(c);
}if("notReceive"==b){a.exchangeEntityNotReceive.init(c);}},validExchangeAdd:function(){var h=$("#exchangeAddForm");var d=h.find("[name=financeType]").val();
if("noChange"!=d){var f=h.find("[name=exAmount]").val();var g=h.find("[name=receiptAccount]").val();var a=h.find("[name=companyAccount]").val();if(!(f&&f>0)){DialogUtils.error(msgCode.FAIL_MSG,"请填写有效的付退金额");
return false;}if("pay"==d&&!a){DialogUtils.error(msgCode.FAIL_MSG,"请选择公司账号");return false;}if("refund"==d&&!g){DialogUtils.error(msgCode.FAIL_MSG,"请填写收款账号");
return false;}}var e=$("#exchangeAddForm").find("[name=exCount]").val();if(!(e&&e>0)){DialogUtils.error(msgCode.FAIL_MSG,"请填写有效的换货数量");return false;}var c="";
var b=$("#exchangeAddForm .addrli");$.each(b,function(j,i){if(!$(this).is(":hidden")){c=$(this).attr("attr-id");}});if(!c){DialogUtils.error(msgCode.FAIL_MSG,"请选择收货地址");
return false;}return true;},_initTabForReceive:function(){$("#comfirmTabLi").removeClass("active");$("#comfirmTab").removeClass("active");$("#receiveTabLi").trigger("click").addClass("active");
$("#receiveTab").addClass("active");},_initInputAndOption:function(){CateUtils.getOptions({typeKey:"system",pKey:"shipCode",container:"shipCompany"});}};
