function ExchangeEntityBase(){this.hadInit=false;this.isFormDataChange=false;this.soItemList=new SoItemList();}ExchangeEntityBase._CONS_={EDIT_URL:ctx+"/ec/ret/exchangeEntity/edit.htm",DETAIL_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",SAVE_EDIT_URL:ctx+"/ec/ret/exchangeEntity/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/ret/exchangeEntity/listData.htm",COUNT_STATUS_URL:ctx+"/ec/ret/exchangeEntity/countAllStatus.htm",CS_EDIT_URL:ctx+"/crm/cs/csEntity/edit.htm",FORM_ID:"exchangeEntityForm",COMFIRM_TAB_TYPE:"comfirm",RECEIVE_TAB_TYPE:"receive",EXCHANGE_TAB_TYPE:"exchange",EXCHANGEING_TAB_TYPE:"exchangeing",COMPLETE_TAB_TYPE:"complete",REJECT_TAB_TYPE:"reject",NOT_RECEIVE_TAB_TYPE:"notReceive",SHIP_INFO_QRY_URL:ctx+"/ec/ret/exchangeEntity/renewShipInfo.htm",SO_DETAIL_URL:ctx+"/ec/salesorder/soEntity/detail.htm",CHANGE_DETAIL_PAGE_URL:ctx+"/ec/ret/exchangeEntity/detail.htm",FIND_BY_ENO_URL:ctx+"/ec/ret/exchangeEntity/findCsByEno.htm",};
ExchangeEntityBase.prototype={init:function(a){this.listDataUrl=ExchangeEntityBase._CONS_.LIST_DATA_URL;if(a!=null&&typeof a!=undefined){if(a.listParams!=undefined){this.listDataUrl=this.listDataUrl+"?"+a.listParams;
}if(a.grid!=undefined){this.grid=a.grid;}if(a.pager!=undefined){this.pager=a.pager;}if(a.getManagerBtns!=undefined){this.getManagerBtns=a.getManagerBtns;
}if(a.widthElement!=undefined){this.widthElement=a.widthElement;}if(a.gridRecordsSpan!=undefined){this.gridRecordsSpan=a.gridRecordsSpan;}if(a.type!=undefined){this.type=a.type;
}if(a.onSelectRow!=undefined){this.onSelectRow=a.onSelectRow;}}this._initJqgrid(null);if(!this.hadInit){this.hadInit=true;this._bindEventHander();}},loadData:function(c,b){var a=this;
FormUtils.loadData(ExchangeEntityBase._CONS_.EDIT_URL+"?id="+c+"&canShowScTrankNo="+(ResUtils.canShow("exchangeEntity.button.showScTrackNo")?"can":"canot"),function(d){if(d){var f=$("#exchangeEntityForm");
$(".editInfoDiv").show();f.find("[name=eno]").val(d.eno);f.find("[name=id]").val(d.id);f.find("[name=skuCount]").val(d.skuCount);f.find("[name=needReturn]").val(d.needReturn);
f.find("[name=returnAddr]").val(d.returnAddr);f.find("[name=trackingNo]").val(d.trackingNo);f.find("[name=scId]").val(d.scId);f.find("[name=shipAmount]").val(d.shipAmount);
f.find("[name=reasonName]").val(d.reasonName);f.find("[name=csName]").val(d.soInfoVo.csName);f.find("[name=csId]").val(d.soInfoVo.csId);f.find("[name=statusName]").val(d.statusName);
a._initCsAccount(d.csId);a._initCompanyAccount();if(d.deductPoint){var e=$("#exchangeAddForm");if(d.diffMoney&&parseInt(d.diffMoney)>0){e.find("[id=pointTip]").text("（换货将扣除消费赠送的积分:"+d.deductPoint+"，由于部分积分已兑换，需要扣除对应金额，金额为:"+d.diffMoney+"元）");
}else{e.find("[id=pointTip]").text("（换货将扣除消费赠送的积分:"+d.deductPoint+"）");}}if(d.needReturn=="N"){if(d.status=="awaiting"){a.hideReturnInfo(false);}else{a.hideReturnInfo(true);
}}else{if(d.status=="awaiting"){a.showReturnInfo(false);}else{a.showReturnInfo(true);}}if("comfirm"==d.status){$(".shipQryBtn").show();}else{$(".shipQryBtn").hide();
}a._showImages(d.exchangeImgPos);a.soItemList.init({data:d.soInfoVo.soItemVos,type:SoItemList._CONS_.ONE_TYPE});if(b&&typeof(b)=="function"){b(d);}a._fillShipInfo(d);
}});},_bindEventHander:function(){var a=this;$("#"+ExchangeEntityBase._CONS_.FORM_ID).on("click",".selectImageBtn",function(){openSelectImageDialog(1,function(c){if($("#imgContainer").find("ul").length==0){var d=new StringBuffer();
d.append("<ul class='dragsort'>");for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}d.append("</ul>");
$("#imgContainer").append(d.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
}else{var d=new StringBuffer();for(var b=0;b<c.length;b++){d.append("<li>");d.append(ImageUtils.createImageDivStr([c[b]],true));d.append("</li>");}$("#imgContainer ul").append(d.toString());
}});a.isFormDataChange=true;});$(document).on("click",".shipQryBtn",function(){ButtonUtils.disableBtn("shipQryBtn");var b=$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=id]").val();
FormUtils.submit(ExchangeEntityBase._CONS_.SHIP_INFO_QRY_URL,"id="+b,function(c){ButtonUtils.enableBtn("shipQryBtn");if(c.success){DialogUtils.success(msgCode.INFO,"查询成功");
var d=$("#shipInfoForm");d.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(c.exchangeEntityPo.apiStatus));d.find("[name=apiRevokeTime]").val(c.exchangeEntityPo.apiRevokeTime);
d.find(".shippingDataDiv").empty().append(c.exchangeEntityPo.apiReturnData);}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){ButtonUtils.enableBtn("shipQryBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});$(document).on("click",".soTab",function(){var c=$(this).attr("csIdVal");var b=$(this).attr("value");
FormUtils.submit(ExchangeEntityBase._CONS_.CS_EDIT_URL,"id="+c,function(d){JTTabUtils.addOrRefreshTab(ExchangeEntityBase._CONS_.SO_DETAIL_URL+"?soNo="+b,d.name+"的订单明细");
});});$("body").on("click",".changeTab",function(){var c=$(this).attr("value");var b=ExchangeEntityBase._CONS_.FIND_BY_ENO_URL;FormUtils.loadData(b+"?eNo="+c,function(d){JTTabUtils.addOrRefreshTab(ExchangeEntityBase._CONS_.CHANGE_DETAIL_PAGE_URL+"?eno="+c,d.name+"的换货单明细");
});});},_getManagerBtns:function(b){var a=[];if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirm")){a.push({lable:"去审核",btnClasses:"btn btn-primary exchangeEntityComfirm",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirmEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary comfirmEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMFIRM_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.comfirmDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary comfirmDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receive")){a.push({lable:"去确认收货",btnClasses:"btn btn-primary exchangeEntityReceive",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receiveEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary receiveEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.receiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary receiveDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchange")){a.push({lable:"换 货",btnClasses:"btn btn-primary exchangeEntityExchange",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeEdit")){a.push({lable:"修 改",btnClasses:"btn btn-primary exchangeEdit",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary exchangeDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.EXCHANGEING_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.exchangeingDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary exchangeingDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.COMPLETE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.completeDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary completeDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.REJECT_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.rejectDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary rejectDetail",iconClasses:"fa fa-edit"});
}if(b==ExchangeEntityBase._CONS_.NOT_RECEIVE_TAB_TYPE&&ResUtils.canShow("exchangeEntity.button.notReceiveDetail")){a.push({lable:"明 细",btnClasses:"btn btn-primary notReceiveDetail",iconClasses:"fa fa-edit"});
}if(a.length>0){return a;}else{return"";}},_initJqgrid:function(c){var a=this;if(c==null||typeof c==undefined){c={};}var b=true;if(a.grid=="#exchangeEntityCompleteGrid"||a.grid=="#exchangeEntityExchangeingGrid"){b=false;
}$(a.grid).JTJqgrid({url:a.listDataUrl,pager:a.pager,postData:c,multiselectWidth:20,colNames:["换货单号","订单号","新订单号","商品名称","数量","是否回寄","申请时间","状态","操作"],colModel:[{name:"eno",index:"eno_",width:100,formatter:function(d,e,f){if(f.eno!=null&&f.eno!=""){return"<a href='#' class='changeTab' value='"+f.eno+"' >"+f.eno+"</a>";
}return f.eno;}},{name:"soNo",index:"so_no_",width:100,formatter:function(d,e,f){return"<a class='soTab' csIdVal='"+f.csId+"' value='"+f.soNo+"'>"+f.soNo+"</a>";
}},{name:"exSno",index:"ex_sno_",width:100,hidden:b,formatter:function(d,e,f){return"<a class='soTab' csIdVal='"+f.csId+"' value='"+f.exSno+"'>"+f.exSno+"</a>";
}},{name:"skuName",index:"sku_name_",width:140,formatter:function(e){var d=new StringBuffer();d.append("<div style='width:auto;overflow:hidden; white-space:nowrap; text-overflow:ellipsis'>");
d.append(e);d.append("</div>");return d.toString();}},{name:"skuCount",index:"sku_count_",width:100},{name:"needReturn",index:"need_return_",width:100,formatter:function(d,f,g){var e=g.needReturn;
if(g.needReturn=="Y"){e="<span>需要</span>";}else{if(g.needReturn=="N"){e="<span>不需要</span>";}}return e;}},{name:"createTime",index:"create_time_",width:100,formatter:function(d){return DateUtils.miniTime(d);
}},{name:"status",index:"status_",width:120,formatter:function(d,f,g){var e=g.status;if(g.status=="awaiting"){e="<span>待审核</span>";}else{if(g.status=="reject"){e="<span>审核不通过</span>";
}else{if(g.status=="comfirm"){e="<span>已审核(等待退货)</span>";}else{if(g.status=="comfirm_direct"){e="<span>已审核(无需退货)</span>";}else{if(g.status=="receive"){e="<span>已收货</span>";
}else{if(g.status=="not_receive"){e="<span>未收到</span>";}else{if(g.status=="exchange"){e="<span>换货中</span>";}else{if(g.status=="complete"){e="<span>已完成</span>";
}else{if(g.status=="reject"){e="<span>审核不通过</span>";}}}}}}}}}return e;}},{name:"__manage",width:60,classes:"rowOps",sortable:false,align:"center",formatter:"manage",formatoptions:this._getManagerBtns(a.type)}],loadComplete:function(){a._disableBtn();
if(a.gridRecordsSpan!=null){$(a.gridRecordsSpan).empty().append($(a.grid).jqGrid("getGridParam","records"));}},onSelectRow:function(e,d){if(a.onSelectRow&&typeof(a.onSelectRow)=="function"){a.onSelectRow(e,d);
}}});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(a.grid,a.searchParam);},_edit:function(b,a){this._showExchangeDetailDiv();this.edit=true;this.loadData(b,a);
},_save:function(f,g,b){var j=this;var c=$("#"+ExchangeEntityBase._CONS_.FORM_ID);if("Y"==c.find("[name=needReturn]").val()){c.find("[name=scId]").rules("add",{required:true});
c.find("[name=trackingNo]").rules("add",{required:true});}else{c.find("[name=scId]").rules("remove");c.find("[name=trackingNo]").rules("remove");}if(c.valid()){var i=ExchangeEntity._CONS_.SAVE_EDIT_URL;
if(b){i=b;}var h=new StringBuffer();h.append("id="+c.find("[name=id]").val());h.append("&reasonName="+c.find("[name=reasonName]").val());h.append("&needReturn="+c.find("[name=needReturn]").val());
h.append("&returnAddr="+c.find("[name=returnAddr]").val());h.append("&scId="+c.find("[name=scId]").val());h.append("&trackingNo="+c.find("[name=trackingNo]").val());
h.append("&shipAmount="+c.find("[name=shipAmount]").val());h.append("&comment="+c.find("[name=comment]").val());h.append("&imgUrls="+j._getImgUrl());h.append("&status="+f);
if(f=="exchange"){var k=$("#exchangeAddForm");var d=$(SoItemList._CONS_.EDIT_GRID).jqGrid("getRowData");var a=k.find("[name=financeType]").val();h.append("&exSkuId="+d[0].skuId);
h.append("&exSkuKey="+d[0].skuKey);h.append("&exStoreId="+k.find("[id=initStoreId]").val());h.append("&exCount="+k.find("[name=exCount]").val());h.append("&financeType="+a);
h.append("&exAmount="+k.find("[name=exAmount]").val());h.append("&payType="+k.find("[name=payType]").val());if("pay"==a){h.append("&receiptAccount="+k.find("[name=companyAccount]").val());
}else{if("refund"==a){h.append("&receiptAccount="+k.find("[name=receiptAccount]").val());}}h.append("&pointTip="+k.find("[id=pointTip]").text());var e=k.find(".addrli");
$.each(e,function(m,l){if(!$(this).is(":hidden")){h.append("&exAddrId="+$(this).attr("attr-id"));}});}j._disableBtn();FormUtils.submit(i,h.toString(),function(l){j._enableGrantBtn();
if(l.success){if(l.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(l.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}j.clear(false);g(true);}else{DialogUtils.error(msgCode.FAIL_MSG,l.msg);}},function(){j._enableGrantBtn();DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},exchangeAdd:function(a){this._showExchangeAddDiv();},_showExchangeListDiv:function(){$(".exchangeListDiv").show();$(".exchangeDetailDiv").hide();
$(".exchangeAddDiv").hide();},_showExchangeDetailDiv:function(){$(".exchangeListDiv").hide();$(".exchangeDetailDiv").show();$(".exchangeAddDiv").hide();
},_showExchangeAddDiv:function(){$(".exchangeListDiv").hide();$(".exchangeDetailDiv").hide();$(".exchangeAddDiv").show();},_showImages:function(a){var c=new StringBuffer();
c.append("<ul class='dragsort'>");for(var b=0;b<a.length;b++){c.append("<li>");c.append(ImageUtils.createImageDivStr([a[b]],true));c.append("</li>");}c.append("</ul>");
$("#imgContainer").empty().append(c.toString());$("#imgContainer").find("ul.dragsort").dragsort({dragSelector:"div",dragBetween:true,dragEnd:function(){},placeHolderTemplate:"<li class='placeHolder'><div></div></li>"});
$(".deleteImage").remove();},_getImgUrl:function(){var b=new Array();var a=$("#imgContainer").find("ul.dragsort");if(a.length>0){a.find("li").each(function(){var c=$(this).find("div.file-box div.file");
b.push(c.attr("urlVal"));});}return b.join(",");},_disableBtn:function(){ButtonUtils.disableBtn("comfirmEdit");ButtonUtils.disableBtn("receiveEdit");ButtonUtils.disableBtn("exchangeEntityComfirm");
ButtonUtils.disableBtn("exchangeEntityReceive");ButtonUtils.disableBtn("comfirm");ButtonUtils.disableBtn("comfirmDetail");ButtonUtils.disableBtn("receiveDetail");
ButtonUtils.disableBtn("exchangeDetail");ButtonUtils.disableBtn("comfirm_direct");ButtonUtils.disableBtn("reject");ButtonUtils.disableBtn("receive");ButtonUtils.disableBtn("not_receive");
ButtonUtils.disableBtn("prevBtn");ButtonUtils.disableBtn("exchangeEntityExchange");ButtonUtils.disableBtn("exchangeEdit");ButtonUtils.disableBtn("exchangeingDetail");
ButtonUtils.disableBtn("completeDetail");ButtonUtils.disableBtn("rejectDetail");ButtonUtils.disableBtn("notReceiveDetail");},_enableGrantBtn:function(){ButtonUtils.enableBtn("comfirm");
ButtonUtils.enableBtn("comfirm_direct");ButtonUtils.enableBtn("reject");ButtonUtils.enableBtn("receive");ButtonUtils.enableBtn("not_receive");ButtonUtils.enableBtn("prevBtn");
},clear:function(c){var a=this;function b(){a._showExchangeListDiv();a.isFormDataChange=false;a._initTabShow();$(".exchangeDetailDiv").find("[id=exchangeBillTabLi]").hide();
FormUtils.clear(ExchangeEntityBase._CONS_.FORM_ID);FormUtils.enableForm(ExchangeEntityBase._CONS_.FORM_ID);$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=csName]").attr("disabled",true);
$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=skuCount]").attr("disabled",true);$("#"+ExchangeEntityBase._CONS_.FORM_ID).find("[name=statusName]").attr("disabled",true);
$("#exchangeAddForm").find("[id=addrContainer]").empty();$("#exchangeAddForm").find("[id=pointTip]").hide();}if(c&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},countAllStatus:function(){FormUtils.loadData(ExchangeEntityBase._CONS_.COUNT_STATUS_URL,function(a){if(a){$("#exchangeEntityComfirmGrid_record").text(a[0]);
$("#exchangeEntityReceiveGrid_record").text(a[1]);$("#exchangeEntityExchangeGrid_record").text(a[2]);$("#exchangeEntityExchangeingGrid_record").text(a[3]);
$("#exchangeEntityCompleteGrid_record").text(a[4]);$("#exchangeEntityRejectGrid_record").text(a[5]);$("#exchangeEntityNotReceiveGrid_record").text(a[6]);
}});},showReturnInfo:function(b){var a=$("#"+ExchangeEntityBase._CONS_.FORM_ID);a.find(".returnInfoDiv").show();a.find(".needReturnDiv").show();a.find(".shipAmountDiv").show();
a.find(".trackingNoDiv").show();a.find(".returnAddrDiv").show();if(b){a.find(".needReturnDiv").hide();}},hideReturnInfo:function(b){var a=$("#"+ExchangeEntityBase._CONS_.FORM_ID);
a.find(".shipAmountDiv").hide().find("[name=shipAmount]").val(0);a.find(".scDiv").hide().find("[name=scId]").val("");a.find(".trackingNoDiv").hide().find("[name=trackingNo]").val("");
a.find(".returnAddrDiv").hide().find("[name=returnAddr]").val("");if(b){a.find(".returnInfoDiv").hide();}},_initCsAccount:function(b){$("#receiptAccount").bsSuggest("destroy");
var a=$("#receiptAccount").bsSuggest({getDataMethod:"url",url:ctx+"/crm/cs/csEntity/findAccount.htm?csId="+b+"&account=",inputWarnColor:null,autoSelect:false,idField:"accountType",keyField:"account",effectiveFields:["typeName","account"],effectiveFieldsAlias:{typeName:"结算方式",account:"账户"},processData:function(f){var e,c,g={value:[]};
if(!f||f.length===0){return false;}c=f.length;for(e=0;e<c;e++){var d="";if("alipay"==f[e].accountType){d="支付宝";}else{if("weixin"==f[e].accountType){d="微信";
}else{if("bank"==f[e].accountType){d="银行转账";}}}g.value.push({id:f[e].id,typeName:d,account:f[e].account,accountType:f[e].accountType});}return g;}}).on("onSetSelectValue",function(d,c){$("[name=payType]").val(c.id);
});$("#receiptAccount").bsSuggest("enable");},_initCompanyAccount:function(){FinanceAccountSelect.initSelect("companyAccount");},_fillShipInfo:function(a){if(a.scName&&a.trackingNo){$("#shipTabLi").show();
var b=$("#shipInfoForm");b.find("[name=scName]").val(a.scName);b.find("[name=trackingNo]").val(a.trackingNo);b.find("[name=apiStatus]").val(ShipInfoUtil.getShipStatusName(a.apiStatus));
b.find("[name=apiRevokeTime]").val(a.apiRevokeTime);b.find(".shippingDataDiv").empty().append(a.apiReturnData);}else{$("#shipTabLi").hide();}},_initTabShow:function(){$(".exchangeDetailDiv .tabli").removeClass("active");
$(".exchangeDetailDiv .tabli").eq(0).addClass("active");$(".exchangeDetailDiv .tab-pane").removeClass("active");$(".exchangeDetailDiv .tab-pane").eq(0).addClass("active");
}};