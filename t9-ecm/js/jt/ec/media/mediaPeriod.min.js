$(function(){var a=new MediaPeriod();a.init();});function MediaPeriod(){this.hadInit=false;}MediaPeriod._CONS_={LIST_DATA_URL:ctx+"/ec/media/mediaPeriod/listDataTable.htm",BATCH_SAVE_URL:ctx+"/ec/media/mediaPeriod/batchSaveAdd.htm",UPDATE_COST_URL:ctx+"/ec/media/mediaPeriod/updateCost.htm",EXPORT_URL:ctx+"/ec/media/mediaPeriod/exportExcel.htm",LIST_COUNT_URL:ctx+"/ec/media/mediaPeriod/listCount.htm",EDIT_FORM_ID:"mediaPeriodForm",};
MediaPeriod.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._hideNotGrantBtn();this._bindFormValidation();
this._initChannelSelect();$("#periodDaySearch").val(DateUtils.format(new Date(),"yyyy-MM-dd"));this._initTable($("#mediaPeriodSearchForm").serialize());
CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interstSearch"},{typeKey:"system",pKey:"channelAccount",container:"accountSearch"},{typeKey:"system",pKey:"mediaChannel",container:"channelPlatformSearch"}]);
}},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mediaPeriod.button.exportExcel")){$(".mediaPeriodExportExcel").hide();}},_bindEventHander:function(){var a=this;
$(".mediaPeriodSearch").on("click",function(){var b=a.toPostParam($("#mediaPeriodSearchForm").serialize());a._initTable(b);});$("#mediaPeriodSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".mediaPeriodSearch").trigger("click");
}});$(document).on("click",".mediaPeriodInitBtn",function(){a._batchSaveAdd();});$(document).on("click",".mediaPeriodChooseTime",function(){$(".mediaPeriodInitDay").text($("#periodDayInit").val());
});$(document).on("click",".mediaPeriodPlus",function(){a._mediaPeriodPlusTr();});$(document).on("click",".mediaPeriodSubtract",function(){$(this).parents("tr").remove();
});$(document).on("click",".prevDay",function(){$("#periodDaySearch").val(DateUtils.getBeforeDate(1,$("#periodDaySearch").val()));});$(document).on("click",".nextDay",function(){$("#periodDaySearch").val(DateUtils.getAfterDate(1,$("#periodDaySearch").val()));
});$(document).on("click",".toDay",function(){$("#periodDaySearch").val(DateUtils.format(new Date(),"yyyy-MM-dd"));});$(document).on("click",".layer-date",function(){laydate({istime:true,format:"YYYY-MM-DD hh:mm:ss"});
$(this).removeClass("validate_input_error");});$(document).on("click",".updateCost",function(){$(this).hide();$(this).next().show();$(this).parents("tr").find(".costInput").removeAttr("disabled");
});$(document).on("click",".periodLine",function(){var b=$(this).attr("periodId");JTTabUtils.addOrRefreshTab(ctx+"/ec/media/mediaLine/list.htm?periodId="+b,"时段推广资源进线");
});$(document).on("click",".lineToDay",function(){var b=DateUtils.format(new Date(),"yyyy-MM-dd");JTTabUtils.addOrRefreshTab(ctx+"/ec/media/mediaLine/list.htm?periodDay="+b,"当天推广资源进线");
});$(document).on("click",".saveCost",function(){var c=$(this);var b=$(this).attr("idVal");var d=$(this).parents("tr").find(".costInput").val();FormUtils.submit(MediaPeriod._CONS_.UPDATE_COST_URL,"id="+b+"&cost="+d,function(e){if(e.success){c.hide();
c.parents("tr").find(".costInput").attr("disabled","disabled");DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);
}});});$(".mediaPeriodExportExcel").on("click",function(){var b=a.toPostParam($("#mediaPeriodSearchForm").serialize());if("self"==type){b+="&Q__S__EQ__channel.mgr_="+currentUserId;
}FormUtils.submit(MediaPeriod._CONS_.EXPORT_URL,b,function(c){ButtonUtils.enableBtn("mediaPeriodExportExcel");if(c.success){DialogUtils.success(msgCode.INFO,c.msg+"成功");
}else{DialogUtils.error(msgCode.FAIL_MSG,c.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});},_initChannelSelect:function(){var a=ctx+"/ec/media/mediaChannel/findActived.htm";
if("self"==type){a=ctx+"/ec/media/mediaChannel/findActivedAndMgr.htm?mgr="+currentUserId;}var b=new StringBuffer();b.append("<option value=''>请选择</option>");
FormUtils.loadData(a,function(d){if(d&&d.length>0){for(var c=0;c<d.length;c++){b.append("<option value='"+d[c].id+"'>"+d[c].name+"</option>");}}$("#channelSearch").empty().append(b.toString());
$("#channelSearch").chosen("destroy");$("#channelSearch").chosen();});},_bindFormValidation:function(){var a={rules:{cost:{required:true},},};FormUtils.bindFormValidation("mediaPeriodInitForm",a);
},_mediaPeriodPlusTr:function(){var a=DateUtils.format(new Date(),"yyyy-MM-dd");if($("#periodDayInit").val()){a=$("#periodDayInit").val();}var b=new StringBuffer();
b.append("<tr>");b.append("<td>");b.append("<span class='mediaPeriodInitDay' name='day'>"+a+"</span>");b.append("</td>");b.append("<td>");b.append("<div class='input-daterange input-group'>");
b.append('<input class="laydate-icon form-control layer-date" name="startTime" placeholder="YYYY-MM-DD hh:mm:ss">');b.append("<span class='input-group-addon'>到</span>");
b.append('<input class="laydate-icon form-control layer-date" name="endTime" placeholder="YYYY-MM-DD hh:mm:ss">');b.append("</div>");b.append("</td>");
b.append("<td>");b.append("<input type='number' name='cost' style='width:90%;' class='form-control'>");b.append("</td>");b.append("<td>");b.append("<button type='button' class='btn btn-sm btn-primary mediaPeriodPlus'>加</button> ");
b.append("<button type='button' class='btn btn-sm btn-danger mediaPeriodSubtract'>减</button>");b.append("</td>");b.append("</tr>");$(".mediaPeriodTbody").append(b.toString());
},_batchSaveAdd:function(){var c=this;var a=MediaPeriod._CONS_.BATCH_SAVE_URL;if($("#mediaPeriodInitForm").valid()){var b="mediaPeriodJson="+c._getMediaPeriodJson();
if(!b){DialogUtils.error(msgCode.INFO,"请填写开始时间");return;}else{if(b=="[]"){DialogUtils.error(msgCode.INFO,"请录入数据");return;}else{ButtonUtils.disableBtn("mediaPeriodInitBtn");
FormUtils.submit(a,b,function(d){if(d.success){if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}JTTabUtils.addOrRefreshTab(ctx+"/ec/media/mediaPeriod/list.htm?type=all","渠道推广");}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("mediaPeriodInitBtn");
DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});}}}},_initTable:function(c){var a=this;var b=MediaPeriod._CONS_.LIST_COUNT_URL+"?Q__D__EQ__period.day_="+DateUtils.format(new Date(),"yyyy-MM-dd");
if("self"==type){b+="&Q__S__EQ__channel.mgr_="+currentUserId;}FormUtils.loadData(b,function(d){a.buildTable(c,d);if(d<=0){if("all"==type){$(".mediaPeriodInitBtn").show();
$(".lineToDay").hide();$(".mediaPeriodExportExcel").hide();$(".mediaPeriodSearchDiv").hide();$(".mediaPeriodInitSearchDiv").show();$("#mediaPeriodDiv").hide();
$("#mediaPeriodInitDiv").show();$(".mediaPeriodInitDay").text(DateUtils.format(new Date(),"yyyy-MM-dd"));}}});},buildTable:function(c,a){var b=MediaPeriod._CONS_.LIST_DATA_URL+"?"+c;
if("self"==type){b+="&Q__S__EQ__channel.mgr_="+currentUserId;}var d=new StringBuffer();d.append("<table class='table table-striped table-bordered' id='mediaPeriodTable'>");
d.append("<thead>");d.append("<tr>");d.append("<td style='width: 5%;border-right: 2px solid rgb(242, 242, 242);'>序号</td>");d.append("<td style='width: 8%;'>渠道</td>");
d.append("<td style='width: 8%;'>推广对象</td>");d.append("<td style='width: 8%;'>推广平台</td>");d.append("<td style='width: 8%;'>推广账户</td>");d.append("<td style='width: 10%;'>推广人员</td>");
d.append("<td style='width: 8%;'>日期</td>");d.append("<td style='width: 9%;'>时段</td>");d.append("<td style='width: 8%;'>消费</td>");d.append("<td style='width: 9%;'>进线</td>");
d.append("<td style='width: 9%;'>成本</td>");d.append("<td style='width: 12%;'>操作</td>");d.append("</tr>");d.append("</thead>");d.append("<tfoot>");d.append("<tr style='color:red;'>");
d.append("<td><span>统计：</span></span></td>");d.append("<td colspan='11'><span id='totalSum'></span></td>");d.append("</tr>");d.append("</tfoot>");d.append("</table>");
$("#mediaPeriodDiv").empty().append(d.toString());$("#mediaPeriodTable").DataTable({ajax:{url:b,type:"POST"},columns:[{data:"lineNum"},{data:"channelName"},{data:"channelInterst"},{data:"channel"},{data:"channelAccount"},{data:"channelMgrName"},{data:"day",render:function(e,g,f){if(e!=null&&e!=""){return e.substring(0,10);
}return e;}},{data:"startTime",render:function(g,f,e){return e.startTime.substring(11,16)+" - "+e.endTime.substring(11,16);}},{data:"cost",render:function(g,f,e){return"<input type='text' class='costInput' org-value='"+g+"' style='width:90%;'  disabled='disabled' value='"+g+"' />";
}},{data:"lineCount",render:function(e,g,f){return"<span style='font-size: 18px;font-weight:  bold;color: blue;'>"+e+"</span>条, 去重后<span style='font-size: 18px;font-weight:  bold;color: red;'>"+f.lineNoRepeatCount+"</span>条";
}},{data:"lineNoRepeatCount",render:function(g,f,e){if(e.cost>0&&e.lineCount>0){return"<span style='font-size: 18px;font-weight:  bold;color: blue;'>"+(e.cost/e.lineCount).toFixed(0)+"</span>, 去重后<span style='font-size: 18px;font-weight:  bold;color: red;'>"+(e.cost/e.lineNoRepeatCount).toFixed(0)+"</span>";
}else{return"<span style='font-size: 18px;font-weight:  bold;color: blue;'>"+0+"</span>, 去重后<span style='font-size: 18px;font-weight:  bold;color: red;'>"+0+"</span>";
}}},{data:"id",render:function(h,g,f){var e="<button class='btn btn-xs btn-primary btn-outline updateCost' type='button' idVal='"+h+"'";if(f.recordTime){e+="style='display:none;'";
}e+=">编辑</button> <button class='btn btn-xs btn-primary btn-outline saveCost' type='button' style='display:none;' idVal='"+h+"' >保存</button> ";e+="<button class='btn btn-xs btn-primary btn-outline periodLine' type='button' periodId='"+f.id+"'>时段进线</button>";
return e;}}],rowId:"id",lengthMenu:[[a],],fnRowCallback:function(h,g,f,e){if(f==0){cost=0;}if(f==0){lineCount=0;}if(f==0){lineNoRepeatCount=0;}cost+=parseFloat(g["cost"]);
lineCount+=parseFloat(g["lineCount"]);lineNoRepeatCount+=parseFloat(g["lineNoRepeatCount"]);if(cost>0&&lineCount>0){$("#totalSum").html("总消费："+cost.toFixed(2)+"(元)，进线："+lineCount.toFixed(2)+"，成本: "+(cost/lineCount).toFixed(0));
}else{$("#totalSum").html("总消费："+cost.toFixed(2)+"(元)，进线："+lineCount.toFixed(2)+"，成本： 0");}return h;},fnDrawCallback:function(f,e){$("#mediaPeriodTable_previous").find("a").text("前一天");
$("#mediaPeriodTable_next").find("a").text("后一天");},searching:false,paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:false});
},_getMediaPeriodJson:function(){var b=true;var a=new StringBuffer();a.append("[");$(".mediaPeriodTbody").find("tr").each(function(){var e=$(this).find("span").eq(0).text();
var f=$(this).find("input[name=startTime]").eq(0).val();var d=$(this).find("input[name=endTime]").eq(0).val();var g=$(this).find("input[name=cost]").eq(0).val();
if(!f){$(this).find("input[name=startTime]").addClass("validate_input_error");b=false;}a.append("{");a.append("'day':'").append(e).append("',");a.append("'startTime':'").append(f).append("',");
a.append("'endTime':'").append(d).append("',");a.append("'cost':'").append(g).append("',");a.append("},");});var c=""+a;if(c.length>1){c=c.substring(0,c.length-1);
}c=c+"]";if(!b){return b;}return c;},toPostParam:function(b){var a=new StringBuffer();$("#channelSearch option:selected").each(function(c){a.append($(this).val());
if(c==$("#channelSearch option:selected").length-1){return false;}else{a.append(",");}});b=b+"&channelSearchs="+a.toString();return b;}};