$(function(){var a=new MediaLine();a.init();});function MediaLine(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;}MediaLine._CONS_={EDIT_URL:ctx+"/ec/media/mediaLine/detail.htm",DELETE_URL:ctx+"/ec/media/mediaLine/delete.htm",LIST_DATA_URL:ctx+"/ec/media/mediaLine/listData.htm",DETAIL_CS_PAGE_URL:ctx+"/crm/cs/csEntity/detailByCode.htm",EDIT_FORM_ID:"mediaLineForm",GRID:"#mediaLineGrid",PAGER:"#mediaLinePager"};
MediaLine.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();this._initJqgrid();this._hideNotGrantBtn();this._initChannelSelect();
this._initPeriod();this._locateToGlHelp();}},_locateToGlHelp:function(){glHelpUtil.init("glHelp.operations.mediaLine");},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mediaLine.button.detail")){$(".mediaLineDetail").hide();
}if(!ResUtils.canShow("mediaLine.button.delete")){$(".mediaLineDel").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();a.isFormDataChange=false;
a.isEdit=false;FormUtils.clear(MediaLine._CONS_.EDIT_FORM_ID);FormUtils.enableForm(MediaLine._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_initChannelSelect:function(){var a=ctx+"/ec/media/mediaChannel/findActived.htm";var b=new StringBuffer();b.append("<option value=''>请选择</option>");
FormUtils.loadData(a,function(d){if(d&&d.length>0){for(var c=0;c<d.length;c++){b.append("<option value='"+d[c].id+"'>"+d[c].name+"</option>");}}$("#channelSearch").empty().append(b.toString()).select2().val($("#channelSearch").attr("value")).trigger("change");
});},_initPeriod:function(){var a=new StringBuffer();a.append("<option value=''>请选择</option>");FormUtils.loadData(ctx+"/ec/media/mediaPeriod/findPeriodTemp.htm",function(c){if(c&&c.length>0){for(var b=0;
b<c.length;b++){a.append("<option value='"+c[b].startTime.substring(11,16)+"'>"+c[b].startTime.substring(11,16)+" - "+c[b].endTime.substring(11,16)+"</option>");
}}$(".periodSearch").empty().append(a.toString());});},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();},_detail:function(a){this._showFormWrapper();this._loadData(a);FormUtils.disableForm(MediaLine._CONS_.EDIT_FORM_ID);},_loadData:function(b){var a=this;
FormUtils.loadData(MediaLine._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=channelId]").val(c.channelId);$("input[name=channelName]").val(c.channelName);
$("input[name=periodTime]").val(c.startTime+" - "+c.endTime);$("input[name=periodId]").val(c.periodId);$("select[name=type]").val(c.type);$("input[name=callId]").val(c.callId);
$("input[name=msgName]").val(c.msgName);$("input[name=msgMobile]").val(c.msgMobile);$("textarea[name=msgComment]").val(c.msgComment);$("input[name=msgPeriod]").val(c.msgPeriod);
$("input[name=csNo]").val(c.csNo);$("input[name=csCreateTime]").val(c.csCreateTime);$("select[name=isRepeat]").val(c.isRepeat);$("select[name=hasWeixin]").val(c.hasWeixin);
$("input[name=createTime]").val(c.createTime);$("input[name=updateTime]").val(c.updateTime);if("msg"!=c.type){$(".msgInfoDiv").hide();}});},_bindEventHander:function(){var a=this;
$(document).on("click",".prevBtn",function(){a.clear(false);});$("#"+MediaLine._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+MediaLine._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+MediaLine._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$(".mediaLineSearch").on("click",function(){var b=$(this).closest("form").serialize()+"&isSearch=y";if(!$("#channelSearch").val()){DialogUtils.error(msgCode.INFO,"请选择渠道");
return;}if(!$("#periodDay").val()){DialogUtils.error(msgCode.INFO,"请选择推广天");return;}a.reloadJqgrid(b);});$("#mediaLineSearchForm").on("keypress",function(b){if(b.keyCode=="13"){$(".mediaLineSearch").trigger("click");
}});$("body").on("click",".mediaLineDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(MediaLine._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DETAIL);return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$("body").on("click",".msgMoreInfo",function(){var b=$(this).attr("idVal");$("#msgMoreInfoContainer").modal("show");FormUtils.loadData(MediaLine._CONS_.EDIT_URL+"?id="+b,function(c){$("#msgMoreInfoContainer").find("input[name=msgName]").val(c.msgName);
$("#msgMoreInfoContainer").find("input[name=msgMobile]").val(c.msgMobile);$("#msgMoreInfoContainer").find("input[name=msgComment]").val(c.msgComment);$("#msgMoreInfoContainer").find("input[name=msgPeriod]").val(c.msgPeriod);
});});$("body").on("click",".csEntityDetail",function(){var b=$(this).attr("csNoVal");JTTabUtils.addOrRefreshTab(MediaLine._CONS_.DETAIL_CS_PAGE_URL+"?csCode="+b,"客户["+b+"]明细");
});$("body").on("click",".phoneMoreInfo",function(){var e=$(this).attr("callIdVal");var b=[];b.push(e);b=b.toString();var d=$(window).width();var f=["1000px","700px"];
if(d<1024){f=["700px","500px"];}var c=this;layer.open({type:1,title:"通话记录",maxmin:false,shadeClose:false,btn:["关闭"],area:f,content:$(".callRecordcDiv"),success:function(g,h){$(".callRecordIframe").attr("src",ctx+"/gl/cti/tRKSheetRecord/listRecord.htm?reqType=recordIdParams&recordIds="+b);
}});});$("body").on("click",".batchPhone",function(){var c=$(MediaLine._CONS_.GRID).jqGrid("getGridParam","selarrrow");var b=[];if(c==null||c.length==0){DialogUtils.error(msgCode.error,"请选择要查看的记录");
return;}for(var d=0;d<c.length;d++){var e=$(MediaLine._CONS_.GRID).jqGrid("getRowData",c[d]);b.push(e.callId);}b=b.toString();JTTabUtils.addOrRefreshTab(ctx+"/gl/cti/tRKSheetRecord/listRecord.htm?reqType=recordIdParams&recordIds="+b,"通话记录");
});},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(MediaLine._CONS_.GRID,a);},_initJqgrid:function(){var a=MediaLine._CONS_.LIST_DATA_URL+"?1=1";
if(periodDay){$("#periodDay").val(periodDay);a+="&Q__D__EQ__period.day_="+periodDay;}if(periodId){a+="&Q__D__EQ__period.id_="+periodId;}var b=true;$(MediaLine._CONS_.GRID).JTJqgrid({url:a,pager:MediaLine._CONS_.PAGER,colNames:["渠道","日期","时段","进线类型","重进线","客户编号","加粉","通话ID","操作"],colModel:[{name:"channelName",index:"channelName",width:90,formatter:function(c,e,f){if(f.footData){var d="<p style='font-weight:normal;color:red;'>"+$("#periodDay").val();
if($(".periodSearch").val()){d+="　"+$(".periodSearch").val();}d+="　"+f.channelName+"</p>";return d;}else{return f.channelName;}}},{name:"periodDay",width:80,formatter:function(c,d,e){return e.periodDay.substring(0,10);
}},{name:"startTime",index:"startTime",width:120,formatter:function(c,d,e){return e.startTime.substring(11,16)+" - "+e.endTime.substring(11,16);},},{name:"type",index:"type_",width:90,formatter:function(c,e,f){var d="";
if(f.type=="400"){d="400电话";}else{if(f.type=="weixin"){d="微信加粉";}else{if(f.type=="msg"){d="表单留言";}else{if(f.type=="add"){d="人工添加";}}}}return d;}},{name:"isRepeat",index:"is_repeat_",width:80,formatter:function(c){if(c=="y"){return"是";
}else{return"否";}}},{name:"csNo",index:"cs_no_",width:80,formatter:function(c,d,e){var f=new StringBuffer();if(e.csNo){f.append("<a class='csEntityDetail' style='font-weight:bold;' csNoVal='"+e.csNo+"'>"+e.csNo+"</a>"+"："+e.csName);
}return f.toString();}},{name:"hasWeixin",index:"has_weixin_",width:80,formatter:function(c){if(c=="y"){return"是";}else{return"否";}}},{name:"callId",index:"call_id_",width:80,hidden:true},{name:"id",index:"id_",width:80,formatter:function(c,d,e){if(e.type=="msg"){return"<button class='jt-btn-safe msgMoreInfo' style='font-weight:bold;' idval="+e.id+">查看留言</button>";
}else{if(e.type=="400"){return"<button class='jt-btn-safe phoneMoreInfo' style='font-weight:bold;' callIdVal="+e.callId+">查看通话</button>";}else{return"";
}}}}],footerrow:true,userDataOnFooter:true,gridComplete:function(){var c=$(MediaLine._CONS_.GRID).parents(".jqGrid_wrapper").find(".ui-jqgrid-sdiv").find("tr.footrow");
c.find("td").hide();c.find('td[aria-describedby*="_channelName"]').show();}});}};