$(function(){var a=new MediaChannel();a.init();});function MediaChannel(){this.hadInit=false;this.isEdit=false;this.isFormDataChange=false;this.mediaChannelLog=new MediaChannelLog();
this.mediaChannelWeixin=new MediaChannelWeixin();}MediaChannel._CONS_={EDIT_URL:ctx+"/ec/media/mediaChannel/edit.htm",DETAIL_URL:ctx+"/ec/media/mediaChannel/detail.htm",DELETE_URL:ctx+"/ec/media/mediaChannel/delete.htm",SAVE_ADD_URL:ctx+"/ec/media/mediaChannel/saveAdd.htm",SAVE_EDIT_URL:ctx+"/ec/media/mediaChannel/saveEdit.htm",LIST_DATA_URL:ctx+"/ec/media/mediaChannel/listData.htm",IMPORT_EXCEL_URL:ctx+"/ec/media/mediaChannel/importExcel.htm",EXPORT_EXCEL_URL:ctx+"/ec/media/mediaChannel/exportExcel.htm",EDIT_FORM_ID:"mediaChannelForm",GRID:"#mediaChannelGrid",PAGER:"#mediaChannelPager"};
MediaChannel.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindFormValidation();this._bindEventHander();this._initJqgrid(a);this._hideNotGrantBtn();
CateUtils.getOptions([{typeKey:"system",pKey:"CsInterestType",container:"interstSearch"},{typeKey:"system",pKey:"CsInterestType",container:"interst"},{typeKey:"system",pKey:"channelType-root",container:"typeSearch"},{typeKey:"system",pKey:"channelType-root",container:"type"},{typeKey:"system",pKey:"mediaChannel",container:"channelSearch"}]);
}this._locateToGlHelp();},_locateToGlHelp:function(){var a="glHelp.operations.mediaChannel";glHelpUtil.init(a);},_hideNotGrantBtn:function(){if(!ResUtils.canShow("mediaChannel.button.detail")){$("button.mediaChannelDetail").hide();
}if(!ResUtils.canShow("mediaChannel.button.add")){$("button.mediaChannelAdd").hide();}if(!ResUtils.canShow("mediaChannel.button.edit")){$("button.mediaChannelEdit").hide();
}if(!ResUtils.canShow("mediaChannel.button.delete")){$("button.mediaChannelDel").hide();}if(!ResUtils.canShow("mediaChannel.button.active")){$("button.mediaChannelActive").hide();
}if(!ResUtils.canShow("mediaChannel.button.unactive")){$("button.mediaChannelUnactive").hide();}if(!ResUtils.canShow("mediaChannel.button.mediaChannelExport")){$("button.mediaChannelExport").hide();
}if(!ResUtils.canShow("mediaChannel.button.mediaChannelImport")){$("button.mediaChannelImport").hide();}},clear:function(c){var a=this;function b(){a._showListWrapper();
a.isFormDataChange=false;a.isEdit=false;$(".form_wrapper .saveBtn").show();$("#"+MediaChannel._CONS_.EDIT_FORM_ID).find("button").removeAttr("disabled");
FormUtils.clear(MediaChannel._CONS_.EDIT_FORM_ID);FormUtils.enableForm(MediaChannel._CONS_.EDIT_FORM_ID);if(c){a.reloadJqgrid();}}if(a.isEdit&&a.isFormDataChange){DialogUtils.warning(function(){b();
});}else{b();}},_showListWrapper:function(){$(".list_wrapper").show();$(".form_wrapper").hide();},_showFormWrapper:function(){$(".list_wrapper").hide();
$(".form_wrapper").show();$(".excel_wrapper").hide();},_add:function(){this._showFormWrapper();$(".choosePhoneDiv").show();$("#chooseMgr").show();$("#clearMgr").show();
this._findEmployeeWx();this._findOutPhone();},_edit:function(a){this._showFormWrapper();this.edit=true;this._loadData(a);$(".choosePhoneDiv").show();$("#chooseMgr").show();
$("#clearMgr").show();},_detail:function(a){this._showFormWrapper();this._loadData(a);$("#"+MediaChannel._CONS_.EDIT_FORM_ID).find("button").attr("disabled","disabled");
$(".form_wrapper .saveBtn").hide();FormUtils.disableForm(MediaChannel._CONS_.EDIT_FORM_ID);$(".choosePhoneDiv").hide();$("#chooseMgr").hide();$("#clearMgr").hide();
},_loadData:function(b){var a=this;FormUtils.loadData(MediaChannel._CONS_.EDIT_URL+"?id="+b,function(c){$("input[name=id]").val(c.id);$("input[name=name]").val(c.name);
$("select[name=type]").val(c.type);$("select[name=interst]").val(c.interst);$("select[name=account]").val(c.account);$("select[name=channel]").val(c.channel);
$("input[name=inPhone]").val(c.inPhone);$("input[name=sort]").val(c.sort);$("select[name=status]").val(c.status);$("select[name=isLong]").val(c.isLong);
$("input[name=createTime]").val(c.createTime);$("input[name=updateTime]").val(c.updateTime);$("input[name=mgrName]").val(c.mgrName);$("input[name=mgr]").val(c.mgr);
$("input[name=formCode]").val(c.formCode);$("input[name=formUrl]").val(c.formUrl);a._findEmployeeWx(c.id,c.weixin);a._findOutPhone(c.outPhone);a._mediaChannelLog(c.id);
a._mediaChannelWeixin(c.id);});},_mediaChannelLog:function(a){var b={channelId:a};this.mediaChannelLog.init(b);},_mediaChannelWeixin:function(a){var b={channelId:a};
this.mediaChannelWeixin.init(b);},_save:function(){var b=this;var c=$("#id").val();var a=null;if(c!=null&&c!=""){a=MediaChannel._CONS_.SAVE_EDIT_URL;}else{a=MediaChannel._CONS_.SAVE_ADD_URL;
}if($("#mediaChannelForm").valid()){ButtonUtils.disableBtn("saveBtn");FormUtils.submitByFormId(a,MediaChannel._CONS_.EDIT_FORM_ID,function(d){ButtonUtils.enableBtn("saveBtn");
if(d.success){window.sessionStorage.setItem("loacalChannel","");if(d.msgCode==actionCode.CREATE){DialogUtils.success(msgCode.INFO,msgCode.CREATE_MSG);}else{if(d.msgCode==actionCode.UPDATE){DialogUtils.success(msgCode.INFO,msgCode.UPDATE_MSG);
}}b.isEdit=false;b.clear(true);}else{DialogUtils.error(msgCode.FAIL_MSG,d.msg);}},function(){ButtonUtils.enableBtn("saveBtn");DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});}},_delete:function(b){var a=this;DialogUtils.confirm(function(){FormUtils.del(MediaChannel._CONS_.DELETE_URL,b,function(c){if(c.success){window.sessionStorage.setItem("loacalChannel","");
DialogUtils.success(msgCode.INFO,msgCode.DELETE_MSG);a.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});});},_toggleStatus:function(c,a){var b=this;
FormUtils.submit(ctx+"/ec/media/mediaChannel/toggleStatus.htm",{ids:c.toString(),status:a},function(d){if(d.success){window.sessionStorage.setItem("loacalChannel","");
if(a==="actived"){DialogUtils.success(msgCode.SUCCESS,"激活成功");}else{if(a==="inactive"){DialogUtils.success(msgCode.SUCCESS,"禁用成功");}}b.reloadJqgrid();}else{DialogUtils.error(msgCode.ERROR,d.msg);
}});},_toExportExcel:function(b){var a=this;$(".prevBtn").show();$(".list_wrapper").hide();$(".form_wrapper").hide();$(".excel_wrapper").show();if(b&&b.length>0){$("#endExportNum").val(b.length);
}$("input[name=selectIds]").val(b);excelUtil.findExportColByModule("media",true,function(d){var e=new StringBuffer();if(d&&d.length>0){for(var c=0;c<d.length;
c++){e.append("<div class='checkbox checkbox-success checkbox-inline'>");e.append("<input type='checkbox' checked class='columnCheckBox' name='exportColumn' id="+d[c].id+" value='"+d[c].devCode+"'><label for='"+d[c].id+"'>"+d[c].name+"</label>");
e.append("</div>");}}$("#columnContainer").empty().append(e.toString());});},_exportExcel:function(){var b=this;var d=$("#columnContainer").find(".columnCheckBox");
var f=[];$(d).each(function(){if($(this).is(":checked")){f.push($(this).val());}});var a=$("#beginExportNum").val();var c=$("#endExportNum").val();if(!a){DialogUtils.error(msgCode.ERROR,"请填写正确的开始记录");
return;}if(!c){DialogUtils.error(msgCode.ERROR,"请填写正确的结束记录");return;}if(a>c){DialogUtils.error(msgCode.ERROR,"开始记录不能大于结束记录");return;}if(parseInt(a)-parseInt($(MediaChannel._CONS_.GRID).jqGrid("getGridParam","records"))>0){DialogUtils.error(msgCode.ERROR,"开始记录不能大于记录总条数");
return;}if(!c){c=a;}var h=$("#mediaChannelSearchForm").serialize();var e=$("input[name=selectIds]").val();if(e&&e.length>0){var g=h+"&columns="+f.toString()+"&Q__S__IN__id_="+e;
}else{var g=h+"&columns="+f.toString()+"&beginExportNum="+a+"&endExportNum="+c;}window.location.href=MediaChannel._CONS_.EXPORT_EXCEL_URL+"?"+g;},_bindEventHander:function(){var a=this;
$("body").on("click",".mediaChannelExport",function(){var b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");a._toExportExcel(b);});$("body").on("click",".exportExcel",function(){a._exportExcel();
});$("body").on("click",".mediaChannelImport",function(){var b={"importUrl":MediaChannel._CONS_.IMPORT_EXCEL_URL,"tabTitle":"导入渠道excel数据"};excelUtil.importExcel(b);
});$('select[name="outPhone"]').on("change",function(){var b=$(this).find("option:selected").attr("phoneVal");$("#inPhone").val(b);});$(document).on("click",".mediaChannelUnactive",function(){a.isEdit=true;
var b=$(this).attr("idVal");if(!b){b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,"请选择要禁用的属性");
return;}}a._toggleStatus(b,"inactive");});$(document).on("click",".mediaChannelActive",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.ERROR,"请选择要激活的属性");return;}}a._toggleStatus(b,"actived");});$(document).on("click",".prevBtn",function(){a.clear(false);
});$(document).on("click",".saveBtn",function(){a._save();});$("#"+MediaChannel._CONS_.EDIT_FORM_ID).on("change","input",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("#"+MediaChannel._CONS_.EDIT_FORM_ID).on("change","select",function(){if(a.isEdit){a.isFormDataChange=true;}});$("#"+MediaChannel._CONS_.EDIT_FORM_ID).on("change","textarea",function(){if(a.isEdit){a.isFormDataChange=true;
}});$("body").on("click",".mediaChannelAdd",function(){a._add();});$("body").on("click",".mediaChannelEdit",function(){a.isEdit=true;var b=$(this).attr("idVal");
if(!b){b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_EDIT);
return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_EDIT_MUL_RECORD);return;}}}a._edit(b);});$("body").on("click",".mediaChannelDel",function(){var b=$(this).attr("idVal");
if(!b){b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");if(b==null||b.length==0){DialogUtils.error(msgCode.error,msgCode.ERROR_NO_SELECT_DELETE);
return;}}a._delete(b);});$("body").on("click",".mediaChannelDetail",function(){a.isEdit=true;var b=$(this).attr("idVal");if(!b){b=$(MediaChannel._CONS_.GRID).jqGrid("getGridParam","selarrrow");
if(b==null||b.length==0){DialogUtils.error(msgCode.error,"请选择要查看明细的记录");return;}else{if(b&&b.length>1){DialogUtils.error(msgCode.error,msgCode.ERROR_DETAIL_MUL_RECORD);
return;}}}a._detail(b);});$(".list_wrapper").on("click",".mediaChannelSearch",function(){var b=$(this).closest("form").serialize();a.reloadJqgrid(b);});
$("#mediaChannelSearchForm").on("keypress",function(b){if(b.keyCode=="13"){var c=$(this).closest("form").serialize();a.reloadJqgrid(c);return false;}});
$(document).on("click","#chooseMgr",function(){var b=new EmployeesSelect();var c={isMultiple:0,isSale:0,mode:0,callBack:function(d){$("[name=mgrName]").val(d[0].name);
$("[name='mgr']").val(d[0].id);}};b.init(c);});$(document).on("click","#clearMgr",function(){$("[name=mgrName]").val("");$("[name='mgr']").val("");});$("body").on("click",".empWeixin",function(){var b=$(this).text();
JTTabUtils.addOrRefreshTab(ctx+"/gl/ou/employeeWeiXin/list.htm?weixin="+b,"员工微信管理");});$(document).on("mouseenter",".jt-weixin-info",function(g){var f=$(this).attr("data-alias");
var j=new StringBuffer();var c=f.split(",");for(var d=0;d<c.length;d++){j.append("<a href='#' class='empWeixin'>"+c[d]+"</a><br />");}$("#jt-weixin-info-div").empty().append(j.toString());
var b=$(this).offset().left;var h=$(this).offset().top+5-$("body").height()*0.025;if(h+300>$(document).height()){h=$(document).height()-300;}$("#jt-weixin-info-div").css({"top":h,"left":b});
$("#jt-weixin-info-div").stop().show("fast");});$(document).on("mouseleave",".jt-weixin-info",function(c){var b=$(this).offset().left;var d=$(this).offset().top+5-$("body").height()*0.025;
if(d+300>$(document).height()){d=$(document).height()-300;}$("#jt-weixin-info-div").css({"top":d,"left":b});$("#jt-weixin-info-div").stop().hide("fast");
});$("#jt-weixin-info-div").hover(function(b){$("#jt-weixin-info-div").stop(true,true).show();},function(b){$("#jt-weixin-info-div").stop().hide("fast");
});},_findEmployeeWx:function(d,c){var b=this;var e=new StringBuffer();$("#relateEmpWx").empty();$("#relateEmpWx").chosen("destroy");$("#relateEmpWx").chosen();
e.append("<option value=''>请选择</option>");var a=[];if(c&&c!=""){a=c.split(",");}FormUtils.loadData(ctx+"/gl/ou/employeeWeiXin/findAll.htm",function(h){if(h&&h.length>0){for(var g=0;
g<h.length;g++){var f=h[g];e.append("<option value='");e.append(f.alias);e.append("'");if(b._isSelected(a,f.alias)){e.append(" selected='selected'");}e.append(">");
e.append(f.alias+":"+f.nickName);e.append("</option>");}$("#relateEmpWx").append(e.toString());$("#relateEmpWx").chosen("destroy");$("#relateEmpWx").chosen();
}});},_isSelected:function(a,c){for(var b=0;b<a.length;b++){if(c==a[b]){return true;}}return false;},_findOutPhone:function(b){var a=this;var c=new StringBuffer();
c.append("<option value=''>请选择</option>");FormUtils.loadData(ctx+"/gl/phone/phone/findAll.htm",function(d){FormUtils.loadData(ctx+"/ec/media/mediaChannel/findHaveOutPhone.htm",function(e){ConfigUtils.findByKey("isUserNewMediaChannel",function(k){var f="";
for(var h=0;h<e.length;h++){f+=e[h].outPhone+",";}if(d.length>0){for(var g=0;g<d.length;g++){if(d[g].adNum==b){c.append("<option value='").append(d[g].adNum).append("' phoneVal='").append(d[g].phone).append("' ");
c.append("selected='selected' ");c.append(">").append(d[g].adNum).append("</option>");}else{if(k.success){c.append("<option value='").append(d[g].adNum).append("' phoneVal='").append(d[g].phone).append("' ");
c.append(">").append(d[g].adNum).append("</option>");}else{if(f.indexOf(d[g].adNum)==-1){c.append("<option value='").append(d[g].adNum).append("' phoneVal='").append(d[g].phone).append("' ");
c.append(">").append(d[g].adNum).append("</option>");}}}}}$("#outPhone").empty().append(c.toString());});});});},_bindFormValidation:function(){var a={rules:{name:{required:true},type:{required:true}},messages:{}};
FormUtils.bindFormValidation(MediaChannel._CONS_.EDIT_FORM_ID,a);},reloadJqgrid:function(a){JTJqgridUtils.reloadJqgrid(MediaChannel._CONS_.GRID,a);},_initJqgrid:function(a){if(a==null||typeof a==undefined){a={};
}$(MediaChannel._CONS_.GRID).JTJqgrid({url:MediaChannel._CONS_.LIST_DATA_URL,pager:MediaChannel._CONS_.PAGER,postData:a,colNames:["名称","类型","推广对象","推广人员","400电话","外线电话","状态","创建时间"],colModel:[{name:"name",index:"name_",width:100,formatter:function(b,c,d){if(d.isQuote=="y"){return"<span style='color:red'>"+b+"</span>";
}else{return b;}}},{name:"type",width:100},{name:"interst",width:100},{name:"mgrName",width:100},{name:"outPhone",index:"out_phone_",width:100},{name:"inPhone",index:"in_phone_",width:100},{name:"status",index:"status_",width:80,formatter:function(b){switch(b){case"actived":return"<span>激活</span>";
break;case"inactive":return"<span style='color:red'>未激活</span>";break;}}},{name:"createTime",index:"create_time_",width:120,formatter:function(b){return DateUtils.miniTime(b);
}}],loadComplete:function(){if($(MediaChannel._CONS_.GRID).jqGrid("getGridParam","records")<1000){$("#endExportNum").val($(MediaChannel._CONS_.GRID).jqGrid("getGridParam","records"));
}else{$("#endExportNum").val(1000);}}});}};