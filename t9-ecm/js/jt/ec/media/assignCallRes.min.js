$(function(){var a=new AssignCallRes(id);a.init();});function AssignCallRes(a){if(!(this instanceof AssignCallRes)){return new AssignCallRes();}else{this.id=a;
}}AssignCallRes._CONS_={LOAD_DATA_URL:ctx+"/ec/media/mediaPlan/loadPlan.htm",SAVE_URL:ctx+"/ec/media/mediaPlan/saveAssignCallRes.htm"};AssignCallRes.prototype={init:function(){this._loadPlan();
this._bindEventHanlder();},_loadPlan:function(){var a=this;FormUtils.loadData(AssignCallRes._CONS_.LOAD_DATA_URL+"?id="+this.id,function(k){$("#mgrContainer").text(k.mgrName);
var b=k.adStartTime;var e=k.deadline;$("#planContainer").empty().append("渠道名称：<b>"+k.channelName+"</b>&nbsp;&nbsp;&nbsp;&nbsp;开始时间：<b>"+b+"</b>&nbsp;&nbsp;&nbsp;&nbsp;结束时间：<b>"+e+"</b>");
var g=k.callLogPos?k.callLogPos.length:0;var c=k.waitingAssignCalls?k.waitingAssignCalls.length:0;var h=k.assignedCalls?k.assignedCalls.length:0;var j=k.repeatCalls?k.repeatCalls.length:0;
$("#countContainer").empty().append("记录总数（<b>"+g+"</b>），已分配（<b>"+h+"</b>），未分配（<b>"+c+"</b>），重复（<b>"+j+"</b>）");a.mediaPlan=k;var f=new StringBuffer();if(k.subEmployeeVos&&k.subEmployeeVos.length){for(var d=0;
d<k.subEmployeeVos.length;d++){f.append("<option value='"+k.subEmployeeVos[d].id+"'>"+k.subEmployeeVos[d].userName+"</option>");}}$("#subEmployeeSelect").empty().append(f.toString());
$("#subEmployeeSelect").chosen();a._createAssigned();});},_bindEventHanlder:function(){var a=this;$("#assignBtn").on("click",function(){if(!$("#notAssignCallRes").val()||$("#notAssignCallRes").val()<=0){DialogUtils.error(msgCode.ERROR,"无资源进行分配，请刷新后再尝试");
return;}var d=$("#subEmployeeSelect").val();if(d.length>=$("#notAssignCallRes").val()){for(var c=0;c<$("#notAssignCallRes").val();c++){var f=$("td[employeeIdVal='"+d[c]+"']");
if(f.length){var e=f.attr("callLogIdsVal").split(",");e.push(a.mediaPlan.waitingAssignCalls[a.index].id);a.index++;f.attr("callLogIdsVal",e.toString());
f.next().find("input").val(Number(Number(f.next().find("input").val())+1));}}a.index=0;}else{for(var c=0;c<a.mediaPlan.waitingAssignCalls.length-1;c++){if(a.index>=a.mediaPlan.waitingAssignCalls.length){break;
}for(var b=0;b<$("#notAssignCallRes").val();b++){var f=$("td[employeeIdVal='"+d[c]+"']");if(f.length){var e=f.attr("callLogIdsVal").split(",");e.push(a.mediaPlan.waitingAssignCalls[a.index].id);
a.index++;f.attr("callLogIdsVal",e.toString());f.next().find("input").val(Number(Number(f.next().find("input").val())+1));}}}a.index=0;}$("#notAssignCallRes").val(0);
});$("#assignCallPlanContainer").on("click",".viewDetailBtn",function(){var f=[];var b=$(this).parent().prev().prev().attr("calllogidsval").split(",");
for(var e=0;e<a.mediaPlan.callLogPos.length;e++){var d=a.mediaPlan.callLogPos[e];if(b&&b.length){for(var c=0;c<b.length;c++){if(d.id==b[c]){f.push(d);break;
}}}}if(f.length){var g=new StringBuffer();for(var e=0;e<f.length;e++){g.append("<tr>");g.append("<td>"+(f[e].csName?f[e].csName:"未知客户")+"</td>");g.append("<td>"+f[e].ano+"</td>");
g.append("</tr>");}$("#callLogAssignDetailContainer").empty().append(g.toString());$("#callLogAssignDetailModal").modal("show");}});$(".saveDraftBtn").on("click",function(){a._saveAssign("draft");
});$(".saveBtn").on("click",function(){a._saveAssign("assign");});$("#createAssignPlanBtn").on("click",function(){if(!$("#notAssignCallRes").val()||$("#notAssignCallRes").val()<=0){DialogUtils.error(msgCode.ERROR,"无资源进行分配，请刷新后再尝试");
return;}if($("#assignCallPlanContainer").find("tr").length>0){if(a.mediaPlan.waitingAssignCalls.length&&a.mediaPlan.assignedCalls.length){if($("#notAssignCallRes").val()>0){for(var c=0;
c<a.mediaPlan.waitingAssignCalls.length;c++){var b=a.mediaPlan.waitingAssignCalls[c];var e=$("#assignCallPlanContainer").find("td[employeeIdVal='"+a.mediaPlan.subEmployeeVos[c].id+"']");
if(e.length){var d=e.attr("callLogIdsVal").split(",");d.push(b.id);e.attr("callLogIdsVal",d.toString());e.next().find("input").val(Number(e.next().find("input").val())+1);
}}$("#notAssignCallRes").val("0");}else{DialogUtils.error(msgCode.ERROR,"无资源进行分配，请刷新后再尝试");}}}else{a._averageAssign();}});},_getAssignParams:function(){var b={};
var a=[];$("#assignCallPlanContainer").find("tr").each(function(){var g=$(this).find("td:eq(0)");var h=g.attr("employeeIdVal");var d=g.attr("callLogIdsVal");
var e={employeeId:h,callLogIds:d};a.push(e);var c=$(this).find("td:eq(4)");var f=c.attr("employeeIdVal");callLogIds1=c.attr("callLogIdsVal");var i={employeeId:f,callLogIds:callLogIds1};
a.push(i);});b.assignJson=JSON.stringify(a);return b;},_saveAssign:function(b){if(!$("#assignCallPlanContainer").find("tr").length){DialogUtils.error(msgCode.ERROR,"请生成分配方案后再保存");
return;}var c=this._getAssignParams();c.type=b;var a=this;FormUtils.submit(AssignCallRes._CONS_.SAVE_URL,c,function(d){if(d.success){DialogUtils.success(msgCode.SUCCESS,"分配成功");
a._loadPlan();}else{DialogUtils.success(msgCode.ERROR,d.msg);}});},_createAssigned:function(){if(this.mediaPlan.assignedCalls&&this.mediaPlan.assignedCalls.length&&this.mediaPlan.subEmployeeVos&&this.mediaPlan.subEmployeeVos.length){var d=new StringBuffer();
for(var c=0;c<this.mediaPlan.subEmployeeVos.length;c++){var a=[];for(var b=0;b<this.mediaPlan.assignedCalls.length;b++){if(this.mediaPlan.assignedCalls[b].employeeId==this.mediaPlan.subEmployeeVos[c].id){a.push(this.mediaPlan.assignedCalls[b].id);
}}d.append("<tr>").append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[c].id+"' callLogIdsVal='"+a.toString()+"'>"+this.mediaPlan.subEmployeeVos[c].userName+"</td>").append("<td><input readonly='readonly' value='"+a.length+"' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>");
c++;a=[];for(var b=0;b<this.mediaPlan.assignedCalls.length;b++){if(this.mediaPlan.assignedCalls[b].employeeId==this.mediaPlan.subEmployeeVos[c].id){a.push(this.mediaPlan.assignedCalls[b].id);
}}d.append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[c].id+"' callLogIdsVal='"+a.toString()+"'>"+this.mediaPlan.subEmployeeVos[c].userName+"</td>").append("<td><input readonly='readonly' value='"+a.length+"' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>");
d.append("</tr>");}$("#assignCallPlanContainer").append(d.toString());if(this.mediaPlan.waitingAssignCalls.length){$("#notAssignCallRes").val(this.mediaPlan.waitingAssignCalls.length);
this.index=0;}else{$("#notAssignCallRes").val(0);}}},_averageAssign:function(){var g=this.mediaPlan.waitingAssignCalls.length;var a=this.mediaPlan.subEmployeeVos.length;
if(g&&a){if(g>a){var e=0;if(g%a==0){e=g/a;}else{e=Math.floor(g/a);}var h=new StringBuffer();var c=0;for(var d=0;d<a;d++){var f=[];for(var b=0;b<e;b++){$.log(c);
f.push(this.mediaPlan.waitingAssignCalls[c].id);c++;}h.append("<tr>").append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[d].id+"' callLogIdsVal='"+f.toString()+"'>"+this.mediaPlan.subEmployeeVos[d].userName+"</td>").append("<td><input readonly='readonly' value='"+e+"' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>");
d++;f=[];for(var b=0;b<e;b++){$.log(c);f.push(this.mediaPlan.waitingAssignCalls[c].id);c++;}h.append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[d].id+"' callLogIdsVal='"+f.toString()+"'>"+this.mediaPlan.subEmployeeVos[d].userName+"</td>").append("<td><input readonly='readonly' value='"+e+"' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>").append("</tr>");
}$("#assignCallPlanContainer").append(h.toString());if(g%a!=0){$("#notAssignCallRes").val(this.mediaPlan.waitingAssignCalls.length-c);}this.index=c;}else{var h=new StringBuffer();
for(var d=0;d<g;d++){h.append("<tr>").append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[d].id+"' callLogIdVal='"+this.mediaPlan.waitingAssignCalls[d].id+"'>"+this.mediaPlan.subEmployeeVos[d].userName+"</td>").append("<td><input readonly='readonly' value='1' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>");
d++;h.append("<td employeeIdVal='"+this.mediaPlan.subEmployeeVos[d].id+"' callLogIdVal='"+this.mediaPlan.waitingAssignCalls[d].id+"'>"+this.mediaPlan.subEmployeeVos[d].userName+"</td>").append("<td><input readonly='readonly' value='1' class='form-control'></td>").append("<td><a href='javascript:void(0);' class='viewDetailBtn'>查看明细</a></td>").append("<td><button class='btn btn-primary' type='button'>解除分配</button></td>").append("</tr>");
}$("#assignCallPlanContainer").append(h.toString());}}}};