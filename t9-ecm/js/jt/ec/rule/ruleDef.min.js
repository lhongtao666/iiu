function RuleDef(){}RuleDef.prototype={init:function(){this._bindEventHandler();},getRuleDefJson:function(){var c=$("select[name='profitType']").val();
var b=$("select[name='targetType']").val();var d={qualifyType:$("select[name='qualifyType']").val(),profitType:c,targetType:b,profitPlus:$("select[name='profitPlus']").val(),};
switch(c){case"percent":case"money":d.ruleProfitPos=this._getDiscountData();if(b=="category"){d.targetConfig=this._getProdCateData();}break;case"skuPercent":if(b==="sku"){d.ruleProfitPos=this._getDiscountData();
d.targetConfig=this._getSkuTargetConfig();}else{if(b==="prod"){d.ruleProfitPos=this._getDiscountData();d.targetConfig=this._getProdTargetConfig();}}break;
case"productGift":if(b==="sku"){d.ruleProfitPos=this._getProductGiftData();d.targetConfig=this._getSkuTargetConfig();}else{if(b==="prod"){d.ruleProfitPos=this._getProductGiftData();
d.targetConfig=this._getProdTargetConfig();}}break;case"totalCoupon":d.ruleProfitPos=this._getCouponData();if(b==="sku"){d.targetConfig=this._getSkuTargetConfig();
}else{if(b==="prod"){d.targetConfig=this._getProdTargetConfig();}}break;case"totalPoint":d.ruleProfitPos=this._getPointData();if(b==="sku"){d.targetConfig=this._getSkuTargetConfig();
}else{if(b==="prod"){d.targetConfig=this._getProdTargetConfig();}}break;case"moneyFreeShip":d.ruleProfitPos=[];var a={isFreeShip:"y",sort:1,baseAmount:$("#promoDetailBodyContainer").find("tr:eq(0) td:eq(1) input").val()};
d.ruleProfitPos.push(a);if(b==="sku"){d.targetConfig=this._getSkuTargetConfig();}else{if(b==="prod"){d.targetConfig=this._getProdTargetConfig();}}break;
}return JSON.stringify(d);},initRuleDef:function(c,a){if(c){this._changeProfitType(c.profitType);$("select[name='qualifyType']").val(c.qualifyType);$("select[name='profitType']").val(c.profitType);
$("select[name='targetType']").val(c.targetType);$("select[name='profitPlus']").val(c.profitPlus);if(c.targetType=="category"){this._switchToCartOrCategoryConfig(c.targetType,c.profitType);
this._createProdCate(c.catePoList);}else{if(c.targetType=="prod"){this._switchToSkuOrProdConfig(c.targetType,c.profitType);this._createProd(c.prodList);
}else{if(c.targetType=="sku"){this._switchToSkuOrProdConfig(c.targetType,c.profitType);this._createSku(c.skuList);}else{if(c.targetType=="cart"){this._switchToCartOrCategoryConfig(c.targetType,c.profitType);
}}}}if(c.ruleProfitPos&&c.ruleProfitPos.length>0){$("#promoDetailBodyContainer").empty();for(var b=0;b<c.ruleProfitPos.length;b++){if(c.profitType=="money"&&(c.targetType=="cart"||c.targetType=="category")){this._createMoney(c.ruleProfitPos[b].baseAmount,c.ruleProfitPos[b].discountAmount);
}else{if(c.profitType=="percent"&&(c.targetType=="cart"||c.targetType=="category")){this._createPercent(c.ruleProfitPos[b].baseAmount,c.ruleProfitPos[b].discountPercent);
}else{if(c.profitType=="skuPercent"){this._createPercent(c.ruleProfitPos[b].baseAmount,c.ruleProfitPos[b].discountPercent);}else{if(c.profitType=="productGift"){this._createProductGift(c.ruleProfitPos[0].baseCount,c.ruleProfitPos);
}else{if(c.profitType=="totalPoint"){this._createPoint(c.ruleProfitPos[b].baseCount,c.ruleProfitPos[b].pointCount);}else{if(c.profitType=="moneyFreeShip"){this._createMoneyFreeShip(c.ruleProfitPos[0].baseAmount);
}else{if(c.profitType=="totalCoupon"){this._createCoupon(c.ruleProfitPos[0].baseCount,c.ruleProfitPos);}}}}}}}}}}if(a){FormUtils.disableForm("ruleDefForm");
$("#selectConfigBtn").attr("disabled","disabled");$("#selectCouponBtn").attr("disabled","disabled");$("#addPromoBtn").attr("disabled","disabled");$("#selectSkuGiftBtn").attr("disabled","disabled");
$(".deleteCouponBtn").attr("disabled","disabled");$(".deleteSkuOrProdBtn").attr("disabled","disabled");$(".deleteSkuGiftBtn").attr("disabled","disabled");
$(".editCouponBtn").attr("disabled","disabled");$(".editSkuGiftBtn").attr("disabled","disabled");$(".deleteSkuOrProdBtn").attr("disabled","disabled");$(".deleteMoneyOrPercentBtn").attr("disabled","disabled");
}},clear:function(){$("#configBodyContainer").empty();$("#promoDetailBodyContainer").empty();FormUtils.clear("ruleDefForm");$("#configContainer").hide();
$("#promoDetailContainer").hide();FormUtils.enableForm("ruleDefForm");$("#selectConfigBtn").removeAttr("disabled");$("#selectCouponBtn").removeAttr("disabled");
$("#addPromoBtn").removeAttr("disabled");$("#selectSkuGiftBtn").removeAttr("disabled");$(".deleteCouponBtn").removeAttr("disabled");$(".deleteSkuOrProdBtn").removeAttr("disabled");
$(".deleteSkuGiftBtn").removeAttr("disabled");$(".editCouponBtn").removeAttr("disabled");$(".editSkuGiftBtn").removeAttr("disabled");$(".deleteSkuOrProdBtn").removeAttr("disabled");
$(".deleteMoneyOrPercentBtn").removeAttr("disabled");},_bindFormValidation:function(){var a={rules:{qualifyType:{required:true},targetType:{required:true},profitType:{required:true},moneyType:{required:true},profitPlus:{required:true}},messages:{}};
FormUtils.bindFormValidation("ruleDefForm",a);},_getSkuTargetConfig:function(){var a=[];$("#configBodyContainer").find("tr").each(function(){a.push($(this).attr("skuIdVal"));
});return a.join(",");},_getProdTargetConfig:function(){var a=[];$("#configBodyContainer").find("tr").each(function(){a.push($(this).attr("prodIdVal"));
});return a.join(",");},_getCouponData:function(){var c=[];var b=1;var a=$("#promoDetailBodyContainer").find("tr:eq(0) td:eq(1) input").val();$("#couponContainer").find("tr").each(function(){var e=$(this).attr("couponDefIdVal");
var d=$(this).find("td:eq(2) input").val();var f={baseCount:a,couponDefId:e,giftCount:d,isFreeShip:"n",sort:b++};c.push(f);});return c;},_getPointData:function(){var b=[];
var a=1;$("#promoDetailBodyContainer").find("tr").each(function(){var c=$(this).find("td:eq(1) input").val();var e=$(this).find("td:eq(4) input").val();
var d=null;d={baseCount:c,pointCount:e,isFreeShip:"n",sort:a++};b.push(d);});return b;},_getProdCateData:function(){var a=[];$("#configBodyContainer").find("tr").each(function(){a.push($(this).attr("cateIdVal"));
});return a.join(",");},_getDiscountData:function(){var d=$("select[name='profitType']").val();var c=$("select[name='targetType']").val();var b=[];var a=1;
$("#promoDetailBodyContainer").find("tr").each(function(){var e=$(this).find("td:eq(1) input").val();var g=$(this).find("td:eq(4) input").val();var f=null;
if(d=="percent"||d=="skuPercent"){f={baseAmount:e,discountPercent:g,isFreeShip:"n",sort:a++};}else{if(d=="money"){f={baseAmount:e,discountAmount:g,isFreeShip:"n",sort:a++};
}}b.push(f);});return b;},_getProductGiftData:function(){var c=[];var b=1;var a=$("#promoDetailBodyContainer").find("tr:eq(0) td:eq(1) input").val();$("#prodGiftContainer").find("tr").each(function(){var d=$(this).attr("skuIdVal");
var f=$(this).find("td:eq(2) input").val();var e={baseCount:a,giftSkuId:d,giftCount:f,isFreeShip:"n",sort:b++};c.push(e);});return c;},_switchToSkuOrProdConfig:function(a,b){if(a==="sku"){var c=new StringBuffer();
c.append("<tr>").append("<th>图片</th>").append("<th>产品编号</th>").append("<th>产品名字</th>").append("<th>sku编码</th>").append("<th>单位</th>").append("<th>价格</th>").append("<th>操作</th>").append("</tr>");
$("#selectLabelConfigContainer").empty().append("选择sku产品");$("#selectConfigBtn").empty().append("<i class='fa fa-plus'></i>选择sku产品");}else{var c=new StringBuffer();
c.append("<tr>").append("<th>产品编号</th>").append("<th>产品名字</th>").append("<th>产品副名称</th>").append("<th>操作</th>").append("</tr>");$("#selectLabelConfigContainer").empty().append("选择产品");
$("#selectConfigBtn").empty().append("<i class='fa fa-plus'></i>选择产品");}$("#configHeaderContainer").empty().append(c.toString());$("#configContainer").show();
if(b==="skuPercent"){$("#addPromoBtn").show();$("#promoDetailBodyContainer").empty();this._createPercent();$("#promoDetailContainer").show();}else{if(b=="productGift"){this._createProductGift();
$("#promoDetailContainer").show();}else{if(b==="totalCoupon"){this._createCoupon();$("#promoDetailContainer").show();}else{if(b==="totalPoint"){$("#promoDetailBodyContainer").empty();
this._createPoint(1,20);$("#promoDetailContainer").show();$("#addPromoBtn").show();}else{if(b==="moneyFreeShip"){this._createMoneyFreeShip();$("#promoDetailBodyContainer").empty();
$("#promoDetailContainer").show();}}}}}},_switchToCartOrCategoryConfig:function(a,b){if(a==="category"){var c=new StringBuffer();c.append("<tr>").append("<th>分类名字</th>").append("<th>业务健</th>").append("<th>操作</th>").append("</tr>");
$("#configHeaderContainer").empty().append(c.toString());$("#selectConfigBtn").empty().append("<i class='fa fa-plus'></i>选择分类");$("#selectLabelConfigContainer").empty().append("选择产品分类");
$("#configContainer").show();}else{$("#configContainer").hide();}if(b==="money"){$("#promoDetailBodyContainer").empty();this._createMoney();$("#promoDetailContainer").show();
$("#addPromoBtn").show();}else{if(b==="percent"){$("#promoDetailBodyContainer").empty();this._createPercent();$("#promoDetailContainer").show();$("#addPromoBtn").show();
}else{if(b==="moneyFreeShip"){$("#promoDetailBodyContainer").empty();this._createMoneyFreeShip();$("#promoDetailContainer").show();$("#addPromoBtn").hide();
}}}},_createPoint:function(a,b){if(!a){a=1;}if(!b){b=20;}var c=new StringBuffer();c.append("<tr>").append("<td>买</td>").append("<td><input class='form-control' value='"+a+"'></td>").append("<td>件</td>").append("<td>多送（百分比）</td>").append("<td><input class='form-control' value='"+b+"' placeholder='输入积分，1~100'></td>").append("<td>%</td>").append("<td>积分</td>").append("<td><button class='btn btn-danger deleteMoneyOrPercentBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
$("#promoDetailBodyContainer").append(c.toString());},_createProductGift:function(b,a){if(!b){b=1;}var c=new StringBuffer();c.append("<tr>").append("<td>买</td>").append("<td><input type='text' class='form-control' value='"+b+"'></td>").append("<td>件</td>").append("<td>送</td>").append("<td>").append("<table class='table table-striped table-bordered' id='prodGiftContainer'>");
c.append("</table>").append("<button class='btn btn-primary pull-right' id='selectSkuGiftBtn' type='button'><i class='fa fa-plus'></i>添加sku赠品</button></td>").append("</tr>");
$("#promoDetailBodyContainer").empty().append(c.toString());this._createGift(a,false);},_createCoupon:function(a,c){if(!a){a=1;}var b=new StringBuffer();
b.append("<tr>").append("<td>买</td>").append("<td><input type='text' class='form-control' value='"+a+"'></td>").append("<td>件</td>").append("<td>送</td>").append("<td>").append("<table class='table table-striped table-bordered' id='couponContainer'>");
b.append("</table>").append("<button class='btn btn-primary pull-right' id='selectCouponBtn' type='button'><i class='fa fa-plus'></i>添加优惠券</button></td>").append("</tr>");
$("#promoDetailBodyContainer").empty().append(b.toString());this._createCouponItems(c,false);},_createCouponItems:function(d,b){if(d&&d.length){var c=new StringBuffer();
if(b){for(var a=0;a<d.length;a++){c.append("<tr couponDefIdVal='"+d[a].id+"'>").append("<td><input class='form-control' value='"+d[a].name+"'></td>").append("<td><button class='btn btn-primary editCouponBtn' type='button'><i class='fa fa-edit'></i>选择优惠券</button></td>").append("<td><input class='form-control' value='"+1+"'></td>").append("<td>"+"张"+"</td>").append("<td><button class='btn btn-danger deleteCouponBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
}}else{for(var a=0;a<d.length;a++){c.append("<tr couponDefIdVal='"+d[a].id+"'>").append("<td><input class='form-control' value='"+d[a].couponName+"'></td>").append("<td><button class='btn btn-primary editCouponBtn' type='button'><i class='fa fa-edit'></i>选择优惠券</button></td>").append("<td><input class='form-control' value='"+d[a].giftCount+"'></td>").append("<td>"+"张"+"</td>").append("<td><button class='btn btn-danger deleteCouponBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
}}$("#couponContainer").append(c.toString());}},_createGift:function(a,c){if(a&&a.length){var d=new StringBuffer();if(c){for(var b=0;b<a.length;b++){d.append("<tr skuIdVal='"+a[b].skuId+"'>").append("<td><input class='form-control' value='"+a[b].prodName+"'></td>").append("<td><button class='btn btn-primary editSkuGiftBtn' type='button'><i class='fa fa-edit'></i>选择sku产品</button></td>").append("<td><input class='form-control' value='1'></td>").append("<td>"+a[b].unitName+"</td>").append("<td><button class='btn btn-danger deleteSkuGiftBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
}}else{for(var b=0;b<a.length;b++){d.append("<tr skuIdVal='"+a[b].giftSkuId+"'>").append("<td><input class='form-control' value='"+a[b].giftName+"'></td>").append("<td><button class='btn btn-primary editSkuGiftBtn' type='button'><i class='fa fa-edit'></i>选择sku产品</button></td>").append("<td><input class='form-control' value='"+a[b].giftCount+"'></td>").append("<td>"+a[b].unitName+"</td>").append("<td><button class='btn btn-danger deleteSkuGiftBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
}}$("#prodGiftContainer").append(d.toString());}},_createPercent:function(b,a){var c=new StringBuffer();if(!b){b=100;}if(!a){a="";}c.append("<tr><td>满</td>").append("<td><input type='text' class='form-control' value='"+b+"'></td>").append("<td>元</td>").append("<td>打</td>").append("<td><input class='form-control' value='"+a+"' placeholder='输入折扣，1-10'></td>").append("<td>折</td>").append("<td><button class='btn btn-danger deleteMoneyOrPercentBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
$("#promoDetailBodyContainer").append(c.toString());},_createMoneyFreeShip:function(a){if(!a){a=100;}var b=new StringBuffer();b.append("<tr>").append("<td>满</td>").append("<td><input type='text' class='form-control' value='"+a+"'></td>").append("<td>元</td>").append("<td>包邮</td>").append("</tr>");
$("#promoDetailBodyContainer").append(b.toString());},_createMoney:function(b,a){if(!b){b=100;}if(!a){a="";}var c=new StringBuffer();c.append("<tr><td>满</td>").append("<td><input type='text' class='form-control' value='"+b+"'></td>").append("<td>元</td>").append("<td>减</td>").append("<td><input class='form-control' value='"+a+"' placeholder='输入金额'></td>").append("<td>元</td>").append("<td><button class='btn btn-danger deleteMoneyOrPercentBtn' type='button'><i class='fa fa-remove'></i>删除</button></td>").append("</tr>");
$("#promoDetailBodyContainer").append(c.toString());},_createProdCate:function(a){if(a&&a.length){var c=new StringBuffer();for(var b=0;b<a.length;b++){c.append("<tr cateIdVal='"+a[b].id+"'>").append("<td>"+a[b].name+"</td>").append("<td>"+a[b].key+"</td>").append("<td><button type='button' class='btn btn-danger deleteProdCateBtn'><i class='fa fa-remove'></i>删除</td>").append("</tr>");
}$("#configBodyContainer").append(c.toString());}},_createProd:function(a){if(a&&a.length){var c=new StringBuffer();for(var b=0;b<a.length;b++){c.append("<tr prodIdVal='"+a[b].prodId+"'>").append("<td>"+a[b].key+"</td>").append("<td>"+a[b].name+"</td>").append("<td>"+a[b].shortName+"</td>").append("<td><button type='button' class='btn btn-danger deleteSkuOrProdBtn'><i class='fa fa-remove'></i>删除</td>").append("</tr>");
}$("#configBodyContainer").append(c.toString());}},_createSku:function(b){if(b&&b.length){var e=new StringBuffer();for(var a=0;a<b.length;a++){var c={path:b[a].imgUrl,isZoom:"mm"};
var d=ImageUtils.getUrl(c,"mm");e.append("<tr prodIdVal='"+b[a].prodId+"' skuIdVal='"+b[a].skuId+"'>").append("<td><img src='"+d+"' style='width: 30px; height: 30px;'></td>").append("<td>"+b[a].prodCode+"</td>").append("<td>"+b[a].prodName+"</td>").append("<td>"+b[a].skuCode+"</td>").append("<td>"+b[a].unitName+"</td>").append("<td>"+b[a].price+"</td>").append("<td><button type='button' class='btn btn-danger deleteSkuOrProdBtn'><i class='fa fa-remove'></i>删除</td>").append("</tr>");
}$("#configBodyContainer").append(e.toString());}},_changeProfitType:function(a){switch(a){case"money":case"percent":var b=new StringBuffer();b.append("<option value=''>请选择</option>");
b.append("<option value='cart'>购物车</option>").append("<option value='category'>产品分类</option>");$("select[name='targetType']").empty().append(b.toString());
break;case"skuPercent":var b=new StringBuffer();b.append("<option value=''>请选择</option>");b.append("<option value='sku'>1~N个产品SKU</option>").append("<option value='prod'>产品</option>");
$("select[name='targetType']").empty().append(b.toString());break;case"productGift":case"totalCoupon":$("#addPromoBtn").hide();var b=new StringBuffer();
b.append("<option value=''>请选择</option>");b.append("<option value='sku'>1~N个产品SKU</option>").append("<option value='prod'>产品</option>");$("select[name='targetType']").empty().append(b.toString());
break;case"totalPoint":var b=new StringBuffer();b.append("<option value=''>请选择</option>");b.append("<option value='sku'>1~N个产品SKU</option>").append("<option value='prod'>产品</option>");
$("select[name='targetType']").empty().append(b.toString());break;case"moneyFreeShip":var b=new StringBuffer();b.append("<option value=''>请选择</option>");
b.append("<option value='cart'>购物车</option>").append("<option value='prod'>产品</option>").append("<option value='category'>产品分类</option>");$("select[name='targetType']").empty().append(b.toString());
break;}},_bindEventHandler:function(){var a=this;$("select[name='profitType']").on("change",function(){var b=$(this).val();a._changeProfitType(b);});$("select[name='targetType']").on("change",function(){var b=$(this).val();
var c=$("select[name='profitType']").val();switch(b){case"cart":case"category":a._switchToCartOrCategoryConfig(b,c);break;case"prod":case"sku":a._switchToSkuOrProdConfig(b,c);
break;}});$("#ruleDefContainer").on("click","#selectConfigBtn",function(){if($(this).text().indexOf("sku")!=-1){SelectProdService.selectSku({storeId:"",isMultiple:1,fn:function(c){a._createSku(c);
}});}else{if($(this).text().indexOf("选择分类")!=-1){var b={isMultiple:1,typeKey:"product_catalog",pKey:"category",fn:function(c){a._createProdCate(c);}};CateUtils.selectCate(b);
}else{var b={isMultiple:1,fn:function(c){a._createProd(c);}};SelectProdService.selectProd(b);}}});$("#configBodyContainer").on("click",".deleteSkuOrProdBtn",function(){$(this).parent().parent().remove();
});$("#ruleDefContainer").on("click","#selectSkuGiftBtn",function(){SelectProdService.selectSku({storeId:"",isMultiple:1,fn:function(b){a._createGift(b,true);
}});});$("#ruleDefContainer").on("click",".deleteSkuGiftBtn",function(){$(this).parent().parent().remove();});$("#ruleDefContainer").on("click",".editSkuGiftBtn",function(){var b=$(this).parent().parent();
SelectProdService.selectSku({isMultiple:0,storeId:"",fn:function(c){b.attr("prodIdVal",c[0].prodId);b.attr("skuIdVal",c[0].skuId);b.find("td").eq(0).find("input").val(c[0].name);
}});});$("#ruleDefContainer").on("click","#selectCouponBtn",function(){SelectCouponUtils.selectCoupon({isMultiple:1,fn:function(b){a._createCouponItems(b,true);
}});});$("#ruleDefContainer").on("click",".deleteCouponBtn",function(){$(this).parent().parent().remove();});$("#ruleDefContainer").on("click",".editCouponBtn",function(){var b=$(this).parent().parent();
SelectCouponUtils.selectCoupon({isMultiple:0,fn:function(c){b.attr("couponDefIdVal",c[0].id);b.find("td").eq(0).find("input").val(c[0].name);}});});$("#addPromoBtn").on("click",function(){var b=$("select[name='profitType']").val();
if(b==="money"){a._createMoney();}else{if(b==="percent"){a._createPercent();}else{if(b=="skuPercent"){a._createPercent();}else{if(b=="totalPoint"){a._createPoint(1,1.5);
}}}}});$("#promoDetailBodyContainer").on("click",".deleteMoneyOrPercentBtn",function(){$(this).parent().parent().remove();});$("#configBodyContainer").on("click",".deleteProdCateBtn",function(){$(this).parent().parent().remove();
});}};