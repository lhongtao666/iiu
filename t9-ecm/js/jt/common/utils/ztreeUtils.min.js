var currentRightClickCate=null;var ZtreeUtils={init:function(b,c){if(c){if(!b){throw new Error("初始化ztree的参数不能为空");}if(!b.treeId){throw new Error("初始化ztree的参数[options.treeId]不能为空");
}if(!b.cateTypeKey){throw new Error("初始化ztree的参数[options.cateTypeKey]不能为空");}if(!b.rootKey){throw new Error("初始化ztree的参数[options.rootKey]不能为空");}this.options=b;
this._initTree(b);this._bindEventHandler(b);this._bindFormValidation();}else{var a=new ZTree();a.init(b);}},_initTree:function(b){var a=this;var d=b.type;
if(!d){d="system";}var c={edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{autoExpandTrigger:true,isCopy:false,isMove:b.dragAble?true:false,prev:true,next:true,inner:(b.inner===null||b.inner===""||b.inner===undefined)?true:b.inner,borderMax:10,borderMin:-5,minMoveSize:5,autoOpenTime:500}},view:{dblClickExpand:false,showLine:true,selectedMulti:false},async:{enable:true,url:ctx+"/gl/cate/cate/loadCateTreeData.htm",contentType:"application/json",dataType:"json",type:"get",otherParam:{cateTypeKey:b.cateTypeKey,rootKey:b.rootKey,userId:b.userId,type:d,limitProdCate:b.limitProdCate?b.limitProdCate:"n",isSale:b.isSale?b.isSale:"n"},autoParam:["id"]},check:{enable:false,chkStyle:"radio",radioType:"all"},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{onClick:function(e,g,f){a.currentClickCate=f;
if(!a.options.disabledRoot){if(b.onClick){b.onClick(f);}}else{if(f.parentId&&b.onClick){b.onClick(f);}}},beforeClick:function(g,f,e){if(!f.parentId&&a.options.disabledRoot){return false;
}else{return true;}},onRightClick:function(h,j,i){a.currentRightClickCate=i;var g=false;var f=false;var e=false;var k=false;if((!i.children||i.children.length==0)){if(!i.parentId){g=false;
}else{g=true;}}if(b.canLeafShowAddBtn===false){f=false;}else{f=true;}if(i.parentId){e=true;}else{if(!i.parentId&&b.canRootShowUpdateBtn===true){e=true;
}}if(b.type==="userAndSystem"){if(i.name.indexOf("【系统】")!=-1){f=false;e=false;g=false;}}if(a.currentClickCate&&a.currentClickCate.id==i.id){k=true;}a._showRightMenu({x:h.pageX,y:h.pageY},f,e,g,k);
if(b.onRightClick){b.onRightClick(i);}},onAsyncSuccess:function(g,j,i,k){var f=$.fn.zTree.getZTreeObj(b.treeId);var h=f.getNodes();var e=h[0];if(h&&h.length){f.expandNode(e,true,false,true);
}if(a.options.disabledRoot){if(e.children&&e.children.length){a._selectNode(e.children[0]);}}else{if(!i){a._selectNode(e);}}},beforeDrag:function(f,e){if(!e[0].parentId){return false;
}else{return true;}},beforeDrop:function(h,g,i,f){var e=g[0];if(f==="prev"||f==="next"){if((e.parentId.isEmpty()&&i.parentId.isEmpty())||(e.parentId==i.parentId)){a._moveHandler(e.id,i.id,null,f);
}else{if(e.parentId!=null&&i.parentId!=null&&e.parentId!=i.parentId){a._moveHandler(e.id,i.id,i.parentId,f);}else{if(e.parentId!=null&&i.parentId==null){a._moveHandler(e.id,i.id,i.id,f);
}}}return true;}else{if(f==="inner"){if(e==null||i==null){return false;}else{a._moveHandler(e.id,null,i.id,null);return true;}}}return false;},}};$.fn.zTree.init($("#"+b.treeId),c);
},_selectNode:function(b){var a=$.fn.zTree.getZTreeObj(this.options.treeId);a.selectNode(b);self.currentClickCate=b;if(this.options.onClick){this.options.onClick(b);
}},_bindFormValidation:function(){var a={rules:{cateName:{required:true},cateKey:{required:true}}};FormUtils.bindFormValidation("cateForm",a);},_moveHandler:function(d,c,a,b){var e={};
if(d&&c&&a==null){e.type="changeSort";}else{if(d&&c&&a!=null){e.type="changeSortAndParentId";}else{if(d&&a!=null){e.type="changeParentId";}}}e.srcId=d;
e.destId=c;e.destParentId=a;e.moveType=b;FormUtils.submit(ctx+"/gl/cate/cate/move.htm",e,function(f){if(f.success){DialogUtils.success("成功","已更新资分类树");
}},function(){DialogUtils.error("错误","网络错误，请稍候重试");});},_showRightMenu:function(d,b,a,c,e){if(c){$("#rMenu").find("li[data-action='del']").show();}else{$("#rMenu").find("li[data-action='del']").hide();
}if(b){$("#rMenu").find("li[data-action='add']").show();}else{$("#rMenu").find("li[data-action='add']").hide();}if(a){$("#rMenu").find("li[data-action='update']").show();
}else{$("#rMenu").find("li[data-action='update']").hide();}if(e){$("#rMenu").find("li[data-action='upload']").show();}else{$("#rMenu").find("li[data-action='upload']").hide();
}$("#rMenu").css({top:(d.y-15)+"px",left:(d.x-10)+"px",display:"block"});},_bindEventHandler:function(a){if(this._hadBindEventHandler){return;}this._hadBindEventHandler=true;
this._bindContextMenuHanlder(a);this._bindSelectIconEventHandler();this._bindSaveCateEventHandler();$("#addCateModalContainer").on("hidden.bs.modal",function(){FormUtils.clear("cateForm");
});$("#addCateModalContainer").on("shown.bs.modal",function(){$("input[name='cateName']").focus();});$("#removeIconBtn").on("click",function(){$("#iconUrlContainer").removeAttr("src");
$("input[name='iconUrl']").val("");});},_bindContextMenuHanlder:function(b){var a=this;$(document).on("mouseleave","#rMenu",function(){$("#rMenu").hide();
});var d={add:{isShow:true,title:"添加",clazz:"addCateBtn",clickFn:function(){}},update:{isShow:true,title:"更新",clazz:"updateCateBtn",clickFn:function(){}},del:{isShow:true,title:"删除",clazz:"delCateBtn",clickFn:function(){}}};
var c=jQuery.extend(d,b.contextMenu);var e=new StringBuffer();if(c.add.isShow){e.append("<li data-action='add' class='"+c.add.clazz+"'><a><font class='text-navy'><i class='fa fa-plus'></i>&nbsp;&nbsp;"+c.add.title+"</font></a></li>");
$("#contextMenuContainer").on("click","."+c.add.clazz,function(){a.isEdit=false;$("#myModalLabel").text("添加分类");$("#addCateModalContainer").modal("show");
if(c.add.clickFn){c.add.clickFn(a.currentRightClickCate);}});}if(c.update.isShow){e.append("<li data-action='update' class='"+c.update.clazz+"'><a><font class='text-navy'><i class='fa fa-edit'></i>&nbsp;&nbsp;"+c.update.title+"</a></font></li>");
$("#contextMenuContainer").on("click","."+c.update.clazz,function(){a.isEdit=true;CateUtils.loadOption(a.currentRightClickCate.id,function(f){$("input[name='cateKey']").val(f.key);
$("input[name='cateName']").val(f.name);$("input[name='iconUrl']").val(f.iconUrl);$("#iconUrlContainer").attr("src",ctx+ztreeIconStyle+"/"+f.iconUrl+".png");
$("#myModalLabel").text("更新分类");$("#addCateModalContainer").modal("show");});if(c.update.clickFn){c.update.clickFn(a.currentRightClickCate);}});}if(c.del.isShow){e.append("<li data-action='del' class='"+c.del.clazz+"'><a><font class='text-danger'><i class='fa fa-remove'></i>&nbsp;&nbsp;"+c.del.title+"</a></font></li>");
$("#contextMenuContainer").on("click","."+c.del.clazz,function(){c.del.clickFn(a.currentRightClickCate);});}if(c.upload&&c.upload.isShow){e.append("<li data-action='upload' class='"+c.upload.clazz+"'><a><font class='text-navy'><i class='fa fa-cloud-upload'>&nbsp;&nbsp;"+c.upload.title+"</a></font></li>");
}$("#contextMenuContainer").empty().append(e.toString());},_bindSelectIconEventHandler:function(){$("#selectIconBtn").on("click",function(){var a=$(this);
SelectZtreeIconUtils.selectZtreeIcon(function(b){$("input[name='iconUrl']").val(b);a.siblings("img").attr("src",ctx+ztreeIconStyle+"/"+b+".png");});});
},_bindSaveCateEventHandler:function(){var a=this;$("#saveCateBtnCommon").on("click",function(){if(!$("#cateForm").valid()){return;}var b=$("#cateForm").find("input[name='cateName']").val();
var c=$("#cateForm").find("input[name='cateKey']").val();var e=$("#cateForm").find("input[name='iconUrl']").val();if(!c){c=new Date().getTime()+"_"+Math.random();
}var d={typeKey:a.options.cateTypeKey,pKey:a.currentRightClickCate.key,key:c,parentId:a.currentRightClickCate.parentId,id:a.currentRightClickCate.id,name:b,userId:a.options.userId,iconUrl:e,success:function(k){if(k.success){if(k.msgCode==actionCode.CREATE){var j=$.fn.zTree.getZTreeObj(a.options.treeId);
var h={name:b,key:c,id:k.msg,iconSkin:e?e:""};var g=-1;var f=j.transformToArray(j.getNodes());if(a.options.type=="userAndSystem"){if(a.options.userId){h.name="【个人】"+h.name;
}else{h.name="【系统】"+h.name;}}j.addNodes(a.currentRightClickCate,f.length,h);var i=j.getNodesByFilter(function(l){if(l.id==h.id){return true;}else{return false;
}},true);a.currentRightClickCate=i;j.selectNode(i);DialogUtils.success(msgCode.SUCCESS,"添加成功");}else{if(k.msgCode==actionCode.UPDATE){var j=$.fn.zTree.getZTreeObj(a.options.treeId);
a.currentRightClickCate.name=b;a.currentRightClickCate.key=c;a.currentRightClickCate.iconSkin=e;j.updateNode(a.currentRightClickCate);DialogUtils.success(msgCode.SUCCESS,"更新成功");
}}$("#addCateModalContainer").modal("hide");FormUtils.clear("cateForm");$("#iconUrlContainer").attr("src","");if(a.options.saveFn){a.options.saveFn(a.currentRightClickCate);
}}else{DialogUtils.error(msgCode.FAIL,k.msg);}},error:function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);}};if(a.isEdit){CateUtils.updateOption(d);
}else{CateUtils.addOption(d);}});}};function ZTree(){this.options=null;}ZTree.prototype={init:function(a){if(!a){throw new Error("初始化ztree的参数不能为空");}if(!a.treeId){throw new Error("初始化ztree的参数[options.treeId]不能为空");
}if(!a.cateTypeKey){throw new Error("初始化ztree的参数[options.cateTypeKey]不能为空");}if(!a.rootKey){throw new Error("初始化ztree的参数[options.rootKey]不能为空");}this.options=a;
this._initTree(a);this._bindEventHandler(a);this._bindFormValidation();},_initTree:function(b){var a=this;var d=b.type;if(!d){d="system";}var c={edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{autoExpandTrigger:true,isCopy:false,isMove:b.dragAble?true:false,prev:true,next:true,inner:(b.inner===null||b.inner===""||b.inner===undefined)?true:b.inner,borderMax:10,borderMin:-5,minMoveSize:5,autoOpenTime:500}},view:{dblClickExpand:false,showLine:true,selectedMulti:false},async:{enable:true,url:(b.url===null||b.url===""||b.url===undefined)?(ctx+"/gl/cate/cate/loadCateTreeData.htm"):b.url,contentType:"application/json",dataType:"json",type:"get",otherParam:{cateTypeKey:b.cateTypeKey,rootKey:b.rootKey,userId:b.userId,type:d,limitProdCate:b.limitProdCate?b.limitProdCate:"n",isSale:b.isSale?b.isSale:"n"},autoParam:["id"]},check:{enable:false,chkStyle:"radio",radioType:"all"},data:{simpleData:{enable:true,idKey:"id",pIdKey:"parentId"}},callback:{onClick:function(e,g,f){a.currentClickCate=f;
if(!a.options.disabledRoot){if(b.onClick){b.onClick(f);}}else{if(f.parentId&&b.onClick){b.onClick(f);}}},beforeClick:function(g,f,e){if(!f.parentId&&a.options.disabledRoot){return false;
}else{return true;}},onRightClick:function(h,j,i){a.currentRightClickCate=i;currentRightClickCate=i;var g=false;var f=false;var e=false;var k=false;if((!i.children||i.children.length==0)){if(!i.parentId){g=false;
}else{g=true;}}if(b.canLeafShowAddBtn===false){f=false;}else{f=true;}if(i.parentId){e=true;}else{if(!i.parentId&&b.canRootShowUpdateBtn===true){e=true;
}}if(b.type==="userAndSystem"){if(i.name.indexOf("【系统】")!=-1){f=false;e=false;g=false;}}if(a.currentClickCate&&a.currentClickCate.id==i.id){k=true;}a._showRightMenu({x:h.pageX,y:h.pageY},f,e,g,k);
if(b.onRightClick){b.onRightClick(i);}a._bindContextMenuHanlder({contextMenu:a.options.contextMenu});},onAsyncSuccess:function(g,j,i,k){var f=$.fn.zTree.getZTreeObj(b.treeId);
var h=f.getNodes();var e=h[0];if(h&&h.length){f.expandNode(e,true,false,true);}if(a.options.disabledRoot){if(e.children&&e.children.length){a._selectNode(e.children[0]);
}}else{if(!i){a._selectNode(e);}}},beforeDrag:function(f,e){if(!e[0].parentId){return false;}else{return true;}},beforeDrop:function(h,g,i,f){var e=g[0];
if(f==="prev"||f==="next"){if((e.parentId.isEmpty()&&i.parentId.isEmpty())||(e.parentId==i.parentId)){a._moveHandler(e.id,i.id,null,f);}else{if(e.parentId!=null&&i.parentId!=null&&e.parentId!=i.parentId){a._moveHandler(e.id,i.id,i.parentId,f);
}else{if(e.parentId!=null&&i.parentId==null){a._moveHandler(e.id,i.id,i.id,f);}}}return true;}else{if(f==="inner"){if(e==null||i==null){return false;}else{a._moveHandler(e.id,null,i.id,null);
return true;}}}return false;},}};$.fn.zTree.init($("#"+b.treeId),c);},_selectNode:function(b){var a=$.fn.zTree.getZTreeObj(this.options.treeId);a.selectNode(b);
self.currentClickCate=b;if(this.options.onClick){this.options.onClick(b);}},_bindFormValidation:function(){var a={rules:{cateName:{required:true},cateKey:{required:true}}};
FormUtils.bindFormValidation("cateForm",a);},_moveHandler:function(d,c,a,b){var e={};if(d&&c&&a==null){e.type="changeSort";}else{if(d&&c&&a!=null){e.type="changeSortAndParentId";
}else{if(d&&a!=null){e.type="changeParentId";}}}e.srcId=d;e.destId=c;e.destParentId=a;e.moveType=b;FormUtils.submit(ctx+"/gl/cate/cate/move.htm",e,function(f){if(f.success){DialogUtils.success("成功","已更新资分类树");
}},function(){DialogUtils.error("错误","网络错误，请稍候重试");});},_showRightMenu:function(d,b,a,c,e){if(c){$("#rMenu").find("li[data-action='del']").show();}else{$("#rMenu").find("li[data-action='del']").hide();
}if(b){$("#rMenu").find("li[data-action='add']").show();}else{$("#rMenu").find("li[data-action='add']").hide();}if(a){$("#rMenu").find("li[data-action='update']").show();
}else{$("#rMenu").find("li[data-action='update']").hide();}if(e){$("#rMenu").find("li[data-action='upload']").show();}else{$("#rMenu").find("li[data-action='upload']").hide();
}$("#rMenu").css({top:(d.y-15)+"px",left:(d.x-10)+"px",display:"block"});},_bindEventHandler:function(a){if(this._hadBindEventHandler){return;}this._hadBindEventHandler=true;
this._bindContextMenuHanlder(a);this._bindSelectIconEventHandler();this._bindSaveCateEventHandler();$("#addCateModalContainer").on("hidden.bs.modal",function(){FormUtils.clear("cateForm");
});$("#addCateModalContainer").on("shown.bs.modal",function(){$("input[name='cateName']").focus();});$("#removeIconBtn").on("click",function(){$("#iconUrlContainer").removeAttr("src");
$("input[name='iconUrl']").val("");});},_bindContextMenuHanlder:function(b){var a=this;$(document).on("mouseleave","#rMenu",function(){$("#rMenu").hide();
});var d={add:{isShow:true,title:"添加",clazz:"addCateBtn",clickFn:function(){}},update:{isShow:true,title:"更新",clazz:"updateCateBtn",clickFn:function(){}},del:{isShow:true,title:"删除",clazz:"delCateBtn",clickFn:function(){}}};
var c=jQuery.extend(d,b.contextMenu);var e=new StringBuffer();if(c.add.isShow){e.append("<li data-action='add' class='"+c.add.clazz+"'><a><font class='text-navy'><i class='fa fa-plus'></i>&nbsp;&nbsp;"+c.add.title+"</font></a></li>");
$("."+c.add.clazz).off();$(document).on("click","."+c.add.clazz,function(){a.isEdit=false;$("#myModalLabel").text("添加分类");$("#addCateModalContainer").modal("show");
if(c.add.clickFn){c.add.clickFn(a.currentRightClickCate);}});}if(c.update.isShow){e.append("<li data-action='update' class='"+c.update.clazz+"'><a><font class='text-navy'><i class='fa fa-edit'></i>&nbsp;&nbsp;"+c.update.title+"</a></font></li>");
$("."+c.update.clazz).off();$(document).on("click","."+c.update.clazz,function(){a.isEdit=true;CateUtils.loadOption(currentRightClickCate.id,function(f){$("input[name='cateKey']").val(f.key);
$("input[name='cateName']").val(f.name);$("input[name='iconUrl']").val(f.iconUrl);$("#iconUrlContainer").attr("src",ctx+ztreeIconStyle+"/"+f.iconUrl+".png");
$("#myModalLabel").text("更新分类");$("#addCateModalContainer").modal("show");});if(c.update.clickFn){c.update.clickFn(a.currentRightClickCate);}});}if(c.del.isShow){e.append("<li data-action='del' class='"+c.del.clazz+"'><a><font class='text-danger'><i class='fa fa-remove'></i>&nbsp;&nbsp;"+c.del.title+"</a></font></li>");
$("."+c.del.clazz).off();$(document).on("click","."+c.del.clazz,function(){c.del.clickFn(a.currentRightClickCate);});}if(c.upload&&c.upload.isShow){e.append("<li data-action='upload' class='"+c.upload.clazz+"'><a><font class='text-navy'><i class='fa fa-cloud-upload'>&nbsp;&nbsp;"+c.upload.title+"</a></font></li>");
}$("#contextMenuContainer").empty().append(e.toString());},_bindSelectIconEventHandler:function(){$("#selectIconBtn").off();$("#selectIconBtn").on("click",function(){var a=$(this);
SelectZtreeIconUtils.selectZtreeIcon(function(b){$("input[name='iconUrl']").val(b);a.siblings("img").attr("src",ctx+ztreeIconStyle+"/"+b+".png");});});
},_bindSaveCateEventHandler:function(){var a=this;$("#saveCateBtnCommon").off();$("#saveCateBtnCommon").on("click",function(){if(!$("#cateForm").valid()){return;
}if(!a.currentRightClickCate){a.currentRightClickCate=currentRightClickCate;}var b=$("#cateForm").find("input[name='cateName']").val();var c=$("#cateForm").find("input[name='cateKey']").val();
var e=$("#cateForm").find("input[name='iconUrl']").val();if(!c){c=new Date().getTime()+"_"+Math.random();}var d={typeKey:a.options.cateTypeKey,pKey:a.currentRightClickCate.key,key:c,parentId:a.currentRightClickCate.parentId,id:a.currentRightClickCate.id,name:b,userId:a.options.userId,iconUrl:e,success:function(l){if(l.success){if(l.msgCode==actionCode.CREATE){var k=$.fn.zTree.getZTreeObj(a.options.treeId);
var h={name:b,key:c,id:l.msg,iconSkin:e?e:""};var g=-1;var f=k.transformToArray(k.getNodes());if(a.options.type=="userAndSystem"){if(a.options.userId){h.name="【个人】"+h.name;
}else{h.name="【系统】"+h.name;}}k.addNodes(a.currentRightClickCate,f.length,h);var j=k.getNodesByFilter(function(m){if(m.id==h.id){return true;}else{return false;
}},true);a.currentRightClickCate=j;k.selectNode(j);DialogUtils.success(msgCode.SUCCESS,"添加成功");}else{if(l.msgCode==actionCode.UPDATE){var k=$.fn.zTree.getZTreeObj(a.options.treeId);
a.currentRightClickCate.name=b;a.currentRightClickCate.key=c;a.currentRightClickCate.iconSkin=e;k.updateNode(a.currentRightClickCate);DialogUtils.success(msgCode.SUCCESS,"更新成功");
}}$("#addCateModalContainer").modal("hide");FormUtils.clear("cateForm");$("#iconUrlContainer").attr("src","");if(a.options.saveFn){a.options.saveFn(a.currentRightClickCate);
}var i=$.fn.zTree.getZTreeObj(a.options.treeId);i.reAsyncChildNodes(null,"refresh");}else{DialogUtils.error(msgCode.FAIL,l.msg);}},error:function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
}};if(a.isEdit){CateUtils.updateOption(d);}else{CateUtils.addOption(d);}});}};