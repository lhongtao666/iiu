function JTWebUploader(a){this.config=a.config;this.container=a.container;this.finish=a.finish;this.success=a.success;this.error=a.error;this.caption=a.caption;
if(!this.container){throw new Error("container参数不能为空");}if(!this.success){throw new Error("上传成功的回调函数不能为空");}this.fileCount=0;this.fileSize=0;this.percentages={};
this.state="pedding";this.uploader=null;this.isImage=true;this.auto=a.auto?a.auto:false;}JTWebUploader._CONS_={UPLOADER_URL:ctx+"/crm/components/upload/ajax.htm?categoryDir=temp",THUMBNAIL_WIDTH:(window.devicePixelRatio||1)*110,THUMBNAIL_HEIGHT:(window.devicePixelRatio||1)*110,};
JTWebUploader.prototype={_createDefaultHtml:function(){return"<div class='queueList'>"+"<div id='dndArea' class='placeholder'>"+"<div id='filePicker' class='filePicker'></div>"+"<p>"+this.caption+"</p>"+"</div>"+"<ul class='filelist'></ul>"+"</div>"+"<div class='statusBar' style='display:none;'>"+"<span class='text'></span>"+"<span class='percentage'></span>"+"<div class='info'></div>"+"<div class='btns'>"+"<div class='uploadBtn'>开始上传</div>"+"</div>"+"</div>";
},init:function(){if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.");
}$(document.body).off("paste");$("#"+this.container).empty().html(this._createDefaultHtml());this.uploader=WebUploader.create({pick:{id:".filePicker",label:"点击选择文件"},dnd:"#"+this.container+" .queueList",paste:document.body,accept:{title:"选择文件",extensions:this.config.acceptTypes,mimeTypes:this.config.mimeTypes||""},swf:ctx+"/js/plugins/webuploader/Uploader.swf",disableGlobalDnd:false,chunked:true,server:this.config.uploadUrl?this.config.uploadUrl:JTWebUploader._CONS_.UPLOADER_URL,fileNumLimit:this.config.fileNumLimit,fileSingleSizeLimit:this.config.fileSingleSizeLimit,auto:this.auto});
this._bindWebUploaderHandler();this._bindEventHandler();},_bindEventHandler:function(){var a=this;$("#"+this.container).on("click",".retry",function(){a.uploader.retry();
});$("#"+this.container).on("click",".ignore",function(){if(a.finish){a.finish();}});$("#"+this.container).find(".uploadBtn").on("click",function(){if($(this).hasClass("disabled")){return false;
}if(a.state==="ready"){a.uploader.upload();}else{if(a.state==="paused"){a.uploader.upload();}else{if(a.state==="uploading"){a.uploader.stop();}}}});},_bindWebUploaderHandler:function(){var a=this;
this.uploader.onUploadProgress=function(d,b){var e=$("#"+d.id),c=e.find(".progress span");c.css("width",b*100+"%");a.percentages[d.id][1]=b;a.updateTotalProgress();
};this.uploader.onFileQueued=function(b){a.fileCount++;a.fileSize+=b.size;if(a.fileCount===1){$("#"+this.container).find(".placeholder").addClass("element-invisible");
$(".statusBar").show();}a.addFile(b);a.setState("ready");a.updateTotalProgress();};this.uploader.onFileDequeued=function(b){a.fileCount--;a.fileSize-=b.size;
if(!a.fileCount){a.setState("pedding");}a.removeFile(b);a.updateTotalProgress();};this.uploader.onUploadSuccess=function(c,b){a.success(c,b);};this.uploader.onUploadError=function(b,c){if(a.error){a.error(b,c);
}};this.uploader.on("all",function(b){switch(b){case"uploadFinished":a.setState("confirm");break;case"startUpload":a.setState("uploading");break;case"stopUpload":a.setState("paused");
break;}});this.uploader.onError=function(b){if(b=="Q_EXCEED_NUM_LIMIT"){DialogUtils.error(msgCode.ERROR,"超出上传文件数量");}else{if(b=="Q_EXCEED_SIZE_LIMIT"){DialogUtils.error(msgCode.ERROR,"超出上传文件总大小");
}else{if(b=="Q_TYPE_DENIED"){DialogUtils.error(msgCode.ERROR,"不支持该文件格式");}else{if(b=="F_EXCEED_SIZE"){DialogUtils.error(msgCode.ERROR,"单个文件大小不能超过："+a.config.fileSingleSizeLimit/(1024*1024)+"mb");
}}}}};},_showError:function(c,b){var d="";switch(c){case"exceed_size":d="文件大小超出";break;case"interrupt":d="上传暂停";break;default:d="上传失败，请重试";}var a="<p class='error'>"+d+"</p>";
$("#"+b.id).append(a);},addFile:function(e){var c=this;var f=$('<li id="'+e.id+'">'+'<p class="title">'+e.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+'<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span>'+"</div>"+"</li>");
var b=f.find("p.progress span");var a=f.find("p.imgWrap");var d=$('<p class="error"></p>');if(e.getStatus()==="invalid"){this._showError(e.statusText,e);
}else{a.text("预览中");c.uploader.makeThumb(e,function(h,i){if(h){var g=$('<img style="width:50%" src="'+ImageUtils.getFileCoverUrl(e.name)+'">');a.empty().append(g);
c.isImage=false;}else{var g=$('<img src="'+i+'">');a.empty().append(g);}},JTWebUploader._CONS_.THUMBNAIL_WIDTH,JTWebUploader._CONS_.THUMBNAIL_HEIGHT);c.percentages[e.id]=[e.size,0];
e.rotation=0;}e.on("statuschange",function(h,g){if(g==="progress"){b.hide().width(0);}else{if(g==="queued"){f.off("mouseenter mouseleave");f.find(".file-panel").remove();
}}if(h==="error"||h==="invalid"){c._showError(e.statusText,this);c.percentages[e.id][1]=1;}else{if(h==="interrupt"){c._showError("interrupt",this);}else{if(h==="queued"){c.percentages[e.id][1]=0;
}else{if(h==="progress"){d.remove();b.css("display","block");}else{if(h==="complete"){f.append('<span class="success"></span>');}}}}}f.removeClass("state-"+g).addClass("state-"+h);
});f.on("mouseenter",function(){f.find(".file-panel").stop().animate({height:30});});f.on("mouseleave",function(){f.find(".file-panel").stop().animate({height:0});
});f.on("click","span",function(){var g=$(this).index();var h=null;switch(g){case 0:c.uploader.removeFile(e);return;case 1:e.rotation+=90;break;case 2:e.rotation-=90;
break;}var i=(function(){var j=document.createElement("p").style,k="transition" in j||"WebkitTransition" in j||"MozTransition" in j||"msTransition" in j||"OTransition" in j;
j=null;return k;})();if(i){h="rotate("+e.rotation+"deg)";a.css({"-webkit-transform":h,"-mos-transform":h,"-o-transform":h,"transform":h});}else{a.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((e.rotation/90)%4+4)%4)+")");
}});f.appendTo($(".filelist"));},removeFile:function(a){var b=$("#"+a.id);delete this.percentages[a.id];this.updateTotalProgress();b.off().find(".file-panel").off().end().remove();
},updateTotalProgress:function(){var a=0;var d=0;var b=$("#"+this.container).find(".progress").children();var c=null;$.each(this.percentages,function(f,e){d+=e[0];
a+=e[0]*e[1];});c=d?a/d:0;b.eq(0).text(Math.round(c*100)+"%");b.eq(1).css("width",Math.round(c*100)+"%");this.updateStatus();},updateStatus:function(){var d="",b,c,a;
if(this.isImage){c="张";a="图片";}else{c="个";a="文件";}if(this.state==="ready"){d="选中"+this.fileCount+c+a+"，共"+WebUploader.formatSize(this.fileSize)+"。";}else{if(this.state==="confirm"){b=this.uploader.getStats();
if(b.uploadFailNum){d="已成功上传"+b.successNum+c+a+"至XX，"+b.uploadFailNum+c+a+'上传失败，<a class="retry" href="#">重新上传</a>失败'+c+'或<a class="ignore" href="#">忽略</a>';
}}else{b=this.uploader.getStats();d="共"+this.fileCount+c+a+"（"+WebUploader.formatSize(this.fileSize)+"），已上传"+b.successNum+c;if(b.uploadFailNum){d+="，失败"+b.uploadFailNum+c;
}}}$("#"+this.container).find(".statusBar .info").html(d);},setState:function(b){if(b===this.state){return;}$("#"+this.container).find(".uploadBtn").removeClass("state-"+this.state);
$("#"+this.container).find(".uploadBtn").addClass("state-"+b);this.state=b;switch(this.state){case"pedding":$("#"+this.container).find(".placeholder").removeClass("element-invisible");
$(".filelist").parent().removeClass("filled");$(".filelist").hide();$(".statusBar").addClass("element-invisible");this.uploader.refresh();break;case"ready":$("#"+this.container).find(".placeholder").addClass("element-invisible");
$(".filelist").parent().addClass("filled");$(".filelist").show();$(".statusBar").removeClass("element-invisible");this.uploader.refresh();break;case"uploading":$("#"+this.container).find(".progress").show();
$("#"+this.container).find(".uploadBtn").text("暂停上传");break;case"paused":$("#"+this.container).find(".progress").show();$("#"+this.container).find(".uploadBtn").text("继续上传");
break;case"confirm":$("#"+this.container).find(".progress").hide();$("#"+this.container).find(".uploadBtn").text("开始上传").addClass("disabled");var a=this.uploader.getStats();
if(a.successNum&&!a.uploadFailNum){this.setState("finish");return;}break;case"finish":var a=this.uploader.getStats();$("#"+this.container).find(".uploadBtn").text("开始上传").addClass("disabled");
if(a.successNum){if(this.finish){this.finish();}}else{this.state="done";}break;}this.updateStatus();}};