function Eav(a){if(!a){throw new Error("param不能为空，请检查参数是否正确");}if(!a.containerId){throw"param.containerId 不能为空";}this.formId="_"+new Date().getTime();this.attrs=[];
this.bizType=a.bizType?a.bizType:"common";this.entityType=a.entityType;this.entityTypeSelectId=a.entityTypeSelectId;this.containerId=a.containerId;this.entityId=a.entityId;
this.eavSetKey=a.eavSetKey;this.eavSetId="";this.attrKeys=null;this.isShowTag=false;if(this.bizType=="tag"){this.isShowTag=a.isShowTag;this._createFollowUpRecordModal();
this.eavRecordDataTable=null;}this._bindEventHanlder();}Eav._CONS_={LOAD_MAIN_ATTR_OPT_URL:ctx+"/gl/eav/eav/getMainAttrOptions.htm"};Eav.ID_VALUE_SEPERATOR="@==@";
Eav.prototype={setEntityId:function(a){this.entityId=a;},setEavSetKey:function(a){this.eavSetKey=a;},setRenderAloneAttrKeys:function(a){this.attrKeys=a;
},getEavSetList:function(c){var a=this;var b=ctx+"/gl/eav/eav/getEavSetList.htm";FormUtils.submit(b,{bizType:a.bizType,entityType:a.entityType},function(f){if(f.success){var e=JSON.parse(f.msg);
var g=new StringBuffer();if(e&&e.length>0){g.append("<option value=''>").append("选择属性集").append("</option>");for(var d=0;d<e.length;d++){if(c&&c===e[d].value){g.append("<option id='"+e[d].id+"' value='"+e[d].value+"' selected='selected'>").append(e[d].name).append("</option>");
}else{g.append("<option id='"+e[d].id+"' value='"+e[d].value+"'>").append(e[d].name).append("</option>");}}$("#"+a.entityTypeSelectId).empty().append(g.toString());
}else{DialogUtils.error(msgCode.ERROR,"该实体类型无对应的属性集，请前往属性集中添加数据");}}else{DialogUtils.error(msgCode.FAIL,f.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},loadMainAttrOptions:function(c,b){var a=this;if(this.bizType==="sku"){FormUtils.loadData(Eav._CONS_.LOAD_MAIN_ATTR_OPT_URL+"?eavSetKey="+c,function(d){if(d.success){b(JSON.parse(d.msg));
}else{DialogUtils.error(msgCode.FAIL,d.msg);}});}},renderEavForm:function(b){this._bindEventHanlder();var a=this;this._getEavShowView(function(d){var c=$("#"+a.containerId);
a._renderAloneAttrKeys(d);c.empty().append(a._createFormHtml(d));$(".i-checks").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",});
a._renderSummernote();a._bindFormValidation();if(a.bizType=="sku"||a.bizType=="tag"){$("#"+a.containerId).find("form legend").remove();}if(b){b(d);}});
},createCsEavTable:function(b,d){var a=this;var e=b.eavAttrValueMap;var c=false;ConfigUtils.findByKey("csEavRecord.save.isAddFollow",function(k){var o=new StringBuffer();
o.append("<table class='table table-bordered' style='text-align:center;'>");o.append("<thead>");o.append("<tr>");o.append("<th style='width: 5%;text-align:center;border-right: 2px solid rgb(242, 242, 242);'>分组</th>");
o.append("<th style='width: 5%;text-align:center;'>档案属性</th>");o.append("<th style='width: 43%;text-align:center;position:relative;'><span style='position:absolute;top:2.5px;display:none;'>档案记录</span>");
o.append("<a href='#' class='eavRecordAllDown pull-right'>全部展开</a><a href='#' class='eavRecordAllUp pull-right' style='display:none;'>全部收起</a>");o.append("<div class='cs-record-contents'><div class='col-sm-2'>日期</div><div class='col-sm-5'>内容</div><div class='col-sm-3'>附件</div></div>");
o.append("</th>");o.append("<th style='width: 43%;text-align:center;'>");o.append("<div class='col-sm-4' style='margin-top: 9px;'>操作</div>");o.append("<div class='col-sm-5' style='margin-top: 5px;'>");
o.append("<input type='checkbox' value='1' name='addFollowFlag' class='jt-middle-check' "+(k.success?"checked='checked'":"")+">保存同步到跟进");o.append("</div>");
o.append("<div class='col-sm-3 save-all-layer' style='padding: 0;'>");o.append("<button type='button' class='jt-form-select addEavRecordBatchBtn pull-left'>批量保存</button>");
o.append("</div>");o.append("</th>");o.append("</tr>");o.append("</thead>");o.append("<tbody>");for(var p in e){var g=e[p];var f=0;if(g&&g.length>0){for(var m=0;
m<g.length;m++){if(g[m].opIds){f++;var q=g[m].eavAttrOptPos;var h=g[m].opIds.split(",");var n=true;for(var l=0;l<q.length;l++){if(g[m].opIds.indexOf(q[l].id)>-1){if(n){o.append("<tr>");
o.append("<td style='width: 10%;' rowspan='"+h.length+"'>"+g[m].name+"</td>");n=false;}else{o.append("<tr>");}o.append("<td style='width: 10%;'><span class='badge badge-success' style='font-weight:500;'>"+q[l].value+"</span></td>");
o.append("<td style='width: 50%;' class='eavRecordsTd' attrVal='"+g[m].name+"' optVal='"+q[l].value+"' attrIdVal='"+g[m].id+"' optIdVal='"+q[l].id+"' optTypeVal='"+q[l].type+"' optOptionsVal='"+q[l].options+"'></td>");
o.append("<td>");o.append("<div class='col-sm-9 eavRecordTableForm' "+((q[l].type=="multi"||q[l].type=="single")?"style='padding-top: 5px;'":"")+">");o.append(a.createEavRecordContent(q[l].type,q[l].options,false));
o.append("</div>");o.append("<div class='col-sm-3 cs-record-opt' style='padding: 0;'>");o.append("<button type='button' class='jt-form-select addEavRecordBtn pull-left' style='margin-bottom: 0;' attrIdVal='"+g[m].id+"' optIdVal='"+q[l].id+"'><i class='fa fa-plus' title='保存'></i><span>保存</span></button>");
o.append("<button type='button' class='jt-form-select csTagAddFollow pull-left' style='margin: 0;' optVal='"+q[l].value+"' attrVal='"+g[m].name+"'><i class='fa fa-pencil-square-o' title='跟进'></i><span>跟进</span></button>");
o.append("</div>");o.append("</td>");o.append("</tr>");c=true;}}}}if(f==0){$(".csTagUp").trigger("click");}}}o.append("</tbody>");o.append("</table>");
d.empty().append(o.toString());a.createEavRecordHtml();$("#tagContainer").hide();if(c){$("#tagTableContainer").slideDown();}$(".csTagDown").animate({top:["-25px","swing"]},500);
$(".csTagUp").animate({top:["0px","swing"]},500);$(".tabView").css("color","#337ab7");$(".shrinkView").css("color","#c2c2c2");$(".tabView").attr("disabled",true);
$(".shrinkView").attr("disabled",false);if("isReturnVisit"==type){$(".addEavRecordBatchBtn").hide();}});},createEavRecordHtml:function(){var a=this;var b=0;
$(".eavRecordsTd").each(function(){var h=$(this).attr("attrIdVal");var j=$(this).attr("optIdVal");var d=$(this).attr("optTypeVal");var c=$(this).attr("optVal");
var g=$(this).attr("attrVal");var f=$(this).attr("optOptionsVal");var e=$(this);var i=new StringBuffer();FormUtils.loadData(ctx+"/gl/eav/eavRecord/getEavRecords.htm?entityId="+a.entityId+"&attrId="+h+"&optId="+j,function(m){var l=m.data;
if(l&&l.length>0){i.append("<div class='col-sm-10 cs-record-list'>");for(var k=0;k<l.length;k++){if(k>4){i.append("<div class='form-group eavRecordDiv eavRecordDiv-more'><a href='javascript:void(0);' class='viewFollowUpRecordBtn' attrVal='"+g+"' optVal='"+c+"' optTypeVal='"+d+"' attrIdVal="+h+" optIdVal="+j+" optOptionsVal='"+f+"'>查看更多</a></div>");
break;}if(k==0){i.append("<div class='form-group'>");e.next().find(".csTagAddFollow").attr("contentVal",l[k].content+" - "+l[k].createTime);}else{i.append("<div class='form-group eavRecordDiv' style='display:none;'>");
}i.append("<div class='col-sm-2' style='white-space: nowrap;padding:0;'>");i.append((l[k].createTime).substring(2,10));i.append("</div>");i.append("<div class='col-sm-5'><p>"+l[k].content+"</p></div>");
i.append("<div class='col-sm-3' style='padding-top: 5px;padding-bottom: 5px;'>"+a.buildImageGroup(l[k].eavRecordImgPos,b)+"</div>");if("double"==d&&k==0){i.append("<div class='col-sm-2'><a href='javascript:void(0);' class='showEavRecordLine' attrVal='"+g+"' optVal='"+c+"' attrIdVal="+h+" optIdVal="+j+" >趋势图</a></p></div>");
}i.append("</div>");b++;}i.append("</div>");i.append("<div class='col-sm-2 cs-record-more'>");i.append("<div class='cs-record-to viewFollowUpRecordBtn' attrVal='"+g+"' optVal='"+c+"' optTypeVal='"+d+"' attrIdVal="+h+" optIdVal="+j+" optOptionsVal='"+f+"'>");
i.append("更多");i.append("</div>");i.append("<div class='cs-record-pull'>");i.append("<i class='fa fa-angle-double-down eavRecordDown' title='展开'></i>");
i.append("<i class='fa fa-angle-double-up eavRecordUp' style='display:none;' title='收起'></i>");i.append("</div>");i.append("</div>");}e.empty().append(i.toString());
});});},buildImageGroup:function(c,b){if(c&&c.length>0){var d=new StringBuffer();d.append('<div class="carousel slide" style="width:80px;margin: 0 auto;" id="carousel'+b+'">');
d.append('<div class="carousel-inner" style="width:80px;">');for(var a=0;a<c.length;a++){d.append('<div class="item ');if(a==0){d.append("active ");}d.append('"><img alt="image" class="img-responsive jt-lager-img" src="'+ctx+c[a].path+'">');
d.append('<div class="carousel-caption" style="padding:0px;bottom:0px;">');d.append('<p style="background-color:rgba(0,0,0,0.3)">'+(a+1)+"<font color='#fff' font-weight='bold'>/</font> "+c.length+"</p>");
d.append("</div>");d.append("</div>");}d.append("</div>");d.append('<a data-slide="prev" href="carousel.html#carousel'+b+'" class="left carousel-control"> <span class="icon-prev" style="width:0px ! important;color:#1caf9a;margin-left:-25px !important"></span>');
d.append('</a> <a data-slide="next" href="carousel.html#carousel'+b+'" class="right carousel-control"> <span class="icon-next" style="width:0px ! important;color:#1caf9a;margin-left:-25px !important"></span>');
d.append("</a>");d.append("</div>");return d.toString();}else{return"";}},renderEavTable:function(b){var a=this;this._getEavShowView(function(d){var c=$("#"+b);
c.empty().append(a._createTableHtml(d));});},getEavParams:function(){var f={};var g="eav__"+this.bizType+"__set__id";f[g]=this.eavSetId;var d="eav__"+this.bizType+"__set__key";
f[d]=this.eavSetKey;var e="eav__"+this.bizType+"__entityid";f[e]=this.entityId;var a="eav__"+this.bizType+"__entitytype";f[a]=this.entityType;if(this.attrs&&this.attrs.length>0){for(var c=0;
c<this.attrs.length;c++){var b=this.attrs[c].formName;f[b]=this._getValueByAttrName(b);}}return $.param(f);},isValid:function(){if($("#"+this.formId).length>0){return $("#"+this.formId).valid();
}return true;},clear:function(){var b=$("#"+this.formId)[0];if(b){for(var a=0;a<b.elements.length;a++){$(document).find("span[data-toggle='tooltip']").each(function(){$(this).tooltip("hide");
});FormUtils._clearValidate($(b.elements[a]));}}this._clearLastEav();},_createFollowUpRecordModal:function(){var a=this;ConfigUtils.findByKey("csEavRecord.save.isAddFollow",function(c){var b=new StringBuffer();
b.append('<div class="modal fade" id="eavRecordContainer" tabindex="-1" role="dialog" aria-labelledby="eavRecordContainerLabel">');b.append('<div class="modal-dialog" role="document" style="width: 900px;">');
b.append('<div class="modal-content">');b.append('<div class="modal-header">');b.append('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
b.append('<h4 class="modal-title" id="eavRecordContainerLabel" style="font-weight: 500;">档案记录明细</h4>');b.append("</div>");b.append('<div class="modal-body">');
b.append("<div class='row'>");b.append("<div class='col-sm-12'>");b.append("<form id='eavRecordForm' class='form-horizontal'>");b.append("<div class='form-group'>");
b.append("<label class='col-sm-1 control-label'>档案内容</label>");b.append("<div class='col-sm-6' id='eavRecordContentDiv'>");b.append("</div>");b.append("<div class='col-sm-2'>");
b.append('<button type="button" class="jt-btn-search" id="addEavRecordBtn">记录</button>');b.append("</div>");b.append("<div class='col-sm-3'>");b.append("<input type='checkbox' value='1' name='addFollowFlag' class='jt-middle-check' "+(c.success?"checked='checked'":"")+">保存同步到跟进");
b.append("</div>");b.append("</div>");b.append("<div class='form-group'>");b.append("<label class='col-sm-1 control-label'>图片</label>");b.append('<div class="col-sm-11">');
b.append('<div class="form-group">');b.append("<div class='col-sm-3'>");b.append("<button type='button' class='jt-btn-search uploadImage' >上传图片</button>");
b.append("</div>");b.append("</div>");b.append('<div class="form-group">');b.append("<div class='col-sm-12'>");b.append("<div id='imageContainer'></div>");
b.append('<div id="recordUploader"></div>');b.append("</div>");b.append("</div>");b.append("</div>");b.append("</div>");b.append("<div class='form-group'>");
b.append("<div id='eavRecordLine' style='display:none;height:250px;width:700px;'></div>");b.append("</div>");b.append("</form>");b.append("</div>");b.append("</div>");
b.append("<div id='eavRecordTableDiv'>");b.append(a._createFollowUpTable());b.append("</div>");b.append("</div>");b.append("</div>");b.append("</div>");
b.append("</div>");if(!$("#eavRecordContainer").length){$("body").append(b.toString());}});},_createFollowUpTable:function(){var a=new StringBuffer();a.append("<table class='table table-striped table-bordered' id='eavRecordTable'>");
a.append("<thead>");a.append("<tr>");a.append('<th width="40%">档案内容</th>');a.append('<th width="40%">图片</th>');a.append('<th width="20%">记录时间</th>');a.append("</tr>");
a.append("</thead>");a.append("</table>");return a.toString();},createEavRecordContent:function(a,e,c){var f=new StringBuffer();f.append("<input type='hidden' name='optTypeVal' value='"+a+"'>");
if("multi"==a){var d=e.split("，");for(var b=0;b<d.length;b++){f.append("<div class='checkbox checkbox-success checkbox-inline'>");f.append("<input type='checkbox' value='"+d[b]+"' name='eavRecordContentInput'>");
f.append("<label for='"+d[b]+"'>"+d[b]+"</label>");f.append("</div>");}}else{if("single"==a){var d=e.split("，");for(var b=0;b<d.length;b++){f.append("<div class='radio radio-success radio-inline'>");
f.append("<input type='radio'");if(b==0){f.append("checked='checked'");}f.append("value='"+d[b]+"' name='eavRecordContentInput'>");f.append("<label for='"+d[b]+"'>"+d[b]+"</label>");
f.append("</div>");}}else{if("double"==a){if(c){f.append("<div class='col-sm-10'>");f.append("<input type='number' name='eavRecordContentInput' class='form-control' validateType='default' onkeydown='if(event.keyCode==13){return false;}' >");
f.append("</div>");}else{f.append("<input type='number' name='eavRecordContentInput' class='form-control' validateType='default' onkeydown='if(event.keyCode==13){return false;}'>");
}}else{f.append("<input type='text' name='eavRecordContentInput' class='form-control' validateType='default' onkeydown='if(event.keyCode==13){return false;}'>");
}}}return f.toString();},_clearLastEav:function(){if(this.attrKeys&&this.attrKeys.length>0){for(var a=0;a<this.attrKeys.length;a++){$("#"+this.attrKeys[a].containerId).empty();
}}$("#"+this.containerId).empty();},_renderAloneAttrKeys:function(d){if(this.attrKeys&&this.attrKeys.length>0){var c=this;var h=d.eavAttrValueMap;for(var g in h){var f=h[g];
if(f&&f.length>0){for(var e=0;e<f.length;e++){var a=new Attr(f[e],this.isShowTag);for(var b=0;b<c.attrKeys.length;b++){if(this.eavAttr.key==c.attrKeys[b].attrKey){$("#"+c.attrKeys[b].containerId).empty().append(a.toString(true));
c.attrs.push(a);}}}}}}},getEavRecordContent:function(c){var b="";var a=c.find("input[name=optTypeVal]").val();if(a=="multi"||a=="single"){c.find("input[name=eavRecordContentInput]").each(function(){if($(this).is(":checked")){b+=$(this).val()+",";
}});if(b){b=b.substring(0,b.length-1);}}else{b=c.find("input[name=eavRecordContentInput]").val();}return b;},_bindEavRecordEventHandler:function(){var a=this;
if($("#eavRecordContainer").length&&this.isShowTag){$("#eavRecordForm").on("click","input[name=addFollowFlag]",function(){if($(this).attr("checked")){$(this).removeAttr("checked");
}else{$(this).attr("checked","checked");}});$("#addEavRecordBtn").off("click").on("click",function(){var b=a.getEavRecordContent($("#eavRecordForm"));if(!b){DialogUtils.error(msgCode.ERROR,"请填写档案内容","#eavRecordContainer");
return;}$("#eavRecordForm").find("input[type=text]").val("");$("#eavRecordForm").find("input[type=number]").val("");$("#eavRecordContentDiv").find("input[type=checkbox]").removeAttr("checked");
var d=new UploadImageUtil();if($("input[name='id']").val()){var e={entityId:$("input[name='id']").val(),attrId:$(".activeEavRecord").attr("attrIdVal"),optId:$(".activeEavRecord").attr("optIdVal"),content:b,eavRecordImgJosn:JSON.stringify(d._buildImageJson())};
FormUtils.submit(ctx+"/gl/eav/eavRecord/addEavRecord.htm",e,function(f){$("#eavRecordTable").DataTable().ajax.reload();DialogUtils.success(msgCode.SUCCESS,"添加成功");
$(".uploadImage").show();$("#imageContainer").empty();});var c=$("#eavRecordForm").find("input[name=addFollowFlag]");if(c.attr("checked")){$("#csFollowForm").find("[name=type]").val("档案情况跟进");
$("#csFollowForm").find("[name=content]").val("【"+c.attr("attrVal")+"】档案属性："+c.attr("optVal")+"。档案记录："+b);$("#csFollowForm").find(".saveAddFollow").trigger("click");
}}});$(document).off("click",".addEavRecordBatchBtn").on("click",".addEavRecordBatchBtn",function(){$("#tagTableContainer").find("tbody").find("tr").each(function(){var c=$(this).find(".eavRecordTableForm");
var b=a.getEavRecordContent(c);if(!b){return;}c.find("input[type=text]").val("");c.find("input[type=number]").val("");c.find("input[type=checkbox]").removeAttr("checked");
if($("input[name='id']").val()){var e={entityId:$("input[name='id']").val(),attrId:$(this).find(".eavRecordsTd").attr("attrIdVal"),optId:$(this).find(".eavRecordsTd").attr("optIdVal"),content:b,eavRecordImgJosn:[]};
var d=$(this).find(".eavRecordsTd");if($("#tagTableContainer").find("input[name=addFollowFlag]").is(":checked")){$("#csFollowForm").find("[name=type]").val("档案情况跟进");
$("#csFollowForm").find("[name=content]").val("【"+d.attr("attrVal")+"】档案属性："+d.attr("optVal")+"。档案记录："+b);$("#csFollowForm").find(".saveAddFollow").trigger("click");
}FormUtils.submit(ctx+"/gl/eav/eavRecord/addEavRecord.htm",e,function(f){a.createEavRecordHtml();DialogUtils.success(msgCode.SUCCESS,"添加成功");});}});});
$(document).off("click",".addEavRecordBtn").on("click",".addEavRecordBtn",function(){var c=$(this).closest("td").find(".eavRecordTableForm");var b=a.getEavRecordContent(c);
if(!b){DialogUtils.error(msgCode.ERROR,"请填写档案内容");return;}c.find("input[type=text]").val("");c.find("input[type=number]").val("");c.find("input[type=checkbox]").removeAttr("checked");
if($("input[name='id']").val()){var e={entityId:$("input[name='id']").val(),attrId:$(this).attr("attrIdVal"),optId:$(this).attr("optIdVal"),content:b,eavRecordImgJosn:[]};
var d=$(this).parents("td").prev(".eavRecordsTd");if($("#tagTableContainer").find("input[name=addFollowFlag]").is(":checked")){$("#csFollowForm").find("[name=type]").val("档案情况跟进");
$("#csFollowForm").find("[name=content]").val("【"+d.attr("attrVal")+"】档案属性："+d.attr("optVal")+"。档案记录："+b);$("#csFollowForm").find(".saveAddFollow").trigger("click");
}FormUtils.submit(ctx+"/gl/eav/eavRecord/addEavRecord.htm",e,function(f){a.createEavRecordHtml();DialogUtils.success(msgCode.SUCCESS,"添加成功");});}});$(document).off("click",".showEavRecordLine").on("click",".showEavRecordLine",function(){$(".showEavRecordLine").removeClass("activeEavRecord");
$(".viewFollowUpRecordBtn").removeClass("activeEavRecord");$(this).addClass("activeEavRecord");var e=$(this).parents("td").attr("attrIdVal");var f=$(this).parents("td").attr("optIdVal");
var d=$(this).parents("td").attr("optTypeVal");var c=$(this).attr("attrVal");var b=$(this).attr("optVal");a.viewFollowUpRecord(e,f,d,null,c,b);});$("#eavRecordTable").off("dblclick","td").on("dblclick","td",function(){if($(this).index()==0){var b=$(this).text();
$(this).text("").append("<input style='width: 100%;' class='form-control' value='"+b+"'>");$(this).find("input").focus();}});$("#eavRecordTable").off("blur","td input").on("blur","td input",function(){var b=$(this).val();
var c=a.eavRecordDataTable.row($(this).parents("tr")).data();c.content=b;a.eavRecordDataTable.row($(this).parents("tr")).data(c);FormUtils.submit(ctx+"/gl/eav/eavRecord/updateEavRecord.htm",c,function(d){a.eavRecordDataTable.draw();
DialogUtils.success(msgCode.SUCCESS,"更新成功");});});$("#"+this.containerId).off("change",".hasFollowUpRecord").on("change",".hasFollowUpRecord",function(){if(a.entityId){if($(this).is(":checked")){$(this).next().find(".viewFollowUpRecordBtn").show();
}else{$(this).next().find(".viewFollowUpRecordBtn").hide();}}});$(document).off("click",".viewFollowUpRecordBtn").on("click",".viewFollowUpRecordBtn",function(){$(".viewFollowUpRecordBtn").removeClass("activeEavRecord");
$(this).addClass("activeEavRecord");var f=$(this).attr("attrIdVal");var g=$(this).attr("optIdVal");var d=$(this).attr("optTypeVal");var e=$(this).attr("optOptionsVal");
var c=$(this).attr("attrVal");var b=$(this).attr("optVal");a.viewFollowUpRecord(f,g,d,e,c,b);});$("#eavRecordContainer").off("hidden.bs.modal").on("hidden.bs.modal",function(){FormUtils.clear("eavRecordForm");
});$(document).off("click",".cs-record-pull").on("click",".cs-record-pull",function(d){var b=$(this).children(".eavRecordDown");var c=$(this).children(".eavRecordUp");
if(b.is(":visible")){b.hide();b.next().show();b.closest(".eavRecordsTd").find(".eavRecordDiv").stop().slideDown("fast");}else{if(c.is(":visible")){c.hide();
c.prev().show();c.closest(".eavRecordsTd").find(".eavRecordDiv").stop().slideUp("fast");}}});$(document).on("click",".eavRecordAllDown",function(){$(this).hide();
$(this).next().show();$(".eavRecordUp").show();$(".eavRecordDown").hide();$(".eavRecordDiv").show();});$(document).on("click",".eavRecordAllUp",function(){$(this).hide();
$(this).prev().show();$(".eavRecordUp").hide();$(".eavRecordDown").show();$(".eavRecordDiv").hide();});}},viewFollowUpRecord:function(d,g,b,i,h,c){var j=this;
if(j.entityId){$("#eavRecordContentDiv").empty().append(j.createEavRecordContent(b,i,true));$("#eavRecordContainer").modal("show");$("#eavRecordContainerLabel").text("【"+h+"—"+c+"】档案记录");
$("#eavRecordForm").find("input[name=addFollowFlag]").attr("optVal",c).attr("attrVal",h);$("#eavRecordLine").hide();$("#eavRecordTableDiv").empty().append(j._createFollowUpTable());
var e=new UploadImageUtil();e.init("recordUploader",true);$(".uploadImage").show();var f=0;var a=ctx+"/gl/eav/eavRecord/getEavRecords.htm?entityId="+j.entityId+"&attrId="+d+"&optId="+g;
j.eavRecordDataTable=$("#eavRecordTable").DataTable({ajax:{url:a},columns:[{data:"content"},{data:"eavRecordImgPos",render:function(n,m,l){if(l.eavRecordImgPos&&l.eavRecordImgPos.length>0){f++;
var o=new StringBuffer();o.append('<div class="carousel slide" style="width:120px;height:120px;" id="carousel'+f+'">');o.append('<div class="carousel-inner" style="width:120px;height:120px;">');
for(var k=0;k<l.eavRecordImgPos.length;k++){o.append('<div class="item ');if(k==0){o.append("active ");}o.append('"><img alt="image" class="img-responsive jt-lager-img" src="'+ctx+l.eavRecordImgPos[k].path+'">');
o.append('<div class="carousel-caption" style="padding:0px;top:100px;">');o.append("<p>"+(k+1)+" / "+l.eavRecordImgPos.length+"</p>");o.append("</div>");
o.append("</div>");}o.append("</div>");o.append('<a data-slide="prev" href="carousel.html#carousel'+f+'" class="left carousel-control"> <span class="icon-prev"></span>');
o.append('</a> <a data-slide="next" href="carousel.html#carousel'+f+'" class="right carousel-control"> <span class="icon-next"></span>');o.append("</a>");
o.append("</div>");return o.toString();}else{return"";}}},{data:"createTime"},],rowId:"id",lengthMenu:[[10,20],[10,20]],paging:true,pageLength:10,pagingType:"simple",lengthChange:false,ordering:true,searching:false,order:[[2,"desc"]],fnInitComplete:function(l,k){if(b=="double"){j.showEavRecordLine();
}},fnDrawCallback:function(l,k){if(b=="double"&&l.iDraw>=3){j.showEavRecordLine();}}});}},showEavRecordLine:function(){var c=$("#eavRecordTable").get(0);
var b=[];var e=1;for(var d=c.rows.length-1;d>0;d--){var f={count:e,content:c.rows[d].cells[0].innerHTML};e++;b.push(f);}$("#eavRecordLine").show();var a=new Report();
a.data=b;a.setLegend(false,null,"count");a.setBarSeriesStyle(true,"right","{c}");a.initSeries([{type:"line",colName:"content",legendName:"数据"}],"count");
a._initChart("eavRecordLine","");},_bindEventHanlder:function(){var a=this;this._bindEavRecordEventHandler();$("#"+a.entityTypeSelectId).off("change").on("change",function(){a.eavSetKey=$(this).val();
if(a.eavSetKey){a.renderEavForm();}});$("#"+a.containerId).off("click",".selectSystemFile").on("click",".selectSystemFile",function(){var b=$(this).attr("containerId");
FileUtils.selectFile(0,function(c){$("#"+b).empty().append(FileUtils.createFileDivStr(c));});});$("#"+a.containerId).off("click",".selectImageBtn").on("click",".selectImageBtn",function(){var b=$(this).attr("containerId");
FileUtils.selectImage(0,function(c){$("#"+b).empty().append(ImageUtils.createImageDivStr(c));});});},_getInputTypeFromAttrName:function(a){var c=a.indexOf("__",5)+2;
var b=a.substring(c,a.indexOf("__",c));return b;},_getValueByAttrName:function(a){var d="";var c=this._getInputTypeFromAttrName(a);switch(c){case"input":case"textarea":d=$(c+"[name='"+a+"']").val();
break;case"radio":case"checkbox":$("input[name='"+a+"']").each(function(){if($(this).is(":checked")){d+=$(this).attr("value")+Eav.ID_VALUE_SEPERATOR+$(this).attr("idValue")+",";
}});break;case"select":$("select[name='"+a+"']").children().each(function(){if($(this).is(":selected")){d+=$(this).attr("value")+Eav.ID_VALUE_SEPERATOR+$(this).attr("idValue")+",";
}});break;case"texteditor":d=SummernoteUtils.getCode(a+"Container");break;case"attach_file":case"attach_img":var b=$("#"+a+"Container").find("div.file").eq(0);
if(b.length){d=b.attr("urlVal")+Eav.ID_VALUE_SEPERATOR+b.attr("nameVal");if(d.indexOf("\\")!=-1){d=d.replace(/\\/ig,"/");}}break;}return d;},_getEavShowView:function(c){var a=this;
if(!a.eavSetKey){return;}a.attrs=[];var b=ctx+"/gl/eav/eav/getEavShowView.htm";FormUtils.submit(b,{eavSetKey:a.eavSetKey,entityId:a.entityId},function(e){if(e.success){var d=JSON.parse(e.msg);
this.eavSetId=d.eavSetPo.id;if(c!=null){c(d);}}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);
});},_renderSummernote:function(){if($(".eavSummernote").length){SummernoteUtils.init({},"eavSummernote");}},_createTableHtml:function(d){var g=this;var n=d.eavAttrValueMap;
var a=new StringBuffer();a.append("<table class='table table-bordered table-striped'>");for(var c in n){var h=n[c];if(h&&h.length>0){a.append("<tr>");a.append("<th colspan='2' style='text-align:center;'>"+c+"</th>");
for(var m=0;m<h.length;m++){var k=new Attr(h[m],this.isShowTag);if(k.eavAttr.dataType=="options"){var s=k.eavAttr.name;var l=k.eavAttr.opLabelNames;a.append("<tr>");
a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");a.append("<td style='text-align:left; width: 80%;'>"+l+"</td>");a.append("</tr>");
}else{var s=k.eavAttr.name;var i=k.getValue();if(k.eavAttr.inputType=="single_attach_file"){if(!i){a.append("<tr>");a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");
a.append("<td style='text-align:left; width: 80%;'>"+"无附件"+"</td>");a.append("</tr>");}else{var p=i.split(Eav.ID_VALUE_SEPERATOR);var b=p[0];var r=p[1];
var q={name:r,url:b};var e=FileUtils.createFileDivStr([q],true);a.append("<tr>");a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");
a.append("<td style='text-align:left; width: 80%;'>"+e+"</td>");a.append("</tr>");}}else{if(k.eavAttr.inputType=="single_attach_img"){if(!i){a.append("<tr>");
a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");a.append("<td style='text-align:left; width: 80%;'>"+"<img src='"+ctx+"/img/jt/nophoto.png"+"' style='width: 80px; height: 80px;' alt='图片丢失了'>"+"</td>");
a.append("</tr>");}else{var p=i.split(Eav.ID_VALUE_SEPERATOR);var b=p[0];var o=p[1];var f={name:o,url:b};var e=ImageUtils.getUrl(f,"mm");a.append("<tr>");
a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");a.append("<td style='text-align:left; width: 80%;'>"+"<img src='"+e+"' style='width: 80px; height: 80px;' alt='图片丢失了'>"+"</td>");
a.append("</tr>");}}else{a.append("<tr>");a.append("<td style='text-align:right; width: 20%;'><strong>"+s+" : </strong></td>");a.append("<td style='text-align:left; width: 80%;'>"+i+"</td>");
a.append("</tr>");}}}}}}a.append("</table>");return a.toString();},_createFormHtml:function(i){var k=this;var b=i.eavAttrValueMap;var f=new StringBuffer();
f.append("<form id='"+k.formId+"' class='form-horizontal' >");for(var h in b){var a=b[h];if(a&&a.length>0){f.append("<fieldset>");f.append("<legend style='font-size:14px;font-weight:bold;padding-left:5px;'>").append(h).append("</legend>");
var g=false;var d=0;for(var c=0;c<a.length;c++){var e=new Attr(a[c],this.isShowTag);if(k._inAloneAttrKeys(e.eavAttr.key)){continue;}if(k._isFormGroup(e)){if(g){g=false;
f.append("</div>");d=0;}f.append("<div class='form-group'>");f.append(e.toString());f.append("</div>");}else{if(d%4==0){g=true;if(d==0){f.append("<div class='form-group'>");
}else{f.append("</div>");f.append("<div class='form-group'>");}}d++;f.append(e.toString());if(c==(a.length-1)){g=false;f.append("</div>");}}k.attrs.push(e);
}}f.append("</fieldset>");}f.append("</form>");return f.toString();},_bindFormValidation:function(){if(this.attrs&&this.attrs.length){var g={};for(var e=0;
e<this.attrs.length;e++){var d=this.attrs[e].eavAttr.validateKey;if(d){if(d.indexOf(",")!=-1){var a=d.split(",");var f={};for(var c=0;c<a.length;c++){f[a[c]]=true;
}g[this.attrs[e].formName]=f;}else{var f={};f[d]=true;g[this.attrs[e].formName]=f;}}}}var b={rules:g,messages:{}};FormUtils.bindFormValidation(this.formId,b);
},_isFormGroup:function(a){return a.eavAttr.inputType==Attr._CONS_.SINGLE.TEXTAREA||a.eavAttr.inputType==Attr._CONS_.SINGLE.TEXTEDITOR||a.eavAttr.inputType==Attr._CONS_.SINGLE.ATTACH_FILE||a.eavAttr.inputType==Attr._CONS_.SINGLE.ATTACH_IMG||a.eavAttr.inputType==Attr._CONS_.OPTION.RADIO||a.eavAttr.inputType==Attr._CONS_.OPTION.CHECKBOX;
},_inAloneAttrKeys:function(b){if(this.attrKeys==null||this.attrKeys.length==0){return false;}for(var a=0;a<this.attrKeys.length;a++){if(this.attrKeys[a].attrKey==b){return true;
}}return false;}};