function SendMessage(){this.hadInit=false;}SendMessage._CONS_={LIST_DATA_URL:ctx+"/gl/sms/smsRecord/findByCsId.htm",SEND_MSG_URL:ctx+"/gl/sms/smsRecord/sendMsg.htm",SEND_ALI_TEMPLATE_URL:ctx+"/gl/sms/smsRecord/sendAliTemplateMsg.htm",RE_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/resend.htm",JUDGE_IS_PHONE_URL:ctx+"/crm/cs/csEntity/judgeIsPhone.htm",BATCH_SEND_MSG_URL:ctx+"/gl/sms/smsRecord/batchSendMsg.htm",DIV:"#smsRecordGridDiv",GRID:"#smsRecordGrid",PAGER:"#smsRecordPager",GRID_ID:"smsRecordGrid",PAGER_ID:"smsRecordPager"};
SendMessage.prototype={init:function(a){if(!this.hadInit){this.hadInit=true;this._bindEventHander();}this._initSelectPlatformType();},_initSelectPlatformType:function(){if("y"==isOpenSelectPlatform){$("body").find(".smsSelectPlatformDiv").show();
}else{$("body").find(".smsSelectPlatformDiv").remove();}},_bindEventHander:function(){var a=this;$("body").on("click",".resendMsg",function(){a.reSendMsg($(this).attr("attr-id"));
});$("body").on("click",".deleteMsgBtn",function(){var b=$(this).attr("idVal");DialogUtils.confirm(function(){FormUtils.submit(ctx+"/gl/sms/smsRecord/delete.htm",{ids:b},function(){a.initTable(a.initParam);
});});});},initTable:function(e){var a=this;a.initParam=e;$("#sendMessageForm").find("[name=sendContent]").attr("disabled",false);var d="";if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){d="<th>操作</th>";
}$("#smsRecordDiv").empty().append("<table class='table table-bordered table-stripped' id='smsRecordTable'>            <thead>                <tr>                    <th></th>                    <th>手机号码</th>                    <th>短信内容</th>                    <th>收发</th>                    <th>平台</th>                    <th>结果</th>                    <th>发送人</th>                    <th>时间</th>"+d+"</tr>            </thead>        </table>");
var b=SendMessage._CONS_.LIST_DATA_URL+"?csId="+e.csId;var c=[{data:"lineNum"},{data:"mobile"},{data:"content"},{data:"type",render:function(f){if(f=="send"){return"<span class='text-success'>发送</span>";
}else{return"<span class='text-primary'>收到</span>";}}},{data:"platform",render:function(g){var f="短信猫";if(g){if(g.startsWith("gst")){f="高斯通";}else{if(g.startsWith("lsm")){f="螺丝帽";
}else{if(g.startsWith("ali")){f="阿里";}}}}return f;}},{data:"result",render:function(f,h,g){if(f=="SUCCESS"){return"<span class='text-success'>成功</span>";
}else{if(f=="WAITING-CONFIRM"){return"<span class='text-warning'>审核中</span>";}else{if(f=="WAITING-SEND"){return"<span class='text-warning'>等待发送</span>";
}else{if(f.indexOf("SENDING")>-1){return"<span class='text-warning'>发送中</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}else{if(f.indexOf("UNPASS-CONFIRM")>-1){return"<span class='text-danger'>不通过</span>";}else{return"<span class='text-danger'>失败</span>&nbsp;&nbsp;"+"<button class='btn btn-sm btn-primary btn-outline resendMsg' attr-id='"+g.id+"' type='button'>重发</button>";
}}}}}}},{data:"employeeAid",render:function(h,g,f){if(f.type=="send"){return h;}else{return"无";}}},{data:"createTime"}];if(ResUtils.canShow("csEntity.smsRecord.button.deleteMy")||ResUtils.canShow("csEntity.smsRecord.button.deleteSub")||ResUtils.canShow("csEntity.smsRecord.button.deleteSearch")){c.push({data:"createTime",width:"10%",render:function(h,g,f){return"<button class='btn btn-sm btn-danger btn-outline deleteMsgBtn' idVal='"+f.id+"' type='button'>删除</button>";
}});}$("#smsRecordTable").DataTable({ajax:{url:b},searching:false,columns:c,rowId:"id",lengthMenu:[[20]],paging:true,pagingType:"simple",lengthChange:false,autoWidth:false,ordering:true,order:[[0,"asc"]]});
},openSendMessageView:function(c){var a=this;a.initForm();$("#sendMessageModalLabel").text("TO："+c.maskNum);var b=$("#sendMessageForm");b.find("[name=csId]").val(c.csId);
b.find("[name=sendPhoneNum]").val(c.number);b.find("[name=replyId]").val(c.replyId);$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){var d=b.find("[name=sendContent]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var e=new CateOptService();e.isHasSensitiveWord(d,function(j){if(j.isCanSendMsg!=null&&!j.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+j.msg,$("#sendMessageContainer"));
}else{var g=b.find("[name=csId]").val();var h=b.find("[name=sendPhoneNum]").val();var f=b.find("[name=replyId]").val();var i=b.find("[name=selectPlatformType]").val();
var k={csId:g,phone:h,sendContent:encodeURIComponent(d),selectPlatformType:i,replyId:f};$("#sendStatus").text("发送中...");FormUtils.submit(SendMessage._CONS_.SEND_MSG_URL,k,function(l){if(l.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,l.msg);$("#sendMessageContainer").modal("hide");}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,l.msg);
}},function(){DialogUtils.error(msgCode.ERROR,"发送异常");});}});});},openBatchSendMessageView:function(c){var a=this;a._initSelectPlatformType();$("#sendMessageModalLabel").html("批量发短信&emsp;<span>批量给<font style='color:red;'>【"+c.csIds.length+"个】</font>个客户发短信<span>");
var b=$("#sendMessageForm");b.find("[name=sendContent]").val("");$("#sendMessageContainer").modal("show");a.getTplOptions({container:"smsTpl",caption:"请选择",type:"sms",cateId:"customer",fn:function(d){b.find("[name=sendContent]").val(d);
}});$("#sendStatus").text("");$("#sendMessageSave").off("click").on("click",function(){DialogUtils.confirmWithOptions({title:"确定批量发短信？",text:"",confirmButtonText:"确定",yesFunc:function(){var f=c.csIds;
var d=b.find("[name=sendContent]").val();var e=b.find("[name=selectPlatformType]").val();if(!d||$.trim(d).length==0){DialogUtils.error(msgCode.ERROR,"短信内容不能为空",$("#sendMessageContainer"));
return;}var g=new CateOptService();g.isHasSensitiveWord(d,function(h){if(h.isCanSendMsg!=null&&!h.isCanSendMsg){DialogUtils.error(msgCode.ERROR,"短信中存在敏感词："+h.msg,$("#sendMessageContainer"));
}else{var i={"sendContent":encodeURIComponent(d),"csIds":f,selectPlatformType:e};FormUtils.submit(SendMessage._CONS_.BATCH_SEND_MSG_URL,i,function(j){if(j.success){$("#sendStatus").text("操作成功");
DialogUtils.success(msgCode.SUCCESS,j.msg);}else{$("#sendStatus").text("发送失败");DialogUtils.error(msgCode.ERROR,j.msg);}},null);}});}});});},openAilTemplateMessageView:function(b){var a=this;
$("#aliTemplateModalCsIds").val(b.csIds);a.getAliTemplateSms();$("#aliTemplateModal").modal("show");$("#aliTemplateModal").removeAttr("tabindex");},initForm:function(){var a=$("#sendMessageModalLabel");
a.find("[name=csId]").val("");a.find("[name=sendPhoneNum]").val("");a.find("[name=sendContent]").val("");a.find(".tabli").removeClass("active").eq(0).addClass("active");
a.find(".tab-pane").removeClass("active").removeClass("in").eq(0).addClass("active").addClass("in");this._initSelectPlatformType();},reSendMsg:function(d){var a=this;
var b=SendMessage._CONS_.RE_SEND_MSG_URL;var c={"ids":d};DialogUtils.success(msgCode.SUCCESS,"发送中...");FormUtils.submit(b,c,function(e){if(e.success){a.initTable(a.initParam);
DialogUtils.success(msgCode.SUCCESS,e.msg);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},null,true);},getTplOptions:function(c){var a=this;if(!c.type||!c.cateId){return;
}var b=window.sessionStorage.getItem("t9-ecm-loacaltpl"+c.type+c.cateId);if(b&&b!=null&&b!=""){a._apendData(c,JSON.parse(b));}else{FormUtils.loadData(ctx+"/gl/tpl/glTpl/findTplByTypeAndCateId.htm?type="+c.type+"&cateId="+c.cateId,function(d){window.sessionStorage.setItem("t9-ecm-loacaltpl"+c.type+c.cateId,JSON.stringify(d));
a._apendData(c,d);});}},getAliTemplateSms:function(){FormUtils.loadData(ctx+"/gl/tpl/glTpl/findAliTemplateSms.htm",function(a){var c=new StringBuffer();
if(a.length>0){var c=new StringBuffer();c.append('<option value="">请选择</option>');for(var b=0;b<a.length;b++){c.append("<option value='"+a[b].type+"' content='"+a[b].content+"'>"+a[b].templateName+"</option>");
}$(".aliTemplateModalSelect").empty().append(c.toString()).select2();}});},_apendData:function(c,a){var f;if(c.container){f=$("#"+c.container);if(f.length==0){f=$("select."+c.container);
if(f.length==0){f=$("select[name='"+c.container+"']");if(f.length==0){return false;}}}}var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");
}if(a&&a.length>0){var g=new StringBuffer();if(c.caption){g.append("<option value=''>").append(c.caption).append("</option>");}for(var d=0;d<a.length;d++){var e=a[d].tplContent;
var b=a[d].name;if(c.selectedOption&&c.selectedOption==e){g.append("<option value='").append(e).append("'>").append(b).append("</option>");}else{g.append("<option value='").append(e).append("'>").append(b).append("</option>");
}}f.empty().append(g.toString());}f.off("change").on("change",function(){var h=c.fn;if(h&&typeof h==="function"){h(f.val());}});}};