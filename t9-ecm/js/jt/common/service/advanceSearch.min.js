function QueryPlan(a,b,c){if(!(this instanceof QueryPlan)){return new QueryPlan(a,b,c);}else{this.name=a;this.isDefault=b;this.conditionList=c;}}QueryPlan.prototype={toString:function(){return JSON.stringify(this);
},toJson:function(){return this.toString();}};function Condition(a,c,b){if(this instanceof Condition){this.col=a;this.op=c;this.value=b;}else{return new Condition(a,c,b);
}}Condition.prototype={toString:function(){return"col:"+col+",op:"+op+"value:"+value;}};function AdvanceSearch(){this.searchCols=[];this.searchPlans=[];
this.currentPlanId="";this.table="";this.jqgridReloadMethod=null;}AdvanceSearch.prototype={setBelongToTable:function(a){this.table=a;},setSearchCols:function(a){this.searchCols=a;
},setJqgridReloadMethod:function(a){this.jqgridReloadMethod=a;},init:function(){this._bindEventHandler();this._addFirstQueryCondition();this._loadQueryPlanList();
},getSearchParams:function(){var a=this;var b={};$("#advanceQueryContainer").children("div[class='row']").eq(0).children("div[class='form-group']").each(function(){var d=$(this).children("div");
var c=d.eq(0).children("select").val();var g=d.eq(1).children("select").val();var e=null;var f=d.eq(2);if(f.children("div").size()>0){e=[];e.push(f.children("div").eq(0).children("input").val());
e.push(f.children("div").eq(1).children("input").val());}else{e=f.children("input").val();}b[a._getSearchParamName(c,g)]=e;});return b;},_addFirstQueryCondition:function(){this.addQueryCondition();
},_switchToCurrentQueryPlan:function(){if(this._getCurrentQueryPlan()==null){return;}var a=this;$("#queryPlanContainer").children("div").each(function(){if($(this).attr("planId")==a.currentPlanId){$(this).addClass("activeQueryPlan");
}else{if($(this).hasClass("activeQueryPlan")){$(this).removeClass("activeQueryPlan");}}});$("#searchPlanSelect").find("option[value='"+this.currentPlanId+"']").attr("selected","selected");
var c=a._getCurrentQueryPlan();$("#planName").val(c.name);var f=c.isDefault=="y";if(f){$("[name='isDefault']:checkbox").prop("checked",true);}else{$("[name='isDefault']:checkbox").removeAttr("checked");
}if(this.searchPlans&&this.searchPlans.length>0){$("#advanceQueryContainer").children("div").eq(0).empty();for(var d=0;d<this.searchPlans.length;d++){if(this.searchPlans[d].id==this.currentPlanId){var e=JSON.parse(this.searchPlans[d].queryData);
for(var b=0;b<e.length;b++){this.addQueryCondition(e[b]);}break;}}this.jqgridReloadMethod(this.getSearchParams());}},addQueryCondition:function(g){var f=new StringBuffer();
f.append("<div class='form-group' style='margin-left:2px; margin-right:2px;'>");f.append("<div class='col-sm-3 resetRowPadding'>");f.append("<select id='condition' class='colNameSelect form-control'>");
if(this.searchCols&&this.searchCols.length>0){for(var d=0;d<this.searchCols.length;d++){if(g&&g.col==this.searchCols[d].colName){f.append("<option selected='selected' value='"+this.searchCols[d].colName+"'>"+this.searchCols[d].name+"</option>");
}else{f.append("<option value='"+this.searchCols[d].colName+"'>"+this.searchCols[d].name+"</option>");}}}f.append("</select>");f.append("</div>");f.append("<div class='col-sm-2 resetRowPadding'>");
f.append("<select class='opSelect form-control'>");if(this.searchCols&&this.searchCols.length>0){if(g){if(this._isEav(g.colName)){f.append(this._getEavDataTypeOptions(this._getDataType(g.col),g.op));
}else{f.append(this._getDataTypeOptions(this._getDataType(g.col),g.op));}}else{if(this._isEav(this.searchCols[0].colName)){f.append(this._getEavDataTypeOptions(this.searchCols[0].dataType));
}else{f.append(this._getDataTypeOptions(this.searchCols[0].dataType));}}}f.append("</select>");f.append("</div>");f.append("<div class='col-sm-6 resetRowPadding'>");
if(g&&g.op=="BW"){var e=g.col;var c=this._getDataType(e);var b="";var a="";if(typeof g.value!="undefined"){b=g.value.split(",")[0];a=g.value.split(",")[1];
}if(c=="D"){f.append("<div class='col-sm-6 resetRowPadding'>"+"<input value='"+b+"' name='endTime' class='laydate-icon form-control layer-date' placeholder='YYYY-MM-DD' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
f.append("</div>");f.append("<div class='col-sm-6 resetRowPadding'>");f.append("<input value='"+a+"' name='endTime' class='laydate-icon form-control layer-date' placeholder='YYYY-MM-DD' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
f.append("</div>");}else{f.append("<div class='col-sm-6 resetRowPadding'>");f.append("<input  value='"+b+"'  type='text' class='form-control' placeholder='起始值'>");
f.append("</div>");f.append("<div class='col-sm-6 resetRowPadding'>");f.append("<input  value='"+a+"'  type='text' class='form-control' placeholder='结束值'>");
f.append("</div>");}}else{if(g){f.append("<input value='"+g.value+"' type='text' class='form-control'>");}else{f.append("<input type='text' class='form-control'>");
}}f.append("</div>");f.append("<p class='text-center deleteCondition col-sm-1 resetRowPadding'>x</p>");f.append("</div>");$("#advanceQueryContainer").children("div").eq(0).append(f.toString());
},_createQueryPlanSelect:function(){var a=this;if(a.searchPlans&&a.searchPlans.length>0){var c=new StringBuffer();c.append("<option value=''>请选择查询方案</option>");
for(var b=0;b<a.searchPlans.length;b++){if(a.searchPlans[b].isDefault=="y"){c.append("<option value='"+a.searchPlans[b].id+"'>").append(a.searchPlans[b].name+"（默认）").append("</>");
}else{c.append("<option value='"+a.searchPlans[b].id+"'>").append(a.searchPlans[b].name).append("</>");}}$("#searchPlanSelect").empty().append(c.toString());
}else{var c=new StringBuffer();c.append("<option value==''>无查询方案</option>");$("#searchPlanSelect").empty().append(c.toString());}},_createQueryPlans:function(){var a=this;
if(a.searchPlans&&a.searchPlans.length>0){var c=new StringBuffer();for(var b=0;b<a.searchPlans.length;b++){c.append("<div planId='"+a.searchPlans[b].id+"' class='col-sm-12 queryPlan'>");
if(a.searchPlans[b].isDefault=="y"){c.append("<span class='col-sm-11 querySpanTitle'>"+a.searchPlans[b].name+"（默认）"+"</span>");}else{c.append("<span class='col-sm-11 querySpanTitle'>"+a.searchPlans[b].name+"</span>");
}c.append("<span planId='"+a.searchPlans[b].id+"' class='text-center deleteQueryPlan col-sm-1'>x</span>");c.append("</div>");}$("#queryPlanContainer").find("div").remove();
$(c.toString()).insertAfter($("#queryPlanContainer").children("h3").eq(0));a._switchToCurrentQueryPlan();}},_loadQueryPlanList:function(){var b=ctx+"/crm/ou/query/listData.htm";
var a=this;FormUtils.loadData(b+"?entityType="+a.table,function(d){if(d.success){var c=JSON.parse(d.msg);a.searchPlans=c;a._createQueryPlans();a._createQueryPlanSelect();
}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},_getCurrentQueryPlan:function(){if(this.searchPlans&&this.searchPlans.length>0){for(var a=0;a<this.searchPlans.length;
a++){if(this.searchPlans[a].id==this.currentPlanId){return this.searchPlans[a];}}}return null;},_getQueryPlanByName:function(a){if(this.searchPlans&&this.searchPlans.length>0){for(var b=0;
b<this.searchPlans.length;b++){if(this.searchPlans[b].name==a){return this.searchPlans[b];}}}return null;},_createNewQueryPlanHtml:function(a){var b=new StringBuffer();
b.append("<div planId='"+a.id+"' class='col-sm-12 queryPlan'>");if(a.isDefault=="y"){b.append("<span class='col-sm-11 querySpanTitle'>"+a.name+"（默认）"+"</span>");
}else{b.append("<span class='col-sm-11 querySpanTitle'>"+a.name+"</span>");}b.append("<span planId='"+a.id+"' class='text-center deleteQueryPlan col-sm-1'>x</span>");
b.append("</div>");return b.toString();},_addQueryPlan:function(c){var a=this;var b=ctx+"/crm/ou/query/saveAdd.htm";FormUtils.submit(b,{entityType:a.table,queryPlanJson:c.toString()},function(d){if(d.success){a._loadQueryPlanList();
DialogUtils.success(msgCode.SUCCESS,"保存成功");}else{DialogUtils.error(msgCode.ERROR,d.msg);}});},_getSearchParamName:function(a,e){var c=false;for(var b=0;
b<this.searchCols.length;b++){if(this.searchCols[b].colName==a){c=this.searchCols[b].isEav;}}var d="";if(c){d="Q__"+this._getDataType(a)+"__"+e+"__"+"eav."+a;
}else{d="Q__"+this._getDataType(a)+"__"+e+"__"+a;}return d;},_getDataType:function(c){var a=this;for(var b=0;b<a.searchCols.length;b++){if(a.searchCols[b].colName==c){return a.searchCols[b].dataType;
}}return"";},_getEavDataTypeOptions:function(b,c){var a="";switch(b){case"INT":a="N";break;case"D":a="D";break;default:a="S";break;}return this._getDataTypeOptions(a,c);
},_isEav:function(c){var a=this;for(var b=0;b<a.searchCols.length;b++){if(a.searchCols[b].colName==c){return a.searchCols[b].isEav;}}return false;},_getDataTypeOptions:function(a,c){var b=new StringBuffer();
switch(a){case"S":if(c=="EQ"){b.append("<option selected='selected' value='EQ'>等于</option>");b.append("<option value='LK'>包含</option>");b.append("<option value='NEQ'>不等于</option>");
}else{if(c=="NEQ"){b.append("<option value='EQ'>等于</option>");b.append("<option value='LK'>包含</option>");b.append("<option selected='selected' value='NEQ'>不等于</option>");
}else{if(c=="LK"){b.append("<option value='EQ'>等于</option>");b.append("<option selected='selected' value='LK'>包含</option>");b.append("<option  value='NEQ'>不等于</option>");
}else{b.append("<option value='EQ'>等于</option>");b.append("<option value='LK'>包含</option>");b.append("<option  value='NEQ'>不等于</option>");}}}break;case"D":if(c=="EQ"){b.append("<option selected='selected' value='EQ'>相等</option>");
b.append("<option value='BW'>区间</option>");}else{if(c=="BW"){b.append("<option value='EQ'>相等</option>");b.append("<option selected='selected' value='BW'>区间</option>");
}else{b.append("<option value='EQ'>相等</option>");b.append("<option value='BW'>区间</option>");}}break;case"N":if(c=="EQ"){b.append("<option selected='selected' value='EQ'>相等</option>");
b.append("<option value='GT'>大于</option>");b.append("<option value='GTE'>大于等于</option>");b.append("<option value='LT'>小于</option>");b.append("<option value='LTE'>小于等于</option>");
b.append("<option value='BW'>区间</option>");}else{if(c=="GT"){b.append("<option value='EQ'>相等</option>");b.append("<option value='GT'>大于</option>");b.append("<option selected='selected' value='GT'>大于等于</option>");
b.append("<option value='LT'>小于</option>");b.append("<option value='LT'>小于等于</option>");b.append("<option value='BW'>区间</option>");}else{if(c=="LT"){b.append("<option value='EQ'>相等</option>");
b.append("<option value='GT'>大于</option>");b.append("<option value='GTE'>大于等于</option>");b.append("<option selected='selected' value='LT'>小于</option>");
b.append("<option value='LTE'>小于等于</option>");b.append("<option value='BW'>区间</option>");}else{if(c=="BW"){b.append("<option value='EQ'>相等</option>");b.append("<option value='GT'>大于</option>");
b.append("<option value='GTE'>大于等于</option>");b.append("<option value='LT'>小于</option>");b.append("<option selected='selected' value='LTE'>小于等于</option>");
b.append("<option value='BW'>区间</option>");}else{if(c=="LTE"){b.append("<option value='EQ'>相等</option>");b.append("<option value='GT'>大于</option>");b.append("<option value='GT'>大于等于</option>");
b.append("<option value='LT'>小于</option>");b.append("<option value='LT'>小于等于</option>");b.append("<option value='BW'>区间</option>");}else{if(c=="GTE"){b.append("<option value='EQ'>相等</option>");
b.append("<option value='GT'>大于</option>");b.append("<option selected='selected' value='GTE'>大于等于</option>");b.append("<option value='LT'>小于</option>");
b.append("<option value='LTE'>小于等于</option>");b.append("<option value='BW'>区间</option>");}else{b.append("<option value='EQ'>相等</option>");b.append("<option value='GT'>大于</option>");
b.append("<option value='GTE'>大于等于</option>");b.append("<option value='LT'>小于</option>");b.append("<option value='LTE'>小于等于</option>");b.append("<option value='BW'>区间</option>");
}}}}}}break;}return b.toString();},_deleteQueryPlan:function(b){if(this.searchPlans&&this.searchPlans.length>0){for(var a=0;a<this.searchPlans.length;a++){if(this.searchPlans[a].id==b){this.searchPlans.splice(a,1);
break;}}$("#advanceQueryContainer").children("div[class='row']").eq(0).empty();$("#searchPlanSelect option[value='"+b+"']").remove();}},_getQueryPlanConditionList:function(){var a=[];
$("#advanceQueryContainer").children("div[class='row']").eq(0).children("div[class='form-group']").each(function(){var c=$(this).children("div");var b=c.eq(0).children("select").val();
var g=c.eq(1).children("select").val();var e=c.eq(2);var d="";if(g=="BW"){if(e.children("div").size()>0){d=e.children("div").eq(0).children("input").val()+","+e.children("div").eq(1).children("input").val();
}else{d=e.children("input").val();}}else{d=c.children("input").val();}var f=new Condition(b,g,d);a.push(f);});return a;},_strLen:function(c){var a=0;for(var b=0;
b<c.length;b++){if(c.charCodeAt(b)>127||c.charCodeAt(b)==94){a+=2;}else{a++;}}return a;},_getQueryPlan:function(){var a=$("#planName").val();if(!a){showError("错误","查询方案名称不能为空");
$("#planName").focus();return null;}if(this._strLen(a)>16){showError("错误","查询方案名字长度过长，请重新输入");$("#planName").focus();return null;}var c=$("input[name='isDefault']").is(":checked")?"y":"n";
var b=new QueryPlan(a,c,this._getQueryPlanConditionList());$("#planName").val("");$("[name='isDefault']:checkbox").attr("checked",false);return b;},_updateQueryPlan:function(){var b=this._getCurrentQueryPlan();
b.conditionList=this._getQueryPlanConditionList();var a=new QueryPlan(b.name,b.isDefault,b.conditionList);this._addQueryPlan(a);},_bindEventHandler:function(){var a=this;
$(document).on("change","#searchPlanSelect",function(){var b=$(this).val();if(b==""){a.currentPlanId="";a.jqgridReloadMethod({});}else{a.currentPlanId=b;
a._switchToCurrentQueryPlan();}});$("#advanceQueryContainer").on("change",".colNameSelect",function(){var c=$(this).val();var b=a._getDataType(c);if(b=="D"){$(this).parent().next().next().empty().append("<input class='laydate-icon form-control layer-date' placeholder='时间' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
}else{$(this).parent().next().next().empty().append("<input type='text' class='form-control'>");}if(a._isEav(c)){$(this).parent().next().children("select").eq(0).empty().append(a._getEavDataTypeOptions(b));
}else{$(this).parent().next().children("select").eq(0).empty().append(a._getDataTypeOptions(b));}});$("#advanceQueryContainer").on("change",".opSelect",function(){var d=$(this).parent().prev().children("select").val();
var f=$(this).val();var b=a._getDataType(d);if(f=="BW"){var e=new StringBuffer();if(b=="D"){e.append("<div class='col-sm-6 resetRowPadding'>");e.append("<input class='laydate-icon form-control layer-date' placeholder='开始时间' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
e.append("</div>");e.append("<div class='col-sm-6 resetRowPadding'>");e.append("<input class='laydate-icon form-control layer-date' placeholder='结束时间' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
e.append("</div>");}else{e.append("<div class='col-sm-6 resetRowPadding'>");e.append("<input type='text' class='form-control' placeholder='起始值'>");e.append("</div>");
e.append("<div class='col-sm-6 resetRowPadding'>");e.append("<input type='text' class='form-control' placeholder='结束值'>");e.append("</div>");}$(this).parent().next().empty().append(e.toString());
}else{var c=$(this).parent().next();if(c.children("div").size()>0){if(b=="D"){c.empty().append("<input class='laydate-icon form-control layer-date' placeholder='开始时间' onclick=\"laydate({istime: true, format: 'YYYY-MM-DD'})\">");
}else{c.empty().append("<input type='text' class='form-control'>");}}}});$("#advanceQueryContainer").on("click",".deleteCondition",function(){$(this).parent().remove();
});$("#advanceSearchBtn").click(function(){a.jqgridReloadMethod(a.getSearchParams());});$("#queryPlanContainer").on("click",".deleteQueryPlan",function(b){var d=$(this).attr("planId");
b.stopPropagation();var c=$(this).parent();showConfirm(function(){deleteByIds(ctx+"/crm/ou/query/delete.htm",d,function(e){if(e.success){DialogUtils.success(msgCode.SUCCESS,e.msg);
c.remove();a._deleteQueryPlan(d);}else{DialogUtils.error(msgCode.ERROR,e.msg);}},function(){DialogUtils.error(msgCode.ERROR,msgCode.ERROR_MSG);});});});
$("#queryPlanContainer").on("click",".queryPlan",function(){if(!$(this).hasClass("activeQueryPlan")){$(this).siblings().removeClass("activeQueryPlan");
$(this).addClass("activeQueryPlan");a.currentPlanId=$(this).attr("planId");a._switchToCurrentQueryPlan();}});$("#queryPlanContainer").on("mouseenter mouseout",".queryPlan",function(b){if(b.type=="mouseenter"){if(!$(this).hasClass("activeQueryPlan")){$(this).addClass("queryPlan-hover");
}}else{if(b.type=="mouseout"){$(this).removeClass("queryPlan-hover");}}});$(".addNewCondition").click(function(){var b=$(this).parent().parent().prev().children("div[class='form-group']").last();
if(b&&b.html()!=null){b.clone().insertAfter(b);}else{a._addFirstQueryCondition();}});$("#advanceQuery").click(function(){if($(this).children("i").hasClass("fa-caret-right")){$(this).children("i").removeClass("fa-caret-right").addClass("fa-caret-down");
$("#advanceQueryContainer").show();}else{$(this).children("i").addClass("fa-caret-right").removeClass("fa-caret-down");$("#advanceQueryContainer").hide();
}});$("#queryPlan").click(function(){if($(this).children("i").hasClass("fa-caret-right")){$(this).children("i").removeClass("fa-caret-right").addClass("fa-caret-down");
$("#saveQueryPlanContainer").show();}else{$(this).children("i").addClass("fa-caret-right").removeClass("fa-caret-down");$("#saveQueryPlanContainer").hide();
}});$("#saveQueryPlanBtn").click(function(){var b=a._getQueryPlan();if(b!=null){a._addQueryPlan(b);}});}};