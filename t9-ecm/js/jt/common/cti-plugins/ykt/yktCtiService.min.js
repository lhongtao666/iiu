$(function(){currentUserAdn=currentUserAcd.split(":")[0];currentUserAcd=currentUserAcd.split(":")[1];if(currentUserAcd=="invalidAcd"){$("#loginedExt1").addClass("text-danger").empty().append(currentUserAdn+"分机不存在");
return;}if(isNaN(currentUserAid)){$("#loginedExt1").addClass("text-danger").empty().append(currentUserAid+"不能登录分机<非数字工号>");return;}jtCtiService=new YktCtiService();
jtCtiService.init();});function YktCtiService(){if(!(this instanceof YktCtiService)){return new YktCtiService();}else{this.transNumber="";this.onTraning=false;
this.callOuting=false;this.newCsCall=false;}}YktCtiService.prototype={init:function(){this._bindEventHandler();this.start();},_loadLoginInfo:function(){var a={};
a.CTIServerType=webApp2AsType;a.CTIServerIP=ctiIp;a.CTIServerPort=ctiPort;a.UserName=currentUserAid;a.RealName=currentUserName;a.Gender="男";a.CompanyId=companyId||"31b05701-60ef-405c-87ba-af47049e3f48";
a.ExtNumber=currentUserAdn;a.ExtCallerNumber="";a.ExtCallerRelayGrpNo="0";a.SeatGroupList=new Array();a.SeatGroupList.push({SeatGroupId:currentUserAcd,SeatGroupName:currentUserAcd+"",});
return a;},_bindEventHandler:function(){},start:function(){var b=this;var a=b._loadLoginInfo();if(a==undefined||a==null||!a.ExtNumber){OcxCore.Utility.ShowTip("参数无效！",2);
return;}if(OcxCore.Session.IsCheckin()){OcxCore.Utility.ShowTip("请先签出当前分机再签入！",2);return;}b._initService2(a);b._login(a);},_initService2:function(a){OcxCore.Session.setCTIServerType(a.CTIServerType);
OcxCore.Session.setCTIServerIP(a.CTIServerIP);OcxCore.Session.setCTIServerPort(a.CTIServerPort);OcxCore.Session.setShowCallInPopOnTalking(false);OcxCore.Session.setShowCallOutPopOnTalking(false);
OcxCore.Session.setLogLevel("TRACE");OcxCore.Session.ResetConfig("EnableConsultExtNum",true);OcxCore.Session.ResetConfig("DialNumberVisible",true);OcxCore.Session.setHideMiddlePhone(false);
OcxCore.Session.ResetConfig("HideMiddlePhoneMode",1);OcxCore.Session.setNowDate(new Date());OcxCore.Session.setUserName(a.UserName);OcxCore.Session.setRealName(a.RealName);
OcxCore.Session.setGender(a.Gender);OcxCore.Session.setCompanyId(a.CompanyId);OcxCore.Session.setExtNumber(a.ExtNumber);OcxCore.Session.setExtMode(1);OcxCore.Session.setExtCallerNumber(a.ExtCallerNumber);
OcxCore.Session.setExtCallerRelayGrpNo(a.ExtCallerRelayGrpNo);a.Continuation=1;a.CanSetBusyWaitCount=0;a.BusySubStateList=[];a.BusySubStateList.push({SubState:202,SubStateName:"小休",Icon:"xiaoxiu.png"});
a.BusySubStateList.push({SubState:203,SubStateName:"开会",Icon:"huiyi.png"});a.BusySubStateList.push({SubState:208,SubStateName:"其它",Icon:"qita.png"});OcxCore.Session.setContinuation(a.Continuation);
OcxCore.Session.setCanSetBusyWaitCount(a.CanSetBusyWaitCount);this._initSeatGroup(a);this._initBusySubState(a);this._bindCTIEventHandler();OcxCore.Session.InitService();
},_login:function(){OcxCore.Session.Checkin();},dialout:function(e,i){if(!e){DialogUtils.error("外呼号码不能为空!");return;}if(e.startsWith("9")){e=e.substring(1);
}var h=e;var a=i;var l=null;var b=1;var d=null;var c=0;var k=null;var f=null;var g=null;var j=null;OcxCore.Session.MakeCall(h,l,a,b,d,c,k,f,g,j);},_loadCsData:function(d,b,c){var a=this;
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum="+d+"&inNum="+b,"客户来电");},_bindCTIEventHandler2:function(){OcxCore.Session.bind("onCTIStateChange",function(c,a,b){OcxCore.Log.debug("调用了客户端 CTI 状态变化响应回调函数");
});},_bindCTIEventHandler:function(){var a=this;OcxCore.Session.bind("onStopService",function(b,c){if(b=="LoginExpired"){console.log("===============ssq===========================");
OcxCore.Log.debug("调用了服务停止后回调函数:"+b);OcxCore.Session.Checkout();}});OcxCore.Session.bind("onCTIStateChange",function(h,f,g){var e="";if(h==OcxCore.Enums.CTIAgentStatusFlag.STATE_BUSY.getIndex()){var d=h;
if(d==OcxCore.Enums.CTIAgentStatusFlag.STATE_BUSY.getIndex()){d=OcxCore.Session.getCTIAgentSubStatus();}if(OcxCore.Session.getCTIAgentSubStatus()>200){var c=OcxCore.Session.getBusySubStateById(OcxCore.Session.getCTIAgentSubStatus());
e=c!=null?c.getSubStateName():"忙碌";}else{e="忙碌";}}else{e=OcxCore.Enums.GetName(OcxCore.Enums.CTIAgentStatusFlag,h);}OcxCore.Log.debug("调用了客户端CTI状态变化响应回调函数,坐席状态:"+e+",CTIConnected:"+f);
var b={UserCode:OcxCore.Session.getUserName(),ExtNumber:OcxCore.Session.getExtNumber(),CTIAgentStatus:h,CTIAgentSubStatus:OcxCore.Session.getCTIAgentSubStatus(),CompanyId:OcxCore.Session.getCompanyId()};
});OcxCore.Session.bind("onRefleshShowInfo",function(g,e,f){var d="";if(g==OcxCore.Enums.CTIAgentStatusFlag.STATE_BUSY.getIndex()){var c=g;if(c==OcxCore.Enums.CTIAgentStatusFlag.STATE_BUSY.getIndex()){c=OcxCore.Session.getCTIAgentSubStatus();
}if(OcxCore.Session.getCTIAgentSubStatus()>200){var b=OcxCore.Session.getBusySubStateById(OcxCore.Session.getCTIAgentSubStatus());d=b!=null?b.getSubStateName():"忙碌";
}else{d="忙碌";}}else{d=OcxCore.Enums.GetName(OcxCore.Enums.CTIAgentStatusFlag,g);}OcxCore.Log.debug("调用了客户端显示信息和按钮状态变化后回调函数   当前状态："+d);});OcxCore.Session.bind("onBeforeCheckIn",function(d){OcxCore.Log.debug("调用了签入之前回调函数");
var b={};var c=false;c=true;return c;});OcxCore.Session.bind("onCheckIn",function(b){OcxCore.Log.debug("调用了签入响应回调函数");});OcxCore.Session.bind("onCheckOut",function(b){OcxCore.Log.debug("调用了签出响应后回调函数");
});OcxCore.Session.bind("onCallAlerting",function(d,j,g,i,l,k,e,h,f){OcxCore.Log.debug("调用了呼入通知（呼入弹屏）回调函数");var c={caller:d,called:j,callGuid:g,callType:0,customId:i,groupId:l,callDirection:0,callTime:k,popTabId:e};
if(f!=undefined&&f.IVRPath!=undefined){c["IVRPath"]=f.IVRPath;}var m=c.caller;var b=c.called;if(m.startsWith("01")&&!m.startsWith("010")){m=m.substring(1);
}a._loadCsData(m,b);});OcxCore.Session.bind("onOutCalling",function(d,i,g,h,j,b,e,f){OcxCore.Log.debug("调用了呼出通知(呼出弹屏)回调函数");var c={caller:d,called:i,callGuid:g,callType:1,customId:h,callDirection:1,callTime:j,popTabId:e,otherParams:b};
});OcxCore.Session.bind("onTalking",function(d,h,f,c,b,g,i,e){OcxCore.Log.debug("调用了通话通知回调函数");});OcxCore.Session.bind("onHangup",function(c,j,g,i,l,k,h,f,b,d,e){OcxCore.Log.debug("调用了挂机响应回调函数");
});OcxCore.Session.bind("onBeforeMakeCall",function(b){OcxCore.Log.debug("调用了客户端拨号之前回调函数");if(b==undefined||b==null||b==""){return null;}return b;});OcxCore.Session.bind("onSaveCtiOption",function(c,h,i,e,b,d,g,f){OcxCore.Log.debug("调用了保存坐席操作动作回调函数: "+OcxCore.Enums.GetName(OcxCore.Enums.CTIAgentOptionFlag,i)+"    开始时间："+e+" 结束时间："+b+" 备注："+g);
});OcxCore.Session.bind("onShowCallInNotice",function(b,h,e,g,j,i,c,f,d){OcxCore.Log.debug("调用了来电时显示来电提醒回调函数");});OcxCore.Session.bind("onHideCallInNotice",function(){OcxCore.Log.debug("调用了隐藏来电提醒回调函数");
});},_initSeatGroup:function(a){OcxCore.Session.clearGroupList();if(!a.SeatGroupList||!a.SeatGroupList.length){return;}for(var b=0;b<a.SeatGroupList.length;
b++){OcxCore.Session.addGroup(a.SeatGroupList[b].SeatGroupId,a.SeatGroupList[b].SeatGroupName);}},_initBusySubState:function(c){OcxCore.Session.clearBusySubStateList();
$("#ocxBtnBusySubState").html("");var b=document.createElement("style");b.type="text/css";var a="";if(!c.BusySubStateList||!c.BusySubStateList.length){return;
}for(var d=0;d<c.BusySubStateList.length;d++){var e=c.BusySubStateList[d].Icon!=undefined?c.BusySubStateList[d].Icon:"manglu.png";OcxCore.Session.addBusySubState(c.BusySubStateList[d].SubState,c.BusySubStateList[d].SubStateName,"",true,e);
$("#ocxBtnBusySubState").append("<div id='ocxBtnBusySubState"+c.BusySubStateList[d].SubState+"' keyid='SetBusy' state='2' substate='"+c.BusySubStateList[d].SubState+"' class='ocxState-dropdownData-item ocxSubState state_"+c.BusySubStateList[d].SubState+"' style='display: block;'>"+c.BusySubStateList[d].SubStateName+"</div>");
a+=".ocxStateInfo .state_"+c.BusySubStateList[d].SubState+"{background:url(CTIAgentSDK/images/substate/"+e+") 0px 0px no-repeat;}\r\n";}if(b.styleSheet){b.styleSheet.cssText=a;
}else{b.innerHTML=a;}document.getElementsByTagName("head")[0].appendChild(b);},_initExtNumber:function(a){OcxCore.Session.clearExtNumberList();a.ExtNumberList=[];
a.ExtNumberList.push({ExtNumber:8001,ExtCaller:"28888888",ExtCallerRelayGrpNo:"1",ExtUserRealName:"客服1"});a.ExtNumberList.push({ExtNumber:8002,ExtCaller:"28888888",ExtCallerRelayGrpNo:"1",ExtUserRealName:"客服2"});
a.ExtNumberList.push({ExtNumber:8003,ExtCaller:"28888888",ExtCallerRelayGrpNo:"1",ExtUserRealName:"客服3"});a.ExtNumberList.push({ExtNumber:8004,ExtCaller:"28888888",ExtCallerRelayGrpNo:"1",ExtUserRealName:"客服4"});
a.ExtNumberList.push({ExtNumber:8005,ExtCaller:"28888888",ExtCallerRelayGrpNo:"1",ExtUserRealName:"客服5"});for(var d=0;d<a.ExtNumberList.length;d++){var c=a.ExtNumberList[d].ExtCaller!=undefined&&a.ExtNumberList[d].ExtCaller!=null?a.ExtNumberList[d].ExtCaller:"";
var b=a.ExtNumberList[d].ExtCallerRelayGrpNo!=undefined&&a.ExtNumberList[d].ExtCallerRelayGrpNo!=null?a.ExtNumberList[d].ExtCallerRelayGrpNo:"0";OcxCore.Session.addExtNumber(a.ExtNumberList[d].ExtNumber,c,b,a.ExtNumberList[d].ExtUserRealName);
}},};