$(function(){var c=currentUserAcd.split(",");phonePanel=new PhonePanel();phonePanel.init();if(isNaN(currentUserAid)){$("#loginedExt1").addClass("text-danger").empty().append(currentUserAid+"不能登录分机<非数字工号>");
currentUserAdn=null;return;}if(c.length==2){var f=[];var b=[];for(var d=0;d<c.length;d++){if(c[d].split(":")[1]==="invalidAcd"){$("#loginedExt").append("&nbsp;&nbsp;<span class='text-danger'>"+c[d].split(":")[0]+"分机不存在"+"</span>");
}else{if(c[d].split(":")[1].startsWith("invalidAid-")){var g=c[d].split(":")[1].replace("invalidAid-");$("#loginedExt").append("&nbsp;&nbsp;<span class='text-danger'>"+c[d].split(":")[0]+"分机已绑定"+g+"工号,您无法登录"+"</span>");
}else{f.push(c[d].split(":")[0]);b.push(c[d].split(":")[1]);}}}currentUserAdn=f.toString(",");currentUserAcd=b.toString(",");}else{currentUserAdn=currentUserAcd.split(":")[0];
currentUserAcd=currentUserAcd.split(":")[1];if(currentUserAcd=="invalidAcd"){$("#loginedExt1").addClass("text-danger").empty().append(currentUserAdn+"分机不存在");
return;}else{if(currentUserAcd&&currentUserAcd.startsWith("invalidAid-")){var g=currentUserAcd.replace("invalidAid-");$("#loginedExt").append("&nbsp;&nbsp;<span class='text-danger'>"+currentUserAdn+"分机已绑定"+g+"工号,您无法登录"+"</span>");
}}}jtCtiService=new CtiService();jtCtiService.init();if("y"==isAllInOne){$("#transBtn").hide();}var e=$("#anoContainer option:not([value=''])");var a=[];
e.each(function(){var j=$(this);var h=j.attr("value");var i=j.attr("isp");var k={num:h,isp:i};a.push(k);});turnMap={all:a,lastIndex:null};});function CtiService(){if(!(this instanceof CtiService)){return new CtiService();
}else{this.transNumber="";this.onTraning=false;this.callOuting=false;this.newCsCall=false;this.isHasMonitor=false;this.callEndDealFlag=false;this.callEndBno=null;
}}CtiService._CONS_={API_SERVICE_HOST:"http://192.168.0.250:8080/DeskServer",CHECK_EXT_URL:ctx+"/gl/cti/glCti/checkExt.htm",CHANGE_USER_MSG_URL:ctx+"/crm/ou/user/changeUserMsg.htm",UPDATE_ADN_STATUS_URL:ctx+"/crm/ou/employee/updateAdnStatusById.htm",DEL_ADN_LOGIN_URL:ctx+"/crm/ou/employee/delAdnLoginByAid.htm",CREATE_OR_UPDATE_EMP_LAST_CALL_LOG:ctx+"/gl/cti/agentMap/createOrUpdateEmpLastCallLog.htm",FORM_ID:"loginCTIForm",ZERO_STR:"0",ONE_STR:"1",TWO_STR:"2",THREE_STR:"3",FOUR_STR:"4",FIVE_STR:"5",};
CtiService.prototype={init:function(){if(ResUtils.canShow("agentMap.button.fenjiMonitor")){this.isHasMonitor=true;}this._bindEventHandler();this.start();
},_bindEventHandler:function(){var a=this;$("#anoContainer").on("change",function(){var d=$(this);var b=d.val();var e=d.find("option:selected").attr("isp");
var c=$("#line_warning_div").find(".warning-isp");d.css({"border-color":"none"});if(c.size&&e){c.each(function(){var f=$(this).attr("isp");if(f==e){d.css({"border-color":"#ff0000"});
return false;}});}});$(".dialoutBtn1").on("click",function(){a.dialout();$(".dialoutBtn1").attr("disabled","disabled");setTimeout(function(){$(".dialoutBtn1").removeAttr("disabled");
},5000);$("#setBusyBtn").removeAttr("disabled","disabled");});$(".telNumberDialoutBtn").on("click",function(){if($(this).hasClass("BtnFlag")){return;}a.dialout();
$(".dialoutBtn1").attr("disabled","disabled");$(".telNumberDialoutBtn").addClass("BtnFlag");setTimeout(function(){$(".dialoutBtn1").removeAttr("disabled");
$(".telNumberDialoutBtn").removeClass("BtnFlag");},5000);$("#setBusyBtn").removeAttr("disabled","disabled");});$("#setBusyBtn").on("click",function(){if($(this).attr("title")==="忙碌"){a.setbusy();
a.createOrUpdateEmpLastCallLog("",CtiService._CONS_.THREE_STR,"");}else{if($(this).attr("title")==="在线"){if(a.callEndDealFlag){a.updateCallEndDealLog();
a.callEndDealFlag=false;clearTimeout(a.callEndDealTimeOut);a.callEndDealTimeOut=null;}a.createOrUpdateEmpLastCallLog("",CtiService._CONS_.ZERO_STR,"");
a.setidle();}}});$("#setHoldBtn").on("click",function(){a.hold();$(this).attr("disabled","disabled");$("#setRetrieveBtn").removeAttr("disabled","disabled");
});$("#setRetrieveBtn").on("click",function(){a.retrieve();$(this).attr("disabled","disabled");$("#setHoldBtn").removeAttr("disabled","disabled");});$("#transBtn").on("click",function(){var d=$("#speedDialNumber").val();
var c="transferFrom:";var b=null;if(currentUserAdn.indexOf(",")){c+=currentUserAdn.split(",")[0];b=currentUserAdn.split(",")[0];}else{c+=currentUserAdn;
b=currentUserAdn;}c+=","+a.csNumber;UMO.inittrans(d,c,true,function(f,e){if(e.errno==0){a.transNumber=d;a.onTraning=true;FormUtils.submit(ctx+"/crm/cs/csEntity/transferCallAdn.htm?adn="+b,{calledAdn:d,csMobile:a.csNumber},function(g){});
}});});},updateAdnStatus:function(a){FormUtils.submit(CtiService._CONS_.UPDATE_ADN_STATUS_URL+"?status="+a,null,function(b){});},createOrUpdateEmpLastCallLog:function(c,a,b){if("y"==isOpenAgentMapCti){FormUtils.submit(CtiService._CONS_.CREATE_OR_UPDATE_EMP_LAST_CALL_LOG+"?status="+a+"&csPhone="+c+"&direction="+b,null,function(d){});
}},updateCallEndDealLog:function(){var a=this;FormUtils.loadData(ctx+"/gl/cti/ctiOperLog/updateCallEndDealLog.htm",null,null);a.createOrUpdateEmpLastCallLog("",CtiService._CONS_.ZERO_STR,"");
},createCallEndDealLog:function(){var a=this;FormUtils.loadData(ctx+"/gl/cti/ctiOperLog/createCallEndDealLog.htm?callEndBno="+a.callEndBno,null,null);},delAdnLogin:function(a){FormUtils.submit(CtiService._CONS_.DEL_ADN_LOGIN_URL+"?aid="+a,null,function(b){});
},_monitor:function(b,a){UMO.listen(b,a,function(d,c){if(c.errno==0){FormUtils.submit(ctx+"/gl/cti/ctiOperLog/employeeDealAcdLog.htm?aid="+b+"&type=monitor",null,function(e){});
}else{DialogUtils.error("错误","稍等请重试！");UMO.listen(b,false,function(f,e){},null);return;}},null);},forceidle:function(a){UMO.forceidle(a,function(c,b){if(b.errno==0){FormUtils.submit(ctx+"/gl/cti/ctiOperLog/employeeDealAcdLog.htm?aid="+a+"&type=forceidle",null,function(d){});
}else{DialogUtils.error("错误",b.errmsg);return;}},null);},_interrupt:function(b,a){UMO.interrupt(b,a,function(d,c){if(c.errno==0){FormUtils.submit(ctx+"/gl/cti/ctiOperLog/employeeDealAcdLog.htm?aid="+b+"&type=interrupt",null,function(e){});
}else{DialogUtils.error("错误",c.errmsg);UMO.interrupt(b,false,function(f,e){},null);return;}},null);},forcebusy:function(a){UMO.forcebusy(a,function(c,b){if(b.errno==0){FormUtils.submit(ctx+"/gl/cti/ctiOperLog/employeeDealAcdLog.htm?aid="+a+"&type=forcebusy",null,function(d){});
}else{DialogUtils.error("错误",b.errmsg);return;}},null);},acditemlist:function(b,a){UMO.acditemlist(b,function(d,c){a(d,c);},null);},getAno:function(b){var c=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;
var a=b.substring(1);if(b.startsWith("9")&&c.test(a)){b=b.substring(1);}else{if(b.startsWith("0")&&c.test(a)){b=b.substring(1);}else{if(b.startsWith("90")&&c.test(a.substring(1))){b=b.substring(2);
}}}return b;},_checkIsMobileAdn:function(a,b){if(a&&a.indexOf("TranServer")>-1){return true;}else{if(b&&b.length>10){return true;}}return false;},_openErrorTipView:function(d,e){var b=this;
var c,a;layer.confirm('<p class="text-muted text-center" id="forceLogoutTip" style="color:red">分机系统正忙!</p><p class="text-muted text-center" style="color:red">请点击重试或取消登录分机！</p>',{btn:["重试","取消"],},function(g,f){if(d){d(g,f);
}},function(){if(e){e(c,a);}b.isOpeningErrorTipView=false;});},_openMarkRecordView:function(d){var a=this;var c=d.phone;if(d.phone.startsWith("0")){c=d.phone.substring(1);
}var a=this;var b={agentId:d.agentId,direction:d.direction,adn:d.adn,phone:d.phone,};layer.open({type:2,title:'<font style="color:red;">【'+a._maskNumber(c)+"】</font>通话标识",maxmin:false,area:["500px","280px"],btn:["保存"],shadeClose:false,content:ctx+"/gl/cti/trksheetRecordMark/toCreate.htm",yes:function(g,f){var e=layer.getChildFrame("body",g);
var h=$("#trkRecordMarkForm",e);if(!h.valid()){return;}var j=$("[name=mark]",h).val();var i=$("[name=markDes]",h).val();b.markDes=i;b.mark=j;FormUtils.submit(ctx+"/gl/cti/trksheetRecordMark/create.htm",$.param(b),function(k){if(k.success){DialogUtils.success(msgCode.SUCCESS,k.msg);
layer.close(g);}else{DialogUtils.error(msgCode.ERROR,k.msg);}},function(){DialogUtils.error(msgCode.ERROR,"服务器错误");});}});},_setTalkingInfo:function(e,d,h,g){var c=this;
var b=null;if(d.startsWith("9")){b=d.substring(1);}else{b=d;}var a=null;if(h=="income"){a=1;}else{if(h=="dialout"){a=0;}}var f={adn:e,phone:b,direction:a,agentId:g,};
c.talkingInfo=f;},_currentTalkingInfo:function(){var a=this;if(a.onTalking){return a.talkingInfo;}},start:function(){var d=this;var a={onReadyState:function(h){$.log("on ready state event:"+h);
if(h==0){if("y"==isAllInOne&&d.exiting){d.exiting=false;return;}console.count("reconnect the cti and return status 0... ");if(isCodeLogoutAdn==0){if(!d.isOpeningErrorTipView){if(reloginAdnCount>=5){if("y"==isAllInOne){$("#mobileNumber").empty().append("未登录");
}d._openErrorTipView(function(i){reloginAdnCount=0;layer.close(i);d.isOpeningErrorTipView=false;if("y"==isAllInOne){UMO.exit();}setTimeout(d.start(),500);
},function(i){reloginAdnCount=0;});d.isOpeningErrorTipView=true;}else{reloginAdnCount++;if("y"==isAllInOne){UMO.exit();}setTimeout(d.start(),500);}}else{if("y"==isAllInOne){UMO.exit();
}}}}else{reloginAdnCount=0;isCodeLogoutAdn=0;if("y"==isAllInOne){$("#mobileNumber").empty().append("空闲中");}}},onCallincome:function(k,h,j){console.log("the uud is "+j);
if(j&&j.startsWith("misc:callback")){k=d.getAno(k);$("#mobileNumber").empty().append("正在呼叫"+d._maskNumber(k));d.callOuting=true;d.csNumber=k;}else{if(j&&j.startsWith("misc:batch")){h=d.getAno(h);
$("#mobileNumber").empty().append("正在呼叫"+d._maskNumber(h));d.callOuting=true;d.csNumber=h;d._loadCsData(d.csNumber,k);}else{if(j&&j.startsWith("transferFrom")){var l=j.split(":")[1];
d.csNumber=l.split(",")[1];d._loadCsData(d.csNumber,currentUserAdn.indexOf(",")>1?currentUserAdn.split(",")[0]:currentUserAdn);DialogUtils.success(msgCode.SUCCESS,"该电话来自"+l.split(",")[0]+"的转接");
this.onCallincomeing=true;}else{if(j==="webCall"){h=h.substring(1);if(h.startsWith("01")&&!h.startsWith("010")){h=h.substring(1);}d.csNumber=h;d.newCsCall=true;
d._loadCsData(d.csNumber,k);this.onCallincomeing=true;}else{d.csNumber=k;if(d.csNumber.startsWith("01")&&!d.csNumber.startsWith("010")){d.csNumber=d.csNumber.substring(1);
}if("y"==isCheckQuhao&&!d.csNumber.startsWith("0")&&!d.csNumber.startsWith("1")){d.csNumber=systemPhoneArea_quhao+d.csNumber;}d.newCsCall=true;d._loadCsData(d.csNumber,h);
this.onCallincomeing=true;}}}}if(d.callEndDealFlag){d.updateCallEndDealLog();d.callEndDealFlag=false;clearTimeout(d.callEndDealTimeOut);d.callEndDealTimeOut=null;
}d.callEndBno=h;$("#mobileNumber").empty().append("正在振铃");d.updateAdnStatus(CtiService._CONS_.FOUR_STR);var i=d.callOuting?CtiService._CONS_.ZERO_STR:CtiService._CONS_.ONE_STR;
d.createOrUpdateEmpLastCallLog(d.csNumber,CtiService._CONS_.FOUR_STR,i);},onTalked:function(m,h,l){d.callEndBno=h;if(d.onTraning){DialogUtils.success(msgCode.SUCCESS,"转接给"+d.transNumber+"成功");
d.onTraning=false;d.transNumber="";UMO.comptrans();d.updateAdnStatus(CtiService._CONS_.ONE_STR);}else{d.onTalking=true;$("#setBusyBtn").attr("disabled","disabled");
$("#setHoldBtn").removeAttr("disabled","disabled");var o=null;if("y"==isAllInOne){o=d.getAno(m);}else{if(d.callOuting){o=d.getAno(h);var n=this.isDoubleFlag?("47"+currentUserAid):currentUserAid;
d._setTalkingInfo(m,h,"dialout",n);d.createOrUpdateEmpLastCallLog(o,CtiService._CONS_.ONE_STR,CtiService._CONS_.ZERO_STR);}else{o=d.getAno(m);var n=this.isDoubleFlag?("47"+currentUserAid):currentUserAid;
d._setTalkingInfo(h,m,"income",n);d.createOrUpdateEmpLastCallLog(o,CtiService._CONS_.ONE_STR,CtiService._CONS_.ONE_STR);}}if(!this.isDoubleFlag){var i=(limitCallCs&&"y"==limitCallCs)||(limitCall&&"y"==limitCall);
if(i&&limitCountCallType&&"link"==limitCountCallType){if(d.callOuting&&d.callOuting==true){var k=d._currentAdnInfo();}}}if(!d.talkingClock){var j=new Date();
d.talkingClock=setInterval(function(){var r=new Date();var s=DateUtils.getDateDiff(j.current(),r.current(),"second");var t=parseInt(s/60);var q=0;if(t==0){t="00";
}else{if(t>0&&t<10){t=0+""+parseInt(t);}else{if(t>60){q=parseInt(t/60);t=parseInt(t%60);if(t<10){t=0+""+t;}}}}var p=t+":"+parseInt(s%60);if(q>0){p=parseInt(q)+":"+p;
}if(l.startsWith("transferFrom")){$("#mobileNumber").empty().append(d._maskNumber(l.split(",")[1])+" "+p);}else{$("#mobileNumber").empty().append(d._maskNumber(o)+" "+p);
}},1000);}}},onRingStoped:function(){$("#mobileNumber").empty().append("空闲中");d.updateAdnStatus(CtiService._CONS_.ZERO_STR);$.log("on ring stop");if(d.newCsCall){d.newCsCall=false;
FormUtils.submit(ctx+"/gl/cti/tRKSheetRecord/createMissedCallMsg.htm",{phone:d.csNumber});d.createOrUpdateEmpLastCallLog(d.csNumber,CtiService._CONS_.ZERO_STR,null);
}this.onCallincomeing=false;},onHookChanged:function(h){console.log("on hook change status is "+h);switch(h){case"1":clearInterval(d.talkingClock);d.talkingClock=null;
if(isOpenCallEndDeal=="y"){d.callEndDealFlag=true;$("#mobileNumber").empty().append("话后处理");$("#setBusyBtn").removeAttr("disabled","disabled");d.setbusy();
$("#setBusyBtn").attr("title","在线");$("#setBusyBtn").find("i").removeClass("glyphicon-off").addClass("glyphicon-home");d.createCallEndDealLog();d.updateAdnStatus(CtiService._CONS_.FIVE_STR);
d.createOrUpdateEmpLastCallLog(d.csNumber,CtiService._CONS_.FIVE_STR,null);d.callEndDealTimeOut=setTimeout(function(){$("#setBusyBtn").trigger("click");
d.updateCallEndDealLog();},parseInt(callEndDealTime)*60000);}else{$("#mobileNumber").empty().append("空闲中");d.updateAdnStatus(CtiService._CONS_.ZERO_STR);
d.createOrUpdateEmpLastCallLog(d.csNumber,CtiService._CONS_.ZERO_STR,null);}if("y"==markCtiRecord&&d.onTalking){var j=d._currentTalkingInfo();if(j){d._openMarkRecordView(j);
}}if(!this.isDoubleFlag){if("y"==limitInterval&&(d.callOuting||d.onTalking)&&(d.callOuting==true||d.onTalking==true)){var i=d._currentAdnInfo();if(i){FormUtils.loadData(ctx+"/gl/cti/glCti/updateCallOutTime.htm?adn="+i.adn+"&gid="+i.gid+"&gidDesName="+i.gidDesName,null,null,true);
}}}d.callOuting=false;d.onTalking=false;this.onCallincomeing=false;break;case"2":if("y"==isAllInOne&&!d.callOuting){return;}$("#mobileNumber").empty().append("摘机");
break;default:clearInterval(d.talkingClock);d.talkingClock=null;$("#mobileNumber").empty().append("请挂机");d.updateAdnStatus(CtiService._CONS_.TWO_STR);d.createOrUpdateEmpLastCallLog(d.csNumber,CtiService._CONS_.TWO_STR,null);
this.onCallincomeing=false;break;}},onAgentChanged:function(h){d.changeAgentStatus(h);},onAsyncFinished:function(j,h,i,k){$.log("onAsyncFinished: atype="+j+" taskid="+h+" ret="+i+" desc="+k);
if("y"==isAllInOne){}},onAllBusy:function(h,j,i){$.log("onAllBusy: status="+h+" acd="+j+" quelen="+i);},onQuelen:function(i,h){$.log("onQuelen: acd="+i+" quelen="+h);
},onSmsincome:function(h,k,i,j){$.log("onSmsincome: dtime="+h+" from="+k+" content="+i+" slot="+j);},onOperCallback:function(h,i,m,j,l,k){$.log("onOperCallback: : flowid="+h+" callid="+i+" direction="+m+" teleno="+j+" time="+l+" state="+k);
},onSpeedCallback:function(h,i,m,j,l,k,n){$.log("onSpeedCallback: flowid="+h+" callid="+i+" direction="+m+" teleno="+j+" time="+l+" state="+k+" desc="+n);
},onTextMessage:function(i,k,l){var h=null;if(currentUserAdn.indexOf(",")!=-1){h=currentUserAdn.split(",")[0];}else{h=currentUserAdn;}if(d._checkIsMobileAdn(ctiServer,h)){if(this.onCallincomeing){var j=l.split(";")[1].split("=")[1];
if(currentUserAdn.indexOf(",")!=-1){d._loadCsData(j,currentUserAdn.split(",")[0],"missed");}else{d._loadCsData(j,currentUserAdn,"missed");}}}else{var j=l.split(";")[1].split("=")[1];
if(j&&j.startsWith("01")&&!j.startsWith("010")){j=j.substring(1);}if(currentUserAdn.indexOf(",")!=-1){d._loadCsData(j,currentUserAdn.split(",")[0],"missed");
}else{d._loadCsData(j,currentUserAdn,"missed");}}},setDoubleAdnFlag:function(h){this.isDoubleFlag=h;},};var e=currentUserAdn,c=currentUserAcd;if(currentUserAdn&&currentUserAdn.indexOf(",")!=-1){e=currentUserAdn.split(",");
}if(currentUserAcd&&currentUserAcd.indexOf(",")!=-1){c=currentUserAcd.split(",");}if(isNaN(currentUserAid)){$("#loginedExt1").addClass("text-danger").empty().append("<span class='text-danger'>该工号无法使用cti</span>");
return;}if(e&&c&&e.length==2&&c.length==2){var g=function(){if(!e[0]||!c[0]||e[0]=="undefined"||c[0]=="undefined"){console.log("非法格式的分机或队列");return;}if("y"===isAllInOne){currentUserPassword=adnPass||"e10adc3949ba59abbe56e057f20f883e";
}UMO.start(ctiServer,null,a,0,"",currentUserAid,currentUserPassword,e[0],function(i,h){console.log("命令名称cmd:"+i);console.log("结果对象Result:"+h);if(h.errno==0){window.localStorage.setItem("umoctiToken",UMO._token);
isCodeLogoutAdn=0;UMO.login(currentUserAid,c[0],-1,d.isHasMonitor,false,function(k,j){console.log("login命令名称cmd:"+k);console.log("login结果对象Result:"+j);
isCodeLogoutAdn=0;if(j.errno==0){$("#loginBtn").attr("disabled","disabled");$("#setBusyBtn").removeAttr("disabled","disabled");$("#logoutBtn").removeAttr("disabled");
$("#mobileNumber").empty().append("空闲中");d._loginTip("loginedExt1",e[0],"success");}else{if(j.errno==103){d._loginTip("loginedExt1",e[0],"error");}else{d._loginTip("loginedExt1",e[0],"error");
}}},null);}else{d._loginTip("loginedExt1",e[0],"error");}});};var f=function(){if(!e[1]||!c[1]||e[1]=="undefined"||c[1]=="undefined"){console.log("非法格式的分机或队列");
return;}if("y"===isAllInOne){currentUserPassword=adnPass||"e10adc3949ba59abbe56e057f20f883e";}var h=$.extend(true,{},a);h.setDoubleAdnFlag(true);UMX.start(ctiServer,null,h,0,"","47"+currentUserAid,currentUserPassword,e[1],function(j,i){console.log("命令名称cmd:"+j);
console.log("结果对象Result:"+i);if(i.errno==0){window.localStorage.setItem("umxctiToken",UMX._token);isCodeLogoutAdn=0;UMX.login("47"+currentUserAid,c[1],-1,d.isHasMonitor,false,function(l,k){console.log("login命令名称cmd:"+l);
console.log("login结果对象Result:"+k);isCodeLogoutAdn=0;if(k.errno==0){$("#loginBtn").attr("disabled","disabled");$("#setBusyBtn").removeAttr("disabled","disabled");
$("#logoutBtn").removeAttr("disabled");$("#mobileNumber").empty().append("空闲中");d._loginTip("loginedExt2",e[1],"success");}else{if(k.errno==103){d._loginTip("loginedExt2",e[1],"error");
}else{d._loginTip("loginedExt2",e[1],"error");}}},null);}else{d._loginTip("loginedExt2",e[1],"error");}});};if(window.localStorage.getItem("umoctiToken")){UMO._token=window.localStorage.getItem("umoctiToken");
UMO._apihost=ctiServer;UMO._dom=0;UMO.logout(currentUserAid,function(i,h){d.delAdnLogin(currentUserAid);isCodeLogoutAdn=1;UMO.exit(function(k,j){g();});
});}else{g();}if(window.localStorage.getItem("umxctiToken")){UMX._token=window.localStorage.getItem("umxctiToken");UMX._apihost=ctiServer;UMX._dom=0;UMX.logout(currentUserAid,function(i,h){isCodeLogoutAdn=1;
d.delAdnLogin(currentUserAid);UMX.exit(function(k,j){f();});});}else{f();}}else{var b=function(){var h=!currentUserAdn||!currentUserAcd||currentUserAdn=="undefined"||currentUserAcd=="undefined";
if(h){console.log("非法格式的分机或队列");return;}if("y"===isAllInOne){currentUserPassword=adnPass||"e10adc3949ba59abbe56e057f20f883e";}var j=0;var i="";if(ctiServer.indexOf("TranServer")>-1){j=ctiWapApiKey+"-0";
i=ctiWapApiPassCode?ctiWapApiPassCode:"e10adc3949ba59abbe56e057f20f883e";currentUserPassword="e10adc3949ba59abbe56e057f20f883e";}UMO.start(ctiServer,null,a,j,i,currentUserAid,currentUserPassword,currentUserAdn,function(l,k){console.log("命令名称cmd:"+l);
console.log("结果对象Result:"+k);window.localStorage.setItem("umoctiToken",UMO._token);isCodeLogoutAdn=0;if(k.errno==0){UMO.login(currentUserAid,currentUserAcd,-1,d.isHasMonitor,false,function(o,n){isCodeLogoutAdn=0;
console.log("login命令名称cmd:"+o);console.log("login结果对象Result:"+n);if(n.errno==0){$("#loginBtn").attr("disabled","disabled");$("#setBusyBtn").removeAttr("disabled","disabled");
$("#logoutBtn").removeAttr("disabled");$("#mobileNumber").empty().append("空闲中");d._loginTip("loginedExt1",currentUserAdn,"success");if(!this.isDoubleFlag){var m=null;
if(currentUserAdn.indexOf(",")){m=currentUserAdn.split(",")[0];}else{m=currentUserAdn;}FormUtils.loadData(ctx+"/crm/ou/employee/updateCurrentLoginedAdn.htm?adn="+m+"&adnStatus=0",null,null,true);
d.createOrUpdateEmpLastCallLog("",CtiService._CONS_.ZERO_STR,"");}}else{if(n.errno==103){d._loginTip("loginedExt1",currentUserAdn,"error");if(n.errmsg&&n.errmsg.indexOf("已登录")>-1){DialogUtils.error(msgCode.ERROR,currentUserAdn+"已被登录");
}else{if(n.errmsg&&n.errmsg.indexOf("already login")>-1){DialogUtils.error(msgCode.ERROR,currentUserAdn+"已被登录");}else{if(n.errmsg&&isAllInOne==="y"&&n.errmsg.indexOf("工号不存在")>-1){DialogUtils.error("该工号无法登录cti");
$("#mobileNumber").empty().append(currentUserAid+":"+currentUserName);UMO.exit();}else{if(n.errmsg&&n.errmsg.indexOf("话务组件返回错误")>-1){DialogUtils.error("请检查话机是否正常挂机");
}else{if(n.errmsg&&n.errmsg.indexOf("队列")>-1){DialogUtils.error("队列错误,请检查队列是否存在");}else{if(n.errmsg){DialogUtils.error(n.errmsg);}}}}}}}else{d._loginTip("loginedExt1",currentUserAdn,"error");
}}},null);}else{d._loginTip("loginedExt1",currentUserAdn,"error");if(ctiServer.indexOf("TranServer")>-1){DialogUtils.error(msgCode.ERROR,k.errmsg);}}});
};if(window.localStorage.getItem("umoctiToken")){UMO._token=window.localStorage.getItem("umoctiToken");UMO._apihost=ctiServer;if(ctiServer.indexOf("TranServer")>-1){UMO._dom=ctiWapApiKey+"-0";
}else{UMO._dom=0;}if("y"==isAllInOne){UMO.exit(function(i,h){isCodeLogoutAdn=1;window.localStorage.removeItem("umoctiToken");b();d.exiting=true;});}else{UMO.logout(currentUserAid,function(i,h){d.delAdnLogin(currentUserAid);
isCodeLogoutAdn=1;UMO.exit(function(k,j){b();});});}}else{if("y"==isAllInOne){UMO.exit(function(){isCodeLogoutAdn=1;window.localStorage.removeItem("umoctiToken");
b();d.exiting=true;});}else{b();}}}},_loginTip:function(a,c,b){if(b=="success"){$("#"+a).addClass("text-success").empty().append("<span class='text-success'>"+c+"</span>");
}else{if(b=="error"){$("#"+a).addClass("text-danger").empty().append("<span class='text-danger'>"+c+"</span>");}}},_maskNumber:function(a){return PhoneEncryptUtils.encryptPhone(a);
},_loadCsData:function(d,b,c){var a=this;JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?showCsCalledNum=y&phoneNum="+d+"&inNum="+b,"客户来电");},changeAgentStatus:function(a){var b=this;
if(a==2){$("#setBusyBtn").attr("title","忙碌");$("#setBusyBtn").find("i").removeClass("glyphicon-home").addClass("glyphicon-off");$("#mobileNumber").empty().append("空闲中");
$("#setHoldBtn").attr("disabled","disabled");$("#setRetrieveBtn").attr("disabled","disabled");b.updateAdnStatus(CtiService._CONS_.ZERO_STR);}else{if(a==3){if(b.callEndDealFlag){return;
}$("#setBusyBtn").attr("title","在线");$("#setBusyBtn").find("i").removeClass("glyphicon-off").addClass("glyphicon-home");$("#mobileNumber").empty().append("免打扰");
$("#setHoldBtn").attr("disabled","disabled");$("#setRetrieveBtn").attr("disabled","disabled");b.updateAdnStatus(CtiService._CONS_.THREE_STR);}else{if(a==4){$("#setHoldBtn").removeAttr("disabled","disabled");
$("#setRetrieveBtn").removeAttr("disabled","disabled");b.updateAdnStatus(CtiService._CONS_.ONE_STR);}}}},exit:function(){UMO.exit(this.cbResult);},_currentAdnInfo:function(){var a=this;
if(a.callOuting){return a.currentAdnInfo;}},_getAdnInfo:function(){var c={};var f="@0";var b=$("#anoContainer").find("option:selected").attr("isp");var e=$("#anoContainer").val();
if(!e){if("turn"==filterDefaultLineWay){if(turnMap.all.length){if(!turnMap.lastIndex){turnMap.lastIndex=0;}if(turnMap.all.length<=turnMap.lastIndex){turnMap.lastIndex=0;
}b=turnMap.all[turnMap.lastIndex].isp;e=turnMap.all[turnMap.lastIndex].num;turnMap.lastIndex++;}}else{}}if(b){var d=b.split("-");if(d.length==2){f=d[1];
}else{if(b.indexOf("铁通")!=-1){f="1";}else{if(b.indexOf("联通")!=-1){f="2";}else{if(b.indexOf("移动")!=-1){f="3";}else{if(b.indexOf("电信")!=-1){f="1";}}}}}}if("y"==isAllInOne){f=e;
}var h="";var g=e;if(g){h="ano:"+g;}c.gid=f;c.ano=g;c.uud=h;var a=null;if(currentUserAdn.indexOf(",")){a=currentUserAdn.split(",")[0];}else{a=currentUserAdn;
}c.adn=a;c.gidNum=e;c.gidDesName=b.trim();return c;},dialout:function(c){var a=this;var f=null;var h=c;if(!c){var b=$("#speedDialNumber").val();if(systemPhoneArea_quhao&&b.startsWith(systemPhoneArea_quhao)){b=b.substring(systemPhoneArea_quhao.length);
}h="9"+b;if(b.startsWith("1")&&b.length==4){h=b;}if("y"===isAllInOne){h=b;}}if(!h||h=="9"){return;}if(h.indexOf("-")!=-1){h=h.replace("-","");}if("y"==isAllInOne&&h.startsWith("9")){f=h.substring(1);
}else{f=h;}var g="";if(f.startsWith("9")){g=f.substring(1);g=a.getAno(g);}this.currentAdnInfo=this._getAdnInfo();var d=this.currentAdnInfo;if("y"==limitCall||"y"==limitInterval||"y"==limitCallCs||"y"==openRemind){FormUtils.loadData(ctx+"/gl/cti/glCti/isCanCallOutNow.htm?csPhone="+g+"&adn="+d.adn+"&gid="+d.gid+"&gidDesName="+d.gidDesName,function(k){if(k.success){if(k.msg&&($.isPlainObject(k.msg)||k.msg.startsWith("{")&&k.msg.endsWith("}"))){var i=null;
if($.isPlainObject(k.msg)){i=k.msg.warningMsg;}else{i=JSON.parse(k.msg).warningMsg;}DialogUtils.warning("线路提醒",i);}var j=d.uud;if("y"==isAppendUUD&&d.gidDesName.indexOf("移动")>-1){j=j+";yidong:"+d.gid;
}UMO.dialout(f,d.gid,j,true,function(o,l){if(l.errno==0){a.callOuting=true;$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").hide();$(".openPhoneBtn").find("span").removeClass("up-caret");var m=(limitCallCs&&"y"==limitCallCs)||(limitCall&&"y"==limitCall);if(m&&limitCountCallType&&"call"==limitCountCallType&&f&&f.length>=5){var n=a.currentAdnInfo;
FormUtils.loadData(ctx+"/gl/cti/glCti/addOneCount.htm?csPhone="+g+"&adn="+n.adn+"&gid="+n.gid+"&gidDesName="+n.gidDesName,null,null,true);}}else{console.log("dialout失败.cmd="+o+";result="+l);
}},null);}else{DialogUtils.error(msgCode.ERROR,k.msg);}},null,true);}else{var e=d.uud;if("y"==isAppendUUD&&d.gidDesName.indexOf("移动")>-1){e=e+";yidong:"+d.gid;
}UMO.dialout(f,d.gid,e,true,function(j,i){if(i.errno==0){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");$("#telContainer").hide();
$(".openPhoneBtn").find("span").removeClass("up-caret");}},null);}},setidle:function(){UMO.setidle(this.cbResult);if(UMX){UMX.setidle(this.cbResult);}},setbusy:function(){UMO.setbusy(this.cbResult);
},hold:function(){UMO.hold(this.cbResult);},retrieve:function(){UMO.retrieve(this.cbResult);},cbResult:function(b,a){$.log("cmd is "+b);$.log("result is "+JSON.stringify(a));
}};function PhonePanel(){if(!(this instanceof PhonePanel)){return new PhonePanel();}else{}}PhonePanel.prototype={init:function(){this._bindEventHandler();
},_bindEventHandler:function(){$(".telNumberBtn").on("click",function(){var a=$(this).attr("numberVal");if(a){$("#speedDialNumber").val($("#speedDialNumber").val()+a);
}$("#speedDialNumber-temp").val($("#speedDialNumber").val());});$("#speedDialNumber-temp").on("change",function(){if($(this).val()!=$("#speedDialNumber").val()){$("#speedDialNumber").val($("#speedDialNumber-temp").val());
}});$(".openPhoneBtn").on("click",function(){if($(this).find("span").is(".up-caret")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(this).find("span").removeClass("up-caret");}else{$("#telContainer").slideDown("fast");$(this).find("span").addClass("up-caret");
}});$(".jt-phone-input").on("focus",function(){$("#telContainer").addClass("tel-locker");$(".numbers-device").slideDown("fast");$("#telContainer").slideDown("fast",function(){if($("#telContainer").is(".tel-locker")){$("#telContainer").removeClass("tel-locker");
}});$(".openPhoneBtn").find("span").addClass("up-caret");$("#speedDialNumber-temp").val("").focus().val($("#speedDialNumber").val());});$("body").on("click",function(a){if(!$("#telContainer").is(":hidden")&&!$("#telContainer").is(".tel-locker")&&!$(a.target).is("#speedDialNumber,#telContainer,#telContainer *")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");}});$("iframe.J_iframe").load(function(){$("body",$(this).contents()).on("click",function(a){if(!$("#telContainer").is(":hidden")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");}});});$("#hideTelConatinerBtn").on("click",function(){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");});$("#clearNumberBtn").on("click",function(){$("#speedDialNumber").val("");
$("#speedDialNumber-temp").val($("#speedDialNumber").val());});}};