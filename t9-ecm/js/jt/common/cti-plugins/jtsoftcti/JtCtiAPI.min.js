var JtCtiAPI={_running:false,_websocket:null,_token:null,_callbackList:new Map(),_eventList:[],_interval:null,_handler:null,start:function(a,d,f,g){var b=this;
var e=b.generateCode();if(b._running==true){if((g!=null)&&(g!=undefined)){var c={success:false,reqId:e,msg:"arleady start. must be exit first",};g(c);}return;
}b._running=true;b._handler=d;b._websocket=new WebSocket("ws://"+a+"/"+f+"?reqId="+e);b._callbackList.put(e,function(h){if(h&&h.data){b._token=h.data.token;
}if(g){g(h);}});b._websocket.onopen=function(h){console.log("connect cti");b._checkAndStartInterval();};b._websocket.onclose=function(j){console.log("close  cti");
b._running=false;var h=b._popCallback(e);if(h){var i={success:false,reqId:e,msg:"can't login . please check the server",};h(i);}if(b._handler){b._handler.onReadyState(0,b._token);
}};b._websocket.onmessage=function(k){b._checkAndStartInterval();var m=k.data;try{var j=JSON.parse(m);var i=j.messageType;if(i=="callback"){var l=j.reqId;
var h=b._popCallback(l);if(h){h(j);}}else{if(i=="event"){console.log("onmessage-event-data:"+m);b._eventList.push(j);}}}catch(n){console.log("error happen: "+n.message);
}};},_checkAndStartInterval:function(){var b=this;if(b._websocket&&b._websocket.readyState==WebSocket.OPEN){var a=new Date().getTime()-b.lastRunTime;if(!b._interval||a>3000){if(b._interval){clearInterval(b._interval);
}b._interval=setInterval(function(){var e={"action":"PING",};b._request(e,null);if(b._eventList.length){for(var c=0;c<b._eventList.length;c++){var d=b._eventList.shift();
b._onData(d);}}b.lastRunTime=new Date().getTime();},1000);}}},_onData:function(c){var b=this;var a=c.eventName;switch(a){case"INIT":b._handler.onReadyState(c.success,c.data.token);
break;case"CALL_INCOME":b._handler.onCallincome(c.data.ano,c.data.bno,c.data.uud);break;case"TALKED":b._handler.onTalked(c.data.ano,c.data.bno,c.data.adn);
break;case"HOOK_CHANGED":b._handler.onHookChanged(c.data.status);break;case"AGENT_INFORM":b._handler.onAgentChanged(c.data.status);break;case"RING_STOP":b._handler.onRingStoped(c.data.ano,c.data.bno,c.data.adn);
break;case"TEXT_MESSAGE":b._handler.onTextMessage(c.data.adn,c.data.bno,c.data.ano);break;}},_popCallback:function(b){var a=this;if(!b){return null;}if(!a._callbackList.size()){return null;
}var c=a._callbackList.get(b);a._callbackList.remove(b);return c;},generateCode:function(){var a=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1);
};return(a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a());},exit:function(c){var a=this;if(JtCtiAPI._websocket&&JtCtiAPI._websocket!=WebSocket.CLOSED){try{JtCtiAPI._websocket.close();
}catch(b){}}a._token=null;a._websocket=null;a._running=false;a._callbackList=new Map();a._eventList=[];clearInterval(a._interval);a._handler=null;if(c){c();
}},_request:function(b,c){var a=this;b.reqId=a.generateCode();b.token=a._token;a._callbackList.put(b.reqId,function(d){if(c){c(d);}});if(!"PING"==b.action){console.log("request-data:"+JSON.stringify(b));
}a._websocket.send(JSON.stringify(b));},login:function(c,b,e){var a=this;var d={"action":"LOGIN","data":{"agentId":c,"acd":b},};a._request(d,e);},logout:function(b,d){var a=this;
var c={"action":"LOGOUT","data":{"agentId":"aid"},};if(a._websocket&&a._websocket.readyState==WebSocket.OPEN){a._request(c,d);}else{if(d){d();}}},dialout:function(c,d){var a=this;
var b={"action":"DIALOUT","data":{"ano":c.ano,"bno":c.bno,"isp":c.isp,"adn":c.adn},};a._request(b,d);},transfer:function(c,d){var a=this;var b={"action":"TRANSFER","data":{"adn":c.adn,"destAdn":c.destAdn},};
a._request(b,d);},hold:function(c,d){var a=this;var b={"action":"PAUSE_CALL","data":{"adn":c.adn},};a._request(b,d);},retrieve:function(c,d){var a=this;
var b={"action":"RETURN_CALL","data":{"adn":c.adn},};a._request(b,d);},setbusy:function(c,d){var a=this;var b={"action":"BUSY_AGENT","data":{"adn":c.adn},};
a._request(b,d);},setidle:function(c,d){var a=this;var b={"action":"AVAILABLE_AGENT","data":{"adn":c.adn},};a._request(b,d);},speedhook:function(c,d){var a=this;
var b={"action":"HANGUP","data":{"adn":c.adn},};a._request(b,d);},};JtCtiAPI.EventHandler={onReadyState:function(a,b){},onCallincome:function(b,a,c){},onTalked:function(b,a,c){},onRingStoped:function(){},onAgentChanged:function(a){},onHookChanged:function(a){},onTextMessage:function(a,b,c){}};
