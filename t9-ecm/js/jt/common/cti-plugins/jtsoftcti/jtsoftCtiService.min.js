$(function(){var b=currentUserAcd.split(",");phonePanel=new PhonePanel();phonePanel.init();if(isNaN(currentUserAid)){$("#loginedExt1").addClass("text-danger").empty().append(currentUserAid+"不能登录分机<非数字工号>");
currentUserAdn=null;return;}currentUserAdn=currentUserAcd.split(":")[0];currentUserAcd=currentUserAcd.split(":")[1];jtCtiService=new JtsoftCtiService();
jtCtiService.init();var c=$("#anoContainer option:not([value=''])");var a=[];c.each(function(){var f=$(this);var d=f.attr("value");var e=f.attr("isp");
var g={num:d,isp:e};a.push(g);});firstEles=a[0];turnMap={all:a,lastIndex:null};});function JtsoftCtiService(){if(!(this instanceof JtsoftCtiService)){return new JtsoftCtiService();
}else{this.transNumber="";this.onTraning=false;this.callOuting=false;this.newCsCall=false;this.isHasMonitor=false;this.callEndDealFlag=false;this.callEndBno=null;
}}JtsoftCtiService.prototype={init:function(){if(ResUtils.canShow("telMonitor.fenjiMonitor.button")){this.isHasMonitor=true;}this._bindEventHandler();this.start();
},_bindEventHandler:function(){var a=this;$("#anoContainer").on("change",function(){var d=$(this);var b=d.val();var e=d.find("option:selected").attr("isp");
var c=$("#line_warning_div").find(".warning-isp");d.css({"border-color":"none"});if(c.size&&e){c.each(function(){var f=$(this).attr("isp");if(f==e){d.css({"border-color":"#ff0000"});
return false;}});}});$(".dialoutBtn1").on("click",function(){a.dialout();$(".dialoutBtn1").attr("disabled","disabled");setTimeout(function(){$(".dialoutBtn1").removeAttr("disabled");
},5000);});$(".telNumberDialoutBtn").on("click",function(){if($(this).hasClass("BtnFlag")){return;}a.dialout();$(".dialoutBtn1").attr("disabled","disabled");
$(".telNumberDialoutBtn").addClass("BtnFlag");setTimeout(function(){$(".dialoutBtn1").removeAttr("disabled");$(".telNumberDialoutBtn").removeClass("BtnFlag");
},5000);});$("#transBtn").on("click",function(){DialogUtils.error(msgCode.ERROR,"暂未实现.");return;a._transfer();});$("#setHoldBtn").on("click",function(){var b=$(this);
a._hold(b);});$("#setRetrieveBtn").on("click",function(){var b=$(this);a._retrieve(b);});$("#setBusyBtn").on("click",function(){var b=$(this);if($(this).attr("title").indexOf("忙碌")>-1){a._busy(b);
}else{if($(this).attr("title").indexOf("空闲")>-1){a._idle(b);}}});$("#setLineDisconnect").on("click",function(){var b=$(this);a._hugup();});},_hugup:function(a){JtCtiAPI.speedhook({adn:currentUserAdn},function(b){if(b.success){DialogUtils.success(msgCode.SUCCESS,b.msg);
}else{DialogUtils.error(msgCode.ERROR,b.msg);}});},_busy:function(b){var a=this;JtCtiAPI.setbusy({adn:currentUserAdn},function(c){if(c.success){a._setTipBusy();
}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_idle:function(b){var a=this;JtCtiAPI.setidle({adn:currentUserAdn},function(c){if(c.success){a._setTipIdle();
}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_hold:function(b){var a=this;JtCtiAPI.hold({adn:currentUserAdn},function(c){if(c.success){b.attr("title","保持中").attr("disabled","disabled");
a._resetRetrieve();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_retrieve:function(b){var a=this;JtCtiAPI.retrieve({adn:currentUserAdn},function(c){if(c.success){b.attr("title","已恢复").attr("disabled","disabled");
a._resetHold();}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},_resetHold:function(){$("#setHoldBtn").removeAttr("disabled").attr("静音");},_resetRetrieve:function(){$("#setRetrieveBtn").removeAttrs("disabled").attr("恢复");
},_setTipBusy:function(){$("#setBusyBtn").attr("title","设为空闲");$("#mobileNumber").empty().append("忙碌(休息)(免打扰)中");},_setTipIdle:function(){$("#setBusyBtn").attr("title","设为忙碌");
$("#mobileNumber").empty().append("空闲中");},_transfer:function(){var a=$("#speedDialNumber").val();if(!a){DialogUtils.error(msgCode.ERROR,"请输入要转移的分机号码！");
return;}if(a.length>5){DialogUtils.error(msgCode.ERROR,"分机号有误！");return;}var b={};b.adn=currentUserAdn;b.destAdn=a;JtCtiAPI.transfer(b,function(c){if(c.success){DialogUtils.success(msgCode.SUCCESS,c.msg);
}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},getAno:function(b){var c=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;var a=b.substring(1);if(b.startsWith("9")&&c.test(a)){b=b.substring(1);
}else{if(b.startsWith("0")&&c.test(a)){b=b.substring(1);}else{if(b.startsWith("90")&&c.test(a.substring(1))){b=b.substring(2);}}}return b;},start:function(){var d=this;
var a={onReadyState:function(f){$.log("on ready state event:"+f);if(f){$("#mobileNumber").empty().append("空闲中");}else{JtCtiAPI.exit();setTimeout(d.start(),500);
}},onCallincome:function(h,f,g){console.log("the uud is "+g);if(g&&g.startsWith("misc:callback")){f=d.getAno(f);$("#mobileNumber").empty().append("正在呼叫"+d._maskNumber(f));
d.callOuting=true;d.csNumber=f;}else{d.csNumber=h;if(d.csNumber.startsWith("01")&&!d.csNumber.startsWith("010")){d.csNumber=d.csNumber.substring(1);}if("y"==isCheckQuhao&&!d.csNumber.startsWith("0")&&!d.csNumber.startsWith("1")){d.csNumber=systemPhoneArea_quhao+d.csNumber;
}d.newCsCall=true;d._loadCsData(d.csNumber,f);this.onCallincomeing=true;}},onTalked:function(i,f,h){console.log("onTalk....");d.onTalking=true;if(d.callOuting){currentCsPhone=d.getAno(f);
var j=currentUserAid;}else{currentCsPhone=d.getAno(i);var j=currentUserAid;}d._chekcLinkAndPlusCount(d.param);if(!d.talkingClock){var g=new Date();d.talkingClock=setInterval(function(){var m=new Date();
var n=DateUtils.getDateDiff(g.current(),m.current(),"second");var o=parseInt(n/60);var l=0;if(o==0){o="00";}else{if(o>0&&o<10){o=0+""+parseInt(o);}else{if(o>60){l=parseInt(o/60);
o=parseInt(o%60);if(o<10){o=0+""+o;}}}}var k=o+":"+parseInt(n%60);if(l>0){k=parseInt(l)+":"+k;}if(h.startsWith("transferFrom")){$("#mobileNumber").empty().append(d._maskNumber(h.split(",")[1])+" "+k);
}else{$("#mobileNumber").empty().append(d._maskNumber(currentCsPhone)+" "+k);}},1000);}},onRingStoped:function(){$("#mobileNumber").empty().append("空闲中");
$.log("on ring stop");if(d.newCsCall){d.newCsCall=false;FormUtils.submit(ctx+"/gl/cti/tRKSheetRecord/createMissedCallMsg.htm",{phone:d.csNumber});}this.onCallincomeing=false;
},onAgentChanged:function(f){console.log("onAgentChanged....");if(f==2){$("#setBusyBtn").find("i").removeClass("glyphicon-home").addClass("glyphicon-off");
d._setTipIdle();}else{if(f==3){$("#setBusyBtn").find("i").removeClass("glyphicon-off").addClass("glyphicon-home");d._setTipBusy();}}},onTextMessage:function(i,f,h){var g=h;
if(g&&g.startsWith("01")&&!g.startsWith("010")){g=g.substring(1);}if(currentUserAdn.indexOf(",")!=-1){d._loadCsData(g,currentUserAdn.split(",")[0],"missed");
}else{d._loadCsData(g,currentUserAdn,"missed");}},onHookChanged:function(f){console.log("on hook change status is "+f);switch(f){case"1":d._checkAndUpdateLastLinkTime(d.param);
clearInterval(d.talkingClock);d.talkingClock=null;$("#mobileNumber").empty().append("空闲中");d.callOuting=false;d.onTalking=false;this.onCallincomeing=false;
d._resetRetrieve();d._resetHold();break;}},};var e=currentUserAdn;var c=currentUserAcd;if(isNaN(currentUserAid)){$("#loginedExt1").addClass("text-danger").empty().append("<span class='text-danger'>该工号无法使用cti</span>");
return;}var b=function(){var f=!currentUserAdn||!currentUserAcd||currentUserAdn=="undefined"||currentUserAcd=="undefined";if(f){console.log("非法格式的分机或队列");
return;}JtCtiAPI.start(ctiServer,a,e,function(g){console.log("startResult:"+g);if(g.success){window.localStorage.setItem("umoctiToken",JtCtiAPI._token);
JtCtiAPI.login(currentUserAid,c,function(h){console.log("loginResult:"+h);if(h.success){$("#loginBtn").attr("disabled","disabled");$("#setBusyBtn").removeAttr("disabled","disabled");
$("#logoutBtn").removeAttr("disabled");$("#mobileNumber").empty().append("空闲中");d._loginTip("loginedExt1",currentUserAdn,"success");}else{if(h.errno==100){DialogUtils.error(msgCode.ERROR,"请检查话机设备是否正常");
}else{if(h.errno==400){DialogUtils.error(msgCode.ERROR,currentUserAdn+"已被登录");}else{d._loginTip("loginedExt1",currentUserAdn,"error");}}}});}else{d._loginTip("loginedExt1",currentUserAdn,"error");
}});};if(window.localStorage.getItem("umoctiToken")){JtCtiAPI.logout(currentUserAid,function(){JtCtiAPI.exit(function(){b();});});}else{b();}},_loginTip:function(a,c,b){if(b=="success"){$("#"+a).addClass("text-success").empty().append("<span class='text-success'>"+c+"</span>");
}else{if(b=="error"){$("#"+a).addClass("text-danger").empty().append("<span class='text-danger'>"+c+"</span>");}}},_maskNumber:function(a){return PhoneEncryptUtils.encryptPhone(a);
},_loadCsData:function(d,b,c){var a=this;JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?showCsCalledNum=y&phoneNum="+d+"&inNum="+b,"客户来电");},exit:function(){JtCtiAPI.exit();
},_getDialoutPhoneInSpeedPlace:function(){var a=$("#speedDialNumber").val();if(systemPhoneArea_quhao&&a.startsWith(systemPhoneArea_quhao)){a=a.substring(systemPhoneArea_quhao.length);
}var b=a;return b;},_checkCallAndPlusCount:function(b){var a=(limitCallCs&&"y"==limitCallCs)||(limitCall&&"y"==limitCall);if(a&&limitCountCallType&&"call"==limitCountCallType&&b.bno){FormUtils.loadData(ctx+"/gl/cti/glCti/addOneCount.htm?csPhone="+b.bno+"&adn="+b.adn+"&gid="+b.gid+"&gidDesName="+b.gidDesName,null,null,true);
}},_chekcLinkAndPlusCount:function(b){var a=(limitCallCs&&"y"==limitCallCs)||(limitCall&&"y"==limitCall);if(a&&limitCountCallType&&"link"==limitCountCallType){if(self.callOuting&&self.callOuting==true){FormUtils.loadData(ctx+"/gl/cti/glCti/addOneCount.htm?csPhone="+b.bno+"&adn="+b.adn+"&gid="+b.gid+"&gidDesName="+b.gidDesName,null,null,true);
}}},_checkAndUpdateLastLinkTime:function(b){var a=this;if("y"==limitInterval&&(a.callOuting||a.onTalking)&&(a.callOuting==true||a.onTalking==true)){FormUtils.loadData(ctx+"/gl/cti/glCti/updateCallOutTime.htm?adn="+b.adn+"&gid="+b.gid+"&gidDesName="+b.gidDesName,null,null,true);
}},_highRateWarn:function(b){if(b.msg&&($.isPlainObject(b.msg)||b.msg.startsWith("{")&&b.msg.endsWith("}"))){var a=null;if($.isPlainObject(b.msg)){a=b.msg.warningMsg;
}else{a=JSON.parse(b.msg).warningMsg;}DialogUtils.warning("线路提醒",a);}},_getDialoutParamInfo:function(g){var i=this;g=g?g:i._getDialoutPhoneInSpeedPlace();
var c=g;if(!c||c=="9"){return;}if(c.indexOf("-")!=-1){c=c.replace("-","");}if(c.startsWith("9")){c=c.substring(1);}var f=c;var e=$("#anoContainer").find("option:selected");
var h=e.attr("isp");var b={};b.bno=f;b.adn=currentUserAdn;if(h){var d=h.split("-")[1];var a=e.attr("value");b.ano=a;b.isp=d;b.gidDesName=h;}else{if("turn"==filterDefaultLineWay){if(turnMap.all.length){if(!turnMap.lastIndex){turnMap.lastIndex=0;
}if(turnMap.all.length<=turnMap.lastIndex){turnMap.lastIndex=0;}b.ano=turnMap.all[turnMap.lastIndex].num;b.isp=turnMap.all[turnMap.lastIndex].isp.split("-")[1];
b.gidDesName=turnMap.all[turnMap.lastIndex].isp;turnMap.lastIndex++;}}}if(!b.gidDesName){var d=firstEles.isp.split("-")[1];b.gidDesName=firstEles.isp;b.isp=d;
}b.gid=b.isp;return b;},dialout:function(b){var a=this;var d=a._getDialoutParamInfo(b);a.param=d;if("y"==limitCall||"y"==limitInterval||"y"==limitCallCs||"y"==openRemind){FormUtils.loadData(ctx+"/gl/cti/glCti/isCanCallOutNow.htm?csPhone="+d.bno+"&adn="+currentUserAdn+"&gid="+d.gid+"&gidDesName="+d.gidDesName,function(f){if(f.success){a._highRateWarn(f);
var e=$("#mobileNumber").text();JtCtiAPI.dialout(d,function(g){if(g.success){a._checkCallAndPlusCount(d);}else{console.log("dialout失败.cmd="+cmd+";result="+g);
DialogUtils.error(msgCode.ERROR,g.msg);}});}else{DialogUtils.error(msgCode.ERROR,f.msg);}},null,true);}else{var c=$("#mobileNumber").text();JtCtiAPI.dialout(d,function(e){if(!e.success){DialogUtils.error(msgCode.ERROR,e.msg);}
});}},};function PhonePanel(){if(!(this instanceof PhonePanel)){return new PhonePanel();}else{}}PhonePanel.prototype={init:function(){this._bindEventHandler();
},_bindEventHandler:function(){$(".telNumberBtn").on("click",function(){var a=$(this).attr("numberVal");if(a){$("#speedDialNumber").val($("#speedDialNumber").val()+a);
}$("#speedDialNumber-temp").val($("#speedDialNumber").val());});$("#speedDialNumber-temp").on("change",function(){if($(this).val()!=$("#speedDialNumber").val()){$("#speedDialNumber").val($("#speedDialNumber-temp").val());
}});$(".openPhoneBtn").on("click",function(){if($(this).find("span").is(".up-caret")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(this).find("span").removeClass("up-caret");}else{$("#telContainer").slideDown("fast");$(this).find("span").addClass("up-caret");
}});$(".jt-phone-input").on("focus",function(){$("#telContainer").addClass("tel-locker");$(".numbers-device").slideDown("fast");$("#telContainer").slideDown("fast",function(){if($("#telContainer").is(".tel-locker")){$("#telContainer").removeClass("tel-locker");
}});$(".openPhoneBtn").find("span").addClass("up-caret");$("#speedDialNumber-temp").val("").focus().val($("#speedDialNumber").val());});$("body").on("click",function(a){if(!$("#telContainer").is(":hidden")&&!$("#telContainer").is(".tel-locker")&&!$(a.target).is("#speedDialNumber,#telContainer,#telContainer *")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");}});$("iframe.J_iframe").load(function(){$("body",$(this).contents()).on("click",function(a){if(!$("#telContainer").is(":hidden")){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");}});});$("#hideTelConatinerBtn").on("click",function(){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").slideUp("fast");$(".openPhoneBtn").find("span").removeClass("up-caret");});$("#clearNumberBtn").on("click",function(){$("#speedDialNumber").val("");
$("#speedDialNumber-temp").val($("#speedDialNumber").val());});}};