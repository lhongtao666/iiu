$(function(){currentUserAdn=szCtiAdn;if(currentUserAdn){jtCtiService=new SzCtiService();jtCtiService.init();$("#speedDialNumber").val("18664579561");}else{$("#mobileNumber").empty().append("未登录");
$("#loginedExt1").addClass("text-danger").empty().append("<span class='text-danger'>"+"未登录"+"</span>");}});function SzCtiService(){if(!(this instanceof SzCtiService)){return new SzCtiService(szCtiAdn);
}}SzCtiService._CONS_={};SzCtiService.EvtHandler={init:function(b){var a=this;a.father=b;},setCurrentCsNum:function(b){var a=this;a.csNumber=b;},getCurrentCsNum:function(){var a=this;
return a.csNumber;},_getAno:function(b){var c=/^(((1[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{9})$/;var a=b.substring(1);if(b.startsWith("9")&&c.test(a)){b=b.substring(1);
}else{if(b.startsWith("0")&&c.test(a)){b=b.substring(1);}else{if(b.startsWith("90")&&c.test(a.substring(1))){b=b.substring(2);}}}return b;},_loadCsData:function(d,b,c){var a=this;
JTTabUtils.addOrRefreshTab(ctx+"/crm/cs/csEntity/in.htm?phoneNum="+d+"&inNum="+b,"客户来电");},onCallincome:function(c,b){var a=this;c=a._getAno(c);a.csNumber=c;
a._loadCsData(c,b);},onCallOut:function(c,b){var a=this;b=a._getAno(b);a.csNumber=b;},onTalked:function(d,b,c){var a=this;d=a._getAno(d);a.csNumber=d;},onRingStoped:function(){var a=this;
FormUtils.submit(ctx+"/gl/cti/tRKSheetRecord/createMissedCallMsg.htm",{phone:a.csNumber});},onHookChanged:function(a){var b=this;switch(a){case"1":b.reset2FreeStatus();
break;case"2":$("#mobileNumber").empty().append("已摘机");break;}},onAgentChanged:function(a){var b=this;switch(a){case"1":DialogUtils.error(msgCode.ERROR,"您登录的分机已在其它地方登录");
currentUserAdn=null;b.csNumber="";$("#mobileNumber").empty().append("未登录");b.father._loginTip("已被踢出","error");break;case"2":b.reset2FreeStatus();break;
case"3":$("#mobileNumber").empty().append("使用中");break;}},onTextMessage:function(a,b,c){},reset2FreeStatus:function(){var a=this;a.csNumber="";a.father.isCalling=false;
$("#mobileNumber").empty().append("空闲中");},};SzCtiService.prototype={init:function(){this._initBtns();this._bindEventHandler();this.start();},_initBtns:function(){$("#setBusyBtn").remove();
$("#setHoldBtn").remove();$("#setRetrieveBtn").remove();$("#setLineDisconnect").show();if(ResUtils.canShow("szcti.monitor")){$("#fenjiMonitor").show();
}else{$("#fenjiMonitor").hide();}$("#fenjiMonitor").show();},_bindEventHandler:function(){var a=this;$(".telNumberBtn").on("click",function(){var b=$(this).attr("numberVal");
if(b){$("#speedDialNumber").val($("#speedDialNumber").val()+b);}});$(".openPhoneBtn").on("click",function(){$("#telContainer").slideDown();});$("#hideTelConatinerBtn").on("click",function(){$(".telNumberBtn.btn-primary").removeClass("btn-primary").addClass("btn-default");
$("#telContainer").hide();});$("#clearNumberBtn").on("click",function(){$("#speedDialNumber").val("");});a._bindCtiOperEventHandler();},_bindCtiOperEventHandler:function(){var a=this;
$(".dialoutBtn1").on("click",function(){var b=$("#speedDialNumber").val();a.dialout(b);$(".dialoutBtn1").attr("disabled","disabled");setTimeout(function(){$(".dialoutBtn1").removeAttr("disabled");
},5000);});$("#transBtn").on("click",function(){var c=$("#speedDialNumber").val();var b=SzCtiService.EvtHandler.getCurrentCsNum();a.trans(c,b);});$("#setLineDisconnect").on("click",function(){SzCtiUtils.forceHook(currentUserAdn,function(b){if(!b.success){DialogUtils.error(msgCode.ERROR,b.msg);
}});});$("#fenjiMonitor").on("click",function(){var b=$("#speedDialNumber").val();a.monitor(b);});},monitor:function(a){if(!a){DialogUtils.error(msgCode.ERROR,"需要监听的分机号码不能为空");
return;}if(currentUserAdn==a){DialogUtils.error(msgCode.ERROR,"需要监听分机不能与当前登录分机相同");return;}if(a.length>=7){DialogUtils.error(msgCode.ERROR,"需要监听的分机号码有误");
return;}SzCtiUtils.listen(currentUserAdn,a,function(b){if(!b.success){DialogUtils.error(msgCode.ERROR,b.msg);}});},trans:function(b,a){if(!b){DialogUtils.error(msgCode.ERROR,"需要转接分机号码不能为空");
return;}if(!a){DialogUtils.error(msgCode.ERROR,"需要转接的客户号码不能为空");return;}if(b==a){DialogUtils.error(msgCode.ERROR,"需要转接分机号码有误");return;}if(currentUserAdn==b){DialogUtils.error(msgCode.ERROR,"需要转接分机不能与当前登录分机相同");
return;}if(b.length>=7){DialogUtils.error(msgCode.ERROR,"需要转接分机号码有误");return;}SzCtiUtils.trans(a,currentUserAdn,b,function(c){if(c.success){FormUtils.submit(ctx+"/crm/cs/csEntity/transferCallAdn.htm",{calledAdn:b,csMobile:a});
}else{DialogUtils.error(msgCode.ERROR,c.msg);}});},start:function(){var a=this;SzCtiService.EvtHandler.init(a);SzCtiUtils.login(SzCtiService.EvtHandler,currentUserAid,currentUserPassword,currentUserAdn,function(b){if(b.success){$("#loginBtn").attr("disabled","disabled");
$("#logoutBtn").removeAttr("disabled");$("#mobileNumber").empty().append("空闲中");a._loginTip(currentUserAdn,"success");}else{DialogUtils.error(msgCode.ERROR,b.msg);
a._loginTip(b.msg,"error");}});},_loginTip:function(b,a){if(a=="success"){$("#loginedExt1").addClass("text-success").empty().append("<span class='text-success'>"+b+"</span>");
}else{if(a=="error"){$("#loginedExt1").addClass("text-danger").empty().append("<span class='text-danger'>"+b+"</span>");}}},dialout:function(b){var a=this;
if(!b){DialogUtils.error(msgCode.ERROR,"拨打号码不能为空");return;}if(a.isCalling){DialogUtils.error(msgCode.ERROR,"话机使用中,请空闲后再拨打.");return;}if(currentUserAdn==b){DialogUtils.error(msgCode.ERROR,"拨打号码不能与当前登录分机相同");
}SzCtiUtils.dialout(b,currentUserAdn,function(c){if(!c.success){DialogUtils.error(c.ERROR,c.msg);$(".dialoutBtn1").removeAttr("disabled");}else{a.isCalling=true;
SzCtiService.EvtHandler.setCurrentCsNum(b);}});},};