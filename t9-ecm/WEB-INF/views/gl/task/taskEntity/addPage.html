<!DOCTYPE html>
<html>

<head>
    <title>日常任务管理</title>
    <#include "/common/common.html" />
    <style type="text/css">
    .margin-class {
        margin-bottom: 20px;
    }
    .layui-layer-iframe .layui-layer-btn, .layui-layer-page .layui-layer-btn{
        border-top:1px solid #ddd !important;
    }
    </style>
    <!-- aaaaaaaa -->
    <link href="${ctx}/css/plugins/timepicker/DateTimePicker.css?v=${jsVersion}" rel="stylesheet">
    <script src="${ctx}/js/plugins/timepicker/DateTimePicker.js?v=${jsVersion}"></script>
    <script src="${ctx}/js/plugins/timepicker/DatetimePicker-i18n-zh-CN.js?v=${jsVersion}"></script>
    <script src="${ctx}/js/jt/common/service/employeesSelectLayer${deploy_min!""}.js?v=${jsVersion}"></script>
    <script src="${ctx}/js/jt/crm/cs/selectCsEntity/selectCsEntityService${deploy_min!""}.js?v=${jsVersion}" ></script>
    <!-- aaaaaaaaaa -->
    <script type="text/javascript">

    var type = "${type } ";
    var entityId = "${entityId }";
    var entityName = "${entityName } ";
    var currentPartyId = currentUserId;
    var currentPartyName = currentUserName;
    var currentPartyAid = currentUserAid;
    $(function() {
        var currentTime = new Date();
        currentTime.setMinutes(currentTime.getMinutes() + 10);
        $("#dtBox").DateTimePicker({
            language: 'zh-CN',
            isPopup: false,
            defaultDate: currentTime,
            minDateTime: DateUtils.format(currentTime, DateUtils._CONS_.DEFAULT_DATE_TIME_PATTERN),
        });
        $("#selectCommonImageBtn").on("click", function() {
            FileUtils.selectFile(1, function(files) {
                if (files && files.length > 0) {
                    $("#commonImageContainer").append(FileUtils.createFileDivStr(files));
                }
            });
        });
        if (!type) {
            $("[name=type]").val("simple");
        } else {
            $("[name=type]").val(type);
            $("[name=entityId]").val(entityId);
            $("[name=entityName]").val(entityName);
        }
        $("body").on("click", "#chooseTaskPartyBtn", function() {
            var employeesSelect = new EmployeesSelect();
            var isShowAllGroup = 0;
            if (ResUtils.canShow("employeeSelector.button.task")) { //是否有显示全部部门的权限
                isShowAllGroup: 1;
            }
            var param = {
                isShowAllGroup: isShowAllGroup,
                grantType: "/task/",
                isMultiple: 0, // false:单选;true:多选
                isSale: 0,
                mode: 0,
                callBack: function(list) {
                    $("[name='partyName']").val(list[0].aid+":"+list[0].name);
                    $("[name='partyId']").val(list[0].id);
                }
            };
            employeesSelect.init(param);
        });
        $("[name=partyId]").val(currentPartyId);
        $("[name=partyName]").val(currentPartyAid+":"+currentPartyName);
        $("[name=notifyTime]").val(currentTime.current());
    });
    $(document).on("click",".selectSelfCsEntity", function(){
            var params = {
                type:"self",
                useFor:"csTaskEntity",
                baseUrl:ctx+'/crm/cs/csEntity/list.htm?isSelectCsEntity=true',
                callBack: function(list, type){
                    appendCsEntityInput(list);
                }
            };
            var selectCsEntityService = new SelectCsEntityService();
            selectCsEntityService.init(params);
        });
        $(document).on("click",".selectMySubCsEntity", function(){
            var params = {
                type:"mysub",
                useFor:"csTaskEntity",
                baseUrl:ctx+'/crm/cs/csEntity/subList.htm?isSelectCsEntity=true',
                callBack: function(list, type){
                   appendCsEntityInput(list);
                }
            };
            var selectCsEntityService = new SelectCsEntityService();
            selectCsEntityService.init(params);
        });
        function appendCsEntityInput(list){
            if(list){
                $(".csEntityCodeStr").html(list[0].code);
                $("[name=csEntityName]").val($(".csEntityEditTmp").text());
                $("[name=csId]").val(list[0].id);
            }
        }
    </script>
</head>

<body>
    <div class="panel-body" style="padding:10px;font-size:14px;">
        <#include "/gl/task/taskEntity/taskEntityForm.html" />
    </div>
</body>

</html>
